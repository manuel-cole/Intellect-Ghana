define("dropbox",["modules/clean/undo","modules/clean/react/modal","modules/core/controller_registry","modules/clean/contacts/list","modules/clean/job_progress","modules/clean/pagination_manager","modules/clean/browse_interface","modules/clean/search/search_helpers","modules/clean/gandalf_util","modules/clean/contacts/cache","modules/clean/multiaccount_login","modules/clean/top_notif","modules/clean/datetime","modules/constants/viewer","modules/core/i18n","modules/clean/uirequest","modules/clean/em_string","modules/clean/base64","modules/core/dom","modules/clean/web_timing_logger","modules/clean/video_util","modules/clean/account/email","modules/clean/dbmodal","modules/clean/teams/team_folder_modal","modules/clean/sharing/share_inband","modules/clean/db_bubble","modules/clean/payments/credit_card_util","modules/clean/contacts/types","external/react","modules/clean/profile_services/profile_services_constants","modules/clean/react/previews/preview_image","modules/core/uri","modules/clean/page_role_observer","modules/core/cookies","modules/clean/react/previews/preview_image_zoom","modules/clean/dbmodal_loading","modules/clean/display_format","modules/clean/payments/cash","modules/clean/event_load","modules/clean/browse/browse_drag_utils","modules/clean/contacts/facebook_modal","modules/clean/contacts/facebook_oauth","modules/clean/react/previews/preview_video","external/purify","modules/clean/account/email_verify_reasons","modules/clean/image_size","modules/clean/react/hierarchical_nav_bar","modules/clean/payments/dfb_util","modules/clean/components/ajax_form","modules/clean/viewer","modules/core/ordered_dictionary","modules/clean/events/rollback","modules/clean/profile_services/profile_services_link","libs","modules/clean/frame_messenger","modules/constants/env","jquery","modules/core/exception","modules/clean/components/bubble_picker","modules/clean/history","modules/clean/analytics","modules/clean/photos/legacy_thumb_loader","modules/core/browser","modules/clean/react/previews/preview_blank","modules/clean/ajax","modules/clean/react/previews/preview_linkfile","modules/clean/sso_login_checks","modules/clean/sprite","modules/clean/filepath","modules/core/notify","modules/clean/clipboard","modules/core/html","modules/clean/react/invite/invite_form_react","modules/clean/static_urls"],function(U,cf,bN,m,x,eZ,eX,ak,au,eb,bF,ck,bU,a2,bd,bp,bK,af,z,d3,bm,cL,cU,dI,dA,ax,eN,S,dl,cQ,cn,D,aZ,bo,c4,cr,aA,dD,ah,cC,dY,ed,a0,cO,ee,ac,aQ,cR,b6,cB,aT,an,cW,ca,eg,eY,bv,dW,br,eo,a3,bl,bR,cA,cs,by,bW,cm,av,ab,q,eV,X,aF){var B={};var dy=cf.SimpleModal;var c6=x.Job;var em=x.ModalProgress;var cx=eb.ContactsCache;var bQ=eb.DefaultContactsCache;var eO=ck.TopNotificationBar;var ez=ck.EUCookieNotificationBar;var o=ck.ExpiredIOSNotificationBar;var d1=ck.PackratUnlimitedOptInNotificationBar;var b7=ck.DfBAdminEarlyAccessSharingControlsBar;var b3=ck.DfBAdminEarlyAccessFtsBar;var aJ=ck.LocaleSwitchBar;var a4=bd.ungettext;var el=bd._;var du=bd.N_;var C=bd.E_;var eP=bd.render_sentences;var ap=cL.ChangeEmail;var dP=cL.EmailVerification;var dS=cU.DBModal;var dM=cU.DBModalStack;var c7=cU.DBUserModal;var u=cn.PreviewImage;var aO=c4.PreviewImageZoom;var ba=dD.Cash;var eT=dD.CashUtil;var d6=a0.PreviewVideo;var aB=ac.image_best_fit_size;var dv=aQ.HierarchicalNavBar;var eU=cR.DfBTransitionInfoFetcher;var bc=cW.LinkedProfileServices;var dV=cW.ProfileServicesLinkingHandler;var bY=dW.alertd;var cz=dW.assert;var ew=dW.reportException;var ex=dW.stackTrace;var E=cA.PreviewBlank;var P=by.PreviewLinkfile;var d4,eL,c0;INLINE_JS.$=$;INLINE_JS.$u=$u;Function.prototype.defer=Function.prototype.defer.wrap(function(e0){var T;T=$A(arguments).slice(1);this.__tb__=ex();return e0.apply(this,T)});String.prototype.evalScripts=String.prototype.evalScripts.wrap(function(e0){var T,e1;T=$A(arguments).slice(1);try{return e0.apply(this,T)}catch(e2){e1=e2;return cz(0,e1.toString())}});d4=B.Jcached={cache:{},set:function(e0,e1,T){var e2;e2=d4.cache[e0];if(e2==null){e2=d4.cache[e0]={}}e2.value=e1;return e2.expires=T?new Date().getTime()+T:0},get:function(T){var e0;e0=d4.cache[T];if((e0==null)||new Date().getTime()>e0.expires){delete d4.cache[T];return false}return e0.value}};Function.prototype.cached=function(T){var e1,e0;e0=Math.random();e1=this;return function(){var e2;e2=d4.get(e0);if(e2!==false){return e2}e2=e1();d4.set(e0,e2,T);return e2}};Array.prototype.sort_by_key=function(e0,e1){var T;if(e1==null){e1=false}T=e1?-1:1;return this.sort(function(e2,e3){e2=e0(e2);e3=e0(e3);if(e2<e3){return T*-1}else{if(e2>e3){return T*1}else{return 0}}})};Array.prototype.contains=function(T){return this.indexOf(T)!==-1};Array.prototype.remove=function(e0,T){T=T||e0+1;return this.splice(e0,T-e0)};Array.prototype.removeItem=function(e0){var T;T=this.indexOf(e0);if(T>=0){return this.remove(T)}else{return false}};Array.prototype.dict_by=function(T){var e2,e3,e1,e4,e0;e1={};for(e2=e4=0,e0=this.length;e4<e0;e2=++e4){e3=this[e2];e1[this[e2][T]]=this[e2]}return e1};Array.prototype.unique=function(){var e3,e1,e2,e0,T;e3={};for(e2=0,e0=this.length;e2<e0;e2++){e1=this[e2];if(typeof e1!=="string"){return this}e3[e1]=0}T=[];for(e1 in e3){T.push(e1)}return T};String.prototype.widthSplit=function(e2){var T,e1,e0,e3;if(e2==null){e2=15}T=[];e1=this;e3=0;e0=e1.substring(e3,e3+e2);while(e0!==""){T.push(e0);e3+=e2;e0=e1.substring(e3,e3+e2)}return T};Object.extend(Effect.Transitions,{EaseIn:function(T){return Math.pow(T,2)},EaseOut:function(T){return Math.pow(T,0.5)}});(function(e1){var e0,T;e0=function(e6){var e3,fa,e9,e7,fb,e5,e4,e8,e2;if(e6){if(Object.isArray(e6)){e3=[];for(e5=0,e8=e6.length;e5<e8;e5++){fa=e6[e5];e3.push(eV.escape(fa).toHTML())}e6=new eV(e3.join(""))}else{if(e6.top||e6.bottom||e6.before||e6.after){e7=["top","bottom","before","after"];for(e4=0,e2=e7.length;e4<e2;e4++){e9=e7[e4];fb=e6[e9];if(fb){e6[e9]=arguments.callee(fb)}}}else{if(dQ.isElm(e6)||e6.toElement||e6.toHTML){}else{e6=eV.escape(e6)}}}}return e6};return Element.addMethods({db_observe:function(e3,e2,e4){return e3.observe(e2,function(e5){return e4(e5,e3)})},smoothScrollIntoView:function(e5,e4){var e9,e3,e2,e8,e7,e6;if(e4==null){e4={}}e9={duration:0.3,offset:0,padding:0,transition:Effect.Transitions.EaseOut};e4=Object.extend(e9,e4);e2=e5.viewportOffset(e5);e3=e5.getDimensions();e6=document.viewport.getDimensions();e7=e4.padding||0;if(e2.top>e7&&(e2.top+e3.height)<(e6.height-e7)){return}e8=e2.top<e7?-1*Math.floor(e6.height/4):-1*Math.floor(3*e6.height/4);e4.offset=e4.offset||e8;return new Effect.ScrollTo(e5,e4)},__sert:function(e2,e3){return Element.insert(e2,e0(e3))},__date:function(e2,e3){return Element.update(e2,e0(e3))},replace:T=function(e2,e3){return e1(e2,e0(e3))}})})(Element.replace);eL=function(T){if(T!=null?T.target:void 0){try{return document.activeElement=T.target===document?null:T.target}catch(e0){}}};c0=function(T){try{return document.activeElement=null}catch(e0){}};if(document.addEventListener){document.addEventListener("focus",eL,true);document.addEventListener("blur",c0,true)}if(!String.prototype.trim){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}}String.prototype.lpad=function(e0,T){var e1;if(T==null){T="0"}e1=this;while(e1.length<e0){e1=T+e1}return e1.toString()};String.prototype.reverse=function(){var e1,e0,T;T=this.split("");e0=T.reverse();e1=e0.join("");return e1};String.prototype.count=function(T){return(this.length-this.gsub(T,"").length)/T.length};String.prototype.repeat=function(T){return(new Array(T+1)).join(this)};String.prototype.title=function(){return this.charAt(0).toUpperCase()+this.substr(1)};Ajax.DBRequest=Class.create(Ajax.Request,{initialize:function($super,e7,e5){var fb,fa,ff,e1,T,fc,e8,e6,e2,e0,fd,fe,e9,e4,e3;if(e5==null){e5={}}this.orig_req={url:e7,options:e5};this.start_time=bU.time();e5.method=e5.method||"post";e5.evalJS=false;e5.suppress_nonstandard_headers=true;e5.parameters=e5.parameters||{};e5.parameters.t=bo.read(Constants.JS_CSRF_COOKIE);e5.parameters.is_xhr=true;if(e5.method.toLowerCase()==="post"||Constants.CPROFILE_ENABLED){e5.parameters.parent_request_id=Constants.REQUEST_ID}if(Constants.CPROFILE_ENABLED){e5.parameters.cProfile=Constants.CPROFILE_PARAMETER}if(Constants.PUBLIC_MODE_OVERRIDE){e5.parameters.public_mode_override="1"}if(Constants.COUNTRY_OVERRIDE){e5.parameters.public_mode_override=Constants.COUNTRY_OVERRIDE}if(Constants.GANDALF_PANEL&&e7.indexOf("/")===0){e5.parameters.gandalf_panel=1}if(Ajax.DBRequest.restrict){e5.parameters.restrict=Ajax.DBRequest.restrict}fa=e5.cleanUp||(function(){});this.subject_user=e5.subject_user||e5.job_user;if(e5.job){this.job_id=dQ.nonce();e5.parameters.job_id=this.job_id;dX.watch(this,e5.dont_hide_progress_on_complete)}if(!e5.no_watch){am.watch(this,!!e5.job)}fc=e5.onFailure;e8=e5.onSuccess;T=e5.onComplete;e1=(function(fg){return function(fh){var fj,fi;if(e5.parameters.xhr_retry||!e5.allow_retries){return false}if((fi=fh.status)===0||fi===500||fi===502||fi===503){fg.orig_req.options.parameters.xhr_retry=true;fg.orig_req.options.onFailure=fc;fg.orig_req.options.onSuccess=e8;fj=new Ajax.DBRequest(fg.orig_req.url,fg.orig_req.options);return true}return false}})(this);e5.onFailure=function(fh){var fj,fg,fi;if(c6.handled(fh.request.job_id)){return}if(e1(fh)){return}if(!e5.noAutonotify){if(!Constants.IS_PROD&&fh.status===500&&fh.getHeader("X-Debug-Url")){e7=fh.getHeader("X-Debug-Url");fj=el("There was a problem completing this request.")+(' <a href="'+e7+'" target="_blank">View debug</a>');ab.error(new eV(fj))}else{ab.error()}}fa(false);if(fc){fc(fh)}if(fh.status===403){fg=dQ.session_storage_get("reload-timestamp");if(!fg||bU.time()-fg>30*1000){dQ.session_storage_set("reload-timestamp",bU.time());location.reload(true)}}return cz(e5.noAutonotify||((fi=fh.status)===403||fi===404||fi===502),"Ajax "+fh.status+" on "+fh.request.url)};e5.onComplete=(function(fg){return function(fh){if(fh.responseText.length&&T){if(fh.responseText.indexOf("async_task_started:")!==0){return T(fh)}}}})(this);e5.onSuccess=(function(fg){return function(fh){var ft,fz,fr,fw,fp,fl,fs,fu,fm,fk,fv,fx,fo,fn,fi,fy,fq,fj;fn=bU.time()-fh.request.start_time;if(c6.handled(fh.request.job_id)){return}if(!fh.responseText.length){if(!e5.job){if(e1(fh)){return}if(!e5.noAutonotify){if(!fh||fh.status!==0){ab.error()}}if(fc){fc(fh)}}}else{if(fh.responseText.indexOf("err:")===0){if(!e5.noAutonotify){fl=fh.responseText.substr(4);if(e5.html_in_error_msg){fl=new eV(fl)}ab.error(fl)}if(fc){fc(fh)}}else{if(fh.responseText.indexOf("async_task_started:")===0){fg.async_task_id=fh.responseText.split(":")[1];dX.watch(fg)}else{if(e8){if(fh.responseText.indexOf("ok:")===0){ab.success(fh.responseText.substr(3))}e8(fh)}}fo=fh.getHeader("X-Server-Response-Time")||"-1";if(e5.log_timing){d3.log_ajax_transition.defer(fn,void 0,void 0,void 0,fo,e7=a5.absolutize(fg.url))}ft=bv("#cprofile");if(!e5.no_watch&&ft.length){fm=""+Constants.REQUEST_ID+"-"+(fh.getHeader("X-Dropbox-Request-Id"));e7=fh.request.url.replace(/[^/]*\/\/[^/]+/,"").replace(/\?.*$/,"");fp="Ajax: "+e7+" ("+fo+"ms)";fs="/profile/cprofile?request_id="+fm;fu=fh.request.url;if(fu.indexOf(Constants.BLOCK_CLUSTER)!==-1){fs+="&block=1"}else{fq=Constants.BATCH_THUMB_ENDPOINTS;for(fi=0,fy=fq.length;fi<fy;fi++){fr=fq[fi];if(fu.indexOf(fr)!==-1){fs+="&block=1";break}}}fw=fs.replace("/cprofile?","/ioprofile?");fk=bv('<a target="_new" />').attr("href",fs).text("CG ");fx=bv('<a target="_new" />').attr("href",fw).text("IO ");fv=bv('<div class="ajax">').text("Ajax: "+e7+" ("+fo+"ms)").prepend(fk,fx);fz=ft.find(".ajax");if(fz.length>=10){fz.last().remove()}ft.prepend(fv)}if(bv("#gandalf_panel").length&&fh.request.url.substring(0,14)!=="/gandalf_panel"){if((fj=window.gandalf_panel)!=null){fj.add(fh.request.url,fh.getHeader("X-Dropbox-Request-Id"))}}}}return fa(true)}})(this);e5.onException=function(fh,fi){var fj,fg;if(window.console){throw fi}fj=("Error with AJAX callback for: "+e7+" :::: ")+fi.toString();fg=ex();fg.pop();return ew(fj,bR.get_href(),"",fg.join("\n"))};if(e5.job){e7+=(e7.indexOf("?")===-1?"?":"&")+"long_running=1"}if(e5.subject_user&&!((e9=e5.parameters)!=null?e9[Constants.UID_PARAM_NAME]:void 0)){e7=D.parse(e7).updateQuery(Constants.UID_PARAM_NAME,e5.subject_user).toString()}fb=$H({url:e7});if(e5.parameters){fb.update(e5.parameters);e4=fb.keys();for(e2=0,fd=e4.length;e2<fd;e2++){ff=e4[e2];e3=["passwd","password","oauth","ccn","host_id"];for(e0=0,fe=e3.length;e0<fe;e0++){e6=e3[e0];if(ff.indexOf(e6)!==-1){fb.unset(ff)}}}fb.unset("t")}e5.onSuccess.__tb_ajax_info__=e5.onFailure.__tb_ajax_info__=Object.toJSON(fb);return $super(e7,e5)}});if(typeof key!=="undefined"&&key!==null){Object.extend(key,{main_modifier:function(){if(dQ.is_mac()){return decodeURIComponent("%E2%8C%98")}else{return"ctrl"}}})}Object.extend(Prototype.BrowserFeatures,{DB_CORS:window.XMLHttpRequest&&("withCredentials" in new XMLHttpRequest())});var cS=[].slice;if(!window.$j){window.$j=window.jQuery}INLINE_JS.$j=bv;if(!Function.prototype.bind){Function.prototype.bind=function(T){var e3,e2,e0,e1;if(typeof monkey_check==="function"){monkey_check()}if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}e3=Array.prototype.slice.call(arguments,1);e1=this;e0=function(){};e2=function(){return e1.apply((this instanceof e0&&T?this:T),e3.concat(Array.prototype.slice.call(arguments)))};e0.prototype=this.prototype;e2.prototype=new e0();return e2}}jQuery.fn.curry=function(){var T,e1,e0;e1=arguments[0],e0=arguments[1],T=3<=arguments.length?cS.call(arguments,2):[];if(e0==null){e0=window}if(typeof monkey_check==="function"){monkey_check()}return function(){var e2;e2=1<=arguments.length?cS.call(arguments,0):[];return e1.apply(e0,cS.call(T).concat(cS.call(e2)))}};jQuery.fn.stripTags=function(T){if(typeof monkey_check==="function"){monkey_check()}return T.replace(/<\w+(\s+("[^"]*"|'[^']*'|[^>])+)?>|<\/\w+>/gi,"")};jQuery.fn.controller=function(T){if(typeof monkey_check==="function"){monkey_check()}if(T!=null){return this.data("jscontroller",T)}else{return this.data("jscontroller")}};jQuery.fn.hasScrollBar=function(){if(typeof monkey_check==="function"){monkey_check()}return this.get(0).scrollHeight>this.height()};jQuery.fn.viewportOffset=function(){if(typeof monkey_check==="function"){monkey_check()}return z.viewport_offset(this)};jQuery.fn.visible=function(){if(typeof monkey_check==="function"){monkey_check()}return jQuery(this).is(":visible")};jQuery.fn.clonePosition=function(e0,T){if(typeof monkey_check==="function"){monkey_check()}z.clone_position(this,e0,T);return this};jQuery.format=function(e0,T){if(typeof monkey_check==="function"){monkey_check()}return e0.replace(/\{([^}]+)\}/g,function(e2,e1){if(e1 in T){return T[e1]}else{return e2}})};jQuery.cachedScript=function(e0,T){if(typeof monkey_check==="function"){monkey_check()}T=bv.extend(T||{},{dataType:"script",cache:true,url:e0});return jQuery.ajax(T)};jQuery.browser=bR;jQuery.addSubjectParam=function(e1,T){var e0;if(typeof monkey_check==="function"){monkey_check()}if(e1.subject_user&&!((e0=e1.data)!=null?e0[Constants.UID_PARAM_NAME]:void 0)){return T[Constants.UID_PARAM_NAME]=String(e1.subject_user)}};jQuery.ajaxPrefilter(function(T,e2,e1){var e0;if(!e2.noDropboxDefaults){e0={t:bo.read(Constants.JS_CSRF_COOKIE),is_xhr:true};jQuery.addSubjectParam(e2,e0);if(jQuery.ajaxSettings.restrict!=null){e0.restrict=jQuery.ajaxSettings.restrict}T.data=bv.param(bv.extend(e2.data,e0),true);return false}});jQuery.ajax.retryOnce=function(e2,T,e0){var e1;if(typeof monkey_check==="function"){monkey_check()}if(T!=="abort"&&((e1=e2.status)===0||e1===500||e1===502||e1===503)&&!this.xhr_retry){this.xhr_retry=true;return jQuery.ajax(this)}};var es,c5,dH,a5,dQ,dk,dg=function(T,e0){return function(){return T.apply(e0,arguments)}};dQ=INLINE_JS.Util=B.Util={set_min_body_height_to_viewport_height:function(){var T;T=$(document.body);if(T!=null?T.style:void 0){return T.style.minHeight=z.viewport_dimensions().height+"px"}},scroll_to_thumb:function(T){var e3,e2,e1,e0;e2=T.cumulativeOffset().top;e3=T.getHeight();e0=z.scroll_offsets().top;e1=z.viewport_dimensions().height;if(e2<e0||e2+e3>e0+e1){return z.scroll_to(0,e2-e1/2)}},decode_sort_key:function(e1){var e3,e2,e0,T;T=[];for(e2=0,e0=e1.length;e2<e0;e2++){e3=e1[e2];if(typeof e3==="string"){T.push(af.decode(e3))}else{T.push(e3)}}return T},sort_by_rank_or_key:function(T,e0){if((T.sort_rank!=null)&&(e0.sort_rank!=null)){return T.sort_rank-e0.sort_rank}cz((T.sort_key!=null)&&(e0.sort_key!=null),"expected sort keys on both elms");return this._sort_by_key(T,e0)},sort_by_key:function(T,e0){return this._sort_by_key(T,e0)},_sort_by_key:function(e0,e5){var e2,T,e1,e4,e3;T=e0.sort_key;e1=e5.sort_key;for(e2=e4=0,e3=T.length;0<=e3?e4<e3:e4>e3;e2=0<=e3?++e4:--e4){if(e1[e2]==null){return 1}if(typeof T[e2]!==typeof e1[e2]){if(typeof T[e2]==="string"){return 1}else{return -1}}else{if(T[e2]!==e1[e2]){if(T[e2]>e1[e2]){return 1}else{return -1}}}}if(e1.length>T.length){return -1}else{return 0}},add_sort_arrow_mouseover:function(T,e3,e1,e0){var e6,e4,e7,e5,e2;e5=$$(e1);e2=[];for(e4=0,e7=e5.length;e4<e7;e4++){e6=e5[e4];e2.push((function(e8){var e9;if(T!==e8){cm.src(e8.down("img"),"web","downtick-spacer");return e8.removeClassName("bolded")}else{e8.addClassName("bolded");if(e8.hasClassName("noarrow")){return}e9=e3?"arrow-up-gray":"arrow-down-gray";return cm.src(e8.down("img"),"web",e9)}})(e6))}return e2},add_sort_arrow_mouseover_j:function(T,e3,e1,e0){var e6,e4,e7,e5,e2;e5=bv(e1);e2=[];for(e4=0,e7=e5.length;e4<e7;e4++){e6=e5[e4];e2.push((function(e8){var e9;if(T.attr("data-sort")!==bv(e8).attr("data-sort")){cm.src(bv(e8).find("img")[0],"web","downtick-spacer");return bv(e8).removeClass("bolded")}else{bv(e8).addClass("bolded");if(bv(e8).hasClass("noarrow")){return}e9=e3?"arrow-up-gray":"arrow-down-gray";return cm.src(bv(e8).find("img")[0],"web",e9)}})(e6))}return e2},one_line_fit:function(T){var e1,e0;e1=$$(T);if(e1.length<2){return}e0=(function(e2){return function(){var fb,e8,e7,e5,fa,e6,e3,e4,e9;e7=e1[0];fa=e1[e1.length-1];e5=e7.cumulativeOffset().top;e6=fa.cumulativeOffset().top;if(e5!==e6){fb=parseInt(e7.getStyle("font-size"),10);e3=fb-1;if(e3<8){return}for(e4=0,e9=e1.length;e4<e9;e4++){e8=e1[e4];e8.style.fontSize=e3+"px"}return e0()}}})(this);return e0()},nice_list:function(e0){var e4,e3,e2,T,e1;if(!e0){return""}else{if(e0.length===1){return e0[0]}else{if(e0.length===2){return el("%(x)s and %(y)s").format({x:e0[0],y:e0[1]})}}}e1=el("%(x)s, %(y)s, and %(z)s").split(/%\(x\)s|%\(y\)s|%\(z\)s/);cz(e1.length===4,"bad item list format %(x)s, %(y)s, and %(z)s");e3=e1[0];e2=e1[1];T=e1[2];e4=e1[3];return[e3,e0.slice(0,-1).join(e2),T,e0[e0.length-1],e4].join("")},list_em_snippet:function(e0,T){var e4,e2,e1,e3,e6,e5;e1="";T-=new bK("...").length;for(e2=e6=0,e5=e0.length;0<=e5?e6<e5:e6>e5;e2=0<=e5?++e6:--e6){e3=e0[e2];if(e2!==0){e3=", "+e3}e4=new bK(e3).length;if(e4>T){break}T-=e4;e1+=e3}return{str:e1,snipped:e0.length-e2}},start_of_day:function(T){var e0;e0=new Date();e0.setTime(T.getTime());e0.setHours(0);e0.setMinutes(0);e0.setSeconds(0);e0.setMilliseconds(0);return e0},to_iso8601_date:function(e2,e0,e1){var T;if(e0==null){e0=false}if(e1==null){e1=false}if(e0){T=e2.getUTCFullYear().toString()+"-"+(e2.getUTCMonth()+1).toString().lpad(2)+"-"+e2.getUTCDate().toString().lpad(2);if(e1){T+=" "+e2.getUTCHours().toString().lpad(2)+":"+e2.getUTCMinutes().toString().lpad(2)+":"+e2.getUTCSeconds().toString().lpad(2)}}else{T=e2.getFullYear().toString()+"-"+(e2.getMonth()+1).toString().lpad(2)+"-"+e2.getDate().toString().lpad(2);if(e1){T+=" "+e2.getHours().toString().lpad(2)+":"+e2.getMinutes().toString().lpad(2)+":"+e2.getSeconds().toString().lpad(2)}}return T},to_mysql_date:function(e3,T,e1){var e0,e4,e2;e0=e3.getFullYear().toString()+"-"+(e3.getMonth()+1).toString().lpad(2)+"-"+e3.getDate().toString().lpad(2);e2=e3.getHours().toString().lpad(2)+":"+e3.getMinutes().toString().lpad(2)+":"+e3.getSeconds().toString().lpad(2);e4="."+e3.getMilliseconds().toString().lpad(3);if(!T){return e0}if(!e1){return e0+" "+e2}return e0+" "+e2+e4},from_mysql_date:function(e0){var e2,e4,e1,e6,T,e5,e3;e6=e0.split(" ");e2=e6[0];e5=e6.length>1?e6[1]:false;e4=e2.split("-");cz(e4.length===3,"weird date format on "+this+", expected yyyy-mm-dd");e1=new Date(e4[0],parseInt(e4[1],10)-1,e4[2]);if(e5){e3=e5.split(":");cz(e3.length===3,"weird time format on "+this+", expected hh:mm:ss.ms");e1.setHours(e3[0]);e1.setMinutes(e3[1]);T=e3[2].split(".");e1.setSeconds(T[0]);if(T.length>1){e1.setMilliseconds(T[1])}}return e1},make_table:function(T,e6){var e1,e5,e7,e0,e3,e2,e4;e7=new Element("table",e6);e0=new Element("tbody");e7.__sert(e0);for(e5 in T){e4=T[e5];e2=new Element("tr");e3=new Element("td").insert(e5);e1=new Element("td").insert(e4);e2.__sert(e3);e2.__sert(e1);e0.__sert(e2)}return e7},validate_email:function(T){var e0;e0=new RegExp("^['&A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,15}$","i");return e0.test(T)},scrollTop:function(){return window.scrollY||document.documentElement.scrollTop||0},scrollLeft:function(){return window.scrollX||document.documentElement.scrollLeft||0},scried:{},scry:function(e1){var e0,T;T=this.scried;e0=T[e1];if(!e0){e0=$(e1);T[e1]=e0}return e0},urlquote:function(T){return T.split("/").map(encodeURIComponent).join("/")},ie8:Prototype.Browser.IE&&document.documentMode&&true,ie:Prototype.Browser.IE,log:function(){var e0,T;if(!Constants.IS_PROD){if(Prototype.Browser.IE){return(e0=$("ieconsole"))!=null?e0.innerHTML+=$A(arguments).join(" ")+"<br>":void 0}else{return typeof console!=="undefined"&&console!==null?(T=console.log)!=null?T.apply(console,$A(arguments)):void 0:void 0}}},childElement:function(e1,e0){var T;T=this.childElementWithIndex(e1,e0);return T[0]},childElementWithIndex:function(e6,e1){var e3,e5,e2,e0,e4,T;e3=0;e0=e6.childNodes;for(e2=e4=0,T=e0.length;e4<T;e2=++e4){e5=e0[e2];if(e5.nodeType===1&&e3++===e1){return[e5,e2]}}return[false,false]},disableSelection:function(T){T.onselectstart=function(){return false};T.unselectable="on";T.style.MozUserSelect="none";return T.style.cursor="default"},enableSelection:function(T){T.onselectstart=function(){return true};T.unselectable="off";T.style.MozUserSelect="";return T.style.cursor=""},disable_ie_image_dragging:function(){if(Prototype.Browser.IE&&Prototype.Browser.IEV<9){return document.ondragstart=function(){return false}}},bsearch:function(T,e6,e4,e3){var e1,e2,e0,e5;if(!e4){e4=function(e7,e8){return e7-e8}}e1=T.length;e2=0;while(e1>e2){e0=Math.floor(e1/2+e2/2);e5=e4(T[e0],e6);if(e5>0){e1=e0}else{if(e5<0){e2=e0+1}else{return e0}}}if(e3){return e2}else{return -1}},nonce:function(){var e1,T,e0;e1=new Date();e0=e1.getTime().toString();T=Math.floor(Math.random()*1000000).toString().lpad(6);return e0+T},focus:function(e0){if(e0){e0=$(e0);try{return e0.focus()}catch(T){}}},sumStyles:function(e2,e3){var T,e1,e4,e0;e1=0;if(e2){for(e4=0,e0=e3.length;e4<e0;e4++){T=e3[e4];e1+=parseInt(e2.getStyle(T),10)||0}}return e1},async_load_script:function(e0){var T;T=function(){var e2,e1;e1=document.createElement("script");e1.src=e0;e1.type="text/javascript";e1.async=true;e2=document.getElementsByTagName("script")[0];return e2.parentNode.insertBefore(e1,e2)};if(document.readyState==="complete"){return T()}else{if(window.attachEvent!=null){return window.attachEvent("onload",T)}else{return window.addEventListener("load",T,false)}}},smart_window_load:function(T){if(document.readyState==="complete"){return T.defer()}else{return Event.observe(window,"load",T)}},isNumber:function(T){return !isNaN(Number(T,10))},shorten_url:function(T,e0){return new Ajax.DBRequest("/shorten_url",{parameters:{url:T},onSuccess:function(e1){return e0(e1.responseText)}})},falsy_to_empty:function(T){return T||""},preloaded_images:{},preload_image:function(e2,e1,e0){var T;if(this.preloaded_images[e2]){return}T=new Image();if(e1!=null){Element.extend(T).observe("error",e1)}if(e0!=null){Element.extend(T).observe("load",e0)}T.src=e2;return this.preloaded_images[e2]=T},get_preloaded_image:function(T){if(this.preloaded_images[T]){return this.preloaded_images[T].clone()}else{return new Element("img",{src:T})}},clear_selected:function(){var T;if(window.getSelection){T=window.getSelection();if(T.removeAllRanges){return T.removeAllRanges()}}else{if(document.selection){return document.selection.empty()}}},is_mac:function(){return navigator.appVersion.indexOf("Mac")!==-1},is_windows:function(){return navigator.appVersion.indexOf("Windows")!==-1},in_scrollbar:function(T){var e1,e0;e1=20;e0=z.viewport_dimensions();return T>e0.width-e1},freshbutton_overlay:function(e0,T){var e2,e1;e1=e0 instanceof jQuery&&e0||bv(e0);e2=T instanceof jQuery&&T||bv(T);e1.on("mouseover",(function(e3){return function(){return e2.addClass("hovered")}})(this));e1.on("mouseout",(function(e3){return function(){e2.removeClass("hovered");return e2.removeClass("pressed")}})(this));e1.on("mousedown",(function(e3){return function(){e2.removeClass("hovered");return e2.addClass("pressed")}})(this));return e1.on("mouseup",(function(e3){return function(){return e2.removeClass("pressed")}})(this))},isElm:function(T){if(typeof HTMLElement==="object"){return T instanceof HTMLElement}else{return T&&typeof T==="object"&&T.nodeType===1&&typeof T.nodeName==="string"}},_track_twitter_chars_left:function(e0,e1){var T;clearInterval(this.chars_left_interval);T=(function(e2){return function(){var e3,e4;e3=$("twitter-chars");e4=e1-$F(e0).strip().length;if(e4<0){e3.addClassName("too-long")}else{e3.removeClassName("too-long")}return e3.__date(e4)}})(this);return this.chars_left_interval=setInterval(T,250)},session_storage_set:function(T,e0){if(!window.sessionStorage||!window.JSON){return}return window.sessionStorage.setItem(T,JSON.stringify(e0))},session_storage_get:function(T){if(window.sessionStorage&&window.JSON){return JSON.parse(window.sessionStorage.getItem(T))}},pdf_plugins:function(){var e1,e0,T;T=/Chrome PDF|Adobe Reader|Adobe PDF|Acrobat/gi;return e1=(function(){var e5,e3,e4,e2;e4=window.navigator.plugins;e2=[];for(e5=0,e3=e4.length;e5<e3;e5++){e0=e4[e5];if(T.test(e0.name)){e2.push(e0)}}return e2})()},get_window_location:function(){return window.location}};dQ.scrollLeft=dQ.scrollLeft.cached(50);dQ.scrollTop=dQ.scrollTop.cached(50);dH=B.UIButton=(function(){T.prototype.selector=function(){return".ui-button"};T.prototype.over=function(e0,e1){return e1.addClassName("over")};T.prototype.out=function(e0,e1){return e1.removeClassName("over")};T.prototype.down=function(e0,e1){return e1.addClassName("down")};T.prototype.up=function(e0){return $$(this.selector()+".down").invoke("removeClassName","down")};function T(){this.clear=dg(this.clear,this);this.up=dg(this.up,this);this.listen()}T.prototype.active=function(e1,e2){var e0;e0=bv(e2);if(e0.hasClass("ui-button-dropdown")){if(e0.hasClass("active")){bv(document).trigger("dropdownClosed",[1])}else{bv(document).trigger("dropdownOpened",[1])}}return e0.toggleClass("active")};T.prototype.clear=function(e6){var e1,e0,e5,e8,e7,e4,e2,e9,e3;e7=$(e6.target);e0=this.selector()+".active";e4=e7.match(e0)&&e7||e7.up(e0);e5=0;e3=$$(e0);for(e2=0,e9=e3.length;e2<e9;e2++){e8=e3[e2];e1=bv(e8);if(e4!==e8){if(e1.hasClass("active")&&e1.hasClass("ui-button-dropdown")){e5+=1}e1.removeClass("active")}}return bv(document).trigger("dropdownClosed",[e5])};T.prototype.listen=function(){$(document.body).on("mouseover",this.selector(),this.over);$(document.body).on("mouseout",this.selector(),this.out);$(document.body).on("mousedown",this.selector(),this.down);document.on("mouseup",this.up);$(document.body).on("click",this.selector(),this.active);return document.on("click",this.clear)};return T})();if(window.console==null){window.console={log:function(){},profile:function(){},profileEnd:function(){}}}document.observe("script:loaded",function(){var e1,e3,e0,e2,T;new dH();if(dQ.ie8){e2=$$("#page-header a, #page-footer a");T=[];for(e3=0,e0=e2.length;e3<e0;e3++){e1=e2[e3];if(e1.target==="_blank"){T.push(e1.target="")}else{T.push(void 0)}}return T}});c5=__CONDITIONAL_JS__.Trace=B.Trace=(function(){var T;T=[];return{log:function(){var e0;e0=bU.time()+": "+$A(arguments).join(" ");return T.push(e0)},get:function(){return T.join("\n")}}})();es=B.T=function(){return c5.log.apply(this,$A(arguments))};document.observe("script:loaded",function(){var T;es("dom:loaded");T=function(){var e2,e0,e1,e3;e1=$("page-content");if(e1){e3=z.viewport_dimensions();e0=$(document.body);e2="absolutize";if(e3.width<e1.getWidth()){return e0.addClassName(e2)}else{return e0.removeClassName(e2)}}};Event.observe(window,"resize",$u.debounce(T,150));return T()});Event.observe(window,"load",function(){return es("window:load")});a5=B.URLUtil={absolutize:function(T){if(T.startsWith("https://")||T.startsWith("http://")){return T}else{if(T.charAt(0)==="/"){return""+window.location.protocol+"//"+window.location.host+T}else{return cz(0,"absolutize is confused by "+T)}}}};dk=B.Velocity={scroll_container:null,velocity:0,last_nonzero_velocity:0,old_y:0,max_delta_y:0,calculate_velocity:function(){this.velocity=this.max_delta_y;if(this.velocity!==0){this.last_nonzero_velocity=this.velocity}return this.max_delta_y=0},capture_new_y_pos:function(){var T,e0;if(this.old_y==null){this.old_y=this.scroll_container!=null?this.scroll_container.scrollTop:z.scroll_offsets().top;return}if(this.max_delta_y==null){this.max_delta_y=0;return}e0=this.scroll_container!=null?this.scroll_container.scrollTop:z.scroll_offsets().top;T=Math.abs(this.max_delta_y)<Math.abs(e0-this.old_y);if(T){this.max_delta_y=e0-this.old_y;return this.old_y=e0}},start_capture:function(T){this.scroll_container=T;this.velocity_calculator_interval=setInterval(this.calculate_velocity.bind(this,500));if(this.scroll_container!=null){return this.scroll_container.observe("scroll",this.capture_new_y_pos.bind(this))}else{return Event.observe(window,"scroll",this.capture_new_y_pos.bind(this))}},get:function(T){if(T==null){T=false}cz(this.velocity_calculator_interval!=null,"Haven't started capturing velocity");if(T){return this.last_nonzero_velocity}return this.velocity}};var de;de=B.DomUtil={fromElm:function(T){return $(T).innerHTML},updateFromElm:function(e0,T){e0=$(e0);T=$(T);return e0.update(this.fromElm(T))},fillVal:function(e6,e3){var e0,e5,e2,e4,T,e1;e4=$$("."+e3);e1=[];for(e5=0,e2=e4.length;e5<e2;e5++){e0=e4[e5];e0=$(e0);if(e0.tagName==="INPUT"){e0.value=e6;e1.push(e0.defaultValue=e6)}else{if(e0.innerHTML===""&&((T=e0.tagName)==="A"||T==="B"||T==="INPUT"||T==="I"||T==="LABEL"||T==="SELECT"||T==="SPAN"||T==="TEXTAREA")){dQ.log("Filling an empty value; this may look broken in IE7",e0)}e1.push(e0.innerHTML=e6)}}return e1},copy_to_clipboard:function(e7,e4,e8){var e2,e1,T,e0,e5,e3;e2=$("hold_clipboard");e2.value=e7;if(e2.createTextRange){e3=e2.createTextRange();if(e3&&((typeof BodyLoaded==="undefined"||BodyLoaded===null)||BodyLoaded===1)){try{return e3.execCommand("Copy")}catch(e6){e5=e6;e8=e8||el("Please copy the text below:");e4=e4||el("Copy text");this.fillVal(e7,"text-to-copy");this.fillVal(e8,"copy-modal-body");eS.show(e4,this.fromElm("copy-modal"),{wit_group:"copy_to_clipboard"});return $("text-to-copy").select()}}}else{if(!$("flashcb")){T=document.createElement("div");T.id="flashcb";document.body.appendChild(T)}$("flashcb").innerHTML="";e1=encodeURIComponent(e2.value);e0='<embed src="/static/swf/_clipboard.swf" FlashVars="clipboard=#{clipboard}" width="0" height="0" type="application/x-shockwave-flash"></embed>';return $("flashcb").innerHTML=e0}}};var am;am=B.RequestWatcher={reqs:[],working_msg:el("Still working...",{comment:"Comment about waiting for a process to complete"}),last_notification:null,TIMEOUT:10,watch:function(e0,e1){var T;T=this.reqs;if(!T.length){this.int_id=setInterval(this.check_up.bind(this),500)}if(e1){e0.skip_message=true}return T.push([e0,bU.time()])},check_up:function(){return this.scan(false)},remove:function(T){return this.scan(T)},scan:function(e4){var e8,e0,e2,T,e6,e5,e1,e7,e3;e0=bU.time();e2=[];e3=this.reqs;for(e1=0,e7=e3.length;e1<e7;e1++){T=e3[e1];e6=T[0];e5=T[1];e8=e0-e5;if(e6.transport.readyState===4){this.clearWorkingMessage();continue}if(e8>4000&&!e6.skip_message){e6.skip_message=true;if(ab.isShown()&&ab.current()===!U.undo_notification){this.last_notification=ab.success(this.working_msg)}}if(e8>this.TIMEOUT*1000&&e6.job){e6.transport.abort()}if(e6!==e4){e2.push([e6,e5])}else{e6.transport.abort()}}this.reqs=e2;if(!e2.length){return clearInterval(this.int_id)}},clearWorkingMessage:function(){if(ab.isShown()&&ab.current()===this.last_notification){return ab.clear()}}};bv(function(){var e1,e0,e2,T;e2=Prototype.Browser;T=[];for(e1 in e2){e0=e2[e1];if(e0===true){T.push(bv(document.body).addClass(e1.toLowerCase()))}}return T});var dx,aW,cS=[].slice;dx=B.HTML5_HISTORY=Modernizr.history;bv((function(T){return function(){return eo.init()}})(this));aW=B.HashRouter={watch_timer:null,callback_map:{},last_hash:"",last_prefix:"",_get_location:function(){return window.location.href},_set_location:function(T){return window.location.href=T},_replace_location:function(T){return window.location.replace(T)},init:function(){return this.watch_timer=setInterval(this.check_hash.bind(this),300)},watch:function(T,e0){this.callback_map[T]=e0;if(!this.watch_timer){return this.init()}},check_hash:function(){var e0,e1,e2,e4,e3,T;e4=this._get_location().split("#")[1];if(e4!=null){e4=e4.replace(/%27/g,"'")}if(this.last_hash===e4){return}this.last_hash=e4;if(this.last_prefix&&e4===""){e4=this.last_prefix+":"}else{if(!e4){return}}T=e4.split(":");e3=T.first();this.last_prefix=e3;e2=this.callback_map[e3];if(e2!=null){e1=(function(){var e8,e6,e7,e5;e7=T.slice(1);e5=[];for(e8=0,e6=e7.length;e8<e6;e8++){e0=e7[e8];e5.push(decodeURIComponent(e0))}return e5})();e2.apply(null,e1)}return $(document).fire("db:hash_change",{hash:e4})},_prepare_hash:function(e1){var e0,T;T=$A(e1).map(dQ.falsy_to_empty);e0=T.map(encodeURIComponent);return e0.join(":")},set_hash:function(){var T,e0;T=1<=arguments.length?cS.call(arguments,0):[];e0=this._prepare_hash(T);return this._set_hash(e0)},replace_hash:function(){var T,e0;T=1<=arguments.length?cS.call(arguments,0):[];e0=this._prepare_hash(T);return this._set_hash(e0,true)},_set_hash:function(e0,T){if(e0===""){e0="/"}this.last_hash=e0;if(!T){return this._set_location("#"+e0)}else{return this._replace_location("#"+e0)}}};var dq;dq=B.SharingState=(function(){function T(){}T.set_role=function(e0){bv(".shared-folder-role-param").val(e0);return this.role=e0};T.set_is_merged=function(e0){return this.is_merged=e0};T.set_team_name=function(e0){return this.team_name=e0};T.set_team_permissions=function(e1,e0){if(e1==null){e1=false}if(e0==null){e0=false}this.team_only=e1;return this.show_groups=e0};T.set_not_logged_in_role_and_email=function(e1,e0){this.not_logged_in_role=e1;return this.not_logged_in_email=e0};T.set_show_inbox=function(e0){return this.show_inbox=e0};return T})();var aR;aR=B.SharingUtil=(function(){function T(){}T.success_string_for_recipients=function(e0){var e1;if(e0.length===1){if(e0[0].indexOf("@")===-1){e1=el("Sent to %(recipient)s.",{comment:"Recipient is a user's name"}).format({recipient:e0[0]})}else{e1=el("Sent to %(recipient)s.",{comment:"Recipient is an email address"}).format({recipient:e0[0]})}}else{if(e0.length===2){if(e0[0].indexOf("@")===-1){if(e0[1].indexOf("@")===-1){e1=el("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"Recipients are users' names."}).format({recipient_first:e0[0],recipient_second:e0[1]})}else{e1=el("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"First recipient is a user's name, second is an email address"}).format({recipient_first:e0[0],recipient_second:e0[1]})}}else{if(e0[1].indexOf("@")===-1){e1=el("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"First recipient is an email address, second is a user's name"}).format({recipient_first:e0[0],recipient_second:e0[1]})}else{e1=el("Sent to %(recipient_first)s and %(recipient_second)s.",{comment:"Recipients are email addresses"}).format({recipient_first:e0[0],recipient_second:e0[1]})}}}else{if(e0[0].indexOf("@")===-1){e1=el("Sent to %(recipient)s and %(num_others)s others.",{comment:"num_others is 2 or more"}).format({recipient:e0[0],num_others:e0.length-1})}else{e1=el("Sent to %(recipient)s and %(num_others)s others.",{comment:"num_others is 2 or more"}).format({recipient:e0[0],num_others:e0.length-1})}}}return e1};return T})();var be,cg;be=B.SharingApi=(function(){T.REQUEST_SUCCEEDED_EVENT="db:sharing_api:request_succeeded";function T(e0){this.user=e0}T.prototype.invite_more_to_folder=function(e1,e0,e3,e5,e2,e4){var e6;e6={ns_id:e1,emails:e0.emails||[],fb_ids:e0.fb_ids||[],group_ids:e0.group_ids||[],new_style_group_ids:e0.new_style_group_ids||[],custom_message:e3||"",access_type:e5};return this._make_request("/share_ajax/invite_more",e6,e2,e4,true)};T.prototype.update_member_access_type=function(e0,e5,e3,e1,e2){var e4;e4={ns_id:e0,member_uid:e5,access_type:e3};return this._make_request("/share_ajax/update_member_access_type",e4,e1,e2)};T.prototype.update_team_folder_access_type=function(e1,e0,e2,e3){var e4;e4={ns_id:e1,can_edit:e0};return this._make_request("/team/admin/team_folder/update_access_type",e4,e2,e3,true,false)};T.prototype.update_invite_access_type=function(e4,e2,e0,e1){var e3;e3={invite_id:e4,access_type:e2};return this._make_request("/share_ajax/update_invite_access_type",e3,e0,e1)};T.prototype.share_folder=function(e9,e3,e2,e8,e7,e1,fa,e0,e5,fb,e4){var e6,fc;e6={emails:e2.emails||[],fb_ids:e2.fb_ids||[],group_ids:e2.group_ids||[],new_style_group_ids:e2.new_style_group_ids||[],custom_message:e8||"",audience:e7,inviter:e1,shared_link_policy:fa,access_type:e0,folder_settings:1};if(e9){e6.folder_name=e3;fc="/share_ajax/new"}else{e6.path=e3;fc=e5?"/share_ajax/existing_no_recipient":"/share_ajax/existing"}if(e7||e1){e6.custom_folder_settings=1}return this._make_request(fc,e6,fb,e4,true)};T.prototype.share_path=function(fb,e2,e7,e6,e1,e8,e0,e4,e9,e3){var e5,fa;e5={emails:e2.emails||[],fb_ids:e2.fb_ids||[],group_ids:e2.group_ids||[],new_style_group_ids:e2.new_style_group_ids||[],custom_message:e7||"",audience:e6,inviter:e1,shared_link_policy:e8,access_type:e0,folder_settings:1,path:fb};fa="/share_ajax/new_path";if(e6||e1){e5.custom_folder_settings=1}return this._make_request(fa,e5,e9,e3,true)};T.prototype.share_file=function(e4,e8,e2,e7,e6,e1,e9,e0,fa,e3){var e5,fb;e5={emails:e2.emails||[],fb_ids:e2.fb_ids||[],group_ids:e2.group_ids||[],new_style_group_ids:e2.new_style_group_ids||[],custom_message:e7||"",audience:e6,inviter:e1,shared_link_policy:e9,access_type:e0,folder_settings:1,path:e4,file_path:e8};fb="/share_ajax/share_file";if(e6||e1){e5.custom_folder_settings=1}return this._make_request(fb,e5,fa,e3,true)};T.prototype.unshare_folder=function(e1,e0,e2){var e3;e3={ns_id:e1,async:true};if(e0){e3.keep_files=true}return this._make_request("/share_ajax/unshare?long_running",e3,e2)};T.prototype.leave_folder=function(e1,e0,e2){var e3;e3={ns_id:e1};if(e0){e3.keep_files=true}return this._make_request("/share_ajax/leave?long_running",e3,e2)};T.prototype.transfer_ownership=function(e0,e2,e1){var e3;e3={ns_id:e0,user_id:e2};return this._make_request("/share_ajax/change_sf_owner",e3,e1)};T.prototype.cancel_invite=function(e0,e3,e1){var e2;e2={ns_id:e0,invite_id:e3};return this._make_request("/share_ajax/cancel_invite",e2,e1)};T.prototype.kick=function(e1,e3,e0,e2){var e4;e4={ns_id:e1,user_id:e3};if(e0){e4.keep_files=true}return this._make_request("/share_ajax/kick_user",e4,e2)};T.prototype.kick_group=function(e0,e2,e1){return ab.error("This feature has been removed.")};T.prototype.reinvite_user=function(e0,e3,e1){var e2;e2={ns_id:e0,invite_id:e3};return this._make_request("/share_ajax/reinvite_user",e2,e1)};T.prototype.update_sf_permissions=function(e0,e3,e1,e2){var e4;e4={ns_id:e0,new_permissions:e3};return this._make_request("/share_ajax/change_sf_perm",e4,e1,e2)};T.prototype.update_sf_team_permissions=function(e0,e3,e4,e2,e6,e1){var e5;e5={ns_id:e0,audience:e3,inviter:e4,shared_link_policy:e2};if(!(e6===void 0)){e5.activity_feed_enabled=e6}return this._make_request("/share_ajax/save_folder_settings",e5,e1)};T.prototype.validate_new_sf_path=function(e3,e0,e1){var e2;e2={share_type:"new",folder_name:e3};return this._make_request("/share_ajax/validate_folder",e2,e0,e1,true)};T.prototype.validate_existing_sf_path=function(e3,e0,e1){var e2;e2={share_type:"existing",path:e3};return this._make_request("/share_ajax/validate_folder",e2,e0,e1,true)};T.prototype._make_request=function(e2,e6,e0,e3,e5,e1){var e4;if(e5==null){e5=false}if(e1==null){e1=true}if(e1){e6[Constants.UID_PARAM_NAME]=this.user.id}if((e4=this.loading_elem)!=null){e4.addClass("ajax-loading")}return new Ajax.DBRequest(e2,{parameters:e6,onSuccess:function(e7){if(typeof e0==="function"){e0(e7)}return bv(document).trigger(T.REQUEST_SUCCEEDED_EVENT,{request_url:e2,ns_id:e6.ns_id||null})},onFailure:e3,onComplete:(function(e7){return function(){var e8;return(e8=e7.loading_elem)!=null?e8.removeClass("ajax-loading"):void 0}})(this),noAutonotify:e5})};return T})();cg=B.UserlessSharingApi=(function(){function T(){}T.prototype.get_inbox_counts=function(e0){return new Ajax.DBRequest("/inbox_count",{onSuccess:(function(e1){return function(e3){var e2;e2=JSON.parse(e3.responseText);cz(typeof e2==="object","bad inbox_count");return e0(e2)}})(this)})};T.prototype.get_folder_info=function(e0,e1){return new Ajax.DBRequest("/share_ajax/list_folders",{onSuccess:e0,onFailure:e1})};return T})();var p;p=INLINE_JS.SharingModals=B.SharingModals=(function(){function T(){}T.show_shared_folder_options_modal=function(e3,e0,e1,e2){if(e1==null){e1=true}if(e2==null){e2=true}return dM.push(new c2(e0,e3,e1,e2))};T.show_share_inband_modal=function(e2,e1,e0,e3){return eq.createAndShowInbandModal(e1,e2,true,e0,true,false,e3)};T.show_shared_folder_wizard=function(e0){return new ec(e0,{element_id:"share-a-folder-wizard-modal"}).show()};T.get_select_role_modal=function(){return new cv({element_id:"select-role-modal"})};T.start_wizard_without_user=function(){if(cB.get_viewer().is_paired){if(this.select_role_modal==null){this.select_role_modal=T.get_select_role_modal()}return this.select_role_modal.show()}else{return this.start_wizard_for_user(cB.get_viewer().get_users()[0])}};T.start_wizard_for_user=function(e0){if(dP.get_for_user(e0).verified_or_show(ee.SHARE_FOLDER)){return T.show_shared_folder_wizard(e0)}};T.show_share_existing_modal=function(e2,e0){var e1;if(dP.get_for_user(e0).verified_or_show()){e1=new ce(e0,{folder_name:e2,element_id:"invite-to-new-sf-wizard-modal-"+e0.id});return e1.show()}};T.show_shmodel_or_invite_modal=function(e1,e3,e0,e2){if(dP.get_for_user(e0).verified_or_show()){return new dK(e0,{path:e1,existing_sf:e3,element_id:"create-link-or-invite-wizard-modal",target_item:e2}).show()}};T.show_unshare_team_sf_modal=function(e1,e0,e3){var e2;e2=new bT(e1,{element_id:"unshare-confirm-modal",team_shared_folder:true,ns_id:e0,folder_path:e3});return e2.show()};T.show_ignore_modal=function(e1,e4,e0){var e3,e2,e5;cz(e0,"Share ignore did not get an ns_id");e5=el("Permanently remove '%(folder_name)s'").format({folder_name:bK.em_snippet(av.filename(e4),15)});e3={path:e4,ns_id:e0};e2=new c7(e1,{element_id:"ignore-confirm",title:e5});e2.on_confirm_button_click=function(e8){var e7,e6,e9;e8.preventDefault();e7=bv(e8.target);e6=e7.closest("form");e9=function(fa){ab.success(el("Removed shared folder successfully."));document.fire(aC.SF_IGNORE,{target_ns_id:e0,user_id:e1.id});return e2.hide()};return bJ.ajax_submit(e6[0],false,e9,void 0,e7[0],e3)};return e2.show()};T.show_rejoin_modal=function(e1,e4,e0){var e3,e2,e5;cz(e0,"Rejoin didn't get an ns_id");e5=el("Rejoin the shared folder '%(folder_name)s'?").format({folder_name:bK.em_snippet(av.filename(e4),13)});e3={path:e4,ns_id:e0};e2=new c7(e1,{element_id:"rejoin-confirm",title:e5});e2.on_confirm_button_click=function(e8){var e7,e6,e9;e8.preventDefault();e7=bv(e8.target);e6=e7.closest("form");e9=function(fc){var fa,fb;fb=fc.responseText;fa=av.filename(fb);ab.success(el("Rejoined shared folder successfully."));document.fire(aC.SF_REJOIN,{target_ns_id:e0,user_id:e1.id,filename:fa,mount_point:fb});return e2.hide()};return bJ.ajax_submit(e6[0],false,e9,void 0,e7[0],e3)};return e2.show()};T.show_invites=function(){return dM.push(new cr({element_id:"invitation-page-modal",endpoint_url:"/share_ajax/get_invitation_page"}))};T.show_shared_subfolder_modal=function(e1,e3){var e6,e4,e5,e0,e2;e5=bK.em_snippet(av.filename(e1),14);e4=el("Can't share folder");e0="'%(parent_shared_folder)s' ".format({parent_shared_folder:e5});de.fillVal(e0.escapeHTML(),"parent_shared_folder_name");e6=el("Share '%(parent_shared_folder)s' folder");e2=e6.format({parent_shared_folder:e5});($("share_parent_folder_button")).value=e2;eS.show(el("Loading shared folder options..."),"<p style='margin: 3em 0; text-align: center;'> <img src='/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif' alt=''/></p>");bv("#share_parent_folder_button").on("click",(function(e7){return function(e8){eS.hide();return e7.show_shared_folder_options_modal(e1,e3)}})(this));return eS.show(e4,$("share_subfolder"))};return T})();var c1;c1=B.InviteFormController=(function(){function T(e2,e1,e0,e7,e6,e5){var e4,e3;this.user=e2;this.$form=e1;this.members=e0;this.invitees=e7;this.new_style_groups=e6;this.team_only=this.$form.data("team-only");e3={tokens:[",",";"],include_fb:true,members:this.members,invitees:this.invitees,new_style_groups:this.new_style_groups,contacts_only:true};if(this.user.role==="work"){e4=Autocompleter.TeamTokenizer;e3.team_only=this.team_only}else{e4=Autocompleter.ContactsTokenizer;e3.include_team=true}if(this.user.role==="work"&&(__CIRCULAR_DEPENDENCY__.GroupsApi!=null)){e3.include_new_style_groups=true}this.sharing_options_auto_completer=new e4(this.user,e5+"-new-collab-input",e5+"-new-whobulk",e5+"-hidden-input",e3);b8._create(this.$form.find(".custom-message-container")[0]);if(this.user.role==="work"){this.team_shared_folder_controller=new i(this.$form)}}T.prototype.listen=function(){return this.sharing_options_auto_completer.listen()};T.prototype.reset_autocompleter=function(){return this.sharing_options_auto_completer.clearTokens()};T.prototype.tokenize=function(){return this.sharing_options_auto_completer.tokenize_emails_input(true)};T.prototype.reset_options=function(){return bv(this.sharing_options_auto_completer.get_entry_container()).hide()};T.prototype.set_team_only=function(e0){this.team_only=e0;return this.sharing_options_auto_completer.setTeamOnly(e0)};T.prototype.extract_invitees=function(){var e3,e2,e1,e6,e5,e0,e4;e6={};e4=["emails","fb_ids","group_ids","new_style_group_ids"];for(e5=0,e0=e4.length;e5<e0;e5++){e2=e4[e5];e1=this.$form.find("input[name="+e2+"]");e6[e2]=[(function(){var e9,e8,e7;e7=[];for(e9=0,e8=e1.length;e9<e8;e9++){e3=e1[e9];e7.push(bv(e3).val())}return e7})()]}return e6};T.prototype.get_custom_message=function(){return this.$form.find("textarea[name='custom_message']").val()};T.prototype.get_access_type=function(){return this.$form.find(".can-edit-dropdown").data("selected-value")};return T})();var aH,c2,N,ej,aN,eB,df,cl,dC,bD,aD,bT,ar={}.hasOwnProperty,cE=function(e2,e0){for(var T in e0){if(ar.call(e0,T)){e2[T]=e0[T]}}function e1(){this.constructor=e2}e1.prototype=e0.prototype;e2.prototype=new e1();e2.__super__=e0.prototype;return e2},dg=function(T,e0){return function(){return T.apply(e0,arguments)}};dC=B.SharedFolderBaseModal=(function(e0){cE(T,e0);function T(e1,e2){this.user=e1;this.options=e2;T.__super__.constructor.call(this,this.options);this.team_shared_folder=this.options.team_shared_folder;this.path=this.options.folder_path;this.ns_id=this.options.ns_id;this.sharing_api=new be(this.user)}T.prototype.on_show=function(){return this.sharing_api.loading_elem=this.$modal_window};return T})(dS);c2=B.ExistingSharedFolderOptionsModal=(function(e0){cE(T,e0);function T(e2,e4,e3,e5,e1){var e7,e6;this.user=e2;if(e3==null){e3=true}if(e5==null){e5=true}this.restore_modal=e1;this.__show_modal=dg(this.__show_modal,this);this.__x_click_handler=dg(this.__x_click_handler,this);cz(e4!=null,"Missing folder path");this.path=av.normalize(e4);e6=el("Shared folder options for '%(folder)s'");e6=e6.format({folder:bK.em_snippet(av.filename(e4),13)});e7={};e7[Constants.UID_PARAM_NAME]=this.user.id;e7.max_results=20;e7.show_invite_form=e3;e7.show_folder_settings=e5;dM.register(aH.MODAL_DONE_VIEWING_EVENT,(function(e8){return function(){return typeof e8.restore_modal==="function"?e8.restore_modal():void 0}})(this));T.__super__.constructor.call(this,{element_id:"folder-share-show-modal",title:e6,endpoint_url:D({path:"/share_options"+this.path}).toString(),parameters:e7})}T.prototype.__x_click_handler=function(e2){var e1;T.__super__.__x_click_handler.apply(this,arguments);e1={path:this.path};a3.SharedFolderActivityLogger.log("web","invite_modal_x_button",this.user,e1);return typeof this.restore_modal==="function"?this.restore_modal():void 0};T.prototype.__show_modal=function(e2){var e1;T.__super__.__show_modal.apply(this,arguments);e1={path:this.path};return a3.SharedFolderActivityLogger.log("web","invite_modal_displayed",this.user,e1)};return T})(cr);aH=B.ExistingSharedFolderOptionsContent=(function(){T.CONTENT_LOADED_EVENT="db:sharing_options:content_loaded";T.MODAL_DONE_VIEWING_EVENT="db:sharing_options:modal_done_viewing_event";function T(e4,e2,e3,e0,e1){this.$root=e4;this.options=e0;this.show_invite_form=e1;this.show_email_verification=dg(this.show_email_verification,this);this.show_folder_settings=dg(this.show_folder_settings,this);this.toggle_from_invite_mode=dg(this.toggle_from_invite_mode,this);this.toggle_to_invite_mode=dg(this.toggle_to_invite_mode,this);this.show_leave_folder_modal=dg(this.show_leave_folder_modal,this);this.show_owner_leave_folder_warning=dg(this.show_owner_leave_folder_warning,this);this.show_access_request_link_modal=dg(this.show_access_request_link_modal,this);this.show_unshare_folder_modal=dg(this.show_unshare_folder_modal,this);this.show_uninvite_modal=dg(this.show_uninvite_modal,this);this.show_transfer_user_modal=dg(this.show_transfer_user_modal,this);this.show_kick_group_modal=dg(this.show_kick_group_modal,this);this.show_kick_user_modal=dg(this.show_kick_user_modal,this);this.update_tf_access=dg(this.update_tf_access,this);this.update_sf_perms=dg(this.update_sf_perms,this);this.reinvite_user=dg(this.reinvite_user,this);this.submit_invitations=dg(this.submit_invitations,this);this.maybe_load_more=dg(this.maybe_load_more,this);this.extract_user_data_and_call=dg(this.extract_user_data_and_call,this);this.extract_invitee_data_and_call=dg(this.extract_invitee_data_and_call,this);this._disable_token_for_sf=dg(this._disable_token_for_sf,this);this.user=cB.get_viewer().get_user_by_id(e2);this.path=av.normalize(e3);if(this.options){this.members=this.options.folder_members;this.invitees=this.options.folder_invitees;this.new_style_groups=this.options.new_style_groups;this.num_total=this.options.num_total}this.$root.find(".bubble-dropdown").click(function(e5){z.controller(bv(e5.target).closest(".sf-action-dropdown")).closeDropdown();return true});this.start=20;this.max_results=100;this.maybe_load_more();this.sharing_api=new be(this.user);this.sharing_api.loading_elem=this.$root;a6.register_all();cT.register_all();this.ns_id=this.$root.data("ns-id");this.$invite_form=this.$root.find(".invite-more-form");this.sf_access_type=this.$invite_form.find(".sf-invite-can-edit");this.team_shared_folder=this.$root.data("team-shared-folder");this.$allow_members_table=this.$root.find(".allow-members-table");this.$folder_management_buttons=this.$root.find(".folder-management-buttons");this.log_extras={path:this.path,ns_id:this.ns_id};this.sf_access_type.hide();this.listen();dM.trigger(T.CONTENT_LOADED_EVENT)}T.prototype.listen=function(){var e3,e2,e1,e5,e0,e4;this.$root.find(".confirm-button").click((function(e6){return function(e7){e7.preventDefault();return e6.submit_invitations()}})(this));this.$root.find(".cancel-button").click((function(e6){return function(e7){e7.preventDefault();return e6.toggle_from_invite_mode()}})(this));if(this.show_invite_form){e3=this.$root.find("#sharing-options-new-collab-input");e4=["focus","keypress","contextmenu"];for(e5=0,e0=e4.length;e5<e0;e5++){e1=e4[e5];e3.off(e1);e3.on(e1,this.toggle_to_invite_mode)}e2=this.$root.find("#custom-message-wizard");e2.on("focus",this.toggle_to_invite_mode);this.$root.find(".change-settings-link").on("click",this.show_folder_settings);this.$root.find(".invite-verify-email").on("click",this.show_email_verification);if(this.$invite_form.length&&!this.team_shared_folder){this.invite_form_controller=new c1(this.user,this.$invite_form,this.members,this.invitees,this.new_style_groups,"sharing-options")}}this.$root.on("click","a.leave-folder",(function(e6){return function(e7){e7.preventDefault();a3.SharedFolderActivityLogger.log("web","invite_modal_leave_button",e6.user,e6.log_extras);return e6.show_leave_folder_modal()}})(this));this.$root.on("click","a.owner-leave-folder",(function(e6){return function(e7){e7.preventDefault();a3.SharedFolderActivityLogger.log("web","invite_modal_owner_leave_button",e6.user,e6.log_extras);return e6.show_owner_leave_folder_warning()}})(this));this.$root.on("click","a.kick-user",(function(e6){return function(e7){return e6.extract_user_data_and_call(e7,e6.show_kick_user_modal)}})(this));this.$root.on("click","a.kick-group",(function(e6){return function(e9){var e7,e8,fa;e9.preventDefault();e7=bv(e9.currentTarget);fa=e7.data("group-name");e8=e7.data("group-gid");return e6.show_kick_group_modal(fa,e8)}})(this));this.$root.on("click","a.make-owner",(function(e6){return function(e7){return e6.extract_user_data_and_call(e7,e6.show_transfer_user_modal)}})(this));this.$root.on("click","a.send-email",(function(e6){return function(e8){var e7,e9;e8.preventDefault();e7=bv(e8.currentTarget);e9=e7.data("email");return window.location=D({scheme:"mailto",path:e9}).toString()}})(this));this.$root.on("click","a.reinvite-user",(function(e6){return function(e7){return e6.extract_invitee_data_and_call(e7,e6.reinvite_user)}})(this));this.$root.on("click","a.uninvite-user",(function(e6){return function(e7){return e6.extract_invitee_data_and_call(e7,e6.show_uninvite_modal)}})(this));this.$root.on("click","input.sf-action-leave",(function(e6){return function(e7){e7.preventDefault();a3.SharedFolderActivityLogger.log("web","invite_modal_leave_button",e6.user,e6.log_extras);return e6.show_leave_folder_modal()}})(this));this.$root.on("click","input.sf-action-unshare",(function(e6){return function(e7){e7.preventDefault();a3.SharedFolderActivityLogger.log("web","invite_modal_unshare_button",e6.user,e6.log_extras);return e6.show_unshare_folder_modal()}})(this));this.$root.on("click","input.simple-sharing-remove-link",(function(e6){return function(e7){e7.preventDefault();return e6._disable_token_for_sf(function(){return dM.pop()})}})(this));this.$root.on("click","a.remove-link",(function(e6){return function(e7){var e8;e7.preventDefault();e8=function(){var e9;e9=dS.get_containing_modal(e6.$root);if(e9&&e9 instanceof cr){return e9.fetch()}};return e6._disable_token_for_sf(e8)}})(this));this.$root.on("click","input.sf-action-get-link",(function(e6){return function(e7){e7.preventDefault();return e6.show_access_request_link_modal()}})(this));this.$root.on("click","input.sf-action-done",(function(e6){return function(e7){e7.preventDefault();a3.SharedFolderActivityLogger.log("web","invite_modal_done_button",e6.user,e6.log_extras);dM.trigger(T.MODAL_DONE_VIEWING_EVENT);return dM.pop()}})(this));this.$root.on("click","input#change-sf-perm-checkbox",(function(e6){return function(e8){var e7;e7=bv(e8.currentTarget);return e6.update_sf_perms(e7.prop("checked"))}})(this));return this.$root.on("click","input#change-tf-access-checkbox",(function(e6){return function(e8){var e7;e7=bv(e8.currentTarget);return e6.update_tf_access(!e7.prop("checked"))}})(this))};T.prototype._disable_token_for_sf=function(e0){return cs.WebRequest({url:D({path:"/sm/disable_token_at_path"+av.normalize(this.path)}),subject_user:this.user.id,type:"POST",success:(function(e1){return function(){bv(document).trigger("db:browse:update");ab.success(el("Link removed"));a3.SimpleSharingLogger.log(e1.user.id,25);return typeof e0==="function"?e0():void 0}})(this),error:(function(e1){return function(){return ab.error(el("An error occurred when removing link"))}})(this)})};T.prototype.extract_invitee_data_and_call=function(e3,e2){var e0,e4,e1;e3.preventDefault();e0=bv(e3.currentTarget);e1=e0.data("email-or-fbname");e4=e0.data("invite-id");return e2(e1,this.ns_id,e4)};T.prototype.extract_user_data_and_call=function(e5,e4){var e1,e3,e2,e0;e5.preventDefault();e1=bv(e5.currentTarget);e2=e1.data("display-name");e3=e1.data("email");e0=e1.data("user-id");return e4(e2,e3,e0)};T.prototype.maybe_load_more=function(){var e1,e0,e2;e0=this.$root.closest("body").length;if(!e0){return}if((this.num_total==null)||(this.start>=this.num_total)){bv("#more-members-spinner").hide();return}bv("#more-members-spinner").show();e2={};e2[Constants.UID_PARAM_NAME]=this.user.id;e2.start=this.start;e2.max_results=this.max_results;e1=D({path:"/share_options"+this.path}).toString();this.$root.removeClass("ajax-loading");new bp(this.$root,e1,{data:e2,success:(function(e3){return function(e7,e4,e8){var e5,e6;if(((e6=e7.data)!=null?e6.options:void 0)!=null){e5=e7.data.options;if((e3.members!=null)&&(e5.folder_members!=null)){Array.prototype.push.apply(e3.members,e5.folder_members)}if((e3.invitees!=null)&&(e5.folder_invitees!=null)){Array.prototype.push.apply(e3.invitees,e5.folder_invitees)}if((e3.new_style_groups!=null)&&(e5.new_style_groups!=null)){Array.prototype.push.apply(e3.new_style_groups,e5.new_style_groups)}}return e3.maybe_load_more()}})(this),error:(function(e3){return function(e6,e4,e5){return ab.error("Unable to load all members of this folder.")}})(this)});return this.start=this.start+this.max_results};T.prototype.submit_invitations=function(){var e3,e2,e5,e1,e4,e0;this.invite_form_controller.tokenize();e5=this.invite_form_controller.extract_invitees();e4=this.invite_form_controller.get_custom_message();e3=this.invite_form_controller.get_access_type();e1=$u.clone(this.log_extras);e1.access_type=e3;a3.SharedFolderActivityLogger.log("web","invite_modal_send_invites_button",this.user,e1);e0=(function(e6){return function(e8){var e7;e7=dS.get_containing_modal(e6.$root);if(e7&&e7 instanceof cr){e7.fetch()}else{dM.pop()}ab.success(e8.responseText);return document.fire(aC.SF_INVITE,{target_ns_id:e6.ns_id,user_id:e6.user.id})}})(this);e2=(function(e6){return function(e7){return eu.show_validation_error(e7,e6.$root.find(".tokenized_autocompleter_container"))}})(this);return this.sharing_api.invite_more_to_folder(this.ns_id,e5,e4,e3,e0,e2)};T.prototype.reinvite_user=function(e2,e0,e1){return this.sharing_api.reinvite_user(e0,e1,(function(e3){return function(fa){var e7,e8,e9,e6,e4,e5;e6=JSON.parse(fa.responseText);e4=e6.status;if(e4==="OK"){e5=el("%(email_or_fbname)s was reinvited successfully");e5=e5.format({email_or_fbname:e2});return ab.success(e5)}else{e9=e6.reason;if(e9==="ACCEPTED"){e7=el("That invitation has already been accepted.")}else{if(e9==="DECLINED"){e7=el("That invitation has already been declined.")}else{e7=el("You no longer have permission to perform this action.")}}ab.error(e7);if(e6.reload){e8=dS.get_containing_modal(e3.$root);if(e8&&e8 instanceof cr){return e8.fetch()}}}}})(this))};T.prototype.update_sf_perms=function(e1){var e2,e3,e0;this.$root.find("#change-sf-perm-saving").show();e2=(e1?1:0);e0=(function(e4){return function(e5){if(e1){ab.success(el("Editors can now manage membership of this folder."))}else{ab.success(el("Editors can no longer manage membership of this folder."))}return e4.$root.find("#change-sf-perm-saving").hide()}})(this);e3=(function(e4){return function(e5){if(e5.responseText.indexOf("err:")===0){ab.error(e5.responseText.substr(4))}else{ab.error(el("Error updating your preference! Please try again."))}return e4.$root.find("#change-sf-perm-saving").hide()}})(this);return this.sharing_api.update_sf_permissions(this.ns_id,e2,e0,e3)};T.prototype.update_tf_access=function(e1){var e2,e0;e0=(function(e3){return function(e4){if(e1){return ab.success(el("Team members can now change folder contents."))}else{return ab.success(el("Team members can no longer change folder contents."))}}})(this);e2=(function(e3){return function(e4){return ab.error(el("Error updating your preference! Please try again."))}})(this);return this.sharing_api.update_team_folder_access_type(this.ns_id,e1,e0,e2)};T.prototype.show_kick_user_modal=function(e2,e1,e0){return dM.push(new eB(this.user,{element_id:"kick-confirm-modal",ns_id:this.ns_id,user_name:e2,folder_path:this.path,user_id:e0}))};T.prototype.show_kick_group_modal=function(e0,e1){return dM.push(new aN(this.user,{element_id:"kick-group-confirm-modal",ns_id:this.ns_id,group_name:e0,folder_path:this.path,group_id:e1}))};T.prototype.show_transfer_user_modal=function(e2,e1,e0){return dM.push(new bD(this.user,{element_id:"transfer-confirm-modal",user_id:e0,user_name:e2,ns_id:this.ns_id,folder_path:this.path}))};T.prototype.show_uninvite_modal=function(e2,e0,e1){return dM.push(new aD(this.user,{element_id:"uninvite-confirm-modal",email_or_fbname:e2,ns_id:e0,invite_id:e1,folder_path:this.path}))};T.prototype.show_unshare_folder_modal=function(){return dM.push(new bT(this.user,{element_id:"unshare-confirm-modal",team_shared_folder:this.team_shared_folder,ns_id:this.ns_id,folder_path:this.path}))};T.prototype.show_access_request_link_modal=function(){return dM.push(new c3(this.user.id,this.path,void 0,true))};T.prototype.show_owner_leave_folder_warning=function(){return ab.error(el("You can't leave this folder because you're the owner. You must transfer ownership to another member before you can leave."))};T.prototype.show_leave_folder_modal=function(){return dM.push(new df(this.user,{element_id:"leave-confirm-modal",team_shared_folder:this.team_shared_folder,ns_id:this.ns_id,folder_path:this.path}))};T.prototype.toggle_to_invite_mode=function(){var e0;this.$allow_members_table.show();this.$folder_management_buttons.hide();this.$invite_form.removeClass("collapsed");return(e0=this.sf_access_type)!=null?e0.show():void 0};T.prototype.toggle_from_invite_mode=function(){var e1,e0;this.$allow_members_table.hide();this.$folder_management_buttons.show();this.$invite_form.addClass("collapsed");if((e1=this.sf_access_type)!=null){e1.hide()}return(e0=this.invite_form_controller)!=null?e0.reset_autocompleter():void 0};T.prototype.show_folder_settings=function(e0){a3.SharedFolderActivityLogger.log("web","invite_modal_change_settings",this.user,this.log_extras);e0.preventDefault();dM.register(ej.SAVED_PERMISSIONS,(function(e1){return function(e3,e2){if(e2!=null){return e1.set_team_only(e2)}}})(this));return dM.push(new ej(this.user,this.path,this.ns_id))};T.prototype.show_email_verification=function(e0){dM.pop();return dP.get_for_user(this.user).show()};T.prototype.set_team_only=function(e0){var e1;this.invite_form_controller.set_team_only(e0);e1=this.$invite_form.add(this.$root.find(".external-invite-message,.member-info .folder-settings"));if(e0){return e1.addClass("team-only")}else{return e1.removeClass("team-only")}};return T})();df=B.LeaveFolderModal=(function(T){cE(e0,T);function e0(){this.before_show=dg(this.before_show,this);this.on_show=dg(this.on_show,this);this.on_confirm_button_click=dg(this.on_confirm_button_click,this);return e0.__super__.constructor.apply(this,arguments)}e0.prototype.on_confirm_button_click=function(e2){var e1;e2.preventDefault();e1=this.$modal_window.find("#keep_files").prop("checked");return this.sharing_api.leave_folder(this.ns_id,e1,(function(e3){return function(){var e4;e4=el("You removed yourself from '%(msg)s'.").format({msg:bK.em_snippet(av.filename(e3.path),25)});ab.success(e4);document.fire(aC.SF_LEAVE,{target_ns_id:e3.ns_id,folder_deleted:!e1,user_id:e3.user.id});return dM.clear()}})(this))};e0.prototype.on_show=function(){e0.__super__.on_show.apply(this,arguments);if(this.team_shared_folder){this.$modal_window.find(".keep_files_option").hide();return this.$modal_window.find(".keep_files_option").find("input").prop("checked",false)}else{this.$modal_window.find(".keep_files_option").show();return this.$modal_window.find(".keep_files_option").find("input").prop("checked",true)}};e0.prototype.before_show=function(){var e1;e1=el("Leave the shared folder '%(folder_name)s'");e1=e1.format({folder_name:bK.em_snippet(av.filename(this.path),14)});return this.format({".db-modal-title-text":e1})};return e0})(dC);bT=B.UnshareFolderModal=(function(e0){cE(T,e0);function T(){this.before_show=dg(this.before_show,this);this.on_show=dg(this.on_show,this);this.on_confirm_button_click=dg(this.on_confirm_button_click,this);return T.__super__.constructor.apply(this,arguments)}T.prototype.on_confirm_button_click=function(e2){var e1;e2.preventDefault();e1=this.$modal_window.find("#keep_files").prop("checked");return this.sharing_api.unshare_folder(this.ns_id,e1,(function(e3){return function(){var e4;e4=el("Unshared folder '%(folder_name)s'");e4=e4.format({folder_name:bK.em_snippet(av.filename(e3.path),25)});ab.success(e4);document.fire(aC.SF_UNSHARE,{target_ns_id:e3.ns_id,user_id:e3.user.id});return dM.clear()}})(this))};T.prototype.on_show=function(){T.__super__.on_show.apply(this,arguments);if(this.team_shared_folder){this.$modal_window.find(".tsf_unshare_desc").show();return this.$modal_window.find(".regular_unshare_desc").hide()}else{this.$modal_window.find(".tsf_unshare_desc").hide();return this.$modal_window.find(".regular_unshare_desc").show()}};T.prototype.before_show=function(){var e1;e1=el("Unshare '%(folder_name)s'");e1=e1.format({folder_name:bK.em_snippet(av.filename(this.path),21)});return this.format({".db-modal-title-text":e1})};return T})(dC);aD=B.UninviteModal=(function(e0){cE(T,e0);function T(e1,e2){this.before_show=dg(this.before_show,this);this.on_confirm_button_click=dg(this.on_confirm_button_click,this);this.email_or_fbname=e2.email_or_fbname;this.ns_id=e2.ns_id;this.invite_id=e2.invite_id;T.__super__.constructor.call(this,e1,e2)}T.prototype.on_confirm_button_click=function(e1){e1.preventDefault();return this.sharing_api.cancel_invite(this.ns_id,this.invite_id,(function(e2){return function(e8){var e6,e7,e5,e3,e4;e5=JSON.parse(e8.responseText);e3=e5.status;if(e3==="OK"){e4=el("%(email_or_fbname)s has been uninvited.").format({email_or_fbname:e2.email_or_fbname});ab.success(e4)}else{e7=e5.reason;if(e7==="ACCEPTED"){e6=el("That invitation has already been accepted.")}else{if(e7==="DECLINED"){e6=el("That invitation has already been declined.")}}ab.error(e6)}return dM.pop()}})(this))};T.prototype.before_show=function(e1){var e2;e2=el("Uninvite %(email_or_fbname)s?").format({email_or_fbname:bK.em_snippet(this.email_or_fbname,20)});return this.format({".uninvite-confirm-nickname":this.email_or_fbname,".uninvite-confirm-folder-name":av.filename(this.path),".db-modal-title-text":e2})};return T})(dC);eB=B.KickUserModal=(function(T){cE(e0,T);function e0(e1,e2){this.user=e1;this.options=e2;this.before_show=dg(this.before_show,this);this.on_confirm_button_click=dg(this.on_confirm_button_click,this);this.user_id=e2.user_id;this.user_name=e2.user_name;e0.__super__.constructor.call(this,e1,e2)}e0.prototype.on_confirm_button_click=function(e3){var e1,e2;e3.preventDefault();e1=this.$modal_window.find("#keep-files-check").prop("checked");this.sharing_api.kick(this.ns_id,this.user_id,e1,(function(e4){return function(){ab.success(el("User removed successfully."));bP.reload_folder_info_if_two_account();return dM.pop()}})(this));e2={ns_id:this.ns_id,kick_user_id:this.user_id,keep_files:e1};return a3.SharedFolderActivityLogger.log("web","invite_modal_kick_collaborator",this.user,e2)};e0.prototype.before_show=function(e1){var e2;e2=el("Remove %(person_name)s from this folder?");e2=e2.format({person_name:this.user_name});return this.format({".kick-confirm-nickname":this.user_name,".db-modal-title-text":e2})};return e0})(dC);aN=B.KickGroupModal=(function(T){cE(e0,T);function e0(e1,e2){this.user=e1;this.options=e2;this.before_show=dg(this.before_show,this);this.on_confirm_button_click=dg(this.on_confirm_button_click,this);this.group_id=e2.group_id;this.group_name=e2.group_name;e0.__super__.constructor.call(this,e1,e2)}e0.prototype.on_confirm_button_click=function(e1){e1.preventDefault();return __CIRCULAR_DEPENDENCY__.GroupsApi.remove_namespace_from_group({group_id:this.group_id,ns_id:this.ns_id},(function(e2){return function(){ab.success(el("Group removed successfully."));bP.reload_folder_info_if_two_account();return dM.pop()}})(this))};e0.prototype.before_show=function(){var e1;e1=el("Remove %(group_name)s from this folder?");e1=e1.format({group_name:this.group_name});return this.format({".kick-confirm-nickname":this.group_name,".db-modal-title-text":e1})};return e0})(dC);cl=B.MakeOwnerModal=(function(e0){cE(T,e0);function T(e1,e2){this.user=e1;this.options=e2;this.before_show=dg(this.before_show,this);this.on_confirm_button_click=dg(this.on_confirm_button_click,this);this.member_uid=e2.member_uid;this.member_name=e2.member_name;this.ns_id=e2.ns_id;this.access_type=e2.access_type;T.__super__.constructor.call(this,e1,e2)}T.prototype.on_confirm_button_click=function(e1){e1.preventDefault();return this.sharing_api.update_member_access_type(this.ns_id,this.member_uid,this.access_type,(function(e2){return function(){ab.success(el("%(name)s now is the owner.").format({name:e2.member_name}));return dM.pop()}})(this))};T.prototype.before_show=function(){var e1;e1=el("Make %(name)s the owner of this folder?");e1=e1.format({name:bK.em_snippet(this.member_name,14)});return this.format({".make-owner-confirm-nickname":this.member_name,".db-modal-title-text":e1})};return T})(dC);bD=B.TransferOwnershipModal=(function(e0){cE(T,e0);function T(e1,e2){this.user=e1;this.options=e2;this.before_show=dg(this.before_show,this);this.on_confirm_button_click=dg(this.on_confirm_button_click,this);this.user_id=e2.user_id;this.user_name=e2.user_name;T.__super__.constructor.call(this,e1,e2)}T.prototype.on_confirm_button_click=function(e1){e1.preventDefault();return this.sharing_api.transfer_ownership(this.ns_id,this.user_id,(function(e2){return function(e3){ab.success(el("Ownership changed successfully"));return dM.pop()}})(this))};T.prototype.before_show=function(){var e1;e1=el("Make %(person_name)s the owner of this folder?");e1=e1.format({person_name:bK.em_snippet(this.user_name,14)});return this.format({".change_sf_owner-confirm-nickname":this.user_name,".db-modal-title-text":e1})};return T})(dC);ej=B.ExistingSharedFolderPermissionsModal=(function(e0){cE(T,e0);T.SAVED_PERMISSIONS="existing_sf_permissions:saved";function T(e2,e3,e1,e6){var e5,e4;this.user=e2;this.path=e3;this.ns_id=e1;this.on_hide=e6;e5={ns_id:this.ns_id,folder_name:this.path};e5[Constants.UID_PARAM_NAME]=this.user.id;e4=el("'%(folder_name)s' settings");e4=e4.format({folder_name:bK.em_snippet(av.filename(this.path),13)});T.__super__.constructor.call(this,{element_id:"folder-permissions-modal",title:e4,endpoint_url:"/share_ajax/folder_settings",parameters:e5})}return T})(cr);N=B.ExistingSharedFolderPermissionsContent=(function(){function T(e1,e2,e0){this.$form=e1;this.ns_id=e0;this._submit=dg(this._submit,this);this.user=cB.get_viewer().get_user_by_id(e2);this.sharing_api=new be(this.user);this.sharing_api.loading_elem=this.$form;this._listen()}T.prototype._listen=function(){this.$form.find(".confirm-button").click(this._submit);return this.$form.find(".cancel-button").click(this._cancel)};T.prototype._cancel=function(){return dM.pop()};T.prototype._submit=function(e5){var e6,e0,e3,e2,e1,e4;e5.preventDefault();e0=this.$form.find("input[name=audience]:checked").val();e3=this.$form.find("input[name=inviter]:checked").val();e1=this.$form.find("input[name=shared_link_policy]:checked").val();e6=(e4=this.$form.find("input[name=activity_feed_enabled]:checked"))!=null?e4.val():void 0;this.sharing_api.update_sf_team_permissions(this.ns_id,e0,e3,e1,e6,(function(e7){return function(e9){var e8,fa;e8=JSON.parse(e9.responseText);fa=e8.team_only_invite;ab.success(e8.message);dM.trigger(ej.SAVED_PERMISSIONS,fa);return dM.pop()}})(this));false;e2={ns_id:this.ns_id,audience:e0,inviter:e3};return a3.SharedFolderActivityLogger.log("web","settings_modal_save",this.user,e2)};return T})();var aU,dR,eE,dK,aV,eu,ce,cp,ec,cX,b4,bI,cN,cM,cK,cI,ar={}.hasOwnProperty,cE=function(e2,e0){for(var T in e0){if(ar.call(e0,T)){e2[T]=e0[T]}}function e1(){this.constructor=e2}e1.prototype=e0.prototype;e2.prototype=new e1();e2.__super__=e0.prototype;return e2},dg=function(T,e0){return function(){return T.apply(e0,arguments)}};aU=B.BaseShareAFolderWizardModal=(function(T){cE(e0,T);e0.prototype.base_title=null;e0.prototype.personal_title=null;e0.prototype.work_title=null;function e0(e1,e2){this.user=e1;this.options=e2;e0.__super__.constructor.call(this,this.options);this.sharing_api=new be(this.user)}e0.prototype.before_show=function(){var e1;this.sharing_api.loading_elem=this.$modal_window;e1=this.base_title;if(cB.get_viewer().is_paired){if(this.user.role==="personal"){e1=this.personal_title}else{e1=this.work_title.format({team_name:cB.get_viewer().team_name})}}return this.format({".db-modal-title-text":e1})};return e0})(dS);ec=B.ShareAFolderWizardModal=(function(T){cE(e0,T);function e0(e1,e2){this.user=e1;this.options=e2;e0.__super__.constructor.call(this,this.user,this.options);this.base_title=el("Share a folder");this.personal_title=el("Share a folder from your personal Dropbox");this.work_title=el("Share a folder from your %(team_name)s Dropbox")}e0.prototype.on_show=function(){this.$modal_window.find("input#create-new-sf").prop("checked",true);this.$modal_window.find("a.back").on("click",(function(e1){return function(e2){e2.preventDefault();p.start_wizard_without_user();return e1.hide()}})(this));return this.$modal_window.find("#new-or-existing-sf li").on("click",(function(e1){return function(e2){bv(e2.currentTarget).find('input[name="sf_type"]').prop("checked",true);if(e1.$modal_window.find("input#create-new-sf").is(":checked")){return a3.SharedFolderActivityLogger.log("web","new_or_existing_modal_new_folder",e1.user)}else{return a3.SharedFolderActivityLogger.log("web","new_or_existing_modal_existing_folder",e1.user)}}})(this))};e0.prototype.on_confirm_button_click=function(e7){var e4,e6,e1,e3,e5,e2;e7.preventDefault();e6=this.$modal_window.find("input#create-new-sf").is(":checked");if(e6){e3=null;if(this.user.role==="work"){e5="shared-folder-type-wizard-modal";e2=dS.get_template(e5);if(e2.length){e3=new bI(this.user,{element_id:e5})}}if(e3===null){e3=new b4(this.user,{element_id:"share-new-folder-wizard-modal"})}this.hide();e1={selection:"new_folder"};a3.SharedFolderActivityLogger.log("web","new_or_existing_modal_next_button",this.user,e1);return e3.show()}e4=this.$modal_window.find(".ajax-loading-indicator").show();return bv.ajax({url:"/share_ajax/account_has_existing_folders",type:"post",subject_user:this.user,success:(function(e8){return function(e9){var fa;e9=JSON.parse(e9);if(e9===true){e3=new cX(e8.user,{element_id:"share-existing-folder-wizard-modal"});e1.has_existing_folder=true}else{fa=el("You don't have any existing folders. Please create and share a new folder.");e3=new b4(e8.user,{element_id:"share-new-folder-wizard-modal",error_msg:fa});e1.has_existing_folder=false}e8.hide();return e3.show()}})(this),error:(function(e8){return function(){return ab.error()}})(this),complete:(function(e8){return function(){return e4.hide()}})(this)},e1={selection:"existing_folder"},a3.SharedFolderActivityLogger.log("web","new_or_existing_modal_next_button",this.user,e1))};return e0})(aU);bI=B.SharedFolderTypeWizardModal=(function(e0){cE(T,e0);function T(e1,e2){this.user=e1;this.options=e2;T.__super__.constructor.call(this,this.user,this.options);this.work_title=el("Share a folder from your %(team_name)s Dropbox")}T.prototype.on_show=function(){this.$modal_window.find("input#team-folder-option").prop("checked",true);this.$modal_window.find("a.back").on("click",(function(e1){return function(e2){e2.preventDefault();p.start_wizard_for_user(e1.user);return e1.hide()}})(this));return this.$modal_window.find("#shared-folder-type li").on("click",(function(e1){return function(e2){bv(e2.currentTarget).find('input[name="shared_folder_type"]').prop("checked",true);if(e1.$modal_window.find("input#team-folder-option").is(":checked")){return a3.SharedFolderActivityLogger.log("web","shared_folder_type_team_folder",e1.user)}else{return a3.SharedFolderActivityLogger.log("web","shared_folder_type_shared_folder",e1.user)}}})(this))};T.prototype.on_confirm_button_click=function(e5){var e1,e3,e4,e2;e5.preventDefault();e1=(function(e6){return function(e9,e7){var e8;e9.preventDefault();e7.hide();e8=new e6.constructor(e6.user,e6.options);return e8.show()}})(this);e3=this.$modal_window.find("input#team-folder-option").is(":checked");if(e3){e4=new dI({element_id:"new-team-folder-modal",open_created_folder:true,back_fn:e1});e2="team_folder"}else{e4=new b4(this.user,{element_id:"share-new-folder-wizard-modal",back_fn:e1});e2="shared_folder"}a3.SharedFolderActivityLogger.log("web","shared_folder_type_next_button",this.user,{selection:e2});this.hide();return e4.show()};return T})(aU);eu=B.InlineModalValidationError=(function(){function T(){}T.show_validation_error=function(e7,e3){var e4,e5,e2,e1,e6,e0;if(e7.responseText.indexOf("err:{")===0){e0=e7.responseText.substr(4);e6=JSON.parse(e0);for(e5 in e6){e4=e6[e5];if("message_text" in e4){e1=e3.find("span.error-message");if(e1.length===0){e1=bv("<span/>").addClass("error-message");e3.prepend(e1)}e1.text(e4.message_text);return}}e3.find("span.error-message").remove();return ab.error()}else{e3.find("span.error-message").remove();if(e7.responseText.indexOf("err:")===0){e2=e7.responseText.substr(4);return ab.error(e2)}else{return ab.error()}}};return T})();cN=B.TeamSharedFolderWizardModalPage1=(function(T){cE(e0,T);function e0(e1,e2){this.user=e1;this.options=e2;this.__fix_position=dg(this.__fix_position,this);e0.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-wizard-page1 input[type=text]";this.base_title=el("Now, let's set up your team");this.options.vertical_offset=5}e0.prototype.on_show=function(){var e2,e4,e1,e3;e3=this.$modal_window.find(".suggestion-input");for(e4=0,e1=e3.length;e4<e1;e4++){e2=e3[e4];cT.register($(e2))}this.$modal_window.find("#validate-team-name").submit((function(e5){return function(e6){e6.preventDefault();return e5.on_confirm_button_click(e6)}})(this));if(this.options.error_msg){ab.error(this.options.error_msg)}return a3.SharedFolderActivityLogger.log("web","team_shared_group_name_land",this.user)};e0.prototype.on_confirm_button_click=function(e4){var e2,e1,e3;e4.preventDefault();e3=this.$modal_window.find("#new-team-shared-folder-name-input").val();e1=(function(e5){return function(){var e6;e6=new cM(e5.user,{team_name:e3,element_id:"team-shared-folder-wizard-modal-page2"});e5.hide();return e6.show()}})(this);e2=(function(e5){return function(e6){a3.SharedFolderActivityLogger.log("web","team_shared_group_name_folder_exists",e5.user);return eu.show_validation_error(e6,e5.$modal_window.find("#validate-team-name"))}})(this);return this.sharing_api.validate_new_sf_path(e3,e1,e2)};e0.prototype.__fix_position=function(e2){var e1;e1=this.$modal_window.find(".db-modal");return e1.css({margin:"0",position:"fixed"})};return e0})(aU);cM=B.TeamSharedFolderWizardModalPage2=(function(T){cE(e0,T);function e0(e1,e2){this.user=e1;this.options=e2;this.__fix_position=dg(this.__fix_position,this);this.on_confirm_button_click=dg(this.on_confirm_button_click,this);e0.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-email1 input[type=text]";this.base_title=el("Invite teammates");this.folder_name=this.options.team_name}e0.prototype.before_show=function(){var e1;e1=el("Add people to %(folder_name)s").format({folder_name:this.folder_name});return this.format({"#figcaption_headline":e1})};e0.prototype.on_show=function(){a3.SharedFolderActivityLogger.log("web","team_shared_group_emails_land",this.user);return this.$modal_window.find("#enter-email-invites").submit((function(e1){return function(e2){e2.preventDefault();return e1.on_confirm_button_click(e2)}})(this))};e0.prototype.on_confirm_button_click=function(e5){var e3,e2,e7,e1,e6,e4;e5.preventDefault();e7={emails:[]};a3.SharedFolderActivityLogger.log("web","team_shared_group_emails_submit",this.user);for(e1=e4=1;e4<=10;e1=++e4){e3=this.$modal_window.find("#new-team-shared-folder-email"+e1).val();if(e3){e7.emails.push(e3)}}e2=dP.getForRole(ci.active_user.role);if(!e2.verified_or_show()){a3.SharedFolderActivityLogger.log("web","team_shared_group_not_email_verified",this.user);return e2.send_email("share_folder",(function(e8){return function(){var e9;e9=new cK(e8.user,{element_id:"team-shared-folder-wizard-modal-page3",folder_name:e8.folder_name,invitees:e7,from_email_verification:true});e8.hide();return e9.show()}})(this))}else{a3.SharedFolderActivityLogger.log("web","team_shared_group_email_verified",this.user);e6=new cK(this.user,{element_id:"team-shared-folder-wizard-modal-page3",folder_name:this.folder_name,invitees:e7,from_email_verification:true});this.hide();return e6.show()}};e0.prototype.__fix_position=function(e2){var e1;e1=this.$modal_window.find(".db-modal");e1.css;return{margin:"0",position:"fixed"}};return e0})(aU);cK=B.TeamSharedFolderWizardModalPage3=(function(e0){cE(T,e0);function T(e1,e2){this.user=e1;this.options=e2;this.__fix_position=dg(this.__fix_position,this);T.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-wizard-page3 input[type=text]";this.base_title=el("Creating %(folder_name)s team and sending invites!").format({folder_name:this.options.folder_name})}T.prototype.on_show=function(){var e6,e4,e3,e2,e8,e7,e5,e1;a3.SharedFolderActivityLogger.log("web","team_shared_group_interstitial",this.user);this.$modal_window.find("#db-modal-close-x").click((function(e9){return function(fa){fa.preventDefault();return e9.on_close_button_click(fa)}})(this));e8="";e7=true;e4=false;e2="all";e5=false;e6=null;e1=(function(e9){return function(fc){var fa,fb;fa=JSON.parse(fc.responseText);ab.success(fa.success_msg);fb=new cI(e9.user,{element_id:"team-shared-folder-wizard-modal-page4",folder_name:e9.options.folder_name,invitees:e9.options.invitees,from_email_verification:true});e9.hide();return fb.show()}})(this);e3=(function(e9){return function(fa){return e9.hide()}})(this);return this.sharing_api.share_folder(e7,this.options.folder_name,this.options.invitees,e8,e4,e2,e5,e6,false,e1,e3)};T.prototype.on_confirm_button_click=function(e1){e1.preventDefault();return this.hide()};T.prototype.__fix_position=function(e2){var e1;e1=this.$modal_window.find(".db-modal");return e1.css({margin:"0",position:"fixed"})};return T})(aU);cI=B.TeamSharedFolderWizardModalPage4=(function(e0){cE(T,e0);function T(e1,e2){this.user=e1;this.options=e2;this.__fix_position=dg(this.__fix_position,this);T.__super__.constructor.apply(this,arguments);this.options.focus="#new-team-shared-folder-wizard-page4 input[type=text]";this.base_title=el("%(folder_name)s created and invites sent!").format({folder_name:this.options.folder_name})}T.prototype.before_show=function(){var e1;e1=this.$modal_window.find("#back_to_home");e1.attr("href","/home/"+this.options.folder_name);return this.format({"#figcaption_headline":this.base_title})};T.prototype.on_show=function(){return a3.SharedFolderActivityLogger.log("web","team_shared_group_final",this.user)};T.prototype.__fix_position=function(e2){var e1;e1=this.$modal_window.find(".db-modal");return e1.css({margin:"0",position:"fixed"})};return T})(aU);b4=B.ShareNewFolderWizardModal=(function(e0){cE(T,e0);function T(e1,e2){this.user=e1;this.options=e2;this.options.focus="#new-shared-folder-wizard input[type=text]";T.__super__.constructor.call(this,this.user,this.options);this.base_title=el("Create a new shared folder");this.personal_title=el("Create a shared folder in your personal Dropbox");this.work_title=el("Create a shared folder in your %(team_name)s Dropbox")}T.prototype.on_show=function(){var e2,e4,e1,e3;e3=this.$modal_window.find(".suggestion-input");for(e4=0,e1=e3.length;e4<e1;e4++){e2=e3[e4];cT.register($(e2))}this.$modal_window.find("#validate-folder-name").submit((function(e5){return function(e6){e6.preventDefault();return e5.on_confirm_button_click(e6)}})(this));if(this.options.error_msg){ab.error(this.options.error_msg)}return this.$modal_window.find("a.back").on("click",(function(e5){return function(e6){if(e5.options.back_fn){return e5.options.back_fn(e6,e5)}else{e6.preventDefault();e5.hide();return p.start_wizard_for_user(e5.user)}}})(this))};T.prototype.on_confirm_button_click=function(e4){var e3,e5,e2,e1;e4.preventDefault();e5=this.$modal_window.find("#new-shared-folder-name-input").val();e2={folder_name:e5};a3.SharedFolderActivityLogger.log("web","name_new_folder_modal_next_button",this.user,e2);bv(document).trigger("db:share_new_folder:next");e1=(function(e6){return function(){var e7;e7=new ce(e6.user,{folder_name:e5,element_id:"invite-to-new-sf-wizard-modal-"+e6.user.id});e6.hide();e7.new_folder=true;e7.show();return a3.SharedFolderActivityLogger.log("web","name_new_folder_modal_success",e6.user,e2)}})(this);e3=(function(e6){return function(e7){var e8;e8=b6.extract_errors(e7.responseText);a3.SharedFolderActivityLogger.log("web","name_new_folder_modal_fail",e6.user,e2);if(e8===false){}else{if(typeof e8==="string"){return ab.error(e8)}else{bv("#new-shared-folder-name-input .error-message").remove();return b6.fill_errors(bv("#validate-folder-name"),e8)}}}})(this);return this.sharing_api.validate_new_sf_path(e5,e1,e3)};return T})(aU);cX=B.ShareExistingFolderWizardModal=(function(e0){cE(T,e0);function T(e1,e2){this.user=e1;this.options=e2;this._hide=dg(this._hide,this);this.on_show=dg(this.on_show,this);T.__super__.constructor.call(this,this.user,this.options);this.base_title=el("Choose folder to share");this.personal_title=el("Choose a folder from your personal Dropbox");this.work_title=el("Choose a folder from your %(team_name)s Dropbox")}T.prototype.on_show=function(){this.treeview_id="copy-move-treeview";this.treeview_parent_id=bv("#"+this.treeview_id).parent().attr("id");bS.schedule_reset();bS.move(this.treeview_id,"share-existing-treeview",{onSuccess:((function(e1){return function(){var e2;bv(document).on("db:treeview_selected",function(e4,e3){return e1.folder_name=e3});e2=bv(".first-treeview-link");if(!dQ.ie){return e2.click()}}})(this)),user:this.user});return this.$modal_window.find("a.back").on("click",(function(e1){return function(e2){e2.preventDefault();e1.hide();return p.start_wizard_for_user(e1.user)}})(this))};T.prototype._hide=function(){bS.move(this.treeview_id,this.treeview_parent_id,{user:this.user});return T.__super__._hide.apply(this,arguments)};T.prototype.on_hide=function(){return bv(document).off("db:treeview_selected")};T.prototype.on_confirm_button_click=function(e4){var e3,e2,e1;e2={folder_name:this.folder_name};e4.preventDefault();if(this.folder_name&&this.$modal_window.find("#copy-move-treeview .highlight .s_web_folder_user").length){this.hide();a3.SharedFolderActivityLogger.log("web","choose_folder_modal_shared_next",this.user,e2);return p.show_shared_folder_options_modal(this.folder_name,this.user)}else{e1=(function(e5){return function(){var e6;e6=new ce(e5.user,{folder_name:e5.folder_name,element_id:"invite-to-new-sf-wizard-modal-"+e5.user.id});e5.hide();a3.SharedFolderActivityLogger.log("web","choose_folder_modal_not_shared_next",e5.user,e2);e6.new_folder=false;return e6.show()}})(this);e3=(function(e5){return function(e6){return eu.show_validation_error(e6,e5.$modal_window.find("#choose-existing-folder"))}})(this);return this.sharing_api.validate_existing_sf_path(this.folder_name,e1,e3)}};return T})(aU);aV=B.CreateOrShareNewFolderWizardModal=(function(e0){cE(T,e0);function T(e1,e2){this.user=e1;this.options=e2;this.on_confirm_button_click=dg(this.on_confirm_button_click,this);this._extract_invitees=dg(this._extract_invitees,this);this._toggle_send_button_state=dg(this._toggle_send_button_state,this);T.__super__.constructor.call(this,this.options);this.destination_dir=this.options.destination_dir;this.sharing_api=new be(this.user);this.state="Create"}T.prototype.on_show=function(){var e2,e3,e5,e4,e1;this.$send_button=this.$modal_window.find(".confirm-button");this.$cancel_button=this.$modal_window.find(".cancel-button");e5="create-and-share-new-folder-invite-wizard-"+this.user.id;this.file_name_input=this.$modal_window.find("#create-and-share-new-folder-name-input");this.file_name_input.focus();e3=e5+"-new-collab-input";this.collab_input=this.$modal_window.find("#"+e3);e2={tokens:[",",";"],include_fb:true,include_team:true,team_only:false,user_id:this.user.id,max_textbox_height:30};this.autocompleter=new Autocompleter.ContactsTokenizer(this.user,e3,e5+"-new-whobulk",e5+"-hidden-input",e2);if((e4=this.file_name_input)!=null){e4.keyup(this._toggle_send_button_state)}if((e1=this.collab_input)!=null){e1.keyup(this._toggle_send_button_state)}if(this.collab_input[0]){this.collab_input[0].on("token:remove",this._toggle_send_button_state);this.collab_input[0].on("token:add",this._toggle_send_button_state)}return this._toggle_send_button_state()};T.prototype._toggle_send_button_state=function(){var e3,e2,e1,e4;e1=((e4=this.autocompleter)!=null?e4.token_manager.tokens.length:void 0)===0;e1=e1&&this.collab_input.val()==="";e3=this.file_name_input.val();e2=e3==="";this.$send_button.prop("disabled",e2);if(e1){this.$send_button.text(el("Create folder"));return this.state="Create"}else{this.$send_button.text(el("Share folder"));return this.state="Share"}};T.prototype._extract_invitees=function(){var e5,e3,e4,e2,e8,e7,e1,e6;e4=this.$modal_window.find(".tokenized_autocompleter_container");e8={};e6=["emails","fb_ids","group_ids","new_style_group_ids"];for(e7=0,e1=e6.length;e7<e1;e7++){e3=e6[e7];e2=e4.find("input[name="+e3+"]");e8[e3]=(function(){var fb,fa,e9;e9=[];for(fb=0,fa=e2.length;fb<fa;fb++){e5=e2[fb];e9.push(bv(e5).val())}return e9})()}return e8};T.prototype.on_confirm_button_click=function(fc){var e3,e9,e6,fe,e7,fa,e4,e5,e1,e8,fb,fd,e2;fc.preventDefault();e1=this.file_name_input.val();fe=el("We can\u2019t create folder '%(folder_name)s'");fe=fe.format({folder_name:e1});e6=function(){return ab.error(fe)};if(this.state==="Create"){e2="/cmd/new"+dQ.urlquote(this.destination_dir);e8={to_path:e1};e8[Constants.UID_PARAM_NAME]=this.user.id;fd=function(){var ff;ff=el("Created new folder '%(folder_name)s'");ff=ff.format({folder_name:e1});return ab.success(ff)};new cs.WebRequest({url:e2,data:e8,success:fd,error:e6})}else{this.autocompleter.tokenize_emails_input(true);fa=this._extract_invitees();fd=function(){var ff;ff=el("Shared new folder '%(folder_name)s'");ff=ff.format({folder_name:e1});return ab.success(ff)};e5="";e9=false;e4="all";fb=false;e3=null;e7=this.destination_dir+"/"+e1;this.sharing_api.share_path(e7,fa,e5,e9,e4,fb,e3,false,fd,e6)}return this.hide()};return T})(dS);dK=B.CreateLinkOrInviteToFolderWizardModal=(function(e0){cE(T,e0);function T(e1,e2){this.user=e1;this.options=e2;T.__super__.constructor.call(this,this.options);this.sharing_api=new be(this.user)}T.prototype.before_show=function(){var e1;this.sharing_api.loading_elem=this.$modal_window;e1=el("Share '%(folder_name)s' with others");e1=e1.format({folder_name:bK.em_snippet(av.filename(this.options.path),16)});return this.format({".db-modal-title-text":e1})};T.prototype.on_show=function(){var e1,e3,e2;e1="edu_modal";e3=(e2=this.options.target_item)!=null?e2:null;a3.ShmodelUILogger.log("view",e1,e3);this.$modal_window.find(".option-to-share-folder").on("click",(function(e4){return function(e6){var e5;if(e4.options.existing_sf){a3.ShmodelUILogger.log("sf_options",e1,e3);e5=new c2(ci.active_user,e4.options.path)}else{a3.ShmodelUILogger.log("sf_invite",e1,e3);e5=new ce(e4.user,{folder_name:e4.options.path,element_id:"invite-to-new-sf-wizard-modal-"+e4.user.id})}e4.hide();return e5.show()}})(this));this.$modal_window.find(".option-to-share-link").on("click",(function(e4){return function(e5){a3.ShmodelUILogger.log("token_share",e1,e3);dh.shmodel(e4.options.path,"create_link_or_invite_to_folder_modal");return e4.hide()}})(this));return this.$modal_window.find(".learn-more").on("click",(function(e4){return function(e5){e5.preventDefault();a3.ShmodelUILogger.log("clicked_learn_more",e1,e3);return window.open("/help/274","_blank")}})(this))};return T})(dS);ce=B.InviteToNewSharedFolderWizardModal=(function(e0){cE(T,e0);function T(e1,e2){this.user=e1;this.options=e2;this.insert_folder_settings=dg(this.insert_folder_settings,this);this.share_folder=dg(this.share_folder,this);this.on_confirm_button_click=dg(this.on_confirm_button_click,this);this.show_settings_modal=dg(this.show_settings_modal,this);this.options.focus=".new-collab-input";T.__super__.constructor.call(this,this.options);this.sharing_api=new be(this.user);this.folder_name=this.options.folder_name;this.is_file=this.options.is_file;this.must_check_verified=(this.options.must_check_verified!=null)||false;this.progress_ever_blocked_by_verify=false}T.prototype.before_show=function(){var e1;this.sharing_api.loading_elem=this.$modal_window;e1=el("Share '%(folder_name)s' with others");e1=e1.format({folder_name:bK.em_snippet(av.filename(this.folder_name),16)});return this.format({".db-modal-title-text":e1})};T.prototype.on_show=function(){var e2,e3,e6,e5,e1,e4;e4=this.$modal_window.find(".suggestion-input");for(e5=0,e1=e4.length;e5<e1;e5++){e3=e4[e5];cT.register($(e3))}e2=this.$modal_window.find(".invite-more-form");if(!this.invite_form_controller){e6="invite-wizard-"+this.user.id;this.invite_form_controller=new c1(this.user,e2,[],[],[],e6);if(this.invite_form_controller.team_only){this.insert_folder_settings("team")}}else{this.invite_form_controller.listen()}this.$modal_window.find(".new-collab-input").focus();this.$modal_window.find(".change-new-folder-settings").on("click",(function(e7){return function(e8){e8.preventDefault();return e7.show_settings_modal()}})(this));this.log_extras={path:this.folder_name};a3.SharedFolderActivityLogger.log("web","share_folder_modal_displayed",this.user,this.log_extras);if(this.is_file){return a3.SharedFolderActivityLogger.log("web","single_file_unshared_invite_modal_displayed",this.user,this.log_extras)}};T.prototype.show_settings_modal=function(){var e2,e1;e1=el("'%(folder_name)s' settings");e1=e1.format({folder_name:bK.em_snippet(av.filename(this.folder_name),13)});e2={folder_name:this.folder_name};if(this.audience_restriction){e2.audience=this.audience_restriction}if(this.inviter_restriction){e2.inviter=this.inviter_restriction}if(this.shared_link_policy_restriction){e2.shared_link_policy=this.shared_link_policy_restriction}e2[Constants.UID_PARAM_NAME]=this.user.id;if(this.is_file){e2.is_file=this.is_file}dM.register(cp.SAVED_PERMISSIONS,(function(e3){return function(e5,e4){e3.insert_folder_settings(e4.audience,e4.inviter,e4.shared_link_policy);return e3.invite_form_controller.reset_options()}})(this));return dM.push(new cr({element_id:"folder-permissions-modal",title:e1,endpoint_url:"/share_ajax/default_folder_settings",parameters:e2}))};T.prototype.on_confirm_button_click=function(e4){var e3,e2,e6,e1,e5;e4.preventDefault();this.invite_form_controller.tokenize();e6=this.invite_form_controller.extract_invitees();e5=this.invite_form_controller.get_custom_message();e3=this.invite_form_controller.get_access_type();e1=this.$modal_window.find("input#allow_other_members_to_share");if(e1.length>0){this.inviter_restriction=e1.is(":checked")?"all":"me"}if(this.is_file){e2=new eE(this.user,{element_id:"confirm-share-new-file-wizard-modal",invitees:e6,msg:e5,access_type:e3,audience_restriction:this.audience_restriction,inviter_restriction:this.inviter_restriction,shared_link_policy_restriction:this.shared_link_policy_restriction,file_path:this.folder_name});this.hide();e2.show();return a3.SharedFolderActivityLogger.log("web","single_file_unshared_invite_modal_continued",this.user,this.log_extras)}else{return this.share_folder(e6,e5,e3,true,false)}};T.prototype.share_folder=function(e6,e3,e1,e7,e5,e2){var fb,e4,e8,fa,e9;if(e7==null){e7=true}if(e5==null){e5=false}if(e2==null){e2=false}e4=(function(fc){return function(fd){return eu.show_validation_error(fd,fc.$modal_window.find(".tokenized_autocompleter_container"))}})(this);fa=(function(fc){return function(ff){var fe,fd;fd=JSON.parse(ff.responseText);ab.success(fd.success_msg);if(fc.progress_ever_blocked_by_verify){a3.SharedFolderActivityLogger.log("web","email_verify_sharing_modal_share_succeess",fc.user,e8)}document.fire(aC.SF_NEW,{sf_info:bP.decode_sort_key(fd.sf_info)});if(e7){fc.hide()}if(e2){fe=new c2(fc.user,av.normalize(fc.folder_name));return fe.show()}}})(this);if(this.must_check_verified&&!this.user.is_email_verified){this.progress_ever_blocked_by_verify=true;a3.SharedFolderActivityLogger.log("web","email_verify_sharing_modal_blocked_on_verify",this.user,e8);this.$modal_window.find(".confirm-button").prop("disabled",true);e9=el("Verification email sent to %(email)s").format({email:this.user.email});fb=dP.get_for_user(this.user);fb.send_email("share_folder",function(){return ab.success(e9)});bv("#resend-email-verification-link").click(function(){return fb.send_email("share_folder",function(){return ab.success(e9)})});this.$modal_window.find(".email-verify-message").show();return fb.ensure_polling((function(fc){return function(){a3.SharedFolderActivityLogger.log("web","email_verify_sharing_modal_unblocked",fc.user,e8);ab.success(el("Email verified. Try sharing your folder again."));fc.$modal_window.find(".confirm-button").prop("disabled",false);return fc.$modal_window.find(".email-verify-message").hide()}})(this))}else{this.sharing_api.share_folder(this.new_folder,this.folder_name,e6,e3,this.audience_restriction,this.inviter_restriction,this.shared_link_policy_restriction,e1,e5,fa,e4);e8={path:this.folder_name,access_type:e1};a3.SharedFolderActivityLogger.log("web","invite_modal_share_folder_button",this.user,e8);return bv(document).trigger("db:invite_to_new_folder:share")}};T.prototype.insert_folder_settings=function(e2,e1,e4){var e3;this.audience_restriction=e2;this.inviter_restriction=e1;this.shared_link_policy_restriction=e4;e3=this.$modal_window.find(".invite-more-form, .external-invite-message,.folder-settings");if(this.audience_restriction==="team"){this.invite_form_controller.set_team_only(true);return e3.addClass("team-only")}else{this.invite_form_controller.set_team_only(false);return e3.removeClass("team-only")}};return T})(dS);eE=B.ConfirmShareNewFileWizardModal=(function(T){cE(e0,T);function e0(e1,e2){this.user=e1;this.options=e2;e0.__super__.constructor.call(this,this.options);this.file_path=this.options.file_path;this.file_name=av.filename(this.file_path);this.folder_name=av.filename_without_extension(this.file_name);this.folder_path=av.parent_dir(this.file_path)+"/"+this.folder_name;this.invitees=this.options.invitees;this.msg=this.options.msg;this.audience_restriction=this.options.audience_restriction;this.inviter_restriction=this.options.inviter_restriction;this.shared_link_policy_restriction=this.options.shared_link_policy_restriction;this.access_type=this.options.access_type;this.sharing_api=new be(this.user);this.log_extras={path:this.file_path}}e0.prototype.before_show=function(){this.format({".confirm-share-file-invitees":this.format_invitees(),".confirm-share-file-name":this.file_name,".confirm-share-folder-name":this.folder_name});return a3.SharedFolderActivityLogger.log("web","single_file_unshared_info_modal_displayed",this.user,this.log_extras)};e0.prototype.on_confirm_button_click=function(e3){var e2,e1;e2=(function(e4){return function(e7){var e5,e6,e8;a3.SharedFolderActivityLogger.log("web","single_file_unshared_sharing_failed",e4.user,e4.log_extras);e8=b6.extract_errors(e7.responseText);if(e8===false){return}else{if(typeof e8==="string"){ab.error(e8)}else{if(typeof e8==="object"){for(e6 in e8){e5=e8[e6];if("message_text" in e5){ab.error(e5.message_text);break}}}}}return e4.hide()}})(this);e1=(function(e4){return function(){var e5;a3.SharedFolderActivityLogger.log("web","single_file_unshared_sharing_succeeded",e4.user,e4.log_extras);e5=el("%(folder_name)s was shared successfully.").format({folder_name:e4.folder_name});ab.success(e5);return e4.hide()}})(this);this.sharing_api.share_file(this.folder_path,this.file_path,this.invitees,this.msg,this.audience_restriction,this.inviter_restriction,this.shared_link_policy_restriction,this.access_type,e1,e2);return a3.SharedFolderActivityLogger.log("web","single_file_unshared_info_modal_confirmed",this.user,this.log_extras)};e0.prototype.format_invitees=function(){var e6,e5,e3,e2,e1,e4;if(!this.invitees){return el("others")}e6=this.invitees.emails[0];e5=this.invitees.fb_ids[0];e3=this.invitees.group_ids[0];e2=this.invitees.new_style_group_ids[0];if(!e6.length){return el("others")}e1=e6[0];e4=e6.length+e5.length+e3.length+e2.length;if(e4>1){e1=e1+el(" and others")}return e1};return e0})(dS);dR=B.ConfirmShareExistingFileWizardModal=(function(e0){cE(T,e0);function T(e1,e2){this.user=e1;this.options=e2;T.__super__.constructor.call(this,this.options);this.folder_name=this.options.folder_name;this.folder_path=this.options.folder_path;this.log_extras={path:this.folder_name}}T.prototype.before_show=function(){this.format({".confirm-share-existing-folder-name":this.folder_name});return a3.SharedFolderActivityLogger.log("web","single_file_shared_info_modal_displayed",this.user,this.log_extras)};T.prototype.on_confirm_button_click=function(e2){var e1;a3.SharedFolderActivityLogger.log("web","single_file_shared_info_modal_confirmed",this.user,this.log_extras);e1=new c2(this.user,this.folder_path);this.hide();return e1.show()};return T})(dS);cp=B.NewSharedFolderPermissionsContent=(function(){T.SAVED_PERMISSIONS="new_sf_permissions:saved";function T(e0){this.$form=e0;this._submit=dg(this._submit,this);this._listen()}T.prototype._listen=function(){this.$form.find(".confirm-button").click(this._submit);return this.$form.find(".cancel-button").click(this._cancel)};T.prototype._cancel=function(){return dM.pop()};T.prototype._submit=function(e3){var e1,e2,e0;e3.preventDefault();e1=this.$form.find("input[name=audience]:checked").val();e2=this.$form.find("input[name=inviter]:checked").val();e0=this.$form.find("input[name=shared_link_policy]:checked").val();dM.trigger(T.SAVED_PERMISSIONS,{audience:e1,inviter:e2,shared_link_policy:e0});return dM.pop()};return T})();var dh;dh=B.SharingShmodel=(function(){function T(){}T.shmodel=function(e1,e0){return new c3(ci.active_user.id,e1,e0).show()};return T})();var bP;bP=INLINE_JS.Sharing=B.Sharing={init:function(e6,e0,e5,e2,e4,e3,e1,T){this.is_merged=e5;this.simple_sharing_enabled=T;if(!e0){this._decode_sort_keys(e6)}this._state={sf_info:e6,cmp:{"#sf-current":this._modified_cmp,"#sf-past":this._modified_cmp},is_ascending:{"#sf-current":false,"#sf-past":false},inbox_counts:{},sf_loading:e0,delay_reload_folder:false,pending_new_folders:[]};if(e5){this.role_picker=bv("#role-selector").controller();this.role_picker.on_state_change=this._render.bind(this);bF.set_during_login_callback((function(e7){return function(e9,e8){dq.set_not_logged_in_role_and_email(null,null);return e7._reload_folder_info(function(){return e8()},function(fa){e8(el("Error displaying shared folders"));return window.location.reload()})}})(this))}dq.set_is_merged(e5);dq.set_not_logged_in_role_and_email(e2,e4);dq.set_team_name(e3);dq.set_show_inbox(e1);this._listen();this._tmpl=eV.tmpl("sf_list_item_tmpl");if(!e0){this._render()}else{this._display_spinner();cs.WebRequest({url:"/share_ajax/list_folders",dataType:"json",success:(function(e7){return function(e8){return e7._load_and_render_sf_list(e8)}})(this),error:(function(e7){return function(e8){return e7._sf_list_error()}})(this)})}this.refresh_inbox_counts(true);return this._display_view()},_load_and_render_sf_list:function(T){this._decode_sort_keys(T);this._state.sf_info=T;this._state.sf_loading=false;this._hide_spinner();if(this._state.pending_new_folders.length>0){this._state.sf_info.current.push.apply(this._state.sf_info.current,this._state.pending_new_folders);this._state.pending_new_folders=[]}this._render();if(this._state.delay_reload_folder){this._state.delay_reload_folder=false;return this._reload_folder_info()}},_sf_list_error:function(){this._hide_spinner();return ab.error(el("We weren\u2019t able to load the list of shared folders. Please refresh the page to try again."))},is_share_page:function(){return this._state!=null},_decode_sort_keys:function(T){return[T.current,T.past].each((function(e0){return function(e1){return e1.each(function(e2){return e0.decode_sort_key(e2)})}})(this))},decode_sort_key:function(T){cz((T.encoded_sort_key!=null)&&(T.sort_key==null),"expected encoded sort keys on each elm");T.sort_key=dQ.decode_sort_key(T.encoded_sort_key);delete T.encoded_sort_key;return T},reload_folder_info_if_two_account:function(){if(this._showing_two_accounts()){return this._reload_folder_info()}},_reload_folder_info:function(e1,T){var e0;if(!this.is_share_page()){return}e0=(function(e2){return function(e3){var e4;e4=JSON.parse(e3.responseText);e2._decode_sort_keys(e4);e2._state.sf_info=e4;e2._render();return typeof e1==="function"?e1():void 0}})(this);if(this._state.sf_loading){return this._state.delay_reload_folder=true}else{return new cg().get_folder_info(e0,T)}},refresh_inbox_counts:function(T){return new cg().get_inbox_counts((function(e0){return function(e1){return e0._update_inbox_counts(e1,T)}})(this))},_update_inbox_counts:function(e0,e3){var e6,e1,T,e5,e4,e2;e2=0;for(e5 in e0){e6=e0[e5];e2+=e6}bv("#inbox-count").text(e2);bv("#inbox-count").toggleClass("show",e2>0);if(!this.is_share_page()){return}e1=function(e8,e7){var e9;for(e5 in e8){e9=e8[e5];if(e7[e5]!==e8[e5]){return false}}return true};if((!e3)&&this._state&&e1(this._state.inbox_counts,e0)){return}this._state.inbox_counts=e0;if(e2){T=new Element("a",{id:"new-invites-link",href:"#"});T.__sert(cm.make("web","email_32",{"class":"link-img"}));e4=a4("%(total_count)d new shared folder invitation","%(total_count)d new shared folder invitations",e2);e4+=" \n";e4=e4.format({total_count:e2});T.__sert(e4);T.observe("click",(function(e7){return function(e8){Event.stop(e8);return e7.show_invites()}})(this));$("invites-box").show();$("invites-box").__date(T)}else{$("invites-box").hide()}if(e2>0&&dq.show_inbox){dq.set_show_inbox(false);return this.show_invites()}},register_accept:function(T){bv(T).closest(".sf-invite-action").addClass("loading");new bp(bv(T),T.action,{data:bJ.collect_form_vars(T),complete:(function(e0){return function(e2,e1){bv(T).closest(".sf-invite-action").removeClass("loading");e0.refresh_inbox_counts();return e0._reload_folder_info()}})(this),success:(function(e0){return function(e5,e1,e7){var e2,e4,e6,e3;e5=(e3=JSON.parse(e7.responseText))!=null?e3.data:void 0;e2=bv(T).closest(".sf-invite-action");e2.addClass("sf-accepted");if(e5!=null?e5.redirect:void 0){if(e0._state&&e0._state.current_total_count>1){e4=e2.find(".view-folder-button");return e4.click(function(){return window.location.href=e5!=null?e5.redirect:void 0})}else{return window.location.href=e5!=null?e5.redirect:void 0}}else{e6=bv(T).closest(".invitation-row").attr("data-invite-id");return e0._remove_invite_row(e6)}}})(this)});return false},register_decline:function(e0,e2,e3){var T,e1;T=bv(e0).closest("form");if((e1=T.closest(".sf-invite-action"))!=null){e1.addClass("loading")}if(T.length){new bp(T,T[0].action,{data:bJ.collect_form_vars(T[0]),complete:(function(e4){return function(e7,e6){var e5;if((e5=T.closest(".sf-invite-action"))!=null){e5.removeClass("loading")}e4._remove_invite_row(e2);e4.refresh_inbox_counts();e4._reload_folder_info();if(e3){return e3()}}})(this)})}return false},_remove_invite_row:function(e3){var T,e2,e1,e0;T=bv("#invites-container");e2=T.find('[data-invite-id="'+e3+'"]');if(e2){e0=e2.parent("tbody");e2.remove();if(e0.children().length===0){T.find(".invitation-table-container").hide();T.find(".message-bottom").removeClass("message-bottom");T.find(".message-top").removeClass("message-top");if(T.find(".invites-message").length===0){e1=dS.get_containing_modal(T);return e1!=null?e1.hide():void 0}}}},_listen:function(){var e1,e0,T;this.listen_modals();e1=(function(e2){return function(e4,fc,e7){var e8,e3,fb,fa,e9,fe,e5,fd,e6;e6=e2._get_current_sf_list_info(e7),fa=e6[0],fb=e6[1];cz(fc,"SF _transfer w/o target_ns_id");for(e8=e5=0,fd=fa.length;e5<fd;e8=++e5){e3=fa[e8];if(e3.target_ns_id===fc&&e3.user_id===e4){e9=e3;fe=e8;break}}cz(fe!=null,"SF _transfer w/o js obj");return[e9,fe]}})(this);T=(function(e2){return function(e8,fd,fa){var fb,e9,fe,fc,e7,e4,e6,e5,e3;e6=e2._get_current_sf_list_info(fd),fb=e6[0],e4=e6[1];e5=e2._get_current_sf_list_info(fa),fc=e5[0],e7=e5[1];e3=e1(e8.memo.user_id,e8.memo.target_ns_id,fd),e9=e3[0],fe=e3[1];fb.splice(fe,1);e2._empty_check(fd);if(e8.memo.filename!=null){e9.filename=e8.memo.filename}if(e8.memo.mount_point!=null){e9.mount_point=e8.memo.mount_point}fc.push(e9);return e2._render()}})(this);e0=(function(e2){return function(e8,e5){var fa,e7,e9,e4,e6,e3;e6=e2._get_current_sf_list_info(e5),fa=e6[0],e4=e6[1];e3=e1(e8.memo.user_id,e8.memo.target_ns_id,e5),e7=e3[0],e9=e3[1];fa.splice(e9,1);return e2._render()}})(this);document.observe(aC.SF_UNSHARE,(function(e2){return function(e3){return e0(e3,"#sf-current")}})(this));document.observe(aC.SF_LEAVE,(function(e2){return function(e3){return T(e3,"#sf-current","#sf-past")}})(this));document.observe(aC.SF_REJOIN,(function(e2){return function(e3){return T(e3,"#sf-past","#sf-current")}})(this));document.observe(aC.SF_IGNORE,(function(e2){return function(e3){return e0(e3,"#sf-past")}})(this));document.observe(aC.SF_NEW,(function(e2){return function(e4){var e3;e3=e4.memo.sf_info;cz(e3,"SF_NEW without info");if(e2._state.sf_loading){return e2._state.pending_new_folders.push(e3)}else{e2._state.sf_info.current.push(e3);return e2._render()}}})(this));$("create-share").observe("click",(function(e2){return function(e3){a3.SharedFolderActivityLogger.log("web","sharing_view_share_new",null,{},true);if(!$("create-share").hasClassName("disabled")){Event.stop(e3);return p.start_wizard_without_user()}}})(this));bv("#learn-more-link").click((function(e2){return function(e3){return a3.SharedFolderActivityLogger.log("web","sharing_view_learn_more",null,{},true)}})(this));if($("new-invites-link")){$("new-invites-link").observe("click",(function(e2){return function(e3){Event.stop(e3);return e2.show_invites()}})(this))}bv("#sf-current, #sf-past").each((function(e2){return function(e3,e4){var e5;e5=["#sf-current","#sf-past"][e3];bv(".sf-list",e4).on("click","a.options-link",function(e7){var fb,e9,fd,e8,fe,fc,fa,e6;e7.preventDefault();fb=bv(e7.target).closest("a.options-link");e8=fb.attr("data-type");fd=fb.attr("data-mount");fa=parseInt(fb.attr("data-nsid"),10);e6=cB.get_viewer().get_user_by_id(fb.attr("data-user_id"));fc=bv(e7.target).closest("li.sf-folder").data("role");fe=fb.attr("data-sf-perm-role");if(fc!=null){dq.set_role(fc)}if(e8==="normal"){if(e2.simple_sharing_enabled){if(dP.get_for_user(e6).verified_or_show()){eq.createAndShowInbandModal(e6,fd,true,fa,true,false,fe)}}else{p.show_shared_folder_options_modal(fd,e6)}}else{if(e8==="remove"){p.show_ignore_modal(e6,fd,fa)}else{if(e8==="rejoin"){p.show_rejoin_modal(e6,fd,fa)}}}e9={option_type:e8};if(fa){e9.ns_id=fa}if(fd){e9.path=fd}return a3.SharedFolderActivityLogger.log("web","sharing_view_share_existing",e6.id,e9,true)});bv(".sf-sort",e4).on("click","a.sort-option",function(e8){var e7,e6,e9;e8.preventDefault();e7=bv(e8.target).closest("a.sort-option");e9={SF_BY_NAME:e2._name_cmp,SF_BY_MODIFIED:e2._modified_cmp};e6=e9[e7.attr("data-sort")];if(e2._state.cmp[e5]===e6){e2._state.is_ascending[e5]=!e2._state.is_ascending[e5]}else{e2._state.cmp[e5]=e6;e2._state.is_ascending[e5]=true}dQ.add_sort_arrow_mouseover_j(e7,e2._state.is_ascending[e5],e5+" .sf-sort a.sort-option",true);return e2._render_list_id(e5)});return dQ.add_sort_arrow_mouseover_j(bv(".modified-sorter",e4),e2._state.is_ascending[e5],e5+" .sf-sort a.sort-option",false)}})(this));return bv(".empty-share-button").click((function(e2){return function(e3){e3.preventDefault();a3.SharedFolderActivityLogger.log("web","sharing_view_share_new",null,{},true);return p.start_wizard_without_user()}})(this))},listen_modals:function(){return bv("#new-or-existing-sf li").click((function(T){return function(e1){var e0;bv("#new-or-existing-sf li").removeClass("active");e0=bv(e1.target).closest("li");e0.find("input").prop("checked",true);return e0.addClass("active")}})(this))},_showing_two_accounts:function(){var T;return this.is_merged&&((T=this.role_picker)!=null?T.get_state():void 0)===dN.ALL},_render:function(){cz(!this._state.sf_loading);this._render_list_id("#sf-current");this._render_list_id("#sf-past");if(bv("#sf-current").hasClass("empty-list")&&bv("#sf-past").hasClass("empty-list")){bv("#page-content").addClass("no-shares");return bv("#empty-content").show()}else{bv("#page-content").removeClass("no-shares");return bv("#empty-content").hide()}},_render_list_id:function(e1){var e8,e5,e6,e3,e4,e2,e7,T,e9,e0;e0=this._get_current_sf_list_info(e1),e3=e0[0],e6=e0[1];e7=this._showing_two_accounts();e8=(function(fa){return function(fb,fd){var fc;fc=fa._state.is_ascending[e1]?1:-1;return fc*fa._state.cmp[e1](fb,fd,e7)}})(this);e3.sort(e8);e4=bv(".sf-list",e1);e4.empty();for(T=0,e9=e3.length;T<e9;T++){e2=e3[T];if(this._should_render(e2)){e5=this._tmpl({options_str:el("Options"),remove_str:el("Remove"),rejoin_str:el("Rejoin"),is_past:e6,sf:e2,Sprite:cm,Emstring:bK,Util:dQ,_:el});e4.append(e5.toHTML())}}return this._empty_check(e1)},_should_render:function(T){if(this.role_picker!=null){return this.role_picker.is_role_visible(T.role)}else{return true}},_empty_check:function(e2){var e1,T,e0;e0=this._get_current_sf_list_info(e2),e1=e0[0],T=e0[1];if(bv(".sf-list",e2).children().length){return bv(e2).removeClass("empty-list")}else{return bv(e2).addClass("empty-list")}},_get_current_sf_list_info:function(T){switch(T){case"#sf-current":return[this._state.sf_info.current,false];case"#sf-past":return[this._state.sf_info.past,true];default:return cz(false,"invalid sf list id")}},_name_cmp:function(e0,e1,T){if(T){return dQ.sort_by_key(e0,e1)}else{return dQ.sort_by_rank_or_key(e0,e1)}},_modified_cmp:function(e0,e1,T){return e0.modified_ts-e1.modified_ts},include_fb:false,use_fb_profile_pics:true,show_invites:function(){var e1,T,e0;this._state.current_total_count=0;e0=this._state.inbox_counts;for(T in e0){e1=e0[T];this._state.current_total_count+=e1}if(this._state.current_total_count>0){return p.show_invites()}},_display_view:(function(T){return function(){return bv("#sf-view").show()}})(this),_hide_view:(function(T){return function(){return bv("#sf-view").hide()}})(this),_display_spinner:function(){this._hide_view();return bv(".sf-spinner").show()},_hide_spinner:function(){return bv(".sf-spinner").hide()}};var bk;Autocompleter.Contacts=Class.create(Autocompleter.Base,{initialize:function(e3,e4,e2,e9){var e8,e1,e6,e7,T,e0,e5;this.user=e3;this.baseInitialize(e4,e2,e9);this.options.array=false;this.options.larray=false;this.options.frequency=0.1;this._num_contacts_shown=0;this._num_query_results=0;e1=this.options.include_fb===true;if(this.options.include_team==null){this.options.include_team=true}e5=this.options.include_team===true;e6=this.options.include_groups===true;T=this.options.include_new_style_groups===true;e7=this.options.include_me===true;e0=this.options.include_rooms===true;this.profile_services=bc.get_linked_profile_services_for_user(this.user.id,this.update_import_contacts_link);this.link_handler=new dV();this._autocompleter_profile_services_item_tmpl=eV.tmpl("autocompleter_item_tmpl");this.listen();this.possible_email_pattern=/[.@_-]/;e8=(function(fa){return function(fb){if(fa.options.include_from_linked_accounts&&fa.options.viewer){fb=fb.includeForViewer(fa.options.viewer)}else{fb=fb.includeForUser(fa.user.id)}if(fa.options.contact_filter){fb=fa.options.contact_filter(fb)}else{if(!e1){fb=fb.excludeFacebook()}if(!e6){fb=fb.excludeGroups()}if(!T){fb=fb.excludeNewStyleGroups()}if(!e5){fb=fb.excludeTeamMembers()}if(!e7){fb=fb.excludeMe()}if(!e0){fb=fb.excludeRooms()}}return fa.setContacts(fb)}})(this);(function(){var fa;return bQ.load_contacts(fa=false,e0=e0,(function(fb){e8(fb);return bQ.register_for_updates("autocompleter_contacts",e8)}))}).defer();return this.options.onShow=function(fa,fb){if(!fb.style.position||fb.style.position==="absolute"){fb.style.position="absolute";bv(fb).clonePosition(bv(fa),{setHeight:false,setTop:false,setLeft:false})}return bv(fb).fadeTo(150,1)}},link_callback:function(T){return dV.show_import_notifications(T)},getToken:function(){var T;T=this.getTokenBounds();return this.element.value.substring(T[0],T[1])},listen:function(){var T;this.install_profile_services_link_listener();T=(function(e0){return function(e1){if(e0.profile_services.has_connected_services()){return}if(bv(e0.element).val()){return}e0.activate();setTimeout(function(){var e2;return(e2=e0.get_entry_container())!=null?e2.show():void 0},300);return true}})(this);return bv(this.element).click(T)},install_profile_services_link_listener:function(){var T;Event.stopObserving(this.element,"blur");T=(function(e0){return function(e1){var e2;if(!bv(e1.target).closest("li").hasClass("profile-services-link-handler")){return(e2=e0.get_entry_container())!=null?e2.hide():void 0}}})(this);bv(this.element).closest(".db-modal-box").click(T);return bv(this.element).closest("#modal-box").click(T)},get_entry_container:function(){var T;return(T=this.element.up(".tokenized_autocompleter_container"))!=null?T.down(".autocomplete"):void 0},profile_services_show:function(){var e1,e0,T,e2;e1=this.get_entry_container();if(((e0=e1.firstChild)!=null?(T=e0.firstChild)!=null?T.value:void 0:void 0)>0){this.old_display=e1.style.display}else{this.old_contents="<ul></ul>";this.old_display="none"}this.profile_services_render_buttons();if((e2=$("flash_copy_container"))!=null){e2.hide()}return this.element.focus()},profile_services_render_buttons:function(){var T;T=this.get_profile_services_button_list();this.hasFocus=true;return this.updateChoices("<ul>"+(T.join(""))+"</ul>")},get_profile_services_button_list:function(){var e0,e4,e1,e3,T,e2;e1=[];e2=cQ.contact_services();for(e3=0,T=e2.length;e3<T;e3++){e4=e2[e3];cz(this.profile_services.is_updated,"profile_services has not been updated");e0="";if(this.profile_services.service_is_connected(e4)){e0=el("Connected")}else{if(this.profile_services.service_was_connected(e4)){e0=el("Reconnect")}}e1.push(this._autocompleter_profile_services_item_tmpl({email_provider_num:e4,email_provider_img:cQ.to_img(e4),email_provider_name:cQ.to_name(e4),bottom_text:e0}).toHTML())}return e1},update_import_contacts_link:(function(T){return function(e0){T.profile_services=e0;if(T.profile_services.has_unconnected_services(true)){return bv(T.element).closest("form").find(".import-contacts-link").show()}else{return bv(T.element).closest("form").find(".import-contacts-link").hide()}}})(this),hide_containing_modal:function(){this.$hidden_modals=bv(".db-modal-wrapper:visible").first();if(this.$hidden_modals.length){return this.$hidden_modals.css("display","none")}else{this.$hidden_modals=bv("#modal:visible, #modal-overlay:visible");return this.$hidden_modals.hide()}},show_containing_modal:function(){this.$hidden_modals.show();return this.$hidden_modals=null},setContacts:function(T){this.options.array=T.contacts;this.options.larray=T.lcontacts;if(this.active||this.getToken()){return this.getUpdatedChoices()}},getUpdatedChoices:function(){return this.updateChoices(this.options.selector())},selectEntry:function(){var e1,e0,T;e0=this.getCurrentEntry();e1=this.options.array[e0.value];if(e1.type===S.FB||e1.type===S.NEW_STYLE_GROUP){e0.innerHTML=e1.name}else{e0.innerHTML=e1.email}if(this.options.tokens.length>1){T=this.options.tokens[0]+" "}else{T=""}e0.innerHTML+=T;this.active=false;this.updateElement(e0);return bv(this.element).trigger("db:autocompleted")}},bk=function(T,e0){var e1;e1=bv("<div>");e1.addClass(T);if(typeof e0==="string"||e0 instanceof String){e1.text(e0)}else{e1.append(e0)}return e1},{getNumContactsShown:function(){return this._num_contacts_shown},getNumQueryResults:function(){return this._num_query_results},setOptions:function(e0){var T;if(e0==null){e0={}}T={choices:5,selector:(function(e1){return function(){var e5,fm,fl,fe,fg,fy,e7,fP,fQ,fa,fw,fL,fq,fi,ff,fx,fv,fd,fH,e6,fu,fO,fr,fA,fs,fz,fF,e2,fE,fM,fc,fj,ft,e3,fC,fn,fp,fD,e4,fk,fN,fo,fK,fJ,fI,fG,fh,fb,e9,e8,fB;fn=[];fw=e1.getToken().toLowerCase();fH=e1.options.array.length;fg=e1.options.array;fA=e1.options.larray;fC=[];if(fw.indexOf(" ")===-1){fC.push("\\s+")}if(fw.indexOf("+")===-1){fC.push("\\+")}if(fw.indexOf("@")===-1){fC.push("@")}if(fw.indexOf(".")===-1){fC.push("\\.")}if(fw.indexOf("&lt;")===-1){fC.push("&lt;")}e3=RegExp("("+fC.join("|")+")");fx=0;while(fw.length>0&&fx<fH){fe=fg[fx];fr=fA[fx];fL=-1;fa=[];fz=[];ff="";switch(fe.type){case S.EMAIL:fa.push(fe.name,fe.email_snippet);fz.push(fr.name,fr.email);ff="/static/images/icons/mail28-vflHfHPJ0.png";break;case S.FB:fa.push(fe.name);fz.push(fr.name);if(bP.use_fb_profile_pics){ff="https://graph.facebook.com/"+fr.fb_id+"/picture"}else{ff="/static/images/icons/fb24-vflGnjfAv.png"}break;case S.USER_GROUP:fa.push(fe.name,fe.members);fz.push(fr.name,"");ff="";fq=fe.group_avatar;break;case S.NEW_STYLE_GROUP:fa.push(fe.name,fe.members);fz.push(fr.name,"");ff="";if(__CIRCULAR_DEPENDENCY__.GroupsListController!=null){fm=__CIRCULAR_DEPENDENCY__.GroupsListController.string_to_hsl(fe.name);fl=__CIRCULAR_DEPENDENCY__.GroupsListController.get_initials(fe.name);fq=bv("<span class='group-icon'>").css("border-color",fm).css("color",fm).text(fl)}break;case S.CAROUSEL_ROOM:fa.push("",fe.name);fk=fr.name;fB=fe.members;for(fK=0,fh=fB.length;fK<fh;fK++){fF=fB[fK];fk+="."+fF.contact_vector_data.toLowerCase();fk+="."+fF.display_name.toLowerCase()}fz.push("",fk);ff=fe.avatar_url||"/static/images/carousel/icon-57px-vfluuaZ5j.png";break;default:cz(false,"should never get here due to type: "+(""+fe.type+", "+fe.name+", "+fe.email+", "+fe))}for(fd=fJ=0,fb=fz.length;fJ<fb;fd=++fJ){fs=fz[fd];fM=fC.length?fs.split(e3):[fs];e7=0;for(fI=0,e9=fM.length;fI<e9;fI++){fE=fM[fI];if(!fE){continue}if(fE.indexOf(fw)===0){fL=e7;break}e7+=fE.length}if(fL!==-1){ft=((fw.length/fE.length)*9.4).toFixed(0);if(fe.sort_key!=null){ft+=fe.sort_key}e6=document.createTextNode(fa[fd].substr(0,fL));e2=bv("<strong>").text(fa[fd].substr(fL,fw.length));fD=document.createTextNode(fa[fd].substr(fL+fw.length));fa[fd]=[e6,e2,fD];break}}if(fe.type===S.FB){fa.push(el("Facebook message"))}if(fL!==-1){if(ff){fi=bv('<img width="28px" height="28px">').attr("src",ff)}else{if(fq){fi=fq}}fc=bk("autocomplete-line",fa[0]);fo=bk("autocomplete-line autocomplete-secondary",fa[1]);fu=bk("autocomplete-left",fi);e4=bk(null,[fc,fo]);fO=bv("<li>").attr("value",fx).append(fu,e4);fn.push([ft,fO])}fx++}fn.sort(function(fS,fR){if(fS[0]<fR[0]){return 1}else{if(fS[0]>fR[0]){return -1}else{return 0}}});e1._num_query_results=fn.length;fn=fn.slice(0,e1.options.choices);fp=bv("<ul>");for(fG=0,e8=fn.length;fG<e8;fG++){fN=fn[fG];fp.append(fN[1])}e1._num_contacts_shown=fn.length;if(!bv(e1.element).hasClass("no-profile-services-link-handler")){if(e1.profile_services.has_unconnected_services(true)){fy=bv(e1.element).closest(".tokenized_autocompleter_container");fj=fy.attr("data-provider");fv=fj===cQ.GOOGLE?el("Select from your Gmail contacts"):fj===cQ.YAHOO?el("Select from your Yahoo contacts"):el("Select from your contacts");fP=false;if((fj===cQ.GOOGLE||fj===cQ.YAHOO)&&!e1.profile_services.service_is_connected(fj)){fP=true}else{if(e1.profile_services.has_connected_services()){fP=false;fv=el("Import Contacts")}}if(fP){fQ=e1._autocompleter_profile_services_item_tmpl({email_provider_num:fj,email_provider_img:cQ.to_img(fj),email_provider_name:fv,bottom_text:""}).toHTML();fp.append(fQ)}else{fi=cm.make("web","user_add");fc=bk("autocomplete-line autocomplete-line-center",fv);fu=bk("autocomplete-left",fi);e4=bk(null,[fc]);fO=bv("<li>").addClass("profile-services-link-handler").append(fu,e4);fp.append(fO)}}}e5=fp.wrap("<span>").parent().html();e1.old_contents=e5;return e5}})(this)};return this.options=Object.extend(T,e0)}});var cD;cD=B.Token=Class.create({initialize:function(e0,T,e1,e2){this.element=$(e0);this.token_manager=e1;this.hidden_input=T;this.element.token=this;this.selected=false;this.info=e2;return bv(this.element).closest(".tokenized_autocompleter_container").click(this.onclick.bindAsEventListener(this))},select:function(){var T;this.token_manager.token=this;if((T=this.hidden_input)!=null){T.element.activate()}this.selected=true;return this.element.addClassName("token_selected")},deselect:function(){if(this.token_manager.token===this){this.token_manager.token=null}this.selected=false;return this.element.removeClassName("token_selected")},onclick:function(T){if(T&&T.preventDefault){T.preventDefault()}if(this.detect(T)&&!this.selected){return this.select()}else{return this.deselect()}},remove:function(T){return this.token_manager.remove(this)},detect:function(e2){var e0,e1,T;e1=e2.target?e2.target:e2.srcElement;T=e1.token;e0=e1;while((T==null)&&e0.parentNode){e0=e0.parentNode;T=e0.token}return(T!=null)&&T.element===this.element}});var M;M=B.TokenManager=Class.create({initialize:function(e1,e2,e0,T){this.contact_search_logger=T;this.shift_boundary_right_func=e2;this.shift_boundary_left_func=e0;this.element=e1;this.tokens=[];return this.token=null},add:function(T){this.tokens.push(T);return this.element.fire("token:add",T.info)},populate:function(){var e5,e1,e3,e2,e4,e0,T;e2=this.element.select(".token");T=[];for(e4=0,e0=e2.length;e4<e0;e4++){e3=e2[e4];e5=e3.hasClassName("token-warn");e1=new cD(e3,null,this,{external:e5});T.push(this.add(e1))}return T},remove:function(e0){var T;if(e0==null){e0=this.token}if(e0!=null){this.contact_search_logger.flag_record_as_removed(e0.info.value);T=this.tokens.indexOf(e0);this.tokens.splice(T,1);e0.element.remove();if(this.token===e0&&T<this.tokens.length){this.tokens[T].select()}else{this.token=null;if(this.shift_boundary_right_func!=null){this.shift_boundary_right_func()}}return this.element.fire("token:remove",e0.info)}},removeAll:function(){var e0,e2,T,e1;e1=this.tokens;for(e2=0,T=e1.length;e2<T;e2++){e0=e1[e2];e0.element.remove();this.element.fire("token:remove",e0.info)}return this.tokens.clear()},shift_left:function(){var T;T=this.token?this.tokens.indexOf(this.token):this.tokens.length;if(T>0){if(this.token){this.token.deselect()}return this.tokens[T-1].select()}else{if(this.shift_boundary_left_func!=null){return this.shift_boundary_left_func()}}},shift_right:function(){var T;T=this.tokens.indexOf(this.token);if(this.token){this.token.deselect()}if(T+1<this.tokens.length){return this.tokens[T+1].select()}else{if(this.shift_boundary_right_func!=null){return this.shift_boundary_right_func()}}}});var dU;dU=B.HiddenInput=Class.create({initialize:function(T,e1,e0){this.element=$(T);this.auto_complete_element=e1;this.token_manager=e0;return Event.observe(this.element,"keydown",this.onKeyPress.bindAsEventListener(this))},onKeyPress:function(T){switch(T.keyCode){case Event.KEY_LEFT:T.preventDefault();this.token_manager.shift_left();break;case Event.KEY_TAB:T.preventDefault();this.token_manager.shift_right();break;case Event.KEY_RIGHT:T.preventDefault();this.token_manager.shift_right();break;case Event.KEY_BACKSPACE:case Event.KEY_DELETE:this.token_manager.remove()}return false}});var bB=[].indexOf||function(e1){for(var e0=0,T=this.length;e0<T;e0++){if(e0 in this&&this[e0]===e1){return e0}}return -1};Autocompleter.ContactsTokenizer=Class.create(Autocompleter.Contacts,{initialize:function($super,T,e2,e4,e1,e0){var e3;this.user=T;$super(T,e2,e4,e0);this.contact_search_logger=new a3.ContactSearchLogger;this.token_manager=new M(this.element,this.generate_shift_boundary_right_func(),null,this.contact_search_logger);this.hidden_input=new dU(e1,this.element,this.token_manager);this.textbox_height=0;if(!this.element.hacks){this.element.should_use_borderless_hack=Prototype.Browser.WebKit;this.element.should_use_shadow_hack=Prototype.Browser.IE||Prototype.Browser.Opera;this.element.hacks=true}if(this.element.should_use_borderless_hack||this.element.should_use_shadow_hack){bv(this.element).parent().addClass("tokenizer_input_borderless")}this.options.onShow=function(e5,e6){bv(e6).clonePosition(bv(e5.parentNode.parentNode),{setHeight:false,setTop:false,setLeft:false});return e6.show()};this.options.onHide=function(e5,e6){return e6.hide()};this.max_textbox_height=270;if(e0.max_textbox_height!=null){this.max_textbox_height=e0.max_textbox_height}this.members=[];if(e0.members!=null){this.members=e0.members}this.invitees=[];if(e0.invitees!=null){this.invitees=e0.invitees}this.new_style_groups=[];if(e0.new_style_groups!=null){this.new_style_groups=e0.new_style_groups}this.contacts_only=false;if(e0.contacts_only!=null){this.contacts_only=e0.contacts_only}if(eo.get_url().indexOf("/referrals")!==-1){e3=bv("#retrieve-contacts-button")}else{e3=bv(this.element).closest("form").find(".tokenizer-submit-button")[0]}bv(e3).on("mousedown",this.beforeSubmit.bindAsEventListener(this));bv(this.element).on("focus",this.onFocus.bindAsEventListener(this));this.import_links=[];if(!e0.hide_import_contacts){this.import_links=bv(".import-contacts-link")}this.calculate_input_size();this.dynamically_resize_input();this.check_populated();return setInterval(this.check_populated.bind(this),100)},onClick:function(e0){var T,e1;T=e0.findElement("li");this.index=T.autocompleteIndex;e1=this.selectEntry();if(!e1){return this.hide()}},onBlur:function($super,T){$(this.element.parentNode).removeClassName("focused");this.element.up(".tokenizer").removeClassName("focused");return $super(T)},onFocus:function(T){$(this.element.parentNode).addClassName("focused");return this.element.up(".tokenizer").addClassName("focused")},beforeSubmit:function(T){return this.tokenize_emails_input(true)},clearTokens:function(T){this.token_manager.removeAll();this.calculate_input_size();return this.dynamically_resize_input()},getTokenCount:function(){return this.token_manager.tokens.length},getEmails:function(){var e0,T;e0=bv(this.element).closest(".tokenized_autocompleter_container").find(".token-valid").find('[name="emails"]');return((function(){var e3,e2,e1;e1=[];for(e3=0,e2=e0.length;e3<e2;e3++){T=e0[e3];e1.push(bv(T).val())}return e1})()).join(", ")},check_populated:function(){var e0,T;e0=$(this.element.parentNode);T=(this.element.value==="")&&(this.token_manager.tokens.length===0);if(e0.hasClassName("populated")&&T){return e0.removeClassName("populated")}else{if(!e0.hasClassName("populated")&&!T){return e0.addClassName("populated")}}},clean_email_addr:function(e3,e1){var e0,e2,T;for(e2=0,T=e3.length;e2<T;e2++){e0=e3[e2];e1=e1.sub(e0,"")}return e1.strip()},get_regexp_from_delimiters:function(e3){var e0,e2,e1,T;e2="";for(e1=0,T=e3.length;e1<T;e1++){e0=e3[e1];e2+=e0+"|"}return new RegExp("["+e2+"\\r\\n|\\r|\\n|\\t]+")},createTokenInfo:function(e2,e1,T){var e3,e0;e0=true;e3=e1;if(T===S.FB){e3=e2}if(T===S.EMAIL&&!dQ.validate_email(e1)){e0=false}else{if(bB.call(this.members,e1)>=0){e0=false;e3=el("Already member")}else{if(bB.call(this.invitees,e1)>=0){e0=false;e3=el("Already invited")}else{if(T===S.NEW_STYLE_GROUP){if(bB.call(this.new_style_groups,e1)>=0){e0=false;e3=el("Already member group")}else{e0=true;e3=el("Group")}}}}}if(e1===this.user.email||e1===this.user.id){e3=el("You");e0=!this.contacts_only}if(!e2&&e1){e2=e1.toString()}return{display:e2,value:e1,type:T,valid:e0,bubble_title:e3}},COMPOUND_EMAIL_REGEX:/([^<>]+)<([^@>]+@[^@>]+)>/,parse_compound_email:function(e0){var T,e1;T=e0.match(this.COMPOUND_EMAIL_REGEX);if(T){e1=this.createTokenInfo(T[0],T[2],S.EMAIL);return e1}return null},tokenize_emails_input:function(e8,e3){var fd,e7,e4,fc,e1,fh,fe,fb,fa,e5,fj,e6,e2,e0,T,ff,fi,fg,e9;e7=this.options.tokens;fa=this.get_regexp_from_delimiters(e7);if(this.options.single_token){fc=[this.element.value]}else{fc=this.element.value.split(fa)}fj="";if(!e8){fj=fc[fc.length-1];fb=this.clean_email_addr(e7,fj);fc=fc.slice(0,fc.length-1);if((e9=fj[fj.length-1])===" "||e9===">"){if(fb.match(this.COMPOUND_EMAIL_REGEX)||dQ.validate_email(fb)){fc.push(fb);fj=""}}}fd=false;e6=[];if(fc.length>0){for(e2=0,ff=fc.length;e2<ff;e2++){e4=fc[e2];e5=this.parse_compound_email(e4);if(e5!=null?e5.valid:void 0){fd=true;this.set_input_size(1);if(this.addContact(e5)){fh={sort_variant:bQ.sort_variant,context:"legacy_tokenizer",contact_type:S.EMAIL,contact_id:e5.value,contact_name:e5.display,did_select_suggestion:false};this.contact_search_logger.add_record(fh)}}else{e6.push(e4)}}}fc=e6;if(!this.options.single_token){fe=[];for(e0=0,fi=fc.length;e0<fi;e0++){e4=fc[e0];fe.push.apply(fe,e4.split(" "))}fc=fe}if(fc.length>0){for(T=0,fg=fc.length;T<fg;T++){e4=fc[T];e4=this.clean_email_addr(e7,e4);if(e4){e5=this.createTokenInfo(e4,e4,S.EMAIL);if(e5.valid){fd=true}else{if(e3){continue}}this.set_input_size(1);if(this.addContact(e5)){fh={sort_variant:bQ.sort_variant,context:"legacy_tokenizer",contact_type:S.EMAIL,contact_id:e4,did_select_suggestion:false};this.contact_search_logger.add_record(fh)}}}}if(this.element.value!==fj){this.element.value=fj}e1=this.element.up("form");if(fd){bJ.clear_errors(e1)}return this.dynamically_resize_input()},generate_shift_boundary_right_func:function(){var e0,T;e0=this.element;T=function(){return e0.focus()};return T},set_input_size:function(T){if((T==null)||T<0){T=20}return this.element.setStyle({width:""+T+"px"})},calculate_input_size:function(){if(this.import_links.length){this.import_links_width=this.import_links.width();return this.import_links_visible=this.import_links.is(":visible")}},dynamically_resize_input:function(){var fb,ff,e5,e3,fi,e6,fc,fe,fa,e2,e8,e4,e9,fd,e1,T,fg,fh,e7,e0;fa=$(this.element.parentNode.parentNode);e8=parseInt(fa.getStyle("width"),10)-15;e2=parseInt(fa.getStyle("height"),10);if(e2!==this.textbox_height){this.textbox_height=e2;if(e2>=this.max_textbox_height){fa.setStyle({"overflow-y":"auto"})}else{fa.setStyle({"overflow-y":"hidden"})}}fi=e8;fb=bv(".tokenizer-link",fa.parentNode);if(fb.length>0){fi-=fb.width()}e9=this.token_manager.tokens;e6=false;fd=0;for(e1=0,fg=e9.length;e1<fg;e1++){e4=e9[e1];e3=e4.element;e5=parseInt(e3.getStyle("width"),10)+parseInt(e3.getStyle("margin-right"),10);fe=fd+e5;if(fe>e8){fd=e5;e6=true}else{if(e5>e8){fd=0;e6=true}else{fd=fe}}}fc=fi-fd;ff=this.element.value.length*7;if(ff>fc){fc=e8}this.set_input_size(fc);if(this.import_links.length&&this.import_links_visible){if(e6||e8-fd-ff<1.25*this.import_links_width){this.import_links_visible=false;e7=this.import_links;e0=[];for(T=0,fh=e7.length;T<fh;T++){e3=e7[T];e0.push(bv(e3).fadeOut(100))}return e0}}},onKeyPress:function(e0){var e1,T;this.dynamically_resize_input();if(this.active){switch(e0.keyCode){case 44:case 188:case 59:case 186:if(!e0.shiftKey){if(this.has_selected_contact_importer_entry()||this.has_selected_contact_importer()){this.tokenize_emails_input(true)}}this.reset_observer();return;case Event.KEY_TAB:case Event.KEY_RETURN:if(this.has_selected_profile_services_entry()||this.has_selected_profile_services()){this.tokenize_emails_input(true);this.hide();Event.stop(e0);return}this.selectEntry();this.hide();this.active=false;Event.stop(e0);return;case Event.KEY_ESC:this.hide();this.active=false;Event.stop(e0);return;case Event.KEY_LEFT:case Event.KEY_RIGHT:return;case Event.KEY_UP:this.markPrevious();this.render();Event.stop(e0);return;case Event.KEY_DOWN:this.markNext();this.render();Event.stop(e0);return}}else{this.tokenize_emails_input(false);if(e0.keyCode===Event.KEY_TAB||e0.keyCode===Event.KEY_RETURN){if(this.element.value&&e0.preventDefault){e0.preventDefault()}this.tokenize_emails_input(true);return}else{if(this.element.value===""){if((e1=e0.keyCode)===Event.KEY_LEFT||e1===Event.KEY_BACKSPACE){this.token_manager.shift_left()}}else{if((T=e0.keyCode)===Event.KEY_LEFT||T===Event.KEY_RIGHT||T===Event.KEY_UP||T===Event.KEY_DOWN){return}}}}this.update_typeahead();return this.reset_observer()},update_typeahead:function(){this.changed=true;return this.hasFocus=true},reset_observer:function(){if(this.observer){clearTimeout(this.observer)}return this.observer=setTimeout(this.onObserverEvent.bind(this),this.options.frequency*1000)},onObserverEvent:function($super){var e0,e1,e4,e3,T,e2;if(this.active){e4=this.element.value;e2=this.options.tokens;for(e3=0,T=e2.length;e3<T;e3++){e0=e2[e3];e1=e4.indexOf(e0);if(e1!==-1){if(this.has_selected_profile_services_entry()){this.tokenize_emails_input(true);this.hide();return}this.element.value=e4.substr(0,e1);this.selectEntry();this.hide();this.active=false;this.element.value=e4.substr(e1+1);break}}this.update_typeahead()}this.tokenize_emails_input(false);return $super()},has_selected_profile_services:function(T){if(T==null){T=this.getCurrentEntry()}return bv(T).hasClass("profile-services-link-handler")},has_selected_profile_services_entry:function(T){var e0;if(T==null){T=this.getCurrentEntry()}return T.value===0&&((e0=T.id)!=null?e0.length:void 0)!==0},selectEntry:function(){var e3,e2,e6,e0,e1,T,e4,e5;e2=this.getCurrentEntry();if(this.has_selected_profile_services(e2)){a3.SharedFolderActivityLogger.log("web","import_contacts_button_clicked",this.user);this.profile_services_show();return true}else{if(this.has_selected_profile_services_entry(e2)){e6=e2.id.split("_")[0];cz((bB.call(cQ.contact_services(),e6)>=0),"The 'id-value' of an autocompleter-entry is not a valid Third Party contact import service");e4=cQ.to_name(e6);if(this.profile_services.service_is_connected(e6)){ab.success(el("You're already connected to %(service_name)s").format({service_name:e4}));return}if(bB.call(cQ.contact_services(),e6)>=0){return this.link_handler.auth_service_with_user(e6,this.user.id,((function(e7){return function(e8){return e7.link_callback(e8)}})(this)),"suggestion")}else{return cz(false,"Should never get here. entry_value: "+e6)}}else{e3=this.options.array[e2.value];e0=e3.type===S.FB?e3.fb_id:e3.type===S.USER_GROUP?e3.group_id:e3.type===S.NEW_STYLE_GROUP?e3.group_id:e3.type===S.CAROUSEL_ROOM?e3.members:e3.email;this.set_input_size(1);T=this.element.value;e5=this.createTokenInfo(e3.name.strip(),e0,e3.type);if(this.addContact(e5)){e1={sort_variant:bQ.sort_variant,context:"legacy_tokenizer",search_expr:T,selected_pos:this.index,num_query_results:this.getNumQueryResults(),contact_type:e3.type,contact_id:e0,contact_name:e3.name.strip(),did_select_suggestion:true};this.contact_search_logger.add_record(e1)}bJ.clear_errors(this.element.up("form"));this.dynamically_resize_input();this.index=0;return this.element.focus()}}},addContact:function(e9){var fk,fj,fe,fl,fa,fn,e6,fh,e0,fb,ff,fm,fq,e1,e7,fd,fg,e8,fi,e3,e2,T,fo,fr,fp,fc,e5,e4;if(e9.type===S.CAROUSEL_ROOM&&!e9.processed){fk=false;fc=e9.value;for(e3=0,fo=fc.length;e3<fo;e3++){fj=fc[e3];e0=this.createTokenInfo(fl=fj.display_name,fi=JSON.stringify([fj.contact_vector_type,fj.contact_vector_data]),e8=S.CAROUSEL_ROOM);e0.processed=true;e0.bubble_title=fj.contact_vector_data;fk=fk||this.addContact(e0)}return fk}fg=this.token_manager.tokens;for(e2=0,fr=fg.length;e2<fr;e2++){fb=fg[e2];if(e9.value===fb.info.value){return false}}this.element.value="";switch(e9.type){case S.FB:fh="fb_ids";fn=new Element("img",{src:"/static/images/icons/fb_16-vflbiYTkC.png"});break;case S.EMAIL:fh="emails";fn=new Element("img",{src:"/static/images/icons/email_16-vflcFyDTl.png"});break;case S.USER_GROUP:fh="group_ids";fn=new Element("img",{src:"/static/images/icons/icon_spacer-vflN3BYt2.gif","class":"sprite sprite_groups s_groups_group"});break;case S.NEW_STYLE_GROUP:fh="new_style_group_ids";fn=new Element("img",{src:"/static/images/icons/icon_spacer-vflN3BYt2.gif","class":"sprite sprite_groups s_groups_group"});break;case S.CAROUSEL_ROOM:fh="carousel_rooms";fn=new Element("img",{src:"/static/images/carousel/icon-57px-vfluuaZ5j.png"});break;case S.INVALID:fh="invalids";fn=new Element("span",{"class":"hidden"});break;default:cz(false,"should never get here due to type: "+e9.type)}ff=this.getTokenClass(e9);fd=bv("<span class='x'>").addClass(ff);fd.on("click",function(fs){this.parentNode.parentNode.parentNode.parentNode.parentNode.token.remove(fs);return false});fq=new Element("input",{type:"hidden",name:fh,value:e9.value.toString()});fb=new Element("a",{"class":"title_bubble token "+ff,href:"#",tabindex:"-1",title:e9.bubble_title});e6=new Element("span");if(this.options.wrap_name){e1=new Element("div",{"class":"token-display-text"});e1.__sert(e9.display);fm=e1;fe=1}else{fm=e9.display;fe=0}e5=[fq,fn,fm];for(T=0,fp=e5.length;T<fp;T++){fa=e5[T];e6.__sert(fa)}bv(e6).append(fd);fb.__date(new Element("span").__date(new Element("span").__date(new Element("span").__date(e6))));if((e4=$(fb).down(5).next(fe))!=null){e4.innerHTML="&nbsp;"}e7=new cD(fb,this.hidden_input,this.token_manager,e9);this.token_manager.add(e7);this.element.up().__sert({before:fb});return true},getTokenClass:function(T){if(!T.valid){return"token-error"}return"token-valid"},isTeamOnly:function(){return false}});var bB=[].indexOf||function(e1){for(var e0=0,T=this.length;e0<T;e0++){if(e0 in this&&this[e0]===e1){return e0}}return -1};Autocompleter.TeamTokenizer=Class.create(Autocompleter.ContactsTokenizer,{initialize:function($super,T,e2,e3,e1,e0){$super(T,e2,e3,e1,e0);this.warn_only=!e0.team_only;this.element.observe("token:remove",this.notifyExternal.bind(this));this.element.observe("token:add",this.notifyExternal.bind(this));this.team_contacts={};return this.suspended_contacts={}},isTeamOnly:function(){return !this.warn_only},setTeamOnly:function(T){this.warn_only=!T;return this.reloadContacts()},reloadContacts:function(){var e0,T;return bQ.load_contacts(e0=false,T=false,(function(e1){return function(e2){return e1.setContacts(e2)}})(this))},setContacts:function($super,e3){var T,e2,e0,e1;this.team_contacts={};this.team_contacts[cB.get_viewer().work_email]=1;e3=e3.sortByTeamFirst();e1=e3.contacts;for(e2=0,e0=e1.length;e2<e0;e2++){T=e1[e2];if(T.team&&T.join_state==="active"){this.team_contacts[T.email]=1}if(T.team&&T.join_state==="suspended"){this.suspended_contacts[T.email]=1}}if(this.options.autocomplete_filter){return $super(this.options.autocomplete_filter(e3))}else{return $super(e3)}},createTokenInfo:function(e3,e1,T){var e5,e4,e2,e0;e0=true;e4=false;e5=e1;if(T===S.FB){e5=e3}if(T===S.EMAIL&&!dQ.validate_email(e1)){e0=false}else{if(bB.call(this.members,e1)>=0){e0=false;e5=el("Already member")}else{if(bB.call(this.invitees,e1)>=0){e0=false;e5=el("Already invited")}else{if(T===S.EMAIL&&!this.team_contacts[e1]){e0=this.warn_only;e4=true}else{if(T===S.FB){e0=this.warn_only;e4=true}else{if(T===S.NEW_STYLE_GROUP){if(bB.call(this.new_style_groups,e1)>=0){e0=false;e5=el("Already member group")}else{e0=true;e5=el("Group")}}}}}}}if(e1===this.user.email||e1===this.user.id){e5=el("You");e0=!this.contacts_only}if(!e3&&e1){e3=e1.toString()}return e2={display:e3,value:e1,type:T,valid:e0,external:e4,bubble_title:e5}},getTokenClass:function(T){if(!T.valid){return"token-error"}if(T.external){return"token-warn"}return"token-valid"},notifyExternal:function(e0){var T,e1,e2;e2=e0.memo;if(e2.external){e1=this.token_manager.tokens.filter(function(e3){return e3.info.external});T=e1?e1.length:0;return this.element.fire("sf:token:external",{count:T})}}});var i;i=B.TeamSharedFolderInviteController=(function(){function T(e0){var e1;this.element=$(e0[0]);e1=this.element.down(".new-collab-input");e1.observe("sf:token:external",this.handle_external.bind(this))}T.prototype.handle_external=function(e1){var e0,e2;e0=e1.memo.count;e2=this.element.down(".external-invite-message");if(e0>1){de.fillVal(e0,"external-invite-num");if(e2!=null){e2.removeClassName("single")}return e2!=null?e2.show():void 0}else{if(e0===1){if(e2!=null){e2.addClassName("single")}return e2!=null?e2.show():void 0}else{return e2!=null?e2.hide():void 0}}};return T})();var ag;ag=INLINE_JS.SharingModel=B.SharingModel={ALBUM_THUMB_SIZE:260,ALBUM_PADDING:40,THUMBS_BATCH_SIZE:12,filename:null,c2d_vars:{},is_folder:false,is_album:false,gallery_enabled:false,gallery_showing:false,send_link_autocompleter:null,team_only_shmodel:false,owner_name:null,init:function(e0,T,e1){this.filename=e0;this.c2d_vars=T;this.c2d_url=e1!=null?e1:"/sm/c2d";this.init_logger();bv(".nav-close").on("click",this.close_embedded_fileviewer.bind(this));return on_script_loaded((function(e2){return function(){var e7,e6,e5,e4,e3;e6=$("login-create-an-account");if(e6){e6.writeAttribute("href","/register?signup_tag=shmodel")}scrollTo(1,0);scrollTo(0,0);bv("#c2d-register-form").on("submit",e2.c2d_register.bind(e2));bv("#c2d-login-form").on("submit",e2.c2d_login.bind(e2));bv("#c2d-twofactor-login-form").on("submit",e2.c2d_twofactor_login.bind(e2));bv("#download_button_link[data-dl-link]").on("click",e2.download_zip);e2.set_viewport_size();e7=function(e9,e8){return e2.do_c2d(e8.id)};bv("#c2d-modal .login-form").on((e4=__CONDITIONAL_JS__.LoginForm)!=null?e4.LOGIN_SUCCESS:void 0,e7);bv("#c2d-modal .register-form").on((e3=__CIRCULAR_DEPENDENCY__.RegisterForm)!=null?e3.REGISTER_SUCCESS:void 0,e7);e5=D.parse(window.location.href);if(e5.getQuery()["force_dl"]){e5.updateQuery({force_dl:0,dl:1});return window.location=e5.toString()}}})(this))},init_folder:function(T,e1,e0){this.gallery_enabled=T;this.gallery_showing=e1;this.is_folder=true;this.init_lightbox(e0);return on_script_loaded((function(e2){return function(){return e2.load_thumbs()}})(this))},init_album:function(){this.is_album=true;this._resize_album_view();return Event.observe(window,"resize",this._resize_album_view.bind(this))},init_file:function(){this.is_folder=false;if(!this.c2d_vars.subpath&&(this.c2d_vars.item_id==null)&&!this.c2d_vars.is_package){return this.c2d_vars.subpath="/"+this.filename}},get_thumbnail_for_file:function(e0){var e1,T;T=e0.icon.split("_");T.pop();e1=T.join("_");return"/static/images/icons128/"+e1+".png"},init_logger:function(){on_script_loaded((function(T){return function(){var e0;e0=$("login-hover-link");if(e0){e0.observe("click",function(){return aI.log(aI.CLICK_SIGN_IN)});e0.observe("click",function(){return dw.log("click_sign_in")})}if($("download_button_link")){aI.attachLogListener(aI.CLICK_DOWNLOAD,$("download_button_link"))}e0=$("add_to_my_dropbox_link");if(e0){aI.attachLogListener(aI.CLICK_ADD_TO_MY_DROPBOX,e0);dw.attachLogListener("click_add_to_my_dropbox",e0)}if($$(".remove-link").length){aI.attachLogListener(aI.REMOVE_LINK,$$(".remove-link")[0])}if($$(".shmodel-filename").length){aI.attachLogListener(aI.CLICK_FILENAME,$$(".shmodel-filename")[0])}e0=$("default_content_download_button");if(e0){aI.attachLogListener(aI.CLICK_DOWNLOAD,e0)}e0=$("default_content_a2md");if(e0){aI.attachLogListener(aI.CLICK_ADD_TO_MY_DROPBOX,e0)}e0=bv("#login-create-an-account")[0];aI.attachLogListener(aI.CLICK_SIGNUP_THRU_DEFAULT_DROPDOWN,e0);e0=bv("#login-hover-cont .login-form")[0];aI.attachLogListener(aI.LOGIN_THRU_DEFAULT_DROPDOWN,e0);return bv("#share-button").click(function(e1){return aI.log(aI.CLICK_SHARE)})}})(this));return document.observe(aE.ACTIONS_ADDED,(function(T){return function(){var e3,e2,e0,e1;e1=$("view_original");if(e1){aI.attachLogListener("shmodel_lightbox_click_vieworiginal",e1)}e2=$("lightbox_share_link");if(e2){aI.attachLogListener("shmodel_lightbox_click_getlink",e2)}e0=bv("lightbox-share-link");if(e0[0]){aI.attachLogListener("shmodel_lightbox_click_getlink",e0[0])}e3=$("lightbox_download_link");if(e3){return aI.attachLogListener("shmodel_lightbox_click_download",e3)}}})(this))},set_team_only_shmodel:function(e0,T){this.team_only_shmodel=e0;return this.owner_name=T},_resize_album_view:function(){var T;T=Math.floor((z.viewport_dimensions().width-2*this.ALBUM_PADDING)/this.ALBUM_THUMB_SIZE)*this.ALBUM_THUMB_SIZE;return $("content-wrapper").setStyle({display:"block",width:""+T+"px"})},init_lightbox:function(T){return aE.init_from_preview_objs(T,"#gallery-view-media li")},load_thumbs:function(){var e0,T;T=this.gallery_showing?$$(".gallery-icon-view img"):$$(".browse-files .icon");e0=function(e1){if(!e1.src.endsWith(cm.SPACER)){return e1.addClassName("thumbnail")}};return bl.batch_load_thumbs(T,this.THUMBS_BATCH_SIZE,e0)},switch_mode:function(e5){var e1,e6,e4,T,e3,e0,e2;e2=$A(["gallery","list"]);for(e3=0,e0=e2.length;e3<e0;e3++){T=e2[e3];e6=$(T+"-view-container");e1=$(T+"-toggle");if(e5===T){e6.show();e1.addClassName("selected")}else{e6.hide();e1.removeClassName("selected")}}if(history.replaceState){e4=window.location.pathname;if(e5==="list"){e4+="?lst"}history.replaceState({},"",e4)}this.gallery_showing=!this.gallery_showing;return this.load_thumbs()},set_viewport_size:function(){var T;if($(document.body).hasClassName("mobile")){T=new Element("meta",{name:"viewport",content:"width = 480"});return document.head.appendChild(T)}},toggle_dropdown:function(e2,e3,e1){var T,e0;if(e2){Event.extend(e2).preventDefault()}if(!e3.visible()){if(this.is_album){return eD.show(e3,e1,null,true)}else{e0=$$(".nav-header").first().getHeight();T=$$(".nav-header .buttons").first().cumulativeOffset().top-4;if(T<0&&dQ.ie8){T=4}return eD.show(e3,e1,e0-T,true)}}},prepare_confirm_remove_modal:function(e0,e2,T,e4,e9,e5,e8,e6){var e1,e3,e7;if(T){e7=e4?el("Unshare?"):el("Unshare album?");e1=bv("#album-disable-token-modal")[0];de.fillVal(e0.escapeHTML(),"album_unshare_name")}else{if(e5){e7=el("Remove link created by %(name)s").format({name:e8});if(e2){e3=el('You are removing the link to "%(fname)s" created by <b>%(owner)s</b>.  Once the link is removed, no one else will be able to view this folder.<br/><br/>We\'ll notify <b>%(owner_email)s</b>.  Do you want to continue?')}else{e3=el('You are removing the link to "%(fname)s" created by <b>%(owner)s</b>.  Once the link is removed, no one else will be able to view this file.<br/><br/>We\'ll notify <b>%(owner_email)s</b>.  Do you want to continue?')}e3=e3.format({fname:bK.em_snippet(e0,17),owner:e8,owner_email:e6})}else{e7=el("Remove link to '%(name)s'").format({name:bK.em_snippet(e0,17)});if(e2){e3=el("Are you sure you want to remove this link? Once the link is removed, nobody else will be able to view this folder.")}else{e3=el("Are you sure you want to remove this link? Once the link is removed, nobody else will be able to view this file.")}}e1=bv("#disable-token-modal")[0];de.fillVal(e3,"disable-token-desc")}return{title:e7,contents:e1}},confirm_remove:function(e0,e4,e1,T,e2,e8,e5,e7,e6){var e3;if(e1==null){e1=false}if(T==null){T=false}if(e2==null){e2=false}if(e8==null){e8=null}if(e5==null){e5=false}if(e7==null){e7=null}if(e6==null){e6=null}cz(e4,"confirm_remove missing tkey");cz(e0,"confirm_remove missing name");cz(e8,"confirm_remove missing user_id");cz(!e5||!T,"admin removal of collections not supported");cz(!e5||e7,"missing link owner name for admin removal");cz(!e5||e6,"missing link owner email for admin removal");if(!cB.get_viewer().is_uid_signed_in(e8)){bF.show_modal({user_id:e8,on_success:(function(e9){return function(){return e9.confirm_remove(e0,e4,e1,T,e2,e8,e5,e7,e6)}})(this)});return}e3=ag.prepare_confirm_remove_modal(e0,e1,T,e2,e8,e5,e7,e6);return eS.show(e3.title,e3.contents,{token:e4,name:e0,is_album:T,user_id:e8})},confirm_remove_from_event_gid:function(T,e7,e1,e6,e3,e5,e4,e0){var e2;if(e3==null){e3=false}if(e5==null){e5=null}if(e4==null){e4=null}if(e0==null){e0=null}cz(e7,"confirm_remove missing event gid");cz(T,"confirm_remove missing name");cz(e6,"confirm_remove missing user_id");cz(cB.get_viewer().is_uid_signed_in(e6),"user not logged in");cz(!e3||e5,"missing link owner name for admin removal");cz(!e3||e4,"missing link owner email for admin removal");e2=ag.prepare_confirm_remove_modal(T,e1,false,false,e6,e3,e5,e4);return eS.show(e2.title,e2.contents,{name:T,user_id:e6,activity_log_event_gid_dbase64:e7,redirect_to_member_id:e0})},do_remove:function(e2){var T,e1,e0;cz(e2.token||e2.activity_log_event_gid_dbase64,"missing token or event gid_dbase64");T=bv("#modal-content input").first();T.attr("disabled",true);bv("#modal-content").addClass("ajax-loading");e0=window.location.pathname;if((e0==="/links"||e0==="/links/your_links"||e0==="/recents")||e0.match("^/home|^/work|^/personal")){return new Ajax.DBRequest("/sm/disable/"+e2.token,{subject_user:e2.user_id,onSuccess:(function(e3){return function(){var e4;eS.hide();if(e2.is_album){e4=el("Unshared '%(name)s'")}else{e4=el("Removed link for '%(name)s'")}e4=e4.format({name:e2.name});ab.success(e4);return document.fire(aC.LINKS_REMOVE,{token:e2.token})}})(this),onComplete:(function(e3){return function(){T.attr("disabled",false);return bv("#modal-content").removeClass("ajax-loading")}})(this)})}else{if(e2.token){e1=D({path:"/sm/disable/"+e2.token})}else{e1=D({path:"/sm/disable_by_event_gid/"+e2.activity_log_event_gid_dbase64});e1.updateQuery("redirect_to_member_id",e2.redirect_to_member_id).toString()}return bJ.postRequest(e1.updateQuery(Constants.UID_PARAM_NAME,e2.user_id).toString())}},show_shmodal_onload:function(e1,e2,e0,T){if(T==null){T=null}return bv((function(e3){return function(){eo.remove_query_param("m");if(!cB.get_viewer().is_uid_signed_in(T)){bF.show_modal({user_id:T,on_success:function(){return e3.show_shmodal_onload(e1,e2,e0,T)}});return}if((T!=null)&&dP.get_for_user(cB.get_viewer().get_user_by_id(T)).verified_or_show()){return e3.show_shmodal(e1,e2,e0,T)}else{if(T==null){cz(cB.get_viewer().is_paired,"Expected viewer to be paired.");return e3.show_share_shmodel_role_chooser(e1,e2,e0)}}}})(this))},show_shmodal:function(e0,e6,T,fc){var fb,e8,fa,e7,e4,e5,e2,e1,e9,e3;this.url=e0;this.short_url=e6;if(!cB.get_viewer().is_uid_signed_in(fc)){bF.show_modal({user_id:fc,on_success:(function(fd){return function(){return fd.show_shmodal(e0,e6,T,fc)}})(this)});return}e2=cB.get_viewer().get_user_by_id(fc);if(dP.get_for_user(e2).verified_or_show()){e5="shmodal-user-"+fc;eS.show(this._get_shmodal_title(e2.is_team),de.fromElm($(e5)));e4={};e4[Constants.UID_PARAM_NAME]=fc;bJ.add_vars("shmodal-send-form",e4);if(this._get_thumbnail_type()){e3=$$(".shmodal-image");for(e1=0,e9=e3.length;e1<e9;e1++){e7=e3[e1];e7.addClassName("thumbnail")}}if(T==="contacts"){fa=Autocompleter.ContactsTokenizer}else{fa=Autocompleter.TeamTokenizer}this.send_link_autocompleter=new fa(e2,e5+"-new-collab-input",e5+"-new-whobulk",e5+"-hidden-input",{tokens:[",",";"],include_fb:true,include_team:true,team_only:T==="team_only",user_id:fc});this.configure_dropdown();if(!this.disabled){if(FlashDetect.installed){fb=q.clipboard_overlay(e0,bv("#"+e5+"-copy-link"),ag.copied_to_clipboard);fb.css({position:"fixed",zIndex:1001});fb.children().height(fb.height());clearInterval(this.follow_freshbutton);e8=(function(fd){return function(){return fb.clonePosition(bv("#"+e5+"-copy-link"),{offsetHeight:6,offsetWidth:6})}})(this);this.follow_freshbutton=setInterval(e8,500)}else{$(e5+"-copy-link").hide()}}b8._create($("modal").down(".custom-message-container"));b8._create($("modal").down(".fb-post-sickinput"));b8._create($("modal").down(".twitter-post-sickinput"));this._populate_twitter_info(e6,fc);$(e5+"-new-collab-input").focus();return aI.log("shmodal_show")}},configure_dropdown:function(){var e3,e0,e2,T,e1;e1=$$(".dropdown-menu-container");for(e2=0,T=e1.length;e2<T;e2++){e3=e1[e2];e0=e3.down(".dropdown-menu-trigger");if(e0!=null){e0.observe("click",(function(e4){return function(e6){var e5;e5=e6.target.up(".dropdown-menu-container");return e5.toggleClassName("dropdown-shown")}})(this))}}return document.on("click",(function(e4){return function(fa){var e8,e9,e7,e5,e6;if(fa.target.hasClassName("dropdown-menu-trigger")||fa.target.up(".dropdown-menu-trigger")){return}e5=$$(".dropdown-shown");e6=[];for(e9=0,e7=e5.length;e9<e7;e9++){e8=e5[e9];e6.push(e8.removeClassName("dropdown-shown"))}return e6}})(this))},copied_to_clipboard:function(){ab.success(el("Link copied to clipboard"));eS.hide();aI.log("shmodal_copy_link");return a3.ViralLogger.log(cB.get_viewer().get_user_ids(),"shmodel","send",{src:"shmodel_copy_link",file_type:ag.is_album?"collection":ag.is_folder?"folder":ag.filename.indexOf(".")===-1?"file":cH.EXTENSION_TO_CATEGORY[av.file_extension(ag.filename).toLowerCase()]||"file"})},get_shmodel_send_recipients:function(e1){var e2,fa,e7,fb,fc,e5,e8,T,e4,e3,e9,e0,e6;cz(e1,"Must pass the shmodal send form into get_shmodel_send_recipients");e2=e1.select('input[name="emails"]');fa=e1.select('input[name="fb_ids"]');e7=e1.select('input[name="group_ids"]');e5=e1.select('input[name="new_style_group_ids"]');T=[];e6=[e2,fa,e7,e5];for(e4=0,e9=e6.length;e4<e9;e4++){fc=e6[e4];for(e3=0,e0=fc.length;e3<e0;e3++){fb=fc[e3];e8=fb.up().innerHTML.stripTags().escapeHTML();T.push(e8.substring(0,e8.indexOf("&")))}}return T},close_embedded_fileviewer:function(e0){var T;e0.preventDefault();T=new eg();T.configureParentMessaging(function(){},["parent-ready"]);T.startListening();return T.postMessageToParent("close-fileviewer")},send_shmodel_link:function(e2){var e1,e0,e3,T;e1=$("shmodal-send-form");cz(e1,"Couldn't find the shmodal send form.");T=this.get_shmodel_send_recipients(e1);e3=(function(e4){return function(e5){var e6;e6=aR.success_string_for_recipients(T);ab.success(e6);eS.hide();return aI.log("shmodal_send")}})(this);e0=(function(e4){return function(e5){return bJ.remove_loading()}})(this);return bJ.ajax_submit(e1,"/sm/share",e3,e0,e1.down(".tokenizer-submit-button"))},show_content:function(e0){var e3,e2,T,e1;$("shmodal-title-text").__date(da.to_title_str(e0));e1=da.list;for(e2=0,T=e1.length;e2<T;e2++){e3=e1[e2];if(e3!==e0){$(da.to_toggle_str(e3)).removeClassName("toggled");$(da.to_content_str(e3)).hide()}}$(da.to_content_str(e0)).show();$(da.to_toggle_str(e0)).addClassName("toggled");return bv("#modal .focusarea").focus()},show_send_content:function(){return this.show_content(da.SEND)},show_fb_content:function(){return this.show_content(da.FB)},show_twitter_content:function(){return this.show_content(da.TWITTER)},start_fb_post:function(e3,e0){var e4,e1,T,e2;e1=(function(e5){return function(){return ed.do_auth(e5.do_fb_post.curry(e3,e0),e0)}})(this);e4=bv("#modal:visible, #modal-overlay:visible");T=function(){return e4.show()};if(ed.authed_user_id===e0){return this.do_fb_post(e3,e0)}else{if(cB.get_viewer().is_uid_associated(ed.authed_user_id)){e4.hide();e2=new dY(cB.get_viewer().get_user_by_id(e0),T,e1.bind(this));return e2.show()}else{return e1()}}},start_twitter_post:function(T){if(ct.is_authed(T)){return this.do_twitter_post(T)}else{return ct.do_auth(this.do_twitter_post,T)}},do_fb_post:function(e0,T){ed.custom_show_posting=function(){return bJ.add_loading($("shmodal-fb-post-submit"))};ed.custom_show_complete=function(){eS.hide();ab.success(el("Successfully posted to Facebook"));aI.log("shmodal_fb_post");return a3.ViralLogger.log(cB.get_viewer().get_user_ids(),"shmodel","send",{src:"shmodel_fb_post",file_type:ag.is_album?"collection":ag.is_folder?"folder":ag.filename.indexOf(".")===-1?"file":cH.EXTENSION_TO_CATEGORY[av.file_extension(ag.filename).toLowerCase()]||"file"})};return ed.post($F("shmodal-fb-post-input"),e0,null,null,null,function(){return eS.hide()},T)},do_twitter_post:function(T){var e0;e0=$F("shmodal-twitter-post-input");if(!e0){ab.error(el("Please enter a Twitter post"));return}else{if(e0.length>140){ab.error(el("Your post must be 140 characters or less"));return}}ct.custom_show_posting=function(){$("twitter-chars").hide();return bJ.add_loading($("shmodal-twitter-post-submit"))};return ct.custom_post(e0,(function(e1){return function(){eS.hide();ab.success(el("Successfully posted to Twitter"));aI.log("shmodal_tweet");return a3.ViralLogger.log(cB.get_viewer().get_user_ids(),"shmodel","send",{src:"shmodel_twitter",file_type:ag.is_album?"collection":ag.is_folder?"folder":ag.filename.indexOf(".")===-1?"file":cH.EXTENSION_TO_CATEGORY[av.file_extension(ag.filename).toLowerCase()]||"file"})}})(this),T)},_get_shmodal_title:function(T){if(T==null){T=false}return this.generate_title_content(this._get_shmodal_title_text(),((function(e0){return function(){return e0.show_send_content()}})(this)),((function(e0){return function(){return e0.show_fb_content()}})(this)),((function(e0){return function(){return e0.show_twitter_content()}})(this)),T)},generate_title_content:function(e0,e7,e4,e9,e2){var e3,e5,T,e8,e1,e6;if(e2==null){e2=false}e8=bv("<div/>",{id:"shmodal-title"});e1=bv("<div/>",{id:"shmodal-title-text",text:e0});e8.append(e1);if(!e2){T=bv("<a/>",{id:"shmodal-send-toggle","class":"freshtoggle ft-left toggled"});T.html(cm.make("web","email_20"));T.on("click",e7);e5=bv("<a/>",{id:"shmodal-fb-toggle","class":"freshtoggle ft-middle"});e5.html(cm.make("web","fb_20"));e5.on("click",e4);e6=bv("<a/>",{id:"shmodal-twitter-toggle","class":"freshtoggle ft-right"});e6.html(cm.make("web","twitter_20"));e6.on("click",e9);e8.append([T,e5,e6])}e3=bv("<div/>",{"class":"clear"});e8.append(e3);return e8[0]},_get_shmodal_title_text:function(){var e0,T;if(this.is_folder){e0=el("Share link to \u2018%(folder_name)s\u2019");return e0=e0.format({folder_name:bK.em_snippet(this.filename,15)})}else{T=this._get_thumbnail_type();if(T===cH.CATEGORY_TO_TRANSLATION.IMAGE){return el("Share this image")}else{if(T===cH.CATEGORY_TO_TRANSLATION.VIDEO){return el("Share this video")}else{return el("Share '%(filename)s'").format({filename:bK.em_snippet(this.filename,18)})}}}},_get_thumbnail_type:function(){var e0,T;if(this.filename.indexOf(".")===-1){return false}T=av.file_extension(this.filename).toLowerCase();e0=cH.EXTENSION_TO_CATEGORY[T];if(e0&&(e0==="IMAGE"||e0==="VIDEO")){return cH.CATEGORY_TO_TRANSLATION[e0]}return false},_populate_twitter_info:function(e1,T){var e2,e0;e2=this.is_folder?el("Just shared some files using @Dropbox"):(e0=this._get_thumbnail_type(),e0&&e0===cH.CATEGORY_TO_TRANSLATION.IMAGE?el("Just shared an image using @Dropbox"):el("Just shared a file using @Dropbox"));$("shmodal-twitter-post-input").setValue(e2+" "+e1);dQ._track_twitter_chars_left("shmodal-twitter-post-input",140);if(ct.is_authed(T)){return ct.get_user_info(function(e3){$("shmodal-twitter-profile").down(".profile-pic").__date(new Element("img",{src:e3.profile_image_url_https}));$("shmodal-twitter-profile").down(".name").__date(e3.name);$("shmodal-twitter-profile").down(".username").__date("@"+e3.screen_name);$("modal").down(".twitter-post-sickinput").addClassName("shrank");return $("shmodal-twitter-profile").show()},T)}},download_zip:function(e2){var e0,e1,e3,T,e4;e0=bv("#download_button_link").attr("data-dl-link");e4=bv("#download_button_link").attr("data-test-link");T=bv("#download_button_link").attr("data-owner")==="true";e3=(function(e5){return function(e6){var e7;if(e6==="OK"){window.location=e0}else{if(e6.indexOf("err:")===0){if(T){e7=el("The zip file is too large.")}else{e7=el("The zip file is too large. Please add it to your Dropbox.")}ab.error(e7)}else{ab.error(el("Failed to download zip file."))}}return false}})(this);e1=(function(e5){return function(e6){ab.error(el("Failed to download zip file."));return false}})(this);if(e4&&bv.support.cors===true){bv.ajax({url:e4,type:"POST",success:e3,error:e1})}else{window.location=e0}return false},show_share_shmodel_role_chooser:function(e0,e1,T){if(this.shmodel_select_role_modal==null){this.shmodel_select_role_modal=new dj({element_id:"share-shmodel-select-role-modal",link_url:e0,short_url:e1,tokenizer_type:T})}return this.shmodel_select_role_modal.show().set_title(this._get_shmodal_title_text())},prompt_login_then_share:function(e0,e1,T,e3){var e2;e2=(function(e4){return function(){var e5;eS.hide();bv("#role-selector option").removeClass("disabled");e5=cB.get_viewer().get_uid_by_role(e3);cB.get_viewer().sign_in_user_by_id(e5);a3.ShmodelUILogger.log("via-shmodel-viewer");return ag.show_shmodal(e0,e1,T,e5)}})(this);if(!cB.get_viewer().is_role_signed_in(e3)){dq.not_logged_in_role=e3;return bF.show_modal({role:e3,on_success:e2})}else{return e2()}},show_c2d_modal:function(e5,e0){var e4,T,e3,e1,e2;if(e5==null){e5=""}if(e0==null){e0=false}if(e5){if(e5===Constants.ROLE_PERSONAL){cz(this.team_only_shmodel!=="forbid","Can't copy to personal Dropbox if restricted")}if(!cB.get_viewer().is_role_signed_in(e5)){bF.show_modal({role:e5,on_success:(function(e6){return function(){return e6.show_c2d_modal(e5)}})(this)});return}}else{if(cB.get_viewer().is_paired){new aL({element_id:"select-role-modal"}).show();return}}if(e5){e1="#c2d-modal-"+e5}else{e1="#c2d-modal"}e2=this._c2d_modal_msg(e5,cB.get_viewer().team_name);e4=this._c2d_modal_button_msg(e5,cB.get_viewer().team_name);T=this._c2d_modal_desc(e5,cB.get_viewer().team_name);if(e0){T=this._c2d_modal_team_only_desc(cB.get_viewer().team_name)+"<br/><br/>"+T}e3=this._c2d_modal_login_desc(e5,cB.get_viewer().team_name);de.fillVal(T,"c2d-desc");de.fillVal(e3,"c2d-login-desc");bv(".c2d-submit-button").val(e4);bv(".c2d-login-register-desc").hide();if(this.is_album){bv(".c2d-login-register-album-desc").show()}else{if(this.is_folder){bv(".c2d-login-register-folder-desc").show()}else{bv(".c2d-login-register-file-desc").show()}}return eS.show(e2,bv(e1)[0],false,false,false,false)},_c2d_modal_msg:function(e2,e0){var T,e1;if(e2==null){e2=""}if(e0==null){e0=""}if(this.c2d_vars.title){return e1=this.c2d_vars.title}else{if(e2===Constants.ROLE_PERSONAL){e1=el("Save '%(filename)s' to my personal Dropbox");return e1.format({filename:bK.em_snippet(this.filename,10)})}else{if(e2===Constants.ROLE_WORK){e1=el("Save '%(filename)s' to my %(team_name)s Dropbox");T=Math.max(10,15-new bK(e0).length);return e1.format({filename:bK.em_snippet(this.filename,T),team_name:e0})}else{e1=el("Save '%(filename)s' to my Dropbox");return e1.format({filename:bK.em_snippet(this.filename,15)})}}}},_c2d_modal_button_msg:function(e1,T){var e0;if(e1==null){e1=""}if(T==null){T=""}if(e1===Constants.ROLE_PERSONAL){return e0=el("Save to my personal Dropbox")}else{if(e1===Constants.ROLE_WORK){e0=el("Save to my %(team_name)s Dropbox");return e0.format({team_name:T})}else{return el("Save to my Dropbox")}}},_c2d_modal_team_only_desc:function(T){var e0;if(this.is_album){e0=el("You can only add this album to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the album to members of <b>%(team_name)s</b>.")}else{if(this.is_folder){e0=el("You can only add this folder to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the folder to members of <b>%(team_name)s</b>.")}else{e0=el("You can only add this file to your <b>%(team_name)s Dropbox</b> because <b>%(owner_name)s</b> has restricted the file to members of <b>%(team_name)s</b>.")}}return e0.format({owner_name:this.owner_name,team_name:T})},_c2d_modal_desc:function(e1,T){var e0;if(e1==null){e1=""}if(T==null){T=""}if(e1===Constants.ROLE_PERSONAL){if(this.is_album){if(this.team_only_shmodel==="warn"){e0=el("The photos and videos in this album were sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy them to your personal Dropbox?");return e0.format({owner_name:this.owner_name,team_name:T})}else{return e0=el("The photos and videos in this album will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}else{if(this.is_folder){if(this.team_only_shmodel==="warn"){e0=el("This folder was sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy it to your personal Dropbox?");return e0.format({owner_name:this.owner_name,team_name:T})}else{return e0=el("This folder will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}else{if(this.team_only_shmodel==="warn"){e0=el("This file was sent from <b>%(owner_name)s</b> on your <b>%(team_name)s</b> team.  Are you sure you want to copy it to your personal Dropbox?");return e0.format({owner_name:this.owner_name,team_name:T})}else{return e0=el("This file will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}}}else{if(e1===Constants.ROLE_WORK){if(this.is_album){e0=el("The photos and videos in this album will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{if(this.is_folder){e0=el("This folder will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{e0=el("This file will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}}return e0.format({team_name:T})}else{if(this.is_album){return el("The photos and videos in this album will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}else{if(this.is_folder){return el("This folder will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}else{return el("This file will be instantly saved to your Dropbox and downloaded to all the computers linked to your account.")}}}}},_c2d_modal_login_desc:function(e1,T){var e0;if(e1==null){e1=""}if(T==null){T=""}if(e1===Constants.ROLE_PERSONAL){if(this.is_album){return e0=el("Once you sign in to your personal Dropbox, the photos and videos in this album will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}else{if(this.is_folder){return e0=el("Once you sign in to your personal Dropbox, this folder will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}else{return e0=el("Once you sign in to your personal Dropbox, this file will be instantly saved to your personal Dropbox and downloaded to all the computers linked to your personal account.")}}}else{if(e1===Constants.ROLE_WORK){if(this.is_album){e0=el("Once you sign in to your %(team_name)s Dropbox, the photos and videos in this album will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{if(this.is_folder){e0=el("Once you sign in to your %(team_name)s Dropbox, this folder will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}else{e0=el("Once you sign in to your %(team_name)s Dropbox, this file will be instantly saved to your %(team_name)s Dropbox and downloaded to all the computers linked to your %(team_name)s account.")}}return e0.format({team_name:T})}}},c2d_register:function(e0){var T,e1;e0.preventDefault();T=$("c2d-register-form");e1=(function(e2){return function(e4){var e3;e3=JSON.parse(e4.responseText);return e2.do_c2d(e3.id)}})(this);return bJ.ajax_submit(T,"/ajax_register",e1,false,$(T).down("input[type=submit]"))},c2d_login:function(e2,T){var e1,e0,e3;if(T==null){T="c2d-login-form"}e2.preventDefault();e1=$(T);e3=(function(e4){return function(e6){var e5;e5=JSON.parse(e6.responseText);switch(e5.status){case"OK":return e4.do_c2d(e5.id);case"TWOFACTOR":return e4.show_c2d_twofactor(e5.last_four_digits);case"SSO":return window.location=e5.sso_url}}})(this);e0=this.c2d_show_twofactor_error500.bind(this);return bJ.ajax_submit(e1,"/ajax_login",e3,e0,$(e1).down("input[type=submit]"))},show_c2d_twofactor:function(T){$("c2d-login").hide();if(T){$("c2d-twofactor-login").addClassName("sms");de.fillVal(T,"last-four-digits")}else{$("c2d-twofactor-login").removeClassName("sms")}$("c2d-resend-link").observe("click",this.c2d_resend_phone_code.bind(this));return $("c2d-twofactor-login").show()},hide_c2d_twofactor:function(){$("c2d-twofactor-login").hide();return $("c2d-login").show()},c2d_resend_phone_code:function(){if(this.c2d_is_resending()){return}this.c2d_show_resending();return new Ajax.DBRequest("/twofactor_resend",{onSuccess:(function(T){return function(e0){switch(e0.responseText.strip()){case"OK":return ab.success(el("We sent you another code. It may take a few minutes to arrive."));case"UNREACHABLE":return T.c2d_show_twofactor_error_unreachable();case"BADCARRIER":return T.c2d_show_twofactor_error_bad_carrier();case"INVALIDNUMBER":return T.c2d_show_twofactor_error_invalid_number();case"NOTAMOBILE":return T.c2d_show_twofactor_error_not_a_mobile();case"EXPIRED":T.hide_c2d_twofactor();return ab.error(el("Sorry, your phone code has expired. Please log in again."))}}})(this),onFailure:this.c2d_show_twofactor_error500.bind(this),cleanUp:this.c2d_hide_resending_with_delay.bind(this)})},c2d_twofactor_login:function(e1){var e0,T,e2;e1.preventDefault();if(!$("c2d-twofactor-code").getValue()){this.c2d_show_twofactor_error_invalid();return}e0=$("c2d-twofactor-login-form");e2=(function(e3){return function(e5){var e4;e4=JSON.parse(e5.responseText);switch(e4.status){case"OK":return e3.do_c2d(e4.id);case"INVALID":return e3.c2d_show_twofactor_error_invalid();case"EXPIRED":e3.hide_c2d_twofactor();return ab.error(el("Sorry, your phone code has expired. Please log in again."))}}})(this);T=this.c2d_show_twofactor_error500.bind(this);return bJ.ajax_submit(e0,"/ajax_verify_code",e2,T)},do_c2d:function(T){var e0;cz(T,"Must specify a user_id for saving to Dropbox.");e0=el("Saving to your Dropbox...");if(cB.get_viewer().is_paired){if(cB.get_viewer().get_user_by_id(T).is_team){e0=el("Saving to your %(team_name)s Dropbox...");e0=e0.format({team_name:cB.get_viewer().team_name})}else{e0=el("Saving to your personal Dropbox...")}}ab.success(e0);eS.hide();return new Ajax.DBRequest(this.c2d_url,{parameters:this.c2d_vars,job:this.is_folder,progress_text:e0,subject_user:T,onSuccess:(function(e1){return function(e2){if(e2.responseText){return bR.redirect(e2.responseText)}}})(this)})},c2d_show_twofactor_error:function(e0){var T;T=$("c2d-twofactor-error");T.__date(e0);return T.show()},c2d_hide_twofactor_error:function(T){return $("c2d-twofactor-error").__date()},c2d_show_twofactor_error500:function(){return this.c2d_show_twofactor_error(el("Sorry, an error occured. Please try again later."))},c2d_show_twofactor_error_bad_carrier:function(){return this.c2d_show_twofactor_error(el("Unfortunately, your carrier is not supported at this time."))},c2d_show_twofactor_error_invalid_number:function(){return this.c2d_show_twofactor_error(el("That is not a valid phone number."))},c2d_show_twofactor_error_not_a_mobile:function(){return this.c2d_show_twofactor_error(el("That phone number does not appear to be a valid mobile number."))},c2d_show_twofactor_error_unreachable:function(){return this.c2d_show_twofactor_error(el("We couldn't reach your phone number. Are you sure it's correct?"))},c2d_show_twofactor_error_invalid:function(){return this.c2d_show_twofactor_error(el("Invalid code."))},c2d_is_resending:function(){return $("c2d-resend-link").hasClassName("resending")},c2d_show_resending:function(){return $("c2d-resend-link").addClassName("resending")},c2d_hide_resending:function(){return $("c2d-resend-link").removeClassName("resending")},c2d_hide_resending_with_delay:function(){return setTimeout(this.c2d_hide_resending.bind(this),3000)}};var da;da=B.ShmodalPanes={SEND:0,FB:1,TWITTER:2,list:[0,1,2],_content_str:["shmodal-send-content","shmodal-fb-content","shmodal-twitter-content"],_toggle_str:["shmodal-send-toggle","shmodal-fb-toggle","shmodal-twitter-toggle"],_title_str:["Share by Email",el("Share on Facebook"),el("Share on Twitter")],to_content_str:function(T){return this._content_str[T]},to_toggle_str:function(T){return this._toggle_str[T]},to_title_str:function(T){if(T===0){return ag._get_shmodal_title_text()}return this._title_str[T]},to_focus_str:function(T){return this._focus_str[T]}};var W,c3,bC,dg=function(T,e0){return function(){return T.apply(e0,arguments)}},ar={}.hasOwnProperty,cE=function(e2,e0){for(var T in e0){if(ar.call(e0,T)){e2[T]=e0[T]}}function e1(){this.constructor=e2}e1.prototype=e0.prototype;e2.prototype=new e1();e2.__super__=e0.prototype;return e2};c3=INLINE_JS.ShareLinkModal=B.ShareLinkModal=(function(T){cE(e0,T);function e0(e1,e4,e2,e6,e5){var e3,e7;this.user_id=e1;if(e6==null){e6=false}if(e5==null){e5=void 0}this.before_show=dg(this.before_show,this);this.show=dg(this.show,this);this.prompt_login_then_show=dg(this.prompt_login_then_show,this);e7={origin:e2};e7[Constants.UID_PARAM_NAME]=this.user_id;if(e5){e3=D({path:"/sm/get_link_modal_content/"+e5}).toString()}else{e3=D({path:"/sm/share_link"+e4}).toString()}e0.__super__.constructor.call(this,{element_id:"share-link-modal",endpoint_url:e3,parameters:e7})}e0.prototype.prompt_login_then_show=function(){var e1;e1=(function(e2){return function(){eS.hide();bv("#role-selector option").removeClass("disabled");cB.get_viewer().sign_in_user_by_id(e2.user_id);a3.ShmodelUILogger.log("via-shmodel-viewer");return e2.show()}})(this);if(!cB.get_viewer().is_uid_signed_in(this.user_id)){return bF.show_modal({user_id:this.user_id,on_success:e1})}else{return e1()}};e0.prototype.show=function(){var e1;e1=cB.get_viewer().get_user_by_id(this.user_id);if(dP.get_for_user(e1).verified_or_show(ee.SHMODAL)){return e0.__super__.show.call(this)}};e0.prototype.before_show=function(){var e4,e3,e1,e2;e2=this.$modal_window.find(".share-link-modal-content").length;if(e2){e4={"class":"ajax-loading-indicator",src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"};e1=bv("<img />",e4);e3=bv("<div />",{"class":"loading-spinner"}).append(e1);return this.$modal_window.find(".dynamic-content").html(e3)}};return e0})(cr);bC=B.ShareLinkModalContent=(function(){function T(e4,e5,e6,e7,e0,e1,fa,e3,e8){var e9,e2;this.owner_id=e4;this.tkey=e5;this.fq_path=e6;this.link=e7;this.filename=e0;this.tokenizer_type=e1;this.tokenizer_ctx_str=fa;this.fq_path_of_restricting_sf=e8;this._send_link=dg(this._send_link,this);this._show_shared_link_settings_modal=dg(this._show_shared_link_settings_modal,this);this._show_shared_folder_settings_modal=dg(this._show_shared_folder_settings_modal,this);this._select_all_text=dg(this._select_all_text,this);this._toggle_send_link_button=dg(this._toggle_send_link_button,this);this._toggle_recipients_outside_team_warning=dg(this._toggle_recipients_outside_team_warning,this);this._toggle_close_button_text=dg(this._toggle_close_button_text,this);this._listen=dg(this._listen,this);this._init_autocompleter=dg(this._init_autocompleter,this);this.$content=bv(".share-link-modal-content");this.modal=dS.get_containing_modal(this.$content);if(!this.modal){return}if(this.tokenizer_type==="shared_folder"){this.shared_folder_members=m.create_contacts_list(e3)}e9={filename:this.filename,fq_path:this.fq_path,tkey:this.tkey,user_id:this.owner_id};document.fire(aC.LINKS_ADD,e9);this.modal.set_title(el("Share link to \u2018%(filename)s\u2019").format({filename:bK.em_snippet(this.filename,15)}));this.collab_input_id=this.tokenizer_ctx_str+"-new-collab-input";this.$collab_input=this.$content.find("#"+this.collab_input_id);this.$send_link_button=this.$content.find(".confirm-button");this.$share_link_url_input=this.$content.find(".copy-link-input-container input[type='text']");this.$cancel_button=this.$content.find(".cancel-button");this._init_autocompleter();this._listen();if((e2=this.$share_link_url_input[0])!=null){e2.select()}}T.prototype._init_autocompleter=function(){var e0,e1;e0={tokens:[",",";"],include_fb:true,include_team:true,team_only:this.tokenizer_type==="team_only",user_id:this.owner_id};if(this.tokenizer_type==="shared_folder"){this.autocompleter=new Autocompleter.SharedFolderTokenizer(cB.get_viewer().get_user_by_id(this.owner_id),this.collab_input_id,this.tokenizer_ctx_str+"-new-whobulk",this.tokenizer_ctx_str+"-hidden-input",e0,this.shared_folder_members)}else{if(this.tokenizer_type==="contacts"){this.autocompleter=new Autocompleter.ContactsTokenizer(cB.get_viewer().get_user_by_id(this.owner_id),this.collab_input_id,this.tokenizer_ctx_str+"-new-whobulk",this.tokenizer_ctx_str+"-hidden-input",e0)}else{this.autocompleter=new Autocompleter.TeamTokenizer(cB.get_viewer().get_user_by_id(this.owner_id),this.collab_input_id,this.tokenizer_ctx_str+"-new-whobulk",this.tokenizer_ctx_str+"-hidden-input",e0)}}e1=(function(e2){return function(e3){return function(){return e2.autocompleter.contact_search_logger.log_records(e2.owner_id,e3)}}})(this);this.modal.logger_keydown_close_handler=e1(true);this.modal.$overlay.on("click",e1(true));this.modal.$db_modal_x.on("click",e1(true));this.$send_link_button.on("click",e1(false));this.$cancel_button.on("click",e1(true));b8.init();return this.$collab_input.focus()};T.prototype._listen=function(){var e2,e0,e5,e4,e3,e1;this.$send_link_button.on("click",this._send_link);this.$share_link_url_input.on("click",this._select_all_text);this.$cancel_button.on("click",(function(e6){return function(e7){return dM.pop()}})(this));this.$content.find("#shared-link-permissions-link").on("click",this._show_shared_link_settings_modal);this.$content.find("#shared-folder-options-link").on("click",this._show_shared_folder_settings_modal);if((e2=this.$collab_input)!=null){e2.keyup(this._toggle_send_link_button)}if((e0=this.$collab_input)!=null){e0.on("input",this._toggle_send_link_button)}if((e5=this.$collab_input[0])!=null){e5.observe("token:remove",this._toggle_send_link_button)}if((e4=this.$collab_input[0])!=null){e4.observe("token:add",this._toggle_close_button_text)}if((e3=this.$collab_input[0])!=null){e3.observe("token:remove",this._toggle_close_button_text)}return(e1=this.$collab_input[0])!=null?e1.observe("sf:token:external",this._toggle_recipients_outside_team_warning):void 0};T.prototype._toggle_close_button_text=function(e2){var e0,e1;e0=((e1=this.autocompleter)!=null?e1.token_manager.tokens.length:void 0)===0;if(e0){return this.$cancel_button.text(el("Close"))}else{return this.$cancel_button.text(el("Cancel"))}};T.prototype._toggle_recipients_outside_team_warning=function(e2){var e0,e1;e0=bv(".external-recipient-warning-message");if(e0.length){e1=e2.memo.count;if(e2.memo.shared_folder_warning){if(e1>0){return e0.show()}else{return e0.hide()}}else{if(e1>1){e0.find(".external-recpient-num").text(e1);return e0.removeClass("single").show()}else{if(e1===1){return e0.addClass("single").show()}else{return e0.hide()}}}}};T.prototype._toggle_send_link_button=function(e2){var e0,e1;e0=((e1=this.autocompleter)!=null?e1.token_manager.tokens.length:void 0)===0;e0=e0&&bv.trim(this.$collab_input.val())==="";return this.$send_link_button.prop("disabled",e0)};T.prototype._select_all_text=function(e0){return bv(e0.currentTarget)[0].select()};T.prototype._show_shared_folder_settings_modal=function(e1){var e0;e1.preventDefault();e0=cB.get_viewer().get_user_by_id(this.owner_id);return p.show_shared_folder_options_modal(this.fq_path_of_restricting_sf,e0)};T.prototype._show_shared_link_settings_modal=function(e1){var e0;e1.preventDefault();e0=new dJ(this.owner_id,this.tkey);return dM.push(e0)};T.prototype._send_link=function(e4){var e2,e1,e3,e0,e5;e3=this.$content.find(".share-link-modal-send-form")[0];e0=this.get_shmodel_send_recipients(e3);e5=(function(e6){return function(e7){var e8;e8=aR.success_string_for_recipients(e0);ab.success(e8);dM.pop();return aI.log("shmodal_send")}})(this);e1=(function(e6){return function(e7){return bJ.remove_loading()}})(this);e2=this.$content.find(".tokenizer-submit-button")[0];return bJ.ajax_submit(e3,"/sm/share",e5,e1,e2)};T.prototype.get_shmodel_send_recipients=function(e2){var e3,fb,e8,fc,fd,e6,e9,e0,e5,e4,fa,e1,e7;cz(e2,"Must pass the shmodal send form into get_shmodel_send_recipients");e3=e2.select('input[name="emails"]');fb=e2.select('input[name="fb_ids"]');e8=e2.select('input[name="group_ids"]');e6=e2.select('input[name="new_style_group_ids"]');e0=[];e7=[e3,fb,e8,e6];for(e5=0,fa=e7.length;e5<fa;e5++){fd=e7[e5];for(e4=0,e1=fd.length;e4<e1;e4++){fc=fd[e4];e9=fc.up().innerHTML.stripTags().escapeHTML();e0.push(e9.substring(0,e9.indexOf("&")))}}return e0};return T})();W=INLINE_JS.QuickSend=B.QuickSend={_files:{},_uploading_fileids:{},init:function(T,e0,e2){var e1;this.owner_id=T;this.tokenizer_ctx_str=e0;this.keep_visible=e2;this.$content=bv("#browse-root-quick-send");this.$content[0].writeAttribute("dropzone","copy move");this.$content[0].writeAttribute("quicksend","true");this.collab_input_id=this.tokenizer_ctx_str+"-new-collab-input";this.$collab_input=this.$content.find("#"+this.collab_input_id);if((e1=this.$collab_input)!=null){e1.keyup(this._toggle_send_button_state)}if(this.$collab_input[0]){this.$collab_input[0].on("token:remove",this._toggle_send_button_state);this.$collab_input[0].on("token:add",this._toggle_send_button_state)}this.$send_button=this.$content.find("#quick-send-submit");this.$send_button.on("click",this._send_link);this.$cancel_button=this.$content.find("#quick-send-cancel");this.$cancel_button.on("click",this._cancel_button_clicked);this.$import_services=this.$content.find(".autocomplete");bv("#browse-files").addClass("quicksend-collapsed");W._update_location();this.has_autocompleter_inited=false;a3.SharedFolderActivityLogger.log("web","quick_send_displayed",ci.active_user,{});this.$collab_input.on("blur",function(){return setTimeout(function(){var e3;return(e3=W.$import_services)!=null?e3.hide():void 0},100)});bv("#quick-send-top-choose-button-send").click(function(){return bv("#quick-send-file-box").click()});bv("#quick-send-choose-button").click(function(){return bv("#quick-send-file-box").click()});bv(".quick-send-choose-file-link").click(function(){return bv("#quick-send-file-box").click()});bv("#quick-send-file-box").on("change",function(){var e4,e3;e3=bv("#quick-send-file-box")[0].files;e4=function(){if(!ci.active_user){ci.active_user=cB.get_viewer().get_user_by_id(W.owner_id)}return bi.upload(W.DEST_FOLDER+"/",e3)};return W.get_folder_name(e4)});document.on(cq.COMPLETE_EVT,W._file_upload_completed);document.on(cq.ERROR_EVT,W._file_upload_errored);return document.on(ci.UPDATE_EVT,W._update_location)},_cancel_button_clicked:function(T){a3.SharedFolderActivityLogger.log("web","quick_send_cancel_button_clicked",ci.active_user,{});return W._reset()},_init_autocompleter:function(){var T;if(W.has_autocompleter_inited){return}W.has_autocompleter_inited=true;T={tokens:[",",";"],include_fb:true,include_team:true,team_only:false,user_id:W.owner_id,max_textbox_height:30,viewer:cB.get_viewer(),include_from_linked_accounts:true};return W.autocompleter=new Autocompleter.ContactsTokenizer(cB.get_viewer().get_user_by_id(W.owner_id),W.collab_input_id,W.tokenizer_ctx_str+"-new-whobulk",W.tokenizer_ctx_str+"-hidden-input",T)},_send_link:function(e6){var e3,e2,e4,e1,e0,e7,e8,T,e5;a3.SharedFolderActivityLogger.log("web","quick_send_send_button_clicked",ci.active_user,{});W.autocompleter.tokenize_emails_input(true);T=W.autocompleter.getTokenCount();e1=bv(".quick-send-left-form")[0];e0=[];e8=0;for(e4 in W._files){e8+=1;e2=W._files[e4];e0.push(e2.fq_path)}e7={num_recipients:T,num_files:e8};a3.SharedFolderActivityLogger.log("web","quick_send_send_attempted",ci.active_user,e7);e5=(function(e9){return function(fa){W._reset();W._toggle_top_area_view();return a3.SharedFolderActivityLogger.log("web","quick_send_send_succeeded",ci.active_user,{})}})(this);e3=(function(e9){return function(fa){return a3.SharedFolderActivityLogger.log("web","quick_send_send_failed",ci.active_user,{})}})(this);return bJ.ajax_submit(e1,"/sm/quick_send",e5,e3,null,{fq_paths:e0.join(",")})},_update_file_area_view:function(){if(Object.keys(W._files).length){bv("#quick-send-drop-area").hide();bv("#quick-send-files-area").show()}else{bv("#quick-send-drop-area").show();bv("#quick-send-files-area").hide()}return W._toggle_send_button_state()},_toggle_top_area_view:function(){bv("#quick-send-top-part-send").hide();bv("#quick-send-top-part-confirm").show();return setTimeout(function(){bv("#quick-send-top-part-send").show();return bv("#quick-send-top-part-confirm").hide()},3000)},_update_location:function(){var T;T=W.keep_visible||!!ci.inside_root_folder;return W._toggle_quick_send_module(T)},_toggle_quick_send_module:function(e1){var T,e0;if(W._visible===e1){return}e0=W.$content;if(e1){W._visible=true;e0.show();return W._update_collapsed_state()}else{W._visible=false;e0.hide();e0.removeClass("collapsed expanded");T=bv("#browse-files");return T.removeClass("quicksend-collapsed quicksend-expanded")}},_update_collapsed_view:function(e3){var e0,e2,T,e1;e2=W.$content;e1=e3?"collapsed":"expanded";if(e2.hasClass(e1)){return}T=e3?"expanded":"collapsed";e2.removeClass(T);e2.addClass(e1);e0=bv("#browse-files");e1=e3?"quicksend-collapsed":"quicksend-expanded";T=e3?"quicksend-expanded":"quicksend-collpased";e0.removeClass(T);e0.addClass(e1);if(!e3){return W._init_autocompleter()}},_update_collapsed_state:function(){var T;T=Object.keys(W._files).length;return W._update_collapsed_view(T===0)},_remove_file:function(e0,T){var e1;e1=false;if(e0 in W._uploading_fileids){e1=true;document.fire(cq.CANCEL_EVT,{file:T});bv(document).trigger(cq.CANCEL_EVT,{file:T});delete W._uploading_fileids[e0]}if(e0 in W._files){$(e0).remove();delete W._files[e0];W._update_upload_list_scroll();W._update_file_area_view();return W._update_collapsed_state()}},_reset:function(){var e0,e2,e1,T;W.autocompleter.clearTokens();e1=bv(".quick-send-left-form")[0];e1.reset();T=[];for(e2 in W._files){e0=W._files[e2];T.push(W._remove_file(e2,e0.file_obj))}return T},_has_added_fq_path:function(e1){var T,e0;for(e0 in W._files){T=W._files[e0];if(T.fq_path===e1){return true}}return false},_update_upload_list_scroll:function(){var e0,T;e0=Object.keys(W._files).length;T=bv("#quick-send-upload-files-list");if(e0<3){return T.removeClass("scroll")}else{T.addClass("scroll");return T.scrollTop=T.scrollHeight}},_add_file:function(e2,T){var e9,e1,e8,e6,e7,e3,e0,fa,e5,e4;e7={size:e2.bytes,source:T};a3.SharedFolderActivityLogger.log("web","quick_send_file_added",ci.active_user,e7);e9=e2.dest||W.DEST_FOLDER;fa=aA.format_bytes(e2.bytes||0);e4=eV.tmpl("upload_list_item_tmpl");e1=e4({file:e2,icon:av.file_icon(e2.name),filename_snippet:bK.em_snippet(e2.name,dO.FILENAME_SNIPPET_LENGTH),size:fa,dest:e9,dest_snippet:bK.em_snippet(el("Dropbox")+e9,dO.DEST_SNIPPET_LENGTH,0),Sprite:cm});e0=cO.sanitize(e1.toHTML());bv("#quick-send-upload-files-list").append(e0);e8=bv("#"+e2.id);W._update_upload_list_scroll();e8.find(".dest-col").hide();e8.find(".time-col").hide();e5=e8.find(".status-col").find("a.small-x-button");e6=e2.id;e5.on("click",function(fb){return W._remove_file(e6,e2)});e3=e8.find(".remove-link");e3.on("click",function(fb){return W._remove_file(e6,e2)});e8.on("mouseenter",(function(fb){return function(fc){e8.find(".status-col").hide();return e3.show()}})(this));e8.on("mouseleave",(function(fb){return function(fc){e8.find(".status-col").show();return e3.hide()}})(this));W._files[e2.id]={file_div:e1,fq_path:e2.fq_path,bytes:e2.size,file_obj:e2};W._update_file_area_view();return W._update_collapsed_state()},_toggle_send_button_state:function(){var e1,T,e0;T=((e0=W.autocompleter)!=null?e0.token_manager.tokens.length:void 0)===0;T=T&&W.$collab_input.val()==="";e1=Object.keys(W._files).length===0||Object.keys(W._uploading_fileids).length>0;return W.$send_button.prop("disabled",T||e1)},_file_upload_errored:function(e1){var e0,T;e0=e1.memo.file;if(e0.id in W._uploading_fileids){T={message:e1.memo.message};a3.SharedFolderActivityLogger.log("web","quick_send_file_errored",ci.active_user,T);return delete W._uploading_fileids[e0.id]}},_file_upload_completed:function(e0){var T;T=e0.memo.file;if(T.id in W._uploading_fileids){a3.SharedFolderActivityLogger.log("web","quick_send_file_uploaded",ci.active_user,{});delete W._uploading_fileids[T.id];return W._toggle_send_button_state()}},get_folder_name:function(e2){var e0,e1,T;if(W.DEST_FOLDER){e2();return}T=function(e4){var e3;e3=JSON.parse(e4);W.DEST_FOLDER=e3.folder_name;return e2()};e0=function(){return ab.error(el("We couldn\u2019t upload your file. Please try again."))};e1={};e1[Constants.UID_PARAM_NAME]=W.owner_id;return new cs.WebRequest({url:"/share/quick_send_folder_name",data:e1,success:T,error:e0})},is_quicksend_dest:function(T){var e0;e0=av.normalize(T);return e0===W.DEST_FOLDER},add_external_file:function(T){var e1,e0;e0=T.dest+T.name;if(W._has_added_fq_path(e0)){ab.success(el("You\u2019ve already added this file."));document.fire(cq.CANCEL_EVT,{file:T});bv(document).trigger(cq.CANCEL_EVT,{file:T});return}T.fq_path=e0;T.bytes=T.size;W._uploading_fileids[T.id]=true;W._add_file(T,"external");e1=bv("#"+T.id);return e1.find(".upload-progress-bar").css({width:"0"})},add_dropbox_file:function(T){var e0;if(T.dir){ab.error(el("Please select files instead of folders."));return}if(W._has_added_fq_path(T.fq_path)){ab.success(el("You\u2019ve already added this file."));return}T.name=T.filename;W._add_file(T,"dropbox");e0=bv("#"+T.id);e0.find(".upload-progress-bar").css({width:"100%"});e0.addClass("complete");return setTimeout(function(){var e1;e1=e0.find(".status-col");e1.empty();return e1.append(cm.make("web","s_check"))},0)}};var dJ,cj,ar={}.hasOwnProperty,cE=function(e2,e0){for(var T in e0){if(ar.call(e0,T)){e2[T]=e0[T]}}function e1(){this.constructor=e2}e1.prototype=e0.prototype;e2.prototype=new e1();e2.__super__=e0.prototype;return e2},dg=function(T,e0){return function(){return T.apply(e0,arguments)}};dJ=B.SharedLinkSettingsModal=(function(e0){cE(T,e0);function T(e1,e2){var e3;this.owner_id=e1;this.tkey=e2;e3={tkey:this.tkey};e3[Constants.UID_PARAM_NAME]=this.owner_id;T.__super__.constructor.call(this,{element_id:"shared-link-settings-modal",endpoint_url:"/sm/shared_link_settings",parameters:e3})}return T})(cr);cj=B.SharedLinkSettingsModalContent=(function(){function T(e1,e2,e0,e4){var e5,e3;this.owner_id=e1;this.tkey=e2;this.filename=e0;this.saved_password_placeholder_value=e4;this._save_settings=dg(this._save_settings,this);this._toggle_password_input=dg(this._toggle_password_input,this);this._enable_password_input_for_editing=dg(this._enable_password_input_for_editing,this);this._date_change_callback=dg(this._date_change_callback,this);this._show_calendar=dg(this._show_calendar,this);this._hide_calendar=dg(this._hide_calendar,this);this._future_date=dg(this._future_date,this);this._enable_save_button=dg(this._enable_save_button,this);this._custom_expiry_click_handler=dg(this._custom_expiry_click_handler,this);this._hide_custom_expiry_label=dg(this._hide_custom_expiry_label,this);this._show_custom_expiry_label=dg(this._show_custom_expiry_label,this);this._toggle_expiration=dg(this._toggle_expiration,this);this._expiry_picker_callback=dg(this._expiry_picker_callback,this);this._listen=dg(this._listen,this);this._detect_and_handle_blur_when_password_empty=dg(this._detect_and_handle_blur_when_password_empty,this);this._is_clicked=dg(this._is_clicked,this);this._change_password_click=dg(this._change_password_click,this);this._init_expiration_section=dg(this._init_expiration_section,this);this.MS_PER_DAY=1000*60*60*24;this.$content=bv(".sharing-settings-modal-content");this.modal=dS.get_containing_modal(this.$content);if(!this.modal){return}e3=el("'%(filename)s' permissions").format({filename:bK.em_snippet(this.filename,18)});this.modal.set_title(e3);this.$form=this.$content.find(".shared-link-settings-modal-form");this.$save_button=this.$form.find(".confirm-button");this.$password_field_container=this.$form.find(".password-field-container");this.$password=this.$form.find(".link-password-container");this.$password_input=this.$password.find("input[name='password']");this.$password_label=this.$password.find("label");this.$change_password=this.$form.find(".change-link-password-container");this.$selected_expiry=this.$form.find(".selected-expiration");this.$unselected_expiry=this.$form.find(".unselected-expiration");this.$custom_expiry=this.$form.find(".custom-expiration");this.$selected_date_box=this.$form.find(".selected-date");this.$selected_date=this.$form.find(".selected-date-text");this.$calendar=this.$form.find("#expiration-calendar-container");this.$expiry_posix=this.$form.find("#expiration-posix");this.$static_expiry=this.$form.find(".static-expiration");this.loaded_with_saved_password=this.$password_input.data("is-saved-password")==="yes";if(this.loaded_with_saved_password){this._show_password_input(e5=true)}this._init_expiration_section();this._listen()}T.prototype._init_expiration_section=function(){var e0;this.$form.find(".expiration-selection").show();if(this.$expiry_posix.val()){bv("#expiration-yes").prop("checked",true);e0=this._posix_time_to_date(parseInt(this.$expiry_posix.val()));this._set_selected_date_text(e0);return this._show_custom_expiry_label()}else{this.$selected_expiry.hide();this._hide_custom_expiry_label();return this.$unselected_expiry.show()}};T.prototype._change_password_click=function(e0){e0.preventDefault();return this._enable_password_input_for_editing()};T.prototype._is_clicked=function(e0,e1){return e0.is(e1.target)||e0.has(e1.target).length};T.prototype._detect_and_handle_blur_when_password_empty=function(e0){if(!this.$password.is(":visible")||this.$password_input.val()||this._is_clicked(this.$password_field_container,e0)){return}return this._show_password_input(true)};T.prototype._listen=function(){if(this.loaded_with_saved_password){bv(window).on("click",this._detect_and_handle_blur_when_password_empty);this.$change_password.find(".change-link-password").on("click",this._change_password_click)}this.$form.on("change",this._enable_save_button);this.$form.on("submit",this._save_settings);this.$save_button.on("click",this._save_settings);this.$content.find(".cancel-button").on("click",(function(e0){return function(e1){return dM.pop()}})(this));this.$content.find(".audience-selection input[type=radio]").on("change",this._toggle_password_input);this.$content.find(".expiration-selection input[type=radio]").on("change",this._toggle_expiration);return bv(window).on(br.CHANGED,this._expiry_picker_callback)};T.prototype._expiry_picker_callback=function(e3,e2){var e0,e1;if(e2.clicked_val===e2.old_val){return}e0=e2.clicked_val;if(e0!=="custom"){e1=this._future_date(parseInt(e0));return this._set_expiration(e1)}else{this.$selected_expiry.hide();this._show_custom_expiry_label();this._set_selected_date_text(this._future_date(30));return this._show_calendar()}};T.prototype._toggle_expiration=function(e2){var e1,e0;if(bv(e2.currentTarget).attr("id")==="expiration-yes"){this.$selected_expiry.show();this._hide_custom_expiry_label();this.$unselected_expiry.hide();bv(".expiration-picker").controller().set_value(30);e0=30;e1=this._future_date(e0);this._set_expiration(e1);return this._set_selected_date_text(e1)}else{this.$expiry_posix.val("");this.$unselected_expiry.show();this.$selected_expiry.hide();this.$static_expiry.hide();this._hide_custom_expiry_label();return this._hide_calendar()}};T.prototype._show_custom_expiry_label=function(){this.$custom_expiry.show();this.$selected_expiry.hide();this.$unselected_expiry.hide();return bv(window).on("click",this._custom_expiry_click_handler)};T.prototype._hide_custom_expiry_label=function(){this.$custom_expiry.hide();return bv(window).off("click",this._custom_expiry_click_handler)};T.prototype._custom_expiry_click_handler=function(e0){if(this._is_clicked(this.$calendar,e0)){return}if(this.$selected_date_box.is(e0.target)||this.$selected_date_box.has(e0.target).length){if(this.$calendar.is(":visible")){return this.$calendar.hide()}else{return this._show_calendar()}}else{if(this.$calendar.is(":visible")){return this.$calendar.hide()}}};T.prototype._enable_save_button=function(e0){return this.$save_button.removeAttr("disabled")};T.prototype._future_date=function(e0){var e1;e1=dQ.start_of_day(new Date());e1.setDate(e1.getDate()+e0);return e1};T.prototype._hide_calendar=function(){return this.$calendar.hide()};T.prototype._show_calendar=function(){var e2,e1,e0;bv(".selected-date").off("click");if(!this.calendar){if(this.$expiry_posix.val()){e0=this._posix_time_to_date(parseInt(this.$expiry_posix.val()))}else{e0=this._future_date(30)}e1={disable_past:true,first_day:this._future_date(1),last_day:this._future_date(365),selected_date:e0,onDateChange:bv.proxy(this._date_change_callback,this)};this.calendar=new F("expiration-calendar-container",e1)}else{this.$calendar.show()}e2=this.$selected_date_box.offset().left;return this.$calendar.show().offset({left:e2})};T.prototype._posix_time_to_date=function(e0){return new Date(e0*1000)};T.prototype._set_selected_date_text=function(e0){return this.$selected_date.text(K.localize(e0))};T.prototype._set_expiration=function(e1){var e0,e2;cz(e1.getMilliseconds()===0);cz(e1.getSeconds()===0);cz(e1.getMinutes()===0);cz(e1.getHours()===0);e2=(e1.getTime()+this.MS_PER_DAY)/1000;e0=e2-1;return this.$expiry_posix.val(e0)};T.prototype._date_change_callback=function(e0){this._set_selected_date_text(e0);this._set_expiration(e0);this._enable_save_button();return this._hide_calendar()};T.prototype._show_password_input=function(e5){var e4,e2,e1,e3,e0;if(e5==null){e5=false}e4=this.$content.find("label[for=audience-password]").position().left;e3=this.$content.find("#audience-password").position().left;e2=e4-e3+10;this.$password.show().css({left:e2});this.$password_input.val("");if(e5){this.$password_input.addClass("disabled").attr("readonly","true");this.$password_input.data("is-saved-password","yes");e0="\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf\u25cf";this.$password_label.text(e0).show();e1=this.$password.position();return this.$change_password.css({left:e1.left,top:e1.top}).show()}else{return this._enable_password_input_for_editing()}};T.prototype._enable_password_input_for_editing=function(){this.$change_password.hide();this.$password_input.removeAttr("readonly").removeClass("disabled");this.$password_input.data("is-saved-password","no");this.$password_label.text(el("Set password")).show();this.$password_input.focus();return this._enable_save_button()};T.prototype._toggle_password_input=function(e0){var e1;if(bv(e0.currentTarget).attr("id")==="audience-password"){return this._show_password_input(e1=this.loaded_with_saved_password)}else{this.$password.hide();this.$change_password.hide();return this.$password_input.data("is-saved-password","no")}};T.prototype._save_settings=function(e3){var e1,e0,e2,e4;if(this.$password_input.data("is-saved-password")==="yes"){e2={type:"hidden",name:"password",value:this.saved_password_placeholder_value};e1=bv("<input />",e2);this.$form.append(e1);this.$password_input.attr("name","inoperative_password")}e4=(function(e5){return function(e6){dM.pop();return ab.success(el("Settings saved."))}})(this);e0=(function(e5){return function(e6){if(e5.$password.length&&e5.$password.is(":visible")){e5.$password_input.focus()}return bJ.remove_loading()}})(this);return bJ.ajax_submit(this.$form[0],"/sm/change_shared_link_settings",e4,e0,this.$save_button[0])};return T})();var eq;eq=B.SimpleSharing=(function(){function T(){}T.createAndShowInbandModalFromBrowseFile=function(e0,e1){return T.createAndShowInbandModal(e0,e1.fq_path,e1.dir,e1.target_ns,e1.is_shared_folder(),e1.could_be_shared_folder(),parseInt(e1.sf_perm_role))};T.createAndShowInbandModal=function(e3,e8,e7,e9,e6,fb,fc){var e2,fa,e1,e5,e4,e0;e2=function(fe,ff,fd){return window.INLINE_JS.DBModalStack.push(new c2(fe,ff,false,false,fd))};e0=function(fe,ff,fd){return window.INLINE_JS.DBModalStack.push(new bT(fe,{element_id:"unshare-confirm-modal",team_shared_folder:false,ns_id:fd,folder_path:ff}))};e1=function(fe,ff,fd,fh,fg){return window.INLINE_JS.DBModalStack.push(new eB(fe,{element_id:"kick-confirm-modal",ns_id:fd,user_name:fg,folder_path:ff,user_id:fh}))};fa=function(fe,fg,fd,ff,fh){return window.INLINE_JS.DBModalStack.push(new aN(fe,{element_id:"kick-group-confirm-modal",ns_id:fd,group_name:fh,folder_path:fg,group_id:ff}))};e4=function(fe,ff,fd,fh,fg){return window.INLINE_JS.DBModalStack.push(new aD(fe,{element_id:"uninvite-confirm-modal",email_or_fbname:fg,ns_id:fd,invite_id:fh,folder_path:ff}))};e5=function(fe,ff,fd){return dM.push(new df(fe,{element_id:"leave-confirm-modal",ns_id:fd,folder_path:ff}))};return dA.createAndShowModal(e3,e8,e2,e0,e1,fa,e4,e5,Boolean(e7),e9,e6,fb,parseInt(fc),ci.simple_sharing_react_memeber_list_enabled)};return T})();var ek,eh;eh=B.FoshmodalPanes=Object.clone(da);eh.to_title_str=function(){var T,e0,e4,e2,e3,e1;if(ek.sharing_collection){e2=bK.em_snippet(ek.collection_to_share.name,18,1);return el("Share '%(snippeted_name)s'").format({snippeted_name:e2})}else{T=ek._selection;e1=cV.categorize_files(T),e0=e1[0],e4=e1[1];if(e0&&e4){e3=a4("Share %(file_count)s item","Share %(file_count)s items",T.length)}else{if(e0){e3=a4("Share %(file_count)s photo","Share %(file_count)s photos",T.length)}else{e3=a4("Share %(file_count)s video","Share %(file_count)s videos",T.length)}}e3=e3.format({file_count:T.length});return e3}};ek=INLINE_JS.Foshmodal=B.Foshmodal={current_shmodel_url:null,current_short_url:null,callback_for_when_we_have_shmodel_url:null,current_foshmodal_pane:eh.SEND,send_link_autocompleter:null,sharing_collection:false,num_photos_to_share:null,working:false,collection_to_share:null,have_real_tkey:false,current_tkey:null,current_album_name:null,previous_album_name:null,_selection:null,lock:function(){if(this.working){return false}this.working=true;return this.working},unlock:function(){return this.working=false},clear_message_inputs:function(){$("shmodal-send-content").down(".custom-message-container").down(".textinput").setValue("");$("shmodal-fb-post-input").setValue("");return $("shmodal-twitter-post-input").setValue("")},refresh:function(){this.current_shmodel_url=null;this.current_short_url;this.callback_for_when_we_have_shmodel_url=null;this.current_foshmodal_pane=eh.SEND;this.sharing_collection=false;this.have_real_tkey=false;this.current_tkey=null;this.current_album_name=null;this.previous_album_name=null;eF.clear();this.clear_message_inputs();this.send_link_autocompleter.clearTokens();this.unlock();bv(".link-image").attr("src","static/images/empty_album_big.png");bJ.remove_loading(bv("#modal").find(".tokenizer-submit-button")[0]);bJ.remove_loading(bv("#modal").find(".foshmodal-copy-link")[0]);bJ.remove_loading(bv("#shmodal-twitter-post-submit")[0]);return bJ.remove_loading(bv("#shmodal-fb-post-submit")[0])},create_album_from_selected_photos:function(T){var e0;cz(this._selection.length,"This should never be called with an empty selection");cz(this.current_tkey!=null,"Missing tkey");cz(this.current_shmodel_url!=null,"Missing shmodel url");cz(this.current_short_url!=null,"Missing short url");cz(T!=null,"Missing collection info");T.is_anonymous=this.creating_anonymous_collection();T.share_tkey=this.current_tkey;T.shmodel_url=this.current_shmodel_url;T.short_url=this.current_short_url;return e0=new Z(T)},set_shmodel_url:function(e0,T){if(this.have_real_tkey){this.current_shmodel_url=this.collection_to_share.shmodel_url;this.current_short_url=this.collection_to_share.short_url;this.current_tkey=this.collection_to_share.share_tkey;return typeof e0==="function"?e0():void 0}else{return new Ajax.DBRequest("/collection_create_dummy_token",{onSuccess:(function(e1){return function(e3){var e2;e2=JSON.parse(e3.responseText);e1.current_shmodel_url=e2.token_link;e1.current_short_url=e2.short_link;e1.current_tkey=e2.tkey;if(typeof e0==="function"){e0()}return typeof e1.callback_for_when_we_have_shmodel_url==="function"?e1.callback_for_when_we_have_shmodel_url():void 0}})(this),onFailure:function(){return typeof T==="function"?T():void 0}})}},attach_collection_to_token:function(e0,T){cz(this.collection_to_share!=null,"Should get called only when there is an existing collection");cz(this.current_shmodel_url!=null,"Should have a shmodel url before you call attach_collection_to_token");if(this.have_real_tkey){if(typeof e0==="function"){e0(this.collection_to_share.gid)}return}cz(this.current_tkey!=null,"should have tkey");return this.collection_to_share.attach_to_token(this.current_tkey,this.current_shmodel_url,this.current_short_url,e0,T)},create_collection_and_attach_to_token:function(e4,T){var e1,e3,e2,e0;cz(this.sharing_collection===false,"Should not get called when we already have a collection");cz(this.current_shmodel_url!=null,"Should have a shmodel url before you call create_collection_and_attach_to_token");e3=(function(e5){return function(e6){var e7;e7=JSON.parse(e6.responseText);e5.create_album_from_selected_photos(e7);return typeof e4==="function"?e4(e7.gid):void 0}})(this);e1=function(e5){return typeof T==="function"?T(e5):void 0};e2={tkey:this.current_tkey,collection_name:this.creating_anonymous_collection()?"":this.current_album_name,is_anonymous:this.creating_anonymous_collection(),item_counters:JSON.stringify((function(){var e8,e6,e7,e5;e7=this._selection;e5=[];for(e8=0,e6=e7.length;e8<e6;e8++){e0=e7[e8];e5.push(e0.item_counter)}return e5}).call(this))};if(bG.in_single_collection_view()){e2.source_collection_gid=bG.get_current_collection().gid}return new Ajax.DBRequest("/collection_create_and_attach_to_dummy_token",{onSuccess:e3,onFailure:e1,parameters:e2})},alert_if_album_name_invalid:function(){if(this.creating_anonymous_collection()){return false}if(this.current_album_name.strip().length===0){ab.error(el("Please enter a name for this album"));this.unlock();return true}if(cw.collection_name_in_use(this.current_album_name)){ab.error(el("You already have an album named '%(current_album_name)s'").format({current_album_name:this.current_album_name}));this.unlock();return true}return false},send_button_onclick:function(e1){var e0,T;if(!this.lock()){return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}e0=$("shmodal-send-form");cz(e0,"Couldn't find the shmodal send form.");if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.send_button_onclick.bind(this);return}T=(function(e2){return function(e3){e2.unlock();if(!e3.responseText.startsWith("err:")){ab.error(el("We couldn't send this album. Please try again."));eS.hide();return e2.refresh()}}})(this);if(this.sharing_collection){this.send_collection(e0,T)}else{this.send_selection(e0,T)}return h.log_interaction(d8.SEND,cY.FOSHMODAL,{num_photos:this.num_photos_to_share})},get_send_success_text:function(){var e2,e0,e1,T,e3;e2=this.get_current_display_name();T=ag.get_shmodel_send_recipients($("shmodal-send-form"));e0=T[0].split(" ")[0];if(T.length===1){e3=el("Shared %(album_name)s with %(first_name_of_recipient)s").format({album_name:e2,first_name_of_recipient:e0})}else{if(T.length===2){e1=T[1].split(" ")[0];e3=el("Shared %(album_name)s with %(first_name_of_recipient)s and %(first_name_of_second_recipient)s").format({album_name:e2,first_name_of_recipient:e0,first_name_of_second_recipient:e1})}else{e3=el("Shared %(album_name)s with %(first_name_of_recipient)s and %(num_other_recipients)s others").format({album_name:e2,first_name_of_recipient:e0,num_other_recipients:T.length-1})}}return e3},send_selection:function(e1,e0){var e3,e2,T;e3=(function(e4){return function(e5){var e6;e6=JSON.parse(e5.responseText);e4.create_album_from_selected_photos(e6);ab.success(e4.get_send_success_text());e4.refresh();return eS.hide()}})(this);e2={shmodel_url:this.current_shmodel_url,tkey:this.current_tkey,num_items:this.num_photos_to_share,is_anonymous:this.creating_anonymous_collection(),item_counters:JSON.stringify((function(){var e7,e5,e6,e4;e6=this._selection;e4=[];for(e7=0,e5=e6.length;e7<e5;e7++){T=e6[e7];e4.push(T.item_counter)}return e4}).call(this))};if(bG.in_single_collection_view()){e2.source_collection_gid=bG.get_current_collection().gid}if(this.creating_anonymous_collection()){e2.collection_name=""}else{if(this.current_album_name.trim().length===0){e2.collection_name=cw.get_default_album_name()}}return bJ.ajax_submit(e1,"/collection_create_and_send_link",e3,e0,e1.down(".tokenizer-submit-button"),e2)},send_collection:function(e0,T){var e1;cz(this.current_tkey!=null,"tkey should be set");cz(this.current_shmodel_url!=null,"shmodel url should be set");e1=(function(e2){return function(){ab.success(e2.get_send_success_text());eS.hide();return e2.refresh()}})(this);return this.collection_to_share.send_link(e0,this.current_tkey,this.current_shmodel_url,this.current_short_url,e1,T)},get_link_button_onclick:function(){var T,e1,e0;if(!this.lock()){return}if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.get_link_button_onclick.bind(this);return}e0=$("modal").down(".tokenizer-submit-button");e1=(function(e2){return function(e4){var e3;e3=e2.get_current_display_name();if(FlashDetect.installed){ab.success(el("The link to %(album_name)s was copied to your clipboard",{comment:"name of a photo/video album"}).format({album_name:e3}))}e2.show_get_link_modal(e2.current_shmodel_url,e3,e4);a3.ViralLogger.log(cB.get_viewer().get_user_ids(),"shmodel","send",{src:"photo_copy_link",file_type:"collection"});if(e2.collection_to_share!=null){co.log_share("share_link",e4,e2.num_photos_to_share,e2.creating_anonymous_collection(),!e2.sharing_collection)}return e2.refresh()}})(this);T=(function(e2){return function(e3){e2.unlock();bJ.remove_loading(e0);if(!e3.responseText.startsWith("err")){ab.error(el("We couldn't create a link to this album. Please try again."));eS.hide();return e2.refresh()}}})(this);if(this.sharing_collection){bJ.add_loading(e0);this.attach_collection_to_token(e1,T)}else{if(this.alert_if_album_name_invalid()){return}bJ.add_loading(e0);this.create_collection_and_attach_to_token(e1,T)}return h.log_interaction(d8.GET_LINK,cY.FOSHMODAL,{num_photos:this.num_photos_to_share})},initialize_get_link_button:function(){var T,e0;if(FlashDetect.installed){T=q.clipboard_overlay(this.current_shmodel_url,bv("#foshmodal-copy-link"),ek.get_link_button_onclick.bind(this));T.css({position:"fixed",zIndex:1001});clearInterval(this.follow_freshbutton);e0=(function(e1){return function(){return T.clonePosition(bv("#foshmodal-copy-link"),{offsetHeight:6,offsetWidth:6})}})(this);return this.follow_freshbutton=setInterval(e0,500)}else{$("foshmodal-copy-link").stopObserving();return $("foshmodal-copy-link").observe("click",this.get_link_button_onclick.bind(this))}},facebook_button_onclick:function(e4,e0){var e3,e1,T,e2;if(!this.lock()){return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.facebook_button_onclick.bind(this).curry(e4,e0);return}e3=bv("#modal:visible, #modal-overlay:visible");T=function(){return e3.show()};e1=(function(e5){return function(){e5.lock();setTimeout(e5.unlock.bind(e5),750);return ed.do_auth((function(){return e5.do_fb_post(e0)}),e0)}})(this);if(ed.authed_user_id===e0){this.do_fb_post(e0)}else{if(cB.get_viewer().is_uid_associated(ed.authed_user_id)){this.unlock();e3.hide();e2=new dY(cB.get_viewer().get_user_by_id(e0),T,e1.bind(this));e2.show()}else{e1()}}return h.log_interaction(d8.FB_SHARE,cY.FOSHMODAL,{num_photos:this.num_photos_to_share})},twitter_button_onclick:function(e0,T){if(!this.lock()){return}if(this.current_shmodel_url==null){this.callback_for_when_we_have_shmodel_url=this.twitter_button_onclick.bind(this).curry(e0,T);return}if(!this.sharing_collection&&this.alert_if_album_name_invalid()){return}if(ct.is_authed(T)){this.do_twitter_post(T)}else{setTimeout(this.unlock.bind(this),750);ct.do_auth(((function(e1){return function(){return e1.do_twitter_post(T)}})(this)),T)}return h.log_interaction(d8.TWITTER_SHARE,cY.FOSHMODAL,{num_photos:this.num_photos_to_share})},do_fb_post:function(T){var e0,e1;e0=(function(e2){return function(){ab.error(el("We couldn't share this album on Facebook. Please try again."));eS.hide();return e2.refresh()}})(this);e1=(function(e2){return function(e4){var e3;ed.custom_show_posting=function(){return bJ.add_loading($("shmodal-fb-post-submit"))};ed.progress_container=$("modal").down(".modal-buttons");e3=e2.get_current_display_name();ed.custom_show_complete=function(){eS.hide();ab.success(el("Shared %(album_name)s on Facebook!",{comment:"name of a photo/video album"}).format({album_name:e3}));return e2.refresh()};ed.post($F("shmodal-fb-post-input"),e2.current_shmodel_url,null,null,null,e0,T);a3.ViralLogger.log(cB.get_viewer().get_user_ids(),"shmodel","send",{src:"photo_fb_post",file_type:"collection"});return co.log_share("share_facebook",e4,e2.num_photos_to_share,e2.creating_anonymous_collection(),!e2.sharing_collection)}})(this);if(this.sharing_collection){return this.attach_collection_to_token(e1,e0)}else{return this.create_collection_and_attach_to_token(e1,e0)}},do_twitter_post:function(T){var e2,e0,e1;e2=$F("shmodal-twitter-post-input");if(!e2){ab.error(el("Please enter a tweet"));this.unlock();return}if(e2.length>140){ab.error(el("Your tweet must be 140 characters or less"));this.unlock();return}e1=(function(e3){return function(e4){ct.custom_show_posting=function(){$("twitter-chars").hide();return bJ.add_loading($("shmodal-twitter-post-submit"))};ct.custom_post(e2,function(){eS.hide();ab.success(el("Your tweet has been posted!"));return e3.refresh()},T);a3.ViralLogger.log(cB.get_viewer().get_user_ids(),"shmodel","send",{src:"photo_twitter",file_type:"collection"});return co.log_share("share_twitter",e4,e3.num_photos_to_share,e3.creating_anonymous_collection(),!e3.sharing_collection)}})(this);e0=(function(e3){return function(){ab.error(el("We couldn't share this album on Twitter. Please try again."));eS.hide();return e3.refresh()}})(this);if(this.sharing_collection){return this.attach_collection_to_token(e1,e0)}else{return this.create_collection_and_attach_to_token(e1,e0)}},show_get_link_modal:function(e0,T,e1){var e2;eS.show(el("Link to %(album_name)s").format({album_name:T.escapeHTML()}),$("get-link-modal"));e2=$("get-link-modal").down(".link-input");e2.setValue(e0);e2.select();$("get-link-modal").down(".view-button").onclick=function(){window.open(e0,"_blank");return eS.hide()};return $("get-link-modal").down(".done-button").onclick=function(){if(e1!=null){cw.flash_sidebar_album(e1)}return eS.hide()}},update_current_album_name_text:function(T){this.current_album_name=$(eh.to_content_str(this.current_foshmodal_pane)).down(".album-name-input").value;if(this.current_foshmodal_pane===eh.FB){return this.set_fb_post_title(this.current_album_name)}},set_fb_post_title:function(e3){var e0,e2,e1,T;T=this.sharing_collection?bG.get_timeline().get_photos():this._selection;if(e3){if(this.num_photos_to_share===1){e0=e3}else{e0=el("%(album_name_text)s (%(album_desc)s)",{comment:'e.g. album_desc is "5 photos and 1 video" and album_name_text is "my_album"'}).format({album_name_text:e3,album_desc:cV.file_desc(T)})}}else{if(T.length===1){e1=T[0];if(e1.preview_type==="photo"){e2=el("Photo from %(date_taken)s")}else{e2=el("Video from %(date_taken)s")}e0=e2.format({date_taken:bU.nice_date_with_month_name(new Date(e1.time_taken),true,true,true)})}else{e0=cV.file_desc(T)}}return $(eh.to_content_str(eh.FB)).down(".link-name").__date(e0)},set_current_album_name_text:function(e0,T){$(eh.to_content_str(e0)).down(".album-name-input").value=T;if(e0===eh.FB){return this.set_fb_post_title(T)}},show_content:function(e3){var e0,e2,T,e1;if(this.working){return}$("shmodal-title-text").__date(eh.to_title_str());e1=eh.list;for(e2=0,T=e1.length;e2<T;e2++){e0=e1[e2];if(e0!==e3){$(eh.to_toggle_str(e0)).removeClassName("toggled");$(eh.to_content_str(e0)).hide()}}$(eh.to_content_str(e3)).show();$(eh.to_toggle_str(e3)).addClassName("toggled");if(!this.sharing_collection){this.set_current_album_name_text(e3,this.current_album_name)}switch(e3){case eh.FB:$("shmodal-fb-post-input").focus();break;case eh.TWITTER:$("shmodal-twitter-post-input").focus();break;case eh.SEND:$("foshmodal-new-collab-input").focus()}return this.current_foshmodal_pane=e3},_get_foshmodal_title:function(){return ag.generate_title_content(eh.to_title_str(),((function(T){return function(){return T.show_content(eh.SEND)}})(this)),((function(T){return function(){return T.show_content(eh.FB)}})(this)),((function(T){return function(){return T.show_content(eh.TWITTER)}})(this)))},creating_anonymous_collection:function(){return !$("shmodal").hasClassName("saving-as-album")},get_current_display_name:function(){if(this.sharing_collection){return"'"+this.collection_to_share.name+"'"}else{if(this.creating_anonymous_collection()){return cV.file_desc(this._selection,true)}else{return"'"+this.current_album_name+"'"}}},set_twitter_message:function(){var T,e1,e0,e3,e2;T=this.sharing_collection?bG.get_timeline().get_photos():this._selection;if(T.length===1){e2=cV.categorize_files(T),e0=e2[0],e3=e2[1];if(e0){e1=el("Just shared a photo using @Dropbox")}else{if(e3){e1=el("Just shared a video using @Dropbox")}else{cz(false,"We shouldn't have non-photo, non-video files in timeline")}}}else{e1=el("Just shared an album using @Dropbox")}return $("shmodal-twitter-post-input").setValue(""+e1+" "+this.current_short_url)},update_shmodal_image_text:function(){var e6,e9,e8,e4,e3,e7,T,e5,e2,e1,e0;if(this.sharing_collection){e9=this.collection_to_share.num_items;e8=cV.album_desc(this.collection_to_share,false,true)}else{e9=this._selection.length;e8=cV.file_desc(this._selection,false,true)}if(e9>1){e5=$$(".shmodal-image");e1=[];for(e4=0,e7=e5.length;e4<e7;e4++){e6=e5[e4];e6.down("span").__date(e8);e1.push(e6.down(".share-file-count").show())}return e1}else{e2=$$(".shmodal-image");e0=[];for(e3=0,T=e2.length;e3<T;e3++){e6=e2[e3];e0.push(e6.down(".share-file-count").hide())}return e0}},show:function(e7,fe){var e8,fb,fc,e9,fd,e5,e4,e2,fa,e0,T,e6,e3,e1;this.unlock();eS.onHide=(function(ff){return function(){var fh,fg;if((fh=$("flash_copy_container"))!=null){fh.remove()}if((fg=ff.send_link_autocompleter)!=null){fg.hide()}bv("#modal").find(".new-collab-input").val("");clearInterval(ff.follow_freshbutton);bG.disable_selection();delete eS.onHide;return eS.hide()}})(this);this.sharing_collection=fe;fd=this.sharing_collection?e7.thumbnail_url_256:e7[0].thumbnail_url;e6=$$(".link_image");for(e5=0,fa=e6.length;e5<fa;e5++){fb=e6[e5];if(fd!=null){fb.src=fd}else{fb.src="static/images/empty_album_big.png"}}this.current_foshmodal_pane=eh.SEND;this.have_real_tkey=this.sharing_collection&&(e7.share_tkey!=null);if(this.sharing_collection){this.collection_to_share=e7;this.num_photos_to_share=this.collection_to_share.num_items;$("shmodal").addClassName("sharing-collection");this.set_fb_post_title(this.collection_to_share.name)}else{this._selection=e7.sort(function(fg,ff){return fg.time_taken-ff.time_taken});this.num_photos_to_share=this._selection.length;this.current_album_name="";this.set_current_album_name_text(this.current_foshmodal_pane,this.current_album_name);$("shmodal").removeClassName("sharing-collection");$("shmodal").removeClassName("saving-as-album");e3=$$(".save-as-album-checkbox");for(e4=0,e0=e3.length;e4<e0;e4++){e8=e3[e4];e8.checked=false;e9=(function(ff){return function(fo){var fp,fl,fj,fh,fg,fk,fi,fn,fm;if(fo.target.checked){$("shmodal").addClassName("saving-as-album");ff.current_album_name=ff.previous_album_name||cw.get_default_album_name();ff.set_current_album_name_text(ff.current_foshmodal_pane,ff.current_album_name);fp=$(eh.to_content_str(ff.current_foshmodal_pane)).down(".album-name-input");fp.focus();fp.select();fk=$$(".save-as-album-checkbox");fn=[];for(fl=0,fh=fk.length;fl<fh;fl++){e8=fk[fl];fn.push(e8.checked=true)}return fn}else{$("shmodal").removeClassName("saving-as-album");ff.previous_album_name=ff.current_album_name;ff.current_album_name="";ff.set_current_album_name_text(ff.current_foshmodal_pane,ff.current_album_name);fi=$$(".save-as-album-checkbox");fm=[];for(fj=0,fg=fi.length;fj<fg;fj++){e8=fi[fj];fm.push(e8.checked=false)}return fm}}})(this);e8.observe("change",e9);if(bR.msie_version_at_most(8)){e8.observe("click",e9)}}e1=$$(".album-name-input");for(e2=0,T=e1.length;e2<T;e2++){fc=e1[e2];fc.observe("keyup",this.update_current_album_name_text.bind(this))}}bG.enable_selection();eS.show(this._get_foshmodal_title(),$("shmodal"));this.clear_message_inputs();this.show_content(this.current_foshmodal_pane);this.set_shmodel_url(((function(ff){return function(){ff.initialize_get_link_button();return ff.set_twitter_message()}})(this)),(function(){ab.error(el("This request could not be completed.  Please try again."));return eS.hide()}));this.update_shmodal_image_text();if(!this.send_link_autocompleter){this.send_link_autocompleter=new Autocompleter.ContactsTokenizer(cB.get_viewer().get_user_by_role(Constants.ROLE_PHOTOS),"foshmodal-new-collab-input","foshmodal-new-whobulk","foshmodal-hidden-input",{tokens:[",",";"],include_fb:true,include_team:true})}this.send_link_autocompleter.clearTokens();R.register(false,$("modal"));if(this.num_photos_to_share<=1){$("shmodal-send-content").down(".collection-thumb-stack").hide();$("shmodal-twitter-content").down(".collection-thumb-stack").hide()}else{$("shmodal-send-content").down(".collection-thumb-stack").show();$("shmodal-twitter-content").down(".collection-thumb-stack").show()}return dQ._track_twitter_chars_left("shmodal-twitter-post-input",140)}};(function(e0,e5){var e2={};function e1(fa,fb){var e9,e7=[];for(var e8=0;e8<fa.length;++e8){e9=e2[fa[e8]]||e3(fa[e8]);if(!e9){throw"module definition dependecy not found: "+fa[e8]}e7.push(e9)}fb.apply(null,e7)}function e6(e9,e8,e7){if(typeof e9!=="string"){throw"invalid module definition, module id must be defined and be a string"}if(e8===e5){throw"invalid module definition, dependencies must be specified"}if(e7===e5){throw"invalid module definition, definition function must be specified"}e1(e8,function(){e2[e9]=e7.apply(null,arguments)})}function e4(e7){return !!e2[e7]}function e3(fa){var e8=e0;var e7=fa.split(/[.\/]/);for(var e9=0;e9<e7.length;++e9){if(!e8[e7[e9]]){return}e8=e8[e7[e9]]}return e8}function T(e9){for(var e8=0;e8<e9.length;e8++){var fa=e0;var fc=e9[e8];var e7=fc.split(/[.\/]/);for(var fb=0;fb<e7.length-1;++fb){if(fa[e7[fb]]===e5){fa[e7[fb]]={}}fa=fa[e7[fb]]}fa[e7[e7.length-1]]=e2[fc]}}e6("moxie/core/utils/Basic",[],function(){var ff=function(fk){var fj;if(fk===fj){return"undefined"}else{if(fk===null){return"null"}else{if(fk.nodeType){return"node"}}}return({}).toString.call(fk).match(/\s([a-z|A-Z]+)/)[1].toLowerCase()};var fb=function(fk){var fj;fd(arguments,function(fl,fm){if(fm>0){fd(fl,function(fo,fn){if(fo!==fj){if(ff(fk[fn])===ff(fo)&&!!~fh(ff(fo),["array","object"])){fb(fk[fn],fo)}else{fk[fn]=fo}}})}});return fk};var fd=function(fo,fp){var fn,fl,fk,fm;if(fo){try{fn=fo.length}catch(fj){fn=fm}if(fn===fm){for(fl in fo){if(fo.hasOwnProperty(fl)){if(fp(fo[fl],fl)===false){return}}}}else{for(fk=0;fk<fn;fk++){if(fp(fo[fk],fk)===false){return}}}}};var fg=function(fj){var fk;if(!fj||ff(fj)!=="object"){return true}for(fk in fj){return false}return true};var e9=function(fk,fj){var fl=0,fm=fk.length;if(ff(fj)!=="function"){fj=function(){}}if(!fk||!fk.length){fj()}function fn(fo){if(ff(fk[fo])==="function"){fk[fo](function(fp){++fo<fm&&!fp?fn(fo):fj(fp)})}}fn(fl)};var fh=function(fl,fm){if(fm){if(Array.prototype.indexOf){return Array.prototype.indexOf.call(fm,fl)}for(var fj=0,fk=fm.length;fj<fk;fj++){if(fm[fj]===fl){return fj}}}return -1};var fe=function(fk,fm){var fl=[];if(ff(fk)!=="array"){fk=[fk]}if(ff(fm)!=="array"){fm=[fm]}for(var fj in fk){if(fh(fk[fj],fm)===-1){fl.push(fk[fj])}}return fl.length?fl:false};var fi=function(fl,fk){var fj=[];fd(fl,function(fm){if(fh(fm,fk)!==-1){fj.push(fm)}});return fj.length?fj:null};var fa=function(fl){var fk,fj=[];for(fk=0;fk<fl.length;fk++){fj[fk]=fl[fk]}return fj};var fc=(function(){var fj=0;return function(fm){var fk=new Date().getTime().toString(32),fl;for(fl=0;fl<5;fl++){fk+=Math.floor(Math.random()*65535).toString(32)}return(fm||"o_")+fk+(fj++).toString(32)}}());var e7=function(fj){if(!fj){return fj}return String.prototype.trim?String.prototype.trim.call(fj):fj.toString().replace(/^\s*/,"").replace(/\s*$/,"")};var e8=function(fj){if(typeof(fj)!=="string"){return fj}var fl={t:1099511627776,g:1073741824,m:1048576,k:1024},fk;fj=/^([0-9]+)([mgk]?)$/.exec(fj.toLowerCase().replace(/[^0-9mkg]/g,""));fk=fj[2];fj=+fj[1];if(fl.hasOwnProperty(fk)){fj*=fl[fk]}return fj};return{guid:fc,typeOf:ff,extend:fb,each:fd,isEmptyObj:fg,inSeries:e9,inArray:fh,arrayDiff:fe,arrayIntersect:fi,toArray:fa,trim:e7,parseSizeStr:e8}});e6("moxie/core/I18n",["moxie/core/utils/Basic"],function(e8){var e7={};return{addI18n:function(e9){return e8.extend(e7,e9)},translate:function(e9){return e7[e9]||e9},_:function(e9){return this.translate(e9)},sprintf:function(fb){var fa=[].slice.call(arguments,1),e9="";e8.each(fb.split(/%[a-z]/),function(fc){e9+=fc;if(fa.length){e9+=fa.shift()}});return e9}}});e6("moxie/core/utils/Mime",["moxie/core/utils/Basic","moxie/core/I18n"],function(fa,e9){var e7="application/msword,doc dot,application/pdf,pdf,application/pgp-signature,pgp,application/postscript,ps ai eps,application/rtf,rtf,application/vnd.ms-excel,xls xlb,application/vnd.ms-powerpoint,ppt pps pot,application/zip,zip,application/x-shockwave-flash,swf swfl,application/vnd.openxmlformats-officedocument.wordprocessingml.document,docx,application/vnd.openxmlformats-officedocument.wordprocessingml.template,dotx,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,xlsx,application/vnd.openxmlformats-officedocument.presentationml.presentation,pptx,application/vnd.openxmlformats-officedocument.presentationml.template,potx,application/vnd.openxmlformats-officedocument.presentationml.slideshow,ppsx,application/x-javascript,js,application/json,json,audio/mpeg,mp3 mpga mpega mp2,audio/x-wav,wav,audio/mp4,m4a,audio/ogg,oga ogg,audio/aiff,aiff aif,audio/flac,flac,audio/aac,aac,audio/ac3,ac3,audio/x-ms-wma,wma,image/bmp,bmp,image/gif,gif,image/jpeg,jpg jpeg jpe,image/photoshop,psd,image/png,png,image/svg+xml,svg svgz,image/tiff,tiff tif,text/plain,asc txt text diff log,text/html,htm html xhtml,text/css,css,text/csv,csv,text/rtf,rtf,video/mpeg,mpeg mpg mpe m2v,video/quicktime,qt mov,video/mp4,mp4,video/x-m4v,m4v,video/x-flv,flv,video/x-ms-wmv,wmv,video/avi,avi,video/webm,webm,video/3gpp,3gpp 3gp,video/3gpp2,3g2,video/vnd.rn-realvideo,rv,video/ogg,ogv,video/x-matroska,mkv,application/vnd.oasis.opendocument.formula-template,otf,application/octet-stream,exe";var e8={mimes:{},extensions:{},addMimeType:function(fb){var fc=fb.split(/,/),fd,ff,fe;for(fd=0;fd<fc.length;fd+=2){fe=fc[fd+1].split(/ /);for(ff=0;ff<fe.length;ff++){this.mimes[fe[ff]]=fc[fd]}this.extensions[fc[fd]]=fe}},extList2mimes:function(fh,fi){var fc=this,fg,fd,ff,fe,fb=[];for(fd=0;fd<fh.length;fd++){fg=fh[fd].extensions.split(/\s*,\s*/);for(ff=0;ff<fg.length;ff++){if(fg[ff]==="*"){return[]}fe=fc.mimes[fg[ff]];if(!fe){if(fi&&/^\w+$/.test(fg[ff])){fb.push("."+fg[ff])}else{return[]}}else{if(fa.inArray(fe,fb)===-1){fb.push(fe)}}}}return fb},mimes2exts:function(fb){var fc=this,fd=[];fa.each(fb,function(ff){if(ff==="*"){fd=[];return false}var fe=ff.match(/^(\w+)\/(\*|\w+)$/);if(fe){if(fe[2]==="*"){fa.each(fc.extensions,function(fg,fh){if((new RegExp("^"+fe[1]+"/")).test(fh)){[].push.apply(fd,fc.extensions[fh])}})}else{if(fc.extensions[ff]){[].push.apply(fd,fc.extensions[ff])}}}});return fd},mimes2extList:function(fb){var fd=[],fc=[];if(fa.typeOf(fb)==="string"){fb=fa.trim(fb).split(/\s*,\s*/)}fc=this.mimes2exts(fb);fd.push({title:e9.translate("Files"),extensions:fc.length?fc.join(","):"*"});fd.mimes=fb;return fd},getFileExtension:function(fc){var fb=fc&&fc.match(/\.([^.]+)$/);if(fb){return fb[1].toLowerCase()}return""},getFileMime:function(fb){return this.mimes[this.getFileExtension(fb)]||""}};e8.addMimeType(e7);return e8});e6("moxie/core/utils/Env",["moxie/core/utils/Basic"],function(fd){var e9=[{s1:navigator.userAgent,s2:"Android",id:"Android Browser",sv:"Version"},{s1:navigator.userAgent,s2:"Chrome",id:"Chrome"},{s1:navigator.vendor,s2:"Apple",id:"Safari",sv:"Version"},{prop:window.opera&&window.opera.buildNumber,id:"Opera",sv:"Version"},{s1:navigator.vendor,s2:"KDE",id:"Konqueror"},{s1:navigator.userAgent,s2:"Firefox",id:"Firefox"},{s1:navigator.vendor,s2:"Camino",id:"Camino"},{s1:navigator.userAgent,s2:"Netscape",id:"Netscape"},{s1:navigator.userAgent,s2:"MSIE",id:"IE",sv:"MSIE"},{s1:navigator.userAgent,s2:"Trident",id:"IE",sv:"rv"},{s1:navigator.userAgent,s2:"Gecko",id:"Mozilla",sv:"rv"}],fb=[{s1:navigator.platform,s2:"Win",id:"Windows"},{s1:navigator.platform,s2:"Mac",id:"Mac"},{s1:navigator.userAgent,s2:"iPhone",id:"iOS"},{s1:navigator.userAgent,s2:"iPad",id:"iOS"},{s1:navigator.userAgent,s2:"Android",id:"Android"},{s1:navigator.platform,s2:"Linux",id:"Linux"}],e8;function fc(fg){var fh,fi;for(var ff=0;ff<fg.length;ff++){fh=fg[ff].s1;fi=fg[ff].prop;e8=fg[ff].sv||fg[ff].id;if(fh){if(fh.indexOf(fg[ff].s2)!=-1){return fg[ff].id}}else{if(fi){return fg[ff].id}}}}function fe(fg){var ff=fg.indexOf(e8);if(ff==-1){return}return parseFloat(fg.substring(ff+e8.length+1))}var fa=(function(){var ff={define_property:(function(){return false}()),create_canvas:(function(){var fg=document.createElement("canvas");return !!(fg.getContext&&fg.getContext("2d"))}()),return_response_type:function(fg){try{if(fd.inArray(fg,["","text","document"])!==-1){return true}else{if(window.XMLHttpRequest){var fi=new XMLHttpRequest();fi.open("get","/");if("responseType" in fi){fi.responseType=fg;if(fi.responseType!==fg){return false}return true}}}}catch(fh){}return false},use_data_uri:(function(){var fg=new Image();fg.onload=function(){ff.use_data_uri=(fg.width===1&&fg.height===1)};setTimeout(function(){fg.src="data:image/gif;base64,R0lGODlhAQABAIAAAP8AAAAAACH5BAAAAAAALAAAAAABAAEAAAICRAEAOw=="},1);return false}()),use_data_uri_over32kb:function(){return ff.use_data_uri&&(e7.browser!=="IE"||e7.version>=9)},use_data_uri_of:function(fg){return(ff.use_data_uri&&fg<33000||ff.use_data_uri_over32kb())},use_fileinput:function(){var fg=document.createElement("input");fg.setAttribute("type","file");return !fg.disabled}};return function(fh){var fg=[].slice.call(arguments);fg.shift();return fd.typeOf(ff[fh])==="function"?ff[fh].apply(this,fg):!!ff[fh]}}());var e7={can:fa,browser:fc(e9),version:fe(navigator.userAgent)||fe(navigator.appVersion),OS:fc(fb),swf_url:"../flash/Moxie.swf",xap_url:"../silverlight/Moxie.xap",global_event_dispatcher:"moxie.core.EventTarget.instance.dispatchEvent"};return e7});e6("moxie/core/utils/Dom",["moxie/core/utils/Env"],function(e8){var e9=function(ff){if(typeof ff!=="string"){return ff}return document.getElementById(ff)};var fa=function(fh,fg){var ff;if(fh.className===""){return false}ff=new RegExp("(^|\\s+)"+fg+"(\\s+|$)");return ff.test(fh.className)};var fb=function(fg,ff){if(!fa(fg,ff)){fg.className=fg.className===""?ff:fg.className.replace(/\s+$/,"")+" "+ff}};var fe=function(fh,fg){var ff=new RegExp("(^|\\s+)"+fg+"(\\s+|$)");fh.className=fh.className.replace(ff,function(fj,fi,fk){return fi===" "&&fk===" "?" ":""})};var e7=function(fg,ff){if(fg.currentStyle){return fg.currentStyle[ff]}else{if(window.getComputedStyle){return window.getComputedStyle(fg,null)[ff]}}};var fd=function(fg,fk){var fl=0,fj=0,fn,fm=document,fh,fi;fg=fg;fk=fk||fm.body;function ff(fr){var fp,fq,fo=0,fs=0;if(fr){fq=fr.getBoundingClientRect();fp=fm.compatMode==="CSS1Compat"?fm.documentElement:fm.body;fo=fq.left+fp.scrollLeft;fs=fq.top+fp.scrollTop}return{x:fo,y:fs}}if(fg&&fg.getBoundingClientRect&&e8.browser==="IE"&&(!fm.documentMode||fm.documentMode<8)){fh=ff(fg);fi=ff(fk);return{x:fh.x-fi.x,y:fh.y-fi.y}}fn=fg;while(fn&&fn!=fk&&fn.nodeType){fl+=fn.offsetLeft||0;fj+=fn.offsetTop||0;fn=fn.offsetParent}fn=fg.parentNode;while(fn&&fn!=fk&&fn.nodeType){fl-=fn.scrollLeft||0;fj-=fn.scrollTop||0;fn=fn.parentNode}return{x:fl,y:fj}};var fc=function(ff){return{w:ff.offsetWidth||ff.clientWidth,h:ff.offsetHeight||ff.clientHeight}};return{get:e9,hasClass:fa,addClass:fb,removeClass:fe,getStyle:e7,getPos:fd,getSize:fc}});e6("moxie/core/Exceptions",["moxie/core/utils/Basic"],function(e8){function e7(fb,fa){var e9;for(e9 in fb){if(fb[e9]===fa){return e9}}return null}return{RuntimeError:(function(){var e9={NOT_INIT_ERR:1,NOT_SUPPORTED_ERR:9,JS_ERR:4};function fa(fb){this.code=fb;this.name=e7(e9,fb);this.message=this.name+": RuntimeError "+this.code}e8.extend(fa,e9);fa.prototype=Error.prototype;return fa}()),OperationNotAllowedException:(function(){function e9(fa){this.code=fa;this.name="OperationNotAllowedException"}e8.extend(e9,{NOT_ALLOWED_ERR:1});e9.prototype=Error.prototype;return e9}()),ImageError:(function(){var e9={WRONG_FORMAT:1,MAX_RESOLUTION_ERR:2};function fa(fb){this.code=fb;this.name=e7(e9,fb);this.message=this.name+": ImageError "+this.code}e8.extend(fa,e9);fa.prototype=Error.prototype;return fa}()),FileException:(function(){var e9={NOT_FOUND_ERR:1,SECURITY_ERR:2,ABORT_ERR:3,NOT_READABLE_ERR:4,ENCODING_ERR:5,NO_MODIFICATION_ALLOWED_ERR:6,INVALID_STATE_ERR:7,SYNTAX_ERR:8};function fa(fb){this.code=fb;this.name=e7(e9,fb);this.message=this.name+": FileException "+this.code}e8.extend(fa,e9);fa.prototype=Error.prototype;return fa}()),DOMException:(function(){var e9={INDEX_SIZE_ERR:1,DOMSTRING_SIZE_ERR:2,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,INVALID_CHARACTER_ERR:5,NO_DATA_ALLOWED_ERR:6,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INUSE_ATTRIBUTE_ERR:10,INVALID_STATE_ERR:11,SYNTAX_ERR:12,INVALID_MODIFICATION_ERR:13,NAMESPACE_ERR:14,INVALID_ACCESS_ERR:15,VALIDATION_ERR:16,TYPE_MISMATCH_ERR:17,SECURITY_ERR:18,NETWORK_ERR:19,ABORT_ERR:20,URL_MISMATCH_ERR:21,QUOTA_EXCEEDED_ERR:22,TIMEOUT_ERR:23,INVALID_NODE_TYPE_ERR:24,DATA_CLONE_ERR:25};function fa(fb){this.code=fb;this.name=e7(e9,fb);this.message=this.name+": DOMException "+this.code}e8.extend(fa,e9);fa.prototype=Error.prototype;return fa}()),EventException:(function(){function e9(fa){this.code=fa;this.name="EventException"}e8.extend(e9,{UNSPECIFIED_EVENT_TYPE_ERR:0});e9.prototype=Error.prototype;return e9}())}});e6("moxie/core/EventTarget",["moxie/core/Exceptions","moxie/core/utils/Basic"],function(e7,e8){function e9(){var fa={};e8.extend(this,{uid:null,init:function(){if(!this.uid){this.uid=e8.guid("uid_")}},addEventListener:function(ff,fe,fc,fd){var fb=this,fg;ff=e8.trim(ff);if(/\s/.test(ff)){e8.each(ff.split(/\s+/),function(fh){fb.addEventListener(fh,fe,fc,fd)});return}ff=ff.toLowerCase();fc=parseInt(fc,10)||0;fg=fa[this.uid]&&fa[this.uid][ff]||[];fg.push({fn:fe,priority:fc,scope:fd||this});if(!fa[this.uid]){fa[this.uid]={}}fa[this.uid][ff]=fg},hasEventListener:function(fb){return fb?!!(fa[this.uid]&&fa[this.uid][fb]):!!fa[this.uid]},removeEventListener:function(fd,fc){fd=fd.toLowerCase();var fe=fa[this.uid]&&fa[this.uid][fd],fb;if(fe){if(fc){for(fb=fe.length-1;fb>=0;fb--){if(fe[fb].fn===fc){fe.splice(fb,1);break}}}else{fe=[]}if(!fe.length){delete fa[this.uid][fd];if(e8.isEmptyObj(fa[this.uid])){delete fa[this.uid]}}}},removeAllEventListeners:function(){if(fa[this.uid]){delete fa[this.uid]}},dispatchEvent:function(fh){var fg,fi,ff,fe,fd={},fc=true;if(e8.typeOf(fh)!=="string"){fe=fh;if(e8.typeOf(fe.type)==="string"){fh=fe.type;if(fe.total&&fe.loaded){fd.total=fe.total;fd.loaded=fe.loaded}fd.async=fe.async||false}else{throw new e7.EventException(e7.EventException.UNSPECIFIED_EVENT_TYPE_ERR)}}if(fh.indexOf("::")!==-1){(function(fj){fg=fj[0];fh=fj[1]}(fh.split("::")))}else{fg=this.uid}fh=fh.toLowerCase();fi=fa[fg]&&fa[fg][fh];if(fi){fi.sort(function(fk,fj){return fj.priority-fk.priority});ff=[].slice.call(arguments);ff.shift();fd.type=fh;ff.unshift(fd);var fb=[];e8.each(fi,function(fj){ff[0].target=fj.scope;if(fd.async){fb.push(function(fk){setTimeout(function(){fk(fj.fn.apply(fj.scope,ff)===false)},1)})}else{fb.push(function(fk){fk(fj.fn.apply(fj.scope,ff)===false)})}});if(fb.length){e8.inSeries(fb,function(fj){fc=!fj})}}return fc},bind:function(){this.addEventListener.apply(this,arguments)},unbind:function(){this.removeEventListener.apply(this,arguments)},unbindAll:function(){this.removeAllEventListeners.apply(this,arguments)},trigger:function(){return this.dispatchEvent.apply(this,arguments)},convertEventPropsToHandlers:function(fb){var fd;if(e8.typeOf(fb)!=="array"){fb=[fb]}for(var fc=0;fc<fb.length;fc++){fd="on"+fb[fc];if(e8.typeOf(this[fd])==="function"){this.addEventListener(fb[fc],this[fd])}else{if(e8.typeOf(this[fd])==="undefined"){this[fd]=null}}}}})}e9.instance=new e9();return e9});e6("moxie/core/utils/Encode",[],function(){var e9=function(fb){return unescape(encodeURIComponent(fb))};var fa=function(fb){return decodeURIComponent(escape(fb))};var e8=function(fi,fn){if(typeof(window.atob)==="function"){return fn?fa(window.atob(fi)):window.atob(fi)}var fe="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var fd,fc,fb,fm,fl,fk,fj,fo,fh=0,fp=0,ff="",fg=[];if(!fi){return fi}fi+="";do{fm=fe.indexOf(fi.charAt(fh++));fl=fe.indexOf(fi.charAt(fh++));fk=fe.indexOf(fi.charAt(fh++));fj=fe.indexOf(fi.charAt(fh++));fo=fm<<18|fl<<12|fk<<6|fj;fd=fo>>16&255;fc=fo>>8&255;fb=fo&255;if(fk==64){fg[fp++]=String.fromCharCode(fd)}else{if(fj==64){fg[fp++]=String.fromCharCode(fd,fc)}else{fg[fp++]=String.fromCharCode(fd,fc,fb)}}}while(fh<fi.length);ff=fg.join("");return fn?fa(ff):ff};var e7=function(fj,fo){if(fo){e9(fj)}if(typeof(window.btoa)==="function"){return window.btoa(fj)}var ff="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var fe,fd,fc,fn,fm,fl,fk,fp,fi=0,fq=0,fh="",fg=[];if(!fj){return fj}do{fe=fj.charCodeAt(fi++);fd=fj.charCodeAt(fi++);fc=fj.charCodeAt(fi++);fp=fe<<16|fd<<8|fc;fn=fp>>18&63;fm=fp>>12&63;fl=fp>>6&63;fk=fp&63;fg[fq++]=ff.charAt(fn)+ff.charAt(fm)+ff.charAt(fl)+ff.charAt(fk)}while(fi<fj.length);fh=fg.join("");var fb=fj.length%3;return(fb?fh.slice(0,fb-3):fh)+"===".slice(fb||3)};return{utf8_encode:e9,utf8_decode:fa,atob:e8,btoa:e7}});e6("moxie/runtime/Runtime",["moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/EventTarget"],function(fb,fa,fc){var e7={},e8={};function e9(fl,fi,fg,fe,fh){var fk=this,fd,fj=fb.guid(fi+"_");function ff(fm,fn){var fp=null,fo=fl&&fl.required_caps;fn=fn||"browser";if(this.mode!==null){return this.mode}if(fo&&!fb.isEmptyObj(fm)){fb.each(fo,function(fs,fq){if(fm.hasOwnProperty(fq)){var fr=fm[fq](fs);if(typeof(fr)==="string"){fr=[fr]}if(!fp){fp=fr}else{if(!(fp=fb.arrayIntersect(fp,fr))){return(fp=false)}}}});if(fp){this.mode=fb.inArray(fn,fp)!==-1?fn:fp[0]}else{if(fp===false){this.mode=false}}}if(this.mode===null){this.mode=fn}if(this.mode&&fo&&!this.can(fo)){this.mode=false}}e8[fj]=this;fg=fb.extend({access_binary:false,access_image_binary:false,display_media:false,do_cors:false,drag_and_drop:false,filter_by_extension:true,resize_image:false,report_upload_progress:false,return_response_headers:false,return_response_type:false,return_status_code:true,send_custom_headers:false,select_file:false,select_folder:false,select_multiple:true,send_binary_string:false,send_browser_cookies:true,send_multipart:true,slice_blob:false,stream_upload:false,summon_file_dialog:false,upload_filesize:true,use_http_method:true},fg);fd=(function(){var fm={};return{exec:function(fq,fo,fr,fp){if(fd[fo]){if(!fm[fq]){fm[fq]={context:this,instance:new fd[fo]()}}if(fm[fq].instance[fr]){return fm[fq].instance[fr].apply(this,fp)}}},removeInstance:function(fn){delete fm[fn]},removeAllInstances:function(){var fn=this;fb.each(fm,function(fp,fo){if(fb.typeOf(fp.instance.destroy)==="function"){fp.instance.destroy.call(fp.context)}fn.removeInstance(fo)})}}}());fb.extend(this,{initialized:false,uid:fj,type:fi,mode:null,shimid:fj+"_container",clients:0,options:fl,can:function(fo,fp){var fm=arguments[2]||fg;if(fb.typeOf(fo)==="string"&&fb.typeOf(fp)==="undefined"){fo=e9.parseCaps(fo)}if(fb.typeOf(fo)==="object"){for(var fn in fo){if(!this.can(fn,fo[fn],fm)){return false}}return true}if(fb.typeOf(fm[fo])==="function"){return fm[fo].call(this,fp)}else{return(fp===fm[fo])}},getShimContainer:function(){var fm,fn=fa.get(this.shimid);if(!fn){fm=this.options.container?fa.get(this.options.container):document.body;fn=document.createElement("div");fn.id=this.shimid;fn.className="moxie-shim moxie-shim-"+this.type;fb.extend(fn.style,{position:"absolute",top:"0px",left:"0px",width:"1px",height:"1px",overflow:"hidden"});fm.appendChild(fn);fm=null}return fn},getShim:function(){return fd},shimExec:function(fn,fo){var fm=[].slice.call(arguments,2);return fk.getShim().exec.call(this,this.uid,fn,fo,fm)},exec:function(fn,fo){var fm=[].slice.call(arguments,2);if(fk[fn]&&fk[fn][fo]){return fk[fn][fo].apply(this,fm)}return fk.shimExec.apply(this,arguments)},destroy:function(){if(!fk){return}var fm=fa.get(this.shimid);if(fm){fm.parentNode.removeChild(fm)}if(fd){fd.removeAllInstances()}this.unbindAll();delete e8[this.uid];this.uid=null;fj=fk=fd=fm=null}});ff.call(this,fe,fh)}e9.order="html5,flash,silverlight,html4";e9.getRuntime=function(fd){return e8[fd]?e8[fd]:false};e9.addConstructor=function(fe,fd){fd.prototype=fc.instance;e7[fe]=fd};e9.getConstructor=function(fd){return e7[fd]||null};e9.getInfo=function(fd){var fe=e9.getRuntime(fd);if(fe){return{uid:fe.uid,type:fe.type,can:function(){return fe.can.apply(fe,arguments)}}}return null};e9.parseCaps=function(fd){var fe={};if(fb.typeOf(fd)!=="string"){return fd||{}}fb.each(fd.split(","),function(ff){fe[ff]=true});return fe};e9.can=function(fe,fg){var ff,fd=e9.getConstructor(fe),fh;if(fd){ff=new fd({required_caps:fg});fh=ff.mode;ff.destroy();return !!fh}return false};e9.thatCan=function(ff,fg){var fe=(fg||e9.order).split(/\s*,\s*/);for(var fd in fe){if(e9.can(fe[fd],ff)){return fe[fd]}}return null};e9.capTrue=function(){return true};e9.capFalse=function(){return false};e9.capTest=function(fd){return function(){return !!fd}};return e9});e6("moxie/runtime/RuntimeClient",["moxie/core/Exceptions","moxie/core/utils/Basic","moxie/runtime/Runtime"],function(e7,fa,e9){return function e8(){var fb;fa.extend(this,{connectRuntime:function(ff){var fd=this,fe;function fc(fg){var fi,fh;if(!fg.length){fd.trigger("RuntimeError",new e7.RuntimeError(e7.RuntimeError.NOT_INIT_ERR));fb=null;return}fi=fg.shift();fh=e9.getConstructor(fi);if(!fh){fc(fg);return}fb=new fh(ff);fb.bind("Init",function(){fb.initialized=true;setTimeout(function(){fb.clients++;fd.trigger("RuntimeInit",fb)},1)});fb.bind("Error",function(){fb.destroy();fc(fg)});if(!fb.mode){fb.trigger("Error");return}fb.init()}if(fa.typeOf(ff)==="string"){fe=ff}else{if(fa.typeOf(ff.ruid)==="string"){fe=ff.ruid}}if(fe){fb=e9.getRuntime(fe);if(fb){fb.clients++;return fb}else{throw new e7.RuntimeError(e7.RuntimeError.NOT_INIT_ERR)}}fc((ff.runtime_order||e9.order).split(/\s*,\s*/))},getRuntime:function(){if(fb&&fb.uid){return fb}fb=null;return null},disconnectRuntime:function(){if(fb&&--fb.clients<=0){fb.destroy();fb=null}}})}});e6("moxie/file/Blob",["moxie/core/utils/Basic","moxie/core/utils/Encode","moxie/runtime/RuntimeClient"],function(fa,e8,e9){var e7={};function fb(fe,fd){function fc(fj,ff,fh){var fg,fi=e7[this.uid];if(fa.typeOf(fi)!=="string"||!fi.length){return null}fg=new fb(null,{type:fh,size:ff-fj});fg.detach(fi.substr(fj,fg.size));return fg}e9.call(this);if(fe){this.connectRuntime(fe)}if(!fd){fd={}}else{if(fa.typeOf(fd)==="string"){fd={data:fd}}}fa.extend(this,{uid:fd.uid||fa.guid("uid_"),ruid:fe,size:fd.size||0,type:fd.type||"",slice:function(fh,ff,fg){if(this.isDetached()){return fc.apply(this,arguments)}return this.getRuntime().exec.call(this,"Blob","slice",this.getSource(),fh,ff,fg)},getSource:function(){if(!e7[this.uid]){return null}return e7[this.uid]},detach:function(fg){if(this.ruid){this.getRuntime().exec.call(this,"Blob","destroy",e7[this.uid]);this.disconnectRuntime();this.ruid=null}fg=fg||"";var ff=fg.match(/^data:([^;]*);base64,/);if(ff){this.type=ff[1];fg=e8.atob(fg.substring(fg.indexOf("base64,")+7))}this.size=fg.length;e7[this.uid]=fg},isDetached:function(){return !this.ruid&&fa.typeOf(e7[this.uid])==="string"},destroy:function(){this.detach();delete e7[this.uid]}});if(fd.data){this.detach(fd.data)}else{e7[this.uid]=fd}}return fb});e6("moxie/file/File",["moxie/core/utils/Basic","moxie/core/utils/Mime","moxie/file/Blob"],function(e9,e8,fa){function e7(fc,fd){var fb,fe;if(!fd){fd={}}if(fd.type&&fd.type!==""){fe=fd.type}else{fe=e8.getFileMime(fd.name)}if(fd.name){fb=fd.name.replace(/\\/g,"/");fb=fb.substr(fb.lastIndexOf("/")+1)}else{var ff=fe.split("/")[0];fb=e9.guid((ff!==""?ff:"file")+"_");if(e8.extensions[fe]){fb+="."+e8.extensions[fe][0]}}fa.apply(this,arguments);e9.extend(this,{type:fe||"",name:fb||e9.guid("file_"),lastModifiedDate:fd.lastModifiedDate||(new Date()).toLocaleString()})}e7.prototype=fa.prototype;return e7});e6("moxie/file/FileInput",["moxie/core/utils/Basic","moxie/core/utils/Mime","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/core/EventTarget","moxie/core/I18n","moxie/file/File","moxie/runtime/Runtime","moxie/runtime/RuntimeClient"],function(e8,fb,fa,ff,fh,e9,fd,e7,fe){var fg=["ready","change","cancel","mouseenter","mouseleave","mousedown","mouseup"];function fc(fl){var fj=this,fi,fk,fm;if(e8.inArray(e8.typeOf(fl),["string","node"])!==-1){fl={browse_button:fl}}fk=fa.get(fl.browse_button);if(!fk){throw new ff.DOMException(ff.DOMException.NOT_FOUND_ERR)}fm={accept:[{title:e9.translate("All Files"),extensions:"*"}],name:"file",multiple:false,required_caps:false,container:fk.parentNode||document.body};fl=e8.extend({},fm,fl);if(typeof(fl.required_caps)==="string"){fl.required_caps=e7.parseCaps(fl.required_caps)}if(typeof(fl.accept)==="string"){fl.accept=fb.mimes2extList(fl.accept)}fi=fa.get(fl.container);if(!fi){fi=document.body}if(fa.getStyle(fi,"position")==="static"){fi.style.position="relative"}fi=fk=null;fe.call(fj);e8.extend(fj,{uid:e8.guid("uid_"),ruid:null,files:null,init:function(){fj.convertEventPropsToHandlers(fg);fj.bind("RuntimeInit",function(fo,fn){fj.ruid=fn.uid;fj.bind("Ready",function(){fj.trigger("Refresh")},999);fj.bind("Change",function(){var fp=fn.exec.call(fj,"FileInput","getFiles");fj.files=[];e8.each(fp,function(fq){if(fq.size===0){return true}fj.files.push(new fd(fj.ruid,fq))})},999);fj.bind("Refresh",function(){var fs,fr,fq,fp;fq=fa.get(fl.browse_button);fp=fa.get(fn.shimid);if(fq){fs=fa.getPos(fq,fa.get(fl.container));fr=fa.getSize(fq);if(fp){e8.extend(fp.style,{top:fs.y+"px",left:fs.x+"px",width:fr.w+"px",height:fr.h+"px"})}}fp=fq=null});fn.exec.call(fj,"FileInput","init",fl)});fj.connectRuntime(e8.extend({},fl,{required_caps:{select_file:true}}))},disable:function(fo){var fn=this.getRuntime();if(fn){fn.exec.call(this,"FileInput","disable",e8.typeOf(fo)==="undefined"?true:fo)}},refresh:function(){fj.trigger("Refresh")},destroy:function(){var fn=this.getRuntime();if(fn){fn.exec.call(this,"FileInput","destroy");this.disconnectRuntime()}if(e8.typeOf(this.files)==="array"){e8.each(this.files,function(fo){fo.destroy()})}this.files=null}})}fc.prototype=fh.instance;return fc});e6("moxie/file/FileDrop",["moxie/core/I18n","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/core/utils/Basic","moxie/file/File","moxie/runtime/RuntimeClient","moxie/core/EventTarget","moxie/core/utils/Mime"],function(e9,fa,fe,e7,fc,fd,fg,fb){var ff=["ready","dragenter","dragleave","drop","error"];function e8(fi){var fh=this,fj;if(typeof(fi)==="string"){fi={drop_zone:fi}}fj={accept:[{title:e9.translate("All Files"),extensions:"*"}],required_caps:{drag_and_drop:true}};fi=typeof(fi)==="object"?e7.extend({},fj,fi):fj;fi.container=fa.get(fi.drop_zone)||document.body;if(fa.getStyle(fi.container,"position")==="static"){fi.container.style.position="relative"}if(typeof(fi.accept)==="string"){fi.accept=fb.mimes2extList(fi.accept)}fd.call(fh);e7.extend(fh,{uid:e7.guid("uid_"),ruid:null,files:null,init:function(){fh.convertEventPropsToHandlers(ff);fh.bind("RuntimeInit",function(fl,fk){fh.ruid=fk.uid;fh.bind("Drop",function(){var fm=fk.exec.call(fh,"FileDrop","getFiles");fh.files=[];e7.each(fm,function(fn){fh.files.push(new fc(fh.ruid,fn))})},999);fk.exec.call(fh,"FileDrop","init",fi);fh.dispatchEvent("ready")});fh.connectRuntime(fi)},destroy:function(){var fk=this.getRuntime();if(fk){fk.exec.call(this,"FileDrop","destroy");this.disconnectRuntime()}this.files=null}})}e8.prototype=fg.instance;return e8});e6("moxie/runtime/RuntimeTarget",["moxie/core/utils/Basic","moxie/runtime/RuntimeClient","moxie/core/EventTarget"],function(e9,e8,fa){function e7(){this.uid=e9.guid("uid_");e8.call(this);this.destroy=function(){this.disconnectRuntime();this.unbindAll()}}e7.prototype=fa.instance;return e7});e6("moxie/file/FileReader",["moxie/core/utils/Basic","moxie/core/utils/Encode","moxie/core/Exceptions","moxie/core/EventTarget","moxie/file/Blob","moxie/file/File","moxie/runtime/RuntimeTarget"],function(e7,fb,fd,ff,fa,fc,e9){var fe=["loadstart","progress","load","abort","error","loadend"];function e8(){var fg=this,fi;e7.extend(this,{uid:e7.guid("uid_"),readyState:e8.EMPTY,result:null,error:null,readAsBinaryString:function(fj){fh.call(this,"readAsBinaryString",fj)},readAsDataURL:function(fj){fh.call(this,"readAsDataURL",fj)},readAsText:function(fj){fh.call(this,"readAsText",fj)},abort:function(){this.result=null;if(e7.inArray(this.readyState,[e8.EMPTY,e8.DONE])!==-1){return}else{if(this.readyState===e8.LOADING){this.readyState=e8.DONE}}if(fi){fi.getRuntime().exec.call(this,"FileReader","abort")}this.trigger("abort");this.trigger("loadend")},destroy:function(){this.abort();if(fi){fi.getRuntime().exec.call(this,"FileReader","destroy");fi.disconnectRuntime()}fg=fi=null}});function fh(fo,fk){fi=new e9();function fm(fp){fg.readyState=e8.DONE;fg.error=fp;fg.trigger("error");fl()}function fl(){fi.destroy();fi=null;fg.trigger("loadend")}function fj(fp){fi.bind("Error",function(fr,fq){fm(fq)});fi.bind("Progress",function(fq){fg.result=fp.exec.call(fi,"FileReader","getResult");fg.trigger(fq)});fi.bind("Load",function(fq){fg.readyState=e8.DONE;fg.result=fp.exec.call(fi,"FileReader","getResult");fg.trigger(fq);fl()});fp.exec.call(fi,"FileReader","read",fo,fk)}this.convertEventPropsToHandlers(fe);if(this.readyState===e8.LOADING){return fm(new fd.DOMException(fd.DOMException.INVALID_STATE_ERR))}this.readyState=e8.LOADING;this.trigger("loadstart");if(fk instanceof fa){if(fk.isDetached()){var fn=fk.getSource();switch(fo){case"readAsText":case"readAsBinaryString":this.result=fn;break;case"readAsDataURL":this.result="data:"+fk.type+";base64,"+fb.btoa(fn);break}this.readyState=e8.DONE;this.trigger("load");fl()}else{fj(fi.connectRuntime(fk.ruid))}}else{fm(new fd.DOMException(fd.DOMException.NOT_FOUND_ERR))}}}e8.EMPTY=0;e8.LOADING=1;e8.DONE=2;e8.prototype=ff.instance;return e8});e6("moxie/core/utils/Url",[],function(){var e7=function(fg){var fc=["source","scheme","authority","userInfo","user","pass","host","port","relative","path","directory","file","query","fragment"],fb=fc.length,fh={http:80,https:443},fe={},fd=/^(?:([^:\/?#]+):)?(?:\/\/()(?:(?:()(?:([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?()(?:(()(?:(?:[^?#\/]*\/)*)()(?:[^?#]*))(?:\\?([^#]*))?(?:#(.*))?)/,fa=fd.exec(fg||"");while(fb--){if(fa[fb]){fe[fc[fb]]=fa[fb]}}if(/^[^\/]/.test(fe.path)&&!fe.scheme){var ff=document.location.pathname;if(!/(\/|\/[^\.]+)$/.test(ff)){ff=ff.replace(/[^\/]+$/,"")}fe.host=document.location.hostname;fe.path=ff+(fe.path||"")}if(!fe.scheme){fe.scheme=document.location.protocol.replace(/:$/,"")}if(!fe.host){fe.host=document.location.hostname}if(!fe.port){fe.port=document.location.port||fh[fe.scheme]||80}fe.port=parseInt(fe.port,10);if(!fe.path){fe.path="/"}delete fe.source;return fe};var e9=function(fb){var fc={http:80,https:443},fa=e7(fb);return fa.scheme+"://"+fa.host+(fa.port!==fc[fa.scheme]?":"+fa.port:"")+fa.path+(fa.query?fa.query:"")};var e8=function(fb){function fa(fc){return[fc.scheme,fc.host,fc.port].join("/")}if(typeof fb==="string"){fb=e7(fb)}return fa(e7())===fa(fb)};return{parseUrl:e7,resolveUrl:e9,hasSameOrigin:e8}});e6("moxie/file/FileReaderSync",["moxie/core/utils/Basic","moxie/runtime/RuntimeClient","moxie/core/utils/Encode"],function(e9,e8,e7){return function(){e8.call(this);e9.extend(this,{uid:e9.guid("uid_"),readAsBinaryString:function(fb){return fa.call(this,"readAsBinaryString",fb)},readAsDataURL:function(fb){return fa.call(this,"readAsDataURL",fb)},readAsText:function(fb){return fa.call(this,"readAsText",fb)}});function fa(fh,fd){if(fd.isDetached()){var fg=fd.getSource();switch(fh){case"readAsBinaryString":return fg;case"readAsDataURL":return"data:"+fd.type+";base64,"+e7.btoa(fg);case"readAsText":var fc="";for(var fe=0,ff=fg.length;fe<ff;fe++){fc+=String.fromCharCode(fg[fe])}return fc}}else{var fb=this.connectRuntime(fd.ruid).exec.call(this,"FileReaderSync","read",fh,fd);this.disconnectRuntime();return fb}}}});e6("moxie/xhr/FormData",["moxie/core/Exceptions","moxie/core/utils/Basic","moxie/file/Blob"],function(e7,e8,fa){function e9(){var fc,fd={},fb="";e8.extend(this,{append:function(ff,fg){var fe=this,fh=e8.typeOf(fg);if(fg instanceof fa){if(fc){delete fd[fc]}fc=ff;fd[ff]=[fg]}else{if("array"===fh){ff+="[]";e8.each(fg,function(fi){fe.append.call(fe,ff,fi)})}else{if("object"===fh){e8.each(fg,function(fj,fi){fe.append.call(fe,ff+"["+fi+"]",fj)})}else{fg=fg.toString();if(!fd[ff]){fd[ff]=[]}fd[ff].push(fg)}}}},hasBlob:function(){return !!fc},getBlob:function(){return fd[fc]&&fd[fc][0]||null},getBlobName:function(){return fc||null},each:function(fe){e8.each(fd,function(fg,ff){e8.each(fg,function(fh){fe(fh,ff)})})},destroy:function(){fc=null;fb="";fd={}}})}return e9});e6("moxie/xhr/XMLHttpRequest",["moxie/core/utils/Basic","moxie/core/Exceptions","moxie/core/EventTarget","moxie/core/utils/Encode","moxie/core/utils/Url","moxie/runtime/Runtime","moxie/runtime/RuntimeTarget","moxie/file/Blob","moxie/file/FileReaderSync","moxie/xhr/FormData","moxie/core/utils/Env","moxie/core/utils/Mime"],function(ff,fg,fe,fm,fj,fd,fh,fc,fl,fn,e7,fi){var e8={100:"Continue",101:"Switching Protocols",102:"Processing",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",207:"Multi-Status",226:"IM Used",300:"Multiple Choices",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",305:"Use Proxy",306:"Reserved",307:"Temporary Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Request Entity Too Large",414:"Request-URI Too Long",415:"Unsupported Media Type",416:"Requested Range Not Satisfiable",417:"Expectation Failed",422:"Unprocessable Entity",423:"Locked",424:"Failed Dependency",426:"Upgrade Required",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported",506:"Variant Also Negotiates",507:"Insufficient Storage",510:"Not Extended"};function fb(){this.uid=ff.guid("uid_")}fb.prototype=fe.instance;var fa=["loadstart","progress","abort","error","load","timeout","loadend"];var e9=1,fo=2;function fk(){var fG=this,ft={timeout:0,readyState:fk.UNSENT,withCredentials:false,status:0,statusText:"",responseType:"",responseXML:null,responseText:null,response:null},fM=true,fy,fE,fF={},fH,fv,fx=null,fz=null,fP=false,fq=false,fp=false,fA=false,fs=false,fw=false,fC,fL,fK=null,fN=null,fI={},fD,fJ="",fr;ff.extend(this,ft,{uid:ff.guid("uid_"),upload:new fb(),open:function(fV,fT,fU,fR,fS){var fQ;if(!fV||!fT){throw new fg.DOMException(fg.DOMException.SYNTAX_ERR)}if(/[\u0100-\uffff]/.test(fV)||fm.utf8_encode(fV)!==fV){throw new fg.DOMException(fg.DOMException.SYNTAX_ERR)}if(!!~ff.inArray(fV.toUpperCase(),["CONNECT","DELETE","GET","HEAD","OPTIONS","POST","PUT","TRACE","TRACK"])){fE=fV.toUpperCase()}if(!!~ff.inArray(fE,["CONNECT","TRACE","TRACK"])){throw new fg.DOMException(fg.DOMException.SECURITY_ERR)}fT=fm.utf8_encode(fT);fQ=fj.parseUrl(fT);fw=fj.hasSameOrigin(fQ);fy=fj.resolveUrl(fT);if((fR||fS)&&!fw){throw new fg.DOMException(fg.DOMException.INVALID_ACCESS_ERR)}fH=fR||fQ.user;fv=fS||fQ.pass;fM=fU||true;if(fM===false&&(fO("timeout")||fO("withCredentials")||fO("responseType")!=="")){throw new fg.DOMException(fg.DOMException.INVALID_ACCESS_ERR)}fP=!fM;fq=false;fF={};fB.call(this);fO("readyState",fk.OPENED);this.convertEventPropsToHandlers(["readystatechange"]);this.dispatchEvent("readystatechange")},setRequestHeader:function(fS,fR){var fQ=["accept-charset","accept-encoding","access-control-request-headers","access-control-request-method","connection","content-length","cookie","cookie2","content-transfer-encoding","date","expect","host","keep-alive","origin","referer","te","trailer","transfer-encoding","upgrade","user-agent","via"];if(fO("readyState")!==fk.OPENED||fq){throw new fg.DOMException(fg.DOMException.INVALID_STATE_ERR)}if(/[\u0100-\uffff]/.test(fS)||fm.utf8_encode(fS)!==fS){throw new fg.DOMException(fg.DOMException.SYNTAX_ERR)}fS=ff.trim(fS).toLowerCase();if(!!~ff.inArray(fS,fQ)||/^(proxy\-|sec\-)/.test(fS)){return false}if(!fF[fS]){fF[fS]=fR}else{fF[fS]+=", "+fR}return true},getAllResponseHeaders:function(){return fJ||""},getResponseHeader:function(fQ){fQ=fQ.toLowerCase();if(fs||!!~ff.inArray(fQ,["set-cookie","set-cookie2"])){return null}if(fJ&&fJ!==""){if(!fr){fr={};ff.each(fJ.split(/\r\n/),function(fR){var fS=fR.split(/:\s+/);if(fS.length===2){fS[0]=ff.trim(fS[0]);fr[fS[0].toLowerCase()]={header:fS[0],value:ff.trim(fS[1])}}})}if(fr.hasOwnProperty(fQ)){return fr[fQ].header+": "+fr[fQ].value}}return null},overrideMimeType:function(fR){var fQ,fS;if(!!~ff.inArray(fO("readyState"),[fk.LOADING,fk.DONE])){throw new fg.DOMException(fg.DOMException.INVALID_STATE_ERR)}fR=ff.trim(fR.toLowerCase());if(/;/.test(fR)&&(fQ=fR.match(/^([^;]+)(?:;\scharset\=)?(.*)$/))){fR=fQ[1];if(fQ[2]){fS=fQ[2]}}if(!fi.mimes[fR]){throw new fg.DOMException(fg.DOMException.SYNTAX_ERR)}fK=fR;fN=fS},send:function(fS,fR){if(ff.typeOf(fR)==="string"){fI={ruid:fR}}else{if(!fR){fI={}}else{fI=fR}}this.convertEventPropsToHandlers(fa);this.upload.convertEventPropsToHandlers(fa);if(this.readyState!==fk.OPENED||fq){throw new fg.DOMException(fg.DOMException.INVALID_STATE_ERR)}if(fS instanceof fc){fI.ruid=fS.ruid;fz=fS.type||"application/octet-stream"}else{if(fS instanceof fn){if(fS.hasBlob()){var fQ=fS.getBlob();fI.ruid=fQ.ruid;fz=fQ.type||"application/octet-stream"}}else{if(typeof fS==="string"){fx="UTF-8";fz="text/plain;charset=UTF-8";fS=fm.utf8_encode(fS)}}}if(!this.withCredentials){this.withCredentials=(fI.required_caps&&fI.required_caps.send_browser_cookies)&&!fw}fp=(!fP&&this.upload.hasEventListener());fs=false;fA=!fS;if(!fP){fq=true;if(!fA){}}fu.call(this,fS)},abort:function(){fs=true;fP=false;if(!~ff.inArray(fO("readyState"),[fk.UNSENT,fk.OPENED,fk.DONE])){fO("readyState",fk.DONE);fq=false;if(fD){fD.getRuntime().exec.call(fD,"XMLHttpRequest","abort",fA)}else{throw new fg.DOMException(fg.DOMException.INVALID_STATE_ERR)}fA=true}else{fO("readyState",fk.UNSENT)}},destroy:function(){if(fD){if(ff.typeOf(fD.destroy)==="function"){fD.destroy()}fD=null}this.unbindAll();if(this.upload){this.upload.unbindAll();this.upload=null}}});function fO(fR,fQ){if(!ft.hasOwnProperty(fR)){return}if(arguments.length===1){return e7.can("define_property")?ft[fR]:fG[fR]}else{if(e7.can("define_property")){ft[fR]=fQ}else{fG[fR]=fQ}}}function fu(fT){var fR=this;fC=new Date().getTime();fD=new fh();function fS(){fD.destroy();fD=null;fR.dispatchEvent("loadend");fR=null}function fQ(fU){fD.bind("LoadStart",function(fV){fO("readyState",fk.LOADING);fR.dispatchEvent("readystatechange");fR.dispatchEvent(fV);if(fp){fR.upload.dispatchEvent(fV)}});fD.bind("Progress",function(fV){if(fO("readyState")!==fk.LOADING){fO("readyState",fk.LOADING);fR.dispatchEvent("readystatechange")}fR.dispatchEvent(fV)});fD.bind("UploadProgress",function(fV){if(fp){fR.upload.dispatchEvent({type:"progress",lengthComputable:false,total:fV.total,loaded:fV.loaded})}});fD.bind("Load",function(fV){fO("readyState",fk.DONE);fO("status",Number(fU.exec.call(fD,"XMLHttpRequest","getStatus")||0));fO("statusText",e8[fO("status")]||"");fO("response",fU.exec.call(fD,"XMLHttpRequest","getResponse",fO("responseType")));if(!!~ff.inArray(fO("responseType"),["text",""])){fO("responseText",fO("response"))}else{if(fO("responseType")==="document"){fO("responseXML",fO("response"))}}fJ=fU.exec.call(fD,"XMLHttpRequest","getAllResponseHeaders");fR.dispatchEvent("readystatechange");if(fO("status")>0){if(fp){fR.upload.dispatchEvent(fV)}fR.dispatchEvent(fV)}else{fs=true;fR.dispatchEvent("error")}fS()});fD.bind("Abort",function(fV){fR.dispatchEvent(fV);fS()});fD.bind("Error",function(fV){fs=true;fO("readyState",fk.DONE);fR.dispatchEvent("readystatechange");fA=true;fR.dispatchEvent(fV);fS()});fU.exec.call(fD,"XMLHttpRequest","send",{url:fy,method:fE,async:fM,user:fH,password:fv,headers:fF,mimeType:fz,encoding:fx,responseType:fR.responseType,withCredentials:fR.withCredentials,options:fI},fT)}if(typeof(fI.required_caps)==="string"){fI.required_caps=fd.parseCaps(fI.required_caps)}fI.required_caps=ff.extend({},fI.required_caps,{return_response_type:fR.responseType});if(fT instanceof fn){fI.required_caps.send_multipart=true}if(!fw){fI.required_caps.do_cors=true}if(fI.ruid){fQ(fD.connectRuntime(fI))}else{fD.bind("RuntimeInit",function(fV,fU){fQ(fU)});fD.bind("RuntimeError",function(fV,fU){fR.dispatchEvent("RuntimeError",fU)});fD.connectRuntime(fI)}}function fB(){fO("responseText","");fO("responseXML",null);fO("response",null);fO("status",0);fO("statusText","");fC=fL=null}}fk.UNSENT=0;fk.OPENED=1;fk.HEADERS_RECEIVED=2;fk.LOADING=3;fk.DONE=4;fk.prototype=fe.instance;return fk});e6("moxie/runtime/Transporter",["moxie/core/utils/Basic","moxie/core/utils/Encode","moxie/runtime/RuntimeClient","moxie/core/EventTarget"],function(fa,e7,e8,fb){function e9(){var fg,fe,fc,fh,fk,fj;e8.call(this);fa.extend(this,{uid:fa.guid("uid_"),state:e9.IDLE,result:null,transport:function(fp,fo,fn){var fm=this;fn=fa.extend({chunk_size:204798},fn);if((fg=fn.chunk_size%3)){fn.chunk_size+=3-fg}fj=fn.chunk_size;fi.call(this);fc=fp;fh=fp.length;if(fa.typeOf(fn)==="string"||fn.ruid){ff.call(fm,fo,this.connectRuntime(fn))}else{var fl=function(fr,fq){fm.unbind("RuntimeInit",fl);ff.call(fm,fo,fq)};this.bind("RuntimeInit",fl);this.connectRuntime(fn)}},abort:function(){var fl=this;fl.state=e9.IDLE;if(fe){fe.exec.call(fl,"Transporter","clear");fl.trigger("TransportingAborted")}fi.call(fl)},destroy:function(){this.unbindAll();fe=null;this.disconnectRuntime();fi.call(this)}});function fi(){fh=fk=0;fc=this.result=null}function ff(fm,fn){var fl=this;fe=fn;fl.bind("TransportingProgress",function(fo){fk=fo.loaded;if(fk<fh&&fa.inArray(fl.state,[e9.IDLE,e9.DONE])===-1){fd.call(fl)}},999);fl.bind("TransportingComplete",function(){fk=fh;fl.state=e9.DONE;fc=null;fl.result=fe.exec.call(fl,"Transporter","getAsBlob",fm||"")},999);fl.state=e9.BUSY;fl.trigger("TransportingStarted");fd.call(fl)}function fd(){var fl=this,fm,fn=fh-fk;if(fj>fn){fj=fn}fm=e7.btoa(fc.substr(fk,fj));fe.exec.call(fl,"Transporter","receive",fm,fh)}}e9.IDLE=0;e9.BUSY=1;e9.DONE=2;e9.prototype=fb.instance;return e9});e6("moxie/core/JSON",[],function(){return !!window.JSON&&JSON.parse||(function(){var fa,e8,e7={'"':'"',"\\":"\\","/":"/",b:"\b",f:"\f",n:"\n",r:"\r",t:"\t"},fj,fh=function(fk){throw {name:"SyntaxError",message:fk,at:fa,text:fj}},fd=function(fk){if(fk&&fk!==e8){fh("Expected '"+fk+"' instead of '"+e8+"'")}e8=fj.charAt(fa);fa+=1;return e8},fc=function(){var fl,fk="";if(e8==="-"){fk="-";fd("-")}while(e8>="0"&&e8<="9"){fk+=e8;fd()}if(e8==="."){fk+=".";while(fd()&&e8>="0"&&e8<="9"){fk+=e8}}if(e8==="e"||e8==="E"){fk+=e8;fd();if(e8==="-"||e8==="+"){fk+=e8;fd()}while(e8>="0"&&e8<="9"){fk+=e8;fd()}}fl=+fk;if(!isFinite(fl)){fh("Bad number")}else{return fl}},fe=function(){var fn,fm,fl="",fk;if(e8==='"'){while(fd()){if(e8==='"'){fd();return fl}else{if(e8==="\\"){fd();if(e8==="u"){fk=0;for(fm=0;fm<4;fm+=1){fn=parseInt(fd(),16);if(!isFinite(fn)){break}fk=fk*16+fn}fl+=String.fromCharCode(fk)}else{if(typeof e7[e8]==="string"){fl+=e7[e8]}else{break}}}else{fl+=e8}}}}fh("Bad string")},fg=function(){while(e8&&e8<=" "){fd()}},e9=function(){switch(e8){case"t":fd("t");fd("r");fd("u");fd("e");return true;case"f":fd("f");fd("a");fd("l");fd("s");fd("e");return false;case"n":fd("n");fd("u");fd("l");fd("l");return null}fh("Unexpected '"+e8+"'")},fi,ff=function(){var fk=[];if(e8==="["){fd("[");fg();if(e8==="]"){fd("]");return fk}while(e8){fk.push(fi());fg();if(e8==="]"){fd("]");return fk}fd(",");fg()}}fh("Bad array")},fb=function(){var fl,fk={};if(e8==="{"){fd("{");fg();if(e8==="}"){fd("}");return fk}while(e8){fl=fe();fg();fd(":");if(Object.hasOwnProperty.call(fk,fl)){fh('Duplicate key "'+fl+'"')}fk[fl]=fi();fg();if(e8==="}"){fd("}");return fk}fd(",");fg()}}fh("Bad object")};fi=function(){fg();switch(e8){case"{":return fb();case"[":return ff();case'"':return fe();case"-":return fc();default:return e8>="0"&&e8<="9"?fc():e9()}};return function(fn,fl){var fk;fj=fn;fa=0;e8=" ";fk=fi();fg();if(e8){fh("Syntax error")}return typeof fl==="function"?(function fm(fr,fq){var fp,fo,fs=fr[fq];if(fs&&typeof fs==="object"){for(fp in fs){if(Object.prototype.hasOwnProperty.call(fs,fp)){fo=fm(fs,fp);if(fo!==e5){fs[fp]=fo}else{delete fs[fp]}}}}return fl.call(fr,fq,fs)}({"":fk},"")):fk}}())});e6("moxie/image/Image",["moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/file/FileReaderSync","moxie/xhr/XMLHttpRequest","moxie/runtime/Runtime","moxie/runtime/RuntimeClient","moxie/runtime/Transporter","moxie/core/utils/Env","moxie/core/EventTarget","moxie/file/Blob","moxie/file/File","moxie/core/utils/Encode","moxie/core/JSON"],function(e9,fd,fj,fh,fk,e8,fi,fc,fg,fm,fb,ff,fe,fa){var fl=["progress","load","error","resize","embedded"];function e7(){fi.call(this);e9.extend(this,{uid:e9.guid("uid_"),ruid:null,name:"",size:0,width:0,height:0,type:"",meta:{},clone:function(){this.load.apply(this,arguments)},load:function(){this.bind("Load Resize",function(){fo.call(this)},999);this.convertEventPropsToHandlers(fl);fp.apply(this,arguments)},downsize:function(fw,fs,fv,ft){try{if(!this.size){throw new fj.DOMException(fj.DOMException.INVALID_STATE_ERR)}if(this.width>e7.MAX_RESIZE_WIDTH||this.height>e7.MAX_RESIZE_HEIGHT){throw new fj.ImageError(fj.ImageError.MAX_RESOLUTION_ERR)}if(!fw&&!fs||e9.typeOf(fv)==="undefined"){fv=false}fw=fw||this.width;fs=fs||this.height;ft=(e9.typeOf(ft)==="undefined"?true:!!ft);this.getRuntime().exec.call(this,"Image","downsize",fw,fs,fv,ft)}catch(fu){this.trigger("error",fu)}},crop:function(fu,fs,ft){this.downsize(fu,fs,true,ft)},getAsCanvas:function(){if(!fg.can("create_canvas")){throw new fj.RuntimeError(fj.RuntimeError.NOT_SUPPORTED_ERR)}var fs=this.connectRuntime(this.ruid);return fs.exec.call(this,"Image","getAsCanvas")},getAsBlob:function(fs,ft){if(!this.size){throw new fj.DOMException(fj.DOMException.INVALID_STATE_ERR)}if(!fs){fs="image/jpeg"}if(fs==="image/jpeg"&&!ft){ft=90}return this.getRuntime().exec.call(this,"Image","getAsBlob",fs,ft)},getAsDataURL:function(fs,ft){if(!this.size){throw new fj.DOMException(fj.DOMException.INVALID_STATE_ERR)}return this.getRuntime().exec.call(this,"Image","getAsDataURL",fs,ft)},getAsBinaryString:function(fs,fu){var ft=this.getAsDataURL(fs,fu);return fe.atob(ft.substring(ft.indexOf("base64,")+7))},embed:function(fv){var fD=this,fA,fz,fB,fx,fE=arguments[1]||{},fu=this.width,fC=this.height,fw;function ft(){if(fg.can("create_canvas")){var fF=fA.getAsCanvas();if(fF){fv.appendChild(fF);fF=null;fA.destroy();fD.trigger("embedded");return}}var fH=fA.getAsDataURL(fz,fB);if(!fH){throw new fj.ImageError(fj.ImageError.WRONG_FORMAT)}if(fg.can("use_data_uri_of",fH.length)){fv.innerHTML='<img src="'+fH+'" width="'+fA.width+'" height="'+fA.height+'" />';fA.destroy();fD.trigger("embedded")}else{var fG=new fc();fG.bind("TransportingComplete",function(){fw=fD.connectRuntime(this.result.ruid);fD.bind("Embedded",function(){e9.extend(fw.getShimContainer().style,{top:"0px",left:"0px",width:fA.width+"px",height:fA.height+"px"});fw=null},999);fw.exec.call(fD,"ImageView","display",this.result.uid,fu,fC);fA.destroy()});fG.transport(fe.atob(fH.substring(fH.indexOf("base64,")+7)),fz,e9.extend({},fE,{required_caps:{display_media:true},runtime_order:"flash,silverlight",container:fv}))}}try{if(!(fv=fd.get(fv))){throw new fj.DOMException(fj.DOMException.INVALID_NODE_TYPE_ERR)}if(!this.size){throw new fj.DOMException(fj.DOMException.INVALID_STATE_ERR)}if(this.width>e7.MAX_RESIZE_WIDTH||this.height>e7.MAX_RESIZE_HEIGHT){throw new fj.ImageError(fj.ImageError.MAX_RESOLUTION_ERR)}fz=fE.type||this.type||"image/jpeg";fB=fE.quality||90;fx=e9.typeOf(fE.crop)!=="undefined"?fE.crop:false;if(fE.width){fu=fE.width;fC=fE.height||fu}else{var fs=fd.getSize(fv);if(fs.w&&fs.h){fu=fs.w;fC=fs.h}}fA=new e7();fA.bind("Resize",function(){ft.call(fD)});fA.bind("Load",function(){fA.downsize(fu,fC,fx,false)});fA.clone(this,false);return fA}catch(fy){this.trigger("error",fy)}},destroy:function(){if(this.ruid){this.getRuntime().exec.call(this,"Image","destroy");this.disconnectRuntime()}this.unbindAll()}});function fo(ft){if(!ft){ft=this.getRuntime().exec.call(this,"Image","getInfo")}if(ft){if(e9.typeOf(ft.meta)==="string"){try{this.meta=fa(ft.meta)}catch(fs){}}else{this.meta=ft.meta}}e9.extend(this,{size:parseInt(ft.size,10),width:parseInt(ft.width,10),height:parseInt(ft.height,10),type:ft.type});if(this.name===""){this.name=ft.name}}function fp(fu){var ft=e9.typeOf(fu);try{if(fu instanceof e7){if(!fu.size){throw new fj.DOMException(fj.DOMException.INVALID_STATE_ERR)}fn.apply(this,arguments)}else{if(fu instanceof fb){if(!~e9.inArray(fu.type,["image/jpeg","image/png"])){throw new fj.ImageError(fj.ImageError.WRONG_FORMAT)}fq.apply(this,arguments)}else{if(e9.inArray(ft,["blob","file"])!==-1){fp.call(this,new ff(null,fu),arguments[1])}else{if(ft==="string"){if(/^data:[^;]*;base64,/.test(fu)){fp.call(this,new fb(null,{data:fu}),arguments[1])}else{fr.apply(this,arguments)}}else{if(ft==="node"&&fu.nodeName.toLowerCase()==="img"){fp.call(this,fu.src,arguments[1])}else{throw new fj.DOMException(fj.DOMException.TYPE_MISMATCH_ERR)}}}}}}catch(fs){this.trigger("error",fs)}}function fn(fs,ft){var fu=this.connectRuntime(fs.ruid);this.ruid=fu.uid;fu.exec.call(this,"Image","loadFromImage",fs,(e9.typeOf(ft)==="undefined"?true:ft))}function fq(fu,fv){var ft=this;ft.name=fu.name||"";function fs(fw){ft.ruid=fw.uid;fw.exec.call(ft,"Image","loadFromBlob",fu)}if(fu.isDetached()){this.bind("RuntimeInit",function(fx,fw){fs(fw)});if(fv&&typeof(fv.required_caps)==="string"){fv.required_caps=e8.parseCaps(fv.required_caps)}this.connectRuntime(e9.extend({required_caps:{access_image_binary:true,resize_image:true}},fv))}else{fs(this.connectRuntime(fu.ruid))}}function fr(fu,ft){var fs=this,fv;fv=new fk();fv.open("get",fu);fv.responseType="blob";fv.onprogress=function(fw){fs.trigger(fw)};fv.onload=function(){fq.call(fs,fv.response,true)};fv.onerror=function(fw){fs.trigger(fw)};fv.onloadend=function(){fv.destroy()};fv.bind("RuntimeError",function(fx,fw){fs.trigger("RuntimeError",fw)});fv.send(null,ft)}}e7.MAX_RESIZE_WIDTH=6500;e7.MAX_RESIZE_HEIGHT=6500;e7.prototype=fm.instance;return e7});e6("moxie/runtime/html5/Runtime",["moxie/core/utils/Basic","moxie/core/Exceptions","moxie/runtime/Runtime","moxie/core/utils/Env"],function(fc,e7,e9,e8){var fb="html5",fa={};function fd(ff){var fe=this,fi=e9.capTest,fh=e9.capTrue;var fg=fc.extend({access_binary:fi(window.FileReader||window.File&&window.File.getAsDataURL),access_image_binary:function(){return fe.can("access_binary")&&!!fa.Image},display_media:fi(e8.can("create_canvas")||e8.can("use_data_uri_over32kb")),do_cors:fi(window.XMLHttpRequest&&"withCredentials" in new XMLHttpRequest()),drag_and_drop:fi(function(){var fj=document.createElement("div");return(("draggable" in fj)||("ondragstart" in fj&&"ondrop" in fj))&&(e8.browser!=="IE"||e8.version>9)}()),filter_by_extension:fi(function(){return(e8.browser==="Chrome"&&e8.version>=28)||(e8.browser==="IE"&&e8.version>=10)}()),return_response_headers:fh,return_response_type:function(fj){if(fj==="json"){return true}else{return e8.can("return_response_type",fj)}},return_status_code:fh,report_upload_progress:fi(window.XMLHttpRequest&&new XMLHttpRequest().upload),resize_image:function(){return fe.can("access_binary")&&e8.can("create_canvas")},select_file:function(){return e8.can("use_fileinput")&&window.File},select_folder:function(){return fe.can("select_file")&&e8.browser==="Chrome"&&e8.version>=21},select_multiple:function(){return fe.can("select_file")&&!(e8.browser==="Safari"&&e8.OS==="Windows")},send_binary_string:fi(window.XMLHttpRequest&&(new XMLHttpRequest().sendAsBinary||(window.Uint8Array&&window.ArrayBuffer))),send_custom_headers:fi(window.XMLHttpRequest),send_multipart:function(){return !!(window.XMLHttpRequest&&new XMLHttpRequest().upload&&window.FormData)||fe.can("send_binary_string")},slice_blob:fi(window.File&&(File.prototype.mozSlice||File.prototype.webkitSlice||File.prototype.slice)),stream_upload:function(){return fe.can("slice_blob")&&fe.can("send_multipart")},summon_file_dialog:fi(function(){return(e8.browser==="Firefox"&&e8.version>=4)||(e8.browser==="Opera"&&e8.version>=12)||(e8.browser==="IE"&&e8.version>=10)||!!~fc.inArray(e8.browser,["Chrome","Safari"])}()),upload_filesize:fh},arguments[2]);e9.call(this,ff,(arguments[1]||fb),fg);fc.extend(this,{init:function(){this.trigger("Init")},destroy:(function(fj){return function(){fj.call(fe);fj=fe=null}}(this.destroy))});fc.extend(this.getShim(),fa)}e9.addConstructor(fb,fd);return fa});e6("moxie/runtime/html5/file/Blob",["moxie/runtime/html5/Runtime","moxie/file/Blob"],function(e8,e9){function e7(){function fa(fc,ff,fb){var fd;if(window.File.prototype.slice){try{fc.slice();return fc.slice(ff,fb)}catch(fe){return fc.slice(ff,fb-ff)}}else{if((fd=window.File.prototype.webkitSlice||window.File.prototype.mozSlice)){return fd.call(fc,ff,fb)}else{return null}}}this.slice=function(){return new e9(this.getRuntime().uid,fa.apply(this,arguments))}}return(e8.Blob=e7)});e6("moxie/core/utils/Events",["moxie/core/utils/Basic"],function(fd){var fe={},fa="moxie_"+fd.guid();function e9(){this.returnValue=false}function e8(){this.cancelBubble=true}var fb=function(fj,ff,fk,fh){var fi,fg;ff=ff.toLowerCase();if(fj.addEventListener){fi=fk;fj.addEventListener(ff,fi,false)}else{if(fj.attachEvent){fi=function(){var fl=window.event;if(!fl.target){fl.target=fl.srcElement}fl.preventDefault=e9;fl.stopPropagation=e8;fk(fl)};fj.attachEvent("on"+ff,fi)}}if(!fj[fa]){fj[fa]=fd.guid()}if(!fe.hasOwnProperty(fj[fa])){fe[fj[fa]]={}}fg=fe[fj[fa]];if(!fg.hasOwnProperty(ff)){fg[ff]=[]}fg[ff].push({func:fi,orig:fk,key:fh})};var fc=function(fk,ff,fl){var fi,fh;ff=ff.toLowerCase();if(fk[fa]&&fe[fk[fa]]&&fe[fk[fa]][ff]){fi=fe[fk[fa]][ff]}else{return}for(var fg=fi.length-1;fg>=0;fg--){if(fi[fg].orig===fl||fi[fg].key===fl){if(fk.removeEventListener){fk.removeEventListener(ff,fi[fg].func,false)}else{if(fk.detachEvent){fk.detachEvent("on"+ff,fi[fg].func)}}fi[fg].orig=null;fi[fg].func=null;fi.splice(fg,1);if(fl!==fh){break}}}if(!fi.length){delete fe[fk[fa]][ff]}if(fd.isEmptyObj(fe[fk[fa]])){delete fe[fk[fa]];try{delete fk[fa]}catch(fj){fk[fa]=fh}}};var e7=function(fg,ff){if(!fg||!fg[fa]){return}fd.each(fe[fg[fa]],function(fi,fh){fc(fg,fh,ff)})};return{addEvent:fb,removeEvent:fc,removeAllEvents:e7}});e6("moxie/runtime/html5/file/FileInput",["moxie/runtime/html5/Runtime","moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/utils/Events","moxie/core/utils/Mime","moxie/core/utils/Env"],function(fb,fd,fa,e8,e9,e7){function fc(){var ff=[],fe;fd.extend(this,{init:function(fp){var fg=this,fn=fg.getRuntime(),fm,fi,fj,fo,fl,fk;fe=fp;ff=[];fj=fe.accept.mimes||e9.extList2mimes(fe.accept,fn.can("filter_by_extension"));fi=fn.getShimContainer();fi.innerHTML='<input id="'+fn.uid+'" type="file" style="font-size:999px;opacity:0;"'+(fe.multiple&&fn.can("select_multiple")?"multiple":"")+(fe.directory&&fn.can("select_folder")?"webkitdirectory directory":"")+(fj?' accept="'+fj.join(",")+'"':"")+" />";fm=fa.get(fn.uid);fd.extend(fm.style,{position:"absolute",top:0,left:0,width:"100%",height:"100%"});fo=fa.get(fe.browse_button);if(fn.can("summon_file_dialog")){if(fa.getStyle(fo,"position")==="static"){fo.style.position="relative"}fl=parseInt(fa.getStyle(fo,"z-index"),10)||1;fo.style.zIndex=fl;fi.style.zIndex=fl-1;e8.addEvent(fo,"click",function(fr){var fq=fa.get(fn.uid);if(fq&&!fq.disabled){fq.click()}fr.preventDefault()},fg.uid)}fk=fn.can("summon_file_dialog")?fo:fi;e8.addEvent(fk,"mouseover",function(){fg.trigger("mouseenter")},fg.uid);e8.addEvent(fk,"mouseout",function(){fg.trigger("mouseleave")},fg.uid);e8.addEvent(fk,"mousedown",function(){fg.trigger("mousedown")},fg.uid);e8.addEvent(fa.get(fe.container),"mouseup",function(){fg.trigger("mouseup")},fg.uid);fm.onchange=function fh(){ff=[];if(fe.directory){fd.each(this.files,function(fr){if(fr.name!=="."){ff.push(fr)}})}else{ff=[].slice.call(this.files)}if(e7.browser!=="IE"){this.value=""}else{var fq=this.cloneNode(true);this.parentNode.replaceChild(fq,this);fq.onchange=fh}fg.trigger("change")};fg.trigger({type:"ready",async:true});fi=null},getFiles:function(){return ff},disable:function(fi){var fh=this.getRuntime(),fg;if((fg=fa.get(fh.uid))){fg.disabled=!!fi}},destroy:function(){var fh=this.getRuntime(),fg=fh.getShimContainer();e8.removeAllEvents(fg,this.uid);e8.removeAllEvents(fe&&fa.get(fe.container),this.uid);e8.removeAllEvents(fe&&fa.get(fe.browse_button),this.uid);if(fg){fg.innerHTML=""}ff=fe=null}})}return(fb.FileInput=fc)});e6("moxie/runtime/html5/file/FileDrop",["moxie/runtime/html5/Runtime","moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/utils/Events","moxie/core/utils/Mime"],function(fa,fb,e9,e7,e8){function fc(){var ff=[],fi=[],fe;fb.extend(this,{init:function(fm){var fl=this,fn;fe=fm;fi=fg(fe.accept);fn=fe.container;e7.addEvent(fn,"dragover",function(fo){fo.preventDefault();fo.stopPropagation();fo.dataTransfer.dropEffect="copy"},fl.uid);e7.addEvent(fn,"drop",function(fp){fp.preventDefault();fp.stopPropagation();ff=[];if(fp.dataTransfer.items&&fp.dataTransfer.items[0].webkitGetAsEntry){var fo=[];fb.each(fp.dataTransfer.items,function(fq){fo.push(fq.webkitGetAsEntry())});fj(fo,function(){fl.trigger("drop")})}else{fb.each(fp.dataTransfer.files,function(fq){if(fd(fq)){ff.push(fq)}});fl.trigger("drop")}},fl.uid);e7.addEvent(fn,"dragenter",function(fo){fo.preventDefault();fo.stopPropagation();fl.trigger("dragenter")},fl.uid);e7.addEvent(fn,"dragleave",function(fo){fo.preventDefault();fo.stopPropagation();fl.trigger("dragleave")},fl.uid)},getFiles:function(){return ff},destroy:function(){e7.removeAllEvents(fe&&e9.get(fe.container),this.uid);ff=fi=fe=null}});function fg(fn){var fm=[];for(var fl=0;fl<fn.length;fl++){[].push.apply(fm,fn[fl].extensions.split(/\s*,\s*/))}return fb.inArray("*",fm)===-1?fm:[]}function fd(fl){var fm=e8.getFileExtension(fl.name);return !fm||!fi.length||fb.inArray(fm,fi)!==-1}function fj(fn,fm){var fl=[];fb.each(fn,function(fo){fl.push(function(fp){fh(fo,fp)})});fb.inSeries(fl,function(){fm()})}function fh(fm,fl){if(fm.isFile){fm.file(function(fn){if(fd(fn)){ff.push(fn)}fl()},function(){fl()})}else{if(fm.isDirectory){fk(fm,fl)}else{fl()}}}function fk(fp,fm){var fl=[],fo=fp.createReader();function fn(fq){fo.readEntries(function(fr){if(fr.length){[].push.apply(fl,fr);fn(fq)}else{fq()}},fq)}fn(function(){fj(fl,fm)})}}return(fa.FileDrop=fc)});e6("moxie/runtime/html5/file/FileReader",["moxie/runtime/html5/Runtime","moxie/core/utils/Encode","moxie/core/utils/Basic"],function(e8,e7,fa){function e9(){var fc,fd=false;fa.extend(this,{read:function(fg,fe){var ff=this;fc=new window.FileReader();fc.addEventListener("progress",function(fh){ff.trigger(fh)});fc.addEventListener("load",function(fh){ff.trigger(fh)});fc.addEventListener("error",function(fh){ff.trigger(fh,fc.error)});fc.addEventListener("loadend",function(){fc=null});if(fa.typeOf(fc[fg])==="function"){fd=false;fc[fg](fe.getSource())}else{if(fg==="readAsBinaryString"){fd=true;fc.readAsDataURL(fe.getSource())}}},getResult:function(){return fc&&fc.result?(fd?fb(fc.result):fc.result):null},abort:function(){if(fc){fc.abort()}},destroy:function(){fc=null}});function fb(fe){return e7.atob(fe.substring(fe.indexOf("base64,")+7))}}return(e8.FileReader=e9)});e6("moxie/runtime/html5/xhr/XMLHttpRequest",["moxie/runtime/html5/Runtime","moxie/core/utils/Basic","moxie/core/utils/Mime","moxie/core/utils/Url","moxie/file/File","moxie/file/Blob","moxie/xhr/FormData","moxie/core/Exceptions","moxie/core/utils/Env","moxie/core/JSON"],function(fe,e8,fb,e7,fd,fa,fh,ff,fc,e9){function fg(){var fn,fl;e8.extend(this,{send:function(fv,fs){var fu=this,fr=(fc.browser==="Mozilla"&&fc.version>=4&&fc.version<7),fo=fc.browser==="Android Browser",ft=false;fl=fv.url.replace(/^.+?\/([\w\-\.]+)$/,"$1").toLowerCase();fn=fm();fn.open(fv.method,fv.url,fv.async,fv.user,fv.password);if(fs instanceof fa){if(fs.isDetached()){ft=true}fs=fs.getSource()}else{if(fs instanceof fh){if(fs.hasBlob()){if(fs.getBlob().isDetached()){fs=fk.call(fu,fs);ft=true}else{if((fr||fo)&&e8.typeOf(fs.getBlob().getSource())==="blob"&&window.FileReader){fi.call(fu,fv,fs);return}}}if(fs instanceof fh){var fq=new window.FormData();fs.each(function(fx,fw){if(fx instanceof fa){fq.append(fw,fx.getSource())}else{fq.append(fw,fx)}});fs=fq}}}if(fn.upload){if(fv.withCredentials){fn.withCredentials=true}fn.addEventListener("load",function(fw){fu.trigger(fw)});fn.addEventListener("error",function(fw){fu.trigger(fw)});fn.addEventListener("progress",function(fw){fu.trigger(fw)});fn.upload.addEventListener("progress",function(fw){fu.trigger({type:"UploadProgress",loaded:fw.loaded,total:fw.total})})}else{fn.onreadystatechange=function fp(){switch(fn.readyState){case 1:break;case 2:break;case 3:var fy,fw;try{if(e7.hasSameOrigin(fv.url)){fy=fn.getResponseHeader("Content-Length")||0}if(fn.responseText){fw=fn.responseText.length}}catch(fx){fy=fw=0}fu.trigger({type:"progress",lengthComputable:!!fy,total:parseInt(fy,10),loaded:fw});break;case 4:fn.onreadystatechange=function(){};if(fn.status===0){fu.trigger("error")}else{fu.trigger("load")}break}}}if(!e8.isEmptyObj(fv.headers)){e8.each(fv.headers,function(fw,fx){fn.setRequestHeader(fx,fw)})}if(""!==fv.responseType&&"responseType" in fn){if("json"===fv.responseType&&!fc.can("return_response_type","json")){fn.responseType="text"}else{fn.responseType=fv.responseType}}if(!ft){fn.send(fs)}else{if(fn.sendAsBinary){fn.sendAsBinary(fs)}else{(function(){var fw=new Uint8Array(fs.length);for(var fx=0;fx<fs.length;fx++){fw[fx]=(fs.charCodeAt(fx)&255)}fn.send(fw.buffer)}())}}fu.trigger("loadstart")},getStatus:function(){try{if(fn){return fn.status}}catch(fo){}return 0},getResponse:function(fq){var fp=this.getRuntime();try{switch(fq){case"blob":var fs=new fd(fp.uid,fn.response);var ft=fn.getResponseHeader("Content-Disposition");if(ft){var fo=ft.match(/filename=([\'\"'])([^\1]+)\1/);if(fo){fl=fo[2]}}fs.name=fl;if(!fs.type){fs.type=fb.getFileMime(fl)}return fs;case"json":if(!fc.can("return_response_type","json")){return fn.status===200?e9(fn.responseText):null}return fn.response;case"document":return fj(fn);default:return fn.responseText!==""?fn.responseText:null}}catch(fr){return null}},getAllResponseHeaders:function(){try{return fn.getAllResponseHeaders()}catch(fo){}return""},abort:function(){if(fn){fn.abort()}},destroy:function(){self=fl=null}});function fi(ft,fq){var fs=this,fp,fo;fp=fq.getBlob().getSource();fo=new window.FileReader();fo.onload=function(){fq.append(fq.getBlobName(),new fa(null,{type:fp.type,data:fo.result}));self.send.call(fs,ft,fq)};fo.readAsBinaryString(fp)}function fm(){if(window.XMLHttpRequest&&!(fc.browser==="IE"&&fc.version<8)){return new window.XMLHttpRequest()}else{return(function(){var fo=["Msxml2.XMLHTTP.6.0","Microsoft.XMLHTTP"];for(var fq=0;fq<fo.length;fq++){try{return new ActiveXObject(fo[fq])}catch(fp){}}})()}}function fj(fp){var fq=fp.responseXML;var fo=fp.responseText;if(fc.browser==="IE"&&fo&&fq&&!fq.documentElement&&/[^\/]+\/[^\+]+\+xml/.test(fp.getResponseHeader("Content-Type"))){fq=new window.ActiveXObject("Microsoft.XMLDOM");fq.async=false;fq.validateOnParse=false;fq.loadXML(fo)}if(fq){if((fc.browser==="IE"&&fq.parseError!==0)||!fq.documentElement||fq.documentElement.tagName==="parsererror"){return null}}return fq}function fk(fq){var ft="----moxieboundary"+new Date().getTime(),fr="--",fs="\r\n",fo="",fp=this.getRuntime();if(!fp.can("send_binary_string")){throw new ff.RuntimeError(ff.RuntimeError.NOT_SUPPORTED_ERR)}fn.setRequestHeader("Content-Type","multipart/form-data; boundary="+ft);fq.each(function(fv,fu){if(fv instanceof fa){fo+=fr+ft+fs+'Content-Disposition: form-data; name="'+fu+'"; filename="'+unescape(encodeURIComponent(fv.name||"blob"))+'"'+fs+"Content-Type: "+fv.type+fs+fs+fv.getSource()+fs}else{fo+=fr+ft+fs+'Content-Disposition: form-data; name="'+fu+'"'+fs+fs+unescape(encodeURIComponent(fv))+fs}});fo+=fr+ft+fr+fs;return fo}}return(fe.XMLHttpRequest=fg)});e6("moxie/runtime/html5/utils/BinaryReader",[],function(){return function(){var fa=false,e8;function fb(fd,ff){var fc=fa?0:-8*(ff-1),fg=0,fe;for(fe=0;fe<ff;fe++){fg|=(e8.charCodeAt(fd+fe)<<Math.abs(fc+fe*8))}return fg}function e7(fe,fc,fd){fd=arguments.length===3?fd:e8.length-fc-1;e8=e8.substr(0,fc)+fe+e8.substr(fd+fc)}function e9(fd,fe,fg){var fh="",fc=fa?0:-8*(fg-1),ff;for(ff=0;ff<fg;ff++){fh+=String.fromCharCode((fe>>Math.abs(fc+ff*8))&255)}e7(fh,fd,fg)}return{II:function(fc){if(fc===e5){return fa}else{fa=fc}},init:function(fc){fa=false;e8=fc},SEGMENT:function(fc,fe,fd){switch(arguments.length){case 1:return e8.substr(fc,e8.length-fc-1);case 2:return e8.substr(fc,fe);case 3:e7(fd,fc,fe);break;default:return e8}},BYTE:function(fc){return fb(fc,1)},SHORT:function(fc){return fb(fc,2)},LONG:function(fc,fd){if(fd===e5){return fb(fc,4)}else{e9(fc,fd,4)}},SLONG:function(fc){var fd=fb(fc,4);return(fd>2147483647?fd-4294967296:fd)},STRING:function(fc,fd){var fe="";for(fd+=fc;fc<fd;fc++){fe+=String.fromCharCode(fb(fc,1))}return fe}}}});e6("moxie/runtime/html5/image/JPEGHeaders",["moxie/runtime/html5/utils/BinaryReader"],function(e8){return function e7(fd){var fe=[],fc,e9,fa,fb=0;fc=new e8();fc.init(fd);if(fc.SHORT(0)!==65496){return}e9=2;while(e9<=fd.length){fa=fc.SHORT(e9);if(fa>=65488&&fa<=65495){e9+=2;continue}if(fa===65498||fa===65497){break}fb=fc.SHORT(e9+2)+2;if(fa>=65505&&fa<=65519){fe.push({hex:fa,name:"APP"+(fa&15),start:e9,length:fb,segment:fc.SEGMENT(e9,fb)})}e9+=fb}fc.init(null);return{headers:fe,restore:function(fh){var ff,fg;fc.init(fh);e9=fc.SHORT(2)==65504?4+fc.SHORT(4):2;for(fg=0,ff=fe.length;fg<ff;fg++){fc.SEGMENT(e9,0,fe[fg].segment);e9+=fe[fg].length}fh=fc.SEGMENT();fc.init(null);return fh},strip:function(fh){var fi,ff,fg;ff=new e7(fh);fi=ff.headers;ff.purge();fc.init(fh);fg=fi.length;while(fg--){fc.SEGMENT(fi[fg].start,fi[fg].length,"")}fh=fc.SEGMENT();fc.init(null);return fh},get:function(fg){var fi=[];for(var fh=0,ff=fe.length;fh<ff;fh++){if(fe[fh].name===fg.toUpperCase()){fi.push(fe[fh].segment)}}return fi},set:function(fg,fj){var fk=[],fh,fi,ff;if(typeof(fj)==="string"){fk.push(fj)}else{fk=fj}for(fh=fi=0,ff=fe.length;fh<ff;fh++){if(fe[fh].name===fg.toUpperCase()){fe[fh].segment=fk[fi];fe[fh].length=fk[fi].length;fi++}if(fi>=fk.length){break}}},purge:function(){fe=[];fc.init(null);fc=null}}}});e6("moxie/runtime/html5/image/ExifParser",["moxie/core/utils/Basic","moxie/runtime/html5/utils/BinaryReader"],function(e9,e8){return function e7(){var fe,fb,fa,fc={},fh;fe=new e8();fb={tiff:{274:"Orientation",270:"ImageDescription",271:"Make",272:"Model",305:"Software",34665:"ExifIFDPointer",34853:"GPSInfoIFDPointer"},exif:{36864:"ExifVersion",40961:"ColorSpace",40962:"PixelXDimension",40963:"PixelYDimension",36867:"DateTimeOriginal",33434:"ExposureTime",33437:"FNumber",34855:"ISOSpeedRatings",37377:"ShutterSpeedValue",37378:"ApertureValue",37383:"MeteringMode",37384:"LightSource",37385:"Flash",37386:"FocalLength",41986:"ExposureMode",41987:"WhiteBalance",41990:"SceneCaptureType",41988:"DigitalZoomRatio",41992:"Contrast",41993:"Saturation",41994:"Sharpness"},gps:{0:"GPSVersionID",1:"GPSLatitudeRef",2:"GPSLatitude",3:"GPSLongitudeRef",4:"GPSLongitude"}};fh={ColorSpace:{1:"sRGB",0:"Uncalibrated"},MeteringMode:{0:"Unknown",1:"Average",2:"CenterWeightedAverage",3:"Spot",4:"MultiSpot",5:"Pattern",6:"Partial",255:"Other"},LightSource:{1:"Daylight",2:"Fliorescent",3:"Tungsten",4:"Flash",9:"Fine weather",10:"Cloudy weather",11:"Shade",12:"Daylight fluorescent (D 5700 - 7100K)",13:"Day white fluorescent (N 4600 -5400K)",14:"Cool white fluorescent (W 3900 - 4500K)",15:"White fluorescent (WW 3200 - 3700K)",17:"Standard light A",18:"Standard light B",19:"Standard light C",20:"D55",21:"D65",22:"D75",23:"D50",24:"ISO studio tungsten",255:"Other"},Flash:{0:"Flash did not fire.",1:"Flash fired.",5:"Strobe return light not detected.",7:"Strobe return light detected.",9:"Flash fired, compulsory flash mode",13:"Flash fired, compulsory flash mode, return light not detected",15:"Flash fired, compulsory flash mode, return light detected",16:"Flash did not fire, compulsory flash mode",24:"Flash did not fire, auto mode",25:"Flash fired, auto mode",29:"Flash fired, auto mode, return light not detected",31:"Flash fired, auto mode, return light detected",32:"No flash function",65:"Flash fired, red-eye reduction mode",69:"Flash fired, red-eye reduction mode, return light not detected",71:"Flash fired, red-eye reduction mode, return light detected",73:"Flash fired, compulsory flash mode, red-eye reduction mode",77:"Flash fired, compulsory flash mode, red-eye reduction mode, return light not detected",79:"Flash fired, compulsory flash mode, red-eye reduction mode, return light detected",89:"Flash fired, auto mode, red-eye reduction mode",93:"Flash fired, auto mode, return light not detected, red-eye reduction mode",95:"Flash fired, auto mode, return light detected, red-eye reduction mode"},ExposureMode:{0:"Auto exposure",1:"Manual exposure",2:"Auto bracket"},WhiteBalance:{0:"Auto white balance",1:"Manual white balance"},SceneCaptureType:{0:"Standard",1:"Landscape",2:"Portrait",3:"Night scene"},Contrast:{0:"Normal",1:"Soft",2:"Hard"},Saturation:{0:"Normal",1:"Low saturation",2:"High saturation"},Sharpness:{0:"Normal",1:"Soft",2:"Hard"},GPSLatitudeRef:{N:"North latitude",S:"South latitude"},GPSLongitudeRef:{E:"East longitude",W:"West longitude"}};function fd(fi,fq){var fk=fe.SHORT(fi),fn,ft,fu,fp,fo,fj,fl,fr,fs=[],fm={};for(fn=0;fn<fk;fn++){fl=fj=fi+12*fn+2;fu=fq[fe.SHORT(fl)];if(fu===e5){continue}fp=fe.SHORT(fl+=2);fo=fe.LONG(fl+=2);fl+=4;fs=[];switch(fp){case 1:case 7:if(fo>4){fl=fe.LONG(fl)+fc.tiffHeader}for(ft=0;ft<fo;ft++){fs[ft]=fe.BYTE(fl+ft)}break;case 2:if(fo>4){fl=fe.LONG(fl)+fc.tiffHeader}fm[fu]=fe.STRING(fl,fo-1);continue;case 3:if(fo>2){fl=fe.LONG(fl)+fc.tiffHeader}for(ft=0;ft<fo;ft++){fs[ft]=fe.SHORT(fl+ft*2)}break;case 4:if(fo>1){fl=fe.LONG(fl)+fc.tiffHeader}for(ft=0;ft<fo;ft++){fs[ft]=fe.LONG(fl+ft*4)}break;case 5:fl=fe.LONG(fl)+fc.tiffHeader;for(ft=0;ft<fo;ft++){fs[ft]=fe.LONG(fl+ft*4)/fe.LONG(fl+ft*4+4)}break;case 9:fl=fe.LONG(fl)+fc.tiffHeader;for(ft=0;ft<fo;ft++){fs[ft]=fe.SLONG(fl+ft*4)}break;case 10:fl=fe.LONG(fl)+fc.tiffHeader;for(ft=0;ft<fo;ft++){fs[ft]=fe.SLONG(fl+ft*4)/fe.SLONG(fl+ft*4+4)}break;default:continue}fr=(fo==1?fs[0]:fs);if(fh.hasOwnProperty(fu)&&typeof fr!="object"){fm[fu]=fh[fu][fr]}else{fm[fu]=fr}}return fm}function fg(){var fi=fc.tiffHeader;fe.II(fe.SHORT(fi)==18761);if(fe.SHORT(fi+=2)!==42){return false}fc.IFD0=fc.tiffHeader+fe.LONG(fi+=2);fa=fd(fc.IFD0,fb.tiff);if("ExifIFDPointer" in fa){fc.exifIFD=fc.tiffHeader+fa.ExifIFDPointer;delete fa.ExifIFDPointer}if("GPSInfoIFDPointer" in fa){fc.gpsIFD=fc.tiffHeader+fa.GPSInfoIFDPointer;delete fa.GPSInfoIFDPointer}return true}function ff(fp,fr,fo){var fm,fk,fj,fi=0;if(typeof(fr)==="string"){var fq=fb[fp.toLowerCase()];for(var fl in fq){if(fq[fl]===fr){fr=fl;break}}}fm=fc[fp.toLowerCase()+"IFD"];fk=fe.SHORT(fm);for(var fn=0;fn<fk;fn++){fj=fm+12*fn+2;if(fe.SHORT(fj)==fr){fi=fj+8;break}}if(!fi){return false}fe.LONG(fi,fo);return true}return{init:function(fi){fc={tiffHeader:10};if(fi===e5||!fi.length){return false}fe.init(fi);if(fe.SHORT(0)===65505&&fe.STRING(4,5).toUpperCase()==="EXIF\0"){return fg()}return false},TIFF:function(){return fa},EXIF:function(){var fj;fj=fd(fc.exifIFD,fb.exif);if(fj.ExifVersion&&e9.typeOf(fj.ExifVersion)==="array"){for(var fk=0,fi="";fk<fj.ExifVersion.length;fk++){fi+=String.fromCharCode(fj.ExifVersion[fk])}fj.ExifVersion=fi}return fj},GPS:function(){var fi;fi=fd(fc.gpsIFD,fb.gps);if(fi.GPSVersionID&&e9.typeOf(fi.GPSVersionID)==="array"){fi.GPSVersionID=fi.GPSVersionID.join(".")}return fi},setExif:function(fi,fj){if(fi!=="PixelXDimension"&&fi!=="PixelYDimension"){return false}return ff("exif",fi,fj)},getBinary:function(){return fe.SEGMENT()},purge:function(){fe.init(null);fe=fa=null;fc={}}}}});e6("moxie/runtime/html5/image/JPEG",["moxie/core/utils/Basic","moxie/core/Exceptions","moxie/runtime/html5/image/JPEGHeaders","moxie/runtime/html5/utils/BinaryReader","moxie/runtime/html5/image/ExifParser"],function(fc,e7,e9,fb,e8){function fa(fl){var fe,fg,fi,fh,fk,fd;function fj(){var fm=0,fn,fo;while(fm<=fe.length){fn=fg.SHORT(fm+=2);if(fn>=65472&&fn<=65475){fm+=5;return{height:fg.SHORT(fm),width:fg.SHORT(fm+=2)}}fo=fg.SHORT(fm+=2);fm+=fo-2}return null}fe=fl;fg=new fb();fg.init(fe);if(fg.SHORT(0)!==65496){throw new e7.ImageError(e7.ImageError.WRONG_FORMAT)}fi=new e9(fl);fh=new e8();fd=!!fh.init(fi.get("app1")[0]);fk=fj.call(this);fc.extend(this,{type:"image/jpeg",size:fe.length,width:fk&&fk.width||0,height:fk&&fk.height||0,setExif:function(fm,fn){if(!fd){return false}if(fc.typeOf(fm)==="object"){fc.each(fm,function(fp,fo){fh.setExif(fo,fp)})}else{fh.setExif(fm,fn)}fi.set("app1",fh.getBinary())},writeHeaders:function(){if(!arguments.length){return(fe=fi.restore(fe))}return fi.restore(arguments[0])},stripHeaders:function(fm){return fi.strip(fm)},purge:function(){ff.call(this)}});if(fd){this.meta={tiff:fh.TIFF(),exif:fh.EXIF(),gps:fh.GPS()}}function ff(){if(!fh||!fi||!fg){return}fh.purge();fi.purge();fg.init(null);fe=fk=fi=fh=fg=null}}return fa});e6("moxie/runtime/html5/image/PNG",["moxie/core/Exceptions","moxie/core/utils/Basic","moxie/runtime/html5/utils/BinaryReader"],function(e7,fa,e9){function e8(fj){var fc,fe,fg,ff,fi;fc=fj;fe=new e9();fe.init(fc);(function(){var fk=0,fm=0,fl=[35152,20039,3338,6666];for(fm=0;fm<fl.length;fm++,fk+=2){if(fl[fm]!=fe.SHORT(fk)){throw new e7.ImageError(e7.ImageError.WRONG_FORMAT)}}}());function fh(){var fl,fk;fl=fb.call(this,8);if(fl.type=="IHDR"){fk=fl.start;return{width:fe.LONG(fk),height:fe.LONG(fk+=4)}}return null}function fd(){if(!fe){return}fe.init(null);fc=fi=fg=ff=fe=null}fi=fh.call(this);fa.extend(this,{type:"image/png",size:fc.length,width:fi.width,height:fi.height,purge:function(){fd.call(this)}});fd.call(this);function fb(fk){var fn,fm,fo,fl;fn=fe.LONG(fk);fm=fe.STRING(fk+=4,4);fo=fk+=4;fl=fe.LONG(fk+fn);return{length:fn,type:fm,start:fo,CRC:fl}}}return e8});e6("moxie/runtime/html5/image/ImageInfo",["moxie/core/utils/Basic","moxie/core/Exceptions","moxie/runtime/html5/image/JPEG","moxie/runtime/html5/image/PNG"],function(fa,e7,e9,e8){return function(fc){var fd=[e9,e8],fb;fb=(function(){for(var ff=0;ff<fd.length;ff++){try{return new fd[ff](fc)}catch(fe){}}throw new e7.ImageError(e7.ImageError.WRONG_FORMAT)}());fa.extend(this,{type:"",size:0,width:0,height:0,setExif:function(){},writeHeaders:function(fe){return fe},stripHeaders:function(fe){return fe},purge:function(){}});fa.extend(this,fb);this.purge=function(){fb.purge();fb=null}}});e6("moxie/runtime/html5/image/MegaPixel",[],function(){function e7(fv,fb,fc){var fe=fv.naturalWidth,fk=fv.naturalHeight;var fp=fc.width,fm=fc.height;var fg=fc.x||0,ff=fc.y||0;var fq=fb.getContext("2d");if(e8(fv)){fe/=2;fk/=2}var ft=1024;var fa=document.createElement("canvas");fa.width=fa.height=ft;var fd=fa.getContext("2d");var fr=e9(fv,fe,fk);var fl=0;while(fl<fk){var fu=fl+ft>fk?fk-fl:ft;var fn=0;while(fn<fe){var fo=fn+ft>fe?fe-fn:ft;fd.clearRect(0,0,ft,ft);fd.drawImage(fv,-fn,-fl);var fi=(fn*fp/fe+fg)<<0;var fj=Math.ceil(fo*fp/fe);var fh=(fl*fm/fk/fr+ff)<<0;var fs=Math.ceil(fu*fm/fk/fr);fq.drawImage(fa,0,0,fo,fu,fi,fh,fj,fs);fn+=ft}fl+=ft}fa=fd=null}function e8(fc){var fb=fc.naturalWidth,fe=fc.naturalHeight;if(fb*fe>1024*1024){var fd=document.createElement("canvas");fd.width=fd.height=1;var fa=fd.getContext("2d");fa.drawImage(fc,-fb+1,0);return fa.getImageData(0,0,1,1).data[3]===0}else{return false}}function e9(fe,fb,fj){var fa=document.createElement("canvas");fa.width=1;fa.height=fj;var fk=fa.getContext("2d");fk.drawImage(fe,0,0);var fd=fk.getImageData(0,0,1,fj).data;var fh=0;var ff=fj;var fi=fj;while(fi>fh){var fc=fd[(fi-1)*4+3];if(fc===0){ff=fi}else{fh=fi}fi=(ff+fh)>>1}fa=null;var fg=(fi/fj);return(fg===0)?1:fg}return{isSubsampled:e8,renderTo:e7}});e6("moxie/runtime/html5/image/Image",["moxie/runtime/html5/Runtime","moxie/core/utils/Basic","moxie/core/Exceptions","moxie/core/utils/Encode","moxie/file/Blob","moxie/runtime/html5/image/ImageInfo","moxie/runtime/html5/image/MegaPixel","moxie/core/utils/Mime","moxie/core/utils/Env"],function(fd,e7,fe,fa,e8,fg,ff,e9,fb){function fc(){var fr=this,fq,fv,fp,fl,ft,fx=false,fi=true;e7.extend(this,{loadFromBlob:function(fA){var fz=this,fB=fz.getRuntime(),fy=arguments.length>1?arguments[1]:true;if(!fB.can("access_binary")){throw new fe.RuntimeError(fe.RuntimeError.NOT_SUPPORTED_ERR)}ft=fA;if(fA.isDetached()){fl=fA.getSource();fo.call(this,fl);return}else{fu.call(this,fA.getSource(),function(fC){if(fy){fl=fw(fC)}fo.call(fz,fC)})}},loadFromImage:function(fy,fz){this.meta=fy.meta;ft=new e8(null,{name:fy.name,size:fy.size,type:fy.type});fo.call(this,fz?(fl=fy.getAsBinaryString()):fy.getAsDataURL())},getInfo:function(){var fy=this.getRuntime(),fz;if(!fv&&fl&&fy.can("access_image_binary")){fv=new fg(fl)}fz={width:fm().width||0,height:fm().height||0,type:ft.type||e9.getFileMime(ft.name),size:fl&&fl.length||ft.size||0,name:ft.name||"",meta:fv&&fv.meta||this.meta||{}};return fz},downsize:function(){fh.apply(this,arguments)},getAsCanvas:function(){if(fp){fp.id=this.uid+"_canvas"}return fp},getAsBlob:function(fy,fz){if(fy!==this.type){fh.call(this,this.width,this.height,false)}return new e8(null,{type:fy,data:fr.getAsBinaryString.call(this,fy,fz)})},getAsDataURL:function(fz){var fA=arguments[1]||90;if(!fx){return fq.src}if("image/jpeg"!==fz){return fp.toDataURL("image/png")}else{try{return fp.toDataURL("image/jpeg",fA/100)}catch(fy){return fp.toDataURL("image/jpeg")}}},getAsBinaryString:function(fz,fB){if(!fx){if(!fl){fl=fw(fr.getAsDataURL(fz,fB))}return fl}if("image/jpeg"!==fz){fl=fw(fr.getAsDataURL(fz,fB))}else{var fA;if(!fB){fB=90}try{fA=fp.toDataURL("image/jpeg",fB/100)}catch(fy){fA=fp.toDataURL("image/jpeg")}fl=fw(fA);if(fv){fl=fv.stripHeaders(fl);if(fi){if(fv.meta&&fv.meta.exif){fv.setExif({PixelXDimension:this.width,PixelYDimension:this.height})}fl=fv.writeHeaders(fl)}fv.purge();fv=null}}fx=false;return fl},destroy:function(){fr=null;fj.call(this);this.getRuntime().getShim().removeInstance(this.uid)}});function fm(){if(!fp&&!fq){throw new fe.ImageError(fe.DOMException.INVALID_STATE_ERR)}return fp||fq}function fw(fy){return fa.atob(fy.substring(fy.indexOf("base64,")+7))}function fs(fz,fy){return"data:"+(fy||"")+";base64,"+fa.btoa(fz)}function fo(fz){var fy=this;fq=new Image();fq.onerror=function(){fj.call(this);fy.trigger("error",new fe.ImageError(fe.ImageError.WRONG_FORMAT))};fq.onload=function(){fy.trigger("load")};fq.src=/^data:[^;]*;base64,/.test(fz)?fz:fs(fz,ft.type)}function fu(fA,fB){var fz=this,fy;if(window.FileReader){fy=new FileReader();fy.onload=function(){fB(this.result)};fy.onerror=function(){fz.trigger("error",new fe.FileException(fe.FileException.NOT_READABLE_ERR))};fy.readAsDataURL(fA)}else{return fB(fA.getAsDataURL())}}function fh(fz,fK,fD,fI){var fL=this,fM,fB,fA,fH,fG,fC,fF,fE,fy;fi=fI;fy=(this.meta&&this.meta.tiff&&this.meta.tiff.Orientation)||1;if(e7.inArray(fy,[5,6,7,8])!==-1){var fJ=fz;fz=fK;fK=fJ}fC=fm();fA=!fD?Math.min:Math.max;fB=fA(fz/fC.width,fK/fC.height);if(fB>1&&(!fD||fI)){this.trigger("Resize");return}fF=Math.round(fC.width*fB);fE=Math.round(fC.height*fB);if(!fp){fp=document.createElement("canvas")}fM=fp.getContext("2d");if(fD){fp.width=fz;fp.height=fK}else{fp.width=fF;fp.height=fE}fH=fF>fp.width?Math.round((fF-fp.width)/2):0;fG=fE>fp.height?Math.round((fE-fp.height)/2):0;if(!fi){fn(fp.width,fp.height,fy)}fk.call(this,fC,fp,-fH,-fG,fF,fE);this.width=fp.width;this.height=fp.height;fx=true;fL.trigger("Resize")}function fk(fB,fC,fy,fE,fA,fD){if(fb.OS==="iOS"){ff.renderTo(fB,fC,{width:fA,height:fD,x:fy,y:fE})}else{var fz=fC.getContext("2d");fz.drawImage(fB,fy,fE,fA,fD)}}function fn(fB,fy,fA){switch(fA){case 5:case 6:case 7:case 8:fp.width=fy;fp.height=fB;break;default:fp.width=fB;fp.height=fy}var fz=fp.getContext("2d");switch(fA){case 2:fz.translate(fB,0);fz.scale(-1,1);break;case 3:fz.translate(fB,fy);fz.rotate(Math.PI);break;case 4:fz.translate(0,fy);fz.scale(1,-1);break;case 5:fz.rotate(0.5*Math.PI);fz.scale(1,-1);break;case 6:fz.rotate(0.5*Math.PI);fz.translate(0,-fy);break;case 7:fz.rotate(0.5*Math.PI);fz.translate(fB,-fy);fz.scale(-1,1);break;case 8:fz.rotate(-0.5*Math.PI);fz.translate(-fB,0);break}}function fj(){if(fv){fv.purge();fv=null}fl=fq=fp=ft=null;fx=false}}return(fd.Image=fc)});e6("moxie/runtime/flash/Runtime",["moxie/core/utils/Basic","moxie/core/utils/Env","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/runtime/Runtime"],function(e8,fb,e9,fe,e7){var fc="flash",fd={};function fa(){var fg;try{fg=navigator.plugins["Shockwave Flash"];fg=fg.description}catch(fi){try{fg=new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")}catch(fh){fg="0.0"}}fg=fg.match(/\d+/g);return parseFloat(fg[0]+"."+fg[1])}function ff(fh){var fg=this,fi;fh=e8.extend({swf_url:fb.swf_url},fh);e7.call(this,fh,fc,{access_binary:function(fj){return fj&&fg.mode==="browser"},access_image_binary:function(fj){return fj&&fg.mode==="browser"},display_media:e7.capTrue,do_cors:e7.capTrue,drag_and_drop:false,report_upload_progress:function(){return fg.mode==="client"},resize_image:e7.capTrue,return_response_headers:false,return_response_type:function(fj){return !e8.arrayDiff(fj,["","text","json","document"])||fg.mode==="browser"},return_status_code:function(fj){return fg.mode==="browser"||!e8.arrayDiff(fj,[200,404])},select_file:e7.capTrue,select_multiple:e7.capTrue,send_binary_string:function(fj){return fj&&fg.mode==="browser"},send_browser_cookies:function(fj){return fj&&fg.mode==="browser"},send_custom_headers:function(fj){return fj&&fg.mode==="browser"},send_multipart:e7.capTrue,slice_blob:e7.capTrue,stream_upload:function(fj){return fj&&fg.mode==="browser"},summon_file_dialog:false,upload_filesize:function(fj){return e8.parseSizeStr(fj)<=2097152||fg.mode==="client"},use_http_method:function(fj){return !e8.arrayDiff(fj,["GET","POST"])}},{access_binary:function(fj){return fj?"browser":"client"},access_image_binary:function(fj){return fj?"browser":"client"},report_upload_progress:function(fj){return fj?"browser":"client"},return_response_type:function(fj){return e8.arrayDiff(fj,["","text","json","document"])?"browser":["client","browser"]},return_status_code:function(fj){return e8.arrayDiff(fj,[200,404])?"browser":["client","browser"]},send_binary_string:function(fj){return fj?"browser":"client"},send_browser_cookies:function(fj){return fj?"browser":"client"},send_custom_headers:function(fj){return fj?"browser":"client"},stream_upload:function(fj){return fj?"client":"browser"},upload_filesize:function(fj){return e8.parseSizeStr(fj)>=2097152?"client":"browser"}},"client");if(fa()<10){this.mode=false}e8.extend(this,{getShim:function(){return e9.get(this.uid)},shimExec:function(fk,fl){var fj=[].slice.call(arguments,2);return fg.getShim().exec(this.uid,fk,fl,fj)},init:function(){var fk,fl,fj;fj=this.getShimContainer();e8.extend(fj.style,{position:"absolute",top:"-8px",left:"-8px",width:"9px",height:"9px",overflow:"hidden"});fk='<object id="'+this.uid+'" type="application/x-shockwave-flash" data="'+fh.swf_url+'" ';if(fb.browser==="IE"){fk+='classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" '}fk+='width="100%" height="100%" style="outline:0"><param name="movie" value="'+fh.swf_url+'" /><param name="flashvars" value="uid='+escape(this.uid)+"&target="+fb.global_event_dispatcher+'" /><param name="wmode" value="transparent" /><param name="allowscriptaccess" value="always" /></object>';if(fb.browser==="IE"){fl=document.createElement("div");fj.appendChild(fl);fl.outerHTML=fk;fl=fj=null}else{fj.innerHTML=fk}fi=setTimeout(function(){if(fg&&!fg.initialized){fg.trigger("Error",new fe.RuntimeError(fe.RuntimeError.NOT_INIT_ERR))}},5000)},destroy:(function(fj){return function(){fj.call(fg);clearTimeout(fi);fh=fi=fj=fg=null}}(this.destroy))},fd)}e7.addConstructor(fc,ff);return fd});e6("moxie/runtime/flash/file/Blob",["moxie/runtime/flash/Runtime","moxie/file/Blob"],function(e8,e9){var e7={slice:function(fc,fe,fa,fd){var fb=this.getRuntime();if(fe<0){fe=Math.max(fc.size+fe,0)}else{if(fe>0){fe=Math.min(fe,fc.size)}}if(fa<0){fa=Math.max(fc.size+fa,0)}else{if(fa>0){fa=Math.min(fa,fc.size)}}fc=fb.shimExec.call(this,"Blob","slice",fe,fa,fd||"");if(fc){fc=new e9(fb.uid,fc)}return fc}};return(e8.Blob=e7)});e6("moxie/runtime/flash/file/FileInput",["moxie/runtime/flash/Runtime"],function(e7){var e8={init:function(e9){this.getRuntime().shimExec.call(this,"FileInput","init",{name:e9.name,accept:e9.accept,multiple:e9.multiple});this.trigger("ready")}};return(e7.FileInput=e8)});e6("moxie/runtime/flash/file/FileReader",["moxie/runtime/flash/Runtime","moxie/core/utils/Encode"],function(fa,e7){var e8="";function e9(fc,fd){switch(fd){case"readAsText":return e7.atob(fc,"utf8");case"readAsBinaryString":return e7.atob(fc);case"readAsDataURL":return fc}return null}var fb={read:function(ff,fd){var fe=this,fc=fe.getRuntime();if(ff==="readAsDataURL"){e8="data:"+(fd.type||"")+";base64,"}fe.bind("Progress",function(fh,fg){if(fg){e8+=e9(fg,ff)}});return fc.shimExec.call(this,"FileReader","readAsBase64",fd.uid)},getResult:function(){return e8},destroy:function(){e8=null}};return(fa.FileReader=fb)});e6("moxie/runtime/flash/file/FileReaderSync",["moxie/runtime/flash/Runtime","moxie/core/utils/Encode"],function(e9,e7){function e8(fb,fc){switch(fc){case"readAsText":return e7.atob(fb,"utf8");case"readAsBinaryString":return e7.atob(fb);case"readAsDataURL":return fb}return null}var fa={read:function(fe,fd){var fb,fc=this.getRuntime();fb=fc.shimExec.call(this,"FileReaderSync","readAsBase64",fd.uid);if(!fb){return null}if(fe==="readAsDataURL"){fb="data:"+(fd.type||"")+";base64,"+fb}return e8(fb,fe,fd.type)}};return(e9.FileReaderSync=fa)});e6("moxie/runtime/flash/xhr/XMLHttpRequest",["moxie/runtime/flash/Runtime","moxie/core/utils/Basic","moxie/file/Blob","moxie/file/File","moxie/file/FileReaderSync","moxie/xhr/FormData","moxie/runtime/Transporter","moxie/core/JSON"],function(fd,e7,e9,fc,fb,ff,fa,e8){var fe={send:function(fn,fi){var fk=this,fo=fk.getRuntime();function fh(){fn.transport=fo.mode;fo.shimExec.call(fk,"XMLHttpRequest","send",fn,fi)}function fj(fq,fp){fo.shimExec.call(fk,"XMLHttpRequest","appendBlob",fq,fp.uid);fi=null;fh()}function fl(fq,fp){var fr=new fa();fr.bind("TransportingComplete",function(){fp(this.result)});fr.transport(fq.getSource(),fq.type,{ruid:fo.uid})}if(!e7.isEmptyObj(fn.headers)){e7.each(fn.headers,function(fp,fq){fo.shimExec.call(fk,"XMLHttpRequest","setRequestHeader",fq,fp.toString())})}if(fi instanceof ff){var fm;fi.each(function(fq,fp){if(fq instanceof e9){fm=fp}else{fo.shimExec.call(fk,"XMLHttpRequest","append",fp,fq)}});if(!fi.hasBlob()){fi=null;fh()}else{var fg=fi.getBlob();if(fg.isDetached()){fl(fg,function(fp){fg.destroy();fj(fm,fp)})}else{fj(fm,fg)}}}else{if(fi instanceof e9){if(fi.isDetached()){fl(fi,function(fp){fi.destroy();fi=fp.uid;fh()})}else{fi=fi.uid;fh()}}else{fh()}}},getResponse:function(fj){var fg,fi,fh=this.getRuntime();fi=fh.shimExec.call(this,"XMLHttpRequest","getResponseAsBlob");if(fi){fi=new fc(fh.uid,fi);if("blob"===fj){return fi}else{if(!!~e7.inArray(fj,["","text"])){fg=new fb();return fg.readAsText(fi)}else{if("arraybuffer"===fj){}else{if("json"===fj){fg=new fb();try{return e8(fg.readAsText(fi))}catch(fk){return null}}}}}}return null},abort:function(fh){var fg=this.getRuntime();fg.shimExec.call(this,"XMLHttpRequest","abort");this.dispatchEvent("readystatechange");this.dispatchEvent("abort");if(!fh){}}};return(fd.XMLHttpRequest=fe)});e6("moxie/runtime/flash/runtime/Transporter",["moxie/runtime/flash/Runtime","moxie/file/Blob"],function(e7,e9){var e8={getAsBlob:function(fc){var fb=this.getRuntime(),fa=fb.shimExec.call(this,"Transporter","getAsBlob",fc);if(fa){return new e9(fb.uid,fa)}return null}};return(e7.Transporter=e8)});e6("moxie/runtime/flash/image/Image",["moxie/runtime/flash/Runtime","moxie/core/utils/Basic","moxie/runtime/Transporter","moxie/file/Blob","moxie/file/FileReaderSync"],function(e8,fa,e9,fc,fb){var e7={loadFromBlob:function(fg){var ff=this,fe=ff.getRuntime();function fd(fi){fe.shimExec.call(ff,"Image","loadFromBlob",fi.uid);ff=fe=null}if(fg.isDetached()){var fh=new e9();fh.bind("TransportingComplete",function(){fd(fh.result.getSource())});fh.transport(fg.getSource(),fg.type,{ruid:fe.uid})}else{fd(fg.getSource())}},loadFromImage:function(fe){var fd=this.getRuntime();return fd.shimExec.call(this,"Image","loadFromImage",fe.uid)},getAsBlob:function(ff,fg){var fe=this.getRuntime(),fd=fe.shimExec.call(this,"Image","getAsBlob",ff,fg);if(fd){return new fc(fe.uid,fd)}return null},getAsDataURL:function(){var ff=this.getRuntime(),fe=ff.Image.getAsBlob.apply(this,arguments),fd;if(!fe){return null}fd=new fb();return fd.readAsDataURL(fe)}};return(e8.Image=e7)});e6("moxie/runtime/silverlight/Runtime",["moxie/core/utils/Basic","moxie/core/utils/Env","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/runtime/Runtime"],function(e8,fb,fa,fe,e7){var fc="silverlight",fd={};function ff(fo){var fr=false,fk=null,fg,fh,fi,fq,fj,fm=0;try{try{fk=new ActiveXObject("AgControl.AgControl");if(fk.IsVersionSupported(fo)){fr=true}fk=null}catch(fn){var fl=navigator.plugins["Silverlight Plug-In"];if(fl){fg=fl.description;if(fg==="1.0.30226.2"){fg="2.0.30226.2"}fh=fg.split(".");while(fh.length>3){fh.pop()}while(fh.length<4){fh.push(0)}fi=fo.split(".");while(fi.length>4){fi.pop()}do{fq=parseInt(fi[fm],10);fj=parseInt(fh[fm],10);fm++}while(fm<fi.length&&fq===fj);if(fq<=fj&&!isNaN(fq)){fr=true}}}}catch(fp){fr=false}return fr}function e9(fh){var fg=this,fi;fh=e8.extend({xap_url:fb.xap_url},fh);e7.call(this,fh,fc,{access_binary:e7.capTrue,access_image_binary:e7.capTrue,display_media:e7.capTrue,do_cors:e7.capTrue,drag_and_drop:false,report_upload_progress:e7.capTrue,resize_image:e7.capTrue,return_response_headers:function(fj){return fj&&fg.mode==="client"},return_response_type:e7.capTrue,return_status_code:function(fj){return fg.mode==="client"||!e8.arrayDiff(fj,[200,404])},select_file:e7.capTrue,select_multiple:e7.capTrue,send_binary_string:e7.capTrue,send_browser_cookies:function(fj){return fj&&fg.mode==="browser"},send_custom_headers:function(fj){return fj&&fg.mode==="client"},send_multipart:e7.capTrue,slice_blob:e7.capTrue,stream_upload:true,summon_file_dialog:false,upload_filesize:e7.capTrue,use_http_method:function(fj){return fg.mode==="client"||!e8.arrayDiff(fj,["GET","POST"])}},{return_response_headers:function(fj){return fj?"client":"browser"},return_status_code:function(fj){return e8.arrayDiff(fj,[200,404])?"client":["client","browser"]},send_browser_cookies:function(fj){return fj?"browser":"client"},send_custom_headers:function(fj){return fj?"client":"browser"},use_http_method:function(fj){return e8.arrayDiff(fj,["GET","POST"])?"client":["client","browser"]}});if(!ff("2.0.31005.0")||fb.browser==="Opera"){this.mode=false}e8.extend(this,{getShim:function(){return fa.get(this.uid).content.Moxie},shimExec:function(fk,fl){var fj=[].slice.call(arguments,2);return fg.getShim().exec(this.uid,fk,fl,fj)},init:function(){var fj;fj=this.getShimContainer();fj.innerHTML='<object id="'+this.uid+'" data="data:application/x-silverlight," type="application/x-silverlight-2" width="100%" height="100%" style="outline:none;"><param name="source" value="'+fh.xap_url+'"/><param name="background" value="Transparent"/><param name="windowless" value="true"/><param name="enablehtmlaccess" value="true"/><param name="initParams" value="uid='+this.uid+",target="+fb.global_event_dispatcher+'"/></object>';fi=setTimeout(function(){if(fg&&!fg.initialized){fg.trigger("Error",new fe.RuntimeError(fe.RuntimeError.NOT_INIT_ERR))}},fb.OS!=="Windows"?10000:5000)},destroy:(function(fj){return function(){fj.call(fg);clearTimeout(fi);fh=fi=fj=fg=null}}(this.destroy))},fd)}e7.addConstructor(fc,e9);return fd});e6("moxie/runtime/silverlight/file/Blob",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/file/Blob"],function(e7,e8,e9){return(e7.Blob=e8.extend({},e9))});e6("moxie/runtime/silverlight/file/FileInput",["moxie/runtime/silverlight/Runtime"],function(e7){var e8={init:function(fa){function e9(fc){var fd="";for(var fb=0;fb<fc.length;fb++){fd+=(fd!==""?"|":"")+fc[fb].title+" | *."+fc[fb].extensions.replace(/,/g,";*.")}return fd}this.getRuntime().shimExec.call(this,"FileInput","init",e9(fa.accept),fa.name,fa.multiple);this.trigger("ready")}};return(e7.FileInput=e8)});e6("moxie/runtime/silverlight/file/FileDrop",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Dom","moxie/core/utils/Events"],function(e9,e8,e7){var fa={init:function(){var fc=this,fb=fc.getRuntime(),fd;fd=fb.getShimContainer();e7.addEvent(fd,"dragover",function(fe){fe.preventDefault();fe.stopPropagation();fe.dataTransfer.dropEffect="copy"},fc.uid);e7.addEvent(fd,"dragenter",function(ff){ff.preventDefault();var fe=e8.get(fb.uid).dragEnter(ff);if(fe){ff.stopPropagation()}},fc.uid);e7.addEvent(fd,"drop",function(ff){ff.preventDefault();var fe=e8.get(fb.uid).dragDrop(ff);if(fe){ff.stopPropagation()}},fc.uid);return fb.shimExec.call(this,"FileDrop","init")}};return(e9.FileDrop=fa)});e6("moxie/runtime/silverlight/file/FileReader",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/file/FileReader"],function(e7,e9,e8){return(e7.FileReader=e9.extend({},e8))});e6("moxie/runtime/silverlight/file/FileReaderSync",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/file/FileReaderSync"],function(e7,e8,e9){return(e7.FileReaderSync=e8.extend({},e9))});e6("moxie/runtime/silverlight/xhr/XMLHttpRequest",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/xhr/XMLHttpRequest"],function(e7,e9,e8){return(e7.XMLHttpRequest=e9.extend({},e8))});e6("moxie/runtime/silverlight/runtime/Transporter",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/runtime/Transporter"],function(e7,e9,e8){return(e7.Transporter=e9.extend({},e8))});e6("moxie/runtime/silverlight/image/Image",["moxie/runtime/silverlight/Runtime","moxie/core/utils/Basic","moxie/runtime/flash/image/Image"],function(e8,e9,e7){return(e8.Image=e9.extend({},e7))});e6("moxie/runtime/html4/Runtime",["moxie/core/utils/Basic","moxie/core/Exceptions","moxie/runtime/Runtime","moxie/core/utils/Env"],function(fd,e7,fa,e9){var fc="html4",fb={};function e8(ff){var fe=this,fh=fa.capTest,fg=fa.capTrue;fa.call(this,ff,fc,{access_binary:fh(window.FileReader||window.File&&File.getAsDataURL),access_image_binary:false,display_media:fh(fb.Image&&(e9.can("create_canvas")||e9.can("use_data_uri_over32kb"))),do_cors:false,drag_and_drop:false,filter_by_extension:fh(function(){return(e9.browser==="Chrome"&&e9.version>=28)||(e9.browser==="IE"&&e9.version>=10)}()),resize_image:function(){return fb.Image&&fe.can("access_binary")&&e9.can("create_canvas")},report_upload_progress:false,return_response_headers:false,return_response_type:function(fi){return !!~fd.inArray(fi,["json","text","document",""])},return_status_code:function(fi){return !fd.arrayDiff(fi,[200,404])},select_file:function(){return e9.can("use_fileinput")},select_multiple:false,send_binary_string:false,send_custom_headers:false,send_multipart:true,slice_blob:false,stream_upload:function(){return fe.can("select_file")},summon_file_dialog:fh(function(){return(e9.browser==="Firefox"&&e9.version>=4)||(e9.browser==="Opera"&&e9.version>=12)||(e9.browser==="IE"&&e9.version>=10)||!!~fd.inArray(e9.browser,["Chrome","Safari"])}()),upload_filesize:fg,use_http_method:function(fi){return !fd.arrayDiff(fi,["GET","POST"])}});fd.extend(this,{init:function(){this.trigger("Init")},destroy:(function(fi){return function(){fi.call(fe);fi=fe=null}}(this.destroy))});fd.extend(this.getShim(),fb)}fa.addConstructor(fc,e8);return fb});e6("moxie/runtime/html4/file/FileInput",["moxie/runtime/html4/Runtime","moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/utils/Events","moxie/core/utils/Mime","moxie/core/utils/Env"],function(fb,fd,fa,e8,e9,e7){function fc(){var fh,ff=[],fi=[],fe;function fg(){var fl=this,fo=fl.getRuntime(),fn,fm,fj,fq,fk,fp;fp=fd.guid("uid_");fn=fo.getShimContainer();if(fh){fj=fa.get(fh+"_form");if(fj){fd.extend(fj.style,{top:"100%"})}}fq=document.createElement("form");fq.setAttribute("id",fp+"_form");fq.setAttribute("method","post");fq.setAttribute("enctype","multipart/form-data");fq.setAttribute("encoding","multipart/form-data");fd.extend(fq.style,{overflow:"hidden",position:"absolute",top:0,left:0,width:"100%",height:"100%"});fk=document.createElement("input");fk.setAttribute("id",fp);fk.setAttribute("type","file");fk.setAttribute("name","Filedata");fk.setAttribute("accept",fi.join(","));fd.extend(fk.style,{fontSize:"999px",opacity:0});fq.appendChild(fk);fn.appendChild(fq);fd.extend(fk.style,{position:"absolute",top:0,left:0,width:"100%",height:"100%"});if(e7.browser==="IE"&&e7.version<10){fd.extend(fk.style,{filter:"progid:DXImageTransform.Microsoft.Alpha(opacity=0)"})}fk.onchange=function(){var fr;if(!this.value){return}if(this.files){fr=this.files[0]}else{fr={name:this.value}}ff=[fr];this.onchange=function(){};fg.call(fl);fl.bind("change",function(){var fs=fa.get(fp),fu=fa.get(fp+"_form"),ft;if(fl.files.length&&fs&&fu){ft=fl.files[0];fs.setAttribute("id",ft.uid);fu.setAttribute("id",ft.uid+"_form");fu.setAttribute("target",ft.uid+"_iframe")}fs=fu=null},998);fk=fq=null;fl.trigger("change")};if(fo.can("summon_file_dialog")){fm=fa.get(fe.browse_button);e8.removeEvent(fm,"click",fl.uid);e8.addEvent(fm,"click",function(fr){if(fk&&!fk.disabled){fk.click()}fr.preventDefault()},fl.uid)}fh=fp;fn=fj=fm=null;fl.trigger({type:"ready",async:true})}fd.extend(this,{init:function(fm){var fj=this,fl=fj.getRuntime(),fk;fe=fm;fi=fm.accept.mimes||e9.extList2mimes(fm.accept,fl.can("filter_by_extension"));fk=fl.getShimContainer();(function(){var fn,fp,fo;fn=fa.get(fm.browse_button);if(fl.can("summon_file_dialog")){if(fa.getStyle(fn,"position")==="static"){fn.style.position="relative"}fp=parseInt(fa.getStyle(fn,"z-index"),10)||1;fn.style.zIndex=fp;fk.style.zIndex=fp-1}fo=fl.can("summon_file_dialog")?fn:fk;e8.addEvent(fo,"mouseover",function(){fj.trigger("mouseenter")},fj.uid);e8.addEvent(fo,"mouseout",function(){fj.trigger("mouseleave")},fj.uid);e8.addEvent(fo,"mousedown",function(){fj.trigger("mousedown")},fj.uid);e8.addEvent(fa.get(fm.container),"mouseup",function(){fj.trigger("mouseup")},fj.uid);fn=null}());fg.call(this);fk=null},getFiles:function(){return ff},disable:function(fk){var fj;if((fj=fa.get(fh))){fj.disabled=!!fk}},destroy:function(){var fk=this.getRuntime(),fj=fk.getShimContainer();e8.removeAllEvents(fj,this.uid);e8.removeAllEvents(fe&&fa.get(fe.container),this.uid);e8.removeAllEvents(fe&&fa.get(fe.browse_button),this.uid);if(fj){fj.innerHTML=""}fh=ff=fi=fe=null}})}return(fb.FileInput=fc)});e6("moxie/runtime/html4/file/FileReader",["moxie/runtime/html4/Runtime","moxie/runtime/html5/file/FileReader"],function(e7,e8){return(e7.FileReader=e8)});e6("moxie/runtime/html4/xhr/XMLHttpRequest",["moxie/runtime/html4/Runtime","moxie/core/utils/Basic","moxie/core/utils/Dom","moxie/core/utils/Url","moxie/core/Exceptions","moxie/core/utils/Events","moxie/file/Blob","moxie/xhr/FormData","moxie/core/JSON"],function(fc,e8,fb,e7,fd,ff,fa,fg,e9){function fe(){var fj,fh,fk;function fi(fl){var fq=this,fo,fp,fm,fn,fr=false;if(!fk){return}fo=fk.id.replace(/_iframe$/,"");fp=fb.get(fo+"_form");if(fp){fm=fp.getElementsByTagName("input");fn=fm.length;while(fn--){switch(fm[fn].getAttribute("type")){case"hidden":fm[fn].parentNode.removeChild(fm[fn]);break;case"file":fr=true;break}}fm=[];if(!fr){fp.parentNode.removeChild(fp)}fp=null}setTimeout(function(){ff.removeEvent(fk,"load",fq.uid);if(fk.parentNode){fk.parentNode.removeChild(fk)}var fs=fq.getRuntime().getShimContainer();if(!fs.children.length){fs.parentNode.removeChild(fs)}fs=fk=null;fl()},1)}e8.extend(this,{send:function(ft,fn){var fp=this,fs=fp.getRuntime(),fo,fm,fr,fl;fj=fh=null;function fq(){var fu=fs.getShimContainer()||document.body,fv=document.createElement("div");fv.innerHTML='<iframe id="'+fo+'_iframe" name="'+fo+'_iframe" src="javascript:&quot;&quot;" style="display:none"></iframe>';fk=fv.firstChild;fu.appendChild(fk);ff.addEvent(fk,"load",function(){var fx;try{fx=fk.contentWindow.document||fk.contentDocument||window.frames[fk.id].document;if(/^4\d{2}\s/.test(fx.title)&&fx.getElementsByTagName("address").length){fj=fx.title.replace(/^(\d+).*$/,"$1")}else{fj=200;fh=e8.trim(fx.body.innerHTML);fp.trigger({type:"progress",loaded:fh.length,total:fh.length});if(fl){fp.trigger({type:"uploadprogress",loaded:fl.size||1025,total:fl.size||1025})}}}catch(fw){if(e7.hasSameOrigin(ft.url)){fj=404}else{fi.call(fp,function(){fp.trigger("error")});return}}fi.call(fp,function(){fp.trigger("load")})},fp.uid)}if(fn instanceof fg&&fn.hasBlob()){fl=fn.getBlob();fo=fl.uid;fr=fb.get(fo);fm=fb.get(fo+"_form");if(!fm){throw new fd.DOMException(fd.DOMException.NOT_FOUND_ERR)}}else{fo=e8.guid("uid_");fm=document.createElement("form");fm.setAttribute("id",fo+"_form");fm.setAttribute("method",ft.method);fm.setAttribute("enctype","multipart/form-data");fm.setAttribute("encoding","multipart/form-data");fm.setAttribute("target",fo+"_iframe");fs.getShimContainer().appendChild(fm)}if(fn instanceof fg){fn.each(function(fw,fu){if(fw instanceof fa){if(fr){fr.setAttribute("name",fu)}}else{var fv=document.createElement("input");e8.extend(fv,{type:"hidden",name:fu,value:fw});fm.appendChild(fv)}})}fm.setAttribute("action",ft.url);fq();fm.submit();fp.trigger("loadstart")},getStatus:function(){return fj},getResponse:function(fl){if("json"===fl){if(e8.typeOf(fh)==="string"){try{return e9(fh.replace(/^\s*<pre[^>]*>/,"").replace(/<\/pre>\s*$/,""))}catch(fm){return null}}}else{if("document"===fl){}}return fh},abort:function(){var fl=this;if(fk&&fk.contentWindow){if(fk.contentWindow.stop){fk.contentWindow.stop()}else{if(fk.contentWindow.document.execCommand){fk.contentWindow.document.execCommand("Stop")}else{fk.src="about:blank"}}}fi.call(this,function(){fl.dispatchEvent("abort")})}})}return(fc.XMLHttpRequest=fe)});e6("moxie/runtime/html4/image/Image",["moxie/runtime/html4/Runtime","moxie/runtime/html5/image/Image"],function(e8,e7){return(e8.Image=e7)});T(["moxie/core/utils/Basic","moxie/core/I18n","moxie/core/utils/Mime","moxie/core/utils/Env","moxie/core/utils/Dom","moxie/core/Exceptions","moxie/core/EventTarget","moxie/core/utils/Encode","moxie/runtime/Runtime","moxie/runtime/RuntimeClient","moxie/file/Blob","moxie/file/File","moxie/file/FileInput","moxie/file/FileDrop","moxie/runtime/RuntimeTarget","moxie/file/FileReader","moxie/core/utils/Url","moxie/file/FileReaderSync","moxie/xhr/FormData","moxie/xhr/XMLHttpRequest","moxie/runtime/Transporter","moxie/core/JSON","moxie/image/Image","moxie/core/utils/Events"])})(this);(function(){var e1={},e0=moxie.core.utils.Basic.inArray;(function T(e3){var e2,e4;for(e2 in e3){e4=typeof(e3[e2]);if(e4==="object"&&!~e0(e2,["Exceptions","Env","Mime"])){T(e3[e2])}else{if(e4==="function"){e1[e2]=e3[e2]}}}})(window.moxie);e1.Env=window.moxie.core.utils.Env;e1.Mime=window.moxie.core.utils.Mime;e1.Exceptions=window.moxie.core.Exceptions;window.mOxie=e1;if(!window.o){window.o=e1}return e1})();(function(e3,e5,e2){var e1=e3.setTimeout,e4={};function T(e7){var e6=e7.required_features,e8={};function e9(fb,fc,fa){var fd={chunks:"slice_blob",resize:"send_binary_string",jpgresize:"send_binary_string",pngresize:"send_binary_string",progress:"report_upload_progress",multi_selection:"select_multiple",max_file_size:"access_binary",dragdrop:"drag_and_drop",drop_element:"drag_and_drop",headers:"send_custom_headers",canSendBinary:"send_binary",triggerDialog:"summon_file_dialog"};if(fd[fb]){e8[fd[fb]]=fc}else{if(!fa){e8[fb]=fc}}}if(typeof(e6)==="string"){e0.each(e6.split(/\s*,\s*/),function(fa){e9(fa,true)})}else{if(typeof(e6)==="object"){e0.each(e6,function(fb,fa){e9(fa,fb)})}else{if(e6===true){if(!e7.multipart){e8.send_binary_string=true}if(e7.chunk_size>0){e8.slice_blob=true}e0.each(e7,function(fb,fa){e9(fa,!!fb,true)})}}}return e8}var e0={VERSION:"2.0.0beta",STOPPED:1,STARTED:2,QUEUED:1,UPLOADING:2,FAILED:4,DONE:5,GENERIC_ERROR:-100,HTTP_ERROR:-200,IO_ERROR:-300,SECURITY_ERROR:-400,INIT_ERROR:-500,FILE_SIZE_ERROR:-600,FILE_EXTENSION_ERROR:-601,FILE_DUPLICATE_ERROR:-602,IMAGE_FORMAT_ERROR:-700,IMAGE_MEMORY_ERROR:-701,IMAGE_DIMENSIONS_ERROR:-702,mimeTypes:e5.mimes,ua:e5.ua,typeOf:e5.typeOf,extend:e5.extend,guid:e5.guid,each:e5.each,getPos:e5.getPos,getSize:e5.getSize,xmlEncode:function(e7){var e8={"<":"lt",">":"gt","&":"amp",'"':"quot","'":"#39"},e6=/[<>&\"\']/g;return e7?(""+e7).replace(e6,function(e9){return e8[e9]?"&"+e8[e9]+";":e9}):e7},toArray:e5.toArray,inArray:e5.inArray,addI18n:e5.addI18n,translate:e5.translate,isEmptyObj:e5.isEmptyObj,hasClass:e5.hasClass,addClass:e5.addClass,removeClass:e5.removeClass,getStyle:e5.getStyle,addEvent:e5.addEvent,removeEvent:e5.removeEvent,removeAllEvents:e5.removeAllEvents,cleanName:function(e6){var e7,e8;e8=[/[\300-\306]/g,"A",/[\340-\346]/g,"a",/\307/g,"C",/\347/g,"c",/[\310-\313]/g,"E",/[\350-\353]/g,"e",/[\314-\317]/g,"I",/[\354-\357]/g,"i",/\321/g,"N",/\361/g,"n",/[\322-\330]/g,"O",/[\362-\370]/g,"o",/[\331-\334]/g,"U",/[\371-\374]/g,"u"];for(e7=0;e7<e8.length;e7+=2){e6=e6.replace(e8[e7],e8[e7+1])}e6=e6.replace(/\s+/g,"_");e6=e6.replace(/[^a-z0-9_\-\.]+/gi,"");return e6},buildUrl:function(e7,e6){var e8="";e0.each(e6,function(fa,e9){e8+=(e8?"&":"")+encodeURIComponent(e9)+"="+encodeURIComponent(fa)});if(e8){e7+=(e7.indexOf("?")>0?"&":"?")+e8}return e7},formatSize:function(e6){if(e6===e2||/\D/.test(e6)){return e0.translate("N/A")}if(e6>1099511627776){return Math.round(e6/1099511627776,1)+" "+e0.translate("tb")}if(e6>1073741824){return Math.round(e6/1073741824,1)+" "+e0.translate("gb")}if(e6>1048576){return Math.round(e6/1048576,1)+" "+e0.translate("mb")}if(e6>1024){return Math.round(e6/1024,1)+" "+e0.translate("kb")}return e6+" "+e0.translate("b")},parseSize:e5.parseSizeStr,predictRuntime:function(e8,e7){var e6,e9;if(e7){e8.runtimes=e7}e6=new e0.Uploader(e8);e9=e6.runtime;e6.destroy();return e9},addFileFilter:function(e7,e6){e4[e7]=e6}};e0.addFileFilter("mime_types",(function(){var e7,e8;function e6(e9){var fa=[];e0.each(e9,function(fb){e0.each(fb.extensions.split(/,/),function(fc){if(/^\s*\*\s*$/.test(fc)){fa.push("\\.*")}else{fa.push("\\."+fc.replace(new RegExp("["+("/^$.*+?|()[]{}\\".replace(/./g,"\\$&"))+"]","g"),"\\$&"))}})});return new RegExp("("+fa.join("|")+")$","i")}return function(fb,fa,e9){if(!e8||fb!=e7){e8=e6(fb);e7=[].slice.call(fb)}if(!e8.test(fa.name)){this.trigger("Error",{code:e0.FILE_EXTENSION_ERROR,message:e0.translate("File extension error."),file:fa});e9(false)}else{e9(true)}}}()));e0.addFileFilter("max_file_size",function(e9,e7,e6){var e8;if(e7.size!==e8&&e9&&e7.size>e9){this.trigger("Error",{code:e0.FILE_SIZE_ERROR,message:e0.translate("File size error."),file:e7});e6(false)}else{e6(true)}});e0.addFileFilter("prevent_duplicates",function(e9,e7,e6){if(e9){var e8=this.files.length;while(e8--){if(e7.name===this.files[e8].name&&e7.size===this.files[e8].size){this.trigger("Error",{code:e0.FILE_DUPLICATE_ERROR,message:e0.translate("Duplicate file error."),file:e7});e6(false);return}}}e6(true)});e0.Uploader=function(fa){var e7=[],fk={},fh={},e9,ff,fc=false,fd,fe,fj;function e8(){var fn,fo=0,fm;if(this.state==e0.STARTED){for(fm=0;fm<e7.length;fm++){if(!fn&&e7[fm].status==e0.QUEUED){fn=e7[fm];if(this.trigger("BeforeUpload",fn)){fn.status=e0.UPLOADING;this.trigger("UploadFile",fn)}}else{fo++}}if(fo==e7.length){if(this.state!==e0.STOPPED){this.state=e0.STOPPED;this.trigger("StateChanged")}this.trigger("UploadComplete",e7)}}}function fi(fm){fm.percent=fm.size>0?Math.ceil(fm.loaded/fm.size*100):100;fb()}function fb(){var fn,fm;ff.reset();for(fn=0;fn<e7.length;fn++){fm=e7[fn];if(fm.size!==e2){ff.size+=fm.origSize;ff.loaded+=fm.loaded*fm.origSize/fm.size}else{ff.size=e2}if(fm.status==e0.DONE){ff.uploaded++}else{if(fm.status==e0.FAILED){ff.failed++}else{ff.queued++}}}if(ff.size===e2){ff.percent=e7.length>0?Math.ceil(ff.uploaded/e7.length*100):0}else{ff.bytesPerSec=Math.ceil(ff.loaded/((+new Date()-e9||1)/1000));ff.percent=ff.size>0?Math.ceil(ff.loaded/ff.size*100):0}}function e6(){var fm=this,fo=0;var fn={accept:fa.filters.mime_types,runtime_order:fa.runtimes,required_caps:fh,swf_url:fa.flash_swf_url,xap_url:fa.silverlight_xap_url};e0.each(fa.runtimes.split(/\s*,\s*/),function(fp){if(fa[fp]){fn[fp]=fa[fp]}});e5.inSeries([function(fp){if(fa.browse_button){fd=new e5.FileInput(e0.extend({},fn,{name:fa.file_data_name,multiple:fa.multi_selection,container:fa.container,browse_button:fa.browse_button}));fd.onready=function(){var fq=e5.Runtime.getInfo(this.ruid);e5.extend(fm.features,{chunks:fq.can("slice_blob"),multipart:fq.can("send_multipart"),multi_selection:fq.can("select_multiple")});fo++;fp()};fd.onchange=function(){fm.addFile(this.files)};fd.bind("mouseenter mouseleave mousedown mouseup",function(fr){if(!fc){var fq=e5.get(fa.browse_button);if(fq){if(fa.browse_button_hover){if("mouseenter"===fr.type){e5.addClass(fq,fa.browse_button_hover)}else{if("mouseleave"===fr.type){e5.removeClass(fq,fa.browse_button_hover)}}}if(fa.browse_button_active){if("mousedown"===fr.type){e5.addClass(fq,fa.browse_button_active)}else{if("mouseup"===fr.type){e5.removeClass(fq,fa.browse_button_active)}}}fq=null}}});fd.bind("error runtimeerror",function(){fd=null;fp()});fd.init()}else{fp()}},function(fp){if(fa.drop_element){fe=new e5.FileDrop(e0.extend({},fn,{drop_zone:fa.drop_element}));fe.onready=function(){var fq=e5.Runtime.getInfo(this.ruid);fm.features.dragdrop=fq.can("drag_and_drop");fo++;fp()};fe.ondrop=function(){fm.addFile(this.files)};fe.bind("error runtimeerror",function(){fe=null;fp()});fe.init()}else{fp()}}],function(){if(typeof(fa.init)=="function"){fa.init(fm)}else{e0.each(fa.init,function(fq,fp){fm.bind(fp,fq)})}if(fo){fm.trigger("PostInit")}else{fm.trigger("Error",{code:e0.INIT_ERROR,message:e0.translate("Init error.")})}})}function fl(fn,fm){if(fn.ruid){var fo=e5.Runtime.getInfo(fn.ruid);if(fo){return fo.can(fm)}}return false}function fg(fo,fq,fm){var fn=new e5.Image();try{fn.onload=function(){fn.downsize(fq.width,fq.height,fq.crop,fq.preserve_headers)};fn.onresize=function(){fm(this.getAsBlob(fo.type,fq.quality));this.destroy()};fn.onerror=function(){fm(fo)};fn.load(fo)}catch(fp){fm(fo)}}ff=new e0.QueueProgress();fa=e0.extend({runtimes:e5.Runtime.order,max_retries:0,multipart:true,multi_selection:true,file_data_name:"file",flash_swf_url:"js/Moxie.swf",silverlight_xap_url:"js/Moxie.xap",send_chunk_number:true},fa);if(fa.resize){fa.resize=e0.extend({preserve_headers:true,crop:false},fa.resize)}if(e0.typeOf(fa.filters)==="array"){fa.filters={mime_types:fa.filters}}fa.filters=e0.extend({mime_types:[],prevent_duplicates:!!fa.prevent_duplicates,max_file_size:fa.max_file_size},fa.filters);fa.filters.max_file_size=e0.parseSize(fa.filters.max_file_size)||0;fa.chunk_size=e0.parseSize(fa.chunk_size)||0;fa.required_features=fh=T(e0.extend({},fa));e0.extend(this,{id:e0.guid(),state:e0.STOPPED,features:{},runtime:e5.Runtime.thatCan(fh,fa.runtimes),files:e7,settings:fa,total:ff,init:function(){var fm=this;fa.browse_button=e5.get(fa.browse_button);fa.drop_element=e5.get(fa.drop_element);if(typeof(fa.preinit)=="function"){fa.preinit(fm)}else{e0.each(fa.preinit,function(fo,fn){fm.bind(fn,fo)})}if(!fa.browse_button||!fa.url){this.trigger("Error",{code:e0.INIT_ERROR,message:e0.translate("Init error.")});return}fm.bind("FilesAdded",function(fo,fn){[].push.apply(e7,fn);e1(function(){fm.trigger("QueueChanged");fm.refresh()},1)});fm.bind("CancelUpload",function(){if(fj){fj.abort()}});if(fa.unique_names){fm.bind("BeforeUpload",function(fn,fo){var fq=fo.name.match(/\.([^.]+)$/),fp="part";if(fq){fp=fq[1]}fo.target_name=fo.id+"."+fp})}fm.bind("UploadFile",function(fv,fs){var fp=fv.settings.url,fq=fv.features,ft=fa.chunk_size,fw=fa.max_retries,fn,fu=0;if(fs.loaded){fu=fs.loaded=ft*Math.floor(fs.loaded/ft)}function fr(){if(fw-->0){e1(fo,1)}else{fs.loaded=fu;fv.trigger("Error",{code:e0.HTTP_ERROR,message:e0.translate("HTTP Error."),file:fs,response:fj.responseText,status:fj.status,responseHeaders:fj.getAllResponseHeaders()})}}function fo(){var fz,fy,fx,fA;if(fs.status==e0.DONE||fs.status==e0.FAILED||fv.state==e0.STOPPED){return}fx={name:fs.target_name||fs.name};if(ft&&fq.chunks&&fn.size>ft){fA=Math.min(ft,fn.size-fu);fz=fn.slice(fu,fu+fA)}else{fA=fn.size;fz=fn}if(ft&&fq.chunks){if(fa.send_chunk_number){fx.chunk=Math.ceil(fu/ft);fx.chunks=Math.ceil(fn.size/ft)}else{fx.offset=fu;fx.total=fn.size}}else{fx.chunk=0;fx.chunks=1}fj=new e5.XMLHttpRequest();fj.withCredentials=true;if(fj.upload){fj.upload.onprogress=function(fB){fs.loaded=Math.min(fs.size,fu+fB.loaded);fv.trigger("UploadProgress",fs)}}fj.onload=function(){if(fj.status>=400){fr();return}if(fA<fn.size){fz.destroy();fu+=fA;fs.loaded=Math.min(fu,fn.size);fv.trigger("ChunkUploaded",fs,{offset:fs.loaded,total:fn.size,response:fj.responseText,status:fj.status,responseHeaders:fj.getAllResponseHeaders()});if(e5.Env.browser==="Android Browser"){fv.trigger("UploadProgress",fs)}}else{fs.loaded=fs.size}fz=fy=null;if(!fu||fu>=fn.size){if(fs.size!=fs.origSize){fn.destroy();fn=null}fv.trigger("UploadProgress",fs);fs.status=e0.DONE;fv.trigger("FileUploaded",fs,{response:fj.responseText,status:fj.status,responseHeaders:fj.getAllResponseHeaders()})}else{fw=fa.max_retries;e1(fo,1)}};fj.onerror=function(){fr()};fj.onloadend=function(){this.destroy();fj=null};if(fv.settings.multipart&&fq.multipart){fx.name=fs.target_name||fs.name;fj.open("post",fp,true);e0.each(fv.settings.headers,function(fC,fB){fj.setRequestHeader(fB,fC)});fy=new e5.FormData();e0.each(e0.extend(fx,fv.settings.multipart_params),function(fC,fB){fy.append(fB,fC)});fy.append(fv.settings.file_data_name,fz);fj.send(fy,{runtime_order:fv.settings.runtimes,required_caps:fh,swf_url:fv.settings.flash_swf_url,xap_url:fv.settings.silverlight_xap_url})}else{fp=e0.buildUrl(fv.settings.url,e0.extend(fx,fv.settings.multipart_params));fj.open("post",fp,true);fj.setRequestHeader("Content-Type","application/octet-stream");e0.each(fv.settings.headers,function(fC,fB){fj.setRequestHeader(fB,fC)});fj.send(fz,{runtime_order:fv.settings.runtimes,required_caps:fh,swf_url:fv.settings.flash_swf_url,xap_url:fv.settings.silverlight_xap_url})}}fn=fs.getSource();if(!e5.isEmptyObj(fv.settings.resize)&&fl(fn,"send_binary_string")&&!!~e5.inArray(fn.type,["image/jpeg","image/png"])){fg.call(this,fn,fv.settings.resize,function(fx){fn=fx;fs.size=fx.size;fo()})}else{fo()}});fm.bind("UploadProgress",function(fn,fo){fi(fo)});fm.bind("StateChanged",function(fn){if(fn.state==e0.STARTED){e9=(+new Date())}else{if(fn.state==e0.STOPPED){for(var fo=fn.files.length-1;fo>=0;fo--){if(fn.files[fo].status==e0.UPLOADING){fn.files[fo].status=e0.QUEUED;fb()}}}}});fm.bind("QueueChanged",fb);fm.bind("Error",function(fn,fo){if(fo.file){fo.file.status=e0.FAILED;fi(fo.file);if(fn.state==e0.STARTED){e1(function(){e8.call(fm)},1)}}});fm.bind("FileUploaded",function(){fb();e1(function(){e8.call(fm)},1)});fm.trigger("Init",{runtime:this.runtime});e6.call(this)},refresh:function(){if(fd){fd.trigger("Refresh")}this.trigger("Refresh")},start:function(){if(this.state!=e0.STARTED){this.state=e0.STARTED;this.trigger("StateChanged");e8.call(this)}},stop:function(){if(this.state!=e0.STOPPED){this.state=e0.STOPPED;this.trigger("StateChanged");this.trigger("CancelUpload")}},disableBrowse:function(){fc=arguments[0]!==e2?arguments[0]:true;if(fd){fd.disable(fc)}this.trigger("DisableBrowse",fc)},getFile:function(fn){var fm;for(fm=e7.length-1;fm>=0;fm--){if(e7[fm].id===fn){return e7[fm]}}},addFile:function(fn,fo){var ft=this,fq=[],fm=[],fs;function fp(){var fv=fe||fd;if(fv){return fv.getRuntime().uid}return false}function fr(fx,fw){var fv=[];e5.each(ft.settings.filters,function(fz,fy){if(e4[fy]){fv.push(function(fA){e4[fy].call(ft,fz,fx,function(fB){fA(!fB)})})}});e5.inSeries(fv,fw)}function fu(fv){var fw=e5.typeOf(fv);if(fv instanceof e5.File){if(!fv.ruid&&!fv.isDetached()){if(!fs){return false}fv.ruid=fs;fv.connectRuntime(fs)}fu(new e0.File(fv))}else{if(fv instanceof e5.Blob){fu(fv.getSource());fv.destroy()}else{if(fv instanceof e0.File){if(fo){fv.name=fo}fq.push(function(fx){fr(fv,function(fy){if(!fy){fm.push(fv)}fx()})})}else{if(e5.inArray(fw,["file","blob"])!==-1){fu(new e5.File(null,fv))}else{if(fw==="node"&&e5.typeOf(fv.files)==="filelist"){e5.each(fv.files,fu)}else{if(fw==="array"){fo=null;e5.each(fv,fu)}}}}}}}fs=fp();fu(fn);if(fq.length){e5.inSeries(fq,function(){if(fm.length){ft.trigger("FilesAdded",fm)}})}},removeFile:function(fn){var fo=typeof(fn)==="string"?fn:fn.id;for(var fm=e7.length-1;fm>=0;fm--){if(e7[fm].id===fo){return this.splice(fm,1)[0]}}},splice:function(fo,fm){var fn=e7.splice(fo===e2?0:fo,fm===e2?e7.length:fm);this.trigger("FilesRemoved",fn);this.trigger("QueueChanged");e0.each(fn,function(fp){fp.destroy()});return fn},trigger:function(fn){var fp=fk[fn.toLowerCase()],fo,fm;if(fp){fm=Array.prototype.slice.call(arguments);fm[0]=this;for(fo=0;fo<fp.length;fo++){if(fp[fo].func.apply(fp[fo].scope,fm)===false){return false}}}return true},hasEventListener:function(fm){return !!fk[fm.toLowerCase()]},bind:function(fm,fo,fn){var fp;fm=fm.toLowerCase();fp=fk[fm]||[];fp.push({func:fo,scope:fn||this});fk[fm]=fp},unbind:function(fm){fm=fm.toLowerCase();var fp=fk[fm],fn,fo=arguments[1];if(fp){if(fo!==e2){for(fn=fp.length-1;fn>=0;fn--){if(fp[fn].func===fo){fp.splice(fn,1);break}}}else{fp=[]}if(!fp.length){delete fk[fm]}}},unbindAll:function(){var fm=this;e0.each(fk,function(fo,fn){fm.unbind(fn)})},destroy:function(){this.stop();e0.each(e7,function(fm){fm.destroy()});e7=[];if(fd){fd.destroy();fd=null}if(fe){fe.destroy();fe=null}fh={};e9=ff=fc=fj=null;this.trigger("Destroy");this.unbindAll();fk={}}})};e0.File=(function(){var e7={};function e6(e8){e0.extend(this,{id:e0.guid(),name:e8.name||e8.fileName,type:e8.type||"",size:e8.size||e8.fileSize,origSize:e8.size||e8.fileSize,loaded:0,percent:0,status:e0.QUEUED,lastModifiedDate:e8.lastModifiedDate||(new Date()).toLocaleString(),getNative:function(){var e9=this.getSource().getSource();return e5.inArray(e5.typeOf(e9),["blob","file"])!==-1?e9:null},getSource:function(){if(!e7[this.id]){return null}return e7[this.id]},destroy:function(){var e9=this.getSource();if(e9){e9.destroy();delete e7[this.id]}}});e7[this.id]=e8}return e6}());e0.QueueProgress=function(){var e6=this;e6.size=0;e6.loaded=0;e6.uploaded=0;e6.failed=0;e6.queued=0;e6.percent=0;e6.bytesPerSec=0;e6.reset=function(){e6.size=e6.loaded=e6.uploaded=e6.failed=e6.queued=e6.percent=e6.bytesPerSec=0}};e3.plupload=e0}(window,mOxie));var ep,al,cP,dE,cq,dO,bi,bB=[].indexOf||function(e1){for(var e0=0,T=this.length;e0<T;e0++){if(e0 in this&&this[e0]===e1){return e0}}return -1};cq=INLINE_JS.Upload=B.Upload={QUEUE_EVT:"db:upload:queue",QUEUE_ERROR_EVT:"db:upload:queue_error",UPDATE_EVT:"db:upload:update",COMPLETE_EVT:"db:upload:complete",ERROR_EVT:"db:upload:error",CANCEL_EVT:"db:upload:cancel",CHOOSE_FILE_BASIC:"db:upload:choose_file_basic",APPLE_PACKAGE_EXTENSIONS:["pages","key","app","numbers","band","photolibrary","rcproject","rtfd","graffle","logic","logicx","lpdf","sketch","screenflow","scriv","dvdproj","mindnode","cmproj","xcodeproj","imovielibrary","mpkg","imovieproject","1password","agilekeychain","fcpbundle","abbu","mindnode","theater","gameproj","aplibrary","itlp","lrdata","ydevice","bundle","framework","plugin","kext","pkg"],APPLE_PACKAGE_ERROR:-54321,current_dest:"",runtimes:(function(){var e1,e0,e2,T;e2={"MSIE 8.0":"flash","MSIE 9.0":"flash"};e0="html5";for(e1 in e2){T=e2[e1];if(navigator.userAgent.indexOf(e1)!==-1){e0=T}}return e0})(),choose_button_id:"choose-button",set_dest:function(T){de.fillVal(T,"dest-folder");return this.current_dest=T},init:function(e1,e2,e3,e0){var T;this.set_dest(e1);T=this.initPLU(e3,e0);if(!e2){ah.window_load(T)}else{T()}bv("#flash-upload-container > .moxie-shim").each(function(e4){if(e4.observe){dQ.freshbutton_overlay(e4,$("choose-button"));return dQ.freshbutton_overlay(e4,$("add-button"))}});return al.clear()},init_basic:function(){dQ.freshbutton_overlay($("file-box"),$("basic-choose-button"));$("file-box").observe("click",function(T){return document.fire(cq.CHOOSE_FILE_BASIC)});$("basic-choose-button").observe("mousemove",function(e1){var e0,T,e2;e0=$("modal").cumulativeOffset();e2=e1.clientY-e0.top-3;T=e1.clientX-e0.left-$("file-box").getWidth()+3;return $("file-box").setStyle({top:e2+"px",left:T+"px"})});return $("file-box").observe("change",function(){var e3,e1,e4,e2,T,e0;eS.hide=function(){};$("modal-x").hide();$("basic-upload-desc").hide();$("basic-upload-buttons").hide();$("file-box").hide();e1=$("file-box").getValue().split("\\").pop();e2=cm.make("web",av.file_icon(e1));$("basic-upload-status").down(".icon").__date(e2);e3=el("Uploading %(filename)s").format({filename:bK.em_snippet(e1,25)});$("basic-upload-status").down(".file-desc").__date(e3);$("basic-upload-status").show();$("basic-uploading-message").show();e4=$("file-box").files;e0=0;if(e4){T=e4[0].lastModifiedDate;if(T){e0=Math.round(Date.parse(T)/1000)||0}}if(!e0){e0=Math.round(Date.parse(new Date)/1000)}$("mtime-utc").value=e0;return $("basic-upload-form").submit()})},initPLU:function(e0,T){return(function(e1){return function(){var e3,e2;e3={url:"https://"+Constants.BLOCK_CLUSTER+"/chunked_upload",file_data_name:"file",runtimes:e1.runtimes,multipart_params:{},multipart:false,max_file_size:"10000mb",chunk_size:"8mb",max_retries:2,browse_button:e1.choose_button_id,container:"flash-upload-container",preinit:{PostInit:function(){if(e0){e0()}return e1.uploaderLoaded()},Error:e1.uploadError.bind(e1)},init:{FilesAdded:e1.fileQueued.bind(e1),UploadProgress:e1.uploadProgress.bind(e1),FileUploaded:e1.uploadSuccess.bind(e1),BeforeUpload:e1.prepareFileForUploading.bind(e1),ChunkUploaded:e1.chunkUploaded.bind(e1),UploadComplete:al.finished.bind(al),Refresh:function(){if(e1.PLU.runtime==="flash"&&$("upload-running-buttons").visible()){bv("#flash-upload-container").clonePosition(bv("#add-button"));bv("#flash-upload-container > .moxie-shim")[0].style.width="100%";return bv("#flash-upload-container > .moxie-shim")[0].style.height="100%"}}},flash_swf_url:aF.UrlConstants.MOXIE_SWF_URL};if(T!=null){bv.extend(e3,T)}e2=new plupload.Uploader(e3);e1.PLU=e2;return e1.PLU.init()}})(this)},reset:function(){if(al.uploading&&al.current_file){this.PLU.removeFile(al.current_file)}return cP.hide()},show_upload:function(){$("upload-desc").hide();$("dnd-upload-desc").hide();$("upload-files-list").show();$("upload-start-buttons").hide();$("upload-running-buttons").show();$("hide-button").show();$("done-button").hide();if(!$("modal-overlay").visible()){return cP.show()}},updatePostParams:function(e1){var e0,T;T=this.PLU.settings.multipart_params;for(e0 in e1){if(e1.hasOwnProperty(e0)){T[e0]=e1[e0]}}return this.PLU.settings.multipart_params=T},fileQueued:function(e0,e4){var e3,e2,T,e1;for(e2=0,T=e4.length;e2<T;e2++){e3=e4[e2];if((typeof e3.getNative==="function"?(e1=e3.getNative())!=null?e1.dest:void 0:void 0)===void 0){e3.dest=cq.current_dest}else{e3.dest=e3.getNative().dest}}document.fire(this.QUEUE_EVT,{files:e4});bv(document).trigger(this.QUEUE_EVT,{files:e4});if(W.is_quicksend_dest(e3.dest)){return}return this.show_upload()},uploadNext:function(){var e3,e1,T,e0,e4,e2;e0=al.next();T=($u.contains(cq.APPLE_PACKAGE_EXTENSIONS,av.file_extension_for_logging(e0.name))&&e0.size%34===0)||(av.file_extension_for_logging(e0.name)===""&&e0.size%34===0&&e0.size<=3400);if(T){e0.status=plupload.FAILED;e1={file:e0,code:cq.APPLE_PACKAGE_ERROR,message:el("Can\u2019t Upload"),tooltip_text:el('To upload a package file via the web, try zipping it first, or <a href="https://www.dropbox.com/help/6691" target="_blank">learn more</a>.'),response:"",responseHeaders:"",status:400};this.uploadError(this.PLU,e1);return false}e4={dest:al.next().dest,t:bo.read(Constants.JS_CSRF_COOKIE)};e4[Constants.UID_PARAM_NAME]=ci.active_user;if((e2=av.file_extension(e0.name,e3=true))==="url"||e2==="webloc"||e2==="website"){e4.overwrite=0}cq.updatePostParams(e4);this.PLU.start();al.last_update_time=0;al.last_update_size=0;return true},pause:function(){return cq.PLU.stop()},uploadProgress:function(e0,T){if(!al.cancelled_files[T.id]){document.fire(this.UPDATE_EVT,{file:T,percent_complete:T.loaded/T.size});return bv(document).trigger(this.UPDATE_EVT,{file:T,percent_complete:T.loaded/T.size})}},generateUploadId:function(){var T,e0,e2,e1;T="";for(e0=e1=0;e1<=15;e0=++e1){T+=String.fromCharCode(Math.floor(Math.random()*256))}e2=af.encode(T);e2=e2.replace(/\+/g,"-");e2=e2.replace(/\//g,"_");e2=e2.replace(/\=*$/,"");return e2},chunkUploaded:function(e0,e1,e2){var T;T=JSON.parse(e2.response||"");return this.updatePostParams({offset:T.offset})},prepareFileForUploading:function(){var T;T=al.next();return this.updatePostParams({reported_total_size:T.size,dest:T.dest,t:bo.read(Constants.JS_CSRF_COOKIE),upload_id:this.generateUploadId(),offset:0})},uploadSuccess:function(e3,e2,e1){var e0,T;try{T=JSON.parse(e1.response)}catch(e4){e0=e4;T=null}if(e1.response==="{'error': 'quota'}"){document.fire(this.ERROR_EVT,{file:e2,message:el("Quota exceeded"),tooltip_text:el("Your upload failed because you are over quota.")});return bv(document).trigger(this.ERROR_EVT,{file:e2,message:el("Quota exceeded"),tooltip_text:el("Your upload failed because you are over quota.")})}else{if(e1.response==="{'error': 'empty'}"){document.fire(this.CANCEL_EVT,{file:e2,message:el("Empty File")});return bv(document).trigger(this.CANCEL_EVT,{file:e2,message:el("Empty File")})}else{if(e1.response==="{'error': 'ignored'}"){document.fire(this.CANCEL_EVT,{file:e2,message:el("File Ignored")});return bv(document).trigger(this.CANCEL_EVT,{file:e2,message:el("File Ignored")})}else{if((T!=null?T.status:void 0)==="complete"){document.fire(this.COMPLETE_EVT,{file:e2});return bv(document).trigger(this.COMPLETE_EVT,{file:e2})}else{document.fire(this.ERROR_EVT,{file:e2});return bv(document).trigger(this.ERROR_EVT,{file:e2})}}}}},uploadComplete:function(e0,T){document.fire(this.COMPLETE_EVT,{file:T});return bv(document).trigger(this.COMPLETE_EVT,{file:T})},uploadError:function(e3,T){var e2,e0,e1;if((e1=T.file.id,bB.call(al.file_ids(),e1)<0)&&T.code!==cq.APPLE_PACKAGE_ERROR){document.fire(this.QUEUE_EVT,{files:[T.file]});bv(document).trigger(this.QUEUE_EVT,{files:[T.file]})}e0=(function(){switch(T.code){case plupload.FILE_SIZE_ERROR:return el("File too large");default:return el("Upload Error")}})();this.show_upload();e2={file:T.file,error_code:T.code,message:e0};if(T!=null?T.tooltip_text:void 0){e2.tooltip_text=T.tooltip_text}document.fire(this.ERROR_EVT,e2);return bv(document).trigger(this.ERROR_EVT,e2)},grabURL:function(){var T;T=$F("file-box");if(/(^http|^https|^ftp):\/\//.match(T)){$("url").value=T}return true},treeview_handler:function(e0,T){var e1;de.fillVal(e0,"dest-folder");e1=$("basic-uploader-url");if(e1){e1.href=e1.href.replace(/(\/upload)(.*)(\?basic=1)/,function(e4,e3,e5,e2){return e3+dQ.urlquote(e0)+e2})}return al.clear()},new_folder:function(){bS.hide();eS.show(el("Create new folder..."),de.fromElm("create-folder"),{action:this.do_new_folder.bind(this,ci.active_user),wit_group:"new-folder-confirm"});if(!dQ.ie){return bv("#first-treeview-link").trigger("click")}},do_new_folder:function(T){var e1,e0;if(!eS.vars.selected_path){ab.error(el("Please select a parent folder."));return}e0=$F("entered-name");e1=eS.vars.selected_path;return new Ajax.DBRequest("/cmd/new"+dQ.urlquote(e1)+"?to_path="+dQ.urlquote(e0),{subject_user:T,onSuccess:(function(e2){return function(e3){e2.treeview_handler(av.normalize(e1)+"/"+e0);return bS.schedule_reset()}})(this),cleanUp:function(){}})},uploaderLoaded:function(){$("upload-loading").hide();$("choose-button").show();if(cq.PLU.runtime==="flash"){bv("#flash-upload-container").clonePosition(bv("#choose-button"));bv("#flash-upload-container > .moxie-shim")[0].style.top="0px";bv("#flash-upload-container > .moxie-shim")[0].style.left="0px";bv("#flash-upload-container > .moxie-shim")[0].style.width="100%";return bv("#flash-upload-container > .moxie-shim")[0].style.height="100%"}else{bv("#"+this.choose_button_id).click((function(T){return function(e0){return bv("#"+T.PLU.id+"_html5").click()}})(this));return bv("#add-button").click((function(T){return function(e0){return bv("#choose-button").click()}})(this))}}};al=B.FileQueue={init:function(){return al._listen()},_listen:function(){document.observe(cq.QUEUE_EVT,al._file_queued.bind(this));document.observe(cq.QUEUE_ERROR_EVT,al._file_queue_errored.bind(this));document.observe(cq.UPDATE_EVT,al._file_updated.bind(this));document.observe(cq.COMPLETE_EVT,al._file_completed.bind(this));document.observe(cq.ERROR_EVT,al._file_errored.bind(this));return document.observe(cq.CANCEL_EVT,al._file_cancelled.bind(this))},_file_queued:function(e4){var e1,e3,e0,e2,T;e2=e4.memo.files;T=[];for(e3=0,e0=e2.length;e3<e0;e3++){e1=e2[e3];this.files[e1.id]=e1;if(!al.uploading){this._start_uploading()}this.current_file=e1;T.push(es("File queued:",e1.name))}return T},_file_queue_errored:function(T){this._file_queued(T);return setTimeout(((function(e0){return function(){return e0._file_errored(T)}})(this)),250)},_file_updated:function(e7){var e2,T,e0,e1,e5,e4,e3,e6,e8;e1=e7.memo.file;e4=e7.memo.percent_complete;e5=e4*e1.size;e8=e5+this.completed_size();e0=new Date().getTime();if(this.last_update_time){e3=(e0-this.last_update_time)/1000;if(cq.PLU.total.bytesPerSec){this.average_bps=cq.PLU.total.bytesPerSec}else{T=e5-this.last_update_size;e2=T/e3;this.average_bps=((e8-T)*this.average_bps+T*e2)/e8}e6=(this.queue_size()-e8)/this.average_bps;this.formatted_time=bU.format_time(e6+this.num_left())}this.current_file=e1;this.last_update_time=new Date().getTime();return this.last_update_size=e5},_file_completed:function(e0){var T;T=e0.memo.file;this.completed_files[T.id]=true;es("File completed:",T.name);return this._check_if_finished(T)},_file_errored:function(e0){var T;T=e0.memo.file;this.errored_files[T.id]=true;ep.update_errors();cP.update_errors();es("File errored:",T.name);return this._check_if_finished(T)},_file_cancelled:function(e0){var T;T=e0.memo.file;this.cancelled_files[T.id]=true;if(T.status===plupload.UPLOADING){cq.PLU.stop();cq.PLU.removeFile(T);cq.PLU.start()}else{cq.PLU.removeFile(T)}es("File cancelled:",T.name);return this._check_if_finished(T)},_start_uploading:function(){var T;this.uploading=cq.uploadNext();if(this.uploading){this.all_cancelled=false;return window.onbeforeunload=T=(function(e0){return function(){return el("Leaving this page will cancel your uploads.")}})(this)}},finished:function(){return this._finished_uploading()},_check_if_finished:function(T){if(this.empty()){if(this.uploading){return this._finished_uploading()}}else{return cq.uploadNext()}},_finished_uploading:function(){var e0,e1,e2,T;this.uploading=false;if(!this.num_files()){ep.cancelled()}else{if(this.errors()){ep.errored();cP.errored()}else{ep.completed();cP.completed()}}T=$("inline-upload-status").visible();ci.select_fq_paths=[];if(ci.inside_dir){for(e2 in this.completed_files){e1=this.files[e2];e0=av.normalize(e1.dest);ci.select_fq_paths.push(""+e0+"/"+e1.name)}ci.force_reload()}else{if(ci.in_search_mode()){bZ.force_reload()}}if(T){cP.show()}eS.onHide=null;return window.onbeforeunload=null},empty:function(){return !this.num_left()},num_files:function(){return this.file_ids().length},num_non_cancelled_files:function(){return this.file_ids().length-this.cancels()},next:function(){return $u(this.files).filter((function(T){return function(e0){return !(T.cancelled_files[e0.id]||T.errored_files[e0.id]||T.completed_files[e0.id])}})(this))[0]},cancels:function(){return $u(this.cancelled_files).keys().length},errors:function(){return $u(this.errored_files).keys().length},queue_size:function(){var e0,e4,e1,e3,T,e2;e1=0;e2=this.file_ids();for(e3=0,T=e2.length;e3<T;e3++){e4=e2[e3];e0=this.files[e4];if(!this.errored_files[e4]&&!this.cancelled_files[e4]&&typeof e0.size!=="undefined"){e1+=e0.size}}return e1},completed_size:function(){var e3,e0,e2,T,e1;e0=0;e1=$u(this.completed_files).keys();for(e2=0,T=e1.length;e2<T;e2++){e3=e1[e2];if(typeof this.files[e3].size!=="undefined"){e0+=this.files[e3].size}}return e0},file_ids:function(){return $u(this.files).map((function(T){return function(e0,e1){return e1}})(this))},totalPercentage:function(){return this.completed_size()/this.queue_size()},num_left:function(){return $u(this.file_ids()).filter((function(T){return function(e0){return !(T.cancelled_files[e0]||T.errored_files[e0]||T.completed_files[e0])}})(this)).length},clear:function(){this.files={};this.cancelled_files={};this.all_cancelled=false;this.errored_files={};this.completed_files={};this.last_update_time=0;this.last_update_size=0;this.average_bps=0;this.formatted_time="";this.uploading=false;window.onbeforeunload=null;if(typeof eS!=="undefined"&&eS!==null){return eS.onHide=null}}};al.clear();dO=B.UploadFile={FILENAME_SNIPPET_LENGTH:15,DEST_SNIPPET_LENGTH:13,_tmpl:null,init:function(){dO._tmpl=eV.tmpl("upload_list_item_tmpl");return dO._listen()},_listen:function(){document.observe(cq.QUEUE_EVT,dO._file_queued);document.observe(cq.QUEUE_ERROR_EVT,dO._file_queue_errored);document.observe(cq.UPDATE_EVT,dO._file_updated);document.observe(cq.COMPLETE_EVT,dO._file_completed);document.observe(cq.ERROR_EVT,dO._file_errored);return document.observe(cq.CANCEL_EVT,dO._file_cancelled)},_file_queued:function(e4){var e1,e3,e0,e2,T;e2=e4.memo.files;T=[];for(e3=0,e0=e2.length;e3<e0;e3++){e1=e2[e3];T.push((function(e6){var fc,e5,e9,fb,fa,fd,e7,e8;fc=e6.dest;if(W.is_quicksend_dest(fc)){W.add_external_file(e6);return}fd=aA.format_bytes(e6.size||0);e5=dO._tmpl({file:e6,icon:av.file_icon(e6.name),filename_snippet:bK.em_snippet(e6.name,dO.FILENAME_SNIPPET_LENGTH),size:fd,dest:fc,dest_snippet:bK.em_snippet(el("Dropbox")+fc,dO.DEST_SNIPPET_LENGTH,0),Sprite:cm});$("upload-files-list").__sert(e5);fb=$(e6.id);fa=al.num_files();if(dh.show_share_button_in_file_uploader){e9=bv("#"+e6.id);e9.find(".dest-col").hide()}e7=$("upload-files-list");if(fa<=6){e7.removeClassName("scroll")}else{e7.addClassName("scroll")}e7.scrollTop=e7.scrollHeight;fb.down(".dest").observe("click",function(){ci.reload_fqpath(fb.readAttribute("data-dest"),true);return eS.hide()});e8=fb.down(".status-col").down("a.small-x-button");e8.stopObserving("click");e8.observe("click",function(fe){document.fire(cq.CANCEL_EVT,{file:e6});return bv(document).trigger(cq.CANCEL_EVT,{file:e6})});return fb.down(".upload-progress-bar").setStyle({width:"0"})})(e1))}return T},_file_queue_errored:function(T){dO._file_queued(T);return dO._file_errored(T)},_file_updated:function(e2){var e1,e3,e0,T;e1=e2.memo.file;e3=$(e1.id);if(al.num_files()===1){T=el("%(time_left)s left").format({time_left:al.formatted_time});e3.down(".time-col").__date(T)}e0=parseInt(e1.percent,10)+"%";if(e0==="100%"){e3.down(".time-col").__date();e3.down(".status-col").__date(new Element("img",{src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"}))}return e3.down(".upload-progress-bar").setStyle({width:e0})},_file_completed:function(e0){var T,e1,e2;T=e0.memo.file;T.completed=true;e2=$(T.id);e2.addClassName("complete");if(dh.show_share_button_in_file_uploader&&!W.is_quicksend_dest(T.dest)){e1=bv("#"+T.id);e1.find(".share-link").show();a3.SharedFolderActivityLogger.log("web","share_button_in_uploader_impression",ci.active_user,{});e1.on("click",function(e5){var e4,e3;eS.hide();a3.SharedFolderActivityLogger.log("web","share_button_in_uploader_click",ci.active_user,{});e4=T.dest+"/"+T.name;e3="file_uploader";return dh.shmodel(e4,e3)})}setTimeout(function(){return e2.down(".status-col").__date(cm.make("web","s_check"))},0);return e2.down(".upload-progress-bar").setStyle({width:"100%"})},_file_errored:function(e0){var T,e1;T=e0.memo.file;e1=$(T.id);if(e1){return dO._actual_file_errored(e0)}else{return setTimeout((function(e2){return function(){return dO._actual_file_errored(e0)}})(this),0)}},_actual_file_errored:function(e3){var T,e1,e0,e4,e2;e0=e3.memo.file;e4=$(e0.id);e4.addClassName("error");e4.down(".dest-col").hide();e4.down(".time-col").__date();e4.down(".status-col").__date(cm.make("web","nosync"));e4.down(".upload-progress-bar").setStyle({width:"100%"});if(W.is_quicksend_dest(e0.dest)){return}e1=e3.memo.message||el("Upload Error");T=void 0;if(e3.memo.tooltip_text){T=e3.memo.tooltip_text}else{T=el('Something went wrong with the advanced uploader. If the problem persists, please use the <a id="basic_link">basic uploader</a> to upload via the website.');bv(document).on("click","a#basic_link",function(){dn.show_basic_upload();return false})}e4.down(".error-msg").__date(e1);e2=e4.down(".error-details");e2.observe("mouseover",function(){return d5.show(e2,T)});return e4.down(".error-col").show()},_file_cancelled:function(e0){var T,e1;T=e0.memo.file;e1=$(T.id);e1.addClassName("cancelled");e1.down(".dest-col").__date(el(e0.memo.message||"Canceled"));e1.down(".time-col").__date();e1.down(".status-col").__date(cm.make("web","cancelsync"));return e1.down(".upload-progress-bar").setStyle({width:"100%"})}};ep=B.BulkUpload={init:function(){this.elem=$("bulk-upload-status");return ep._listen()},_listen:function(){document.observe(cq.QUEUE_EVT,ep._file_queued.bind(this));return document.observe(cq.UPDATE_EVT,ep._file_updated.bind(this))},_file_queued:function(e0){var T;T=new Element("a",{"class":"small-x-button"});T.observe("click",function(){var e3,e5,e4,e2,e1;al.all_cancelled=true;e3=al.file_ids().slice(0);e1=[];for(e4=0,e2=e3.length;e4<e2;e4++){e5=e3[e4];if(!al.completed_files[e5]&&!al.errored_files[e5]){document.fire(cq.CANCEL_EVT,{file:al.files[e5]});e1.push(bv(document).trigger(cq.CANCEL_EVT,{file:al.files[e5]}))}else{e1.push(void 0)}}return e1});return this.elem.down(".status").__date(T)},_file_updated:function(e2){var e1,e0,T;if(al.num_files()>1){this.elem.removeClassName("error");this.elem.removeClassName("complete");this.elem.removeClassName("cancelled");e1=a4("%d file","%d files",al.num_non_cancelled_files()).format(al.num_non_cancelled_files());this.elem.down(".num-files").__date(e1);e0=el("- %(size)s").format({size:aA.format_bytes(cq.PLU.total.size)});this.elem.down(".size").__date(e0);if(al.formatted_time){T=el("%(time_left)s left").format({time_left:al.formatted_time});this.elem.down(".time-left").__date(T)}this.elem.down(".upload-progress-bar").style.width=Math.min(100,(al.totalPercentage()*100||0).toFixed(2))+"%";this.elem.show();if(cq.PLU.runtime==="flash"){return bv("#flash-upload-container").clonePosition(bv("#add-button"))}}},update_errors:function(){var T;T=a4("- %d error","- %d errors",al.errors()).format(al.errors());return $("bulk-upload-status").down(".num-errors").__date(T)},completed:function(){var e0,T;$("hide-button").hide();$("done-button").show();if(al.num_files()>1){this.elem.addClassName("complete");e0=a4("Uploaded %d file","Uploaded %d files",al.num_non_cancelled_files()).format(al.num_non_cancelled_files());this.elem.down(".num-files").__date(e0);T=el("- %(size)s").format({size:aA.format_bytes(al.completed_size())});this.elem.down(".size").__date(T);this.elem.down(".num-errors").__date();this.elem.down(".time-left").__date();this.elem.down(".status").__date(cm.make("web","s_check"));return this.elem.down(".upload-progress-bar").style.width="100%"}},errored:function(){var T;$("hide-button").hide();$("done-button").show();this.completed();T=a4("- %d error","- %d errors",al.errors()).format(al.errors());return this.elem.down(".num-errors").__date(T)},cancelled:function(){$("hide-button").hide();$("done-button").show();if(al.num_files()>1){this.elem.addClassName("cancelled");this.elem.down(".num-files").__date(el("All uploads canceled"));this.elem.down(".size").__date();this.elem.down(".num-errors").__date();this.elem.down(".time-left").__date();this.elem.down(".status").__date(cm.make("web","cancelsync"));return this.elem.down(".upload-progress-bar").style.width="100%"}}};cP=B.InlineUploadStatus={FILENAME_SNIPPET_LENGTH:30,init:function(){return this._listen()},_listen:function(){document.observe(cq.QUEUE_EVT,cP._file_queued.bind(this));return document.observe(cq.UPDATE_EVT,cP._file_updated.bind(this))},_file_queued:function(e1){var e0,T;e0=$("inline-upload-status");e0.removeClassName("error");e0.removeClassName("complete");e0.down(".icon").__date(cm.make("web","s_sync"));e0.down(".file-desc").__date(el("Starting upload..."));e0.down(".num-errors").__date();T=a4("%d file","%d files",al.num_left()).format(al.num_left());e0.down(".view-details").__date(T);e0.down(".status").__date();return e0.down(".inline-upload-progress").style.width="0%"},_file_updated:function(e5){var e4,e1,e2,e3,e0,T;e4=$("inline-upload-status");e1=e5.memo.file;e4.down(".icon").__date(cm.make("web","s_sync"));e2=el("Uploading %(filename)s").format({filename:bK.em_snippet(e1.name,this.FILENAME_SNIPPET_LENGTH)});e4.down(".file-desc").__date(e2);if(al.num_left()>1){T=a4("%d file left","%d files left",al.num_left()-1).format(al.num_left()-1);e4.down(".view-details").__date(T)}else{e4.down(".view-details").__date(el("View details"))}if(al.formatted_time){e0=el("%(time_left)s left").format({time_left:al.formatted_time});e4.down(".status").__date(e0)}e3=e1.percent+"%";return e4.down(".inline-upload-progress").style.width=e3},update_errors:function(){var T,e0;T=$("inline-upload-status");e0=a4("- %d error","- %d errors",al.errors()).format(al.errors());return T.down(".num-errors").__date(e0)},add_x_button:function(){var T,e0;e0=new Element("a",{"class":"small-x-button"});e0.observe("click",function(){cP.hide();return cq.reset()});T=$("inline-upload-status");return T.down(".status").__date(e0)},completed:function(){var e0,T;e0=$("inline-upload-status");e0.addClassName("complete");e0.removeClassName("error");e0.down(".icon").__date(cm.make("web","s_check"));if(al.num_files()>1){T=el("Uploaded %(num_files)d files").format({num_files:al.num_non_cancelled_files()})}else{T=el("Uploaded %(filename)s").format({filename:bK.em_snippet(al.current_file.name,this.FILENAME_SNIPPET_LENGTH)})}e0.down(".file-desc").__date(T);e0.down(".num-errors").__date();e0.down(".view-details").__date(el("View details"));this.add_x_button();return e0.down(".inline-upload-progress").style.width="100%"},errored:function(){var e1,e0,T,e2;e1=$("inline-upload-status");e1.addClassName("error");e1.removeClassName("complete");e1.down(".icon").__date(cm.make("web","nosync"));e0=void 0;if(al.num_files()>1){e0=el("Uploaded %(num_completed)d of %(num_files)d files").format({num_completed:al.num_non_cancelled_files()-al.errors(),num_files:al.num_non_cancelled_files()});e1.down(".file-desc").__date(e0);e2=a4("- %d error","- %d errors",al.errors()).format(al.errors());e1.down(".num-errors").__date(e2)}else{if(al.current_file!=null){T=bK.em_snippet(al.current_file.name,this.FILENAME_SNIPPET_LENGTH)}e0=T?el("Unable to upload %(filename)s").format({filename:T}):el("Unable to upload file");e1.down(".file-desc").__date(e0);e1.down(".num-errors").__date()}e1.down(".view-details").__date(el("View details"));this.add_x_button();return e1.down(".inline-upload-progress").style.width="100%"},show:function(T){return $("inline-upload-status").show()},hide:function(){return $("inline-upload-status").hide()}};bi=B.UploadPrep={_drop_indicators:false,_drop_dest_folder:null,file_counter:0,current_req:null,_notifications_cleared:false,supported:function(){return Prototype.BrowserFeatures.DB_CORS},enabled:function(){return bi.supported()&&ci.inside_dir&&!(ci.in_search_mode()&&bZ.fulltext_search_enabled)},browse_indicators_enabled:function(){var e2,e0,e1,T;if(!bi.enabled()){return false}e0=["file-preview-modal","modal-overlay"];if(cq.choose_button_id.startsWith("wizard-")){e0.push("wizard-overlay")}for(e1=0,T=e0.length;e1<T;e1++){e2=e0[e1];if($(e2).visible()){return false}}return true},modal_indicators_enabled:function(){var T;return bi.enabled()&&bv("#modal #upload-modal-dropzone").length&&bv("#modal").visible()&&((T=bv("#modal").offset())!=null?T.left:void 0)>0},_show_border_drop_indicators:function(){return $$(".external-drop-indicator").each(function(T){return bv(T).css("opacity",0).fadeTo(500,0.6)})},_hide_border_drop_indicators:function(){return $$(".external-drop-indicator").invoke("hide")},show_drop_indicators:function(e0){var T;if(!bi._drop_indicators){if(bi.modal_indicators_enabled()){T=$("upload-modal-dropzone");bv(T).clonePosition(bv("#modal"),{setLeft:false,setTop:false});bv(T).fadeIn(500);bi._show_border_drop_indicators()}else{if(bi.browse_indicators_enabled()){bH._add_drop_indicators(e0)}else{return}}$("drag-status").removeClassName("active");return bi._drop_indicators=true}},hide_drop_indicators:function(){if(bi._drop_indicators){bi._hide_border_drop_indicators();bH._remove_drop_indicators();if(!bi._notifications_cleared){ab.clear()}$("upload-modal-dropzone").hide();$("drag-status").addClassName("active");setTimeout((function(){bi._drop_indicators=false;bi._drop_dest_folder=null;return bi._notifications_cleared=false}),500)}return bi._notifications_cleared=true},folder_dragover:function(T){var e0;if(bi.browse_indicators_enabled()&&bi._drop_indicators){if(dE.disabled){if(bi._drop_dest_folder==null){e0=el("You can't upload files because you're out of space.");ab.error(e0,60);bi._notifications_cleared=false;bi._show_border_drop_indicators()}}else{if(T!==bi._drop_dest_folder){if(T===ci.containing_fq_path()){if(ci.inside_read_only_shared_folder){e0=el("You don't have permission to add to this folder.");ab.error(e0,60)}else{e0=el("Drop your file to %(upload_action)s",{comment:"upload_action is a phrase like 'upload to folder 'XYZ'"}).format({upload_action:dn.upload_plain_snippet()});ab.success(new eV(e0),60);bi._show_border_drop_indicators()}bi._notifications_cleared=false}else{ab.clear();bi._hide_border_drop_indicators()}}}return bi._drop_dest_folder=T}},supports_recursive_upload:function(T){var e0;return window.File&&window.FileReader&&window.FileList&&window.Blob&&(T!=null?(e0=T[0])!=null?e0.webkitGetAsEntry:void 0:void 0)},upload:function(e1,e3,e0){var e2,e5,e4,T;if(e0==null){e0=null}if(ci.inside_read_only_shared_folder){return}if(dE.disabled){e5=el("You can't upload files because you're out of space.");return ab.error(e5)}else{if(bi.supports_recursive_upload(e0)){return bi._recursive_upload(e1,e0)}else{for(e4=0,T=e3.length;e4<T;e4++){e2=e3[e4];e2.dest=e1}return bi._upload(e3,e0)}}},_recursive_upload:function(fa,e7){var fc,e1,e2,e9,e5,fd,e0,fb,e4,e6,T,e3,e8;e0=[];e4=[];e6=function(fe,ff){fe.dest=fa+av.parent_dir(ff.fullPath);return e0.push(fe)};for(e3=0,e8=e7.length;e3<e8;e3++){fb=e7[e3];e9=fb.webkitGetAsEntry();if(e9!==null){if(e9.isDirectory){if(W.is_quicksend_dest(fa)){ab.error(el("Please select files instead of folders."))}else{e4.push(e9)}}else{e6(fb.getAsFile(),e9)}}}e2=0;fd=0;T=function(fe,fg){var ff;ff=el('The drag and drop uploader can\'t upload %(name)s because it contains Unicode characters. Use the <a id="use-advanced-uploader"> advanced uploader</a> instead.').format({name:fg.name});ab.error(new eV(ff));return bv("#use-advanced-uploader").on("click",function(fh){fh.preventDefault();return dn.show_upload()})};fc=3000;e5=0;e1=function(){var fe;while(e4.length){e9=e4.pop();if(e9!==null){if(e9.isDirectory){(function(fg){var ff;ff=fg.createReader();e2+=1;return ff.readEntries(function(fh){var fk,fj,fi;if(fh.length!==0){for(fj=0,fi=fh.length;fj<fi;fj++){fk=fh[fj];e4.push(fk)}return ff.readEntries(arguments.callee)}else{return e2-=1}},function(fh){e2-=1;return T(fh,fg)})})(e9)}else{fd+=1;fe=function(ff){return function(fg){e6(fg,ff);return fd-=1}};e9.file(fe(e9),function(ff){fd-=1;return T(ff,e9)})}}}if(e0.length>fc&&!e5){e5=1;ab.error(el("The Dropbox website can't upload more than %(max_files)s files.").format({max_files:fc}));return}if(e2||fd){return e1.defer()}else{if(e0.length){return bi._upload(e0)}}};return e1()},_upload:function(e2,e0){var T,e1;if(e0==null){e0=null}if(e0){T=this._parse_upload_items(e0)}e1=function(){var e5,e7,e4,e6,e3;e3=[];for(e7=0,e4=e2.length;e7<e4;e7++){e5=e2[e7];if(navigator.userAgent.toLowerCase().indexOf("chrome")>-1&&(T!=null?(e6=T[e5.name])!=null?e6.isDirectory:void 0:void 0)){e5.is_directory=true}e5.id=plupload.guid();e3.push(cq.PLU.addFile(e5))}return e3};if($("modal").visible()){return e1()}else{dn.show_upload(e1);return eS.hide(null,true)}},_parse_upload_items:function(e0){var e1,e2,e3,T;e1={};for(e3=0,T=e0.length;e3<T;e3++){e2=e0[e3];if(e2.getAsEntry){e2=e2.getAsEntry()}else{if(e2.webkitGetAsEntry){e2=e2.webkitGetAsEntry()}}e1[e2.name]=e2}return e1}};dE=B.OverQuotaUploads={disabled:false,init:function(T){this.disabled=T;if(this.disabled){return bv("body").addClass("uploads-disabled")}}};var dn;dn=INLINE_JS.FileOps=B.FileOps={NOTIFICATION_SNIPPET_LEN:40,SHOW_UPLOAD_EVT:"db:fileops:show_upload",_find_app_by_id:function(e0){var e3,e2,T,e1;e1=eS.vars.apps;for(e2=0,T=e1.length;e2<T;e2++){e3=e1[e2];if(e3.app_id!==e0){continue}return e3}return null},create_album_from_folder:function(e0,T){return new Ajax.DBRequest("/collection_from_folder",{parameters:{path:e0,album_name:T},job:true,job_user:cB.get_viewer().photos_user,dont_hide_progress_on_complete:true,progress_text:el("Creating album..."),onSuccess:function(e1){var e2;e2=JSON.parse(e1.responseText);return window.location.href=e2.url}})},dir_handler:function(e2,e1){var e0,T;if(typeof e1==="string"){e1=$(e1)}e0=$$(".treeview .highlight")[0];if(e0){e0.removeClassName("highlight")}T=e1.up("div");T.addClassName("highlight");eS.selected_div=T;if(eS.shown()){e1.blur()}document.fire("db:dir_click",{path:e2});return eS.vars.selected_path=e2},show_folder_pick:function(e4,e2,e1,e3,T){var e0;de.fillVal(av.filename(e2).escapeHTML(),"folder-pick-file");bS.move("copy-move-treeview","folder-pick-treeview",{user:ci.active_user});e0=(T?el("Move"):el("Copy"));de.fillVal(e0,"folder-pick-action-text");eS.show(e4,$("folder-pick"),{fq_path:e2,action:e1,folder:e3});return bv("#first-treeview-link").trigger("click")},show_bulk_folder_pick:function(e5,e4,e2,e3){var e0,T,e1;e1=aY.profile_files(e2);T=aY.profile_summary(e1);de.fillVal(T,"bulk-folder-pick-file");bS.move("copy-move-treeview","bulk-folder-pick-treeview",{user:ci.active_user});if(e4==="move"){e0=el("Move")}else{if(e4==="copy"){e0=el("Copy")}else{e0=el("Restore")}}de.fillVal(e0,"bulk-folder-pick-action-text");eS.show(e5,$("bulk-folder-pick"),{files:e2,action:e3});return bv("#first-treeview-link").trigger("click")},show_copy:function(T,e0){var e1;e1=(e0?el("Copy folder to..."):el("Copy file to..."));bS.set_params({disable_read_only:true});return dn.show_folder_pick(e1,T,dn.do_copy,e0,false)},show_copy_bulk:function(T){var e0;e0=a4("Copy %(item_count)s item to...","Copy %(item_count)s items to...",T.length).format({item_count:T.length});bS.set_params({disable_read_only:true});return dn.show_bulk_folder_pick(e0,"copy",T,dn.do_bulk_copy)},show_move_bulk:function(T){var e0;e0=a4("Move %(item_count)s item to...","Move %(item_count)s items to...",T.length).format({item_count:T.length});bS.set_params({disable_read_only:true});return dn.show_bulk_folder_pick(e0,"move",T,dn.do_bulk_move)},show_move:function(T,e0){var e1;e1=(e0?el("Move folder to..."):el("Move file to..."));bS.set_params({disable_read_only:true});return dn.show_folder_pick(e1,T,dn.do_move,e0,true)},show_delete:function(T,e1,e2,e0){return dy.show({title_text:e2?el("Delete folder?"):el("Delete file?"),body_html:el("Are you sure you want to delete <strong>%(items)s</strong> from your Dropbox?").format({items:av.filename(e1).escapeHTML()}),confirm_text:el("Delete"),cancel_text:el("Cancel"),confirm_callback:(function(e3){return function(){if(e0){return dn.do_nonbrowse_delete(T,[e1])}else{return dn.do_delete(T,e1)}}})(this)})},show_bulk_delete:function(T,e0){return dy.show({title_text:a4("Delete %(item_count)s item?","Delete %(item_count)s items?",e0.length).format({item_count:e0.length}),body_html:a4("Are you sure you want to delete %(item_count)s item from your Dropbox?","Are you sure you want to delete %(item_count)s items from your Dropbox?",e0.length).format({item_count:e0.length}),confirm_text:el("Delete"),cancel_text:el("Cancel"),confirm_callback:(function(e1){return function(){return dn.do_bulk_delete(T,e0)}})(this)})},show_purge:function(T,e0){return dy.show({title_text:e0?el("Permanently delete folder?"):el("Permanently delete file?"),body_html:el("Are you sure you want to permanently delete <strong>%(items)s</strong> from your Dropbox?").format({items:av.filename(T).escapeHTML()}),confirm_text:el("Permanently delete"),cancel_text:el("Cancel"),confirm_callback:(function(e1){return function(){return dn.do_purge(ci.find_file(T))}})(this)})},show_bulk_purge:function(T){return dy.show({title_text:a4("Permanently delete %d item?","Permanently delete %d items?",T.length).format(T.length),body_html:a4("Are you sure you want to permanently delete %(item_count)s item from your Dropbox?","Are you sure you want to permanently delete %(item_count)s items from your Dropbox?",T.length).format({item_count:T.length}),confirm_text:el("Permanently delete"),cancel_text:el("Cancel"),confirm_callback:(function(e0){return function(){return dn.do_bulk_purge(T)}})(this)})},show_bulk_restore:function(e0,T){return dy.show({title_text:a4("Restore %d item...","Restore %d items...",e0.length).format(e0.length),body_html:a4("Are you sure you want to restore %(item_count)s item?","Are you sure you want to restore %(item_count)s items?",e0.length).format({item_count:e0.length}),confirm_text:el("Restore"),cancel_text:el("Cancel"),confirm_callback:(function(e1){return function(){return dn.do_bulk_restore(e0)}})(this)})},wrap_strong:function(T){if(ci.containing_fq_path()===""){return T.escapeHTML()}else{return"<strong>"+T.escapeHTML()+"</strong>"}},upload_snippet:function(e1){var T,e0;if(e1==null){e1=1000}if(cB.get_viewer().is_paired&&ci.active_user.is_team){e0=bK.em_snippet(cB.get_viewer().team_name,e1).escapeHTML()}if(ci.containing_fq_path()===""){if(cB.get_viewer().is_paired){if(ci.active_user.is_team){return el(" upload to your %(team_name)s Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({team_name:e0})}else{return el(" upload to your personal Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"})}}else{return el(" upload to your Dropbox")}}else{T=bK.em_snippet(av.filename(ci.containing_fq_path()),e1).escapeHTML();if(cB.get_viewer().is_paired){if(ci.active_user.is_team){return el(" upload to the folder <strong>%(folder)s</strong> in your %(team_name)s Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({folder:T,team_name:e0})}else{return el(" upload to the folder <strong>%(folder)s</strong> in your personal Dropbox",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({folder:T})}}else{return el(" upload to the folder <strong>%(folder)s</strong>",{comment:"Used after the string 'drop your file to...' or 'choose a file to...'"}).format({folder:T})}}},upload_short_snippet:function(e1){var e0,T;if(e1==null){e1=1000}T=ci.containing_fq_path();if(!T){return el("Upload to Dropbox",{comment:"Upload a file to the root Dropbox folder"})}e0=bK.em_snippet(av.filename(T),e1);return el("Upload to '%(folder_name)s'",{comment:"Upload a file to some folder on the website"}).format({folder_name:e0})},upload_plain_snippet:function(T){if(T==null){T=1000}return this.upload_snippet(T).replace("<strong>","'").replace("</strong>","'")},show_upload:function(e7,T,e4){var e1,e5,e0,e2,e6,e3;e1=ci.containing_fq_path();if(dE.disabled){de.fillVal(this.wrap_strong(av.filename(e1)),"disabled-upload-foldername");e0=this.upload_short_snippet(20);eS.show(e0,$("disabled-upload-modal"),{},false);return}bv(document).trigger(this.SHOW_UPLOAD_EVT,{source:T,has_callback:e7!=null});if((!FlashDetect.versionAtLeast(9))&&cq.runtimes==="flash"){dn.show_basic_upload();$("enhanced-upload-toggle").hide();return}de.fillVal(this.upload_snippet(20),"upload-foldername");de.fillVal(this.upload_plain_snippet(10),"dnd-upload-foldername");if($("upload-desc").visible()&&bi.supported()){$("upload-desc").hide();$("dnd-upload-desc").show()}e0=this.upload_short_snippet(20);eS.show(e0,de.fromElm("advanced-upload-modal"),{wit_group:"advanced-uploader"},false,false,al.num_files());e3=[$("modal").down(".basic-link-start"),$("modal").down(".basic-link-running")];for(e2=0,e6=e3.length;e2<e6;e2++){e5=e3[e2];if(e5!=null){e5.observe("click",function(){dn.show_basic_upload();return false})}}if(!al.num_files()){cq.init(av.normalize(e1),true,e7,e4)}else{cq.set_dest(av.normalize(e1))}return cP.hide()},show_basic_upload:function(){de.fillVal(this.upload_snippet(20),"basic-upload-foldername");eS.show(this.upload_short_snippet(20),$("basic-upload-modal"),{},false);$("modal").down(".enhanced-link").observe("click",function(){dn.show_upload();return false});cq.set_dest(av.normalize(ci.containing_fq_path()));return cq.init_basic()},show_undelete:function(T){var e0,e1,e2;de.fillVal(T.filename.escapeHTML(),"undelete_filename");e0=cm.make("web",T.icon,{});e0.addClassName("link-img");e0.style.backgroundColor="transparent";e1=dn.build_revisions_uri(T.fq_path,ci.active_user,{undelete:1});$$(".undelete-icon").invoke("update",e0);$$(".undelete-other-versions")[0].href=e1;$$(".undelete-link")[0].href=e1;e2=el("Restore file?");return eS.show(e2,$("undelete-modal"),{file:T})},do_undelete:function(e0){var T,e1;T=eS.vars.file;e1=el("Restored '%(file_name)s'").format({file_name:T.filename});new Ajax.DBRequest("/cmd/restore",{parameters:{files:[T.fq_path]},subject_user:ci.active_user,job:true,html_in_error_msg:true,progress_text:el("Restoring..."),onSuccess:function(e2){eS.hide();ab.success(e1);return document.fire(aC.RESTORE,{files:[T]})}});return false},do_copy:function(e1,e0){var T;e1=e1||eS.vars.fq_path;e0=e0||eS.vars.selected_path;T=ci.find_file(e1);cz(T,"Trying to copy a file we couldn't find.");return dn.do_bulk_copy([T],e0)},do_bulk_copy:function(e4,e0){var e2,e3,e1,e5,T;ci.pre_action_selection=eG.get_selected_fq_paths();e4=e4||eS.vars.files;cz(e4.length>0,"Tried to copy 0 files");if(typeof e0==="undefined"){if(typeof eS.vars.selected_path==="undefined"){ab.error(el("You need to select a destination for the file."));return}else{e0=eS.vars.selected_path}}e0=av.normalize(e0);e1=0;for(e5=0,T=e4.length;e5<T;e5++){e2=e4[e5];if(e2.dir){if((e0+"/").indexOf(e2.fq_path+"/")===0){ab.error(el("You cannot copy a folder into itself."));return}}}e3=e4.pluck("fq_path");ab.clear();return new Ajax.DBRequest("/cmd/copy",{parameters:{files:e3,to_path:e0},subject_user:ci.active_user,job:true,html_in_error_msg:true,progress_text:el("Copying..."),onSuccess:function(fd){var e9,fc,e6,fe,e8,fa,e7,fb;e9=fd.responseText.evalJSON().changesets;fc=e3.length;fe=bK.em_snippet(av.filename(e0),dn.NOTIFICATION_SNIPPET_LEN).escapeHTML();e8=a4("Copied %(count)d item to '<a id=\"reload-link\">%(location)s</a>'.","Copied %(count)d items to '<a id=\"reload-link\">%(location)s</a>'.",fc);e8=e8.format({count:fc,location:fe});U.notifyWithUndo(new eV(e8),e9,dn.do_rollback);e6=[];fb=fd.responseText.evalJSON().new_browse_files;for(fa=0,e7=fb.length;fa<e7;fa++){e2=fb[fa];e6.push(e2.fq_path)}ci.select_fq_paths=e6;$("reload-link").observe("click",function(){return aX.set_path_url(null,e0)});bS.schedule_reset();return document.fire(aC.COPY,{files:e4,to_fq_path:e0})}})},bulk_move_error:function(T,e7){var e5,e2,e8,e3,e9,e4,e0,e1,e6;e8=ci.find_file(e7);e3=aY.profile_files(T);e1=void 0;e4=void 0;e6=void 0;if(e8){e4=e8.dir;e1=e8.fq_path;e6=e8.target_ns||e8.ns_id}else{if(ci.inside_dir&&ci.can_get_details_from_fq_path(e7)){e2=ci.details_from_fq_path(e7);e4=true;e1=e2.fq_path;e6=e2.ns_id}else{e4=true;e1=e7;e6=void 0}}e9=T.pluck("fq_path").collect(av.normalize);if(-1!==e9.indexOf(av.normalize(e1))){return el("You cannot copy a folder into itself.")}e5=e0=function(fa){var fb;fb=av.parent_dir(fa.fq_path);return fb===(e1||"/")};if(T.all(e5)){return a4("That file already exists in that folder.","Those files already exist in that folder.",T.length)}if(!e4){return el("You cannot put files inside one another.")}if(e3.target_namespaces>0&&e6&&e6!==Constants.root_ns){if(e3.sandboxes>0){if(e8.is_sandbox()){return el("You're not allowed to put an application folder inside another application folder.")}else{if(e8.is_shared_folder()){return el("You're not allowed to put an application folder inside a shared folder.")}}}else{if(e3.shared_folders>0){if(e8.is_sandbox()){return el("You're not allowed to put a shared folder inside an application folder.")}else{if(e8.is_shared_folder()){return el("You're not allowed to put a shared folder inside another shared folder.")}}}}return el("You're not allowed to nest special folders.")}if(ci.public_folder_enabled){if(e1==="/Public"&&e3.target_namespaces>0){return el("You're not allowed to move shared folders to your Public folder.")}}if(e3.public_folder>0){return el("You're not allowed to move your Public folder.")}if(e3.deleted>0){return el("Moving deleted folders or files is not allowed.")}},do_move:function(e1,e0){var T;e1=e1||eS.vars.fq_path;e0=e0||eS.vars.selected_path;T=ci.find_file(e1);cz(T,"Trying to move a file we couldn't find.");return dn.do_bulk_move([T],e0)},do_bulk_move:function(e3,e4){var e1,e2,T,e0;ci.pre_action_selection=eG.get_selected_fq_paths();e3=e3||eS.vars.files;if(!e3){return}cz(e3.length>0,"Tried to move 0 files");T=e4||eS.vars.selected_path||"";T=av.normalize(T);e1=dn.bulk_move_error(e3,T);if(e1){ab.error(e1);return}e2=e3.pluck("fq_path");ab.clear();e0="/cmd/move";return new Ajax.DBRequest(e0,{parameters:{files:e2,to_path:T},subject_user:ci.active_user,job:true,html_in_error_msg:true,progress_text:el("Moving..."),onSuccess:function(e8){var e7,e6,e5,e9;e7=e8.responseText.evalJSON().changesets;e6=e2.length;e5=bK.em_snippet(av.filename(T),dn.NOTIFICATION_SNIPPET_LEN).escapeHTML();e9=a4("Moved %(count)d item to '<a id=\"reload-link\">%(location)s</a>'.","Moved %(count)d items to '<a id=\"reload-link\">%(location)s</a>'.",e6);e9=e9.format({count:e6,location:e5});U.notifyWithUndo(new eV(e9),e7,dn.do_rollback);$("reload-link").observe("click",function(){return aX.set_path_url(null,T)});bS.schedule_reset();return document.fire(aC.MOVE,{files:e3,to_fq_path:T})}})},do_rollback:function(T){return new Ajax.DBRequest("/cmd/rollback",{parameters:{ns_to_cs:JSON.stringify(T)},subject_user:ci.active_user,job:true,html_in_error_msg:true,progress_text:el("Undoing..."),onSuccess:function(e0){var e1;e1=el("Undo complete.");ab.success(e1);cz(ci.pre_action_selection instanceof Array,"Expected a selection from before the action to be undone");if(ci.in_search_mode()){bZ.select_fq_paths=ci.pre_action_selection;bZ.force_reload()}else{if(aE.shown){ci.select_fq_paths=ci.pre_action_selection}else{ci.select_fq_paths=ci.pre_action_selection;ci.force_reload()}}return ci.pre_action_selection=false}})},do_bulk_delete:function(T,e2){var e0,e1;ci.pre_action_selection=eG.get_selected_fq_paths();e2=e2||eS.vars.files;cz(e2.length>0,"Tried to delete 0 files");e1=(function(){var e5,e4,e3;e3=[];for(e5=0,e4=e2.length;e5<e4;e5++){e0=e2[e5];e3.push(e0.fq_path)}return e3})();ab.clear();return new Ajax.DBRequest("/cmd/delete",{parameters:{files:e1},subject_user:T,job:true,html_in_error_msg:true,progress_text:el("Deleting..."),onSuccess:function(e3){var e5,e4;e4=e3.responseText.evalJSON();e5=a4("Deleted %d item.","Deleted %d items.",e1.length).format(e1.length);U.notifyWithUndo(e5,e4.changesets,dn.do_rollback);bS.schedule_reset();return document.fire(aC.DELETE,{files:e2})}})},do_delete:function(T,e1){var e0;e0=ci.find_file(e1||eS.vars.fq_path);cz(e0,"Trying to delete a file we couldn't find.");return dn.do_bulk_delete(T,[e0])},do_nonbrowse_delete:function(T,e0){return new Ajax.DBRequest("/cmd/delete",{parameters:{files:e0},subject_user:T,html_in_error_msg:true,onSuccess:function(e1){var e2;e2=a4("Deleted %(file_count)s item","Deleted %(file_count)s items",e0.length);e2=e2.format({file_count:e0.length});ab.success(e2);return document.fire(aC.DELETE,{fq_paths:e0})}})},do_purge:function(T){cz(T,"Trying to purge a file we couldn't find.");return dn.do_bulk_purge([T])},do_bulk_purge:function(e0){var T,e1;cz(e0.length>0,"Tried to purge 0 files");T=e0.collect(function(e2){return e2.fq_path});e1=a4("Permanently deleted %d item","Permanently deleted %d items",T.length).format(T.length);return new Ajax.DBRequest("/cmd/purge",{parameters:{files:T},subject_user:ci.active_user,job:true,html_in_error_msg:true,progress_text:el("Deleting..."),onSuccess:function(e2){ab.success(e1);bS.schedule_reset();return document.fire(aC.PURGE,{files:e0})}})},do_bulk_restore:function(e1){var e0,e2,T;e1=e1||eS.vars.files;T=eS.vars.user;cz(e1.length>0,"Tried to restore 0 files");e0=e1.collect(function(e3){return e3.fq_path});e2=a4("Restored %d item","Restored %d items",e0.length,{comment:"meaning, successfully restored x files and folders"}).format(e0.length);return new Ajax.DBRequest("/cmd/restore",{parameters:{files:e0},subject_user:ci.active_user,job:true,html_in_error_msg:true,progress_text:el("Restoring..."),onSuccess:function(e3){ab.success(e2);bS.schedule_reset();return document.fire(aC.RESTORE,{files:e1})}})},do_folder_restore:function(e0,T){var e1;e1=function(e2){var e4,e3;e4=el("Restoring '%(folder_name)s'").format({folder_name:av.filename(e0)});e3=e2.responseText;if(e3.startsWith("err:")){e3=e3.substring(4);bv("#async-result").html(e3);ab.error(new eV(e3),60)}else{e4=el("Restored '%(folder_name)s'").format({folder_name:av.filename(e0)});bv("#status-of-files").text(el("Restored files"));ab.success(e4,60)}bv("#restore-done-heading").text(e4);bv(".pre-restore").hide();return bv(".post-restore").show()};return new Ajax.DBRequest("/cmd/restore",{parameters:{files:[e0]},job:true,html_in_error_msg:true,progress_text:el("Restoring..."),onSuccess:e1,onFailure:e1,subject_user:T})},do_bulk_download:function(e1){var e3,e0,e2,T;e3=new Element("form",{action:D({scheme:"https",authority:Constants.BLOCK_CLUSTER,path:"/zip_batch"}).updateQuery(Constants.UID_PARAM_NAME,ci.active_user.id).toString(),method:"post"});for(e2=0,T=e1.length;e2<T;e2++){e0=e1[e2];bJ.add_vars(e3,{files:e0.fq_path})}bJ.add_vars(e3,{parent_path:ci.block_hash_param||"/",w:ci.block_hash});$(document.body).__sert(e3);return e3.submit()},do_bulk_photo_view:function(e1,T){var e4,e3,e0,e2;if(T==="carousel"||T==="carousel_as_dropbox_photos"){e2={};e2[a2.UID_PARAM_NAME]=cB.get_viewer().personal_user.id;e4=String(D({scheme:"https",authority:eY.WEBSERVER,path:"/app/view_in_timeline",query:e2}))}else{e4=String(D({scheme:"https",authority:eY.WEBSERVER,path:"/photos"}))}e3=new Element("form",{action:e4,method:"post"});bJ.add_vars(e3,{t:bo.read(Constants.JS_CSRF_COOKIE),ns_ids:JSON.stringify((function(){var e7,e6,e5;e5=[];for(e7=0,e6=e1.length;e7<e6;e7++){e0=e1[e7];e5.push(e0.ns_id)}return e5})()),ns_paths:JSON.stringify((function(){var e7,e6,e5;e5=[];for(e7=0,e6=e1.length;e7<e6;e7++){e0=e1[e7];e5.push(e0.ns_path)}return e5})())});$(document.body).__sert(e3);return e3.submit()},build_revisions_uri:function(e1,T,e0){if(e0==null){e0={}}e0[Constants.UID_PARAM_NAME]=String(T);return D({path:"/revisions"+e1}).updateQuery(e0)}};var bJ,ar={}.hasOwnProperty;bJ=__CONDITIONAL_JS__.Forms=INLINE_JS.Forms=B.Forms={submitOnlyOnce:function(){var T;T=bJ.submitted!==true;bJ.submitted=true;return T},disable:function(T){if(T){return setTimeout((function(){return T.disabled=true}),0)}},enable:function(T){if(T){return setTimeout((function(){return T.disabled=false}),0)}},show_button_on_change:function(T,e2){var e1,e3,e4,e0;e1=bv(T);e1.hide();if(e2==null){e2=e1.closest("form")}e3=e2[0];if(this.next_id==null){this.next_id=0}e4=this.next_id++;if(this.initial_vars==null){this.initial_vars={}}this.initial_vars[e4]=this.collect_form_vars(e3);e1.attr("data-id",e4);e2.data("button-id",e4);e0=(function(e5){return function(){var e8,e7,e6;e1.hide();e7=e5.collect_form_vars(e3);if(Object.keys(e7).length!==Object.keys(e5.initial_vars[e4]).length){e1.show()}e6=[];for(e8 in e7){if(e7[e8]!==e5.initial_vars[e4][e8]){e6.push(e1.show())}else{e6.push(void 0)}}return e6}})(this);e2.change(e0);e2.find("input").filter(":text").on("input",e0);return e2.find("textarea").on("input",e0)},add_vars:function(e1,e2){var e3,e0,T;e1=$(e1);T=[];for(e0 in e2){if(!ar.call(e2,e0)){continue}e3=new Element("input",{type:"hidden",name:e0});e3.setValue(e2[e0]);T.push(e1.__sert(e3))}return T},collect_form_vars:function(e3,e2){var e6,e1,e0,e5,e4,T;if(e2==null){e2=false}e3=e3||$(document.body);e1=e3.select("input").concat(e3.select("textarea")).concat(e3.select("select"));e0={};for(e4=0,T=e1.length;e4<T;e4++){e6=e1[e4];if(e6.name&&e6.name!=="t"){e5=e6.getValue();if(e5||e2){if(typeof e5!=="string"){e5=e5.join(",")}if(e0[e6.name]!=null){if(typeof e0[e6.name]==="string"){e0[e6.name]=[e0[e6.name],e5]}else{e0[e6.name].push(e5)}}else{e0[e6.name]=e5}}}}return e0},add_loading:function(e1,T){var e0;if(e1){e1=$(e1);e0=new Element("img",{src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"});e0.addClassName("text-img ajax_submit_loading");if(T==="after"){return bv(e1).after(e0)}else{return bv(e1).before(e0)}}},remove_loading:function(T){return bv(".ajax_submit_loading").remove()},ui_form_submit:function(e0,T){T=T||e0.action;if(e0.ajax_submitted){return false}e0.ajax_submitted=true;return new bp(bv(e0),T,{data:bJ.collect_form_vars(e0),success:(function(e1){return function(e5,e2,e6){var e4,e3;e3=bv(e0).data("button-id");if(e3!=null){e4=bv(e0).find("*[type='submit'][data-id='"+e3+"']");e1.initial_vars[e3]=e1.collect_form_vars(e0);return e4.hide()}}})(this),complete:(function(e1){return function(e3,e2){return e0.ajax_submitted=false}})(this)})},ajax_submit_obj:function(e4){var e8,fa,e1,e2,e0,e3,e6,e7,e5,e9,T;e2=e4.form,T=e4.url,e9=e4.success_callback,e1=e4.fail_callback,e8=e4.button,e6=e4.more_vars,e7=e4.position,e3=e4.job,e0=e4.html_response,fa=e4.complete_callback,e5=e4.progress_text;return bJ.ajax_submit(e2,T,e9,e1,e8,e6,e7,e3,e0,fa,e5)},ajax_submit:function(e2,e0,fb,e1,e9,e6,fa,e3,T,fe,e4){var fc,e5,e7,fd,e8;if(T==null){T=false}if(e2.ajax_submitted){return false}e2.ajax_submitted=true;e8=bv(e2).find(".suggestion-input");for(e7=0,fd=e8.length;e7<fd;e7++){fc=e8[e7];cT.blank(fc.identify())()}if(e9){bJ.add_loading(e9,fa)}e5=bJ.collect_form_vars(e2);if(e6){Object.extend(e5,e6)}new Ajax.DBRequest(e0||e2.action,{noAutonotify:true,parameters:e5,job:e3,progress_text:e4,evalJSON:false,onSuccess:function(ff){bJ.remove_loading();if(fb&&typeof fb==="function"){return fb(ff)}},onFailure:function(fh){var ff,fg;if(fh){if(fh.responseText.indexOf("err:")===0){ff=fh.responseText.substr(4);if(ff.indexOf("{")===0){fg=ff.evalJSON(true);bJ.fill_errors(e2,fg)}else{if(T){ff=new eV(ff)}ab.error(ff)}}else{ab.error()}bJ.remove_loading();if(e1&&typeof e1==="function"){return e1(fh)}}},onComplete:function(fi){var fh,fg,ff;ff=e2.select(".suggestion-input");for(fh=0,fg=ff.length;fh<fg;fh++){fc=ff[fh];cT.blur_elm(fc)}e2.ajax_submitted=false;if(fe&&typeof fe==="function"){return fe(fi)}}});return false},clear_errors:function(T){T=T||$(document.body);this.hide_errors(T);return T.select(".error-removable").invoke("remove")},fill_errors:function(e4,e3){var e1,e6,e0,e2,e5,T;e3=e3||{};e4=e4||$(document.body);bJ.clear_errors(e4);for(e5 in e3){if(!ar.call(e3,e5)){continue}e6=e4.down("[data-error-field-name='"+e5+"']")||e4.down("[name='"+e5+"']");if(e6){e1=new Element("br",{"class":"error-removable"});e0=new Element("span",{"class":"error-message error-removable"});e2=e3[e5];cz(e2.message_html||e2.message_text,"Error message must have a message_html or message_text property");if(e2.message_html){e0.update(e2.message_html)}else{e0.__date(e2.message_text)}bv(e6).before(e0);bv(e6).before(e1);T=bv(e4).find("input[name='"+e5+"'], textarea[name='"+e5+"']");if(T){T.addClass("input-error")}}}return this.show_errors(e4)},value:function(e2){var e1,e0,e4,e3,T;e0=$$('input[name="'+e2+'"]');e4=null;for(e3=0,T=e0.length;e3<T;e3++){e1=e0[e3];e4=$(e1).getValue()||e4}return e4},postRequest:function(e1,e2,T){var e0;if(e2==null){e2={}}if(T==null){T={}}cz(e1!=null,"postRequest missing action");e2.t=bo.read(Constants.JS_CSRF_COOKIE);e0=new Element("form",{action:e1,method:"POST"});if(T.target){e0.target=T.target}document.body.appendChild(e0);bJ.add_vars(e0,e2);return e0.submit()},hide_errors:function(e1){var e4,e3,e2,e0,T;e4=this.get_errors(e1);T=[];for(e2=0,e0=e4.length;e2<e0;e2++){e3=e4[e2];if(e3.down("span.error-message")){T.push(e3.hide())}else{T.push(void 0)}}return T},show_errors:function(e0){var e3,e2,e1,T;e3=this.get_errors(e0);for(e1=0,T=e3.length;e1<T;e1++){e2=e3[e1];if(e2.down("span.error-message")){e2.show()}}return bv(".sick-input").find("label").css("top","")},get_errors:function(e0){var e1,T;T=".error-bubble, .error-plain-text";e1=e0?e0.select(T):$$(T);return e1}};bv(function(){return bJ.show_errors()});var R;R=B.ActAsBlock={elm_list:["margin-left","margin-right","padding-left","padding-right","border-left-width","border-right-width"],parent_list:["padding-left","padding-right","border-left-width","border-right-width"],register:function(e3,e4){var e2,e0,e1,T;if(e4==null){e4=document.body}e1=$(e4).getElementsByClassName("act_as_block");T=[];for(e2=0,e0=e1.length;e2<e0;e2++){e3=e1[e2];T.push(this.resize(e3))}return T},resize:function(e3){var T,e1,e2,e0;e3=$(e3);e1=e3.up();T=dQ.sumStyles(e3,this.elm_list);e2=dQ.sumStyles(e1,this.parent_list);e3.style.width="1px";e0=e1.getWidth()-T-e2;if(e0>0){return e3.style.width=e0+"px"}}};var a6;a6=B.BrowseStyleRows={register_all:function(){var e2,e1,T,e0;e0=$$(".bs-row");for(e1=0,T=e0.length;e1<T;e1++){e2=e0[e1];this.register(e2)}Event.observe(document,"click",this.kill_current.bind(this));return bv(document).on("dropdown-opened",this.kill_current.bind(this))},register:function(e0){var T;e0=$(e0);e0.db_observe("mouseover",this.mouseover.bind(this));e0.db_observe("mouseout",this.mouseout.bind(this));T=e0.down(".action-button");if(T){return T.db_observe("click",this.click.bind(this))}},mouseover:function(e0,T){if(!T.hasClassName("no-hover")){return T.addClassName("hover")}},mouseout:function(e0,T){return T.removeClassName("hover")},click:function(e2,e0){var T,e3,e1;if(e2.target.tagName==="A"){return}e3=e0.up(".bs-row");Event.stop(e2);if(e3.hasClassName("selected")){this.kill_current(false);return}bv(document).trigger("dropdown-opened");this.kill_current(false);e1=$(e2.target);if(!e1.match(".bs-actions-list *")){e3.addClassName("selected")}T=(e1.hasClassName("bs-row")?e1:e1.up(".bs-row"));return T.style.zIndex=9},kill_current:function(e3){var e4,e2,e0,e1,T;e1=$$(".bs-row.selected");T=[];for(e2=0,e0=e1.length;e2<e0;e2++){e4=e1[e2];e4.removeClassName("selected");T.push(e4.style.zIndex="")}return T}};var d9;d9=B.Bubble={make:function(fc,fn,ff,fa,e6){var e3,fd,fk,e2,e1,fm,fh,fb,e9,e4,e8,fe,fj,e7,T,e5,e0,fl,fi,fg;if(fn==null){fn="left"}e6=e6!=null?e6:{};if(["left","right"].contains(fn)){ff=ff||"middle";cz(["top","middle","bottom"].contains(ff),"expected tail position ['top', 'middle', 'bottom'], got "+ff)}else{if(["bottom","top"].contains(fn)){ff=ff||"center";cz(["left","center","right"].contains(ff),"expected tail position ['left', 'center', 'right'], got "+ff)}else{if(!["none"].contains(fn)){cz(false,"unexpected tail side, got "+fn)}}}fe=new Element("table");if(e6.style==="titled"){fe.addClassName("bluebubble");fj="bluebubble"}else{fe.addClassName("bubble");fj="bubble"}if(fa){fe.style.width=fa+"px"}T=new Element("tbody");fl=new Element("tr");e5=new Element("td");e5.addClassName("tl");e8=new Element("td");e8.addClassName("t");if(e6.style==="titled"){if(fa){e8.style.width=(fa-42)+"px"}}e0=new Element("td");e0.addClassName("tr");if(fn==="top"){e7=new Element("img",{src:"/static/images/"+fj+"_arrow_top.png"});e7.addClassName("tarrow");if(e6.style==="titled"){e7.addClassName("arrow-"+ff);fd=new Element("div");fd.addClassName("arrow-container");if(fa){fd.style.width=(fa-42)+"px"}fd.__sert(e7);e8.__sert(fd)}else{e8.style.textAlign=ff;e8.__sert(e7)}}fl.__sert(e5);fl.__sert(e8);fl.__sert(e0);T.__sert(fl);fi=new Element("tr");fb=new Element("td");fb.addClassName("l");if(fn==="left"){if(e6.style==="titled"){e3=new Element("img",{src:"/static/images/bluebubble_arrow_left-vfl8zzy_-.png"})}else{e3=new Element("img",{src:"/static/images/bubble_arrow-vfl8m7tk-.png"})}e3.addClassName("arrow");fb.__sert(e3);fb.vAlign=ff}fh=new Element("td");fh.addClassName("c");fh.update(fc);e9=new Element("td");e9.addClassName("r");if(fn==="right"){e4=new Element("img",{src:"/static/images/bubble_arrow_right-vflmW3_2s.png"});e4.addClassName("rarrow");e9.__sert(e4);e9.vAlign=ff}fi.__sert(fb);fi.__sert(fh);fi.__sert(e9);T.__sert(fi);fg=new Element("tr");e1=new Element("td");e1.addClassName("bl");fk=new Element("td");fk.addClassName("b");if(fn==="bottom"){e2=new Element("img",{src:"/static/images/"+fj+"_arrow_bottom.png"});e2.addClassName("barrow");if(e6.style==="titled"){e2.addClassName("arrow-"+ff);fd=new Element("div");fd.addClassName("arrow-container");if(fa){fd.style.width=(fa-42)+"px"}fd.__sert(e2);fk.__sert(fd)}else{fk.style.textAlign=ff;fk.__sert(e2)}}fm=new Element("td");fm.addClassName("br");fg.__sert(e1);fg.__sert(fk);fg.__sert(fm);T.__sert(fg);fe.__sert(T);return fe}};var eD;eD=INLINE_JS.FreshDropdown=B.FreshDropdown={show:function(e5,e2,e1,e0){var e4,e3,e6,T;if(e0==null){e0=false}bv(document).trigger("dropdownOpened",[1]);e4=bv(e2);if(!e1){e1=e4[0].offsetHeight+10}this.hide_all();e3=bv(e5).show();T=e3[0].offsetWidth;e6=e4[0].offsetWidth;e3.clonePosition(e4,{setHeight:false,setWidth:false,offsetLeft:-1*(T-e6)+22,offsetTop:e1});if(e0){e3.width(T)}e4.addClass("pressed");return((function(e7){return function(){return document.observe("click",eD.hide_all)}})(this)).defer()},hide_all:function(e1){var e0,T;T=bv(".freshdropdown-menu");e0=0;T.each(function(){if(bv(this).is(":visible")){return e0+=1}});T.hide();bv(document).trigger("dropdownClosed",[e0]);$$(".freshdropdown-button").invoke("removeClassName","pressed");return document.stopObserving("click",eD.hide_all)}};var Y;Y=B.JumpWatcher={inverval:null,last_hash:null,last_page_offset:0,check:function(){if(window.location.href.endsWith("#")&&window.pageYOffset===0&&Y.last_page_offset!==0){return this.report()}else{this.last_page_offset=window.pageYOffset;return this.last_hash=D.parse(window.location.href).fragment}},report:function(){clearInterval(Y.interval);return cz(0.1+0.2===0.3,"Hash jump detected, last hash = "+this.last_hash+". You may have an onclick handler that isn't firing, or you are not preventing the default action (eg. by returning false in your handler)")}};var eM,bf,ar={}.hasOwnProperty,cE=function(e2,e0){for(var T in e0){if(ar.call(e0,T)){e2[T]=e0[T]}}function e1(){this.constructor=e2}e1.prototype=e0.prototype;e2.prototype=new e1();e2.__super__=e0.prototype;return e2};eM=B.LocaleSelectorModal=(function(e0){cE(T,e0);function T(){return T.__super__.constructor.apply(this,arguments)}T.prototype.action="https://"+Constants.WEBSERVER+"/set_locale";T.prototype.on_show=function(){return this.$modal_window.on("click",".locale-option",(function(e1){return function(e2){e2.preventDefault();e1.hide();return e1.set_locale(bv(e2.target).attr("data-locale"))}})(this))};T.prototype.on_hide=function(){return this.$modal_window.off("click")};T.prototype.set_locale=function(e1,e3){var e2;if(e3==null){e3=false}e2=bv("<form />",{action:this.action,method:"post"});bJ.add_vars(e2[0],{locale:e1,locale_cont:e3||window.location.href,t:bo.read(Constants.JS_CSRF_COOKIE)});bv(document.body).append(e2);return e2.submit()};return T})(dS);bf=B.TeamLocaleSelectorModal=(function(T){cE(e0,T);function e0(){return e0.__super__.constructor.apply(this,arguments)}e0.prototype.action="https://"+Constants.WEBSERVER+"/team/admin/set_locale";return e0})(eM);var dz;dz=B.LoginDropdown={init:function(){var T;T=bv("#login-hover-link");if(!(T.length>0)){return}this.login_link=T;return this.register()},register:function(T){this.login_link.on("click",this.click.bind(this));this.login_link.on("mousedown",this.mousedown.bind(this));this.login_link.on("focus",this.click.bind(this));return $(document.body).on("click",this.unclick.bind(this))},mousedown:function(T){return this.clicking=true},click:function(T){T.preventDefault();if(this.clicking&&T.type==="focus"){return}this.clicking=false;if(this.down){return this.unclick()}bv(document).trigger("dropdownOpened",[1]);this.down=true;this.login_link.parent().addClass("down");return bv("input[name='login_email']").focus()},unclick:function(e0){var T;if(e0){T=bv(e0.target);if(T[0].match("#top-login-wrapper, #top-login-wrapper *")){return}}if(this.down){bv(document).trigger("dropdownClosed",[1])}this.down=false;return this.login_link.parent().removeClass("down")}};var eS;eS=__CONDITIONAL_JS__.Modal=INLINE_JS.Modal=B.Modal={KEY_SCOPE:"modal",width:640,vertical_offset:90,show:function(fb,e7,e8,fd,e1,e9,e5,e6,fc){var e0,e3,fa,T,e2,e4;if(e8==null){e8=false}if(fd==null){fd=false}if(e1==null){e1=false}if(e9==null){e9=false}if(e5==null){e5=""}if(e6==null){e6=true}if(fc==null){fc=false}if(eS.shown()){eS._cleanup()}e1=e1||this.width;e3="#modal-content .error-message, #modal-content .error-removable, #modal-content .error-bubble";$$(e3).invoke("hide");if(al.uploading&&!e9){bY(el("You can't do this while uploading."));return false}cz(e7,"Missing modal content!");e2=this.vars._prev_scope;this.vars=e8||{};this.vars._prev_scope=e2;$("modal").setStyle({width:""+e1+"px",margin:"0 0 0 "+(Math.floor(-e1/2).toString())+"px"});this.vars.extra_class="";if(e5){$("modal").addClassName(e5);this.vars.extra_class=e5}if(!e9){if(al.num_files()){cq.reset();al.clear()}T=dQ.childElement($("modal-content"),0);if(T&&T!==e7){$("grave-yard").__sert(T)}e0=new Element("div");e0.update(e7);$("modal-content").__sert(e0);if(e7.show){e7.show()}Element.show("modal")}bv("#modal-overlay").off("click");if(e6){bv("#modal-overlay").on("click",function(fe){eS.hide(null,false,true);fe.preventDefault();return fe.stopPropagation()})}else{bv("#modal-overlay").on("click",function(fe){fe.preventDefault();return fe.stopPropagation()})}this.fix_position();$("modal-overlay").show();$("modal-behind").setStyle({width:""+(e1+20)+"px",margin:"0 0 0 "+(Math.floor(-e1/2-10).toString())+"px"});bv("#modal-behind").css("opacity",0.2);$("modal-behind").show();if(fd){$("modal-content").select("#"+fd.id).first().focus()}else{if(!dQ.ie){fa=$("modal").down("input[type=submit]")||$("modal").down("input[type=button]");if(fa){fa.focus()}}}if(!this.track_id){this.track_resizes()}if(fb){if(dQ.isElm(fb)){bv("#modal-title").html(fb)}else{bv("#modal-title").text(fb)}bv("#modal-title").show();e4=bv("#modal-title").text();es("Modal.show:",e4)}else{bv("#modal-title").hide();es("Modal.show")}R.register(false,"modal");this.keydownHandler=this.keydown.bind(this);document.observe("keydown",this.keydownHandler);$("modal-content").style.height="auto";if(key.getScope()!==this.KEY_SCOPE){this.vars._prev_scope=key.getScope()}key.setScope(this.KEY_SCOPE);this.prevent_hide_if_loading=fc;bv("#modal").find("input").filter(":visible:first").focus();if(this.in_viewport()){this.scroll_locked=true;z.scroll_lock_document()}bv(document).trigger("modalOpened",[1]);return false},in_viewport:function(){var e1,T,e0,e3,e2;e1=bv("#modal");T=e1.height();e2=e1.width();e0=z.viewport_dimensions();e3=z.viewport_offset(e1);return e3.left>0&&e3.top>0&&e3.left+e2<e0.width&&e3.top+T<e0.height},fix_position:function(e1){var e0,T;T=document.viewport.getScrollOffsets().top+this.vertical_offset;e0=parseInt($("modal").getStyle("height"),10);if(e0+this.vertical_offset<document.viewport.getHeight()){$("modal").setStyle({position:"fixed",top:this.vertical_offset+"px"});return $("modal-behind").setStyle({position:"fixed",height:(e0+20)+"px",top:(this.vertical_offset-10)+"px"})}else{$("modal").setStyle({position:"absolute",top:T+"px"});return $("modal-behind").setStyle({position:"absolute",height:(e0+20)+"px",top:(T-10)+"px"})}},keydown:function(e2){var e3,T,e1,e0;e1=e2.keyCode||e2.which||e2.charCode;if(e1===27||(e1===8&&!z.focus_in_input())){e2.preventDefault();this.hide(null,false,true)}if(e1===9&&!z.focus_in_input()){T=$("modal").down("input[type=text], input[type=email]");e0=$("modal").down(".modal-tabs");e3=e0;while(e3&&e3.next()){e3=e3.next();if(e3.visible()){T=e3.down("input[type=text], input[type=email]");break}}if(T){e2.preventDefault();return T.focus()}}},shown:function(){return $("modal").visible()},hide:function(e1,T,e0){if(e1){Event.stop(e1)}if(this.should_prevent_hide()){return false}this.prevent_hide_if_loading=false;if(this.onHide){this.onHide(e0);return}this.onHide=null;Element.hide("modal-behind");Element.hide("modal-overlay");$("modal").removeClassName(this.vars.extra_class);if(!T&&!al.num_files()){Element.hide("modal")}else{$("modal").style.marginLeft="-10000000px";if(al.uploading){cP.show()}}eS._cleanup();if(this.track_id){clearInterval(this.track_id);this.track_id=false}document.stopObserving("keydown",this.keydownHandler);if(document.activeElement&&[document,window,document.body].indexOf(document.activeElement)===-1){$(document.activeElement).blur()}key.setScope(this.vars._prev_scope);return es("Modal.hide")},_cleanup:function(){bv(document).trigger("modalClosed",[1]);if(this.scroll_locked){return z.scroll_unlock_document()}},should_prevent_hide:function(){return this.prevent_hide_if_loading&&$u.some(bv("#modal form"),function(T){return T.ajax_submitted})},track_resizes:function(){return this.track_id=setInterval(this.on_resize.bind(this),150)},on_resize:function(){var T;T=$("modal").getHeight();if(this.old_height!==T||$("modal-behind").getHeight()<T){this.old_height=T;return this.fix_position()}},vars:{}};var eK,eI,dN,d2,dg=function(T,e0){return function(){return T.apply(e0,arguments)}},bB=[].indexOf||function(e1){for(var e0=0,T=this.length;e0<T;e0++){if(e0 in this&&this[e0]===e1){return e0}}return -1},ar={}.hasOwnProperty,cE=function(e2,e0){for(var T in e0){if(ar.call(e0,T)){e2[T]=e0[T]}}function e1(){this.constructor=e2}e1.prototype=e0.prototype;e2.prototype=new e1();e2.__super__=e0.prototype;return e2};dN=B.RolePickerState={ALL:"all",PERSONAL:Constants.ROLE_PERSONAL,WORK:Constants.ROLE_WORK};eI=B.RolePicker=(function(){function T(e3){var e4,e0,e2,e1,e6,e5;if(e3==null){e3={}}this._actually_set_state=dg(this._actually_set_state,this);this._do_login=dg(this._do_login,this);this.is_user_visible=dg(this.is_user_visible,this);this.is_role_visible=dg(this.is_role_visible,this);this.ensure_role_is_visible=dg(this.ensure_role_is_visible,this);this.update_picker_ui=dg(this.update_picker_ui,this);this.set_state=dg(this.set_state,this);this.get_state=dg(this.get_state,this);this._allow_merged_state=e3.allow_merged_state!=null?e3.allow_merged_state:true;this._limit_to_role=e3.limit_to_role!=null?e3.limit_to_role:null;e6=cB.get_viewer();e0=e6.is_role_signed_in(dN.PERSONAL)&&e6.is_role_signed_in(dN.WORK);if(e3.initial_state){e2=$u.values(dN);cz((e5=e3.initial_state,bB.call(e2,e5)>=0),"RolePicker requires initial_state to be one of: "+e2);this.set_state(e3.initial_state)}else{if(this._allow_merged_state&&e0){this.set_state(dN.ALL)}else{e4=e6.get_users();cz(e4.length,"tried to use RolePicker on a page with no users");e1=e4[0];this.set_state(e1.role)}}}T.prototype.get_state=function(){return this._state};T.prototype.set_state=function(e1){var e4,e3,e0,e2;cz(this._allow_merged_state||(e1!==dN.ALL),"tried to set merged state in non-merged picker");if(this._limit_to_role!=null){cz((e1===dN.ALL)||(e1===this._limit_to_role))}if(e1===dN.ALL){e2=[Constants.ROLE_PERSONAL,Constants.ROLE_WORK,Constants.ROLE_PHOTOS];for(e3=0,e0=e2.length;e3<e0;e3++){e4=e2[e3];if(!cB.get_viewer().is_role_signed_in(e4)){this._do_login(e4,e1);return}}}else{e4=e1;if(!cB.get_viewer().is_role_signed_in(e4)){this._do_login(e4,e1);return}}return this._actually_set_state(e1)};T.prototype.update_picker_ui=function(){};T.prototype.ensure_role_is_visible=function(e0){if(!this.is_role_visible(e0)){if(this._allow_merged_state){return this.set_state(dN.ALL)}else{return this.set_state(e0)}}};T.prototype.is_role_visible=function(e0){return this._state===dN.ALL||this._state===e0};T.prototype.is_user_visible=function(e0){return this.is_role_visible(e0.role)};T.prototype._do_login=function(e0,e1){return bF.show_modal({role:e0,on_success:(function(e2){return function(){return e2._actually_set_state(e1)}})(this)})};T.prototype._actually_set_state=function(e0){if(e0===this._state){return}this._state=e0;this.update_picker_ui();return typeof this.on_state_change==="function"?this.on_state_change(e0):void 0};return T})();d2=B.RoleSelect=(function(e0){cE(T,e0);function T(e2,e1){if(e1==null){e1={}}this.limit_to_role=dg(this.limit_to_role,this);this.update_picker_ui=dg(this.update_picker_ui,this);this.on_ui_change=dg(this.on_ui_change,this);this.$container=e2;this.$bubble_picker=this.$container.find(".bubble-picker");this.$bubble_picker.on(br.CHANGED,this.on_ui_change);T.__super__.constructor.call(this,e1)}T.prototype.on_ui_change=function(e1,e3){var e2;e2=e3.clicked_val;if(e2!==this._state){this.$bubble_picker.controller().set_value(this._state);return this.set_state(e2)}};T.prototype.update_picker_ui=function(){this.$bubble_picker.controller().set_value(this._state);return this.$bubble_picker.find(".bubble-picker-label .role-option").addClass("title_bubble")};T.prototype.limit_to_role=function(e4,e2){var e1,e3;if(e4!=null){this.ensure_role_is_visible(e4);for(e1 in dN){e3=dN[e1];if(e3===e4||e3===dN.ALL){continue}this.$bubble_picker.controller().disable_option(e3,e2)}}else{for(e1 in dN){e3=dN[e1];this.$bubble_picker.controller().enable_option(e3)}}return this._limit_to_role=e4};return T})(eI);eK=B.PageRoleSelect=(function(e0){cE(T,e0);function T(e2,e1){if(e1==null){e1={}}e1.allow_merged_state=false;T.__super__.constructor.call(this,e2,e1)}T.prototype.on_state_change=function(e2){var e1;e1=(function(){switch(e2){case dN.PERSONAL:return Constants.ROLE_PERSONAL;case dN.WORK:return Constants.ROLE_WORK}})();return aZ.emit(e1)};return T})(d2);var b8;b8=B.SickInput={init:function(){var e3,e2,e0,e1,T;e1=$$(".sick-input");T=[];for(e2=0,e0=e1.length;e2<e0;e2++){e3=e1[e2];if(!e3.hasClassName("sickified")){T.push(this._create(e3))}}return T},_create:function(e2){var e1,T,e0;if(e2==null){return}e1=e2.identify();T=e2.down("input")||e2.down("textarea")||e2.down("select");T.observe("focus",function(){return e2.addClassName("focused")});T.observe("blur",function(){return e2.removeClassName("focused")});e0=function(){if(e2.hasClassName("populated")&&T.getValue()===""){e2.removeClassName("populated")}else{if(!e2.hasClassName("populated")&&T.getValue()!==""){e2.addClassName("populated")}}if(e1 in b8._handler_map){return b8._handler_map[e1]()}};bJ.show_errors();e0();return setInterval(e0,100)},_handler_map:{},add_interval_handler:function(e0,T){var e1;e1=e0.identify();return this._handler_map[e1]=T},remove_interval_handler:function(e0,T){var e1;e1=e0.identify();if(this._handler_map[e1]===T){return delete this._handler_map[e1]}}};var cT;cT=B.SuggestionInput={register:function(e0){var T;e0=$(e0);T=e0.up("form");if(cT.defaulted(e0)||e0.getValue()===""){e0.setValue(e0.title)}else{e0.addClassName("suggestion-input-unfaded")}e0.observe("blur",this.blur.bind(this));e0.observe("focus",this.focus.bind(this));e0.observe("db:value_change",this.focus.bind(this));if(T){if(!e0.id){e0.id="r_elm_id_"+(Math.random().toString())}return T.observe("submit",cT.blank(e0.id).bind(this))}},register_all:function(){var e1,e3,e0,e2,T;e2=$$(".suggestion-input");T=[];for(e3=0,e0=e2.length;e3<e0;e3++){e1=e2[e3];T.push(this.register(e1))}return T},blank:function(T){return(function(e0){return function(){var e1;e1=$(T);if(!e1){return}if(e0.defaulted(e1)){return e1.setValue("")}}})(this)},defaulted:function(T){T=$(T);return T.getValue()===T.title},do_blank:function(T){return this.blank(T)()},clear:function(T){var e0;e0={target:T};return this.focus(e0)},focus:function(T){var e0;e0=$(T.target);if(!e0){return}if(this.defaulted(e0)){e0.addClassName("suggestion-input-unfaded");return e0.setValue("")}},blur_elm:function(T){if(T.getValue()===""){T.removeClassName("suggestion-input-unfaded");T.setValue(T.title)}return T.blur()},blur:function(T){var e0;e0=$(T.target);if(!e0){return}return this.blur_elm(e0)},reset:function(e0){var T;T=$(e0);if(!T){return}T.removeClassName("suggestion-input-unfaded");T.setValue(T.title);T.defaulted=true;return T.blur()},setValue:function(T,e0){var e1;e1=$(T);if(!e1){return}e1.addClassName("suggestion-input-unfaded");e1.setValue(e0);return e1.defaulted=false}};var bh;bh=B.TitleBubble=(function(){var e1,e0,e5,e2,e3,T,e4;e4=0;e1=0;T=function(e6){return e4=e6};e3=function(fc){var fh,ff,e9,fd,e8,e6,fe,fb,e7,fa,fg;fd=bv(fc.currentTarget);fg=fd.attr("title");if(fg!=null?fg.length:void 0){fd.attr("data-title",fg);fd.removeAttr("title")}e9=parseInt(fd.data("title-delay"));ff="title-bubble-"+(e1++);fd.data("bubble-id",ff);fh=bv("<div/>",{id:ff,"class":"title_bubble_container"});if(!e9){fh.css({opacity:0});fh.addClass("has-transition")}if(fd.hasClass("white")){fh.addClass("white")}if(fd.hasClass("black")){fh.addClass("black")}fh.text(fd.attr("data-title"));fe=fd.attr("data-title-html");fh.html(fe);e7=fd.attr("data-title-hide-tail")!=="yes";if(e7){fa=bv("<div/>",{"class":"tail"});fh.append(fa)}bv(document.body).append(fh);e6=e5(fd[0],fh[0]);e8=e0(e6,fh[0],fd[0]);fh.clonePosition(fd,{setWidth:false,setHeight:false,offsetTop:e8.top-e4,offsetLeft:e8.left});fh.addClass("position-"+e6);if(e7){fa.clonePosition(fd,{setWidth:false,setHeight:false,setTop:false,offsetLeft:e8.left+e8.tail_offset_left+(bv(fh).outerWidth()/2)})}fb=function(){var fi;if(!((fh.data("pending-delay"))&&(fd.data("bubble-id")===ff))){return}fi=(parseInt(fd.data("title-fade-time")))||400;return fh.fadeIn(fi)};if(e9){fh.hide();fh.data("pending-delay",true);return setTimeout(fb,e9)}else{return fh.css({opacity:""})}};e5=function(fa,e6){var e9,e8,e7;fa=$(fa);e7=fa.getAttribute("data-title-position");e9=document.viewport.getDimensions();e8=fa.viewportOffset();if(!(e7==="above"||e7==="below"||e7==="right"||e7==="left")){e7="above"}if(e7==="left"){if(e8.left<e6.width){return"right"}}else{if(e7==="right"){if(e9.width-(e8.left+fa.getWidth())<e6.width){return"left"}}else{if(e7==="below"){if(e9.height-(e8.top+fa.getHeight())<e6.height){return"above"}}else{if(e7==="above"){if(e8.top<e6.height){return"below"}}}}}return e7};e0=function(e8,ff,fb){var fd,e9,fg,fc,fe,fa,e6,fi,fh,e7;ff=$(ff);fb=$(fb);fg=document.viewport.getDimensions();fd=ff.getDimensions();fc=fb.viewportOffset();e9=6;fe=0;fa=0;fh=0;e7=0;if(e8==="below"||e8==="above"){if(e8==="below"){fa=fb.getHeight()+e9}else{fa=(-1*fd.height)-e9}e6=fb.getWidth()/2-fd.width/2;if(fc.left+e6+fd.width>fg.width){fe=fg.width-fc.left-fd.width;fh=e6-fe-5}else{fe=e6;fh=-5}}if(e8==="left"||e8==="right"){if(e8==="right"){fe=fb.getWidth()+e9}else{fe=(-1*fd.width)-e9}fi=fb.getHeight()/2-fd.height/2;if(fc.top+fi+fd.height>fg.height){fa=fg.height-fc.top-fd.height;e7=fi-fa-5}else{fa=fi;e7=-5}}return{left:fe,top:fa,tail_offset_left:fh,tail_offset_top:e7}};e2=function(e7){var e6,e8,e9;e9=bv(e7!=null?e7.currentTarget:void 0);e6=bv("#"+e9.data("bubble-id"));if(e6.data("pending-delay")){e6.removeData("pending-delay");e8=(parseInt(e9.data("title-fade-time")))||400;return e6.fadeOut(e8,function(){return e6.remove()})}else{return e6.remove()}};return{init:function(){bv(document).on("mouseenter",".title_bubble",e3);bv(document).on("mouseleave",".title_bubble",e2).on("mouseup",".title_bubble",e2);bv(document).on("mouseenter",".title_bubble_sticky",e3);return bv(document).on("mouseleave",".title_bubble_sticky",e2)},set_vertical_space:T,hide_all:function(){return bv(".title_bubble_container").remove()}}})();var d5;d5=INLINE_JS.Tooltip=B.Tooltip={attach:function(e4,e1,T,e0){var e3,e2;if(e0==null){e0={}}e4=$(e4);T=(T?$(T):null);e3=d9.make(e1,e4.tail_position,e0.tail_position,e0.width,e0);e3.setStyle({display:"none",position:"absolute"});$("floaters").__sert(e3);if(e4.match("#modal-content *")||e4.match(".db-modal-content *")){e3.style.zIndex="13001"}else{e3.style.zIndex=""}if(e4.tail_position==="right"){e2=(dQ.ie?32:12);e3.style.marginLeft=-(e3.getWidth()+e4.getWidth()+e2)+"px"}e4.tooltip=e3;e4.out_target=(T?true:false);e4.observe("mouseout",this.mouseout("target",e4));e4.observe("mouseover",this.mouseover("target",e4));e4.out_trigger=(T?false:true);if(T){T.observe("mouseout",this.mouseout("trigger",e4));T.observe("mouseover",this.mouseover("trigger",e4))}e4.out_tooltip=true;e3.observe("mouseout",this.mouseout("tooltip",e4));return e3.observe("mouseover",this.mouseover("tooltip",e4))},update:function(e0,T){if(e0.tooltip){return $(e0.tooltip).update(T)}},mouseover:function(T,e0){return function(){return e0["out_"+T]=false}},mouseout:function(T,e0){return function(){e0["out_"+T]=true;return d5.hide_if_out.defer(e0)}},show_by:function(e0){var e1,T;e1=bv(e0.tooltip);e0=bv(e0);e1.show();T=Math.floor(e1[0].offsetHeight/2);return e1.clonePosition(e0,{setWidth:false,setHeight:false,offsetTop:Math.floor(e0[0].offsetHeight/2)-T,offsetLeft:e0[0].offsetWidth+1})},hide_if_out:function(T){var e0;if(!T.out_target||!T.out_trigger||!T.out_tooltip){return}e0=$(T.tooltip);return e0.hide()},show:function(e3,e2,e0,T,e1){if(T==null){T="left"}e3=$(e3);if(!e3.tail_position){e3.tail_position=T}e0=(e0?$(e0):null);if(!e3.tooltip){this.attach(e3,e2,e0,e1)}return this.show_by(e3)}};var bS;bS=INLINE_JS.TreeView=B.TreeView={tv:{},loaded:false,user:null,role_icon:"",set_params:function(T){return this.ajax_params=T},init:function(e1,T,e2){var e0;if(e2==null){e2="treeview"}this.tv[e2]={};e0=this.tv[e2];e0.autohide=(T===null?true:T);e0.handler=e1;e0.viewdiv=$(e2);e0.hidefunc=this.hide.bindAsEventListener(this);this.ajax_params={};document.observe(bu.ADD,(function(e3){return function(e4){return e3.schedule_reset()}})(this));document.observe(bu.REMOVE,(function(e3){return function(e4){return e3.schedule_reset()}})(this));return document.observe(bu.MOVE,(function(e3){return function(e4){return e3.schedule_reset()}})(this))},schedule_reset:function(){return this.loaded=false},reset:function(e4){var e1,e2,e0,e6,T,e3,e5;e1={url:"/ajax_subtreeview",type:"post",data:bv.extend({},this.ajax_params),success:(function(e7){return function(e9){var fa,e8;e8=[];for(fa in e7.tv){if(e7.tv.hasOwnProperty(fa)){e7.tv[fa].viewdiv.down(".treeview-folders").update(e9);if(e4&&e4.onSuccess){e8.push(e4.onSuccess(e9))}else{e8.push(void 0)}}else{e8.push(void 0)}}return e8}})(this)};if(e4!=null?e4.user:void 0){if(e4.user.id!==((e5=this.user)!=null?e5.id:void 0)){e6=bv("<p />",{id:"treeview-loading"});T=bv("<img />",{src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif"});e6.append(T);e3=" "+el("Loading your folders");e6.append(e3);bv("#dest-treeview .treeview-folders").html(e6);this.user=e4.user}e1.subject_user=e4.user;e0=cB.get_role_title(e4.user);if(cB.get_viewer().is_paired){if(e4.user.is_team){e2="s_briefcase"}else{e2="s_house"}}else{e2="dropbox"}if(!e0){e0=el("Dropbox")}bv("#first-treeview-link span").text(e0);cm.replace(bv("#root-img")[0],"web",this.role_icon,e2);this.role_icon=e2}else{bv("#first-treeview-link span").text(el("Dropbox"))}return bv.ajax(e1)},toggle:function(e1,e0){var T;Event.stop(e1);T=this.tv[e0||"treeview"];if(T.shown){T.shown=false;this.hide(e1,e0)}else{T.shown=true;this.show(e1.target,e0)}return false},hide:function(e1,e0){var T;T=this.tv[e0||"treeview"];if(!e1||!$(e1.target).descendantOf(T.viewdiv)){T.viewdiv.hide();Event.stopObserving(window,"click",T.hidefunc);return T.shown=false}},show:function(e1,e0){var e2,T;T=this.tv[e0||"treeview"];e1=$(e1);e1.blur();e2=e1.cumulativeOffset();T.viewdiv.setStyle({top:(e2.top+e1.getHeight())+"px",left:(e2.left-4)+"px"});T.viewdiv.show();return Event.observe(window,"click",T.hidefunc)},toggleNode:function(e0){var T;e0=$(e0);T=e0.down("img");if(T.className.match("bullet_plus")){cm.replace(T,"web","bullet_plus","bullet_minus")}else{cm.replace(T,"web","bullet_minus","bullet_plus")}e0.up().next("div").toggle();e0.blur();return false},toggleNodeAjax:function(e2,T,e0){var e1,e3;if(e2.fetched_children){return this.toggleNode(e2)}e2=$(e2);e1=e2.down("img");e3=cm._get(e1);e1.src="/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif";bv.ajax({url:"/ajax_subtreeview"+T,type:"post",data:bv.extend({},this.ajax_params),subject_user:e0,success:(function(e4){return function(e5){var e6;e6=new Element("div",{style:"display: none;"}).update(e5);e2.up().__sert({after:e6});e2.fetched_children=true;cm._set(e1,e3);return e4.toggleNode(e2)}})(this),complete:function(){if(/loading/.match(e1.src)){return cm._set(e1,e3)}}});return false},handle:function(e1,e0){var e2,T;e2=$H(this.tv).keys();T=$(e0).ancestors().find(function(e3){return e2.include(e3.id)});if(!T){return}T=this.tv[T.id];bv(document).trigger("db:treeview_selected",[e1]);if(T.handler){T.handler(e1,e0)}if(T.autohide){this.hide(T.id)}return false},move:function(e1,e2,e0){var T;T=$(e1);if(!this.loaded){this.reset({onSuccess:(function(e3){return function(){e3.loaded=1;return e3.move(e1,e2,e0)}})(this),user:e0!=null?e0.user:void 0})}else{if(e0&&e0.onSuccess){e0.onSuccess()}}cz(T,"Couldn't find tree_id");cz($(e2),"Couldn't find location_id");$(e2).appendChild(T);return T.show()}};var aK;aK=B.ULSelectMenu=(function(){var e2,e6,e1,e7,e8,e3,e5,T,e4,e0,e9;e2=function(fa){return fa.removeClassName("shown")};e9=function(fa){return fa.toggleClassName("shown")};e5=function(){return this.removeClassName("hover")};e3=function(){return this.addClassName("hover")};T=function(fe,fd){var fa,ff,fc,fb;fb=[];for(ff=0,fc=fd.length;ff<fc;ff++){fa=fd[ff];fb.push(fe.insert(fa))}return fb};e7=function(fc,fa,fb){T(fc,fb);if(fc.firstChild!==fa){return fc.__sert({top:fa})}};e4=function(fb,fc){var fa;fa="selected";bv(fb).find("."+fa).removeClass(fa);return bv(fc).addClass(fa)};e0=function(fc,ff){var fg,fe,fb,fd,fa;fd=fc.select("li");fa=[];for(fe=0,fb=fd.length;fe<fb;fe++){fg=fd[fe];if(fg.getAttribute("data-value")===ff){fa.push(e4(fc,fg))}else{fa.push(void 0)}}return fa};e8=function(fa,fc,fb){return function(fd){if(!fa.hasClassName("selected")){e4(fc,fa);fc.fire("db:change",fa.getAttribute("data-value"));return e2(fc)}else{e7(fc,fa,fb);return e9(fc)}}};e6=function(fc){var ff,fi,fe,fb,fh,fa,fd,fg;fi=fc.select("li");cz(fi.length,"Empty list of options "+fc.identify());fe=void 0;if(fi.length===1){fc.addClassName("one")}else{for(fd=0,fg=fi.length;fd<fg;fd++){ff=fi[fd];fh=ff.getAttribute("data-value");cz(fh,ff.identify()+" missing data value");ff.observe("click",e8(ff,fc,fi));ff.observe("mouseenter",e3);ff.observe("mouseleave",e5);if(ff.hasClassName("selected")){fe=ff}}$(document.body).observe("click",function(fj){if($(fj.target).up(".ul_select_menu")===fc){return}return e2(fc)})}if(!fe){fe=fi[0]}fe.addClassName("selected");fa=new Element("span");fb=fe.getDimensions();fa.setStyle({width:fb.width+"px",height:fb.height+"px",position:"relative",display:"inline-block"});return fc.wrap(fa)};e1=function(){var fe,fd,fb,fc,fa;fc=$$(".ul_select_menu");fa=[];for(fd=0,fb=fc.length;fd<fb;fd++){fe=fc[fd];fa.push(e6(fe))}return fa};bv(e1);return{init:function(fa){return e6(fa)},set_selected_by_value:e0}})();var F;F=B.DBCalendar=Class.create({initialize:function(e0,T){this.options=T||{};this.container=$(e0);cz(this.container,"Couldn't find the element");this.today=new Date();if(this.options.disable_future){this.options.last_day=dQ.start_of_day(this.options.last_day||this.today)}if(this.options.disable_past){this.options.first_day=dQ.start_of_day(this.options.first_day||this.today)}this.view_date=dQ.start_of_day(this.options.selected_date||this.today);this.selected_date=dQ.start_of_day(this.options.selected_date||this.today);return this.render()},_change_month:function(e0,T){Event.stop(e0);this.view_date.setMonth(T);return this.render()},is_valid_date:function(e2,e4,e3,e1,T){var e0;e2=parseInt(e2,10);e4=parseInt(e4,10);e3=parseInt(e3,10);e1=parseInt(e1,10);T=parseInt(T,10);e1=e1||1970;T=T||(new Date()).getFullYear()+1;e4+=1;if(e3<e1){return false}if(e3>T){return false}if(e4<1||e4>12){return false}if(e2<=0){return false}if(e4===2){e0=((e3%4)===0)&&(((e3%100)!==0)||((e3%400)===0));if(e0){return e2<=29}else{return e2<=28}}else{if(e4===4||e4===6||e4===9||e4===11){return e2<=30}else{return e2<=31}}},change_date:function(T,e2,e0){var e1;if(!this.is_valid_date(T,e2,e0)){return}e1=e0!==this.view_date.getFullYear()||e2!==this.view_date.getMonth();this.selected_date=new Date(e0,e2,T);if(e1){this.view_date.setMonth(e2);this.view_date.setFullYear(e0);this.render()}else{bv(this.container).find(".selected").removeClass("selected");bv(this.container).find("a#day"+T+"-"+e2).addClass("selected")}if(this.options.onDateChange){return this.options.onDateChange(this.selected_date)}},render:function(){var e2,e8,e6,e4,e3,e0,e5,e1,e7,T;e8=this.render_days();e4=bv(".current-month",e8);e5=e4.first().data("date");e0=e4.last().data("date");T=e5<=this.options.first_day;e7=e0>=this.options.last_day;e2=new Element("div");e2.addClassName("calendar clearfix");if(!e7){this._next_month=(function(e9){return this._change_month(e9,this.view_date.getMonth()+1)}).bind(this);e3=new Element("a");e3.addClassName("changemonth next");e3.update(cm.make("web","arrowright",{}));Event.observe(e3,"click",this._next_month);e2.__sert(e3)}if(!T){this._prev_month=(function(e9){return this._change_month(e9,this.view_date.getMonth()-1)}).bind(this);e1=new Element("a");e1.addClassName("changemonth prev");e1.update(cm.make("web","arrowleft",{}));Event.observe(e1,"click",this._prev_month);e2.__sert(e1)}e6=new Element("h5");e6.update(el("%(month)s %(year)s",{comment:"For example 'January 2010'. This is used as part of a calendar."}).format({month:bU.month_name(this.view_date.getMonth()),year:this.view_date.getFullYear()}));e2.__sert(e6);e2.__sert(e8);return this.container.__date(e2)},render_days:function(){var e6,e5,T,e4,e0,e3,e2,e1;e5=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),1);e2=e5.getDay();e6=new Element("div");e6.addClassName("days");for(T=e1=e2;e2<=0?e1<0:e1>0;T=e2<=0?++e1:--e1){e3=new Date(e5.getFullYear(),e5.getMonth(),e5.getDate());e3.setDate(e3.getDate()-T);e6.__sert(this.render_day(e3,true))}e4=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),1);while(e4.getMonth()===this.view_date.getMonth()){e6.__sert(this.render_day(e4));e4=new Date(this.view_date.getFullYear(),this.view_date.getMonth(),e4.getDate()+1)}e0=new Date(this.view_date.getFullYear(),this.view_date.getMonth()+1,0);while(e0.getDay()!==6){e0=new Date(e0.getFullYear(),e0.getMonth(),e0.getDate()+1);e6.__sert(this.render_day(e0,true))}return e6},render_day:function(e0,e2){var T,e1;e1=!e2;if(this.options.last_day){e2=e2||e0>this.options.last_day}if(this.options.first_day){e2=e2||e0<this.options.first_day}T=new Element(e2?"span":"a");bv(T).data("date",e0);if(e1){T.addClassName("current-month")}T.update(e0.getDate());T.addClassName("date");T.writeAttribute("id","day"+e0.getDate()+"-"+e0.getMonth());if(this.selected_date.getDate()===e0.getDate()&&this.selected_date.getMonth()===e0.getMonth()&&this.selected_date.getFullYear()===e0.getFullYear()){T.addClassName("selected")}if(e2){T.addClassName("inactive")}else{this._handler=(function(e4){var e3;e3=e4.target.identify().substr(3).split("-");return this.change_date(e3[0],this.view_date.getMonth(),this.view_date.getFullYear())}).bind(this);Event.observe(T,"click",this._handler)}return T}});var aM;aM=B.DatePickerInput=Class.create({initialize:function(T,e1){var e4,e2,e3,e0;this.container=T;this.options={};Object.extend(this.options,e1||{});this.input=this.container.down(".input-date");this.display=this.container.down(".visible-date");e0=(this.input.value?dQ.from_mysql_date(this.input.value):new Date());if(this.container.hasAttribute("data-first")){e3=dQ.from_mysql_date(this.container.getAttribute("data-first"))}e4=this.options.disable_future!=null?this.options.disable_future:true;e2=this.options.disable_past!=null?this.options.disable_past:true;this.cal_container=this.container.down(".cal-container");this.calendar=new F(this.cal_container,{onDateChange:this.onDateChange.bind(this),first_day:e3,disable_future:e4,disable_past:e2,selected_date:e0});this.container.observe("click",this.show_cal.bindAsEventListener(this));$(document.body).observe("click",this.hide_cal.bind(this));return this.onDateChange(e0)},show_cal:function(e0){var T;if(e0){Event.stop(e0)}T=$(e0.target);if(T.match(".cal-container")||T.up(".cal-container")){return}bv(".cal-container").hide();return this.cal_container.show()},hide_cal:function(){return this.cal_container.hide()},onDateChange:function(T){this.input.value=dQ.to_mysql_date(T,false);this.display.update(K.localize(T));return this.hide_cal()}});var eW;eW=B.TextInputDatePicker=Class.create({initialize:function(e2,e1){var e4,e3,e0,T;this.options={include_seconds:true,include_microseconds:true,choose_eod:false};Object.extend(this.options,e1||{});this.input=$(e2);cz(this.input,"Couldn't find the element "+e2.toString());e0=new Date();T=(this.input.value?dQ.from_mysql_date(this.input.value):false);e3=new Date(e0.getUTCFullYear(),e0.getUTCMonth(),e0.getUTCDate());this.cal_icon=cm.make("web","calendar_view_month",{align:"absmiddle"});this.cal_container=new Element("div",{id:"cal_container_"+e2,style:"display: none; position: absolute; z-index: 1"});this.calendar=new F(this.cal_container,{onDateChange:this.onDateChange.bind(this),last_day:e3,selected_date:T});this.input.__sert({after:this.cal_icon});this.cal_icon.observe("click",this.toggle_cal.bindAsEventListener(this));e4=bv(this.input);bv(this.cal_container).clonePosition(e4,{setWidth:false,setHeight:false,offsetTop:e4[0].offsetHeight});return this.cal_icon.__sert({after:this.cal_container})},toggle_cal:function(T){if(T){Event.stop(T)}return this.cal_container.toggle()},hide_cal:function(T){if(T){Event.stop(T)}return this.cal_container.hide()},onDateChange:function(T){if(this.options.choose_eod){T.setTime(dQ.start_of_day(T).getTime()+86399999)}this.input.value=dQ.to_mysql_date(T,this.options.include_seconds,this.options.include_microseconds);return this.hide_cal()}});ah.window_load(R.register.bind(R));bv(b8.init.bind(b8));bv(cT.register_all.bind(cT));Event.observe(window,"scroll",function(){return bh.hide_all()});bv(function(){Y.interval=setInterval(Y.check.bind(Y),500);dz.init();return bh.init()});var aP;aP=B.LocaleSelector={init:function(){bv(document).on("click",".modal-locale-link",(function(T){return function(e0){e0.preventDefault();return T.show()}})(this));bv(document).on("click",".modal-locale-link-index-page",(function(T){return function(e0){e0.preventDefault();T.logShow();return T.show()}})(this));return bv(document).on("click",".modal-team-locale-link",(function(T){return function(e0){e0.preventDefault();return T.show_team_modal()}})(this))},show:function(){if(!this.modal){this.modal=new eM({element_id:"locale-selector-modal"})}return this.modal.show()},logShow:function(){return bv.ajax({url:"https://"+Constants.WEBSERVER+"/log_user_opened_locale_selector",type:"POST"})},show_team_modal:function(){if(!this.team_modal){this.team_modal=new bf({element_id:"locale-selector-modal"})}return this.team_modal.show()}};bv(function(){return aP.init()});var a7,ar={}.hasOwnProperty,cE=function(e2,e0){for(var T in e0){if(ar.call(e0,T)){e2[T]=e0[T]}}function e1(){this.constructor=e2}e1.prototype=e0.prototype;e2.prototype=new e1();e2.__super__=e0.prototype;return e2};a7=INLINE_JS.ChangeNameModal=B.ChangeNameModal=(function(T){cE(e0,T);function e0(){e0.__super__.constructor.call(this,{element_id:"change-name-modal"});this.on_confirm_button_click=(function(e1){return function(e5){var e4,e2,e3;e5.preventDefault();e4=bv(e5.target);e2=e4.closest("form");e3=function(){e1.hide();return location.reload()};return bJ.ajax_submit(e2[0],false,e3,null,e4[0])}})(this)}return e0})(dS);var bM,ef,dg=function(T,e0){return function(){return T.apply(e0,arguments)}},ar={}.hasOwnProperty,cE=function(e2,e0){for(var T in e0){if(ar.call(e0,T)){e2[T]=e0[T]}}function e1(){this.constructor=e2}e1.prototype=e0.prototype;e2.prototype=new e1();e2.__super__=e0.prototype;return e2};ef=B.ManageAliasModal=(function(e0){cE(T,e0);function T(e1){this.options=e1;this._poll_until_verified=dg(this._poll_until_verified,this);this._get_params_from_target=dg(this._get_params_from_target,this);this._on_load=dg(this._on_load,this);this._show_action_panel=dg(this._show_action_panel,this);this._input_enter_handler=dg(this._input_enter_handler,this);this.resend_verify=dg(this.resend_verify,this);this.remove_alias=dg(this.remove_alias,this);this.add_alias=dg(this.add_alias,this);this.refresh_alias=dg(this.refresh_alias,this);this.on_show=dg(this.on_show,this);T.__super__.constructor.call(this,this.options)}T.prototype.before_show=function(e1){T.__super__.before_show.call(this,e1);this.polling=0;e1.find(".alias-action").on("click",this._show_action_panel);e1.find(".alias-action-submit").on("click",this.add_alias);e1.find("form").submit(function(){return false});return e1.find(".alias-action-inputs input").on("keyup",this._input_enter_handler)};T.prototype.on_show=function(){return this.refresh_alias(true,this._poll_until_verified)};T.prototype.refresh_alias=function(e2,e1){if(e2==null){e2=true}if(e2){bJ.clear_errors()}return new Ajax.DBRequest("/account/alias/get",{subject_user:this.options.subject_user,onSuccess:(function(e3){return function(e4){e3.$modal_window.find(".dynamic-content").html(e4.responseText);e3._on_load(e4);if(typeof e1==="function"){return e1()}}})(this),onFailure:(function(e3){return function(e4){return e3.hide()}})(this)})};T.prototype.add_alias=function(e4){var e3,e1,e2,e5;e4.preventDefault();e1=bv(e4.currentTarget).closest("form");e3=e1.find(".alias-action-submit");e5={};e5[Constants.UID_PARAM_NAME]=this.options.subject_user.id;e2=(function(e6){return function(){var e7;e6.$modal_window.find(".alias-action-inputs input").val("");e6.polling=0;e7=e6.polling?null:e6._poll_until_verified;return e6.refresh_alias(true,e7)}})(this);return bJ.ajax_submit(e1[0],false,e2,false,e3[0],e5,"before")};T.prototype.remove_alias=function(e1){var e2;e1.preventDefault();e2=this._get_params_from_target(e1.currentTarget);return new Ajax.DBRequest("/account/alias/remove",{subject_user:this.options.subject_user,parameters:e2,onSuccess:(function(e3){return function(e4){return e3.refresh_alias()}})(this)})};T.prototype.resend_verify=function(e1){var e2;e1.preventDefault();e2=this._get_params_from_target(e1.currentTarget);return new Ajax.DBRequest("/account/alias/send_verify",{subject_user:this.options.subject_user,parameters:e2,onSuccess:(function(e3){return function(e4){return e3.refresh_alias()}})(this)})};T.prototype._input_enter_handler=function(e1){e1.preventDefault();e1.stopPropagation();if(e1.which===13){return this.add_alias(e1)}};T.prototype._show_action_panel=function(e3){var e2,e1;e3.preventDefault();e1=bv(e3.currentTarget).data("target");this.$modal_window.find(".alias-action-panel").hide();e2=this.$modal_window.find("#"+e1).show();return e2.find("input:visible:enabled:first").focus()};T.prototype._on_load=function(e1){a6.register_all();this.$dynamic=this.$modal_window.find("#alias-list-container");this.$dynamic.on("click",".alias-remove",(function(e2){return function(e3){return e2.remove_alias(e3)}})(this));return this.$dynamic.on("click",".alias-verify",(function(e2){return function(e3){return e2.resend_verify(e3)}})(this))};T.prototype._get_params_from_target=function(e3){var e1,e2,e4;e1=bv(e3);e4=e1.data("alias-type");e2=e1.closest(".alias-row").find(".alias-text").text();return{alias:e2,alias_type:e4}};T.prototype._poll_until_verified=function(){var e3,e4,e2,e1;e4=5;e3=60;e2=(function(e5){return function(){return e5.refresh_alias(false,e5._poll_until_verified)}})(this);e1=this.$dynamic.find(".alias-verify").length;if(e1&&this.polling<e3){this.polling++;return setTimeout(e2,e4*1000)}else{return this.polling=0}};return T})(dS);bM=INLINE_JS.AliasManager=B.AliasManager={show:function(e3){var e1,e2,e0,T;T=cB.get_viewer().get_user_by_role(e3);if(T==null){return}if(!T.is_email_verified){if(e3===Constants.ROLE_PERSONAL){personal_email_verification.verified_or_show()}else{work_email_verification.verified_or_show()}return}e0=cB.get_viewer().is_paired?e3:"";e2=el("Manage your %(role_show)s contact methods").format({role_show:e0});e1=new ef({element_id:"manage-alias",title:e2,subject_user:T,role:T.role});e1.show()}};var di;di=INLINE_JS.BonusTable=B.BonusTable={_tmpl:null,_inited:null,_next_page:0,_fetching_page:false,init:function(T){this.user_id=T;if(di._inited){return}di._inited=true;$("bonus-loading").show();di._tmpl=eV.tmpl("bonus_row_tmpl");di.listen();return di.get_next_page()},_render:function(e2){var e0,e3,e1,T;e0=[];for(e1=0,T=e2.length;e1<T;e1++){e3=e2[e1];e0.push(di._tmpl({row:e3,Sprite:cm}))}return $("bonus-table").__sert(e0)},get_next_page:function(){if(di._fetching_page){return}di._fetching_page=true;return new Ajax.DBRequest("/account/bonus_page/"+di._next_page,{onSuccess:function(e0){var e2,T,e1;e2=e0.responseText.evalJSON();e1=e2.rows;T=e2.has_more;di._render(e1);$("bonus-loading").hide();if(T){di._next_page+=1;$("load-more-bonus").show()}else{$("load-more-bonus").hide()}return di._fetching_page=false},subject_user:this.user_id})},_max_referral_over:function(e0){var T,e2,e1;e2=bv(e0.currentTarget);e1=el("You've earned the maximum amount of referral space. Thanks for inviting people to Dropbox!");T=bv(d9.make(e1,"right","middle"));Element.absolutize(T[0]);e2.append(T);T.clonePosition(e2,{setWidth:false,setHeight:false});return T.css({width:"200px",left:(parseInt(T.css("left"),10)-210)+"px",top:(parseInt(T.css("top"),10)-55)+"px"})},_max_referral_out:function(e4){var T,e3,e1,e2,e0;e2=bv(".reached-max-referral-bonus .bubble");e0=[];for(e3=0,e1=e2.length;e3<e1;e3++){T=e2[e3];e0.push(T.remove())}return e0},listen:function(){bv("#load-more-bonus").on("click",di.get_next_page.bind(di));bv(document).on("mouseenter",".reached-max-referral-bonus",di._max_referral_over);return bv(document).on("mouseleave",".reached-max-referral-bonus",di._max_referral_out)},toggle:function(){if(bv("#bonus-list").is(":visible")){this.hide();return bv("#space-earned-link").text(el("View all space earned"))}else{this.show();return bv("#space-earned-link").text(el("Hide space earned"))}},show:function(){return bv("#bonus-list").slideDown(150)},hide:function(){return bv("#bonus-list").slideUp(150)}};var A,s,c;A=INLINE_JS.DowngradeReasons=B.DowngradeReasons={reasons:{},addReason:function(T){return this.reasons[T]=true},addReasons:function(T){var e2,e3,e1,e0;e0=[];for(e3=0,e1=T.length;e3<e1;e3++){e2=T[e3];e0.push(this.addReason(e2))}return e0},change:function(e4,e1,T){var e5,e7,e6,e2,e0,e3;e4=parseInt(e4,10);e7=$(e1);cz(e7,"Couldn't find container for DowngradeReason");e5=false;e3=this.reasons;for(e2 in e3){e6=e3[e2];e0=$(T+e2);cz(e0,"Couldn't find container for ",T+e2);if(e6&&parseInt(e2,10)===e4){e0.show();e5=true}else{e0.hide()}}if(e5){return e7.show()}else{return e7.hide()}}};s=B.DowngradeReasons2={init:function(){var e0,e2,T,e1;e1=["input[name=downgrade_reason_id]","input[name=other_reason_id]"];for(e2=0,T=e1.length;e2<T;e2++){e0=e1[e2];bv(e0).change(function(e4){var e3;e3=e4.target.id.indexOf("other")>=0;return s.change(e3,e4.target.getValue())})}return bv(".shared-additional-info").attr("name","shared_additional_info")},change:function(e1,T){var e0;bv(".downgrade-other-reason .error-message").hide();if(e1){return}e0="#downgrade-info-"+T;bv(".downgrade-info").hide();bv(e0).show();bv(".downgrade-info textarea").removeAttr("name");bv(e0+" textarea").attr("name","additional_info");return bv("input[name=other_reason_id]").removeAttr("checked")}};c=B.DowngradeSurvey={init:function(){var T;T="#downgrade-survey-form";return bv(""+T).on("submit",(function(e0){return function(e3){var e2,e1;e1=bv(""+T+" input[name=other_reason_id]:checked").length;e2=bv(""+T+" input[id=downgrade-radio-8]");if(e2.is(":checked")&&e1===0){bv(".downgrade-other-reason .error-message").show();return e3.preventDefault()}}})(this))}};var b1;b1=INLINE_JS.GetSpace=B.GetSpace={_current_space:null,_why_msg:null,_twitter_url:null,offer_highlight_color:"#ffa",init:function(e1,e0,e2){var T;b1._current_space=e1;b1._why_msg=e0;b1._twitter_url=e2;$("space-actions").on("click",".space-action",b1.perform_action);T=D.parse(window.location.href).fragment;if(T){return b1.highlight_offer(T)}},highlight_offer:function(e0){var T,e1;T=bv("#"+e0);e1=T.css("background-color");return T.css("background-color",b1.offer_highlight_color).delay(2000).animate({"background-color":e1}).queue(function(){return T.css("background-color","")})},perform_action:function(e0){var e1,T;T={contact_sales:b1._contact_sales,contact_support:b1._contact_support,teams:b1._teams,upgrade:b1._upgrade,plans:b1._plans,refer:b1._refer,get_started:b1._get_started,fb_link:b1._fb_link,twitter_link:b1._twitter_link,twitter_follow:b1._twitter_follow,why_like:b1._why_like,mailbox_link:b1._mailbox_link};e1=$(e0.target);if(!e1.hasClassName("space-action")){e1=e1.up(".space-action")}return T[e1.id]()},_teams:function(){return window.location.href="/business?tk=dropbox&ag=getspace&ad=v1"},_contact_sales:function(){return window.location.href="mailto:sales@dropbox.com"},_contact_support:function(){return window.location.href="/support"},_plans:function(){return window.location.href="/plans"},_upgrade:function(){return window.location.href="/upgrade"},_refer:function(){return window.location.href="/referrals"},_get_started:function(){return window.location.href="/gs"},_fb_link:function(){return ed.do_auth(function(){b1._refresh_link_bonuses();return b1._completed($("fb_link"))},cB.get_viewer().personal_user.id)},_twitter_link:function(){return ct.do_auth(function(){b1._refresh_link_bonuses();ct.set_is_authed(cB.get_viewer().personal_user.id,true);return b1._completed($("twitter_link"))},cB.get_viewer().personal_user.id)},_twitter_follow:function(){if(ct.is_authed(cB.get_viewer().personal_user.id)){return b1.follow_dropbox()}else{return ct.do_auth(b1.follow_dropbox,cB.get_viewer().personal_user.id)}},_why_like:function(){eS.show(el("Tell us why you love Dropbox"),$("why-i-like-modal"));$("why-i-like-input").focus();return dQ._track_twitter_chars_left("why-i-like-input",90)},_mailbox_link:function(){return window.location.href="http://www.mailboxapp.com/"},follow_dropbox:function(){if(!ct.is_authed(cB.get_viewer().personal_user.id)){b1._refresh_link_bonuses();ct.set_is_authed(cB.get_viewer().personal_user.id,true)}return ct.follow_dropbox({showWorking:function(){return $("twitter_follow").down(".title").__date(el("Following Dropbox on Twitter..."))},onFailure:function(){return $("twitter_follow").down(".title").__date(el("Follow Dropbox on Twitter"))},onSuccess:function(){if($("twitter_link")&&$("twitter_link").visible()){b1._completed($("twitter_link"))}return b1._completed($("twitter_follow"))}},cB.get_viewer().personal_user.id)},submit_why:function(){b1._why_msg=$F("why-i-like-input");return bJ.ajax_submit($("why-i-like-form"),false,(function(){eS.hide();return b1._completed($("why_like"))}),false,$("why-i-like-submit"))},_completed:function(e0){var T;e0.addClassName("completed");e0.down(".icon-col").__date(cm.make("web","check_36"));bv(e0).css("opacity",0.5).fadeTo(500,1);setTimeout((function(){return bv(e0).css("opacity",1).slideUp().animate({opacity:0},{queue:false,duration:"normal"})}),1500);T=parseInt(e0.down(".space").readAttribute("data-space"),10);b1._current_space+=T;$("current-space").__date(aA.format_bytes(b1._current_space));$("current-space").addClassName("updated");return setTimeout((function(){return $("current-space").removeClassName("updated")}),5000)},_refresh_link_bonuses:function(){return new Ajax.DBRequest("/social_recheck")}};var bq;bq=B.Help={toggle_more_help:false,show_os:function(e0,e1,T){e1=$(e1);$$(".os-filter").invoke("removeClassName","selected");e1.addClassName("selected");$$(".help-os-section").invoke("hide");$$(".help-os-"+T).invoke("show");return Event.stop(e0)},vote:function(T,e0){new Ajax.DBRequest("/help/"+T+"/vote/"+e0);bv("#help-vote-cont").fadeOut();return ab.success(el("Thanks for your feedback!"))}};var ei,dG,aa,r,dg=function(T,e0){return function(){return T.apply(e0,arguments)}},ar={}.hasOwnProperty,cE=function(e2,e0){for(var T in e0){if(ar.call(e0,T)){e2[T]=e0[T]}}function e1(){this.constructor=e2}e1.prototype=e0.prototype;e2.prototype=new e1();e2.__super__=e0.prototype;return e2};dG=INLINE_JS.Hosts=B.Hosts={attach_host_listener:function(e3,e1){var e0,e2,e4,T;e0=bv("#"+e3);e4=e0.data("host-ids");e2=e0.data("display-name");T=function(){return new aa(e4,e2,e1,null,null).show()};return bv(".unlink-host-link",e0).on("click",T)},edit:function(e4,e1){var e0,e5,e6,e3,e2,T;e6=bv("#host-device-row-"+e1+" .host-item .sprite-text");if(e6.data("editing")==="true"){return false}e6.data("editing","true");e5=e6.text();e6.data("previous",e5);e4=$u.values(e4);e3=bv('<input type="text" class="name-input skinny-input" size="20" maxlength="256" style="word-wrap: break-word;" />').val(e5);T=bv('<input type="button" class="button">').val(el("Save"));T.on("click",function(){return dG.doneEditing(e4,e1)});e0=bv('<input type="button" class="button grayed">').val(el("Cancel"));e0.on("click",function(){return dG.cancelEditing(e1)});e6.empty();e6.append(e3,"&nbsp;",T,"&nbsp;",e0);e2=bv("input",e6);e2.on("keydown",function(){return dG.checkKey(e4,e1)});return e2.focus()},doneEditing:function(e1,e0){var e2,T;e2=bv("#host-device-row-"+e0+" .host-item .sprite-text");T=bv("input",e2).val();return bv.ajax({url:"/account/change_host_name",data:{host_ids:JSON.stringify(e1),name:T},type:"POST"}).success(function(e3){return dG.unedit(e2,JSON.parse(e3).display_name)})},cancelEditing:function(T){var e0;e0=bv("#host-device-row-"+T+" .host-item .sprite-text");return dG.unedit(e0,e0.data("previous"))},unedit:function(e0,T){e0.data("editing","false");return e0.text(T)},dismiss:function(e1,e0,e2,T,e3){new bv.ajax("/account/dismiss_unlink",{type:"POST",data:{host_id:e1,user_id:e0,team_id:e2},subject_user:e3,success:function(e4){return T.remove()}});return false},checkKey:function(e0,T){return function(e1){e1=e1||window.event;if(e1.keyCode===Event.KEY_RETURN){dG.doneEditing(e0,T)}if(e1.keyCode===Event.KEY_ESC){return dG.cancelEditing(T)}}},show_device_unlink_modal:function(e2,e3,e5,e1,e0,e7,T){var e6,e4;e6=bv("#unlink-device-modal-"+e7);e4={both:$u.values(e0),personal:[e0[Constants.ROLE_PERSONAL]],work:[e0[Constants.ROLE_WORK]]};eS.show(e1,e6[0]);if($u.values(e0).length>1){e6.addClass("show-selector")}return bv("form input[type=submit]",e6).on("click",function(e8){e8.preventDefault();e0=e4[bv(".unlink-select select",e6).val()];bJ.add_vars(bv("form",e6)[0],{user_ids:JSON.stringify(e0),app_id:e3,device_id:JSON.stringify(e2),device_name:T});return bv("form",e6).submit()})}};ei=B.DeleteFailuresModal=(function(T){cE(e0,T);function e0(){this.on_show=dg(this.on_show,this);this.on_confirm_button_click=dg(this.on_confirm_button_click,this);return e0.__super__.constructor.apply(this,arguments)}e0.prototype.on_confirm_button_click=function(e1){e1.preventDefault();window.location.href="/delete_failures?host_id="+this.host_id;return this.hide()};e0.prototype.on_show=function(e2){var e1;e1=a4("Dropbox couldn't delete %(num_failures)d file from the computer <strong>%(host_name)s</strong>. You can download the name of this file and the reason why it couldn't be deleted.","Dropbox couldn't delete %(num_failures)d files from the computer <strong>%(host_name)s</strong>. You can download the names of these files and the reasons why they couldn't be deleted.",this.num_failures).format({host_name:this.name.escapeHTML(),num_failures:this.num_failures});return this.$modal_window.find(".failures_message").html(e1)};return e0})(dS);r=INLINE_JS.show_delete_failures_modal=B.show_delete_failures_modal=function(e1,e0,T){var e2;e2=new ei({element_id:"delete-failures-modal"});e2.host_id=e1;e2.name=e0;e2.num_failures=T;e2.show();return false};aa=INLINE_JS.UnlinkHostModal=B.UnlinkHostModal=(function(e0){cE(T,e0);function T(e5,e3,e1,e2,e4){this.host_ids=e5;this.name=e3;this.delete_support_type=e1;this.owner_id=e2;this.team_id=e4;this.on_show=dg(this.on_show,this);this._set_delete_text=dg(this._set_delete_text,this);this.fail_callback=dg(this.fail_callback,this);this.success_callback=dg(this.success_callback,this);this.on_confirm_button_click=dg(this.on_confirm_button_click,this);T.__super__.constructor.call(this,{element_id:"unlink-host-modal"});this.show_host_selector=$u(this.host_ids).values().length>1}T.prototype.on_confirm_button_click=function(e4){var e2,e3,e1;e4.preventDefault();e3=this.$modal_window.find(".unlink_host_form")[0];e2=$(this.$modal_window.find(".confirm-button")[0]);this.$modal_window.find("[type=button]").attr("disabled","");e1={host_ids:JSON.stringify(this.get_selected_hosts())};return bJ.ajax_submit(e3,false,this.success_callback,this.fail_callback,e2,e1)};T.prototype.success_callback=function(){return window.location.reload()};T.prototype.fail_callback=function(){return this.$modal_window.find("[type=button]").removeAttr("disabled")};T.prototype._set_delete_text=function(e1){return this.$modal_window.find(".delete_data_label").text(e1)};T.prototype._get_unlink_select=function(){return this.$modal_window.find(".unlink-select select").val()};T.prototype._set_delete_checkbox=function(){return this.$modal_window.find(".delete_data").prop("checked",true)};T.prototype._clear_delete_checkbox=function(){return this.$modal_window.find(".delete_data").prop("checked",false)};T.prototype.on_show=function(e2){var e1;this._clear_delete_checkbox();if(this.delete_support_type===Constants.DELETE_ON_UNLINK_OLD_CLIENT){this.$modal_window.find(".unlink_host_modal_content").addClass("show_old_client_modal")}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_UNSUPPORTED){this.$modal_window.find(".unlink_host_modal_content .unlink_host_form").addClass("hidden")}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_SUPPORTED_TEAM_ONLY){this._set_delete_checkbox();this.$modal_window.find(".unlink-choice").change((function(e3){return function(e4){if(e3._get_unlink_select()===Constants.ROLE_PERSONAL){e3._clear_delete_checkbox();return e3.$modal_window.find(".new_client").hide()}else{e3._set_delete_checkbox();return e3.$modal_window.find(".new_client").show()}}})(this));this._set_delete_text(el("Delete files from %(team_name)s Dropbox the next time this computer comes online.").format({team_name:cB.get_viewer().team_name}))}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_SUPPORTED_PERSONAL_ONLY){this._set_delete_checkbox();this.$modal_window.find(".unlink-choice").change((function(e3){return function(e4){if(e3._get_unlink_select()===Constants.ROLE_WORK){e3._clear_delete_checkbox();return e3.$modal_window.find(".new_client").hide()}else{e3._set_delete_checkbox();return e3.$modal_window.find(".new_client").show()}}})(this));this._set_delete_text(el("Delete files from my personal Dropbox the next time this computer comes online."))}else{if(this.delete_support_type===Constants.DELETE_ON_UNLINK_SUPPORTED){this._set_delete_checkbox();this._set_delete_text(el("Delete files from these Dropboxes the next time this computer comes online."));this.$modal_window.find(".unlink-choice").change((function(e3){return function(e4){if(e3._get_unlink_select()===Constants.ROLE_PERSONAL){return e3._set_delete_text(el("Delete files from my personal Dropbox the next time this computer comes online."))}else{if(e3._get_unlink_select()===Constants.ROLE_WORK){return e3._set_delete_text(el("Delete files from %(team_name)s Dropbox the next time this computer comes online.").format({team_name:cB.get_viewer().team_name}))}else{return e3._set_delete_text(el("Delete files from these Dropboxes the next time this computer comes online."))}}}})(this))}}}}}if(this.show_host_selector){e1="<span class='host_name'></span>";this.$modal_window.find(".unlink-select").removeClass("hidden");this.$modal_window.find(".unlink-modal-text").html(el("Which Dropboxes do you want to unlink from %(host_name)s? Any Dropbox you unlink will immediately stop syncing.").format({host_name:e1}))}this.$modal_window.find("[name=host_id]").attr("value",this.host_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);this.$modal_window.find("[name=user_id]").attr("value",this.owner_id);return this.$modal_window.find(".host_name").text(this.name)};T.prototype.get_selected_hosts=function(){var e1;if($u.values(this.host_ids).length===1){return $u.values(this.host_ids)}e1=bv(".unlink-choice").val();if(e1==="both"){return $u.values(this.host_ids)}else{return[this.host_ids[e1]]}};return T})(dS);var ev;ev=B.News={DEFAULT_TAB:"recent-news",init:function(){$("news-home").on("click","#nav a",function(e0,e1){var T;if(e1.hasAttribute("data-div")){e0.preventDefault();T=e1.readAttribute("data-div");return eo.push_state("/news/"+T)}});return eo.add_callback("/news",ev.history_change)},change_tab:function(T){var e0;e0=$$("#nav a[data-div="+T+"]").first();if($(e0)){$$(".section").invoke("removeClassName","selected");$$("#nav a").invoke("removeClassName","selected");$(e0).addClassName("selected");return $(T).addClassName("selected")}},history_change:function(T){T=T||ev.DEFAULT_TAB;return ev.change_tab(T)}};var dt;dt=B.Recover={init:function(){var T;T=$("recover-form");return T.observe("submit",this.form_submit.bind(this))},form_submit:function(T){this.clear_error();T.preventDefault();return bJ.ajax_submit($("recover-form"),null,this.submit_response.bind(this))},submit_response:function(e0){var T;T=JSON.parse(e0.responseText);if(T.status==="error"){this.show_error(T.msg)}if(T.status==="ok"){this.show_hosts(T)}if(T.status==="redirect"){return window.location.href=T.url}},show_hosts:function(e6){var e3,e1,e2,T,e5,e0,e4;bJ.add_vars($("recover-form"),{check_file:"true"});$("filename-to-create").update(e6.filename);e1=$("trusted-hosts");e1.update();e4=e6.hosts;for(e5=0,e0=e4.length;e5<e0;e5++){e3=e4[e5];T=new Element("li");e2="lnx";if(e3.platform==="mac"){e2="osx"}if(e3.platform==="win"){e2="win"}T.__sert(cm.make("web",e2));T.__sert(new eV(e3.display_name.escapeHTML()));e1.appendChild(T)}$("login-step").hide();return $("hosts-step").show()},show_error:function(T){$("error-messages").update(T);return $("error-messages").show()},clear_error:function(){return $("error-messages").update()}};var c8;c8=B.Restore={next:function(T,e2){var e1,e0;e0=bv("ul.selected");e1=e0.next("ul");e1.addClass("selected");e0.removeClass("selected");if(e1.next("ul").length){bv("#next-page").show()}else{bv("#next-page").hide()}bv("#prev-page").show();return c8.inc_page(1)},prev:function(T,e2){var e1,e0;e0=bv("ul.selected");e1=e0.prev("ul");e1.addClass("selected");e0.removeClass("selected");if(e1.prev("ul").length){bv("#prev-page").show()}else{bv("#prev-page").hide()}bv("#next-page").show();return c8.inc_page(-1)},inc_page:function(e1){var e0,T;e0=parseInt(bv("#page_num").text(),10);T=e0+e1;return bv("#page_num").text(T)},init:function(e2,T,e0){var e1;e1=cB.get_viewer().get_user_by_id(e0);bv("#next-page").on("click",function(e3){c8.next(e3);return false});bv("#prev-page").on("click",function(e3){c8.prev(e3);return false});bv("#restore-submit-button").on("click",function(e3){dn.do_folder_restore(e2,e1);return false});bv("#restore-cancel-button").on("click",function(e3){return bR.redirect(T)});return bv("#restore-back-button").on("click",function(e3){return bR.redirect(T)})}};var b5,dj,cv,aL,dg=function(T,e0){return function(){return T.apply(e0,arguments)}},ar={}.hasOwnProperty,cE=function(e2,e0){for(var T in e0){if(ar.call(e0,T)){e2[T]=e0[T]}}function e1(){this.constructor=e2}e1.prototype=e0.prototype;e2.prototype=new e1();e2.__super__=e0.prototype;return e2};b5=B.SelectRoleModal=(function(T){cE(e0,T);function e0(){this.on_show=dg(this.on_show,this);return e0.__super__.constructor.apply(this,arguments)}e0.prototype.on_select_role=null;e0.prototype.on_show=function(){return bv(".role-options li").click((function(e1){return function(e3){var e2,e4;e2=bv(e3.target).closest("li");e4=e2.data("role");cz(e1.on_select_role,"missing on_select_role implementation");e1.on_select_role(e4);return e1.hide()}})(this))};return e0})(dS);cv=B.SharedFolderSelectRoleModal=(function(T){cE(e0,T);function e0(){return e0.__super__.constructor.apply(this,arguments)}e0.prototype.on_select_role=function(e2){var e1;e1=function(){bP.role_picker.ensure_role_is_visible(e2);dq.set_role(e2);return p.start_wizard_for_user(cB.get_viewer().get_user_by_role(e2))};if(e2===bF.logged_out_role){return bF.show_modal({role:e2,on_success:e1})}else{return e1()}};return e0})(b5);aL=B.ShmodelC2DSelectRoleModal=(function(T){cE(e0,T);function e0(){return e0.__super__.constructor.apply(this,arguments)}e0.prototype.on_select_role=function(e2){var e1;e1=function(){return ag.show_c2d_modal(e2)};if(!cB.get_viewer().is_role_signed_in(e2)){return bF.show_modal({role:e2,on_success:e1})}else{return e1()}};return e0})(b5);dj=B.ShareShmodelSelectRoleModal=(function(T){cE(e0,T);function e0(){this.on_select_role=dg(this.on_select_role,this);return e0.__super__.constructor.apply(this,arguments)}e0.prototype.on_select_role=function(e1){return ag.prompt_login_then_share(this.options.link_url,this.options.short_url,this.options.tokenizer_type,e1)};return e0})(b5);var cG;cG=B.TabController=Class.create({initialize:function(e1,e0){var T;T=$(e1);cz(T,e1+" is missing.");this.container=T;this.options={killEvent:true};Object.extend(this.options,e0);return this.listen()},listen:function(){var e4,e1,e3,e0,e2,T;e1=this;e2=this.container.select("a");T=[];for(e3=0,e0=e2.length;e3<e0;e3++){e4=e2[e3];cz(e4.id&&e4.id.length>0,"Element is missing an id");T.push(e4.observe("click",(function(e5){return this.click(e5)}).bindAsEventListener(e1)))}return T},click:function(T){if(this.options.killEvent){Event.stop(T)}return this.toggle($(T.target))},toggle:function(e0){var e3,T,e2,e4,e1;e1=this.container.down("a.selected");if(e1){e4=$(e1.id+"-content");if(e4){e4.hide()}}this.container.select(".selected").invoke("removeClassName","selected");T=false;if(!e0){e0=this.container.down("a");T=true}e0.addClassName("selected");e3=$(e0.id+"-content");if(e3){e3.show()}if(this.options.onTabChange){this.options.onTabChange(e0,e1)}if(this.options.url_prefix){e2=this.options.url_prefix;if(!T){e2+="/"+e0.id}return eo.push_state(e2)}}});var dB;dB=B.InviteForm={initialized:false,init:function(){if(this.initialized){return}return bv((function(T){return function(){T.add_auto_completer=new Autocompleter.ContactsTokenizer(cB.get_viewer().get_user_by_role(Constants.ROLE_WORK),"team-invite-new-collab-input","team-invite-new-whobulk","team-invite-hidden-input",{tokens:[",",";"],hide_import_contacts:true,suggestions_disabled:true,contact_filter:function(e0){return e0.excludeTeamMembers().excludeFacebook().excludeGroups().excludeNewStyleGroups().excludeRooms().excludeMe()}});T.add_auto_completer.clearTokens();T.tokenAdd=bv.proxy(T._tokenAdd,T);T.tokenRemove=bv.proxy(T._tokenRemove,T);bv("#team-invite-new-collab-input")[0].on("token:add",T.tokenAdd);bv("#team-invite-new-collab-input")[0].on("token:remove",T.tokenRemove);T.reset_licenses();T.initialized=true;T.setup_tab_support(bv);return b8.init()}})(this))},set_emails:function(T){if(T==null){return}return bv((function(e0){return function(){var e3,e5,e4,e2,e1;e0.init();e1=[];for(e4=0,e2=T.length;e4<e2;e4++){e3=T[e4];e5=e0.add_auto_completer.createTokenInfo(null,e3,S.EMAIL);e1.push(e0.add_auto_completer.addContact(e5))}return e1}})(this))},rebind_modal_submit_autocompleter:function(){var T,e0;T=this.invite_modal.$modal_window;e0=T.find(".tokenizer-submit-button");e0.on("mousedown",(function(e1){return function(){return e1.add_auto_completer.beforeSubmit()}})(this));return this.setup_tab_support(T)},setup_tab_support:function(T){return T.find("#team-invite-new-collab-input").first().on("keyup change",function(){var e0;e0=T.find(".new-collab-input").first();if(e0.val()!==""){return e0.attr("tabindex",-1)}else{return e0.removeAttr("tabindex")}})},reset_modal_licenses:function(){var T;T=__CIRCULAR_DEPENDENCY__.Dashboard!=null?__CIRCULAR_DEPENDENCY__.Dashboard.get_licensed_members():__CIRCULAR_DEPENDENCY__.MembersReact!=null?__CIRCULAR_DEPENDENCY__.MembersReact.get_licensed_members():window.active_team_member_table.get_licensed_members();this.update_used_licenses(T);this.available_licenses=this.total_licenses-this.used_licenses;this.update_license_count();return this.new_users=0},reset_licenses:function(){this.available_licenses=this.total_licenses-this.used_licenses;this.update_license_count();return this.new_users=0},get_new_users:function(){return this.new_users},_tokenAdd:function(T){this.available_licenses--;bv(window).trigger("token:changed",{remaining_licenses:this.available_licenses});return this.new_users++},_tokenRemove:function(T){this.available_licenses++;bv(window).trigger("token:changed",{remaining_licenses:this.available_licenses});return this.new_users--},already_invited_user:function(e0){var e1,T,e2;if(window.active_team_member_table){e2=window.active_team_member_table.data.users;for(T in e2){e1=e2[T];if(e1.email===e0){return true}}}},update_license_count:function(){var T,e0;T=bv("#license-count-message");if(this.available_licenses<0){e0=el("You need more licenses for this invitation.");T.addClass("over")}else{if(this.available_licenses===0){e0=el("You have no remaining licenses.");T.removeClass("over")}else{if(this.available_licenses>0){e0=a4("You have %(invites)d remaining license.","You have %(invites)d remaining licenses.",this.available_licenses).format({invites:this.available_licenses});T.removeClass("over")}else{e0="You have \u00a0 remaining licenses."}}}return T.text(e0)},init_modal_licenses:function(e1,e0,T){if(!this.invite_modal){this.invite_modal=new t(T)}this.total_licenses=e1;this.is_trial=e0;return bv("body").trigger("invite-modal-initialized")},update_used_licenses:function(T){this.used_licenses=T;return this.reset_licenses()},init_form_licenses:function(e1,T,e0){this.total_licenses=e1;this.used_licenses=T;this.is_trial=e0;return dB.reset_licenses()},add_total_licenses:function(T){T=T||0;if(T>0){this.total_licenses+=T;this.available_licenses+=T;this.update_license_count();if(__CIRCULAR_DEPENDENCY__.Dashboard!=null){return __CIRCULAR_DEPENDENCY__.Dashboard.add_licenses(T)}}},on_add_licenses_exit:function(e0,T){var e1;if((e1=this.invite_modal)!=null?e1.$modal_window:void 0){this.rebind_modal_submit_autocompleter()}return this.add_total_licenses(T)},reset_modal:function(){var T;T=this.invite_modal.$modal_window;cT.reset(T.find("#team-invite-message")[0]);if(this.add_auto_completer){this.add_auto_completer.clearTokens()}this.reset_modal_licenses();return T.find(".new-collab-input").val("")},on_add_licenses_click:function(e0){var T;e0.preventDefault();if(this.is_trial){if((T=this.invite_modal)!=null){T.hide()}return __CIRCULAR_DEPENDENCY__.add_more_licenses_to_trial()}else{if(this.add_licenses_cb!=null){dM.unregister(__CIRCULAR_DEPENDENCY__.AddLicensesModal.LICENSES_ADDED,this.add_licenses_cb)}this.add_licenses_cb=bv.proxy(this.on_add_licenses_exit,this);dM.register(__CIRCULAR_DEPENDENCY__.AddLicensesModal.LICENSES_ADDED,this.add_licenses_cb);return dM.push(new __CIRCULAR_DEPENDENCY__.AddLicensesModal())}}};var t,dg=function(T,e0){return function(){return T.apply(e0,arguments)}},ar={}.hasOwnProperty,cE=function(e2,e0){for(var T in e0){if(ar.call(e0,T)){e2[T]=e0[T]}}function e1(){this.constructor=e2}e1.prototype=e0.prototype;e2.prototype=new e1();e2.__super__=e0.prototype;return e2};t=B.InviteModal=(function(e0){cE(T,e0);function T(e1){this.transition_view_model=e1;this._reset=dg(this._reset,this);this._update_free_licenses_message=dg(this._update_free_licenses_message,this);this._update_form_pricing_information=dg(this._update_form_pricing_information,this);this._update_remaining_licenses_message=dg(this._update_remaining_licenses_message,this);this._make_transition_info_request=dg(this._make_transition_info_request,this);this._handle_token_change=dg(this._handle_token_change,this);this._licenses_total=dg(this._licenses_total,this);this._licenses_to_add=dg(this._licenses_to_add,this);this.on_hide=dg(this.on_hide,this);this.on_show=dg(this.on_show,this);T.__super__.constructor.call(this,{element_id:"team-invite-wizard",focus:".new-collab-input"});this.inline_add_license=this.transition_view_model!=null;if(this.inline_add_license){this.transition_info_fetcher=new eU([e1]);this.probability=Math.random()}this.skip_reset=false}T.prototype.on_confirm_button_click=function(e1){return dF.add_users(e1,this.add_qty)};T.prototype.on_show=function(){var e1;this._reset();bv('input[name="membership_type"]').click((function(e2){return function(){return e2._update_free_licenses_message()}})(this));e1=bv("#team-invite-wizard .team-invite-add-licenses");e1.on("click",bv.proxy(dB.on_add_licenses_click,dB));bv(window).on("token:changed",this._handle_token_change);if(dB.initialized){dB.update_license_count()}return dM.register(dM.CLEAR,function(){return dB.reset_modal()})};T.prototype.on_hide=function(){return bv(window).off("token:changed",this._handle_token_change)};T.prototype._licenses_to_add=function(){return -1*dB.available_licenses};T.prototype._licenses_total=function(){return dB.total_licenses+this._licenses_to_add()};T.prototype._handle_token_change=function(e2,e1){this._update_remaining_licenses_message(e1.remaining_licenses);if(this.inline_add_license){clearTimeout(this.fetch_transition_timeout_id);return this.fetch_transition_timeout_id=setTimeout((function(e3){return function(){e3._make_transition_info_request();return e3.fetch_transition_timeout_id=null}})(this),100)}};T.prototype._make_transition_info_request=function(){var e3,e2,e1,e4;e2=Math.floor(Math.random()*1000000);this.current_callback_token=e2;e3=this._licenses_to_add();e1=this._licenses_total();e4=(function(e5){return function(e6){return e5._update_form_pricing_information(e2,e3,e1,e6[0])}})(this);if(e3>0){return this.transition_info_fetcher.get(e4,{total_users:this._licenses_total()})}else{return e4(null)}};T.prototype._update_remaining_licenses_message=function(e1){var e2;this.remaining_licenses=e1;e2=this._get_remaining_licenses_message(e1);return this.$modal_window.find("#license-count-message").text(e2)};T.prototype._get_remaining_licenses_message=function(e1){var e2;if(e1<0){e2=el("You need more licenses for this invitation.")}else{if(e1===0){e2=el("After this invitation, you'll have no remaining licenses.")}else{e2=a4("After this invitation, you'll have %(count)d remaining license.","After this invitation, you'll have %(count)d remaining licenses.",e1).format({count:e1})}}return e2};T.prototype._update_form_pricing_information=function(e4,e5,e1,e8){var e2,e7,e6,e3;if(e4!==this.current_callback_token){return}if(e8&&e5>0){this.add_qty=e5;e2=this.transition_view_model.state.currency;e6=e8.current_total.amount;e7=eT.formatCurrency(e6,e2);e3=eT.formatCurrency(e8.recurring_total.amount,e2);bv(".new-amount").text(e7);bv(".add-qty").text(e5);bv(".recurring-amount").text(e3);bv(".total-qty").text(e1);bv(".charges-section").show();bv(".team-invite-buttons .confirm-button").val(el("Invite and buy"));return bv("#expected_price").val(e6)}else{return this._reset()}};T.prototype._update_free_licenses_message=function(){var e1,e2;e2=this.$modal_window.find('input[name="membership_type"]');e1=e2&&e2.is(":checked");this.$modal_window.find(".team-invite-add-licenses").toggle(!e1);this.$modal_window.find("#license-count-message").toggle(!e1);return this.$modal_window.find("#license-free-message").toggle(e1)};T.prototype._reset=function(){this.add_qty=0;bv(".charges-section").hide();bv("#expected_price").val(0);bv(".team-invite-buttons .confirm-button").val(el("Invite to team"));bv('input[name="membership_type"]').attr("checked",false);return this._update_free_licenses_message()};return T})(dS);var bz,aq,aw,Q,dZ,eH,bn,et,dF,eR,a8,ch,n,dg=function(T,e0){return function(){return T.apply(e0,arguments)}},ar={}.hasOwnProperty,cE=function(e2,e0){for(var T in e0){if(ar.call(e0,T)){e2[T]=e0[T]}}function e1(){this.constructor=e2}e1.prototype=e0.prototype;e2.prototype=new e1();e2.__super__=e0.prototype;return e2};dF=INLINE_JS.Team=B.Team={_use_async_reset:false,team_id:cB.get_viewer().team_id,set_team_id:function(T){this.team_id=T},setup_beta_modal_listeners:function(){var e4,e7,e5,T,e3,e2,e6,e0,e1;e7=bv(".feature-list .enroll-button");T=bv(".feature-list .feedback-button");for(e3=0,e6=e7.length;e3<e6;e3++){e4=e7[e3];e5=bv(e4).data("feature");bv(e4).click((function(e8){return function(){return new aq(e8).show()}})(e5));e4.disabled=false}e1=[];for(e2=0,e0=T.length;e2<e0;e2++){e4=T[e2];e5=bv(e4).data("feature");e1.push(bv(e4).click((function(e8){return function(){return new aw(e8).show()}})(e5)))}return e1},invite_modal_show:function(T){if(!dB.invite_modal){return bv("body").one("invite-modal-initialized",(function(e0){return function(){return e0.invite_modal_show(T)}})(this))}if(!this.invite_modal_already_initialized){dB.invite_modal.show();dB.init();this.invite_modal_already_initialized=true}else{dB.invite_modal.show();dB.rebind_modal_submit_autocompleter()}if(window.active_team_member_table!=null){dB.update_used_licenses(window.active_team_member_table.get_licensed_members())}return dB.set_emails(T)},init_admin:function(){bh.set_vertical_space(2);return bv("form.activity-report-generator").submit(this.submit_report_form.bind(this))},init_team_name_change_notice:function(){return bv(".team_name_change_notice .hide_link").click((function(T){return function(e0){return T.hide_team_name_change_banner()}})(this))},add_users:function(e1,T){var e3,e0,e2;Event.stop(e1);e0=$("team-invite-form");cz(e0,"Couldn't find the team invite form.");e3=bv(e0).find("input[name='emails']");if(e3.length===0){ab.error(el("You haven't included anyone to invite! Please invite at least one person."));return}e2=bJ.collect_form_vars(e0);bv.extend(e2,{team_id:this.team_id});bJ.add_loading(e1.target);return new Ajax.DBRequest("/account/team/add_users",{parameters:e2,subject_user:cB.get_viewer().work_user,progress_text:el("Inviting members..."),noAutonotify:true,onSuccess:function(e9){var e7,e6,e5,e8,e4;bJ.remove_loading();dB.reset_modal();dB.add_total_licenses(T);dB.invite_modal.hide();e8=bv(".team_admin_members_table");e5=JSON.parse(e9.responseText);if(e5){if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){window.active_team_member_table.add_users(e5!=null?e5.users:void 0)}else{if(__CIRCULAR_DEPENDENCY__.Dashboard!=null){__CIRCULAR_DEPENDENCY__.Dashboard.set_num_invited(e5!=null?e5.num_invited:void 0)}}}e7=(function(){var fb,fa;fb=e5!=null?e5.users:void 0;fa=[];for(e6 in fb){e4=fb[e6];fa.push(e4)}return fa})();if(e7.length===1){return ab.success(el("Invited %(user_email)s.").format({user_email:e7[0].email}))}else{if(e7.length>1){return ab.success(el("Invited %(user_count)d people.").format({user_count:e7.length}))}else{return ab.error(a4("Skipped %(num_skipped)d person who is already a member of the team.","Skipped %(num_skipped)d people who are already members of the team.",e3.length).format({num_skipped:e3.length}))}}}else{return ab.error()}},onFailure:function(e6){var e4,e5;if(e6){if(e6.responseText.indexOf("err:")===0){e4=e6.responseText.substr(4);if(e4.indexOf("{")===0){e5=e4.evalJSON(true);bJ.fill_errors(e0,e5)}else{e4=new eV(e4);ab.error(e4)}}else{ab.error()}}bJ.remove_loading();return bv("input[type='submit']").prop("disabled",false)},cleanUp:function(){bJ.remove_loading();dB.reset_modal();return dB.invite_modal.hide()}})},show_demo_signup_modal:function(e1,e2,e3,e0,e4){var T,e7,e6,e5;this.webinar_key=e1;this.webinar_iso_datetime=e2;this.webinar_date=e3;this.webinar_title=e0;this.tab_url=e4;e5=el("Register for a webinar on %(start_time)s").format({start_time:this.webinar_date});e7=new Q({element_id:"demo-signup-modal",title:e5});e7.show();e7.$modal_window.find("input[name=webinar_key]").attr("value",this.webinar_key);e7.$modal_window.find("input[name=webinar_title]").attr("value",this.webinar_title);e7.$modal_window.find("input[name=Sales_Webinar_Topic__c]").attr("value",this.webinar_title);e7.$modal_window.find("input[name=Sales_webinar_date__c]").attr("value",this.webinar_iso_datetime);e6=e7.$modal_window.find("input[name=retURL]");e6.attr("value",e6.val()+"#"+this.tab_url);T=e7.$modal_window.find("#demo-signup-form")[0];return T.on("submit",e7.on_confirm_button_click)},show_unsuspend_modal:function(e1,T,e0){var e2;e2=new bn({element_id:"dfe-unsuspend-modal",focus:"confirm"});e2.user_name=e1||e0;e2.email=e0;e2.user_id=T;e2.team_id=this.team_id;e2.show();return false},show_remove_or_deactivate_modal:function(e1,e4,T,e0,e5,e3){var e2;e2=new dZ({element_id:"dfe-remove-or-deactivate-user-modal",focus:".new-collab-input"});e2.user_name=e4||e0;e2.email=e0;e2.user_id=T;e2.team_id=this.team_id;e2.invited=e5;e2.hide_transfer_wipe=e3;e2.show();return false},show_remove_modal:function(e2,e5,T,e0,e6,e1,e4){var e3;e3=new eH({element_id:"dfe-remove-user-modal",focus:".new-collab-input"});e3.user_name=e5||e0;e3.email=e0;e3.user_id=T;e3.team_id=this.team_id;e3.invited=e6;e3.num_api_apps=e1;e3.hide_transfer_wipe=e4;e3.show();return false},remove_user:function(e2,e3){var e1,e0,T;alert("in remove_user");Event.stop(e2);e0=bv("input[type=submit]","#remove-user-modal");e0.attr("disabled",1);T=eS.vars.user_id;if(e3){e1=true}else{e1=bv("input[name=disable_if_joined]:checked","#remove-user-modal").val()}return new Ajax.DBRequest("/account/team/remove_user",{parameters:{team_id:this.team_id,user_id:T,disable_if_joined:e1},onSuccess:(function(e4){return function(e7){var e6,e8,e5;e6=JSON.parse(e7.responseText);if((e8=window.active_team_member_table)!=null){e8.remove_user(eS.vars.user_id)}if((e5=window.removed_team_member_table)!=null){e5.add_users(e6)}e4.decrement_used_licenses();return ab.success(el("User removed."))}})(this),cleanUp:function(){eS.hide();return e0.removeAttr("disabled")}})},show_reinvite_modal:function(e1,e2,T,e0){var e3;de.fillVal(e0,"reinvite-user-email");de.fillVal(e2,"reinvite-user-team");e3=el("Resend invite to '%(email_address)s'").format({email_address:bK.em_snippet(e0,18)});return eS.show(e3,$("reinvite-user-modal"),{user_id:T,button:e1})},reinvite_user:function(e0){var T;Event.stop(e0);T=eS.vars.user_id;return new Ajax.DBRequest("/account/team/reinvite_user",{parameters:{team_id:this.team_id,user_id:T},onSuccess:function(e4){var e2,e3,e1,e5;ab.success(el("Invite sent."));if((e5=$("team-member-info"))!=null){e5.update(e4.responseText)}e2=window.active_team_member_table;if(e2){e1=e2.data.users[T];e1.invite_expired=false;e3={};e3[T]=e1;return e2.update_user_data(e3)}},cleanUp:function(){return eS.hide()}})},show_request_license_modal:function(e0,T){var e1;e1=el("Request a license?");return eS.show(e1,$("request-license-modal"),{user_id:T,button:e0})},request_license:function(e0){var T;Event.stop(e0);T=eS.vars.user_id;return new Ajax.DBRequest("/team/request_license",{parameters:{team_id:this.team_id,user_id:T},onSuccess:function(e1){bv("#request_license_text").hide();return ab.success(el("License Requested."))},cleanUp:function(){return eS.hide()}})},show_user_activity_log_modal:function(T,e1,e2){var e0;e0=bv("#activity-log-modal");e0.find(".activity-log-email").text(e1);e0.find(".activity-log-name").text(e2);e0.find("#activity-log-user-message").show();return eS.show(el("Create activity report"),e0[0],{user_id:T})},show_team_activity_log_modal:function(e0,e1){var T;T=bv("#activity-log-modal");T.find(".activity-log-email").text(e0);T.find(".activity-log-name").text(e1);T.find("#activity-log-team-message").show();return eS.show(el("Create full activity report"),T[0])},generate_activity_log:function(e6){var e4,e2,e5,e3,T,e1,e0;Event.stop(e6);e2=bv("#activity-log-modal");e5=e2.find("input[name='from_date']").val();T=e2.find("input[name='to_date']").val();if(e5>T){ab.error(el("Your start date is after your end date."));return}e3=this.team_id;e0=eS.vars.user_id;e1=new Date().getTimezoneOffset().toString();e4=bv(".activity-report-generator .freshbutton-blue");e4.prop("disabled",true);return new Ajax.DBRequest("/team/events_report/csv",{parameters:{from_date:e5,to_date:T,team_id:e3,user_id:e0,tzoffset:e1},onSuccess:function(e7){return ab.success(el("Report started. We'll email you when it's ready."))},cleanUp:function(){eS.hide();return e4.prop("disabled",false)}})},show_reset_password_modal:function(e0,e1,T){var e2;bv("#reset-password-modal .member-name").text(e1);e2=el("Reset password for '%(user_name)s'").format({user_name:e1});return eS.show(e2,$("reset-password-modal"),{user_id:T,button:e0})},reset_password:function(e0){var T;Event.stop(e0);T=eS.vars.user_id;return new Ajax.DBRequest("/account/team/reset_password",{parameters:{team_id:this.team_id,user_id:T},onSuccess:function(e1){return ab.success(el("User's password reset."))},cleanUp:function(){return eS.hide()}})},show_reset_all_passwords_modal:function(){return eS.show(el("Reset all passwords"),$("reset-all-passwords-modal"))},set_async_password_reset:function(T){return this._use_async_reset=T},reset_all_passwords:function(){return new Ajax.DBRequest("/account/team/reset_all_passwords",{parameters:{team_id:this.team_id},job:this._use_async_reset,subject_user:cB.get_viewer().work_user,progress_text:el("Resetting all passwords..."),onSuccess:function(T){return ab.success(el("All passwords reset."))},cleanUp:function(){return eS.hide()}})},show_admin_status_modal:function(e1,e7,e9,e3,e8,e4){var e0,e5,T,e2,e6;T=e8.strip()||e3;e2=void 0;e0=void 0;e6=void 0;e5=void 0;if(e4){e6=el("Add admin permissions for '%(person_name)s'").format({person_name:T.escapeHTML()});e2=el("Are you sure you want to add admin permissions for <strong>%(person_name)s</strong>?").format({person_name:T.escapeHTML()});e0=el("Add admin permissions",{comment:"make this user an admin; give them the permissions an admin has"});e5="alert_32"}else{e6=el("Remove admin privileges from '%(person_name)s'").format({person_name:T.escapeHTML()});e2=el("Are you sure you want to remove admin permissions from <strong>%(person_name)s</strong>?").format({person_name:T.escapeHTML()});e0=el("Remove admin permissions",{comment:"clicking this button completes the action: it removes a person's admin status"});e5="alert_32"}de.fillVal(e3,"admin-status-email");de.fillVal(e2,"admin-status-action");de.fillVal(e0,"admin-status-button-action");return eS.show(e6,$("admin-status-modal"),{user_id:e9,button:e1,admin_on:e4})},set_admin_status:function(e0){var T;Event.stop(e0);T=eS.vars.user_id;return new Ajax.DBRequest("/account/team/set_admin_status",{parameters:{team_id:this.team_id,user_id:T,on:(eS.vars.admin_on?"yes":"no")},onSuccess:function(e2){var e3,e1;e3=(eS.vars.admin_on?el("User's admin status granted."):el("User's admin status removed."));if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){return __CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){e1=JSON.parse(e2.responseText);window.active_team_member_table.update_user_data(e1);return ab.success(e3)}else{if(eS.vars.admin_on){return window.location="/team/admin/member?id=%d&msg=granted".format(eS.vars.user_id)}else{return window.location="/team/admin/member?id=%d&msg=removed".format(eS.vars.user_id)}}}},cleanUp:function(){return eS.hide()}})},show_disable_2fa_modal:function(e1,T,e0){bv("#disable-2fa-modal .member-name").text(e0);return eS.show(el("Disable two-step verification"),$("disable-2fa-modal"),{user_id:T,elm:e1})},show_reset_2fa_modal:function(e1,T,e0){bv("#reset-2fa-modal .member-name").text(e0);return eS.show(el("Reset two-step verification"),$("reset-2fa-modal"),{user_id:T,user_name:e0,elm:e1})},reset_2fa:function(){return new Ajax.DBRequest("/account/team/reset_2fa",{parameters:{team_id:this.team_id,user_id:eS.vars.user_id},onSuccess:function(e0){var T;bv(".tfa_enabled").replaceWith(el("Disabled"));T=JSON.parse(e0.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){window.active_team_member_table.update_user_data(T)}else{if(__CIRCULAR_DEPENDENCY__.MemberActionsMenu){__CIRCULAR_DEPENDENCY__.MemberActionsMenu.update_container_users(".buttons",T)}}}ab.success(el("Two-step verification reset for %(user_name)s").format({user_name:eS.vars.user_name}));return eS.hide()}})},disable_2fa:function(){return new Ajax.DBRequest("/account/team/disable_2fa",{parameters:{team_id:this.team_id,user_id:eS.vars.user_id},onSuccess:function(e0){var T;bv(".tfa_enabled").replaceWith(el("Disabled"));T=JSON.parse(e0.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.active_team_member_table){window.active_team_member_table.update_user_data(T)}else{if(__CIRCULAR_DEPENDENCY__.MemberActionsMenu){__CIRCULAR_DEPENDENCY__.MemberActionsMenu.update_container_users(".buttons",T)}}}ab.success(el("Two-step verification disabled."));return eS.hide()}})},show_sso_preview_email:function(T){return eS.show(el("Email preview"),$(T))},show_sso_sample_email:function(T){return eS.show(el("Sample email"),$(T))},show_user_message_modal:function(e1,e0,T){var e2;de.fillVal(T,"user-message-email");e2=el("Send email to '%(user_name)s'").format({user_name:e1});$("user-message").value="";eS.show(e2,$("user-message-modal"),{user_name:e1,user_id:e0});return dQ.focus.defer("user-message")},send_user_message:function(){var e0,T;T=eS.vars.user_id;e0=$F("user-message").strip();return new Ajax.DBRequest("/account/team/send_user_message",{parameters:{user_id:T,team_id:this.team_id,message:e0},onSuccess:function(){var e1;e1=eS.vars.user_name;ab.success(el("Message successfully sent to %(user_name)s.").format({user_name:e1}));return eS.hide()}})},hide_team_name_change_banner:function(){new Ajax.DBRequest("/account/team/name_change_notice_received",{parameters:{team_id:this.team_id}});bv(".team_name_change_notice").hide();return false},hide_pin_banner:function(){new Ajax.DBRequest("/team/invalidate_pin");return bv(".pin_notice").hide()},hide_pin_banner_with_user_id:function(T,e0){var e1;e1=function(e2){return bv(e0).closest("span").removeClass("on").addClass("off")};if(T===null){return new Ajax.DBRequest("/team/invalidate_pin",{onSuccess:e1})}else{return new Ajax.DBRequest("/team/invalidate_pin",{parameters:{user_id:T},onSuccess:e1})}},get_pin_with_user_id:function(T,e1,e0){var e2;if(e0==null){e0=null}if(e0===null){e0=function(e4,e3){bv(e3).closest("span").find(".pin-value").text(e4.pin+" -");return bv(e3).closest("span").removeClass("off").addClass("on")}}e2=function(e4){var e3;e3=JSON.parse(e4.responseText);return e0(e3,e1)};if(T===null){return new Ajax.DBRequest("/team/generate_pin",{onSuccess:e2})}else{return new Ajax.DBRequest("/team/generate_pin",{parameters:{user_id:T},onSuccess:e2})}},send_team_message:function(e0){var T;Event.stop(e0);T=$F("team-message").strip();if(T){return new Ajax.DBRequest("/account/team/send_team_message",{parameters:{team_id:this.team_id,message:T},onSuccess:function(e1){ab.success(el("Message successfully sent to team."));return eS.hide()}})}},show_security_message_modal:function(){return new eR().show()},send_team_security_message:function(e1){var e0,T;Event.stop(e1);T=$F("team-security-message").strip();e0=$("team-security-message-form");return new Ajax.DBRequest("/account/team/send_team_message",{parameters:e0.serialize(true),onSuccess:function(e2){ab.success(el("Message successfully sent."));return eS.hide()}})},used_licenses:0,total_licenses:0,set_used_licenses:function(T,e0){this.used_licenses=T;return this.total_licenses=e0},decrement_used_licenses:function(){return this.set_used_licenses(this.used_licenses-1,this.total_licenses)},show_migration_link:function(T,e0){$("migration-url").value=e0;eS.show(el("Migration link for '%(email)s'").format({email:bK.em_snippet(T,18)}),$("migrate-url-modal"));return $("migration-url").select()},show_end_session_modal:function(e0,T,e1){bh.hide_all();bv("#end-session-modal .member-name").text(bv("#member-name").text());return eS.show(el("Close web session",{comment:"Log out of your current Dropbox web session"}),$("end-session-modal"),{login_id:e0,user_id:T,elm:e1})},end_session:function(){return new Ajax.DBRequest("/logout_remote_session",{parameters:{remote_login_id:eS.vars.login_id,team_id:this.team_id,user_id:eS.vars.user_id},onSuccess:function(){eS.hide();dF.remove_closest_row(eS.vars.elm);return ab.success(el("Web session closed."))}})},unlink_device:function(T,e2,e6,e0,e7,e1,e3){var e5,e4;bh.hide_all();e5=$("unlink-device-modal-"+e1);e4=el("Unlink %(device_name)s").format({device_name:e6});return eS.show(e4,e5,{app_id:e2,user_id:e7,elm:e3,device_id:T,display_name:e6})},unlink_device_submit:function(){return new Ajax.DBRequest("/account/unlink_team_device",{parameters:{app_id:eS.vars.app_id,team_id:this.team_id,user_id:eS.vars.user_id,device_id:JSON.stringify(eS.vars.device_id)},subject_user:cB.get_viewer().work_user,onSuccess:function(){eS.hide();dF.remove_closest_row(eS.vars.elm);return ab.success(el("%(device_name)s unlinked.").format({device_name:eS.vars.display_name}))}})},disable_app:function(e0,e1,T,e2){bh.hide_all();bv("#disable-app-modal .app-name").text(e1);bv("#disable-app-modal .member-name").text(bv("#member-name").text());return eS.show(el("Disable '%(app_name)s'?").format({app_name:e1}),$("disable-app-modal"),{app_id:e0,user_id:T,elm:e2})},disable_app_submit:function(){return new Ajax.DBRequest("/api/uninstall_app",{parameters:{app_id:eS.vars.app_id,keep_sandbox_files:true,team_id:this.team_id,user_id:eS.vars.user_id},subject_user:cB.get_viewer().work_user,onSuccess:function(T){eS.hide();dF.remove_closest_row(eS.vars.elm);return ab.success(T.responseText)}})},remove_closest_row:function(e2){var e1,e0,T;e1=bv(e2).closest(".team_admin_table_row");e0=bv(e1).closest(".team_admin_table");if(e0.find(".team_admin_table_row").length===1){T=e0.prev(".team_admin_table_title");if(!T.length){T=bv(".team_apps_table_panel")}T.remove();return e0.remove()}else{return e1.remove()}},submit_report_form:function(T){bv(T.target.elements.tzoffset).val(""+new Date().getTimezoneOffset());return true},change_membership_type_add_license:function(T){eS.hide();return bv.proxy(dB.on_add_licenses_click,dB)(T)},show_change_membership_type_modal:function(e9,e8,e6,T,e5,e3,e2,e7){var e4,e0,e1;e0=bv("#change-membership-type-modal");e0.find(".member-prefix").toggle(e6);e0.find(".invite-prefix").toggle(!e6);e0.find(".member-name").text(e8);e0.find(".membership-type-text").text(e5);e0.find(".license-usage-verb").text(e3);e0.find(".add-license").click(function(fa){fa.preventDefault();return change_membership_type_add_license(fa)});e1=false;if(e2===0){if(e7){e1=true}else{e4="You have no remaining licenses."}}else{e4=el("You have %(available_licenses)s license%(plural)s remaining.").format({available_licenses:e2,plural:e2>1?"s":""})}e0.find(".licenses-info").text(e4);e0.find(".has-licenses-description").toggle(!e1);e0.find(".confirm-button").toggle(!e1);e0.find(".no-licenses-description").toggle(e1);e0.find(".add-licenses-button").toggle(e1);return eS.show(el("Change Account"),$("change-membership-type-modal"),{user_id:e9,display_name:e8,membership_type:T,membership_type_text:e5,is_member:e6})},change_membership_type:function(){return new Ajax.DBRequest("/account/team/change_membership_type",{parameters:{team_id:this.team_id,user_id:eS.vars.user_id,membership_type:eS.vars.membership_type},onSuccess:function(e0){var T,e1;T=eS.vars.is_member?eS.vars.display_name:"this invite";ab.success(el("Account changed to %(membership_type_text)s for %(display_name)s").format({membership_type_text:eS.vars.membership_type_text,display_name:T}));if((e1=__CIRCULAR_DEPENDENCY__.MembersReact)!=null){e1.refresh_member_stats()}return eS.hide()}})}};aq=B.BetaEnrollConfirmationModal=(function(e0){cE(T,e0);function T(e1){this.feature_name=e1;this.on_confirm_button_click=dg(this.on_confirm_button_click,this);T.__super__.constructor.call(this,{element_id:"beta-enroll-confirmation-modal"})}T.prototype.on_confirm_button_click=function(e1){bv("<input>").attr({type:"hidden",name:"feature_name",value:this.feature_name}).appendTo("#beta-enroll-confirmation-modal form");return this.$modal_window.addClass("ajax-loading")};return T})(dS);aw=B.BetaFeedbackModal=(function(e0){cE(T,e0);function T(e1){this.feature_name=e1;this.success=dg(this.success,this);T.__super__.constructor.call(this,{element_id:"beta-feedback-modal"});this.on_confirm_button_click=(function(e2){return function(e6){var e5,e4,e3;e6.preventDefault();e5=bv(e6.target);e4=e5.closest("form");e3={feature_name:e2.feature_name};return bJ.ajax_submit(e4[0],false,e2.success,e2.error,e5[0],e3)}})(this)}T.prototype.success=function(e1){ab.success(el("Thank you for your feedback."));return this.$modal_window.hide()};T.prototype.error=function(e1){if(e1.status!==200){return ab.error(el("Failed to submit feedback. Please try again."))}};return T})(dS);Q=B.DemoSignupModal=(function(T){cE(e0,T);function e0(){this.on_show=dg(this.on_show,this);this.on_confirm_button_click=dg(this.on_confirm_button_click,this);return e0.__super__.constructor.apply(this,arguments)}e0.prototype.on_confirm_button_click=function(e5){var fd,fa,e6,e1,e8,e3,fc,fb,e2,e9,e7,e4;e5.preventDefault();e7=$("demo-signup-form");fb=$("1210");e3=bv(e7).find("input[name='first_name']").val();bv(fb).find("input[name='FirstName']").attr("value",e3);fc=bv(e7).find("input[name='last_name']").val();bv(fb).find("input[name='LastName']").attr("value",fc);e8=bv(e7).find("input[name='email']").val();bv(fb).find("input[name='Email']").attr("value",e8);e9=bv(e7).find("input[name='phone_number']").val();bv(fb).find("input[name='Phone']").attr("value",e9);fd=bv(e7).find("input[name='company_name']").val();bv(fb).find("input[name='Company']").attr("value",fd);e6=bv(e7).find("select[name='company_size']");fa=e6.find("option:selected").val();bv(fb).find("input[name='Company_size__c']").attr("value",fa);e1=$(this.$modal_window.find(".confirm-button")[0]);e4=(function(fe){return function(ff){fe.$modal_window.hide();return fb.submit()}})(this);e2=bJ.collect_form_vars(e7,true);return bJ.ajax_submit(e7,false,e4,false,e1,e2,true)};e0.prototype.on_show=function(e1){this.$modal_window.find(".db-modal-content").css({"overflow-y":""});return b8.init()};return e0})(dS);bz=B.AccountTransferBaseModal=(function(e0){cE(T,e0);function T(e1,e3,e2){this.file_action_selector=e3;this.transfer_choice_selector=e2;this._clearInput=dg(this._clearInput,this);this._markInputInvalid=dg(this._markInputInvalid,this);this._markInputValid=dg(this._markInputValid,this);this._tokenRemove=dg(this._tokenRemove,this);this._tokenAdd=dg(this._tokenAdd,this);this._selectChange=dg(this._selectChange,this);this._isTransferSelected=dg(this._isTransferSelected,this);this.handleAjaxFailure=dg(this.handleAjaxFailure,this);T.__super__.constructor.call(this,e1,this.file_action_selector,this.transfer_choice_selector)}T.prototype.on_show=function(){if(this.$modal_window.find("#manage-files-new-collab-input").length===0){return}this.auto_completer=new Autocompleter.TeamTokenizer(cB.get_viewer().get_user_by_role(Constants.ROLE_WORK),"manage-files-new-collab-input","manage-files-new-whobulk","manage-files-hidden-input",{hide_import_contacts:true,suggestions_disabled:true,wrap_name:true,single_token:true,contact_filter:(function(e1){return function(e2){return e2.excludeNonTeam().excludeGroups().excludeNewStyleGroups().excludeRooms().excludeByEmail(e1.email?[e1.email.toLowerCase()]:[])}})(this)});this.tokenAdd=bv.proxy(this._tokenAdd,this);this.tokenRemove=bv.proxy(this._tokenRemove,this);this.$collab_input=this.$modal_window.find("#manage-files-new-collab-input")[0];this.$collab_input.on("token:add",this.tokenAdd);this.$collab_input.on("token:remove",this.tokenRemove);this.$textinput=this.$modal_window.find(".tokenized_autocompleter_container .textinput");this.selectChange=bv.proxy(this._selectChange,this);return this.$modal_window.find(this.file_action_selector).on("change",this.selectChange)};T.prototype.handleAjaxFailure=function(e1){if(e1.status===200&&this._isTransferSelected()){return this._markInputInvalid()}};T.prototype._isTransferSelected=function(){return bv(this.transfer_choice_selector).prop("checked")};T.prototype._selectChange=function(e1){if(this._isTransferSelected()){return this.$textinput.removeClass("unselected")}else{return this.$textinput.addClass("unselected")}};T.prototype._tokenAdd=function(e1){this.$collab_input.hide();if(e1.memo.valid){return this._markInputValid()}else{return this._markInputInvalid()}};T.prototype._tokenRemove=function(e1){this.$collab_input.show();return this._clearInput()};T.prototype._markInputValid=function(){this._clearInput();return this.$textinput.addClass("valid")};T.prototype._markInputInvalid=function(){this._clearInput();return this.$textinput.addClass("invalid")};T.prototype._clearInput=function(){this.$textinput.removeClass("valid");return this.$textinput.removeClass("invalid")};return T})(dS);eR=B.TwoFactorMessageModal=(function(e0){cE(T,e0);function T(){T.__super__.constructor.call(this,{element_id:"team-security-message-modal",focus:"#team-security-message"})}T.prototype.on_confirm_button_click=function(e1){dF.send_team_security_message(e1);return this.hide()};return T})(dS);bn=B.DfeUnsuspendUserModal=(function(T){cE(e0,T);function e0(e1){this.on_confirm_button_click=dg(this.on_confirm_button_click,this);this.success_callback=dg(this.success_callback,this);e0.__super__.constructor.call(this,e1)}e0.prototype.before_show=function(){var e1;e0.__super__.before_show.call(this);e1=el("Unsuspend %(user_name)s").format({user_name:this.user_name});this.$modal_window.find(".db-modal-title-text").text(e1);this.$modal_window.find("[name=user_id]").attr("value",this.user_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);this.$modal_window.find("[name=email]").attr("value",this.email);this.$modal_window.find(".unsuspended_name").text(this.user_name);return this.$modal_window.find(".unsuspended_email").text(this.email)};e0.prototype.success_callback=function(e1){var e2;ab.success("User unsuspended");if((e2=__CIRCULAR_DEPENDENCY__.MembersReact)!=null){e2.refresh_member_stats()}return this.hide()};e0.prototype.on_confirm_button_click=function(e3){var e1,e2;e3.preventDefault();e2=this.$modal_window.find(".dfe-unsuspend-modal")[0];e1=$(this.$modal_window.find(".confirm-button")[0]);return bJ.ajax_submit(e2,false,this.success_callback,false,e1)};return e0})(dS);dZ=B.DfeRemoveOrDeactivateUserModal=(function(e0){cE(T,e0);function T(e1){this.on_confirm_button_click=dg(this.on_confirm_button_click,this);this.success_callback=dg(this.success_callback,this);this.on_show=dg(this.on_show,this);this.handle_change_action=dg(this.handle_change_action,this);this.switch_to_uninvite_mode=dg(this.switch_to_uninvite_mode,this);this.switch_to_removal_mode=dg(this.switch_to_removal_mode,this);this.switch_to_deactivation_mode=dg(this.switch_to_deactivation_mode,this);this.show_removal_content=dg(this.show_removal_content,this);this.show_deactivation_content=dg(this.show_deactivation_content,this);this.set_modal_class=dg(this.set_modal_class,this);T.__super__.constructor.call(this,e1,"input[name=transfer_files]","#transfer_files_on")}T.prototype.set_form_action_to_deactivate=function(){return bv(".dfe-remove-or-deactivate-user-modal").attr("action","/account/team/deactivate_user")};T.prototype.set_form_action_to_remove=function(){return bv(".dfe-remove-or-deactivate-user-modal").attr("action","/account/team/remove_user")};T.prototype.set_modal_class=function(e3){var e2,e1;e2="suspending deleting";e1=this.$modal_window.find(".dfe-remove-or-deactivate-user-modal");e1.removeClass(e2);return e1.addClass(e3)};T.prototype.show_deactivation_content=function(){return this.set_modal_class("suspending")};T.prototype.show_removal_content=function(){return this.set_modal_class("deleting")};T.prototype.switch_to_deactivation_mode=function(){this.show_deactivation_content();return this.set_form_action_to_deactivate()};T.prototype.switch_to_removal_mode=function(){this.show_removal_content();return this.set_form_action_to_remove()};T.prototype.switch_to_uninvite_mode=function(){this.set_form_action_to_remove();this.set_modal_class("invited");this.$modal_window.find(".transfer_data_on_remove_setting").remove();return this.$modal_window.find(".remote_wipe_setting").remove()};T.prototype.handle_change_action=function(e1){e1.preventDefault();if(bv("#deactivate_option").is(":checked")){return this.switch_to_deactivation_mode()}else{return this.switch_to_removal_mode()}};T.prototype.on_show=function(e1){var e2;T.__super__.on_show.call(this);bv("input[name=deactivate_or_remove]").on("change",this.handle_change_action);this.$modal_window.find(".deleted_user_name").text(this.user_name);if(this.invited){e2=el("Uninvite %(user_name)s").format({user_name:this.user_name});this.switch_to_uninvite_mode()}else{e2=el("Remove %(user_name)s").format({user_name:this.user_name});bv("#deactivate_option").attr("checked","checked");this.switch_to_deactivation_mode()}this.$modal_window.find(".db-modal-title-text").text(e2);this.$modal_window.find("[name=user_id]").attr("value",this.user_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);if(this.hide_transfer_wipe){this.$modal_window.find(".transfer_data_on_remove_setting").remove();return this.$modal_window.find(".remote_wipe_setting").remove()}};T.prototype.success_callback=function(e1){if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}if(this.invited){ab.success(el("User uninvited"))}else{if(bv("#deactivate_option").is(":checked")){ab.success(el("User suspended"))}else{ab.success(el("User deleted"))}}return this.hide()};T.prototype.on_confirm_button_click=function(e3){var e1,e2;e3.preventDefault();e2=this.$modal_window.find(".dfe-remove-or-deactivate-user-modal")[0];e1=$(this.$modal_window.find(".confirm-button")[0]);return bJ.ajax_submit(e2,false,this.success_callback,this.handleAjaxFailure,e1)};return T})(bz);eH=B.DfeRemoveUserModal=(function(T){cE(e0,T);function e0(e1){this.on_confirm_button_click=dg(this.on_confirm_button_click,this);this.success_callback=dg(this.success_callback,this);this.on_show=dg(this.on_show,this);e0.__super__.constructor.call(this,e1,"input[name=transfer_files]","#transfer_files_on")}e0.prototype.on_show=function(e2){var e1,e3;e0.__super__.on_show.call(this);this.$modal_window.find(".remove_user_name").text(this.user_name);if(this.invited){e3=el("Uninvite %(user_name)s").format({user_name:this.user_name})}else{e3=el("Delete %(user_name)s").format({user_name:this.user_name})}this.$modal_window.find(".db-modal-title-text").text(e3);if(this.num_api_apps){e1=a4("%(num)s API app","%(num)s API apps",this.num_api_apps).format({num:this.num_api_apps});this.$modal_window.find(".num_api_app").text(e1)}else{this.$modal_window.find(".api_app_warning").hide()}this.$modal_window.find("[name=user_id]").attr("value",this.user_id);this.$modal_window.find("[name=team_id]").attr("value",this.team_id);if(this.invited){this.$modal_window.find(".active_user_remove_setting").remove();this.$modal_window.find(".dfe-remove-user-modal").addClass("invited")}if(this.hide_transfer_wipe){return this.$modal_window.find(".active_user_remove_setting").remove()}};e0.prototype.success_callback=function(e3){var e2,e4,e1;e2=JSON.parse(e3.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if((e4=window.active_team_member_table)!=null){e4.remove_user(this.user_id)}if((e1=window.removed_team_member_table)!=null){e1.add_users(e2)}}if(this.invited){ab.success(el("User uninvited."))}else{ab.success(el("User removed."))}dF.decrement_used_licenses();return this.hide()};e0.prototype.on_confirm_button_click=function(e3){var e1,e2;e3.preventDefault();e2=this.$modal_window.find(".dfe-remove-user-modal")[0];e1=$(this.$modal_window.find(".confirm-button")[0]);return bJ.ajax_submit(e2,false,this.success_callback,this.handleAjaxFailure,e1)};return e0})(bz);et=B.ManageFilesModal=(function(e0){cE(T,e0);function T(e2,e3,e1){this.source_user_id=e2;this.source_user_name=e3;this.options=e1;this.on_confirm_button_click=dg(this.on_confirm_button_click,this);this.success_callback=dg(this.success_callback,this);T.__super__.constructor.call(this,this.options,"input[name=file_action]","#move-files")}T.prototype.get_form=function(){return this.$modal_window.find("form")[0]};T.prototype.on_show=function(){var e1;T.__super__.on_show.call(this);this.$modal_window.find("[name='source_user_id']").attr("value",this.source_user_id);this.$modal_window.find(".source-user-name").text(this.source_user_name);e1=el("Manage %(team_member)s's files").format({team_member:this.source_user_name});this.$modal_window.find(".db-modal-title-text").text(e1);return this.get_form().on("submit",this.on_confirm_button_click)};T.prototype.success_callback=function(e2){var e1;e1=JSON.parse(e2.responseText);if(__CIRCULAR_DEPENDENCY__.MembersReact!=null){__CIRCULAR_DEPENDENCY__.MembersReact.refresh_member_stats()}else{if(window.removed_team_member_table){window.removed_team_member_table.update_user_data(e1)}else{if(__CIRCULAR_DEPENDENCY__.MemberActionsMenu!=null){__CIRCULAR_DEPENDENCY__.MemberActionsMenu.update_container_users(".buttons",e1)}}}if(bv("#move-files").prop("checked")){ab.success(el("Transfer started",{comment:"This refers to the start of a file transfer from one Dropbox to another"}))}else{ab.success(el("Permanently deleted files"))}return this.hide()};T.prototype.on_confirm_button_click=function(e3){var e1,e2;e3.preventDefault();e2=this.get_form();e1=$(this.$modal_window.find(".confirm-button")[0]);return bJ.ajax_submit(e2,false,this.success_callback,this.handleAjaxFailure,e1)};return T})(bz);ch=B.show_manage_files_modal=function(T,e0){var e1;e1=new et(T,e0,{element_id:"manage-files-modal",focus:".new-collab-input"});return e1.show()};n=function(){var T;T=function(e2,e1){var e0,e3;bv(e1).css("display","none");e0=bv(e1).closest("#user_generate_liveops_pin");e3=e0.find(".user_generate_liveops_pin_value");e3.text(e2.pin);bv(e1).addClass("liveops_pin_elem_invisible");return e0.find(".user_generate_liveops_pin_text").removeClass("liveops_pin_elem_invisible")};dF.get_pin_with_user_id(null,this,T);return false};bv("#user_generate_liveops_pin_button").click(n);a8=function(){bv("#help_callus_title").hide();bv("#help_callus_details").show();return false};bv("#help_callus_trigger").click(a8);var O,b,dT,bb,ai,bB=[].indexOf||function(e1){for(var e0=0,T=this.length;e0<T;e0++){if(e0 in this&&this[e0]===e1){return e0}}return -1},cS=[].slice;O=B.NOTCLIENTS={};b=B.NOTCLIENT_DEBUG=false;dT="/subscribe";bb=B.add_notclient=function(T,e1,e0){ai(T);return setTimeout((function(){return O[T].init(e1,e0)}),2000)};ai=B.new_notclient=function(fh){var fv,fx,e8,fa,e7,fi,ff,fq,e1,fc,T,e3,fb,fA,e2,fB,e5,fm,fg,e4,fo,e9,fe,fw,fl,fC,fu,fd,ft,e0,fn,fs,e6,fj,fz,fr,fk,fy,fp;cz(bB.call(O,fh)<0,"cannot create more than one notclient per user");fg=function(fD){return $u.isNumber(fD)&&fD%1===0&&fD>0};fm=function(fD){return $u.isNumber(fD)&&fD%1===0&&fD>=0};cz(fg(fh),"user_id must be a positive integer");e4=function(){var fD;fD=1<=arguments.length?cS.call(arguments,0):[];if(b){return console.log.apply(console,fD)}};fv=90000;fa=8096;fi="user";e7="list";e2=false;fx=1000;e8=5*60*1000;fC=0;fj=function(){var fD;if(e3===0){fD=0}else{fD=Math.min(fx*Math.pow(2,e3-1),e8)}return Math.max(fD,fC)};fw=null;fu={};fA={};fe=1;fB=false;e5=false;fy=null;fq=false;fr=[];e6=null;T=null;fo=null;e9={};fd=false;e3=0;fz=0;fk=function(fH,fF){var fE,fD,fG;fG=[];for(fE in fF){fD=fF[fE];fE=parseInt(fE,10);cz(fg(fE),"ns_ids must be positive integers: "+fE);cz(fm(fD),"sjids must be nonnegative integers: "+fD);if(fH[fE]!=null){fG.push(fH[fE]=Math.min(fH[fE],fD))}else{fG.push(fH[fE]=fD)}}return fG};e1=function(){var fF,fE,fG,fD;cz((fw!=null)&&!$u.isEmpty(fu),"expected nid and ns_map");fG={host_int:0,trace:window.location.pathname,rev:Constants.SVN_REV};fF=$u.pluck($u.values(fA),"type");if(bB.call(fF,fi)>=0){fG.user_id=fh;fG.nid=fw!=null?fw.replace(/^0+(.)/,"$1"):void 0}if(bB.call(fF,e7)>=0){fG.ns_map=((function(){var fH;fH=[];for(fE in fu){fD=fu[fE];fH.push(""+fE+"_"+fD)}return fH})()).join(",")}if(D.parse(dT).updateQuery(fG).toString().length>fa){delete fG.ns_map}return fG};fc=function(){var fD;if(!e2){return}fD=fj();if(fD>0){return T=window.setTimeout(fp,fD)}else{return fp()}};fp=function(){var fD;cz(!fB&&!e5,"connect: invalid state");cz(fw>=0||!$u.isEmpty(fu),"notclient: called connect with nothing to subscribe to");e4("###########################");fD=e1();if((fD.nid==null)&&!fD.ns_map){e4("nothing to subscribe to. skipping notserver connection.");return}e4("connecting to notserver...");fB=true;fz+=1;return fy=bv.ajax(dT,{data:fD,dataType:"json",noDropboxDefaults:true,error:function(){if(fq){fq=false;return}e3+=1;e4("error connecting to notserver. bad rounds="+e3+".");fB=false;return fc()},success:function(fE){e4("notserver connection closed. response:",fE);fB=false;if(fE.chillout!=null){fC=parseInt(fE.chillout,10)*1000;e4("notserver told us to chill for "+fC+"ms")}else{if(fC>0){e4("setting notserver chillout back to 0ms");fC=0}}if(fE.ret==="punt"){return fc()}else{cz(fE.ret==="new","unknown notserver ret: "+fE.ret);cz("refresh" in fE,"expected notserver ret:new to have refresh keyword");return fs(fE.refresh)}}})};ff=function(){if(fy!=null){fq=true;fy.abort();return fy=null}};ft=function(){fC=0;fB=false;e5=false;ff();fr=[];window.clearTimeout(e6);window.clearTimeout(T);e6=null;T=null;fo=null;e9={};fd=false;e3=0;return fc()};fn=function(){var fD;e2=false;fC=0;fw=null;fu={};fA={};fD=0;fe=1;fB=false;e5=false;fy=null;fq=false;fr=[];window.clearTimeout(e6);window.clearTimeout(T);e6=null;T=null;fo=null;e9={};fd=false;e3=0;return fz=0};fs=function(fI){var fL,fH,fD,fE,fJ,fF,fK,fG;cz(!e5&&!fB,"run_handlers: invalid state");cz(fo===null,"run_handlers: new_nid must start at null");cz($u.isEqual(e9,{}),"run_handlers: new_ns_map must start at {}");cz(!fd,"expected one_or_more_handler_failures=false");e5=true;e4("running handlers...");fE=$u.filter($u.values(fA),function(fN){var fM;return fM=fN.type,bB.call(fI,fM)>=0});cz(!$u.isEmpty(fE),"notserver sent a ping for unsubscribed activity");fr=$u.pluck(fE,"handler_id");for(fF=0,fK=fE.length;fF<fK;fF++){fG=fE[fF],fL=fG.handler,fH=fG.handler_id,fD=fG.name,fJ=fG.type;e4("running id="+fH+", name="+fD+", type="+fJ);fL()}if($u.isEmpty(fr)){return e4("all handlers already finished running. no need for a slacker timeout.")}else{e4("all handlers running. slacker timeout set.");return e6=window.setTimeout(e0,fv)}};e0=function(){var fF,fG,fE,fD;cz(e5&&!fB,"called report_slackers in an invalid state.");cz(!$u.isEmpty(fr,"report_slackers called w/ nothing slackin'"));e4("found some slackers");fd=true;fD=[];for(fG=0,fE=fr.length;fG<fE;fG++){fF=fr[fG];fD.push(fb(fF))}return fD};fb=function(fD){if(bB.call(fr,fD)<0){return}e4("done handling: "+fD);fr=$u.without(fr,fD);if($u.isEmpty(fr)){e4("all handlers are done running.");e5=false;window.clearTimeout(e6);if(fo!=null){e4("new nid: "+fo);fw=fo}if(!$u.isEmpty(e9)){e4("new ns_map:",e9);fu=e9}if(fd){e3+=1;e4("one or more handler errors. bad_rounds="+e3)}else{e3=0}fo=null;e9={};fd=false;return fc()}};fl={get_user_id:function(){return fh},get_nid:function(){return fw},get_ns_map:function(){return $u.clone(fu)},get_consecutive_bad_rounds:function(){return e3},get_total_rounds:function(){return fz},get_notserver_chillout_ms:function(){return fC},get_sleep_ms:fj,subscribe_user:function(fK){var fE,fF,fJ,fI,fH,fD,fG;cz(!e5,"adding new handlers from inside handlers is not currently supported");fG=["name","handler"];for(fH=0,fD=fG.length;fH<fD;fH++){fI=fG[fH];cz(fK[fI],"subscribe_user requires this param be non-falsey: "+fI)}cz($u.isFunction(fK.handler),"handler must be a function");e4("adding user handler "+fK.name);fF=$u.pluck($u.values(fA),"type");fJ=bB.call(fF,fi)<0;fE=fe++;fA[fE]={handler_id:fE,handler:fK.handler,name:fK.name,type:fi};if(fJ){e4("first user handler added, reconnecting");ft()}return fE},subscribe_sfj:function(fK){var fE,fF,fJ,fI,fH,fD,fG;cz(!e5,"adding new handlers from inside handlers is not currently supported");fG=["name","handler"];for(fH=0,fD=fG.length;fH<fD;fH++){fI=fG[fH];cz(fK[fI],"subscribe_sfj requires this param be non-falsey: "+fI)}cz($u.isFunction(fK.handler),"handler must be a function");e4("adding sfj handler "+fK.name);fF=$u.pluck($u.values(fA),"type");fJ=bB.call(fF,e7)<0;fE=fe++;fA[fE]={handler_id:fE,handler:fK.handler,name:fK.name,type:e7};if(fJ){e4("first sfj handler added, reconnecting");ft()}return fE},handler_success:function(fD,fF){var fE;if(bB.call(fr,fD)<0){return}fE=fA[fD].type;if(fE===e7){cz("ns_map" in fF,"ns_map required param is missing");cz(!("nid" in fF),"nid is disallowed from SFJ handlers");fk(e9,fF.ns_map)}else{cz(fE===fi,"unknown handler type: "+fE);cz("nid" in fF,"nid required param is missing");cz(!("ns_map" in fF),"ns_map is disallowed from user handlers");if((fo==null)||fF.nid<fo){fo=fF.nid}}return fb(fD)},handler_failure:function(fD){e4("handler failed. handler_id="+fD);if(bB.call(fr,fD)<0){return}fd=true;return fb(fD)},handle_visibility_change:function(){if(window.document.hidden){return ff()}else{return ft()}},init:function(fE,fD){cz(!e2,"error: init() has been called twice.");fw=fE;fk(fu,fD);e2=true;if(window.document.visibilityState!=null){window.document.on("visibilitychange",this.handle_visibility_change);if(!window.document.hidden){return fc()}}else{return fc()}},reset:fn,abort:ff,reconnect:ft};O[fh]=fl;return fl};var bu;bu=B.UpdateEvents={ADD:"db:add_file_objects",REMOVE:"db:remove_file_objects",MOVE:"db:move_file_objects"};var bX;bX=B.FileTypes={FILE:1,FOLDER:2,PACKAGE:3,SHARED_FOLDER:4,SANDBOX:5,TEAM_SHARED_FOLDER:6};var aY;aY=B.BrowseUtil={THUMBS_BATCH_SIZE:16,make_browsefile:function(e0,e1){var T;if(e1==null){e1=null}T=Object.clone(e0);if(T.is_dir){T.ago="";T.ts=0}else{T.target_ns=false}T.sort_key=dQ.decode_sort_key(T.sort_key);T.request_id=e1!=null?e1:null;return new cH(T)},filepreview_from_selected:function(fd,fi,fj,e3,e4,e5,fc){var fg,e9,e6,fe,e1,fb,e0,e7,ff,fa,e8,e2,T,fh;if(e3==null){e3=false}if(e4==null){e4=false}if(e5==null){e5=false}if(fc==null){fc=false}if(fi&&(fi.bytes<0||fi.preview_type==="download")){window.open(fi.href,"_blank");return}e2=eo.get_url();fb=eo.deconstruct_url(e2);e1=e2.indexOf("/lightbox")===0;e6=e2.indexOf("/sh/")===0;e9=e2.indexOf("/s/")===0;e0=fb.qargs.preview!=null;if((fd==="callback")&&e1&&aE.shown){return}else{if(fd==="fileclick"&&fi&&(e5||fi.preview_type!=="photo")&&(e5||fi.preview_type!=="video")){l.show(fi,ci.active_user,{files:ci.files,in_browse:true,should_focus_comment_input:fc});if(!(e4||e9||fb.qargs.preview===fi.filename)){l.set_preview_url()}return}}if(!fi){fa=eG.get_selected_files();fi=fa&&fa.first()}ff=e3?[fi]:ci.files;e7=this.browsefile_to_filepreview(ff,e5);if(e7.length){e8=0;if(fi){for(fe=T=0,fh=e7.length;T<fh;fe=++T){fg=e7[fe];if(fg.fq_path===fi.fq_path){e8=fe;break}}}if(e6){ad.close_shared_link_view()}return aE.init(e7,{start_index:e8,include_delete:true,keep_url:e9||e4,is_loading:fj,share_button_experiment_variant:ci.lightbox_share_button_experiment_variant})}},browsefile_to_filepreview:function(T,e2){var e4,e6,e1,e5,e0,e3,e7;if(e2==null){e2=false}e5=[];for(e3=0,e7=T.length;e3<e7;e3++){e4=T[e3];if(e4.bytes<0||e4.dir){continue}if(!e2&&e4.preview_type==="photo"&&e4.large_thumbnail_url_tmpl){e6="null-"+e4.filename;e1=new V({filename:e4.filename,fq_path:e4.fq_path,thumbnail_url_tmpl:e4.large_thumbnail_url_tmpl,dl_url:D.parse(e4.href).updateQuery({dl:1}).toString(),original_url:e4.href,link_hash:e6,ns_id:e4.ns_id,ns_path:e4.ns_path,owner_id:e4.user_id});e5.push(e1)}else{if(!e2&&e4.preview_type==="video"&&e4.large_thumbnail_url_tmpl&&!Constants.DISABLE_VIDEOS_IN_LIGHTBOX){e0=new bx({filename:e4.filename,fq_path:e4.fq_path,thumbnail_url_tmpl:e4.large_thumbnail_url_tmpl,preview_url:e4.video_transcode_url(),dl_url:D.parse(e4.href).updateQuery({dl:1}).toString(),ns_id:e4.ns_id,ns_path:e4.ns_path,owner_id:e4.user_id});e5.push(e0)}}}return e5},profile_files:function(e0){var e1,e2,e3,T;e2={files:0,folders:0,shared_folders:0,deleted:0,public_folder:0,rejoinables:0,sandboxes:0,target_namespaces:0,in_root_coll:0};for(e3=0,T=e0.length;e3<T;e3++){e1=e0[e3];if(e1.dir){e2.folders+=1}else{e2.files+=1}if(e1.is_sandbox()){e2.sandboxes+=1}if(e1.is_shared_folder()){e2.shared_folders+=1}if(e1.bytes===-1){e2.deleted+=1}if(e1.target_ns){e2.target_namespaces+=1}if(e1.fq_path.toLowerCase()==="/public"&&ci.public_folder_enabled){e2.public_folder=1}if(e1.in_root_coll){e2.in_root_coll+=1}}return e2},profile_summary:function(e0){var e1,T;e1=a4("%d file","%d files",e0.files,{comment:"used in a phrase such as 'x files and y folders'"}).format(e0.files);T=a4("%d folder","%d folders",e0.folders,{comment:"used in a phrase such as 'x files and y folders'"}).format(e0.folders);if(e0.files&&e0.folders){return el("%(x_files)s and %(y_folders)s",{comment:"x_files will either be '1 file' or 'd files', similar for x_folders"}).format({x_files:e1,y_folders:T})}else{if(e0.files){return e1}else{if(e0.folders){return T}else{return""}}}},BROWSE_MODE:"browse",SEARCH_MODE:"search",SPECIAL_MODES:["search"],set_browse_mode:function(){var e6,e4,e1,e0,e5,e3,T,e2;e6=bv("#browse");e1=e6.find("#browse-root-actions");e0=e6.find("#browse-sort");e4=e6.find("#browse-header-status");e2=this.SPECIAL_MODES;for(e3=0,T=e2.length;e3<T;e3++){e5=e2[e3];e6.removeClass(e5);e1.removeClass(e5);e0.removeClass(e5);e4.removeClass(e5)}if(bZ.sparky_search_ui_enabled){bZ.reset_fulltext_search(true);e6.removeClass("fulltext_search");e1.removeClass("fulltext_search");e0.removeClass("fulltext_search");e4.removeClass("fulltext_search");bv("#fulltext-search-loading").hide();return bv("#fulltext-search-all-link").hide()}},set_special_mode:function(e5){var e0,e1,e7,T,e4,e2,e6,e3;e0=bv("#browse");e7=e0.find("#browse-root-actions");T=e0.find("#browse-sort");e1=e0.find("#browse-header-status");cz(this.SPECIAL_MODES.indexOf(e5)!==-1,"unknown mode");if(e0.hasClass(e5)){cz(e7.hasClass(e5),"inconsistent modes");cz(T.hasClass(e5),"inconsistent modes");return}e3=this.SPECIAL_MODES;for(e2=0,e6=e3.length;e2<e6;e2++){e4=e3[e2];if(e4!==e5){e0.removeClass(e4);e7.removeClass(e4);T.removeClass(e4);e1.removeClass(e4)}}e0.addClass(e5);e7.addClass(e5);T.addClass(e5);e1.addClass(e5);if(e5===this.SEARCH_MODE){if(bZ.sparky_search_ui_enabled){e0.addClass("fulltext_search");e7.addClass("fulltext_search");T.addClass("fulltext_search");return e1.addClass("fulltext_search")}}},get_mode:function(){var e3,T,e2,e0,e1;T=this.BROWSE_MODE;e1=this.SPECIAL_MODES;for(e2=0,e0=e1.length;e2<e0;e2++){e3=e1[e2];if(bv("#browse").hasClass(e3)){T=e3}}return T},load_visible_thumbs:function(){var e9,fc,e2,e8,fd,fe,fa,e1,e6,e0,e5,e4,fb,T,e7,e3;e1=this.get_files_in_view();fc=e1[1]-e1[0];fa=[Math.max(e1[0]-fc,0),e1[0]];fe=[Math.min(e1[1],ci.files.length),Math.min(e1[1]+fc,ci.files.length)];e9=[];e7=[e1,fe,fa];for(e5=0,fb=e7.length;e5<fb;e5++){fd=e7[e5];e8=fd[0],e6=fd[1];e3=ci.files.slice(e8,+e6+1||9000000000);for(e4=0,T=e3.length;e4<T;e4++){e2=e3[e4];if(e2.get_div()){e9.push(e2.get_div().down("img"))}}}e0=function(ff){if(!ff.src.endsWith(cm.SPACER)){ff.addClassName("thumbnail");return ff.__sert({before:new Element("div",{"class":"thumbnail-border"})})}};return bl.batch_load_thumbs(e9,this.THUMBS_BATCH_SIZE,e0)},get_files_in_view:function(){var e5,e2,e7,e3,e4,e1,T,e8,e6,e0,e9;T=[0,ci.files.length-1];e0=z.viewport_dimensions().height;e9=z.scroll_offsets().top;e1=this._get_elm_height();if(!e1){return T}e5=bv("#browse-files");e3=parseInt(e5.css("padding-top"),10);if(!e5.length||isNaN(e3)){return T}if(bv("body").hasClass("absolutize")){e2=e5.offset().top+e3;e7=e2-e9;if(e7>0){e8=0;e4=e0-e7;e6=e4/e1}else{e8=Math.abs(e7/e1);e6=Math.abs(e0-e7)/e1}}else{e8=e9/e1;e4=e0-e3;e6=(e4+e9)/e1}e8=Math.max(Math.floor(e8),0);e6=Math.min(Math.floor(e6),ci.files.length-1);return[e8,e6]},_get_elm_height:function(){var e0,T;if(ci.files.length>=3&&ci.files[1].get_div()){e0=bv(ci.files[1].get_div());T=e0.outerHeight()+parseInt(e0.css("margin-bottom"))+parseInt(e0.css("margin-top"));return T}else{return null}},append_ellipsis:function(T){return el("%(action_text)s\u2026","web","action which requires further user interaction").format({action_text:T})},_show_blue_sharing_icons:function(){return ci.sharing_icons_experiment_variant&&ci.sharing_icons_experiment_variant==="BLUE_ICONS"},get_shared_folder_icon:function(){if(this._show_blue_sharing_icons()){return"s-folder-blue"}else{return"rainbow_16"}},get_shared_link_icon:function(){if(this._show_blue_sharing_icons()){return"s-link-blue"}else{return"s_link"}}};var bj;bj=B.Sort=(function(){var e5,T,e2,e4,e3,e1,e0;e2=function(e7){var e6;e6=e7?1:-1;return function(e8,e9){return e6*dQ.sort_by_rank_or_key(e8,e9)}};e4=function(e7){var e6;e6=e7?1:-1;return function(e8,e9){if(e8.bytes>e9.bytes){return e6}else{if(e8.bytes<e9.bytes){return -e6}else{return e6*bj.FILES_BY_NAME(e8,e9)}}}};e5=function(e7){var e6;e6=e7?1:-1;return function(e8,e9){return e6*(e8.fq_path.toLowerCase()>e9.fq_path.toLowerCase()?1:-1)}};T=function(e7){var e6;e6=e7?1:-1;return function(e9,fa){var e8;e8=e9.ts===fa.ts?0:e9.ts>fa.ts?1:-1;return e6*e8}};e1=function(e6){return function(e9){var e8,e7;e7=e6(e9);e8=e2(true);return function(fa,fb){if(fa.dir^fb.dir){return(fa.dir?1:0)-(fb.dir?1:0)}else{return e7(fa,fb)||e8(fa,fb)}}}};e3=function(e6){return function(e9){var e7,e8;if(!bj.FOLDERS_FIRST){return e6(e9)}e8=e6(e9);e7=e9?1:-1;return function(fb,fc){var fa;if(fb.dir^fc.dir){fa=(fb.dir?0:1)-(fc.dir?0:1);return e7*fa}else{return e8(fb,fc)}}}};e0=function(e6){return function(e9){var e7,e8;e8=bj.FILES_BY_NAME(e9);e7=e9?1:-1;return function(fb,fc){var fa;if(fb.is_deleted^fc.is_deleted){return(fb.is_deleted?1:0)-(fc.is_deleted?1:0)}fa=0;if(e6){if(fb.get_category()!==fc.get_category()){fa=fb.get_category()<fc.get_category()?-1:1}else{if(fb.get_extension()!==fc.get_extension()){fa=fb.get_extension()<fc.get_extension()?-1:1}}}else{if(fb.get_extension()!==fc.get_extension()){fa=fb.get_extension()<fc.get_extension()?-1:1}else{if(fb.get_category()!==fc.get_category()){fa=fb.get_category()<fc.get_category()?-1:1}}}return(e7*fa)||e8(fb,fc)}}};return{FILES_BY_NAME:e3(e2),SHARED_WITH:e3(e2),FILES_BY_SIZE:e1(e4),FILES_BY_LOCATION:e1(e5),FILES_BY_KIND:e1(e0(true)),FILES_BY_EXTENSION:e1(e0(false)),FILES_BY_MODIFIED:e1(T),FOLDERS_FIRST:!dQ.is_mac(),ALL_BY_MODIFIED:T}})();var db,bB=[].indexOf||function(e1){for(var e0=0,T=this.length;e0<T;e0++){if(e0 in this&&this[e0]===e1){return e0}}return -1};db=B.FlexColumn=(function(){var e4,e0,e7,e3,e6,e1,T,e2,e5;e4=[{label:"FILES_BY_KIND",func:bj.FILES_BY_KIND,display:el("Kind"),is_asc:true},{label:"FILES_BY_EXTENSION",func:bj.FILES_BY_EXTENSION,display:el("Extension"),is_asc:true},{label:"FILES_BY_SIZE",func:bj.FILES_BY_SIZE,display:el("Size"),is_asc:false}];e6={label:"SHARED_WITH",func:bj.FILES_BY_NAME,display:el("Shared With"),is_asc:true};e0={};e7={};e1=[];e3=[];for(e2=0,e5=e4.length;e2<e5;e2++){T=e4[e2];e1.push(T.func);e0[T.label]=T.display;e7[T.label]=T.is_asc;e3.push(T.label)}e7[e6.label]=e6.is_asc;return{SORT_FUNCTIONS:e1,DISPLAY:e0,IS_ASC:e7,LABELS:e3,has_label:function(e8){return(bB.call(this.LABELS,e8)>=0)||e8===e6.label},has_sort:function(e8){return bB.call(this.SORT_FUNCTIONS,e8)>=0},next:function(fa,e9){var e8;if(e9==null){e9=false}e8=db.LABELS.indexOf(fa)+1;if(e8===db.LABELS.length){if(e9){return e6}else{e8=0}}return e4[e8]}}})();var bZ,en;en=B.SearchType={COMPLETION:"completion",DELETED:"deleted",FULLTEXT:"full-text"};bZ=B.FileSearch={MAX_RESULTS:100,SHORT_PREFIX_LEN:2,SHORT_PREFIX_DELAY_TIME:250,_cache:{},_cache_ts:{},CACHE_TIME:60000,last_state:false,last_fq_path:null,scoped_search:true,last_new_search_ts:{},is_loaded:false,init:function(fd,e8,e9,fe){var fc,e0,fb,e7,e1,e5,e4,fa,T,e6,e3,e2;this.sparky_search_ui_enabled=fd;this.firefly_enabled=e8;this.fulltext_search_enabled=e9;this.search_page_enabled=fe;if(this.sparky_search_ui_enabled){return}e7=$("browse-search");fb=$("browse-search-input");b8.add_interval_handler(e7,this.search_with_delay.bind(this));$("advanced-search-box").observe("submit",(function(ff){return function(fg){ff.search();return Event.stop(fg)}})(this));$("exit-search-xclose").observe("click",(function(ff){return function(){return ff.exit_search()}})(this));key("/",ci.KEY_SCOPE,function(){if(L.is_active()){return}if(!e7.hasClassName("focused")){fb.focus();return false}});key("escape",ci.KEY_SCOPE,(function(ff){return function(){if(ci.in_search_mode()){ff.exit_search();return false}if(fb.getValue().strip()===""){fb.blur();return false}}})(this));key("tab",ci.KEY_SCOPE,(function(ff){return function(fg){if(document.activeElement===fb){fg.preventDefault();fb.blur();if(ci.files.length){eG.set_selected_files(ci.files[0])}else{if(ci.in_search_mode()){ff.toggle_advanced()}}return false}}})(this));e1="#advanced-search-link, #advanced-search-exit, #advanced-search-cancel";$(document.body).on("click",e1,this.toggle_advanced.bind(this));bv(document).on(aC.RENAME,(function(ff){return function(){return ff.clear_cache()}})(this));e6=[aC.DELETE,aC.COPY,aC.MOVE,aC.PURGE,aC.RESTORE,aC.UPLOAD,aC.SF_NEW,aC.SF_LEAVE,aC.SF_UNSHARE,aC.SF_REJOIN,aC.SF_IGNORE,aC.LINKS_REMOVE];for(e5=0,fa=e6.length;e5<fa;e5++){e0=e6[e5];fc=(function(ff){return function(fg){if(!ci.inside_dir){return ff.force_reload()}}})(this);document.observe(e0,fc);bv(document).on(e0,fc)}e3=[bu.ADD,bu.MOVE,bu.REMOVE];e2=[];for(e4=0,T=e3.length;e4<T;e4++){e0=e3[e4];e2.push(document.observe(e0,(function(ff){return function(fg){return ff._update_number_results(ci.files.length)}})(this)))}return e2},get_state:function(){var e5,e1,e4,e0,e3,T,e2;e5=bv("#browse-search");if(this.sparky_search_ui_enabled){e4={is_advanced:false}}else{e4={is_advanced:e5.length&&!e5.visible()}}if(e4.is_advanced){e2=["all_terms","any_terms","excluded_terms","exact"];for(e3=0,T=e2.length;e3<T;e3++){e1=e2[e3];e0=bv("#"+e1).val();if(e0){e4[e1]=e0}}e4.include_files=bv("#include_files").prop("checked");e4.include_folders=bv("#include_folders").prop("checked");e4.include_deleted=!Constants.can_see_trash&&bv("#include_deleted").prop("checked")}else{e4.query_unnormalized=this.get_basic_query();e4.query=e4.query_unnormalized.toLowerCase().strip().split(RegExp(" +")).join(" ");if(this.sparky_search_ui_enabled){e4.last_fq_path=this.last_fq_path!=null?this.last_fq_path:""}}return e4},set_state:function(e3){var e0,e2,T,e1;if(e3.is_advanced){e1=["all_terms","any_terms","excluded_terms","exact"];for(e2=0,T=e1.length;e2<T;e2++){e0=e1[e2];if(e3[e0]){$(e0).setValue(e3[e0])}}bv("#include_files").prop("checked",e3.include_files);bv("#include_folders").prop("checked",e3.include_folders);if(!Constants.can_see_trash){bv("#include_deleted").prop("checked",e3.include_deleted)}this.show_advanced();return this.search()}else{if(this.sparky_search_ui_enabled){this.last_fq_path=e3.last_fq_path!=null?e3.last_fq_path:"";this.scoped_search=this.last_fq_path!=="";ci.inside_dir=this.scoped_search}this.set_basic_query(e3.query_unnormalized);this.show_basic();if(this.sparky_search_ui_enabled){if(this.search_page_enabled){return this.do_search(false,true)}else{return this.do_search(this.scoped_search,true)}}else{return this.search()}}},state_changed:function(){var e0,T;e0=this.get_state();T=this.last_state;if(this.sparky_search_ui_enabled){if(T===false){return !!e0.query}return(e0.is_advanced!==T.is_advanced)||(e0.query!==T.query)||(e0.last_fq_path!==T.last_fq_path)}else{if(T===false){return !!e0.query}return(e0.is_advanced!==T.is_advanced)||(e0.query!==T.query)}},get_basic_query:function(){return this._get_browse_search_input().val()},set_basic_query:function(T){if(T===this.get_basic_query()){return}this._get_browse_search_input().val(T);if(!this.sparky_search_ui_enabled){$("browse-search").show()}return $("advanced-search-link").__date(el("Advanced search"))},set_title:function(){var T,e0;T=this.get_state();e0=el("Search - Dropbox");if(T.query_unnormalized){e0=""+T.query_unnormalized+" - "+e0}return document.title=e0},_pending_search_q:"",search_with_delay:function(){var e0,e1,T;e1=this.search.bind(this);T=this.get_state();if(T.is_advanced){return}e0=T.query;if(e0.length===0&&ci.in_search_mode()){e1();return}if(e0.length<=this.SHORT_PREFIX_LEN){if(e0!==this._pending_search_q){this._pending_search_q=e0;clearTimeout(this._pending_search_timer);return this._pending_search_timer=setTimeout(e1,this.SHORT_PREFIX_DELAY_TIME)}}else{this._pending_search_q="";if(this.state_changed()){return e1()}}},_set_scope_path_to_browse_location:function(){if(ci.inside_dir){return this.last_fq_path=ci.containing_fq_path()}else{return this.last_fq_path=""}},do_search:function(e1,T){var e3,e4,e2,e0;if(T==null){T=false}if(typeof ci.entered_search==="function"){ci.entered_search()}e0=!T&&!ci.in_search_mode();if(this.sparky_search_ui_enabled&&e0){this._set_scope_path_to_browse_location()}e2=this.get_state();e4=""===this.get_basic_query();if(!e2.is_advanced&&e4){if(ci.in_search_mode()){this._clear_on_reload=false;this.exit_search()}return}this.last_state=e2;this._clear_on_reload=true;if(!(ci.in_search_mode()&&!this.sparky_search_ui_enabled)){eG.deselect_all();ci.clear();aY.set_special_mode("search");if(!this.sparky_search_ui_enabled){this._set_scope_path_to_browse_location()}this.scoped_search=this.last_fq_path!=="";if(!T){e3=null;if(this.sparky_search_ui_enabled){if(this.search_page_enabled){eo.push_state("/search/"+ci.active_user.role,e2)}else{eo.push_state("/search",e2)}}else{eo.push_state("/search")}}}this._prune_cache();this.set_title();if(e2.is_advanced){this.ask_server_advanced()}else{if(this.sparky_search_ui_enabled){this.reset_fulltext_search(this.scoped_search);this.last_new_search_ts=new Date();bv("#fulltext-search-loading").show();this.ask_server("/ajax_fulltext_search",e1,0,this.MAX_RESULTS,false)}else{if(e2.query in this._cache){this.update_results()}else{if(!this.attempt_cache_filter()){this.ask_server("/ajax_search",false)}}}}return es("search")},build_search_url:function(T,e0){if(this.search_page_enabled){return eo.construct_url("/search/"+T.role,e0)}else{return eo.construct_url("/search",e0)}},search:function(T){if(T==null){T=false}if(T!==this.scoped_search){this.last_state=false}this.scoped_search=this.scoped_search&&T;if(this.sparky_search_ui_enabled&&!this.scoped_search){this.last_fq_path=""}return this.do_search(false)},load_more_results:function(){var T;if(this.sparky_search_ui_enabled&&!this.end_of_results){T=this.search_pos;if(this.end_of_active_results){T=this.deleted_search_pos}return this.ask_server("/ajax_fulltext_search",false,T,this.MAX_RESULTS,this.end_of_active_results)}},firefly_filename_search:function(){return this.do_search(true)},_prune_cache:function(){var e1,e2,e4,e3,e0,T;e1=new Date();e2=[];for(e4 in this._cache_ts){if(e1-this._cache_ts[e4]>this.CACHE_TIME){e2.push(e4)}}T=[];for(e3=0,e0=e2.length;e3<e0;e3++){e4=e2[e3];delete this._cache[e4];T.push(delete this._cache_ts[e4])}return T},update_empty:function(){var T;T=el("No results found");if(this.scoped_search&&this.sparky_search_ui_enabled){T=el("No results found in '%(path)s'").format({path:av.filename(this.last_fq_path)})}bv("#noresults-header").text(T);bv("#fulltext-search-all-link").hide();bv("#noresults-directions").toggle(!(this.scoped_search&&this.sparky_search_ui_enabled));return bv("#noresults-search-all-link").toggle(this.scoped_search&&this.sparky_search_ui_enabled)},show_empty:function(){this.update_empty();return $("search-empty").show()},hide_empty:function(){return $("search-empty").hide()},reset_fulltext_search:function(T){eG.deselect_all();ci.clear();ci.reset_state();ci.update_header_status("");this.search_pos=0;this.deleted_search_pos=0;this.end_of_active_results=false;this.end_of_results=false;this.scoped_search=T;return bv("#fulltext-search-all-link").hide()},exit_search:function(){var e3,e0,e2,T,e1;if(ci.in_search_mode()&&this.sparky_search_ui_enabled){if(this.search_page_enabled){e3=[ci.inside_deleted_dir,ci.inside_deleted_sandbox,ci.inside_deleted_shared_folder];if(!$u.any(e3)){ci.deleted_shown=false}}else{ci.deleted_shown=false}}e1=$$("#advanced-search-box .sick-input input");for(e2=0,T=e1.length;e2<T;e2++){e0=e1[e2];e0.setValue("");e0.blur()}this.show_basic();$("browse").removeClassName("pending-search");this.hide_empty();if(this.search_page_enabled){return aX.set_path_url(null,this.last_fq_path,ci.deleted_shown)}else{ci.first_load=true;return ci.reload_fqpath(this.last_fq_path,true)}},clear_cache:function(){this._cache={};return this._cache_ts={}},force_reload:function(){this.clear_cache();return this.search()},create_completion_log_dict:function(e0,e5,e2,e3,e4,T,e1){if(e0==null){e0=null}if(e5==null){e5=null}if(e2==null){e2=null}if(e3==null){e3=null}if(e4==null){e4=null}if(T==null){T=null}if(e1==null){e1=null}if(e0==null){return}if(e5!=null){e0.request_id=e5}if(e2!=null){e0.latency=(new Date().getTime())-e2}if(e3!=null){e0.query_string=e3.query;if((T==null)||T===200){e0.displayed=this.last_state.query===e3.query?true:false}}if(e4!=null){e0.result_count=e4}if((T!=null)&&T!==200){e0.failure_type=T}if(e1!=null){e0.file_nsid=e1.ns_id;e0.file_sjid=e1.sjid}return e0},ask_server:function(e0,e5,e1,e6,e3){var e4,e9,e7,e2,e8,T;T=this.get_state();e8=null;if(this.sparky_search_ui_enabled){e2=new Date();if(e3){e8=en.DELETED}else{if(e5){e8=en.COMPLETION}else{e8=en.FULLTEXT}}}e4={firefly:this.firefly_enabled,infinite_scroll:e1>0?true:false,path_scoped:false,search_type:e8,query_string:T.query};a3.SearchClientActivityLogger.log("query_started",ci.active_user.id,e4);cz(!T.is_advanced,"expected to be in basic search mode");if(!e1){bv("#web-search-results").html(el("Searching..."))}bv("#browse").addClass("pending-search");e9={query:T.query};if(this.sparky_search_ui_enabled){if(e1){e9.start=e1}if(e6){e9.max_results=e6}if(e3){e9.deleted=e3}if(this.scoped_search){e9.fq_path=this.last_fq_path}if(!e5){this.last_fulltext_query=T.query}}if(e5){e9.filename_only=true}e7=false;return new Ajax.DBRequest(e0,{no_watch:true,evalJSON:false,parameters:e9,log_timing:true,onSuccess:(function(fa){return function(fc){var fd,fb,ff,fe;if(!ci.in_search_mode()){return}ff=fc.request.parameters.parent_request_id;fd=JSON.parse(fc.responseText);fe=fd.file_info.length;if(fa.sparky_search_ui_enabled){if(T.query===fa.last_fulltext_query&&e2>=fa.last_new_search_ts){fa.search_pos=fa.search_pos+fe;if(fa.end_of_active_results){fa.deleted_search_pos=fa.deleted_search_pos+fe}if(fe<fa.MAX_RESULTS){fa.end_of_results=true&&fa.end_of_active_results;fa.end_of_active_results=true;if(!fa.end_of_results){e7=true}else{bv("#fulltext-search-loading").hide()}}fa.update_results(fd,e7,ff)}}else{fa._cache[T.query]=fd;fa._cache_ts[T.query]=new Date();if(!fa.last_state.is_advanced&&(fa.last_state.query===T.query)){fa.update_results(null,false,ff)}}if(fd.file_info.length>0){fb=fd.file_info[0]}else{fb=null}e4=fa.create_completion_log_dict(e4,ff,fc.request.start_time,T,fe,null,fb);return a3.SearchClientActivityLogger.log("query_completed",ci.active_user.id,e4)}})(this),onFailure:(function(fa){return function(fb){e4=fa.create_completion_log_dict(e4,fb.request.parameters.parent_request_id,fb.request.start_time,T,null,fb.status);return a3.SearchClientActivityLogger.log("query_failed",ci.active_user.id,e4)}})(this),cleanUp:(function(fa){return function(){if(e7){return fa.load_more_results()}else{return bv("#browse").removeClass("pending-search")}}})(this),subject_user:ci.active_user})},ask_server_advanced:function(){var T,e0;e0=this.get_state();T={firefly:this.firefly_enabled,query_string:e0.query};a3.SearchClientActivityLogger.log("query_started",ci.active_user.id,T);cz(e0.is_advanced,"expected to be in advanced search mode");cz(!e0.query,"expected advanced search params only");delete e0.is_advanced;$("web-search-results").__date(el("Searching..."));$("browse").addClassName("pending-search");return new Ajax.DBRequest("/ajax_advanced_search",{no_watch:true,evalJSON:false,parameters:e0,log_timing:true,onSuccess:(function(e1){return function(e3){var e2,e4;if(!ci.in_search_mode()){return}e4=e3.request.parameters.parent_request_id;e1.advanced_results=JSON.parse(e3.responseText);e1.update_results(null,false,e4);if(e1.advanced_results.file_info.length>0){e2=e1.advanced_results.file_info[0]}else{e2=null}T=e1.create_completion_log_dict(T,e3.request.parameters.parent_request_id,e3.request.start_time,e0,e1.advanced_results.file_info.length,null,e2);return a3.SearchClientActivityLogger.log("query_completed",ci.active_user.id,T)}})(this),onFailure:(function(e1){return function(e2){T=e1.create_completion_log_dict(T,e2.request.parameters.parent_request_id,e2.request.start_time,e0,null,e2.status);return a3.SearchClientActivityLogger.log("query_failed",ci.active_user.id,T)}})(this),cleanUp:function(e1){return $("browse").removeClassName("pending-search")},subject_user:ci.active_user})},attempt_cache_filter:function(){var T,e2,e0,e6,e1,e5,e4,e3;e5=this.get_state().query;e6=this._query_to_regex(e5);e0=function(e7){return e6.match(av.filename(e7.ns_path).toLowerCase())};if(e5.length<=1){return false}for(e1=e4=e3=e5.length-1;e3<=1?e4<=1:e4>=1;e1=e3<=1?++e4:--e4){e2=e5.substr(0,e1).strip();if(e2 in this._cache){if(this._cache[e2].file_info.length<this.MAX_RESULTS){T=Object.clone(this._cache[e2]);T.file_info=T.file_info.findAll(e0);this.update_results(T);return true}else{return false}}}return false},_query_to_regex:function(T){return new RegExp(RegExp.escape(T).split(new RegExp(" +")).join(".*"))},update_results:function(e0,T,e4){var e3,e2,e1;if(T==null){T=false}if(e4==null){e4=null}if(!this.sparky_search_ui_enabled){ci.reset_state();ci.reset_sort()}e1=this.get_state();if(!e0&&e1.is_advanced){e0=this.advanced_results}if(!e0){e2="the only way to get to advanced is through basic -- expected last_state to exist and not be advanced!";cz(this.last_state&&!this.last_state.is_advanced,e2);cz(this.last_state.query in this._cache,("update() called w/o a cache entry: q="+this.last_state.query)+(e0=this._cache[this.last_state.query]))}ci.update(e0,e4);ci.set_selection_from_fq_paths_or_index(bZ);e3=e1.is_advanced?el("Basic search"):el("Advanced search");$("advanced-search-link").__date(e3);if(!T){if(this.sparky_search_ui_enabled){this._update_number_results(this.search_pos)}else{this._update_number_results(ci.files.length)}if(ci.files.length){return this.hide_empty()}else{return this.show_empty()}}},_update_number_results:function(e0){var T,e1;if(this.sparky_search_ui_enabled){if(e0===0){T=""}else{if(this.end_of_results){T=this.fulltext_search_enabled?a4("%(num_results)s result in files, folders, and content.","%(num_results)s results in files, folders, and content.",e0).format({num_results:e0}):a4("%(num_results)s result in files and folders.","%(num_results)s results in files and folders.",e0).format({num_results:e0})}else{T=this.fulltext_search_enabled?a4("Over %(num_results)s result in files, folders, and content.","Over %(num_results)s results in files, folders, and content.",e0).format({num_results:e0}):a4("Over %(num_results)s result in files and folders.","Over %(num_results)s results in files and folders.",e0).format({num_results:e0})}}}else{if(e0===0){T=el("No Results")}else{if(e0>=this.MAX_RESULTS){e0=e0+"+"}T=a4("%(num_results)s result","%(num_results)s results",e0).format({num_results:e0})}}e1=el("Search")+" - "+T;if(this.sparky_search_ui_enabled){ci.update_header_status(T);e1=el("Results for '%(query)s'").format({query:this.get_state().query});if(this.scoped_search){e1=el("Results for '%(query)s' in '%(path)s'").format({query:this.get_state().query,path:av.filename(this.last_fq_path+"'")})}}bv("#web-search-results").text(e1);if(this.sparky_search_ui_enabled&&this.scoped_search){return bv("#fulltext-search-all-link").show()}},show_advanced:function(){$("browse").addClassName("advanced-search");$("browse-search").hide();$("advanced-search-link").__date(el("Basic search"));$("advanced-search-box").show();return $("all_terms").focus()},show_basic:function(T){$("browse").removeClassName("advanced-search");$("advanced-search-box").hide();$("advanced-search-link").__date(el("Advanced search"));if($("browse-search")){$("browse-search").show();if(!T){return $("browse-search-input").focus()}}},toggle_advanced:function(){var T,e0;e0=$("advanced-search-link");e0.toggleClassName("selected");if(e0.hasClassName("selected")){bv("#all_terms").val(this.get_basic_query());return this.show_advanced()}else{T=bv("#all_terms").val();if(T){this.set_basic_query(T);return this.show_basic()}else{return this.exit_search()}}},history_change_handler:function(T,e2){var e3,e0,e1;e0=typeof this._get_browse_search_input().find("input").attr("value")==="string";e1=e0&&!this.is_loaded;if(this.sparky_search_ui_enabled&&e2){this.last_state=e2;this.last_state.is_advanced=false}if(!this.last_state){aX.set_path_url(Constants.root_ns,"");return}if(this.state_changed()||e1){this.set_state(this.last_state)}if(!l.shown()){key.setScope(ci.KEY_SCOPE)}if(eG.get_selected_files().length){e3=eG.get_selected_files()[0].get_div();ci.scrollToWithPadding(e3,e3.getHeight()*2)}return this.is_loaded=true},clear_searchbox:function(){return this._get_browse_search_input().val("")},_get_browse_search_input:function(){return bv("#browse-search-input")}};var ea;ea=B.BrowseKeys={_handlers:{},init:function(){},init_advanced:function(){var e1,T,e0;e0=this.advanced_dict;for(T in e0){e1=e0[T];key(e1.key,ci.KEY_SCOPE,e1.onPress)}this.customize_chart();if(dQ.is_mac()&&Prototype.Browser.Gecko){return document.observe("keypress",(function(e2){return function(e3){if(e3.charCode===63&&!z.focus_in_input()){return e2.advanced_dict.help.onPress()}}})(this))}},customize_chart:function(){var e2,e0,e1,T;e2=(dQ.is_mac()?".key-windows":".key-macos");e1=0;e0=void 0;T=[];while(true){e0=$("keys-chart").down(e2,e1++);if(!e0){break}T.push(e0.hide())}return T},toggle_chart:function(){if($("keys-chart").style.display==="none"){return this.show_chart()}else{return this.hide_chart()}},show_chart:function(){var T,e0;T=$("keys-chart");T.style.position="fixed";e0=$("browse-sort");if(bZ.sparky_search_ui_enabled&&ci.in_search_mode()){e0=$("browse-header-wrapper")}else{if(e0.getStyle("display")==="none"){e0=$("browse-root-actions")}}bv(T).clonePosition(bv(e0),{setHeight:false});T.style.top=e0.cumulativeOffset()[1]+e0.getHeight()+"px";T.setOpacity(0.9);return T.show()},hide_chart:function(){return $("keys-chart").hide()},advanced_dict:{rename:{title:el("Rename selected files",{comment:"'selected' means files that have been highlighted by the user to be acted upon"}),key:"f2",onPress:function(e0,e1){var T;T=eG.get_selected_files();if(T.length){return T.first().edit()}}},"delete":{title:el("Delete selected files",{comment:"'selected' means files that have been highlighted by the user to be acted upon"}),key:"delete, command+backspace, backspace",onPress:function(e2,e3){var T,e1,e0;Event.stop(e2);if(ci.inside_read_only_shared_folder){ab.warning(el("You don't have permission to delete files in this folder."))}e0=eG.get_selected_files();if(e0.length===1){T=e0.first();if(T.is_deleted){return dn.show_purge(T.fq_path,T.dir)}else{return dn.show_delete(ci.active_user,T.fq_path,T.dir)}}else{if(e0.length>1){e1=aY.profile_files(e0);if(e1.deleted===e0.length){return dn.show_bulk_purge(e0)}else{if(e1.deleted===0){return dn.show_bulk_delete(ci.active_user,e0)}}}}}},help:{title:el("Show/hide keyboard shorcuts"),key:"shift+/, "+(key.main_modifier())+"+/",onPress:function(){return ea.toggle_chart()}},close_help:{title:el("Hide keyboard shorcuts"),key:"escape",onPress:function(){return ea.hide_chart()}},up_dir:{title:el("Up a folder",{comment:"meaning, go from the current folder to its containing (parent) folder. this is one step up only -- the parent, not the root."}),key:"left",onPress:function(){var T,e0;ci.keyboard_nav=true;if(!ci.reloading){if(ci.inside_dir){if(!ci.containing_ns_path()&&ci.containing_ns_id()!==Constants.root_ns){e0=Constants.root_ns;T=av.normalize(av.parent_dir(ci.containing_fq_path()))}else{e0=ci.containing_ns_id();T=av.normalize(av.parent_dir(ci.containing_ns_path()))}if(ci.containing_ns_path()!==T||ci.containing_ns_id()!==e0){ci.select_fq_paths=[ci.containing_fq_path()];return aX.set_path_url(e0,T)}else{return eG.flicker_selected()}}else{return eG.flicker_selected()}}}},open_file:{title:el("Open highlighted file"),key:"enter",onPress:function(){var T,e0;e0=eG.get_selected_files();if(e0.length===1){T=e0[0];ci.open_file(T,false)}return false}},open_dir:{title:el("Open highlighted folder"),key:"right",onPress:function(){var T,e0;ci.keyboard_nav=true;e0=eG.get_selected_files();if(e0.length===1){T=e0[0];if(T.dir){ci.select_index=0;ci.open_folder(T)}else{eG.flicker_selected()}}return false}},undo:{title:el("Undo recent move/copy/rename/delete"),key:""+(key.main_modifier())+"+z",onPress:function(){U.perform_undo();return false}},search:{title:el("Search"),key:"/",onPress:function(){bv(document).trigger("db:searchbar:focus");return false}}}};var ad;ad=B.BrowseSharedLink={store_shared_link_info:function(e1,T,e0){if(e1.charAt(0)==="/"){e1=e1.substring(1)}this._shared_link_fq_dir=e1;this._shared_link_file=e0;return this._shared_link_url=T},shared_link_handler:function(T,e0){if(ad._shared_link_url==="/s/"+T){aX.load_browse_view(void 0,encodeURIComponent(ad._shared_link_fq_dir));ci.open_preview(ad._shared_link_file)}else{if(ad._shared_link_url==="/sh/"+T||ad._shared_link_url==="/member_link/"+T){aX.load_browse_view(void 0,encodeURIComponent(ad._shared_link_fq_dir));if(ad._shared_link_file){ci.open_preview(ad._shared_link_file)}else{aE.init([],{include_delete:true,keep_url:true,filename_in_url:true,enable_sublinks:true,share_button_experiment_variant:ci.lightbox_share_button_experiment_variant})}}else{location.reload()}}return ad.highlight_user()},close_shared_link_view:function(){if(window.location.pathname===this._shared_link_url){return aX.set_path_url(null,"/"+this._shared_link_fq_dir)}},highlight_user:function(){if(ci.active_user.role===Constants.ROLE_WORK){bv("#work-nav-item").addClass("selected");return bv("#personal-nav-item").removeClass("selected")}else{bv("#personal-nav-item").addClass("selected");return bv("#work-nav-item").removeClass("selected")}}};var aX;aX=B.BrowseURL={_DEFAULTS:{d:false,select:false,open_preview:false},_get_helper:function(T){var e0;e0=eo.deconstruct_url().qargs;if(T in e0){return !!e0[T]}else{cz(T in this._DEFAULTS,"bad query param in BrowseURL");return this._DEFAULTS[T]}},get_del:function(){return this._get_helper("d")},ns_to_fq_path:function(T,e1){var e0;if(T!==ci.active_user.root_ns&&(!(T in ci.ns_id_to_mount_point))){T=ci.active_user.root_ns}if(T===ci.active_user.root_ns){return e1}else{e0=ci.ns_id_to_mount_point[T];return e0+e1}},_make_url:function(T,e4,e5){var e6,e3,e0,e2,e1;if(e5==null){e5={}}if(!T){T=ci.active_user.root_ns}cz(typeof T==="number","expected ns_id as a number");cz(typeof e4==="string","expected explicit ns_path string");e6=this.ns_to_fq_path(T,e4);e2=D({path:eX.get_browse_root(ci.active_user)+e6});e0=eo.deconstruct_url().qargs;for(e3 in e5){e1=e5[e3];if(e3 in this._DEFAULTS&&!!e1!==this._DEFAULTS[e3]){e0[e3]=e1}}for(e3 in e0){if(!(e3 in this._DEFAULTS)){delete e0[e3]}}return eo.construct_url(String(e2),e0)},set_path_url:function(T,e4,e2){var e3,e1,e0;if(!T){T=ci.active_user.root_ns}else{e1=parseInt(T,10);T=!isNaN(e1)?e1:Constants.root_ns}e4=av.normalize(e4);e0=e2!=null?this._make_url(T,e4,{d:e2?1:0}):this._make_url(T,e4);e3=eo.deconstruct_url(e0);return eo.push_state(e3.path,e3.qargs)},set_del_url:function(T){var e1,e2,e0;e0=eo.deconstruct_url();e1=e0.path;e2=e0.qargs;if(T){e2.d="1"}else{delete e2.d}return eo.push_state(e1,e2)},_first_load:true,_last_ns_dir:null,_last_ns_id:null,load_browse_view:function(T,e2,e0){var e3,e4,e1;if(e0==null){e0=false}key.setScope(ci.KEY_SCOPE);e2=av.normalize(e2);e1=false;if(!this._first_load){e1=(!ci.inside_dir)||(e2!==this._last_ns_dir)||(T!==this._last_ns_id)||(ci.in_search_mode()&&bZ.sparky_search_ui_enabled)}e3=e0!==ci.deleted_shown;ci.deleted_shown=e0;if(this._first_load||e1||e3){ci.reload(T,e2,true)}bZ.show_basic(true);this._first_load=false;this._last_ns_dir=e2;this._last_ns_id=T;if(eG.get_selected_files().length){e4=eG.get_selected_files()[0].get_div();if(e4){return ci.scrollToWithPadding(e4,e4.getHeight()*2)}}},history_change_handler:function(e3,e4){var e1,e2,T,e0;if(ci.show_inline_share){ci.reset_browse_exp()}T=e4.ns;e0=e4.d==="1";this.load_browse_view(T,e3,e0);if(e4.preview!=null){e2="/"+D.encode(e4.preview);if(!!e3){e2="/"+e3+e2}e1=ci.find_file(D.decode(e2));if(e1!=null){return ci.open_preview(e1,false,false,true)}else{a3.UserActivityLogger.log("web","browse_preview_does_not_exist");return eo.replace_state(eX.get_browse_root(ci.active_user))}}else{if(l.shown()){return l.hide()}}},parse_b2_hash:function(e3){var e1,e0,e2,T,e4;T=e3.split(":");if(T.length!==4){return false}e2=T[0];e1=T[2]==="1";e0=T[3];e4=!e0||dQ.isNumber(e0);if(!e4){return false}e0=parseInt(e0,10)||Constants.root_ns;return{ns_id:e0,ns_path:e2,deleted:e1}}};var cH;cH=B.BrowseFile=Class.create({initialize:function(e1){var e3,e0,e2,T,e4;e3=ci.inside_dir?c9:cb;e0=av.filename(e1.fq_path);this.icon=e1.icon;this.filename=e0;this.filename_highlights=(e2=e1.filename_highlights)!=null?e2:[];this.caption=bK.em_snippet(e0,e3);this.ns_id=e1.ns_id;this.ns_path=e1.ns_path;this.fq_path=e1.fq_path;this.mount_point=e1.mount_point;this.hash=e1.hash;this.href=e1.href;this.size=e1.size!=="None"?e1.size:"";this.bytes=e1.bytes;this.is_deleted=this.bytes===-1;this.ago=e1.ago;this.ts=e1.ts;this.dir=e1.is_dir?1:0;this.target_ns=e1.target_ns;this.sort_rank=e1.sort_rank;this.sort_key=e1.sort_key||[""];this.sjid=e1.sjid;this.tkey=void 0;this.thumbnail_url_tmpl=e1.thumbnail_url_tmpl;this.large_thumbnail_url_tmpl=e1.large_thumbnail_url_tmpl;this.type=e1.type;this.preview_type=e1.preview_type;if(e1.last_modified_fname){this.last_modified_fname=bK.em_snippet(e1.last_modified_fname,cJ)}this.htmlified_link=e1.htmlified_link;this.linkfile_link=e1.linkfile_link;this.doc_preview_status=e1.doc_preview_status;this.in_root_coll=e1.in_root_coll;this.user_id=e1.user_id;this.sf_perm_role=e1.sf_perm_role;this.fulltext_search=e1.fulltext_search;this.read_only=e1.read_only?true:false;this.is_read_only_mount=e1.is_read_only_mount?true:false;this.request_id=(T=e1.request_id)!=null?T:null;return this.match_type=(e4=e1.match_type)!=null?e4:"UNKNOWN_MATCH"},track_in_browse:function(){if(!(this.to_key() in cH._file_index)){ci.add_file(this);return cH._file_index[this.to_key()]=this}},is_shared_folder:function(){return this.type===bX.SHARED_FOLDER},could_be_shared_folder:function(){var e1,e2,T,e0;e2=ci.public_folder_enabled&&this.fq_path.toLowerCase().startsWith("/public/");e0=ci.public_folder_enabled&&this.fq_path.toLowerCase()==="/public";T=this.target_ns;e1=this.ns_id!==Constants.root_ns;return this.type===bX.FOLDER&&!T&&!e2&&!e0&&!this.is_sandbox()&&(ci.golden_gate_enabled||!e1)},is_shared_single_file:function(){var T;T=this.ns_id!==Constants.root_ns;return this.type===bX.FILE&&T},could_be_shared_single_file:function(){var e0,e1,T;e1=ci.public_folder_enabled&&this.fq_path.toLowerCase().startsWith("/public/");T=ci.public_folder_enabled&&this.fq_path.toLowerCase()==="/public";e0=this.ns_id!==Constants.root_ns;return this.type===bX.FILE&&!(e0||e1||T)},is_sandbox:function(){return this.type===bX.SANDBOX},video_transcode_url:function(){return bm.video_transcode_url(this.fq_path,this.hash,ci.active_user)},get_div:function(){return $("f_"+(this.to_key()))},rename:function(e4,e6,e2,e3,e5,e7){var e0,e8,T,e1;e0=ci.inside_dir?c9:cb;T=this.fq_path;ci.pre_action_selection=[T];e8=ci.find_file(e4);if(e8){ci.remove_file(e8)}this.filename=av.filename(e4);this.caption=bK.em_snippet(this.filename,e0);this.fq_path=e4;this.ns_path=e6;this.htmlified_link=e7;this.hash=e2;this.sort_key=e3;this.sort_rank=null;this.last_modified_fname=null;if(!this.dir){e1=this.href.split("/");e1[e1.length-1]=dQ.urlquote(this.filename)+("?w="+e2);this.href=e1.join("/");this.icon=e5}else{this.href="/home"+dQ.urlquote(e4);if(this.target_ns){ci.ns_id_to_mount_point[this.target_ns]=e4}}if(ci.in_search_mode()&&bZ.sparky_search_ui_enabled){this.filename_highlights=[]}cH._file_index[this.to_key()]=this;ci.update_file_pos(this);return bv(document).trigger(aC.RENAME,{old_fq_path:T,file:this})},edit:function(){var e1,T,e2,e0,e3;this.editing=true;ci.selectable();e3=(function(e4){return function(fc){var e6,e5,e9,fe,fb,e8,ff,fd,fa,e7;e7=fc.responseText.evalJSON(true);cz(e7.new_browse_files.length===1,"No new file data returned.");e9=e7.new_browse_files.first();fe=e9.fq_path;fb=e9.hash;fa=dQ.decode_sort_key(e9.sort_key);ff=e9.icon;fd=e9.ns_path;e8=e9.htmlified_link;e6=e7.changesets;e5=el("Rename complete.");U.notifyWithUndo(e5,e6,dn.do_rollback);e4.rename(fe,fd,fb,fa,ff,e8);eG.set_selected_files([e4]);e4.get_div().smoothScrollIntoView();aY.load_visible_thumbs();return ci.fire_visible_change_callbacks()}})(this);T=D({path:"/cmd/rename"+this.fq_path}).updateQuery(Constants.UID_PARAM_NAME,ci.active_user).toString();e2=bZ.sparky_search_ui_enabled&&ci.in_search_mode()?".filename-col":".filename-col a";e1=new Ajax.InPlaceEditor(this.get_div().down(e2),T,{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:25,ajaxClass:Ajax.DBRequest,submitOnBlur:true,initialText:this.filename,cancelIfSame:true,clickToEdit:false,onComplete:(function(e4){return function(){return e4.editing=false}})(this),onFailure:function(){},savingText:el("Saving..."),ajaxOptions:{job:true,subject_user:ci.active_user,html_in_error_msg:true,progress_text:el("Renaming..."),method:"POST",onCreate:ab.clear,onSuccess:e3,onUninitialized:ci.unselectable},callback:(function(e4){return function(e5,e6){return{to_path:e6||"",folder:(e4.dir?"yes":"")}}})(this)});e1.enterEditMode();e0=this.get_div().down(".editor_field");if("selectionEnd" in e0&&this.filename.lastIndexOf(".")>-1){return e0.selectionEnd=this.filename.lastIndexOf(".")}},to_key:function(){return""+this.ns_id+"_"+this.sjid},get_category:function(){var e0,T;if(this.dir){if(ci.inside_dir&&ci.containing_fq_path()===""){if(this.filename.toLowerCase()==="public"&&ci.public_folder_enabled){e0="PUBLIC_FOLDER"}}if(e0==null){if(this.type===bX.FOLDER){e0="FOLDER"}else{if(this.type===bX.PACKAGE){e0="FOLDER"}else{if(this.type===bX.TEAM_SHARED_FOLDER){e0="TEAM_SHARED_FOLDER"}else{if(this.type===bX.SHARED_FOLDER){e0="SHARED_FOLDER"}else{if(this.type===bX.SANDBOX){e0="SANDBOX"}else{if(this.target_ns){e0="SHARED_FOLDER"}else{e0="FOLDER"}}}}}}}}if(e0==null){e0=cH.EXTENSION_TO_CATEGORY[this.get_extension()]||"FILE"}T=this.is_deleted?cH.CATEGORY_TO_DELETED_TRANSLATION[e0]:cH.CATEGORY_TO_TRANSLATION[e0];cz(T,"CATEGORY MISSING FOR "+e0);return T},get_extension:function(){if(this.dir||this.filename.indexOf(".")===-1){return}return av.file_extension(this.filename).toLowerCase()},is_shmodelable:function(){return !this.is_deleted&&ci.is_shmodelable_path(this.fq_path)}});cH._CATEGORIES={IMAGE:"bmp cr2 gif ico jpeg jpg nef png psd tif tiff svg svgz",VIDEO:"3gp 3gpp 3gpp2 avi dv flv m2t m4v mkv mov mp4 mpeg mpg mts ts vob wmv",AUDIO:"aif flac m4a m4p mp3 ogg wav wma",DOCUMENT:"ai cdr csv dbxlink doc docx docm eps fla indd keynote numbers otf pages pdf ppt pptx pptm pps ppsx ppsm ps rtf swf txt wpd xls xlsx xlsm",COMPRESSED_FILE:"7z bz2 gz gzip rar tar zip",CODE:"as as3 c coffee cpp cs css cxx h html html java js less php py rb sass scss sh sql vb xhtml xml",DISK_IMAGE:"dmg iso",EXECUTABLE:"exe",SHORTCUT:"lnk",LINK:"url webloc",FONT:"ttf"};cH.EXTENSION_TO_CATEGORY={};cH.CATEGORY_TO_TRANSLATION={FILE:el("file"),FOLDER:el("folder"),SHARED_FOLDER:el("shared folder"),TEAM_SHARED_FOLDER:el("team folder"),PUBLIC_FOLDER:el("folder"),IMAGE:el("image"),VIDEO:el("video"),AUDIO:el("audio"),DOCUMENT:el("document"),COMPRESSED_FILE:el("archive"),CODE:el("code"),DISK_IMAGE:el("disk image"),EXECUTABLE:el("executable"),SHORTCUT:el("shortcut"),LINK:el("link"),FONT:el("font"),SANDBOX:el("app folder")};cH.CATEGORY_TO_DELETED_TRANSLATION={FILE:el("deleted file"),FOLDER:el("deleted folder"),SHARED_FOLDER:el("deleted shared folder"),TEAM_SHARED_FOLDER:el("deleted team folder"),PUBLIC_FOLDER:el("deleted folder"),IMAGE:el("deleted image"),VIDEO:el("deleted video"),AUDIO:el("deleted audio"),DOCUMENT:el("deleted document"),COMPRESSED_FILE:el("deleted archive"),CODE:el("deleted code"),DISK_IMAGE:el("deleted disk image"),EXECUTABLE:el("deleted executable"),SHORTCUT:el("deleted shortcut"),LINK:el("deleted link"),FONT:el("deleted font"),SANDBOX:el("deleted app folder")};(function(){var e1,e3,e0,e2,T;e2=cH._CATEGORIES;T=[];for(e1 in e2){e0=e2[e1];T.push((function(){var e7,e5,e4,e6;e4=e0.trim().split(" ");e6=[];for(e7=0,e5=e4.length;e7<e5;e7++){e3=e4[e7];e6.push(cH.EXTENSION_TO_CATEGORY[e3]=e1)}return e6})())}return T})();cH._file_index={};cH.from_key=function(T){return cH._file_index[T]};cH.from_elem=function(e0){var T;if(!e0){return}T=e0.readAttribute("data-identity");if(T){return cH.from_key(T)}else{return cH.from_elem(e0.up("[data-identity]"))}};var a,er,ae,eQ,bE,ds;a=INLINE_JS.BrowseActions=B.BrowseActions=Class.create({initialize:function(T){return this._set_files(T)},firefly_logging_helper:function(T){if(ci.in_search_mode()&&T){this._firefly_log_values.action_type=T;return a3.SearchClientActivityLogger.log("result_action",ci.active_user.id,this._firefly_log_values)}},unlisten:function(){},get_action_names:function(){var T;T=this.get_files();if(T.length<2){return this._get_actions_single(T.first())}else{return this._get_actions_multi(T)}},get_files:function(){return this._files},get_action_by_name:function(T){return this.evaluate_action(a.option_dict[T],T)},evaluate_action:function(e1,e0){var e2,e3,T;e2=(function(e4){return function(e6,e5){if((e5!=null)&&(e6==null)){return e5}if(bv.isFunction(e6)){return e6.call(e4)}else{if(e6!=null){return e6}else{return e5}}}})(this);T={icon_href:e1.icon_href,target:e1.target,click_handler:e1.click_handler,type:e1.type,name:e0||e1.name,is_dropdown:!!e1.is_dropdown,icon:e2(e1.icon),text:e2(e1.text),detail_text:e2(e1.detail_text),href:e2(e1.href,""),kind:e2(e1.kind,"icon"),button_label:e2(e1.button_label,e1.text)};if(bv.isFunction(e1.subactions)){T.subactions=e1.subactions.call(this)}else{if(bv.isArray(e1.subactions)){T.subactions=(function(){var e7,e5,e6,e4;e6=e1.subactions;e4=[];for(e7=0,e5=e6.length;e7<e5;e7++){e3=e6[e7];e4.push(this.get_action_by_name(e3))}return e4}).call(this)}else{if(e1.subactions){cz(0,"subactions must be a function or an array of actions")}}}return T},_set_files:function(e0){var T;this._files=$A(e0);this._log_extras={};if(this.get_files().length>0){T=e0.first();this._log_extras={path:T.fq_path,ns_id:T.ns_id};return this._firefly_log_values={file_nsid:T.ns_id,file_sjid:T.sjid,firefly:bZ.firefly_enabled,match_type:T.match_type,position:T.sort_rank,request_id:T.request_id,viewport:"full-view"}}},_get_actions_single:function(ff){var e5,e8,e9,fc,e1,e2,fh,e6,fb,e3,e4,fd,fe,fa,T,fg,e7,e0;e8=[];if(!ff){return[]}fc=ci.public_folder_enabled&&ff.fq_path.toLowerCase().startsWith("/public/");fb=ci.public_folder_enabled&&ff.fq_path.toLowerCase()==="/public";fh=ff.target_ns;e9=ff.ns_id!==Constants.root_ns;e4=ff.type===bX.SHARED_FOLDER;e3=ff.type===bX.SANDBOX;e6=ff.type===bX.PACKAGE;e2=ff.in_root_coll;if(ff.is_deleted){e8=e8.concat(["restore"]);e8.push("purge");if(!ff.dir){e8.push("revisions")}}else{fa=(__CONDITIONAL_JS__.UnityFeatures!=null)&&((e7=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?e7.is_cached_and_locally_available(ff.ns_id,ff.ns_path):void 0);fd=fa?"open":"download";if(ff.dir){if(e3){e8.push("app_info")}else{if(ci.simple_sharing_enabled){e8.push("share_folder_and_token")}else{if(e4){e8.push("sharing_options")}else{if(!(e9||fh||fc||fb)){e8.push("share")}}}}if(ff.is_shmodelable()&&!ci.simple_sharing_enabled){e8.push("token_share")}e8.push(fd);if(!fb){e8=e8.concat(["delete","rename","move"]);if(!(e6||fh)){e8.push("copy")}}if(ci.can_use_photos_features){if(ci.can_use_photos_features){e8.push("album_from_folder")}}}else{if(ff.is_shmodelable()){e8.push("token_share")}if(fc||ci.public_app_token){e8.push("copy_url")}e8.push(fd);if(ci.can_show_preview(ff)&&ci.browser_supports_comments){e8.push("comment")}e8=e8.concat(["delete","rename","move","copy","revisions"]);if(e2&&ci.can_use_photos_features){if(ci.photos_experience==="carousel"){e8.push("view_in_carousel")}else{e8.push("view_in_photos")}}}if(!ci.simple_sharing_enabled){fe=false;e0=["sharing_options","share","token_share"];for(T=0,fg=e0.length;T<fg;T++){e5=e0[T];e1=e8.indexOf(e5);if(e1>-1){e8.splice(e1,1);fe=true}}if(ff.is_shared_folder()||ff.could_be_shared_folder()){e8.unshift("single_entry_share_dropdown_variant_menu")}else{e8.unshift("single_entry_share_dropdown_variant_token_share_only")}}}return e8},_get_actions_multi:function(e1){var T,e0,e2;if(Constants.send_a_copy_enabled){T=["send_copy","download"]}else{T=["download"]}T=T.concat(["delete","move","copy","restore","purge"]);if(ci.photos_experience==="carousel"){T.push("view_in_carousel")}else{T.push("view_in_photos")}e0=aY.profile_files(e1);if(e0.deleted>0||e0.public_folder>0){T.removeItem("move");T.removeItem("copy");T.removeItem("delete")}if(e0.shared_folders>0){T.removeItem("copy")}if(e0.deleted>0){T.removeItem("send_copy");T.removeItem("delete");T.removeItem("download")}if(!ci.inside_dir){T.removeItem("download")}if(!(e0.deleted===e1.length&&(e0.shared_folders===0||((e0.shared_folders===(e2=e1.length)&&e2===1))))){T.removeItem("restore");if(e0.deleted!==e1.length){T.removeItem("purge")}}if(e0.in_root_coll!==e1.length||!ci.can_use_photos_features){T.removeItem("view_in_photos");T.removeItem("view_in_carousel")}return T},_show_appropriate_sharing_modals:function(e0,T){var e1;if(ci.simple_sharing_enabled&&e0.dir){if(dP.get_for_user(ci.active_user).verified_or_show()){eq.createAndShowInbandModalFromBrowseFile(ci.active_user,e0)}return}if(e0.is_shared_folder()){a3.ShmodelUILogger.log_with_target_file("sf_options",T,e0);return p.show_shared_folder_options_modal(e0.fq_path,ci.active_user)}else{if(e0.could_be_shared_folder()){a3.ShmodelUILogger.log_with_target_file("sf_invite",T,e0);return p.show_share_existing_modal(e0.fq_path,ci.active_user)}else{a3.ShmodelUILogger.log_with_target_file("token_share",T,e0);e1=e0.fq_path;cz(e1,"token_share: expected non-root fq_path");return dh.shmodel(e1,T+"_token_share")}}},get_disabled_action_names:function(){var T,e1,e3,e0,e2;T=false;e2=this.get_files();for(e3=0,e0=e2.length;e3<e0;e3++){e1=e2[e3];T=true;if(!e1.read_only){T=false;break}}if(ci.inside_read_only_shared_folder||T){return["move","rename","delete","restore","purge","upload","new_folder"]}else{return[]}},show_disabled_action_warning:function(T){if(ci.inside_read_only_shared_folder){if(T==="move"){return ab.warning(el("You don't have permission to move files in this folder."))}else{if(T==="rename"){return ab.warning(el("You don't have permission to rename files in this folder."))}else{if(T==="delete"){return ab.warning(el("You don't have permission to delete files in this folder."))}else{if(T==="restore"){return ab.warning(el("You don't have permission to restore files in this folder."))}else{if(T==="purge"){return ab.warning(el("You don't have permission to permanently delete files in this folder."))}else{if(T==="upload"){return ab.warning(el("You don't have permission to upload files into this folder."))}else{if(T==="new_folder"){return ab.warning(el("You don't have permission to create a new folder in this folder."))}else{return ab.warning(el("You only have permission to view this folder."))}}}}}}}}else{return ab.warning(el("You do not have permission to perform the requested action."))}}});Object.extend(a,{PUBLIC_FOLDER_PATH_LENGTH:7,showCopyPublicUrlModal:function(e0){var T,e1;eS.show(aY.append_ellipsis(el("Copy public link")),de.fromElm("copy-public-url"),{wit_group:"copy_public_link"});eS.onHide=function(){$("flash_copy_container").remove();delete eS.onHide;return eS.hide()};T=q.clipboard_overlay(e0,bv("#real_copy"),function(){ab.success(el("Link copied to clipboard!"));return eS.hide()});T.css({zIndex:1001});e1=$("modal-content").down("#public_url");cz(e1,"Text element not found for copy pulic link");e1.setValue(e0);return e1.select()},shortenPublicLink:function(){var T;dQ.shorten_url($F("public_url"),a.updatePublicLink);T=new Element("img",{id:"publink_loading",src:"/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif",className:"right"});return $("modal-content").down("a").__date(T)},updatePublicLink:function(e0){var T;$("public_url").setValue(e0);$("public_url").select();$("publink_loading").remove();$("flash_copy_container").remove();T=q.clipboard_overlay(e0,bv("#real_copy"),function(){ab.success(el("Link copied to clipboard!"));return eS.hide()});return T.css({zIndex:1001})},option_dict:{new_folder:{icon:"folder_add",text:el("New folder"),click_handler:function(T){return ci.new_folder()}},global_restore:{icon:"restore",text:function(){cz(ci.inside_deleted_dir,"Global restore from not a deleted dir");if(ci.inside_deleted_shared_folder){return aY.append_ellipsis(el("Rejoin shared folder"))}else{if(ci.inside_deleted_sandbox){return el("Restore app folder")}else{return el("Restore folder")}}},click_handler:function(){var e2,e3,e0,T,e1;e2=ci.containing_fq_path();e0=e2.toLowerCase();if(ci.inside_deleted_sandbox){cz(ci.old_path_to_ns_id[e0],"Deleted sandbox missing nsid");return a9.restore_sandbox(ci.active_user,e2,ci.old_path_to_ns_id[e0])}else{if(ci.inside_deleted_shared_folder){cz(ci.old_path_to_ns_id[e0],"Deleted shared folder missing nsid");return p.show_rejoin_modal(ci.active_user,e2,ci.old_path_to_ns_id[e0])}else{e3=D.parse(location.href).setFragment("").toString();T={prev:e3};T[Constants.UID_PARAM_NAME]=ci.active_user;e1=D({path:"/restore"+e2}).updateQuery(T);return window.location.href=String(e1)}}}},restore:{icon:"restore",text:function(){var e0,T;e0=this.get_files();T=aY.profile_files(e0);if(T.shared_folders===e0.length){return aY.append_ellipsis(a4("Rejoin shared folder","Rejoin shared folders",e0.length,{comment:"BUTTON"}))}else{return aY.append_ellipsis(el("Restore",{comment:"Restore a previously-deleted file"}))}},click_handler:function(){var e1,e4,e0,e5,e3,T,e2;e4=this.get_files();if(e4.length===0){}else{if(e4.length===1){e1=e4.first();if(!e1.is_deleted){return}e5=e1.fq_path;e0=e5.toLowerCase();if(e1.type===bX.SANDBOX){cz(ci.old_path_to_ns_id[e0],"Restore missing ns");a9.restore_sandbox(ci.active_user,e5,ci.old_path_to_ns_id[e0])}else{if(e1.type===bX.SHARED_FOLDER){cz(ci.old_path_to_ns_id[e0],"Rejoin missing ns");p.show_rejoin_modal(ci.active_user,e5,ci.old_path_to_ns_id[e0])}else{if(e1.dir){e3=D.parse(location.href).updateQuery({select:e1.filename});T={prev:String(e3)};T[Constants.UID_PARAM_NAME]=ci.active_user;e2=D({path:"/restore"+e1.fq_path}).updateQuery(T);window.location=String(e2)}else{dn.show_undelete(e1)}}}}else{return dn.show_bulk_restore(e4,ci.active_user)}}}},global_share:{icon:function(){return aY.get_shared_folder_icon()},text:function(){if(ci.inside_shared_folder){return aY.append_ellipsis(el("Shared folder options",{comment:"BUTTON. please keep this as short as possible."}))}else{if(ci.containing_fq_path()===""){return aY.append_ellipsis(el("Share a folder",{comment:"BUTTON. this initiates a wizard that lets the user select a folder to share."}))}else{return aY.append_ellipsis(el("Share this folder",{comment:"BUTTON. this button lets the user share the current folder that they're viewing."}))}}},click_handler:function(e1){var e0,T;e1.preventDefault();if(ci.containing_fq_path()===""){return p.start_wizard_for_user(ci.active_user)}else{if(ci.simple_sharing_enabled){e0=ci.inside_shared_folder&&!ci.containing_ns_path();T=e0?ci.containing_ns_id():void 0;return eq.createAndShowInbandModal(ci.active_user,ci.containing_fq_path(),true,T,e0,!ci.inside_shared_folder,ci.containing_sf_perm_role())}else{if(ci.inside_shared_folder){return p.show_shared_folder_options_modal(ci.containing_mount_point(),ci.active_user)}else{return p.show_share_existing_modal(ci.containing_fq_path(),ci.active_user)}}}}},global_share_button:{icon:"rainbow_16",kind:"button",button_label:el("Share"),text:function(){return aY.append_ellipsis(el("Share a folder"))},click_handler:function(e0,T){e0.preventDefault();if(ci.containing_fq_path()===""){return p.start_wizard_for_user(ci.active_user)}else{if(ci.is_in_subfolder_of_shared_folder()){a3.ShmodelUILogger.log("via-single-entry-sharing-button");return dh.shmodel(ci.containing_fq_path(),T+"_global_share_button")}else{return p.show_shmodel_or_invite_modal(ci.containing_fq_path(),ci.inside_shared_folder,ci.active_user)}}}},sharing_options:{icon:function(){return aY.get_shared_folder_icon()},text:aY.append_ellipsis(el("Shared folder options",{comment:"BUTTON"})),click_handler:function(e1,T){var e0;e0=this.get_files().first();a3.ShmodelUILogger.log_with_target_file("sf_options",T,e0);return p.show_shared_folder_options_modal(e0.fq_path,ci.active_user)}},share:{icon:function(){return aY.get_shared_folder_icon()},text:aY.append_ellipsis(el("Invite to folder",{comment:"BUTTON"})),click_handler:function(e1,T){var e0;e0=this.get_files().first();a3.ShmodelUILogger.log_with_target_file("sf_invite",T,e0);return p.show_share_existing_modal(e0.fq_path,ci.active_user)}},share_folder_and_token:{icon:function(){return aY.get_shared_folder_icon()},text:aY.append_ellipsis(el("Share",{comment:"BUTTON"})),click_handler:function(e1,T){var e0;e0=this.get_files().first();return this._show_appropriate_sharing_modals(e0,T)}},revisions:{icon:"s_clock",click_handler:function(){return window.location.href=dn.build_revisions_uri(this.get_files().first().fq_path,ci.active_user)},text:el("Previous versions",{comment:"BUTTON"})},token_share:{icon:function(){return aY.get_shared_link_icon()},text:aY.append_ellipsis(el("Share link",{comment:"BUTTON"})),click_handler:function(e2,T){var e0,e1;e0=this.get_files().first();a3.ShmodelUILogger.log_with_target_file("token_share",T,e0);e1=e0.fq_path;cz(e1,"token_share: expected non-root fq_path");return dh.shmodel(e1,T+"_token_share")}},global_token_share:{icon:function(){return aY.get_shared_link_icon()},text:aY.append_ellipsis(el("Share link",{comment:"BUTTON"})),click_handler:function(e0,T){a3.ShmodelUILogger.log("via-global-toolbar");return dh.shmodel(ci.containing_fq_path(),T+"_global_token_share")}},copy_url:{icon:"world_link",text:aY.append_ellipsis(el("Copy public link",{comment:"BUTTON"})),click_handler:function(e1){var e0,T;e0=this.get_files().first();if(ci.public_app_token){T="/spa/"+ci.public_app_token+e0.ns_path}else{T="/u/"+ci.active_user.id+e0.fq_path.substring(a.PUBLIC_FOLDER_PATH_LENGTH)}return a.showCopyPublicUrlModal(String(new D({scheme:"https",authority:Constants.PUBSERVER,path:T})))}},download:{icon:"download",text:function(){return el("Download",{comment:"BUTTON"})},click_handler:function(){var e2,e1,T,e5,e7,e6,e3,e0,e4;T=this.get_files();if(T.length===1&&!T[0].dir){e1=T.first();e4=[Constants.protocol,Constants.BLOCK_CLUSTER,e1.fq_path,e1.hash],e6=e4[0],e2=e4[1],e7=e4[2],e5=e4[3];e3={w:e5,dl:1};e0=D({scheme:e6,authority:e2,path:"/get"+e7,query:e3});return window.location=String(e0.updateQuery(Constants.UID_PARAM_NAME,ci.active_user))}else{return dn.do_bulk_download(T)}}},view:{href:function(){var e4,T,e2,e1,e3,e0;T=this.get_files().first();e0=[Constants.protocol,Constants.BLOCK_CLUSTER,dQ.urlquote(T.fq_path),T.hash],e3=e0[0],e4=e0[1],e1=e0[2],e2=e0[3];return""+e3+"://"+e4+"/get"+e1+"?w="+e2},icon:"page_white_magnify",text:el("View file",{comment:"BUTTON"})},ignore:{click_handler:function(){return p.show_ignore_modal(this.get_files().first().fq_path)},icon:"folder_user_delete",text:el("Permanently remove",{comment:"BUTTON"})},show_del:{click_handler:function(T){return ci.toggle_deleted()},icon:"trash-can",text:el("Show deleted files",{comment:"BUTTON"})},hide_del:{click_handler:function(T){return ci.toggle_deleted()},icon:"trash-can-open",text:el("Hide deleted files",{comment:"BUTTON"})},copy:{icon:"copy",text:aY.append_ellipsis(el("Copy",{comment:"BUTTON"})),click_handler:function(e1){var T,e0;e0=this.get_files();if(e0.length===1){T=e0.first();return dn.show_copy(T.fq_path,T.dir)}else{if(e0.length>1){return dn.show_copy_bulk(e0)}}}},move:{icon:"move_16",text:aY.append_ellipsis(el("Move",{comment:"BUTTON"})),click_handler:function(e1){var T,e0;e0=this.get_files();if(e0.length===1){T=e0.first();return dn.show_move(T.fq_path,T.dir)}else{if(e0.length>1){return dn.show_move_bulk(e0)}}}},rename:{icon:"rename",text:el("Rename",{comment:"BUTTON"}),click_handler:function(){return this.get_files().first().edit()}},"delete":{icon:"delete_16",text:aY.append_ellipsis(el("Delete",{comment:"BUTTON"})),click_handler:function(e1){var T,e0;e0=this.get_files();if(e0.length>1){return dn.show_bulk_delete(ci.active_user,e0)}else{if(e0.length===1){T=e0.first();return dn.show_delete(ci.active_user,T.fq_path,T.dir)}}}},global_purge:{icon:"cancel",text:aY.append_ellipsis(el("Permanently delete folder")),click_handler:function(){return dn.show_purge(ci.containing_fq_path(),true)}},purge:{icon:"cancel",text:aY.append_ellipsis(el("Permanently delete",{comment:"BUTTON"})),click_handler:function(e1){var T,e0;e0=this.get_files();if(e0.length===1){T=e0.first();return dn.show_purge(T.fq_path,T.dir)}else{return dn.show_bulk_purge(e0)}}},upload:{icon:"upload_16",text:aY.append_ellipsis(el("Upload")),click_handler:function(T){return dn.show_upload()}},app_info:{icon:"application_double",text:aY.append_ellipsis(el("Application info")),click_handler:function(T){return window.location.href="/account/security"}},more_actions:{is_dropdown:true,text:el("More",{comment:"Show more options"}),click_handler:Prototype.emptyFunction},more_global_actions:{text:el("More actions"),click_handler:function(){bE.show_secondary();return document.body.observe("click",bE.hide_secondary)}},view_in_photos:{icon:"s_photo",text:function(){return el("View in Photos")},click_handler:function(){var T;T=this.get_files();return dn.do_bulk_photo_view(T,ci.photos_experience)}},view_in_carousel:{icon:"s_carousel",text:function(){return el("View in Timeline")},click_handler:function(){var T;T=this.get_files();return dn.do_bulk_photo_view(T,"carousel")}},album_from_folder:{icon:"create-album",text:function(){return el("Create album")},click_handler:function(){var e0,T;e0=this.get_files();T=e0.first();return dn.create_album_from_folder(T.fq_path,T.filename)}},open:{icon:"open",text:function(){return el("Open")},click_handler:function(){var T;T=this.get_files().first();return __CONDITIONAL_JS__.UnityFeatures.open_file(T.ns_id,T.ns_path,T.user_id,__CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler,function(e0){return __CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler(false)})}},comment:{icon:"s_file_comment",text:function(){return el("Comment",{comment:"BUTTON"})},click_handler:function(){var T;T=this.get_files().first();return ci.open_preview(T,true,false,false,true)}},single_entry_share_dropdown_variant_token_share_only:{icon:"s_rainbow",text:aY.append_ellipsis(el("Share")),click_handler:function(e1,T){var e0;e0=this.get_files().first();a3.ShmodelUILogger.log_with_target_file("single_entry_share_click",T,e0);return dh.shmodel(e0.fq_path,T)}},single_entry_share_dropdown_variant_menu:{icon:"s_rainbow",text:aY.append_ellipsis(el("Share")),is_dropdown:true,subactions:["single_entry_share_dropdown_variant_menu_invite_option","single_entry_share_dropdown_variant_menu_token_share_option"],click_handler:function(){},hover_handler:function(e1,T){var e0;e0=this.get_files().first();return a3.ShmodelUILogger.log_with_target_file("single_entry_share_hover",T,e0)}},single_entry_share_dropdown_variant_menu_invite_option:{icon:"user_add",text:aY.append_ellipsis(el("Invite people to collaborate")),click_handler:function(e4,T){var e1,e2,e3,e0;e1=this.get_files().first();if(e1.is_shared_folder()){if(dP.get_for_user(ci.active_user).verified_or_show()){a3.ShmodelUILogger.log_with_target_file("sf_options",T,e1);e2=new c2(ci.active_user,e1.fq_path);return e2.show()}}else{e0=ci.verify_email_after_share_experiment_variant;e3=e0&&e0==="VERIFY_LAST";if(e3){a3.UserActivityLogger.log("web","email_verify_last_experiment_shown")}else{if(e0){a3.UserActivityLogger.log("web","email_verify_last_experiment_not_shown")}}if(e3||dP.get_for_user(ci.active_user).verified_or_show()){a3.ShmodelUILogger.log_with_target_file("sf_invite",T,e1);e2=new ce(ci.active_user,{folder_name:e1.fq_path,element_id:"invite-to-new-sf-wizard-modal-"+ci.active_user.id,must_check_verified:e3});return e2.show()}}}},single_entry_share_dropdown_variant_menu_token_share_option:{icon:"s_link",text:aY.append_ellipsis(el("Send link")),click_handler:function(e1,T){var e0;e0=this.get_files().first();a3.ShmodelUILogger.log_with_target_file("token_share",T,e0);return dh.shmodel(e0.fq_path,T)}}}});ae=B.BrowseActionsContext=Class.create(a,{initialize:function($super,T){$super(T);return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");bv("#context-menu-container").off("mouseenter");$("context-menu-container").on("click",".action button",this._click.bind(this));$("context-menu-container").on("contextmenu",".action button",this._click.bind(this));bv("#context-menu-container").on("mouseover","li.primary",this._over.bind(this));bv("#context-menu-container").on("mouseout","li.primary",this._out.bind(this));return bv("#context-menu-container").on("mouseenter",".action button",this._enter.bind(this))},_click:function(e2,e0){var e1,T;e1=e0.readAttribute("data-value");this.firefly_logging_helper(e1);T=a.option_dict[e1];a3.BrowseActionsContextMenuLogger.log(this.get_files(),e1);if(!T.is_dropdown||e0.hasAttribute("submenu-index")){bg.hide()}e2.preventDefault();T.click_handler.call(this,e2,"browse_actions_context");if(e1==="sharing_options"){a3.SharedFolderActivityLogger.log("web","browse_view_options",ci.active_user,this._log_extra,true)}if(e1==="share"){return a3.SharedFolderActivityLogger.log("web","browse_view_share_existing",ci.active_user,this._log_extras,true)}},_reset_all_submenus:function(){return bv("#context-menu-container .hover").removeClass("hover")},_reset_submenu:function(T){return bv(T).removeClass("hover")},_enter:function(e2){var e1,T,e0;e1=bv(e2.currentTarget).data("value");cz(e1);T=a.option_dict[e1];cz(T,"Action info is missing for "+e1);return(e0=T.hover_handler)!=null?e0.call(this,e2,"browse_actions_context"):void 0},_over:function(T){if(bv(T.currentTarget).children(".secondary").length){clearTimeout(this.timeoutID);this._reset_all_submenus();return bv(T.currentTarget).addClass("hover")}},_out:function(T){if(bv(T.currentTarget).children(".secondary").length){return this.timeoutID=setTimeout((function(e0){return function(){return e0._reset_submenu(T.currentTarget)}})(this),300)}}});er=B.BrowseActionsBasic=Class.create(a,{initialize:function($super){var T;T=eG.get_selected_files();$super(T);this._render();return this._listen()},_listen:function(){var T;this.bound_update=this._update.bind(this);this.bound_disable=this._disable.bind(this);this.bound_enable=this._enable.bind(this);this.bound_click=this._click.bind(this);document.observe(eG.UPDATED_EVT,this.bound_update);document.observe(bg.SHOW_EVT,this.bound_disable);document.observe(bg.HIDE_EVT,this.bound_enable);T=$("browse-root-actions");T.stopObserving("click");return T.on("click",".action button",this.bound_click)},unlisten:function(){document.stopObserving(eG.UPDATED_EVT,this.bound_update);document.stopObserving(bg.SHOW_EVT,this.bound_disable);document.stopObserving(bg.HIDE_EVT,this.bound_enable);return $("browse-root-actions").stopObserving("click",this.bound_click)},_update:function(){this._set_files(eG.get_selected_files());return this._render()},_disable:function(){$("browse-root-actions").stopObserving("click");if($("browse-root-actions").down(".secondary")){$("browse-root-actions").down(".secondary").addClassName("disabled")}return $$("#browse-root-actions .action *").invoke("setStyle",{cursor:"default"})},_disable_action:function(e1){var e0,T;T="#browse-root-actions #"+e1+"_action_button";e0=bv(T);e0.addClass("disabled");return e0.click((function(e2){return function(e3){e2.show_disabled_action_warning(e1);return false}})(this))},_enable:function(){$("browse-root-actions").stopObserving("click");$("browse-root-actions").on("click",".action button",this._click.bind(this));if($("browse-root-actions").down(".secondary")){$("browse-root-actions").down(".secondary").removeClassName("disabled")}return $$("#browse-root-actions .action *").invoke("setStyle",{cursor:"pointer"})},_render:function(){var fq,fj,fl,fb,fn,fr,ft,fi,fk,fe,T,e7,e8,fa,e9,fm,e6,fu,fg,e4,fd,fc,ff,fh,e5,e3,e1,e0,fo,fs,fp,e2;e7=this.get_files();fl=this.get_action_names();if(!ci.simple_sharing_enabled){fc=["single_entry_share_dropdown_variant_token_share_only","single_entry_share_dropdown_variant_menu"];for(e3=0,fo=fc.length;e3<fo;e3++){fj=fc[e3];e9=fl.indexOf(fj);if(e9>-1){fl.splice(e9,1);break}}}fq=13.5;fk="";e8="";if(e7.length===1){fk=bK.em_snippet(e7[0].filename,fq);if(!e7[0].dir&&e7[0].bytes>=0){e8=e7[0].size}}else{if(1<e7.length){e4=aY.profile_files(e7);fm=[];if(e4.files){e6=a4("%d file","%d files",e4.files).format(e4.files);fm.push(e6)}if(e4.folders){e6=a4("%d folder","%d folders",e4.folders).format(e4.folders);fm.push(e6)}fk=dQ.nice_list(fm)}}fr=$("browse-root-actions");fn=fr.getLayout().get("width");fa=fr.getStyle("font-size");cz(fa.endsWith("px"),"Invalid font size "+fa);fa=parseInt(fa,10);fe=new bK(fk).length*fa;ff=new bK(e8).length*fa;fn-=fe+ff;fh=[];fd=[];fn-=30;for(e1=0,fs=fl.length;e1<fs;e1++){fu=fl[e1];fj=this.get_action_by_name(fu);e5=new bK(fj.text).length*fa;ft=e5+16+8+10+9;if(fn>ft){fh.push(fu)}else{if(fd.length===0){fg=fh.pop();fd.push(fg)}fd.push(fu)}fn-=ft}if(fd.length){fh.push("more_actions")}fb=(function(){var fx,fv,fw;fw=[];for(fx=0,fv=fh.length;fx<fv;fx++){fu=fh[fx];fw.push(this.get_action_by_name(fu))}return fw}).call(this);if(fd.length){fb[fb.length-1].subactions=(function(){var fx,fv,fw;fw=[];for(fx=0,fv=fd.length;fx<fv;fx++){fu=fd[fx];fw.push(this.get_action_by_name(fu))}return fw}).call(this)}fi=eV.tmpl("actions_bar_tmpl",{context:this,description:fk,filesize:e8,has_actions:!!fl.length,actions:fb,_:el,Sprite:cm});$("browse-root-actions").__date(fi);T=this.get_disabled_action_names();e2=[];for(e0=0,fp=T.length;e0<fp;e0++){fj=T[e0];e2.push(this._disable_action(fj))}return e2},_click:function(e2,e0){var e1,T;e1=e0.readAttribute("data-value");cz(e1);this.firefly_logging_helper(e1);T=a.option_dict[e1];cz(T,"Action info is missing for "+e1);e2.preventDefault();T.click_handler.call(this,e2,"browse_actions_basic");if(e1==="sharing_options"){a3.SharedFolderActivityLogger.log("web","browse_view_select_folder_options",ci.active_user,this._log_extras,true)}if(e1==="share"){return a3.SharedFolderActivityLogger.log("web","browse_view_select_share_existing",ci.active_user,this._log_extras,true)}}});Object.extend(er,{STANDARD_ACTIONS:["share","sharing_options","app_info","token_share","copy_url","download","delete","rename","restore","purge","view_in_photos","view_in_carousel"]});eQ=B.GlobalActions=Class.create(a,{initialize:function($super){return $super()},get_action_names:function(){var T;if(!ci.inside_dir){return[]}T=[];if(!ci.inside_deleted_dir){T=T.concat(["upload","new_folder"]);if(this._should_show_shared_folder_options()){T.push("global_share")}if(this._should_show_share_link()){T.push("global_token_share")}if(this._should_show_single_entry_share()){T.push("global_share_button")}if(!Constants.can_see_trash){T.push((ci.deleted_shown?"hide_del":"show_del"))}}else{T=T.concat(["global_restore"])}return T},_should_show_shared_folder_options:function(){return !ci.is_in_subfolder_of_shared_folder()&&!ci.inside_sandbox&&!this._should_show_single_entry_share()},_should_show_share_link:function(){return ci.is_shmodelable_path(ci.containing_fq_path())&&!this._should_show_single_entry_share()},_should_show_single_entry_share:function(){return ci.single_share_entry_point&&ci.containing_fq_path()!==""}});bE=B.GlobalActionsBasic=Class.create(eQ,{initialize:function($super){$super();this._listen();return this._render()},_listen:function(){$("global-actions").stopObserving("click");$("global-actions").on("click","a",this._click.bind(this));document.observe(bg.SHOW_EVT,this._disable.bind(this));return document.observe(bg.HIDE_EVT,this._enable.bind(this))},_render:function(){var e2,e4,e6,e9,fb,T,e0,e5,e8,e7,e3,fa,e1;e4=this.get_action_names();e7=e4.intersect(bE.STANDARD_ACTIONS);e5=e4.without.apply(e4,bE.STANDARD_ACTIONS);if(e5.length===1){e7=e4;e5=[]}if(e5.length){e7.push("more_global_actions")}e8=(function(){var fe,fd,fc;fc=[];for(fe=0,fd=e7.length;fe<fd;fe++){T=e7[fe];fc.push(this.get_action_by_name(T))}return fc}).call(this);e6=(function(){var fe,fd,fc;fc=[];for(fe=0,fd=e8.length;fe<fd;fe++){e2=e8[fe];if(e2.kind==="button"){fc.push(e2)}}return fc})();e0=(function(){var fe,fd,fc;fc=[];for(fe=0,fd=e8.length;fe<fd;fe++){e2=e8[fe];if(e2.kind!=="button"){fc.push(e2)}}return fc})();e9=eV.tmpl("global_actions_tmpl",{context:this,standard_actions:e6.concat(e0),secondary_actions:(function(){var fe,fd,fc;fc=[];for(fe=0,fd=e5.length;fe<fd;fe++){T=e5[fe];fc.push(this.get_action_by_name(T))}return fc}).call(this),Sprite:cm});$("global-actions").__date(e9);bv(document).trigger("db:browse:ga_rendered");fb=this.get_disabled_action_names();e1=[];for(e3=0,fa=fb.length;e3<fa;e3++){e2=fb[e3];e1.push(this._disable_action(e2))}return e1},_disable:function(){$("global-actions").stopObserving("click");$$("#global-actions .action a").invoke("removeClassName","title_bubble");return $$("#global-actions .action a").invoke("addClassName","disabled")},_disable_action:function(e1){var e0,T;T="#global-actions #"+e1+"_button";e0=bv(T);e0.addClass("disabled");return e0.click((function(e2){return function(e3){e2.show_disabled_action_warning(e1);return false}})(this))},_enable:function(){var e2,e3,e1,e0,T;$("global-actions").stopObserving("click");$("global-actions").on("click","a",this._click.bind(this));$$("#global-actions .action a").invoke("removeClassName","disabled");$$("#global-actions .action a").invoke("addClassName","title_bubble");e3=this.get_disabled_action_names();T=[];for(e1=0,e0=e3.length;e1<e0;e1++){e2=e3[e1];T.push(this._disable_action(e2))}return T},_click:function(e2,e0){var e1,T;e1=e0.readAttribute("data-value");cz(e1);T=a.option_dict[e1];cz(T,"Action info is missing for "+e1);bE.hide_secondary();eG.deselect_all();e2.preventDefault();T.click_handler.call(this,e2,"global_actions_basic");if(e1==="global_share"){if(this._log_extras.path===""){return a3.SharedFolderActivityLogger.log("web","browse_view_share_button",ci.active_user,this._log_extras,true)}else{return a3.SharedFolderActivityLogger.log("web","folder_view_share_button",ci.active_user,this._log_extras,true)}}}});Object.extend(bE,{STANDARD_ACTIONS:["upload","new_folder","global_share","global_token_share","global_restore","global_purge","global_share_button"],show_secondary:function(){var T,e0;e0=$("secondary-actions");T=$("more_global_actions_button");e0.show();return T.addClassName("down")},hide_secondary:function(){var T,e0;e0=$("secondary-actions");if(!e0){return}T=$("more_global_actions_button");e0.hide();return T.removeClassName("down")}});ds=B.GlobalActionsContext=Class.create(eQ,{initialize:function($super,T){$super(T);return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(e2,e0){var e1,T;e1=e0.readAttribute("data-value");this.firefly_logging_helper(e1);T=a.option_dict[e1];eG.deselect_all();if(!T.is_dropdown){bg.hide()}e2.preventDefault();T.click_handler.call(this,e2,"global_actions_context");if(e1==="global_share"){if(this._log_extras.path===""){return a3.SharedFolderActivityLogger.log("web","browse_view_right_click_share",ci.active_user,this._log_extras,true)}else{if(ci.inside_shared_folder){return a3.SharedFolderActivityLogger.log("web","folder_view_right_click_options",ci.active_user,this._log_extras,true)}else{return a3.SharedFolderActivityLogger.log("web","folder_view_right_click_share",ci.active_user,this._log_extras,true)}}}}});var w;w=B.BrowseClipboard=(function(){var e7,e4,e1,e5,e3,e9,fb,e6,e0,T,e8,e2,fa;e7=0;e4=1;e3=[];e1=null;fa=function(){var fe,fg,fd,fh,ff,fc;if(z.focus_in_input()){return}fd=eG.get_selected_files();if(fd&&fd.length){for(ff=0,fc=fd.length;ff<fc;ff++){fg=fd[ff];if(fg.bytes<0){ab.error(el("Deleted files cannot be added to the clipboard"));return false}else{if(fg.target_ns){fh=el("'%(filename)s' cannot be added to the clipboard");fh=fh.format({filename:fg.filename});ab.error(fh);return false}}}e3=fd;fe=fd.length;fh=a4("Added %d item to clipboard","Added %d items to clipboard",fe).format(fe);ab.success(fh);return true}};e9=function(){if(fa()){e1=e7;return false}};fb=function(){if(fa()){e1=e4;return false}};e6=function(fc){var fd;cz(typeof fc!=="undefined","BrowseClipboard _paste got an undefined path");if(e3.length){fd=e1===e7?dn.do_bulk_copy:dn.do_bulk_move;fd(e3,fc);return true}};e2=function(fc){var fd;if(z.focus_in_input()||ci.in_search_mode()||ci.inside_deleted_dir){return}fd=e6(ci.containing_fq_path());if(fd){return false}};e5=function(){return e3=[]};T=function(fj){var fi,fe,fg,fh,ff,fd,fc;fg=fj.memo.files;for(fh=0,fd=fg.length;fh<fd;fh++){fe=fg[fh];for(ff=0,fc=e3.length;ff<fc;ff++){fi=e3[ff];if(fi.fq_path===fe.fq_path||fi.fq_path.startsWith(fe.fq_path+"/")){e5();return}}}};e0=function(fc){cz((fc.memo.file!=null)&&(fc.memo.files==null));fc.memo.files=[fc.memo.file];return T(fc)};e8=function(){var fg,fc,ff,fd,fe;bv(document).on(aC.RENAME,(function(fh){return function(fi,fj){fi.memo=fj;return e0(fi)}})(this));fe=[aC.DELETE,aC.MOVE];for(ff=0,fd=fe.length;ff<fd;ff++){fg=fe[ff];document.observe(fg,T)}fc=key.main_modifier();key(""+fc+"+c",ci.KEY_SCOPE,e9);key(""+fc+"+x",ci.KEY_SCOPE,fb);return key(""+fc+"+v",ci.KEY_SCOPE,e2)};return{init:function(){return e8()}}})();var eG,aS,az;eG=B.BrowseSelection=(function(){var e3,e5,fm,fb,fp,T,fi,fa,fx,ff,fj,e6,fc,fk,fu,ft,e7,fd,e2,fl,fg,fn,fv,e4,fq,fo,fw,e9,fs,fr,fh,fz,e1,fe,e8,e0,fy;fr=[];fb=null;ff=null;fa=null;T=[];e8=function(){$$("#browse-files li.browse-file.file-select").invoke("removeClassName","file-select").invoke("removeClassName","file-select-one");eG.get_selected_files().invoke("get_div").findAll(function(fA){return fA}).invoke("addClassName","file-select");if(eG.get_selected_files().length===1){return eG.get_selected_files().invoke("get_div").findAll(function(fA){return fA}).invoke("addClassName","file-select-one")}};e0=function(){if(fa){return}$$("#browse-files li.browse-file[draggable]").invoke("writeAttribute","draggable",false);if(ci.in_search_mode()&&bZ.sparky_search_ui_enabled){return}return eG.get_selected_files().filter(function(fA){return !fA.editing}).invoke("get_div").findAll(function(fA){return fA}).invoke("writeAttribute","draggable","true")};fy=function(fA){fA.apply(null,$A(arguments).slice(1));return document.fire(eG.UPDATED_EVT)};fh=function(fC,fB){var fD,fA;fA=fr.length;fr=(fC instanceof cH?[fC]:$A(fC));if(fr.length!==fA){es("Selected",fr.length,"files")}fD=fB||fr.last();cz(!fD||fD instanceof cH,"Invalid anchor type"+fD);return fb=fD};fh=fh.wrap(fy);e3=function(fB,fA){if(fB){fr.push(fB)}return fb=fA||fB};e3=e3.wrap(fy);fq=function(fA){var fB;fB=fr.indexOf(fA);if(fB===-1){return}return fr.splice(fB,1)};fq=fq.wrap(fy);fo=function(){return fr=[]};fo=fo.wrap(fy);fz=function(fA){T=fA;$$("#browse-files li.browse-file.context-select").invoke("removeClassName","context-select");return fA.invoke("get_div").findAll(function(fB){return fB}).invoke("addClassName","context-select")};fd=function(fJ){var fG,fE,fD,fF,fM,fC,fL,fN,fA,fI,fK,fH,fB;fH=$(fJ.target);fN=fH.match("li.browse-file")?fH:fH.up("li.browse-file");fG=fH.match("a")?fH:fH.up("a");fD=cH.from_elem(fN);if(fJ.isRightClick()||!fN||fG||fN.hasClassName("unselectable")){return}ci.keyboard_nav=false;if(T.length){return}fC=dQ.is_mac();if((fC&&fJ.metaKey)||(!fC&&fJ.ctrlKey)){if(fr.indexOf(fD)===-1){return e3(fD)}else{return fq(fD)}}else{if(fJ.shiftKey){fE=ci.files.indexOf(fb);fB=ci.files.indexOf(fD);fL=ci.files.indexOf(fr.last());fI=fr.slice(0);fM=fL<fE?-1:1;fF=fE;while(fF!==fL){fF+=fM;fK=fI.indexOf(ci.files[fF]);if(fK!==-1){fI.splice(fK,1)}}fM=fB<fE?-1:1;fF=fE;while(fF!==fB){fF+=fM;fA=fI.indexOf(ci.files[fF]);if(fA!==-1){fI.splice(fA,1)}fI.push(ci.files[fF])}return fh(fI,fb)}else{return fh(fD)}}};e2=function(fF){var fJ,fC,fI,fG,fB,fA,fE,fD,fH;if(fF.isRightClick()||T.length||dQ.in_scrollbar(fF.pointerX())){return}fG=$(fF.target);if(Element.match(fG,"object")){fG=fG.parentNode}fE=["browse-box","context-menu-container","modal","modal-overlay"];fB=false;for(fD=0,fH=fE.length;fD<fH;fD++){fA=fE[fD];if(fG.descendantOf(fA)||fG.match("#"+fA)){fB=true;break}}if(!fB){fh();return}fI=fG.match("li.browse-file")?fG:fG.up("li.browse-file");fC=cH.from_elem(fI);fJ=fG.match("[draggable]")||fG.up("[draggable]");if(fC&&!fJ){ff=fb;if(!fF.shiftKey){if(fC){ff=fC}else{if(fG.match("#browse-files")){ff=ci.files.last()}}}fa=[];if(fF.metaKey||fF.ctrlKey){return fa=eG.get_selected_files()}}};e1=function(fC){var fB,fA;fB=cH.from_elem(ft(fC));fC.preventDefault();if(!fB){return}fA="browse_file_row";a3.ShmodelUILogger.log_with_target_file("token_share",fA,fB);return dh.shmodel(fB.fq_path,fA)};ft=function(fB){var fA;fA=$(fB.target);if(fA.match("li.browse-file")){return fA}else{return fA.up("li.browse-file")}};fu=(function(fA){return function(fI){var fC,fB,fD,fL,fK,fH,fJ,fF,fG,fE;fJ=ci.sharing_single_file_collaboration&&ci.sharing_single_file_collaboration==="SINGLE_FILE_SHARING";fL=ft(fI);fC=cH.from_elem(fL);fI.preventDefault();if(!fC){return}fK="browse_file_row";fG=a3.ShmodelUILogger.get_target_item(fC);a3.ShmodelUILogger.log("single_entry_share",fK,fG);fD=ci.simple_sharing_enabled;fH=bv(fL).find(".inline-share-button")[0];if(ci.show_shared_with&&!ci.show_inline_share&&!ci.in_search_mode()){fH=bv(fL).find(".sharing .inline-share-button")[0]}fF=fC.dir&&(fC.is_shared_folder()||fC.could_be_shared_folder());if(fF){if(fD){if(dP.get_for_user(ci.active_user).verified_or_show()){return eq.createAndShowInbandModalFromBrowseFile(ci.active_user,fC)}}else{return az.open(fC.fq_path,fC.is_shared_folder(),fH,ci.active_user,fG)}}else{if(ci.simple_sharing_to_file_enabled&&((fE=__CONDITIONAL_JS__.OpenWith)!=null?fE.file_supported(fC):void 0)){if(dP.get_for_user(ci.active_user).verified_or_show()){return eq.createAndShowInbandModalFromBrowseFile(ci.active_user,fC)}}else{if(fJ&&(fC.is_shared_single_file()||fC.could_be_shared_single_file())&&!fD){return az.open(fC.fq_path,fC.is_shared_single_file(),fH,ci.active_user,fG,fB=true,fC.mount_point)}else{eG.firefly_logging_helper(fC,"single_entry_share_button_file_link");return dh.shmodel(fC.fq_path,fK)}}}}})(this);e4=(function(fA){return function(fD){var fC,fB;fB=ft(fD);fC=cH.from_elem(fB);return aS.recipients_click(fC,ci.active_user)}})(this);e7=(function(fA){return function(fD){var fC,fB;fB=ft(fD);fC=cH.from_elem(fB);return aS.link_click(fC,ci.active_user)}})(this);fp=function(fD){var fB,fA,fC;fC=$(fD.target);fA=fC.match("li.browse-file")?fC:fC.up("li.browse-file");fB=cH.from_elem(fA);if(fB){return fd(fD)}};fk=null;fj=function(){var fA;clearInterval(fk);fA=function(){ci.keyboard_nav=false;return $("browse-files").addClassName("mouse-active")};return fk=setTimeout(fA,100)};fi=function(){if(!ci.keyboard_nav){ci.keyboard_nav=true;return $("browse-files").removeClassName("mouse-active")}};fl=function(fG){var fD,fC,fB,fF,fI,fA,fE,fH;fj();if(!eG.is_selecting()){return}fD=ci.files.indexOf(ff);fA=ci.files.indexOf(cH.from_elem(fG.target));cz(fD<ci.files.length&&fD>=0,"anchor_index: "+fD+" "+ff);cz(fA<ci.files.length&&fA>=0,"target_index: "+fA);fC=ci.files.slice(Math.min(fD,fA),Math.max(fD,fA)+1);fB=fa.slice(0);for(fE=0,fH=fC.length;fE<fH;fE++){fI=fC[fE];fF=fB.indexOf(fI);if(fF===-1){fB.push(fI)}else{fB.splice(fF,1)}}return fh(fB)};fx=function(fA){ff=null;return fa=null};fv=function(fC){var fA,fB;if(typeof L!=="undefined"&&L!==null){L.reset()}fi();if(fC){Event.extend(fC).preventDefault()}fB=fr.length?fr.last()===ci.files.first()?ci.files.first():(fA=ci.files.indexOf(fr.last())-1,ci.files[fA]):ci.files.last();fh(fB);if(fB){return ci.scrollTo(fB.get_div())}};fg=function(fC){var fA,fB;if(typeof L!=="undefined"&&L!==null){L.reset()}fi();if(fC){Event.extend(fC).preventDefault()}fB=fr.length?fr.last()===ci.files.last()?ci.files.last():(fA=ci.files.indexOf(fr.last())+1,ci.files[fA]):ci.files.first();fh(fB);if(fB){return ci.scrollTo(fB.get_div())}};fm=function(fI){var fA,fB,fG,fH,fD,fE,fF,fC;if(typeof L!=="undefined"&&L!==null){L.reset()}fi();if(fI){Event.extend(fI).preventDefault()}if(fr.length>0){fH=ci.files.indexOf(fr.last());fA=ci.files.indexOf(fb);if(fb===fr.last()||fA>fH){if(fH>0){fC=[];for(fG=fE=fF=fH-1;fF<=0?fE<=0:fE>=0;fG=fF<=0?++fE:--fE){fB=ci.files[fG];fD=fr.indexOf(fB);e3(fB,fb);if(fD!==-1){fC.push(fr.splice(fD,1))}else{ci.scrollTo(fB.get_div());break}}return fC}}else{fq(fr.last());return ci.scrollTo(fr.last().get_div())}}else{return fv()}};e5=function(fJ){var fA,fB,fH,fI,fE,fF,fG,fD,fC;if(typeof L!=="undefined"&&L!==null){L.reset()}fi();if(fJ){Event.extend(fJ).preventDefault()}if(fr.length>0){fI=ci.files.indexOf(fr.last());fA=ci.files.indexOf(fb);if(fb===fr.last()||fA<fI){fC=[];for(fH=fF=fG=fI+1,fD=ci.files.length;fG<=fD?fF<fD:fF>fD;fH=fG<=fD?++fF:--fF){fB=ci.files[fH];fE=fr.indexOf(fB);e3(fB,fb);if(fE!==-1){fC.push(fr.splice(fE,1))}else{ci.scrollTo(fB.get_div());break}}return fC}else{fq(fr.last());return ci.scrollTo(fr.last().get_div())}}else{return fg()}};fw=function(){if(typeof L!=="undefined"&&L!==null){L.reset()}fh(ci.files);return false};fs=function(){if(typeof L!=="undefined"&&L!==null){L.reset()}return fh(null,null,null)};e9=function(fA){return fh(ci.find_file(fA.memo.fq_path))};fc=function(){$$(".file-select").invoke("removeClassName","file-select").invoke("removeClassName","file-select-one");return setTimeout(e8,100)};fn=function(fA){return fA.memo.files.each(function(fB){var fC;fC=fr.indexOf(fB[0]);if(fC!==-1){fr.splice(fC,1);return e3(fB[1])}})};e6=function(fA,fB){var fC;if(ci.in_search_mode()&&fA&&fB){fC={file_nsid:fA.ns_id,file_sjid:fA.file_sjid,firefly:bZ.firefly_enabled,match_type:fA.match_type,position:fA.sort_rank,request_id:fA.request_id,viewport:"full-view",action_type:fB};return a3.SearchClientActivityLogger.log("result_action",ci.active_user.id,fC)}};fe=function(fB,fA,fC,fE,fI){var fH,fG,fF,fD;fG="file_row_sharing_menu";if(fA){if(dP.get_for_user(fB).verified_or_show()){a3.ShmodelUILogger.log("sf_options",fG,fC);e6("single_entry_share_button_folder_options");fH=new c2(fB,fE);if(typeof fI==="function"){fI()}return fH.show()}}else{fD=ci.verify_email_after_share_experiment_variant;fF=fD&&fD==="VERIFY_LAST";if(fF){a3.UserActivityLogger.log("web","email_verify_last_experiment_shown")}else{if(fD){a3.UserActivityLogger.log("web","email_verify_last_experiment_not_shown")}}if(fF||dP.get_for_user(fB).verified_or_show()){a3.ShmodelUILogger.log("sf_invite",fG,fC);e6("single_entry_share_button_folder_invite");fH=new ce(fB,{folder_name:fE,element_id:"invite-to-new-sf-wizard-modal-"+fB.id,must_check_verified:fF});if(typeof fI==="function"){fI()}return fH.show()}}};document.observe(bu.REMOVE,function(fA){return fA.memo.files.each(fq)});document.observe(bu.MOVE,fn);return{UPDATED_EVT:"db:select:updated",LIGHTBOX_EXIT_SELECT_EVT:"db:filepreview:exitselect",init:function(){var fA;document.observe("click",fp);document.observe("mousedown",e2);document.observe("mouseup",fx);document.observe("dragend",fx);document.observe("mouseup",e0);$("browse-files").on("mouseover","li.browse-file",fl);$("browse-files").on("click",".shmodel-file",e1);$("browse-files").on("click",".inline-share-button",fu);$("browse-files").on("click",".more-link",fu);document.observe(eG.UPDATED_EVT,e8);document.observe(eG.UPDATED_EVT,e0);document.observe(ci.RENDER_EVT,e8);document.observe(ci.RENDER_EVT,e0);document.observe(ci.UPDATE_EVT,fh.bind(null,null,null));document.observe(eG.LIGHTBOX_EXIT_SELECT_EVT,e9);fA=key.main_modifier();key("up",ci.KEY_SCOPE,fv);key("down",ci.KEY_SCOPE,fg);key(fA+"+a",ci.KEY_SCOPE,fw);key("escape",ci.KEY_SCOPE,fs);key("shift+up",ci.KEY_SCOPE,fm);return key("shift+down",ci.KEY_SCOPE,e5)},set_selected_files:function(fA){return fh(fA)},get_selected_files:function(){return fr.slice(0)},get_selected_fq_paths:function(){return fr.map(function(fA){return fA.fq_path})},has_selected_files:function(){return fr.length},is_selected:function(fA){return fr.indexOf(fA)!==-1},is_selecting:function(){return !!ff},deselect_all:fo,set_context_selected:function(fA){return fz(fA)},flicker_selected:fc,firefly_logging_helper:function(fA,fB){return e6(fA,fB)},show_share_modal_if_email_verified:fe,recipients_click:function(fA){return e4(fA)},link_click:function(fA){return e7(fA)}}})();az=B.SharingGrowthExperimentsDropdown={open:function(e4,e1,e2,e0,e5,e6,e3){var T;this.fq_path=e4;this.existing_sf=e1;this.button=e2;this.user=e0;this.target_item=e5;this.is_file=e6;this.mount_point=e3;this.$menu=bv("#sharing-growth-experiments-dropdown-menu");T=this.$button&&this.$button.length;if(T){if(this.$button[0]===this.button){this._hide();return}else{this._hide()}}return this._show()},_show:function(){var T;this.$menu.show();this.$button=bv(this.button);this.$button.addClass("pressed");if(ci.show_inline_share){this.$button.parent(".sharing-actions").addClass("pressed")}T={offsetLeft:-1*Math.abs(this.$button.outerWidth()-this.$menu.outerWidth())+6,offsetTop:46,setWidth:false,setHeight:false};z.clone_position(this.$menu,this.$button,T);bv("#browse-box").addClass("dropdown-menu-open");if(this.is_file){this._add_share_file_logging("single_file_shared_entry_button_displayed","single_file_unshared_entry_button_displayed")}return this._listen()},_listen:function(){this.$menu.on("click dblclick",function(T){return T.stopPropagation()});bv(document).on("mousedown",bv.proxy(this._click_outside_menu_callback,this));this.$menu.find(".option-to-share-folder").on("click",bv.proxy(this._sf_click,this));return this.$menu.find(".option-to-share-link").on("click",bv.proxy(this._share_link_click,this))},_unlisten:function(){this.$menu.hide().off("click dblclick");bv(document).off("mousedown",this._click_outside_menu_callback);this.$menu.find(".option-to-share-folder").off("click",bv.proxy(this._sf_click,this));return this.$menu.find(".option-to-share-link").off("click",bv.proxy(this._share_link_click,this))},_add_share_file_logging:function(e1,e2){var e0,T;T={path:this.fq_path};e0=this.existing_sf?e1:e2;return a3.SharedFolderActivityLogger.log("web",e0,this.user,T)},_sf_click:function(e0){var T;if(this.is_file){if(dP.get_for_user(this.user).verified_or_show()){this._add_share_file_logging("single_file_shared_collaboration_clicked","single_file_unshared_collaboration_clicked");if(this.existing_sf){T=new dR(this.user,{folder_name:av.filename(this.mount_point),folder_path:this.mount_point,element_id:"confirm-share-existing-file-wizard-modal"})}else{T=new ce(this.user,{folder_name:this.fq_path,is_file:true,element_id:"invite-to-new-share-file-wizard-modal-"+this.user.id})}this._hide();return T.show()}}else{return eG.show_share_modal_if_email_verified(this.user,this.existing_sf,this.target_item,this.fq_path,this._hide.bind(this))}},_share_link_click:function(e0){var T;T="file_row_sharing_menu";a3.ShmodelUILogger.log("token_share",T,this.target_item);this._firefly_logging_helper("single_entry_share_button_folder_link");dh.shmodel(this.fq_path,T);if(this.is_file){this._add_share_file_logging("single_file_shared_link_clicked","single_file_unshared_link_clicked")}return this._hide()},_firefly_logging_helper:function(T){return eG.firefly_logging_helper(ci.find_file(this.fq_path),T)},_clicked:function(T,e0){return T.is(e0.target)||T.has(e0.target).length},_click_outside_menu_callback:function(T){if(!(this._clicked(this.$menu,T)||this._clicked(this.$button,T))){return this._hide()}},_hide:function(T){this._unlisten();bv("#browse-box").removeClass("dropdown-menu-open");this.$button.removeClass("pressed");if(ci.show_inline_share){this.$button.parent(".sharing-actions").removeClass("pressed")}return this.$button=null}};aS=B.SharingGrowthExperimentsAutocomplete={init:function(){return this.autocomplete=new Autocompleter.ContactsTokenizer(ci.active_user,"growth-browse-inline-new-collab-input","growth-browse-inline-new-whobulk","growth-browse-inline-hidden-input",{tokens:[",",";"],include_fb:false,include_team:false,hide_import_contacts:false,suggestions_disabled:true})},recipients_click:function(e0,T){var e1;this.file=e0;this.user=T;this.mode="recipients";this._activate();this.$sharing_actions.find(".get-link").hide();this.$sharing_actions.find(".send-button").show();e1=this._autocomplete_div();this.$sharing_actions.prepend(e1);e1.show();this.autocomplete.dynamically_resize_input();bv(this.autocomplete.element).val("");this.autocomplete.clearTokens();bv(this.autocomplete.get_entry_container()).hide();bv(this.autocomplete.element).focus();return false},link_click:function(e1,e0){var T;this.file=e1;this.user=e0;if(!dP.get_for_user(this.user).verified_or_show(ee.SHMODAL)){return}T="file_row_sharing_menu";a3.ShmodelUILogger.log("token_share",T,this.target_item);return dh.shmodel(this.file.fq_path,T)},_activate:function(){this.$sharing_div=bv(this.file.get_div()).find(".sharing");this.$sharing_actions=this.$sharing_div.find(".sharing-actions");this.$sharing_actions.find(".recipients").hide();this.$sharing_div.addClass("pressed");bv("#browse-box").addClass("dropdown-menu-open");return this._listen()},_send:function(){var e0,e5,e6,e8,fb,e2,e1,e3,e7,fa,e4,T,e9;this.sharing_api=new be(this.user);this.autocomplete.tokenize_emails_input(true);e8=this.emails=this.autocomplete.getEmails().split(", ");fb=this.file.fq_path;T={emails:e8};e6="";e5="";e0="";e3=this.file.target_ns;e1="";e9="";e0="";e2=false;this._hide();fa=(function(fc){return function(){return fc._complete(el("Sent!"),"success")}})(this);e7=(function(fc){return function(fh){var fg,ff,fe,fd;fd=fh.responseText.substr(4);if(fd[0]==="{"){fg=JSON.parse(fd);if(fg.emails){ff=fg.emails["message_text"]}if(fg.path){ff=fg.path["message_text"]}}else{ff=fd}if(!ff){ff="Unknown"}fe=el("Error: %(msg)s").format({msg:ff});return fc._complete(fe,"error")}})(this);if(!dP.get_for_user(this.user).verified_or_show(ee.SHMODAL)){return}e4=this.file.read_only||this.file.is_read_only_mount;if(this.file.is_shared_folder()&&!e4){return this.sharing_api.invite_more_to_folder(e3,T,e6,e0,fa,e7)}else{if(this.file.could_be_shared_folder()&&!e4){return this.sharing_api.share_folder(false,fb,T,e6,e5,e1,e9,e0,e2,fa,e7)}else{return this._get_shmodel_link(function(fd){var fc;fc=D.parse(fd);return cs.WebRequest({url:"/sm/share",data:{emails:e8,shmodel_path:fc.path},subject_user:ci.active_user.id,success:fa,error:e7})})}}},_get_shmodel_link:function(T){return cs.WebRequest({url:"/growth/find_or_create_shmodel_link",data:{path:this.file.fq_path},subject_user:ci.active_user.id,dataType:"json",success:(function(e0){return function(e1){if(e1.error!=null){return e0._complete(el("Error"),"error")}else{return T(e1.shmodel_link)}}})(this),error:(function(e0){return function(){return e0._complete(el("Error"),"error")}})(this)})},_complete:function(e0,e5){var T,e4,e6,e7,e2,e3,e1;this.$sharing_div.addClass("complete");T=this.$sharing_div.find(".sharers");if(e5==="success"&&this.emails){e3=a4("Sent to %(number)d person","Sent to %(number)d people",this.emails.length).format({number:this.emails.length});ab.success(e3);e4=T.text();if(e4==="--"){e4=""}if(e4.length===""||e4.length+this.emails.join(", ").length<28){e6=[];e1=0;e2=0;while(e2<this.emails.length&&e1+this.emails[e2].length<(30-e4.length)){e6.push(this.emails[e2]);e1+=this.emails[e2].length;e2++}if(this.emails.length>e6.length){e6.push("+"+(this.emails.length-e6.length))}if(e4!==""){e6.push(e4)}e7=e6.join(", ");T.text(e7)}}else{if(e5==="error"){ab.error(e0)}}return setTimeout(this._removeComplete,2000)},_removeComplete:function(){return bv("div.sharing.complete").removeClass("complete")},_autocomplete_div:function(){return bv("#browse-inline-autocomplete")},_listen:function(){if(this.mode==="recipients"){this._autocomplete_div().on("click dblclick",function(T){return T.stopPropagation()});this.$sharing_actions.find(".send-button").on("click",bv.proxy(this._send,this))}return bv(document).on("mousedown",bv.proxy(this._click_outside_autocompleter_callback,this))},_unlisten:function(){if(this.mode==="recipients"){this._autocomplete_div().off("click dblclick");this.$sharing_actions.find(".send-button").off("click",bv.proxy(this._send,this))}return bv(document).off("mousedown",this._click_outside_autocompleter_callback)},_click_outside_autocompleter_callback:function(T){if(!(this.$sharing_actions.is(T.target)||bv(T.target).parents(".sharing-actions").length)){return this._hide()}},_hide:function(T){var e0;this._unlisten();bv("#browse-box").removeClass("dropdown-menu-open");this.$sharing_actions.find(".recipients, .get-link").show();this.$sharing_actions.find(".send-button, .link-field").hide();this.$sharing_div.removeClass("pressed");e0=this._autocomplete_div().hide();return bv("#browse-sort").append(e0)}};var y;y=B.DragScroll={_timer:null,_mouse_y:0,_initial_mouse_y:null,_scroll_amount:40,_scroll_window:50,_min_drag_distance:20,_exclude_move_event:null,init:function(T,e0){this._exclude_move_event=T;if(e0!=null){return this._scroll_window=e0}},start:function(){this._initial_mouse_y=null;this._listen();return this._timer=setInterval(this._check_for_scroll.bind(this),100)},end:function(){this._unlisten();return clearInterval(this._timer)},_mousemove:function(e0){var T;if(typeof this._exclude_move_event==="function"?this._exclude_move_event(e0):void 0){return this._mouse_y=0}else{T=e0.pointerY();return this._mouse_y=T-z.scroll_offsets().top}},_listen:function(){document.observe("mousemove",this._mousemove.bind(this));return document.observe("dragover",this._mousemove.bind(this))},_unlisten:function(){document.stopObserving("mousemove",this._mousemove.bind(this));return document.stopObserving("dragover",this._mousemove.bind(this))},_check_for_scroll:function(){var T;if(this._initial_mouse_y===null){this._initial_mouse_y=this._mouse_y}if(Math.abs(this._mouse_y-this._initial_mouse_y)<this._min_drag_distance){return}T=0;if(this._mouse_y<this._scroll_window){T=-1*this._scroll_amount}else{if(this._mouse_y>z.viewport_dimensions().height-this._scroll_window){T=this._scroll_amount}}if(T){return z.scroll_to(z.scroll_offsets().left,z.scroll_offsets().top+T)}}};var bH;bH=B.BrowseDrag={_BODY_DRAG_CLASS:"external_drag",_STATUS_CLASS:"dragging",_STATUS_OFFSET:10,_SELECTION_CONST:"SELECTION",_current_item_key:null,_drag_from_window:false,init:function(){var T;if(!Modernizr.draganddrop){return}this.listen();T=function(e1){var e0;e0=bv(e1.target);return e0.closest("#browse-location").length||e0.attr("id")==="browse-location"};return y.init(T,bv("#browse-header").height())},listen:function(){var T;T=$(document.body);document.observe(ci.UPDATE_EVT,this._update_body_data.bind(this));T.on("dragleave","[dropzone]",this._dropzone_dragleave.bind(this));T.on("dragend",this._body_dragend.bind(this));T.on("dragover","[dropzone]",this._dropzone_dragover.bind(this));if(Prototype.Browser.IE){T.on("dragenter","[dropzone]",this._dropzone_dragover.bind(this));T.on("mousedown",this._ie_start_drags.bind(this));T.on("mouseover","a.filename-link",this._ie_mouseover.bind(this))}T.observe("dragover",this._body_dragover.bind(this));T.observe("dragleave",this._body_dragleave.bind(this));T.observe("dragstart",this._body_dragstart.bind(this));T.observe("mousemove",this._body_mousemove.bind(this));T.on("dragstart","li.browse-file",this._file_dragstart.bind(this));document.observe(eG.UPDATED_EVT,this._build_selected_drag_icon.bind(this));document.observe(ci.RENDER_EVT,this._build_selected_drag_icon.bind(this));T.on("mousedown","li.browse-file",this._build_file_drag_icon.bind(this));return T.on("drop","[dropzone]",this._drop.bind(this))},_file_mousemove:function(e0){var T;if(!window.event||window.event.button!==1){return}T=e0.findElement("[draggable]");if(T&&T!==document&&T.dragDrop){T.dragDrop();return bH._ie_end_drags()}},_ie_start_drags:function(T,e0){if(e0.tagName!=="OBJECT"&&$(e0).match("[draggable]")){return $("browse-files").observe("mousemove",this._file_mousemove)}},_ie_end_drags:function(){return $("browse-files").stopObserving("mousemove")},_update_body_data:function(){var e0,T;e0=ci.inside_dir?"copy move":false;T=ci.inside_dir?ci.containing_fq_path():false;$(document.documentElement).writeAttribute("dropzone",e0);return $(document.documentElement).writeAttribute("data-fq_path",T)},_body_dragover:function(e0){var T;T=this._get_event_browse_files();if(T.length){return this._update_status_position(e0,T)}else{if(!this._drag_from_window&&this._can_drop_transfer(e0.dataTransfer)){return bi.show_drop_indicators(e0)}}},_body_dragleave:function(e1){var e0,T,e2;T=e1.x||e1.clientX;e2=e1.y||e1.clientY;e0=z.viewport_dimensions();if(!((0<T&&T<e0.width)&&(0<e2&&e2<e0.height))){return bi.hide_drop_indicators()}},_body_dragstart:function(){return this._drag_from_window=true},_body_dragend:function(){if($("breadcrumb-dropdown")){$("breadcrumbs-box").removeClassName("down");$("breadcrumb-dropdown").hide()}this._clear_event_browse_files();this._remove_drop_indicators();bi.hide_drop_indicators();y.end();return this._drag_from_window=false},_body_mousemove:function(){return bi.hide_drop_indicators()},_ie_mouseover:function(e0,T){if(!z.focus_in_input()){return T.focus()}},_dropzone_dragover:function(e4,T){var e0,e1,e2,e3;e4.preventDefault();e2=this._get_event_browse_files();e3=this._target_fq_path(T);if(!e2.pluck("fq_path").indexOf(e3===-1)){return}if(!this._can_drop(e4,T)){T.addClassName("drag_nodrop");return}try{e1=e4.dataTransfer.effectAllowed}catch(e5){}if(e1==="move"||e1==="copyMove"||e1==="linkMove"||e1==="all"){e4.dataTransfer.dropEffect="move"}else{e4.dataTransfer.dropEffect="copy"}e4.preventDefault();e0=$$(".dragover");e0.removeItem(T);e0.invoke("removeClassName","dragover");if(!dE.disabled){T.addClassName("dragover")}return bi.folder_dragover(e3)},_dropzone_dragleave:function(e0,T){return this._clear_hover_state(T)},_file_dragstart:function(e5,e8){var e9,T,fa,e0,e4,e3,e2,e6,e1;dQ.clear_selected();if(eG.is_selecting()){return e5.preventDefault()}e5.dataTransfer.effectAllowed="copyMove";e5.dataTransfer.setData("URL","about:blank");e4=cH.from_elem(e8);this._set_event_browse_files(e4);e3=this._get_event_browse_files();if(e3.length<=1&&!e4.dir){e1=e4.href;e2=(e4.filename||el("file")).replace(/:/g,"-");e6="application/octet-stream";try{e5.dataTransfer.setData("DownloadURL",[e6,e2,e1].join(":"))}catch(e7){}}fa=new Element("img",{src:"/static/images/icons/icon_spacer-vflN3BYt2.gif",width:1,height:1});e9=true;try{e5.dataTransfer.setDragImage(fa,150,150)}catch(e7){e0=e7;e9=dQ.ie8}this._add_drop_indicators(e5);y.start();if(e9){this._update_status_position(e5,e3);T=$("drag-status");T.removeClassName("rotatein").removeClassName("fadein").removeClassName("selection");if(e3.length>1){T.addClassName("rotatein")}if(this._is_dragging_selection()){T.addClassName("selection")}return T.addClassName("fadein")}},_add_drop_indicators:function(e3){var e4,e2,e0,e1,T;$(document.body).addClassName(this._STATUS_CLASS);if(!dE.disabled){e1=$$('[dropzone="copy move"]');T=[];for(e2=0,e0=e1.length;e2<e0;e2++){e4=e1[e2];if(this._can_drop(e3,e4)){T.push(e4.addClassName("can_drop"))}else{T.push(void 0)}}return T}},_remove_drop_indicators:function(){this._clear_hover_state();$(document.body).removeClassName(this._STATUS_CLASS);return $$(".can_drop").invoke("removeClassName","can_drop")},_build_selected_drag_icon:function(){var T,e2,e7,e1,e5,e8,e6,e0,e3,e9,e4;e0=eG.get_selected_files();e7=new Element("div",{id:"drag-selection-status"});e4=e0.slice(0,4);for(e5=e3=0,e9=e4.length;e3<e9;e5=++e3){e2=e4[e5];T=e2.get_div();if(!T){continue}e6=T.down(".icon");e6.stopObserving("load");e6.observe.bind(e6).defer("load",bH._build_selected_drag_icon);e8=e6.cloneNode(false);Element.addClassName(e8,"icon icon"+e5);e7.__sert(e8)}e1=new Element("span",{className:"badge"});e1.__date(e0.length);e7.appendChild(e1);return $("drag-selection-status").replace(e7)},_build_file_drag_icon:function(e3,T){var e0,e4,e2,e1;e0=cH.from_elem(T);e1=e0.get_div().down(".icon").cloneNode(false);Element.addClassName(e1,"icon icon0");e2=new Element("span",{className:"badge"});e2.__date("1");e4=new Element("div",{id:"drag-file-status"});e4.__date(e1).__sert(e2);return $("drag-file-status").replace(e4)},_drop:function(e7,fb){var e8,e3,fe,fc,ff,e6,fd,e5,e2,e0,e9,T,e1,e4,fa;e3=this._get_event_browse_files();if(this._linkfile_drop_enabled()){e6=cC.getDraggedLink(e7.dataTransfer)}if(e6!=null){T=cC.buildUrlLinkfileContents(e6);e9=new Blob([T],{type:"text/plain"});e0=D.parse(e6).getAuthority();e9.name=ci.unused_filename(e0+".url");e9.overwrite=false;fd=[e9];a3.LinkfileActivityLogger.log("droplink","url",e0,true,"browse",{})}else{fd=e7.dataTransfer.files;e5=e7.dataTransfer.items}e7.preventDefault();if(fb.readAttribute("quicksend")){if(fd&&fd.length){fe=function(){return bi.upload(W.DEST_FOLDER,fd,e5)};W.get_folder_name(fe)}else{if(e3.length){for(e4=0,fa=e3.length;e4<fa;e4++){e2=e3[e4];e2.id=plupload.guid();W.add_dropbox_file(e2)}}}return}if(this._is_read_only(fb)){e1=el("You don't have permission to add to this folder.");ab.error(e1);return}fc=null;ff=cH.from_elem(fb);e8=fb.readAttribute("data-fq_path");if(ff){fc=ff.fq_path}else{if(e8||e8===""){fc=e8}}if(fd&&fd.length){if(!bi.supported()){ab.error(el("Drag and drop not supported. Please try the simple uploader."))}else{if(!bi.browse_indicators_enabled()&&!bi.modal_indicators_enabled()){if(cq.choose_button_id.startsWith("wizard-")){ab.error(el("You'll be able to drag and drop files once you finish this tutorial. For now, choose a file to upload."))}else{ab.error(el("You can't drag and drop upload right now."))}}else{bi.upload(fc,fd,e5)}}}else{if(e3.length){if((e7.dataTransfer.dropEffect==="copy")||(e7.dataTransfer.effectAllowed==="copy")){dn.do_bulk_copy(e3,fc)}else{if(!ci.inside_dir||ci.containing_fq_path()!==fc){dn.do_bulk_move(e3,fc)}}}}this._remove_drop_indicators();return bi.hide_drop_indicators()},_set_event_browse_files:function(T){var e0;e0=eG.is_selected(T);return this._current_item_key=e0?this._SELECTION_CONST:T.to_key()},_clear_event_browse_files:function(){return this._current_item_key=null},_get_event_browse_files:function(){var e1,e0,T;try{T=this._current_item_key;if(this._is_dragging_selection()){return eG.get_selected_files()}else{if(T){e0=cH.from_key(T);return(e0?[e0]:[])}}}catch(e2){e1=e2;console.log(e1)}return[]},_is_dragging_selection:function(){return this._current_item_key&&this._current_item_key===this._SELECTION_CONST},_is_read_only:function(T){if(T.readAttribute("read_only")){return true}if(T.readAttribute("is_read_only_mount")){return true}return false},_linkfile_drop_enabled:function(){return au.getGandalfRule("docpreview-linkfile-drop")&&(typeof Blob!=="undefined"&&Blob!==null)},_can_drop_transfer:function(e0){var T;T=["Files"];if(this._linkfile_drop_enabled()){T.push.apply(T,["text/x-moz-url","text/uri-list","Url"])}return $u.intersection(e0!=null?e0.types:void 0,T).length>0},_can_drop:function(e2,e0){var T,e1;if(e0.readAttribute("quicksend")){return true}if(this._is_read_only(e0)){return false}T=this._target_fq_path(e0);e1=this._get_event_browse_files();if(e1.length){return !dn.bulk_move_error(e1,T)}else{if(this._can_drop_transfer(e2.dataTransfer)){bi.supported();return true}else{return false}}},_target_fq_path:function(T){var e0;e0=cH.from_elem(T);if(e0){return e0.fq_path}else{return T.readAttribute("data-fq_path")}},_clear_hover_state:function(e0){var e3,e2,T,e1;e1=$$("#browse .dragover");for(e2=0,T=e1.length;e2<T;e2++){e3=e1[e2];if(e3!==e0){e3.removeClassName("dragover")}}return $$("#browse .drag_nodrop").invoke("removeClassName","drag_nodrop")},_update_status_position:function(T){T=Event.extend(T);return dQ.scry("drag-status").setStyle({left:(T.pointerX()-z.scroll_offsets().left+this._STATUS_OFFSET)+"px",top:(T.pointerY()-z.scroll_offsets().top+this._STATUS_OFFSET)+"px"})}};var L;L=B.BrowseJump={_active:"",_listening:false,_RESET_WAIT:1000,_RESET_TIMER_ID:null,_CODEPOINTS:null,_BLACKLIST:["/","\\",":","?","*","<",">","|"].map(function(T){return T.charCodeAt(0)}),update:function(){var e1,e4,e0,e3,T,e2;if(!L._listening){L.listen();L._listening=true}e1=[];e2=ci.files;for(e3=0,T=e2.length;e3<T;e3++){e0=e2[e3];e4=L.to_codepoint_list(e0.filename);e1.push([e4,e0])}e1.sort(function(e6,e5){return L.cmp_codepoints(e6[0],e5[0])});return L._CODEPOINTS=e1},reset:function(){return L._active=""},is_active:function(){return L._active},jump:function(T){if(T){eG.set_selected_files([T]);return ci.scrollTo(T.get_div())}},listen:function(){var e3,e2,e0,e1,T;document.observe("keypress",function(e5){var e4;if(key.getScope()!==ci.KEY_SCOPE){return}if(z.focus_in_input()||e5.metaKey||e5.altKey||e5.altGraphKey||e5.ctrlKey){return}e4=e5.charCode||e5.keyCode;if(e4<32){return}if((33<=e4&&e4<=40)){return}if(e4===32){if(L._active){e5.preventDefault()}else{return}}if(L._BLACKLIST.indexOf(e4)!==-1){return}clearTimeout(L._RESET_TIMER_ID);L._active+=String.fromCharCode(e4).toLowerCase();L.jump(L.nearest_file(L._active));return L._RESET_TIMER_ID=setTimeout(L.reset,L._RESET_WAIT)});e1=[aC.DELETE,aC.COPY,aC.MOVE,aC.RENAME,aC.PURGE,aC.RESTORE,aC.UPLOAD,aC.SF_NEW,aC.SF_LEAVE,aC.SF_UNSHARE,aC.SF_REJOIN,aC.SF_IGNORE,aC.LINKS_REMOVE,bu.ADD,bu.REMOVE,bu.MOVE];T=[];for(e2=0,e0=e1.length;e2<e0;e2++){e3=e1[e2];document.observe(e3,function(e4){return L.update()});T.push(bv(document).on(e3,function(e4){return L.update()}))}return T},nearest_file:function(e7){var e4,e0,T,e3,e6,e5,e2,e1;if((e5=L._CODEPOINTS)!=null?e5.length:void 0){e4=L.to_codepoint_list(e7);e2=L._CODEPOINTS;for(e3=0,e6=e2.length;e3<e6;e3++){e1=e2[e3],T=e1[0],e0=e1[1];if(L.cmp_codepoints(e4,T)<1){return e0}}L._CODEPOINTS.last()[1]}return null},cmp_codepoints:function(e3,e2){var T,e1,e0;cz(e3.length>0&&e2.length>0,"bad input to cmp_codepoints");for(T=e1=0,e0=e3.length;0<=e0?e1<e0:e1>e0;T=0<=e0?++e1:--e1){if(e2[T]==null){return 1}if(e3[T]!==e2[T]){return(e3[T]<e2[T]?-1:1)}}if(e2.length>e3.length){return -1}else{return 0}},to_codepoint_list:function(e0){var e1,T,e3,e2;e0=e0.toLowerCase();T=[];for(e1=e3=0,e2=e0.length;0<=e2?e3<e2:e3>e2;e1=0<=e2?++e3:--e3){T.push(e0.charCodeAt(e1))}return T}};var bg;bg=B.ContextMenu={KEY_SCOPE:"context",SHOW_EVT:"db:contextmenu:show",HIDE_EVT:"db:contextmenu:hide",_prev_key_scope:null,listen:function(){bv(document).click(this.hide_on_click);bv(document).on(ci.UPDATE_EVT,this.hide_on_click);return key("esc",this.KEY_SCOPE,(function(T){return function(e0){return bg.hide()}})(this))},unlisten:function(){bv(document).off("click",this.hide_on_click);return bv(document).off(ci.UPDATE_EVT,this.hide_on_click)},hide_on_click:function(T){if(!(T.which===3||bv(T.target).parents("#context-menu").length)){return bg.hide()}},show_for_file:function(T,e2,e1){var e3,e0;ci.keyboard_nav=false;this.hide();e3=cH.from_elem(e1);e0=eG.is_selected(e3)?eG.get_selected_files():(eG.deselect_all(),[e3]);eG.set_context_selected(e0);return this._show(e2,new T(e0))},show_global:function(T,e0){this.hide();return this._show(e0,new T())},show_shmodel:function(e5){var e4,e0,T,e1,e2,e3;e4=["get_original"];e2=e5.findElement("img");if((e2.readAttribute("enable-download"))==="true"){e1=e2.readAttribute("data-original-href");e0=[]}else{e1="";e0=["get_original"]}this.hide();e3={get_original:{icon:"download",text:el("Download original"),href:e1}};T=Class.create({get_action_names:function(){return e4},get_disabled_action_names:function(){return e0},get_action_by_name:function(e6){var e7;e7=e3[e6];e7.name=e6;return e7}});return this._show(e5,new T())},show_for_lightbox:function(e6){var e5,e0,T,e3,e1,e4,e2;e5=["download","view_original"];this.hide();e1=e6.findElement("img");if((e1.readAttribute("enable-download"))==="false"){e0=["download","view_original"];e3="";e2=""}else{e0=[];e3=D.parse(e1.readAttribute("data-original-href")).updateQuery({dl:1}).toString();e2=e1.readAttribute("data-original-href")}e4={download:{icon:"download",text:el("Download"),href:e3},view_original:{icon:"view_original",text:aY.append_ellipsis(el("View original")),href:e2,target:"_blank"}};T=Class.create({initialize:function(){return this._listen()},_listen:function(){var e7;e7=$("context-menu-container");e7.stopObserving("click");e7.stopObserving("contextmenu");e7.on("click",".action button",this._click.bind(this));return e7.on("contextmenu",".action button",this._click.bind(this))},_click:function(fb,e8){var fa,e7,e9;fa=e8.readAttribute("data-value");e7=e4[fa];bg.hide();fb.preventDefault();return(e9=e7.click_handler)!=null?e9.call(this,fb):void 0},get_action_names:function(){return e5},get_disabled_action_names:function(){return e0},get_action_by_name:function(e7){var e8;e8=e4[e7];e8.name=e7;return e8}});return this._show(e6,new T())},show_photos:function(e7,fb){var fa,e0,e4,e2,e9,e8,T,e1,e5,e6,e3;this.hide();e2={divider:{type:"divider"},choose_album:{icon:"album_16",text:aY.append_ellipsis(el("Add %(num_photos)s to album").format({num_photos:fb.length})),click_handler:function(fc){cw.show_add_to_album_modal(fc,fb);return h.log_interaction(d8.ADD_TO_OTHER_ALBUM,cY.PCM,{num_photos:fb.length})}},remove:{icon:"album_delete_16",text:el("Remove %(num_photos)s from album").format({num_photos:fb.length}),click_handler:function(){cw.show_remove_photos_modal(bG.get_current_collection(),fb);return h.log_interaction(d8.REMOVE,cY.PCM,{num_photos:fb.length})}},set_cover:{icon:"album_16",text:el("Set as cover"),click_handler:function(){bG.get_current_collection().set_cover(fb[0]);return h.log_interaction(d8.SET_AS_COVER,cY.PCM,{num_photos:1})}},edit_timestamp:{text:"Edit timestamp",click_handler:function(){return bG.show_timestamps_modal(fb)}}};if(bG.in_single_collection_view()){fa=["share","choose_album","remove"];if(fb.length===1){fa.unshift("divider");fa.unshift("set_cover")}}else{fa=["share","choose_album"];fa.push("divider");fa.push("delete");if(bG.timestamp_edit_enabled){e9=(function(){var fe,fd,fc;fc=[];for(fe=0,fd=fb.length;fe<fd;fe++){e1=fb[fe];if(e1.time_taken==null){fc.push(e1)}}return fc})();if(e9.length===0){fa.push("edit_timestamp")}else{if(e9.length===fb.length){e2.edit_timestamp.text="Set timestamp";fa.push("edit_timestamp")}}}}if(fb.length===1){e6=cV.categorize_files(fb),e8=e6[0],T=e6[1];if(e8){e5=aY.append_ellipsis(el("Share photo"))}else{e5=aY.append_ellipsis(el("Share video"))}Object.extend(e2,{share:{icon:"s_link",text:e5,click_handler:function(fc){ek.show(fb,false);return h.log_interaction(d8.SHARE,cY.PCM,{num_photos:1})}},"delete":{text:aY.append_ellipsis(el("Delete")),click_handler:function(){bG.show_delete_photos_modal(fb);return h.log_interaction(d8.DELETE,cY.PCM,{num_photos:1})}},show_in_folder:{text:aY.append_ellipsis(el("Show in folder")),click_handler:function(){bG.show_in_folder(fb[0]);return h.log_interaction(d8.SHOW_IN_FOLDER,cY.PCM,{num_photos:1})}}});if(bG.in_single_collection_view()){fa.push("divider")}fa.push("show_in_folder")}else{e3=cV.categorize_files(fb),e8=e3[0],T=e3[1];if(e8&&T){e5=a4("Share %(file_count)s item","Share %(file_count)s items",fb.length);e4=a4("Delete %(file_count)s item","Delete %(file_count)s items",fb.length)}else{if(e8){e5=a4("Share %(file_count)s photo","Share %(file_count)s photos",fb.length);e4=a4("Delete %(file_count)s photo","Delete %(file_count)s photos",fb.length)}else{e5=a4("Share %(file_count)s video","Share %(file_count)s videos",fb.length);e4=a4("Delete %(file_count)s video","Delete %(file_count)s videos",fb.length)}}e5=e5.format({file_count:fb.length});e4=e4.format({file_count:fb.length});Object.extend(e2,{share:{icon:"s_link",text:e5,click_handler:function(fc){bG._share_selected();return h.log_interaction(d8.SHARE,cY.PCM,{num_photos:fb.length})}},"delete":{text:e4,click_handler:function(fc){bG.show_delete_photos_modal(fb);return h.log_interaction(d8.DELETE,cY.PCM,{num_photos:fb.length})}}})}e0=Class.create({initialize:function(){return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(ff,fd){var fe,fc,fg;fe=fd.readAttribute("data-value");fc=e2[fe];if(ff.clientX===0&&ff.clientY===0){return}bg.hide();return(fg=fc.click_handler)!=null?fg.call(this,ff):void 0},get_action_names:function(){return fa},get_disabled_action_names:function(){return[]},get_action_by_name:function(fc){var fd;fd=e2[fc];fd.name=fc;return fd}});return this._show(e7,new e0())},show_photo_collection:function(e2,e3,e4){var e1,T,e0;this.hide();if(e3.is_anonymous){e1=["go_to_link","unshare"]}else{if(e3.is_creator){e1=["share","rename"];if(e3.share_tkey!=null){e1.push("unshare")}e1.push("delete")}else{e1=["share"]}}e0={share:{icon:"s_link",text:aY.append_ellipsis(el("Share album")),click_handler:function(e5){if(e3.num_items===0){ab.error(el("This album is empty. Add some photos before you share it!"));return}ek.show(e3,true);return h.log_interaction(d8.SHARE_ALBUM,cY.CCM,{num_photos:e3.num_photos})}},unshare:{icon:"lock",text:aY.append_ellipsis(e3.is_anonymous?el("Unshare"):el("Unshare album")),click_handler:function(e5){cw.show_unshare_modal(e3);return h.log_interaction(d8.UNSHARE_ALBUM,cY.CCM,{num_photos:e3.num_photos})}},rename:{icon:"pencil",text:el("Rename album"),click_handler:function(e5){e3.rename(e4.down(".collection-name"));return h.log_interaction(d8.RENAME_ALBUM,cY.CCM,{num_photos:e3.num_photos})}},"delete":{icon:"album_delete_16",text:aY.append_ellipsis(el("Delete album")),click_handler:function(e5){cw.show_delete_modal(e3);return h.log_interaction(d8.DELETE_ALBUM,cY.CCM,{num_photos:e3.num_photos})}},go_to_link:{icon:"s_link",text:el("Go to link"),click_handler:function(e5){cw.go_to_link(e3);return h.log_interaction(d8.GO_TO_ALBUM_LINK,cY.CCM,{num_photos:e3.num_photos})}}};T=Class.create({initialize:function(){return this._listen()},_listen:function(){$("context-menu-container").stopObserving("click");$("context-menu-container").stopObserving("contextmenu");$("context-menu-container").on("click",".action button",this._click.bind(this));return $("context-menu-container").on("contextmenu",".action button",this._click.bind(this))},_click:function(e9,e6){var e8,e5,e7;e8=e6.readAttribute("data-value");e5=e0[e8];bg.hide();return(e7=e5.click_handler)!=null?e7.call(this):void 0},get_action_names:function(){return e1},get_disabled_action_names:function(){return[]},get_action_by_name:function(e5){var e6;e6=e0[e5];e6.name=e5;return e6}});return this._show(e2,new T())},_show:function(fc,e6,fb){var fa,e3,fd,T,e9,e8,ff,e7,e1,e0,fe,fg,e5,e4,e2;if(fb==null){fb=false}e7=((fc!=null?(e5=fc.target)!=null?e5.tagName.toUpperCase():void 0:void 0)==="INPUT")&&((fc!=null?(e4=fc.target)!=null?e4.type.toUpperCase():void 0:void 0)==="TEXT")||((fc!=null?(e2=fc.target)!=null?e2.tagName.toUpperCase():void 0:void 0)==="TEXTAREA");e9=["#page-footer","#account-header","#browse-global-actions-bar","#modal","#modal-overlay","#file-preview-modal","#file-viewer","#notify-wrapper",".db-modal-wrapper","#sharing-growth-experiments-dropdown-menu",".inline-share-button","#wizard-overlay","#react-bubble-dropdown-root",".preview-sf-members-box",".db-modal",".db-modal-overlay"];ff=$(fc.target);if(bv(ff).parents("#context-menu").length){return}fa=bv("#file-preview-modal");if(!(fa.find(ff).length&&bv(ff).is("img"))){for(e1=0,fe=e9.length;e1<fe;e1++){T=e9[e1];fd=$$(T);if(fd){for(e0=0,fg=fd.length;e0<fg;e0++){e3=fd[e0];if(ff.descendantOf(e3)||ff.match(T)){return}}}}}if((fc!=null?fc.shiftKey:void 0)||e7){return}else{Event.stop(fc)}if(this._context_menu_tmpl==null){this._context_menu_tmpl=eV.tmpl("context_menu_tmpl")}if(!e6.get_action_names().length){return}eD.hide_all();$("context-menu-container").__date(this._context_menu_tmpl({context:e6,actions:(function(){var fj,fh,fk,fi;fk=e6.get_action_names();fi=[];for(fj=0,fh=fk.length;fj<fh;fj++){e8=fk[fj];fi.push(e6.get_action_by_name(e8))}return fi})(),disabled_actions:e6.get_disabled_action_names(),big:fb,Sprite:cm}));this.position_at(fc.clientX,fc.clientY);$("context-menu-container").show();this.listen();this._prev_key_scope=key.getScope();key.setScope(this.KEY_SCOPE);return document.fire(this.SHOW_EVT)},position_at:function(e1,e4){var e0,T,e2,e3;e3=z.viewport_dimensions();T=parseInt($("context-menu").getStyle("width"),10);e0=parseInt($("context-menu").getStyle("height"),10);e2=15;if(e1+T>e3.width-e2){$("context-menu").setStyle({left:(e3.width-T-e2)+"px"})}else{$("context-menu").setStyle({left:e1+"px"})}if(e4+e0>e3.height-e2){return $("context-menu").setStyle({top:(e3.height-e0-e2)+"px"})}else{return $("context-menu").setStyle({top:e4+"px"})}},hide:function(){if(!$("context-menu-container").empty()){this.unlisten();eG.set_context_selected([]);$("context-menu-container").__date();if(key.getScope()===this.KEY_SCOPE){key.setScope(this._prev_key_scope)}return document.fire(this.HIDE_EVT)}}};var c9,ci,j,at,cJ,cb,bB=[].indexOf||function(e1){for(var e0=0,T=this.length;e0<T;e0++){if(e0 in this&&this[e0]===e1){return e0}}return -1};c9=B.BROWSE_SNIPPET_LEN=25;cb=B.SEARCH_SNIPPET_LEN=20;cJ=B.LAST_MODIFIED_FNAME_SNIPPET=4;at=[bj.FILES_BY_NAME,true,"FILES_BY_NAME"];ci=INLINE_JS.Browse=B.Browse={KEY_SCOPE:"browse",RENDER_EVT:"db:browse:render",UPDATE_EVT:"db:browse:update",SCROLL_DURATION:0.5,msg:false,files:[],reloading:false,creating_folder:false,first_load:true,last_sort:at,folder_loading_notification:null,folder_loading_timeout:null,keyboard_nav:false,paginating:false,is_initialized:false,init:function(e0,e5,e2,e4,T,e3,e1){this.browse_actions_ctor=e5;this.global_actions_ctor=e2;this.browse_actions_context_ctor=e4;this.global_actions_context_ctor=T;this.ns_id_to_mount_point=e3;cz(typeof e1==="number","a user_id was not passed into Browse.init",true,[],false);this.active_user=cB.get_viewer().get_user_by_id(e1);__CIRCULAR_DEPENDENCY__.active_user_loaded=true;cz(this.active_user,"No active_user was found in Browse.init",true,[],false);this.unselectable();this.listen();z.viewport_dimensions();if(bR.chrome){this.browser_supports_previews=e0&&dQ.pdf_plugins().length}else{this.browser_supports_previews=e0}if(cB.get_viewer().is_paired){dq.set_role(this.active_user.role)}this.subscribe_sfj_callbacks={};this.compiled_search_tmpl=eV.tmpl("search_list_item_tmpl");this.add_visible_change_callback((function(e6){return function(){return e6.show_inline_sharing_on_browse_exp()}})(this));cs.AuthenticatedRequest({url:D({path:"/flash_detect_log"}),data:{installed:FlashDetect.installed,major:FlashDetect.major,minor:FlashDetect.minor,revision:FlashDetect.revision,revisionStr:FlashDetect.revisionStr,raw:FlashDetect.raw}});return this.is_initialized=true},setup:function(e0,e6){var e5,e4,e3,e2,T,e1;if(e6==null){e6=null}this.ns_id_to_mount_point=e0.ns_id_to_mount_point;this.old_path_to_ns_id=e0.old_path_to_ns_id;this.compiled_tmpl=eV.tmpl("list_item_tmpl");this.render_timeout=null;this.inside_root_folder=e0.containing_fq_path==="";this.inside_dir=e0.inside_dir;this.inside_deleted_dir=e0.inside_deleted_dir;this.inside_shared_folder=e0.inside_shared_folder;this.inside_read_only_shared_folder=e0.inside_read_only_shared_folder;this.inside_sandbox=e0.inside_sandbox;this.public_app_token=e0.public_app_token;this.public_folder_enabled=e0.public_folder_enabled;this.inside_deleted_sandbox=e0.inside_deleted_sandbox;this.inside_deleted_shared_folder=e0.inside_deleted_shared_folder;this.inside_team_folder=e0.inside_team_folder;this.golden_gate_enabled=e0.golden_gate_enabled;this.is_read_only=e0.is_read_only;this.ns_map=e0.ns_map;this.contents_cache_key=e0.contents_cache_key;this._eventbus_darklaunch_enabled=e0.eventbus_darklaunch_enabled;this._eventbus_darklaunch_num_queues=e0.eventbus_darklaunch_num_queues;e4="inside_deleted_dir";if(this.inside_deleted_dir){$("browse").addClassName(e4)}else{$("browse").removeClassName(e4)}this.block_hash=e0.block_hash;this.block_hash_param=e0.block_hash_param;if(this.inside_dir){$("advanced-search-box").hide();$("advanced-search-link").removeClassName("selected");this._containing_ns_id=e0.containing_ns_id;this._containing_ns_path=e0.containing_ns_path;this._containing_fq_path=e0.containing_fq_path;this._containing_mount_point=e0.containing_mount_point;this._containing_sf_perm_role=e0.containing_sf_perm_role;this.breadcrumb();e1=[this.browse_actions,this.global_actions];for(e2=0,T=e1.length;e2<T;e2++){e5=e1[e2];if(e5!=null){e5.unlisten()}}this.browse_actions=new this.browse_actions_ctor();this.global_actions=new this.global_actions_ctor();if(!(e0.file_info||e0.paginated)){this.show_message(el('<h3>This folder is empty</h3> Add files using the <a href="/install">desktop application</a> or the upload button above.'))}}if(e0.paginated){this._start_pagination(e0.first_page)}else{this._push_files(e0.file_info,e6)}if(this._eventbus_darklaunch_enabled){e3=new __CIRCULAR_DEPENDENCY__.EventbusDarkLaunch(ci.active_user.id,this._eventbus_darklaunch_num_queues);return e3.allocate_event_queues()}},entered_search:function(){return this._stop_pagination()},_start_pagination:function(e0){var T;if(e0.unsupported_sort!=null){this.reset_sort()}this.paginating=true;T=ci.active_user.id;this.pagination_manager=new eZ();this.pagination_manager.initialize(e0,"sjid","/browse_get_next",T,(function(e1){return function(e2,e3){return e1._new_data_available(e2,e3)}})(this));this.pagination_manager.startAutoFetching();bv("#more-loading").show();return this.disable_sorting()},_stop_pagination:function(){if(!this.paginating){return}this.paginating=false;this.pagination_manager.stopAutoFetching();this.pagination_manager=null;bv("#more-loading").hide();return this.enable_sorting()},_new_data_available:function(e0,T){if(!this.paginating){return}this._push_files(T);if(!this.in_search_mode()){this.smartfill()}if(e0.areAllItemsReady()){return this._stop_pagination()}},_start_darklaunch_event_queues:function(){var T,e2,e1,e0;if(this._eventbus_darklaunch_num_queues<=0){return}e0=[];for(T=e2=1,e1=this._eventbus_darklaunch_num_queues;1<=e1?e2<=e1:e2>=e1;T=1<=e1?++e2:--e2){__CIRCULAR_DEPENDENCY__.UserQueue.get_user_queue(ci.active_user.id,this._eventbus_darklaunch_num_queues);e0.push(eventbus_dark_launch.allocate_event_queues())}return e0},_push_files:function(e1,e4){var e0,e2,e3,T;if(e4==null){e4=null}for(e3=0,T=e1.length;e3<T;e3++){e2=e1[e3];e0=aY.make_browsefile(e2,e4);e0.track_in_browse()}return L.update()},_get_helper:function(T){cz(this.inside_dir,"accessed "+T+", but not inside a directory");return ci[T]},containing_ns_id:function(){return this._get_helper("_containing_ns_id")},containing_ns_path:function(){return this._get_helper("_containing_ns_path")},containing_mount_point:function(){return this._get_helper("_containing_mount_point")},containing_fq_path:function(){if(!this.inside_dir){return""}return this._get_helper("_containing_fq_path")},containing_sf_perm_role:function(){return this._get_helper("_containing_sf_perm_role")},listen:function(){var fb,e2,e3,e6,fe,e0,e9,e8,e5,fc,e1,T,fd,fa,e7,e4;bv("#fulltext-search-all-link").click(this.unscoped_search);bv("#noresults-search-all-link").click(this.unscoped_search);$("browse-files").on("click","li.browse-file",this.click.bind(this));$("browse-files").on("dblclick","li.browse-file",this.dblclick.bind(this));$("browse-files").on("contextmenu","li.browse-file",bg.show_for_file.bind(bg,this.browse_actions_context_ctor));this.enable_sorting();e6="#browse-sort a.sortable-column-header";dQ.add_sort_arrow_mouseover($("name-sorter"),true,e6,false);Event.observe(window,"scroll",this.window_scroll.bind(this));Event.observe(window,"resize",this.updateOffset.bind(this));$(document.body).on("click","a.crumb",this.crumb_click.bind(this));$("browse-files").on("click","a.parent-dir",this.parent_click.bind(this));document.observe("contextmenu",bg.show_global.bind(bg,this.global_actions_context_ctor));document.observe(eG.UPDATED_EVT,this.selection_handler.bind(this));document.observe(aC.COPY,(function(ff){return function(fg){if(ff.inside_dir&&fg.memo.to_fq_path===ff.containing_fq_path()){return ff.force_reload()}}})(this));fa=[aC.MOVE,aC.RESTORE,aC.UPLOAD,aC.SF_NEW,aC.SF_REJOIN,aC.SF_IGNORE,aC.LINKS_REMOVE,aC.LINKS_ADD];for(e9=0,fc=fa.length;e9<fc;e9++){e2=fa[e9];e3=(function(ff){return function(fg){if(ff.inside_dir&&!(bZ.sparky_search_ui_enabled&&ci.in_search_mode())){return ff.force_reload()}}})(this);document.observe(e2,e3);bv(document).on(e2,e3)}e7=[aC.SF_LEAVE,aC.SF_UNSHARE];for(e8=0,e1=e7.length;e8<e1;e8++){e2=e7[e8];document.observe(e2,(function(ff){return function(fg){if(ff.inside_dir){if(fg.memo.target_ns_id===ff.containing_ns_id()){if(fg.memo.folder_deleted){return ff.reload_fqpath("")}else{return ff.reload_fqpath(ff.containing_fq_path())}}else{return ff.force_reload()}}}})(this))}e4=[aC.DELETE,aC.PURGE];for(e5=0,T=e4.length;e5<T;e5++){e2=e4[e5];document.observe(e2,(function(ff){return function(fo){var fl,fn,fh,fm,fg,fj,fk,fi;if(ff.inside_dir){if(fo.eventName===aC.PURGE||(fo.eventName===aC.DELETE&&!aX.get_del())){for(fn=fm=fk=ff.files.length-1;fk<=0?fm<=0:fm>=0;fn=fk<=0?++fm:--fm){if(fo.memo.files.indexOf(ff.files[fn])===-1){fh=ff.files[fn]}else{break}}eG.deselect_all();fi=fo.memo.files;for(fj=0,fg=fi.length;fj<fg;fj++){fl=fi[fj];fl.get_div().remove();ff.files.removeItem(fl)}if(ff.files.length){if(fh!=null){return eG.set_selected_files(fh)}else{return eG.set_selected_files(ff.files.last())}}else{return ff.show_empty()}}else{if(ff.keyboard_nav){ff.select_fq_paths=[ff.containing_fq_path()+"/"+fo.memo.files.last().filename]}if(aE.shown){return aE.reload=true}else{return ff.force_reload()}}}}})(this))}document.observe(bg.SHOW_EVT,this.disable_sorting.bind(this));document.observe(bg.HIDE_EVT,this.enable_sorting.bind(this));fd=function(){var fg,ff;fg=$("browse-header");ff=fg.cumulativeOffset().top+fg.getHeight();return z.viewport_dimensions().height-ff};key("pagedown",this.KEY_SCOPE,(function(ff){return function(fg){Event.extend(fg).preventDefault();return window.scrollBy(0,fd())}})(this));key("pageup",this.KEY_SCOPE,(function(ff){return function(fg){Event.extend(fg).preventDefault();return window.scrollBy(0,-1*fd())}})(this));fe=function(){var ff;ff=ci.in_search_mode()?bZ:ci;if(ci.files.length===0){return ff.show_empty()}else{return ff.hide_empty()}};document.observe(bu.ADD,(function(ff){return function(fi){var fh,fg,fk,fj;fj=fi.memo.files;for(fg=0,fk=fj.length;fg<fk;fg++){fh=fj[fg];ff.insert_file(fh,true)}return fe()}})(this));document.observe(bu.REMOVE,(function(ff){return function(fi){var fh,fg,fk,fj;fj=fi.memo.files;for(fg=0,fk=fj.length;fg<fk;fg++){fh=fj[fg];ff.remove_file(fh)}return fe()}})(this));document.observe(bu.MOVE,(function(ff){return function(fl){var fo,fm,fn,fp,fj,fg,fi,fh,fk;fm=ff.in_search_mode()&&bZ.sparky_search_ui_enabled;fi=fl.memo.files;fk=[];for(fj=0,fg=fi.length;fj<fg;fj++){fh=fi[fj],fo=fh[0],fp=fh[1];if(fm){if(fo!=null){fn=ff.get_file_pos(fo)}else{continue}}ff.remove_file(fo);ff.insert_file(fp);if(fm&&fn>=0){fk.push(ff.update_file_pos(fp,fn))}else{fk.push(void 0)}}return fk}})(this));fb=this.fire_visible_change_callbacks.bind(this);bv(window).on("resize",fb);this._last_visible_change_timeout_id=null;e0=(function(ff){return function(fg){clearTimeout(ff._last_visible_change_timeout_id);return ff._last_visible_change_timeout_id=setTimeout(fb,250)}})(this);return bv(window).on("scroll",e0)},add_subscribe_sfj_callback:function(T){return this.subscribe_sfj_callbacks[this.subsribe_sfj_count]=T},remove_sfj_callback:function(T){return delete this.subscribe_sfj_callbacks[T]},disable_sorting:function(){$("browse-sort").stopObserving("click");return $$("#browse-sort *").invoke("setStyle",{cursor:"default"})},enable_sorting:function(){$("browse-sort").stopObserving("click");$("browse-sort").on("click","#browse-sort a.sortable-column-header",this.sort_handler.bind(this));return $$("#browse-sort *").invoke("setStyle",{cursor:"pointer"})},click:function(e1,e3){var T,e2,e0;e0=$(e1.target);if(e0.match("a.filename-link")||e0.match("img.icon")||e0.up("a.filename-link")){this._click(e1,e3)}if(e0.match("a.parent-dir")){T=cH.from_elem(e3);if(T){e2={file_nsid:T.ns_id,file_sjid:T.sjid,firefly:bZ.firefly_enabled,match_type:T.match_type,position:T.sort_rank,request_id:T.request_id,viewport:"full-view",action_type:"click_path_link"};return a3.SearchClientActivityLogger.log("result_action",ci.active_user.id,e2)}}},dblclick:function(T,e0){if($(T.target).match("a")){return}return this._click(T,e0)},open_file:function(e2,T,e0){var e3,e1;if(e0==null){e0=false}e1={mode:"get",file_ext:av.file_extension_for_logging(e2.filename),file_bytes:e2.bytes};e3={file_nsid:e2.ns_id,file_sjid:e2.sjid,firefly:bZ.firefly_enabled,match_type:e2.match_type,position:e2.sort_rank,request_id:e2.request_id,viewport:e0?"dropdown-view":"full-view"};if(e2.dir){if(this.in_search_mode()||e0){e3.action_type="folder_open";a3.SearchClientActivityLogger.log("result_action",ci.active_user.id,e3)}if(T){return this.open_folder_in_new_window(e2)}else{return this.open_folder(e2)}}else{if(!T&&this.can_show_preview(e2)){if(this.in_search_mode()||e0){e3.action_type="file_view";a3.SearchClientActivityLogger.log("result_action",ci.active_user.id,e3)}return this.open_preview(e2,true,e0,e0)}else{if(this.in_search_mode()||e0){e3.action_type="file_view";a3.SearchClientActivityLogger.log("result_action",ci.active_user.id,e3)}a3.UserActivityLogger.log("web","file_view",e1);return window.open(e2.href,"_blank")}}},close_preview_callback:function(){bv(document).off("db:filepreview:close",this.close_preview_callback);document.stopObserving(aE.EXIT_SELECT_EVT,this.close_preview_callback);ad.close_shared_link_view();return ci.set_title()},open_preview:function(e0,e2,e3,e1,T){if(e2==null){e2=false}if(e3==null){e3=false}if(e1==null){e1=false}if(T==null){T=false}if(this.can_show_preview(e0)){aY.filepreview_from_selected("fileclick",e0,!e2,e3,e1,this.photopreview_ui_zoomzoom_enabled,T);bv(document).on("db:filepreview:close",this.close_preview_callback);return document.observe(aE.EXIT_SELECT_EVT,this.close_preview_callback)}},_click:function(e1,e2){var e0,T;this.keyboard_nav=false;e0=cH.from_elem(e2);if(e0.editing){return}T=(e1.which===2)||(dQ.is_mac()&&e1.metaKey);ci.open_file(e0,T);e1.preventDefault()},crumb_click:function(e2,T){var e1,e0;this.keyboard_nav=false;e2.preventDefault();e0=T.readAttribute("data-fq_path");e1=this.details_from_fq_path(e0);return aX.set_path_url(e1.ns_id,e1.ns_path)},parent_click:function(e3,e2){var e1,e4,T,e0;this.keyboard_nav=false;e3.preventDefault();e0=e2.readAttribute("data-parent_ns_path");T=parseInt(e2.readAttribute("data-parent_ns_id"),10);aX.set_path_url(T,e0);e1=cH.from_elem(e2);if(e1){e4={file_nsid:e1.ns_id,file_sjid:e1.sjid,firefly:bZ.firefly_enabled,match_type:e1.match_type,position:e1.sort_rank,request_id:e1.request_id,viewport:"full-view",action_type:"click_path_link"};return a3.SearchClientActivityLogger.log("result_action",ci.active_user.id,e4)}},selection_handler:function(){if(eG.get_selected_files().length){return $("browse-box").addClassName("selected")}else{return $("browse-box").removeClassName("selected")}},POST_SCROLL_WAIT:100,_last_scroll_timeout:null,window_scroll:function(){var T,e0,e2,e1;if(bZ.sparky_search_ui_enabled&&this.in_search_mode()&&!bZ.end_of_results){e1=aY.get_files_in_view(),e2=e1[0],e0=e1[1];T=this.files.length-(e2+e0);if(T<=50&&!$("browse").hasClassName("pending-search")){bZ.load_more_results()}}clearTimeout(this._last_scroll_timeout);return this._last_scroll_timeout=setTimeout(aY.load_visible_thumbs.bind(aY),this.POST_SCROLL_WAIT)},unscoped_search:function(){return bZ.search(false)},updateOffset:function(){if(!this.div_parent){return}this._cumulativeOffset=this.div_parent.cumulativeOffset();return this.viewportOffset()},reset_sort:function(){var e0,T;this.last_sort=at;T="#browse-sort a.sortable-column-header";e0=$$(T)[0];dQ.add_sort_arrow_mouseover(e0,true,T,false);$("kind-sorter-label").__date(db.DISPLAY.FILES_BY_KIND);return cm.src(e0.down("img"),"web","arrow-up-gray")},sort_handler:function(e6,e2,e5){var e0,e4,e3,T,e1;e2=$(e2);e2.blur();e1=e2.readAttribute("data-sort");if(e5!=null){}else{if(this.last_sort[0]===bj[e1]){e5=e2.readAttribute("data-ascending")==="false"}else{e5=e1!=="FILES_BY_MODIFIED"}}if(db.has_label(e1)){if(db.has_sort(this.last_sort[0])||this.show_shared_with){e3=db.next(e1,this.show_shared_with);e0=this.show_shared_with?"sharing-sorter-label":"kind-sorter-label";$(e0).__date(e3.display);e1=e3.label}e2.writeAttribute("data-sort",e1);e5=db.IS_ASC[e1]}else{e2.writeAttribute("data-ascending",(e5?"true":"false"))}T="#browse-sort a.sortable-column-header";dQ.add_sort_arrow_mouseover(e2,e5,T,true);e4=bj[e1];this.sort(e4,e5,e1);if(e6){return e6.stop()}},toggle_deleted:function(){var T;T=!aX.get_del();return aX.set_del_url(T)},unused_filename:function(fa,fd){var e1,fe,e2,e8,e9,e4,fb,e3,e6,e5,fg,fc,T,ff,e7,e0;if(fd==null){fd=false}fc=av.filename_without_extension(fa);fg=av.file_extension(fa,e1=true);e8=[];e7=ci.files;for(T=0,ff=e7.length;T<ff;T++){fe=e7[T];e5=av.filename_without_extension(fe.filename);e6=av.file_extension(fe.filename,e1=true);e4=e5.toLowerCase().indexOf(fc.toLowerCase())===0;e9=fg.toLowerCase()===e6.toLowerCase();e3=!fd||fe.dir;if(e4&&e9&&e3){e8.push(fe.filename.toLowerCase())}}if(fg){fg="."+fg}else{fg=""}e2=fc+fg;fb=1;while(true){if(e0=e2.toLowerCase(),bB.call(e8,e0)<0){break}e2=""+fc+" ("+fb+")"+fg;fb++}return e2},new_folder:function(){var fa,e2,e1,e3,e7,T,e0,e5,e8,e9,e4,e6;if(this.reloading||this.creating_folder){return}if(ci.sharing_create_and_share_new_folder_enabled&&!this.inside_shared_folder){e7=new aV(ci.active_user,{element_id:"create-and-share-new-folder-modal-"+ci.active_user.id,destination_dir:this.containing_fq_path()});e7.show();return}this.hide_empty();this.selectable();e1=this.unused_filename(el("New folder"),e8=true);e6=eV.tmpl("new_folder_tmpl",{name:e1,Sprite:cm,_:el});e3=-1;if(this.files.length){e4=z.scroll_offsets();if(e4.top>0){e9=this.files[0].get_div().getLayout().get("margin-box-height");e3=Math.floor(e4.top/e9)}}if(e3>0){this.files[e3].get_div().__sert({after:e6})}else{$("browse-files").__sert({top:e6})}T=$$("#browse-files .browse-new-folder .name").first();cz(T!=null,"expected new_folder_name to be defined");fa=this.containing_fq_path();e5=(function(fb){return function(fe){var fd,fc,ff;ff=fe.responseText.evalJSON(true);cz(ff.new_browse_files.length===1,"No new file data returned.");fd=av.filename(ff.new_browse_files.first().fq_path);fc=el("Created folder '%(folder_name)s'");fc=fc.format({folder_name:bK.em_snippet(fd,25)});ab.success(fc);fb.select_fq_paths=[ff.new_browse_files.first().fq_path];return fb.force_reload()}})(this);e0=(function(fb){return function(fd){var fc;fc=$$("#browse-files li.browse-new-folder").first();if(fc){fc.remove()}return fb.creating_folder=false}})(this);e2=new Ajax.InPlaceEditor(T,"/cmd/new"+(dQ.urlquote(fa)),{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:25,ajaxClass:Ajax.DBRequest,submitOnBlur:true,onFailure:function(){},onComplete:e0,savingText:el("Creating folder..."),onLeaveEditMode:this.unselectable,ajaxOptions:{method:"POST",onSuccess:e5,subject_user:ci.active_user},callback:(function(fb){return function(fc,fd){fb.creating_folder=true;return{to_path:fd||"",folder:"yes"}}})(this)});return e2.enterEditMode()},open_folder:function(e0){var e2,T,e1;cz(e0.dir,"Only open directories, not files");if(ci.inside_dir&&ci.containing_ns_path()===e0.ns_path&&!(this.in_search_mode()&&bZ.sparky_search_ui_enabled)){return}if(!(eG.get_selected_files().length===1&&eG.get_selected_files().indexOf(e0)===0)){eG.deselect_all();e2=e0.get_div();if(e2){e2.addClassName("file-select")}}clearTimeout(this.folder_loading_timeout);this.folder_loading_timeout=setTimeout((function(e3){return function(){var e4;e4=el("Loading %(filename)s...");e4=e4.format({filename:bK.em_snippet(e0.filename,50)});return e3.folder_loading_notification=ab.success(e4,60,true)}})(this),1000);if(e0.target_ns){T=e0.target_ns;e1=""}else{T=e0.ns_id;e1=e0.ns_path}if(e0.is_deleted){return aX.set_path_url(T,e1,true)}else{return aX.set_path_url(T,e1)}},open_folder_in_new_window:function(T){return window.open(aX._make_url(T.ns_id,T.ns_path),"_blank")},show_message:function(e1){var e0,T;if((typeof e1)!==(typeof"string")){T=$("browse-files").down(".browse-message");if(T){T.show()}return}this.msg=e1;e0=new Element("div",{"class":"browse-message"});e0.__date(e1);return $("browse-files").__sert(e0)},sort:function(e0,e3,T,e2){var e1;if(!e2&&e0===this.last_sort[0]&&e3===this.last_sort[1]){return}this.last_sort=[e0,e3,T];e1=e0(e3);this.files.sort(e1);this.smartfill();aY.load_visible_thumbs();return this.fire_visible_change_callbacks()},resort:function(){var e2,T,e1,e0;T=this.last_sort;e1=T[0];e2=T[1];e0=T[2];return this.sort(e1,e2,e0,true)},in_search_mode:function(){return bv("#browse").hasClass("search")},flex_column:function(){if(this.show_shared_with){return $("sharing-sorter").readAttribute("data-sort")}else{return $("kind-sorter").readAttribute("data-sort")}},smartfill:function(){var e0,e3,e1,e4,e2,e6,T,e5;e0=$("browse-files");e2=[];e4=this.in_search_mode();e5=this.files;for(e6=0,T=e5.length;e6<T;e6++){e3=e5[e6];e1=this.flex_column();e2.push(this.compiled_tmpl({file:e3,in_search_mode:e4,flex_column:e1,sharing_growth_experiments_variant:ci.sharing_growth_experiments_variant,share_link_icon_src:aY.get_shared_link_icon(),Browse:ci,Sprite:cm,Constants:Constants,FilePath:av,Emstring:bK,_:el}))}e0.__date(e2);document.fire(this.RENDER_EVT);return bv(document).trigger(this.RENDER_EVT)},search_smartfill:function(e7,e1){var T,e6,e4,e0,e3,e2,e5;if(e1==null){e1=null}e3=[];for(e2=0,e5=e7.length;e2<e5;e2++){e6=e7[e2];e0=aY.make_browsefile(e6,e1);e0.track_in_browse();e4=this.compiled_search_tmpl({file:e0,sharing_growth_experiments_variant:ci.sharing_growth_experiments_variant,share_link_icon_src:aY.get_shared_link_icon(),BrowseInterface:eX,Browse:ci,Sprite:cm,Constants:Constants,_:el,searchHelpers:ak,HTML:eV,FilePath:av,Emstring:bK,Util:dQ});T=bv(e4.toHTML());e3.push(T)}bv("#browse-files").append(e3);document.fire(this.RENDER_EVT);bv(document).trigger(this.RENDER_EVT);aY.load_visible_thumbs();return this.fire_visible_change_callbacks()},add_file:function(T){this.files.push(T);if(T.target_ns){ci.ns_id_to_mount_point[T.target_ns]=T.fq_path}if(T.bytes<0){return this.deleted_shown=true}},insert_file:function(e1,e0){var T;if(!e1){return}e0=e0||0;T=this.find_file(e1.fq_path);if(T&&T!==e1){this.remove_file(T)}cH._file_index[e1.to_key()]=e1;this.update_file_pos(e1);if(e0){e1.get_div().setStyle({display:"none"})}return document.fire(this.RENDER_EVT)},add_files:function(T){return ci._push_files(T.file_info)},get_file_pos:function(T){var e0;e0=this.files.indexOf(T);cz(e0!==-1,"file not present in @files");cz(T.to_key() in cH._file_index,"file not present in BrowseFile._file_index");return e0},remove_file:function(T){var e1,e0;if(!T){return}e1=this.files.indexOf(T);if(e1!==-1){this.files.splice(e1,1);delete cH._file_index[T.to_key()];return(e0=T.get_div())!=null?e0.remove():void 0}},update_file_pos:function(e4,e6){var T,e8,e2,e3,e5,e1,e0,e7;if(e6==null){e6=-1}e7=this.files.indexOf(e4);if(e7!==-1){this.files.splice(e7,1)}delete e4.sort_rank;e1=this.last_sort[0];e5=this.last_sort[1];if(e6>=0){e7=e6}e3=this.in_search_mode()&&bZ.sparky_search_ui_enabled?e7:dQ.bsearch(this.files,e4,e1(e5),true);this.files.splice(e3,0,e4);e2=e4.get_div();T=$("browse-files");if(e2){e2.remove()}if(this.in_search_mode()&&bZ.sparky_search_ui_enabled){e0=this.compiled_search_tmpl({file:e4,Browse:ci,BrowseInterface:eX,Constants:Constants,Emstring:bK,FilePath:av,HTML:eV,Search:__CIRCULAR_DEPENDENCY__.Search,Sprite:cm,Util:dQ,_:el})}else{e0=this.compiled_tmpl({file:e4,in_search_mode:this.in_search_mode(),flex_column:this.flex_column(),sharing_growth_experiments_variant:ci.sharing_growth_experiments_variant,share_link_icon_src:aY.get_shared_link_icon(),Browse:ci,Constants:Constants,Emstring:bK,FilePath:av,Sprite:cm,_:el})}e8=T.childElements();if(e3<e8.length){return T.childElements()[e3].__sert({before:e0})}else{return T.__sert(e0)}},find_file:function(T){return this.files.find(function(e0){return e0.fq_path.toLowerCase()===T.toLowerCase()})},reset_state:function(){this.msg=false;this.dragging=false;this.files=[];this.selected_files=[];this.selection=[];cH._file_index={};return bH._body_dragend()},clear:function(){$("browse-files").__date();this.hide_empty();return bZ.hide_empty()},show_empty:function(){var T;this.hide_empty();if(bv("#browse-empty-team-folder").length&&this.inside_team_folder&&!this.is_in_subfolder_of_team_folder()){T="#browse-empty-team-folder"}else{T="#browse-empty"}bv(""+T+" .drag-prompt").toggle(!this.is_read_only);if(!(ci.in_search_mode()&&bZ.sparky_search_ui_enabled)){return bv(T).show()}},hide_empty:function(){return bv("#browse-empty, #browse-empty-team-folder").hide()},update:function(T,e0){if(e0==null){e0=null}$("browse-box").show();if(bZ.sparky_search_ui_enabled&&this.in_search_mode()){return this.search_smartfill(T.file_info,e0)}else{this.clear();if(typeof T==="string"){T=JSON.parse(T)}this.setup(T,e0);this.resort();document.fire(this.UPDATE_EVT);return bv(document).trigger(this.UPDATE_EVT)}},show_inline_sharing_on_browse_exp:function(){var e1,e4,e0,e3,T,e2;if(!ci.show_inline_share){return}if(this.in_search_mode()){bv("#browse-box").removeClass("show-inline-share");return}bv("#browse-box").addClass("show-inline-share");e2=ci.files;for(e3=0,T=e2.length;e3<T;e3++){e1=e2[e3];e0=bv(e1.get_div()).find(".sharing");e0.find(".recipients").off().on("click",eG.recipients_click);if((e1.is_shared_folder()||e1.could_be_shared_folder())&&!(e1.read_only||e1.is_read_only_mount)){e4=el("Who do you want to collaborate on this folder with?")}else{if(e1.type===bX.FOLDER){e4=el("Who do you want to send this folder to?")}else{e4=el("Who do you want to send this file to?")}}e0.find(".recipients").attr("placeholder",e4);e0.find(".get-link").off().on("click",eG.link_click)}if(!this.show_sharing_init_done){this.show_sharing_init_done=true;return aS.init()}},reset_browse_exp:function(){var T;T=bv("#browse-inline-autocomplete");T.hide().off();bv("#browse-sort").append(T);return bv("#browse-box").removeClass("dropdown-menu-open")},reload_fqpath:function(e0,T){return this.reload(null,dQ.urlquote(e0),T)},force_reload:function(){return this.reload(this.containing_ns_id(),dQ.urlquote(this.containing_ns_path()),true)},set_title:function(){var T;if(ci.in_search_mode()){bZ.set_title();return}if(!ci.inside_dir){return}T=this.containing_fq_path();return document.title=T?av.filename(T)+" - Dropbox":cB.get_viewer().is_paired&&ci.active_user.role===Constants.ROLE_WORK?cB.get_viewer().team_name+" - Dropbox":cB.get_viewer().is_paired&&ci.active_user.role===Constants.ROLE_PERSONAL?el("Personal")+" - Dropbox":el("Home")+" - Dropbox"},set_selection_from_fq_paths_or_index:function(e7){var e1,e0,e5,e4,T,e2,e3,e6;T=e7.select_fq_paths;e2=e7.select_index;if(T||e2>-1){e0=[];if(T){for(e3=0,e6=T.length;e3<e6;e3++){e5=T[e3];e4=this.find_file(e5);if(e4){e0.push(e4)}}}if(!e0.length&&e2>-1){e1=this.files[e2];if(e1){e0.push(e1)}}if(e0.length){eG.set_selected_files(e0);this.scrollToWithPadding(e0.first().get_div(),100)}e7.select_fq_paths=false;return e7.select_index=-1}else{if(!bZ.sparky_search_ui_enabled){return window.scrollTo(0,0)}}},set_selection_from_item_counters:function(){var e0,e6,e3,e8,e4,e2,e7,T,e5,e1;if(this.select_item_counters!=null){e3={};e5=this.select_item_counters;for(e4=0,e7=e5.length;e4<e7;e4++){e6=e5[e4];e3[e6]=true}e8=[];e1=this.files;for(e2=0,T=e1.length;e2<T;e2++){e0=e1[e2];if(e0.root_coll_item_counter in e3){e8.push(e0)}}eG.set_selected_files(e8);return this.select_item_counters=null}},reload:function(e2,e7,e0){var e9,e3,e8,e1,e5,e4,e6,T;e1="Browse.reload ns_path contains an invalid character: # ; ? : @ & = + $ (ns_path = "+e7+")";cz(e7.search(eo.URL_ESCAPE_REGEX)===-1,e1);if(e2==null){e2=ci.active_user.root_ns}e7=av.normalize(e7);if(aY.get_mode()!==aY.BROWSE_MODE){this.clear();aY.set_browse_mode()}if(bZ._clear_on_reload){bZ.clear_searchbox()}if(!al.uploading){cP.hide()}this._stop_pagination();if(this.reloading){return}if(this.inside_dir&&e7===this.containing_ns_path()&&e2===this.containing_ns_id()&&!e0){return}e6=this.first_load?Constants.referrer:"";e8=this.deleted_shown?"?show_deleted=yes":"";e4={ns_id:e2,referrer:e6,delays_parent_request_rendering:this.first_load,sort_label:this.last_sort[2],sort_is_ascending:this.last_sort[1],sort_folders_first:bj.FOLDERS_FIRST};e4=Object.extend(e4,this.extra_reload_args);es("Browse.reload:",e7);this.reloading=true;T="/browse"+e7+e8;e9=2;e3=["browse",e2,e7,e8,ci.active_user.id,e9];e5=(function(fa){return function(fb){fa.reset_state();fa.update(fb);(fa.files.length?fa.hide_empty.bind(fa):fa.show_empty.bind(fa))();clearTimeout(fa.folder_loading_timeout);if(ab.isShown()&&ab.current()===fa.folder_loading_notification){ab.clear()}z.scroll_clear_cache();fa.set_selection_from_fq_paths_or_index(ci);if(!l.shown()){return fa.set_title()}}})(this);new Ajax.DBRequest(T,{allow_retries:true,subject_user:ci.active_user,parameters:e4,log_timing:true,on304:(function(fa){return function(fb){}})(this),onSuccess:(function(fa){return function(fg){var fe,fb,fj,fc,ff,fi,fd,fh;if(fa.in_search_mode()){return}fj=JSON.parse(fg.responseText);fi=null;ff=null;e5(fj);if(fi){fc=[];for(fd=0,fh=fi.length;fd<fh;fd++){fe=fi[fd];fc.push(ci.find_file(fe.fq_path))}eG.set_selected_files(fc);window.scrollTo(ff[0],ff[1])}else{ci.set_selection_from_item_counters()}if(ci.sharing_autoselect_first_file_enabled&&!eG.has_selected_files()){fb=fa.files[0];return eG.set_selected_files([fb])}}})(this),onFailure:(function(fa){return function(){aE.update_with_error();if(fa.first_load){fa.reload.bind(fa).defer(Constants.root_ns,"")}return clearTimeout(fa.folder_loading_timeout)}})(this),cleanUp:(function(fa){return function(){fa.first_load=false;return fa.reloading=false}})(this),no_feed_reload:true,evalJSON:false});return true},is_in_subfolder_of_shared_folder:function(){return ci.inside_shared_folder&&ci.containing_ns_path()},is_in_subfolder_of_team_folder:function(){return ci.inside_team_folder&&ci.containing_ns_path()},is_shmodelable_path:function(T){var e0;if(ci.public_app_token){return false}if(T===""){return false}if(ci.public_folder_enabled){e0=T.toLowerCase();if(e0.startsWith("/public/")){return false}}return true},can_show_preview:function(e0){var T,e2,e1;T=this.browser_supports_previews||((e1=e0.preview_type)==="photo"||e1==="video");e2=e0.preview_type==="video"&&Constants.DISABLE_VIDEOS_IN_LIGHTBOX;return !e2&&T},can_get_details_from_fq_path:function(e1){var e0,T;e0=this.containing_fq_path();T=this.containing_mount_point();return(T&&e1.startsWith(T))||e0.startsWith(e1)},details_from_fq_path:function(e2){var e3,e0,T,e1;cz(this.can_get_details_from_fq_path(e2));e0=this.containing_mount_point();if(e0&&e2.startsWith(e0)){T=this.containing_ns_id();e1=e2.slice(e0.length);e3=av.filename(e2,this._get_root_name())}else{T=Constants.root_ns;e1=e2;e3=av.filename(e2,this._get_root_name())}return{ns_id:T,ns_path:e1,fq_path:e2,folder_name:e3||this._get_root_name(),url:String(eX.browse_uri_for_fq_path(ci.active_user,e2)),icon:(e2.length?"folder_32":this._get_root_icon())}},update_header_status:function(T){return bv("#browse-header-status").text(T)},update_header_height:function(){var e0,e2,e1,T;e2=bv("#browse-header");e0=bv("#browse-files");T=0;if(e2.css("position")==="fixed"){T=bv(window).scrollTop()}if(!z.is_page_scrollable()){T=Math.abs(parseFloat(bv("html").css("top"))||0)}e1=e2.offset().top+e2.height()-e0.offset().top-T;return e0.css("padding-top",e1)},_make_breadcrumbs_data:function(){var e4,e5,e0,e3,T,e2,e1;e5=this.containing_fq_path();e4=[];T=e5.split("/");for(e0=e2=0,e1=T.length;0<=e1?e2<e1:e2>e1;e0=0<=e1?++e2:--e2){e3=av.normalize(T.slice(0,e0+1).join("/"));e4.push(this.details_from_fq_path(e3))}return e4},_get_root_icon:function(){if(!cB.get_viewer().is_paired){return"glyph"}if(ci.active_user.role===Constants.ROLE_WORK){return"work_icon"}else{if(ci.active_user.role===Constants.ROLE_PERSONAL){return"personal_icon"}}},_get_root_name:function(){return cB.get_root_name(ci.active_user)},_get_max_breadcrumb_width:function(e2){var e0,e1,T;e1=e2?this._DROPDOWN_WIDTH:new bK(this._get_root_name()).length;if(this.use_shorter_breadcrumbs){e0=bv("#browse-rightmenu").width();T=bv("#browse-global-actions-bar").width();return((T-e0)*this._FUDGE_FACTOR/this._PX_TO_EM)-e1}else{return this._MAX_BREADCRUMB_WIDTH-e1}},_PX_TO_EM:16,_FUDGE_FACTOR:0.75,_DROPDOWN_WIDTH:2.625,_MAX_BREADCRUMB_WIDTH:20,_CONNECT_WIDTH:1.64,breadcrumb:function(){var e8,e0,e2,e9,e5,e7,T,fa,e6,e1,e3,e4;e0=this._make_breadcrumbs_data();e1=e0.collect(function(fb){return new bK(fb.fq_path?fb.folder_name:"").length});e6=0;e2=0;cz(e0.length>0,"expected at least one breadcrumb");fa=this._get_max_breadcrumb_width();for(e5=e3=e4=e0.length-1;e4<=0?e3<=0:e3>=0;e5=e4<=0?++e3:--e3){e6+=e1[e5];if(e6>fa){break}e2+=1;e6+=this._CONNECT_WIDTH}e9=e0.slice(0,e0.length-Math.max(1,e2));e0=e0.slice(e9.length,e0.length);if(!e9.length&&e0.length>1){e0.shift()}e7=e0.pop();e8=eV.tmpl("breadcrumb_tmpl",{breadcrumbs:e0,dropdown:e9,containing_fq_path:this.containing_fq_path(),url_root:eX.get_browse_root(ci.active_user),root_name:this._get_root_name(),Sprite:cm});T=e7.folder_name;if(e7.fq_path!==""){T=bK.em_snippet(T,this._get_max_breadcrumb_width(e9.length>1))}$("browse-location").__date(e8);$("browse-location").__sert(" "+T);if(e9.length>1){return this._render_breadcrumbs_dropdown(e9)}},_render_breadcrumbs_dropdown:function(e3){var T,e1,e0,e2;T=$("breadcrumbs-box");e3.reverse();e0=eV.tmpl("breadcrumb_li_tmpl",{breadcrumbs:e3,Sprite:cm,Emstring:bK});$("browse-location").__sert(e0);e1=$("breadcrumb-dropdown");e2=(function(e4){return function(e6){var e5;e6.stopPropagation();e1.show();e5=bv(T);return bv(e1).clonePosition(e5,{setWidth:0,setHeight:0,offsetTop:e5[0].offsetHeight,offsetLeft:parseInt(e5.css("padding-left"),10)})}})(this);T.observe("click",e2);T.observe("dragover",e2);return document.observe("click",(function(e4){return function(){T.removeClassName("down");return e1.hide()}})(this))},viewportOffset:function(){var T,e1,e0;if(!this.files.length){return}if(!this.div_parent){e1=this.files[0].get_div().offsetParent;if(!e1){return}this._viewportOffset={};this.div_parent=$(e1);this._cumulativeOffset=this.div_parent.cumulativeOffset()}T=dQ.scrollLeft(this.div_parent);e0=dQ.scrollTop(this.div_parent);if(!this.scrollTop||!this.scrollLeft||this.scrollTop!==e0||this.scrollLeft!==T){this._viewportOffset.top=this._cumulativeOffset.top-e0;this._viewportOffset.left=this._cumulativeOffset.left-T;this.scrollLeft=T;this.scrollTop=e0}return this._viewportOffset},selectable:function(){return dQ.enableSelection($("browse-files"))},unselectable:function(){return dQ.disableSelection($("browse-files"))},_header_offset:(function(){var T;T=$("browse-header");return T.getHeight()+T.cumulativeOffset().top}).cached(1000),scrollTo:function(T){return this.scrollToWithPadding(T,3)},scrollToWithPadding:function(e2,e4){var e1,e5,e0,e3,T;if(!e2){return}e3=z.viewport_dimensions();T=z.scroll_offsets();e5=e2.cumulativeOffset().top-T.top;e1=e2.getHeight();e0=this._header_offset();if(e5<e0){z.scroll_to(0,T.top+e5-e0-e4)}else{if(e5+e1>e3.height){z.scroll_to(0,T.top+e5+e1-e3.height+e4)}}if($("modal-overlay").visible()&&$("modal").getStyle("position")==="absolute"){return eS.fix_position()}},_visible_change_callbacks:{},_next_visible_change_callback_id:0,add_visible_change_callback:function(T){this._visible_change_callbacks[this._next_visible_change_callback_id]=T;return this._next_visible_change_callback_id++},remove_visible_change_callback:function(T){return delete this._visible_change_callbacks[T]},fire_visible_change_callbacks:function(){var e1,e5,e2,e4,e3,T,e0;if(!bv.isEmptyObject(this._visible_change_callbacks)){e3=aY.get_files_in_view(),e4=e3[0],e1=e3[1];T=this._visible_change_callbacks;e0=[];for(e2 in T){e5=T[e2];e0.push(e5(this.files,this.active_user.id,e4,e1))}return e0}}};j=B.BrowseUpdate=(function(){var T,e6,e5,e2,e4,e3,e1,e0;e1=function(e8){var e9,fa,e7;if(!ci.inside_dir){return}fa=e8.parent_changes;if(fa.change_to_fq_path!=null){if(fa.change_type==="moved"){if(fa.is_changing_view){e9=el("The folder '%s' has been moved. <a href=\"/home%s\">View</a>");e9=e9.format(fa.old_fq_path.escapeHTML(),dQ.urlquote(fa.new_fq_path))}else{e9=el("This folder has been moved")}}else{if(fa.change_type==="renamed"){if(fa.is_changing_view){e9=el("The folder '%s' has been renamed. <a href=\"/home%s\">View</a>");e9=e9.format(fa.old_fq_path.escapeHTML(),dQ.urlquote(fa.new_fq_path))}else{e9=el("This folder has been renamed to '%s'.");e7=fa.change_to_fq_path.split("/");e9=e9.format(e7[e7.length-1].escapeHTML())}}else{e9=el("The folder '%s' has been deleted.");e9=e9.format(fa.old_fq_path.escapeHTML())}}if(fa.is_changing_view){ab.error(new eV(e9))}else{if(fa.old_fq_path===ci.containing_fq_path()){ab.success(new eV(e9))}}ci.reload_fqpath(fa.change_to_fq_path);return}return e3(e8)};e0=function(fc){var e8,ff,fe,e7,fh,fd,fa,fg,fb,e9;ff=[];fd=[];if(!ci.in_search_mode()){return}bZ.clear_cache();for(e7 in ci.ns_id_to_mount_point){if(!(e7 in fc.mount_points)){fc.mount_points[e7]=null}}fb=fc.mount_points;for(e7 in fb){fe=fb[e7];e7=parseInt(e7,10);fh=ci.ns_id_to_mount_point[e7];if(fe===fh){continue}if(fe){ci.ns_id_to_mount_point[e7]=fe}else{delete ci.ns_id_to_mount_point[e7]}e9=ci.files;for(fa=0,fg=e9.length;fa<fg;fa++){e8=e9[fa];if(e8.fq_path.indexOf(fh)===0&&e8.target_ns!==e7){if(fe){e8.fq_path=fe+e8.fq_path.slice(fh.length);e8.href=eX.get_browse_root(ci.active_user)+fe+e8.href.slice(5+fh.length);ff.push([e8,e8])}else{fd.push(e8)}}}}return e3(fc,[],fd,ff)};e3=function(fu,ff,fo,fe){var fj,fd,fp,fk,fn,fg,fm,fl,fr,fh,fa,e8,e7,fq,ft,fs,fi,fc,fb,e9;if(ff==null){ff=[]}if(fo==null){fo=[]}if(fe==null){fe=[]}fi=fu.added;for(fa=0,fq=fi.length;fa<fq;fa++){fp=fi[fa];fd=av.normalize(av.parent_dir(fp.ns_path));if(ci.in_search_mode()||(fp.ns_id===ci.containing_ns_id()&&fd===ci.containing_ns_path())){fj=aY.make_browsefile(fp);fj.track_in_browse();ff.push(fj)}}fc=fu.removed;for(e8=0,ft=fc.length;e8<ft;e8++){fk=fc[e8];fo.push(ci.find_file(fk))}fb=fu.moved;for(e7=0,fs=fb.length;e7<fs;e7++){e9=fb[e7],fn=e9[0],fh=e9[1];fr=av.normalize(av.parent_dir(fh.ns_path));fl=null;fm=ci.in_search_mode()||(fh.ns_id===ci.containing_ns_id()&&fr===ci.containing_ns_path());fg=ci.in_search_mode()&&bZ.sparky_search_ui_enabled;if(fm&&!(fg&&ci.find_file(fh.ns_path))){fl=aY.make_browsefile(fh);fl.track_in_browse()}fe.push([ci.find_file(fn),fl])}document.fire(bu.ADD,{files:ff});bv(document).trigger(bu.ADD,{files:ff});document.fire(bu.MOVE,{files:fe});aY.load_visible_thumbs();ci.fire_visible_change_callbacks();return e4(ff,fo,fe)};T=function(fa,e8,e9,e7){fa.css("background","");bv(document).trigger("db:browse:update_rendered");return document.fire(bu.REMOVE,{files:e9})};e4=function(fh,fg,fi){var e9,fk,fe,fl,fd,fc,fa,fj,e8,e7,ff,fb;fe=(fh.length+fg.length)<=10;for(fd=0,fj=fh.length;fd<fj;fd++){e9=fh[fd];if(!(e9&&e9.get_div())){continue}e6(e9,fe,fh,fg,fi)}for(fc=0,e8=fg.length;fc<e8;fc++){e9=fg[fc];if(!(e9&&e9.get_div())){continue}e2(e9,fe,fh,fg,fi)}fb=[];for(fa=0,e7=fi.length;fa<e7;fa++){ff=fi[fa],fk=ff[0],fl=ff[1];if(fk){e2(fk,fe,fh,fg,fi)}if(fl){fb.push(e6(fl,fe,fh,fg,fi))}else{fb.push(void 0)}}return fb};e5=function(e7){var e8;e8=eG.is_selected(e7)?"#83B8DC":"#CCEAFF";return bv(e7.get_div()).css("background-color",e8)};e2=function(e7,fa,e9,fb,e8){var fc;e5(e7);fc=bv(e7.get_div());if(fa){return fc.show().slideUp("normal",function(){return T(fc,e9,fb,e8)})}else{fc.hide();return T(fc,e9,fb,e8)}};e6=function(e7,fa,e9,fb,e8){var fc;e5(e7);fc=bv(e7.get_div());if(fa){return fc.hide().slideDown("normal",function(){return T(fc,e9,fb,e8)})}else{fc.show();return T(fc,e9,fb,e8)}};return{init:function(){var e9,e8,e7;e7=O[ci.active_user.id];e9=(function(fa){return function(){return aE.refresh_file_list(ci.files)}})(this);document.observe(ci.UPDATE_EVT,e9);return e8=e7.subscribe_sfj({name:"BrowseUpdater",handler:function(){var fi,fd,ff,fh,fe,fj,fc,fb,fa,fg;fj=ci.in_search_mode();fi=fj?e0:e1;fa=fj?"/update/list_search":"/update/list_dir";if(!(ci.inside_dir||fj)){e7.handler_failure(e8);return}if(fj){fb=bZ.get_state();if(fb.is_advanced){fe=fb}else{fe={all_terms:fb.query}}}else{fe={fq_dir:ci.containing_fq_path(),show_deleted:ci.deleted_shown}}fe.ns_map=((function(){var fl,fk;fl=e7.get_ns_map();fk=[];for(fh in fl){fc=fl[fh];fk.push(""+fh+"_"+fc)}return fk})()).join(",");cz(ci.active_user,"No active_user was set before calling "+fa+". Active user loaded? "+(__CIRCULAR_DEPENDENCY__.active_user_loaded||false)+". Error before loading? "+(__CIRCULAR_DEPENDENCY__.an_error_happened_before_loading||false)+". Error after loading? "+(__CIRCULAR_DEPENDENCY__.an_error_happened_after_loading||false)+".",true,[],false);fg=ci.subscribe_sfj_callbacks;for(ff in fg){fd=fg[ff];fd()}return new bv.ajax(fa,{data:fe,dataType:"json",type:"POST",subject_user:ci.active_user,success:(function(fk){return function(fl){fi(fl);return e7.handler_success(e8,{ns_map:fl.ns_map})}})(this),error:function(){return e7.handler_failure(e8)}})}})}}})();var aC;aC=B.FileEvents={DELETE:"db:bulk_delete",COPY:"db:bulk_copy",MOVE:"db:bulk_move",RENAME:"db:bulk_rename",PURGE:"db:bulk_purge",RESTORE:"db:bulk_restore",UPLOAD:"db:upload",SF_NEW:"db:sf_new",SF_LEAVE:"db:sf_leave",SF_UNSHARE:"db:sf_unshare",SF_REJOIN:"db:sf_rejoin",SF_INVITE:"db:sf_invite",SF_IGNORE:"db:sf_ignore",LINKS_REMOVE:"db:link_remove",LINKS_ADD:"db:link_add"};var dX;dX=B.ProgressWatcher={job_info:{},INIT_POLL_INT:1000,FAILS_MEAN_FAIL:3,MODAL_WAIT_MS:1000,watch:function(T,e3){var e2,e1,e0;if(T.async_task_id){if(!T.async_task_id.match(/^[A-Za-z0-9_\-=]*$/)){return}e1=T.async_task_id}else{e1=T.job_id}dX.job_info[e1]={};e2=dX.job_info[e1];e2.subject_user=T.subject_user||((e0=T.parameters)!=null?e0[Constants.UID_PARAM_NAME]:void 0);e2.req=T;e2.is_async_task=!!T.async_task_id;e2.poll_int=dX.INIT_POLL_INT;e2.poll_count=0;e2.int_id=setInterval(dX.update_for(e1),e2.poll_int);e2.failures=0;e2.start_time=bU.time();return e2.dont_hide=e3},update_for:function(T){return function(){return dX.update(T)}},backoff:function(e0){var T;T=dX.job_info[e0];clearInterval(T.int_id);T.poll_int=Math.min(Math.floor(T.poll_int*1.5),30000);return T.int_id=setInterval(dX.update_for(e0),T.poll_int)},update:function(e1){var T,e0;e0=dX.job_info[e1];if(c6.peek(e1)){return dX.done(e1)}e0.poll_count++;if(e0.poll_count%10===0){dX.backoff(e1)}if(!e0.modaled&&bU.time()-e0.start_time>dX.MODAL_WAIT_MS){T=e0.req.options;em.show(T.progress_text);T.onProgress=em.update;if(T.on_modal_shown!=null){T.on_modal_shown()}e0.modaled=true}if(e0.is_async_task){return dX.get_async_task_status(e1)}else{return dX.get_job_status(e1)}},get_job_status:function(T){return new Ajax.DBRequest("/job_status/"+T,{method:"post",subject_user:dX.job_info[T].subject_user,onSuccess:function(e1){var e2,e0;e2=dX.job_info[T];e0=e1.responseText;if(e0.indexOf("err")===0){dX.done(T);if(e2.req.options.onFailure&&!c6.handled(T)){e2.req.options.onFailure(e1)}return}if(e0.indexOf("done")===0){e2.req.options.job=false;if(!c6.peek(T)){new Ajax.Request("/job_results/"+T,{method:"post",parameters:{t:bo.read(Constants.JS_CSRF_COOKIE)},onSuccess:function(e4){if(c6.handled(T)){return}am.clearWorkingMessage();if(e2.req.options.onSuccess){return e2.req.options.onSuccess(e4)}},onFailure:function(e4){if(c6.handled(T)){return}am.clearWorkingMessage();if(e2.req.options.onFailure){return e2.req.options.onFailure(e4)}}})}return dX.done(T)}else{try{if(e2.req.options.onProgress){return e2.req.options.onProgress(e1.responseText)}}catch(e3){}}},onFailure:function(e0){var e1;e1=dX.job_info[T];e1.failures++;if(e1.failures>=dX.FAILS_MEAN_FAIL){if(e1.req.options.onFailure){e1.req.options.onFailure(e0,true)}am.remove(e1.req);return dX.done(T)}}})},get_async_task_status:function(T){return new Ajax.DBRequest("/async_task_status/"+T,{method:"post",subject_user:dX.job_info[T].subject_user,onSuccess:function(e1){var e2,e0;e2=dX.job_info[T];e0=e1.responseText;if(e0.indexOf("done:")===0||e0.indexOf("err:")===0){c6.handled(T);am.clearWorkingMessage();if(e0.indexOf("done:")===0){e1.responseText=e0.substr(5)}if(e2.req.options.onSuccess){e2.req.options.onSuccess(e1)}if(e2.req.options.onComplete){e2.req.options.onComplete(e1)}return dX.done(T)}else{if(e0.indexOf("async_task_err:")===0){ab.error(new eV(e0.substr(15)));c6.handled(T);am.clearWorkingMessage();dX.done(T);return ci.force_reload()}else{try{if(e2.req.options.onProgress){return e2.req.options.onProgress(e1.responseText)}}catch(e3){}}}},onFailure:function(e0){var e1;e1=dX.job_info[T];e1.failures++;if(e1.failures>=dX.FAILS_MEAN_FAIL){try{if(e1.req.options.onFailure){e1.req.options.onFailure(e0,true)}}catch(e2){}am.remove(e1.req);return dX.done(T)}}})},done:function(e0){var T;T=dX.job_info[e0];clearInterval(T.int_id);if(!T.dont_hide){delete dX.job_info[e0];if(!(T.req.async_task_id&&T.req.async_task_id!==e0)){return em.hide(e0)}}else{return em.update("1/1")}}};var dd,bO,bt,bB=[].indexOf||function(e1){for(var e0=0,T=this.length;e0<T;e0++){if(e0 in this&&this[e0]===e1){return e0}}return -1};bt=B.NamespaceEvents=(function(){function T(e0){this.ns_id=e0;this.earliest=Number.MAX_VALUE;this.events=[];this.seen={};this.done=false}return T})();dd=B.EventDatePicker=(function(){function T(e1){var e0,e2,e3;this.on_change=e1;bv(document.body).on("click",(function(e4){return function(e5){return e4.hide_calendar(e5)}})(this));e3=new Element("div",{id:"cal_container"});bv(e3).bind("click",function(e4){return e4.preventDefault()});bv(document.body).append(e3);this.calendar=new F("cal_container",{onDateChange:(function(e4){return function(e5){return e4.on_change(e5)}})(this),disable_future:true});bv(e3).css("position","fixed");e2=bv("#cal_date");e0=bv("#cal_container");e0.clonePosition(e2,{setWidth:false,setHeight:false,offsetTop:e2.height(),offsetLeft:e2.width()-e0.children().first()[0].offsetWidth});this.hide_calendar()}T.prototype.show_calendar=function(e0){if(this.shown){bv("#cal_container").hide();this.shown=false;return}bv("#cal_container").show();return this.shown=true};T.prototype.hide_calendar=function(e0){if(e0&&bv(e0.target).closest("#cal_date").length>0){return}bv("#cal_container").hide();this.shown=false;return true};return T})();bO=INLINE_JS.Events=B.Events={ns:null,role:"all",now:Number(new Date()),timestamp:dQ.start_of_day(new Date(Number(new Date())+60*60*24*1000)),request_in_flight:false,one_day:60*60*24*1000,user_navigated_away:false,init:function(T,e4,e6,e1,e5){var e2,e3,e0;if(e5==null){e5=false}e0=eo.deconstruct_url();this.first_event_map=T;this.roles=e4;this.rss_data=e6;this.role_has_events=e1;this.for_deleted_files_page=e5;this.role_picker=bv("#role-selector").controller();if(this.roles.length===1){this.role=this.roles[0].role}else{if(e0.qargs.role){this.role=e0.qargs.role;this.role_picker.set_state(this.role)}}this.date_picker=new dd((function(e7){return function(e8){e7.change_date(e8);e7.set_url();return a3.WebMiscActivityLogger.log("filter_events_date")}})(this));this._init_state();this.role_picker.on_state_change=(function(e7){return function(){e7.role=e7.role_picker.get_state();if(e7.ns&&!$u(e7.valid_roles()).any(function(e8){return e8.ns_ids.contains(e7.ns.ns_id)})){e7.ns=null;aK.set_selected_by_value(bv("#namespace-list")[0],"false")}e7.set_url();return e7.get_more(true)}})(this);bF.set_during_login_callback((function(e7){return function(e9,e8){return window.location.reload()}})(this));bv(window).bind("beforeunload",(function(e7){return function(){e7.user_navigated_away=true;return void 0}})(this));if(bv("#namespace-list-container")[0]){bv("#namespace-list-container")[0].observe("db:change",(function(e7){return function(e8){e7.ns=e7.namespaces[JSON.parse(e8.memo)];e7.set_url();e7.get_more(true);return a3.WebMiscActivityLogger.log("filter_events_shared_folder")}})(this))}bv(window).on("scroll",(function(e7){return function(){document.body.scrollTop=Math.min(document.body.scrollTop,document.body.scrollHeight-z.viewport_dimensions().height-10);return e7.get_more()}})(this));if(e0.qargs.ns){aK.set_selected_by_value(bv("#namespace-list")[0],e0.qargs.ns);this.ns=this.namespaces[e0.qargs.ns]}if(e0.qargs.date){e3=e0.qargs.date.split("-").map(Number);e2=new Date(e3[2],e3[1]-1,e3[0]);this.date_picker.calendar.selected_date=e2;this.change_date(e2)}this.update_calendar_first_day();return this.get_more()},_init_state:function(){var e0,e3,e6,e4,e2,e1,e5,T;this.namespaces={};e5=$u(this.roles).values();for(e6=0,e2=e5.length;e6<e2;e6++){e3=e5[e6];T=e3.ns_ids;for(e4=0,e1=T.length;e4<e1;e4++){e0=T[e4];this.namespaces[e0]=new bt(e0)}}if(this.ns){return this.ns=this.namespaces[this.ns.ns_id]}},change_date:function(T){this.timestamp=Number(T)+this.one_day;if(this.timestamp<this.earliest()||this.timestamp>this.latest){this.latest=this.timestamp;this._init_state()}bv("#cur_date_text").text(K.localize(T));return this.get_more(true)},is_scrolled_down:function(){var T,e1,e0;e0=z.scroll_offsets().top;e1=z.viewport_dimensions().height;T=bv("#events").height();return e0+e1+50>=T},get_more:function(e2){var T,e0,e1;if(this.request_in_flight){return}if($u(this.valid_nss()).all(function(e3){return e3.done})){this.render();return}if(!(e2||this.is_scrolled_down())){this.render();return}this.request_in_flight=true;this.render();e0=(function(e3){return function(){return $u(e3.valid_nss()).map(function(e4){return e4.ns_id}).join(",")}})(this);T=Math.min(this.earliest(),this.timestamp/1000,Math.floor(this.now/1000));e1={page_size:25,ns_ids:e0(),timestamp:T};if(this.for_deleted_files_page){e1.for_deleted_files_page=true}return new Ajax.DBRequest("/events/ajax",{method:"POST",parameters:e1,onSuccess:(function(e3){return function(fg){var fe,e5,fh,e7,ff,fc,fb,e9,fi,e6,e4,fd,fa,e8;fe=JSON.parse(fg.responseText);e3.request_in_flight=false;fd=fe.events;for(fc=0,fi=fd.length;fc<fi;fc++){e5=fd[fc];e5.html=bv(e5.html)[0];ff=e5.pkey+" "+(e5.html.textContent||e5.html.innerText);fh=e3.namespaces[e5.ns_id];if(!fh.seen[ff]){fh.events.push(e5);fh.seen[ff]=true;fh.earliest=e5.timestamp}}if(fe.events.length>0){fa=fe.ns_ids;for(fb=0,e6=fa.length;fb<e6;fb++){e7=fa[fb];e3.namespaces[e7].earliest=$u(fe.events).map(function(fj){return fj.timestamp}).min()}}e3.render();if(fe.events.last()){e3.get_more()}else{if($u(fe.ns_ids).join(",")!==e0()){e3.get_more()}else{e8=fe.ns_ids;for(e9=0,e4=e8.length;e9<e4;e9++){e7=e8[e9];e3.namespaces[e7].done=true}}}return an.configureAllLinks("#event-table",".inline-restore","events")}})(this),onError:(function(e3){return function(){e3.request_in_flight=false;if(!e3.user_navigated_away){return ab.error(el("We had problems loading your events feed; please try again later."))}}})(this)})},valid_roles:function(){if(this.role!=="all"){return $u(this.roles).filter((function(T){return function(e0){return e0.role===T.role}})(this))}else{return this.roles}},valid_nss:function(){if(this.ns){return[this.ns]}else{return $u(this.valid_roles()).map((function(T){return function(e0){return e0.ns_ids}})(this)).flatten().map((function(T){return function(e0){return T.namespaces[e0]}})(this)).uniq()}},earliest:function(){return $u(this.valid_nss()).map((function(T){return function(e0){return e0.earliest}})(this)).max()},latest:Number.MAX_VALUE,update_calendar_first_day:function(){this.date_picker.calendar.options.first_day=dQ.start_of_day(new Date($u(this.valid_nss()).map((function(T){return function(e0){return T.first_event_map[e0.ns_id]}})(this)).min()));if(this.date_picker.calendar.selected_date<this.date_picker.calendar.options.first_day){this.date_picker.calendar.selected_date=dQ.start_of_day(new Date(Number(this.date_picker.calendar.options.first_day)+this.one_day));this.change_date(this.date_picker.calendar.selected_date)}return this.date_picker.calendar.render()},set_url:function(){var e1,e2,e0,T;e0=new Date(this.timestamp-this.one_day);e2=this.now-this.timestamp>0;e1={};if(this.ns){e1.ns=this.ns.ns_id}if(this.role!=="all"){e1.role=this.role}if(e2){e1.date=""+(e0.getDate())+"-"+(e0.getMonth()+1)+"-"+(e0.getFullYear())}T=this.for_deleted_files_page?"/deleted_files":"/events";return eo.push_state(T,e1)},on_preview_open:function(e1){var e0,T;T=cB.get_viewer().get_user_by_id(e1.user_id);if(e1.preview_type==="photo"&&e1.large_thumbnail_url_tmpl){e0={filename:e1.filename,fq_path:e1.fq_path,thumbnail_url_tmpl:e1.large_thumbnail_url_tmpl,original_url:e1.href,ns_id:e1.ns_id,ns_path:e1.ns_path};aE.init([new V(e0)],{start_index:0})}else{bv(document).on("db:filepreview:close",this.on_preview_close);l.show(e1,T)}return false},on_preview_close:function(){bv(document).off("db:filepreview:close",this.on_preview_close);return document.title=el("Recent events - Dropbox")},render:function(){var T,ff,fh,fg,e9,fi,e8,fl,fd,e1,e7,fb,e6,fc,fe,e0,e5,e3,e2,fj,fk,fa,e4;if(this.role_has_events[this.role]){this.update_calendar_first_day()}T=$u(this.valid_nss()).map((function(fm){return function(fn){return fn.events}})(this)).flatten();ff=this.earliest();e0=$u(T).sortBy(function(fm){return -fm.timestamp});e9=$u(e0).filter((function(fm){return function(fn){return fn.timestamp>=ff&&fn.timestamp<fm.timestamp/1000&&(fm.ns!==null||!fn.is_dup)}})(this));if(this.role_has_events[this.role]){bv("#event-table").empty();for(e3=0,fj=e9.length;e3<fj;e3++){e7=e9[e3];fh=bv(e7.html);fb=$u(this.valid_roles()).filter((function(fm){return function(fn){return fn.ns_ids.contains(e7.ns_id)}})(this)).map((function(fm){return function(fn){return fn.name}})(this)).join(" & ");fh.find("span.role-label > span").text(fb);bv("#event-table").append(fh);if(e7.preview_jsinfo!=null){fg=e7.preview_jsinfo;e8=fh.find("#prev_link");e8.on("click",this.on_preview_open.bind(this,fg));fe=fh.find(".inline-button");fe.on("click",this._inline_share_button.bind(this,fg))}}bv("#events-container").show();bv("#events-sub-header").show();bv("#events-sub-header").css("visibility","visible");bv("#events-empty-state").hide();bv(".empty-explanation").hide()}else{if(!this.request_in_flight){bv("#events-container").hide();bv("#events-sub-header").hide();bv("#events-empty-state").show();bv(".empty-explanation").show()}}if(!this.request_in_flight){bv("#more-loading").hide()}else{bv("#more-loading").show()}bv("#more-loading").css("marginTop",this.earliest()===Number.MAX_VALUE?"140px":"20px");fa=bv("#namespace-list > li");for(e2=0,fk=fa.length;e2<fk;e2++){fi=fa[e2];e1=$u(this.valid_roles()).map((function(fm){return function(fn){return fn.ns_ids}})(this)).flatten().any((function(fm){return function(fn){return fn===bv(fi).data("value")}})(this));fd=bv(fi).data("value")===false;e5=fd||e1;bv(fi).css("display",e5?"":"none")}fc=bB.call((function(){var fp,fn,fm,fo;fm=this.valid_roles();fo=[];for(fp=0,fn=fm.length;fp<fn;fp++){fl=fm[fp];fo.push(fl.ns_ids.length>1)}return fo}).call(this),true)>=0;if(!this.request_in_flight){if(fc){bv("#namespace-list-container").css("visibility","visible");bv("#namespace-list-container").show()}else{bv("#namespace-list-container").hide()}e6=this.rss_data[(e4=this.ns)!=null?e4.ns_id:void 0]||this.rss_data[this.role];if(e6&&this.role_has_events[this.role]){bv("#rss-feed a").attr("data-title",e6.title);bv("#rss_url").val(e6.url);bv("#reset-rss-link").on("click",(function(fm){return function(fn){new Ajax.DBRequest("/reset_rss",{parameters:{ns_id:e6.ns_id},onSuccess:function(){ab.success(el("RSS feed url successfully reset."));return bR.redirect("/events")}});return false}})(this));bv("#rss_url").focus();bv("#rss-feed").show();return bv("#rss-feed").css("visibility","visible")}else{return bv("#rss-feed").hide()}}},show_rss_modal:function(){var T,e0;eS.show(el("Subscribe to this RSS feed"),bv("#rss-modal")[0]);e0=bv("#rss_url").val();T=q.clipboard_overlay(e0,bv("#real_copy"),function(){ab.success(el("Link copied to clipboard!"));return eS.hide()},bv(".modal-buttons"));return T.css({zIndex:1001})},_inline_share_button:function(e0,e2){var T,e1;e2.preventDefault();T="events_table_row";e1=a3.ShmodelUILogger.get_target_item(e0);a3.ShmodelUILogger.log("single_entry_share",T,e1);return new c3(e0.user_id,e0.fq_path,T).show()}};var K;K=B.DateUtil={fromSecondsSinceEpochUTC:function(T){var e0;e0=new Date(1970,0,1);e0.setSeconds(T);return e0},applyTimezoneOffset:function(e0,e2){var T,e1;T=parseInt(e2,10);e1=60*(e2-T);e0.setHours(e0.getHours()+T);return e0.setMinutes(e0.getMinutes()+e1)},contextualFormat:function(e0){var e2,e4,T,e1,e3;T=new Date(Date.now());e1=(T.getTime()-e0.getTime())/1000;e2=0;if(e1<8*3600){return bU.ago(e0)}this.applyTimezoneOffset(T,Constants.TIMEZONE_OFFSET);this.applyTimezoneOffset(e0,Constants.TIMEZONE_OFFSET);e3=new Date(Date.now());this.applyTimezoneOffset(e3,Constants.TIMEZONE_OFFSET);e3.setDate(e3.getDate()-1);if(e0.getYear()===T.getYear()&&e0.getMonth()===T.getMonth()&&e0.getDate()===T.getDate()){e4=el("Today %(time)s");return e4.format({time:K.format(e0,Constants.time_format)})}else{if(e0.getYear()===e3.getYear()&&e0.getMonth()===e3.getMonth()&&e0.getDate()===e3.getDate()){e4=el("Yesterday %(time)s");return e4.format({time:K.format(e0,Constants.time_format)})}else{return K.format(e0,Constants.datetime_format)}}},toUTCDate:function(T){return new Date(T.getUTCFullYear(),T.getUTCMonth(),T.getUTCDate(),T.getUTCHours(),T.getUTCMinutes(),T.getUTCSeconds(),T.getUTCMilliseconds())},differenceStr:function(e2,e5){var e7,e6,e0,e1,e3,T,e4;e3=(e2.getTime()-e5.getTime())/1000;if(e3<60){return a4("%d sec","%d secs",e3).format(e3)}else{if(e3<3600){e0=parseInt(e3/60,10);return a4("%d min","%d mins",e0).format(e0)}else{if(e3<86400){e6=parseInt(e3/3600,10);return a4("%d hour","%d hours",e6).format(e6)}else{if(e3<2592000){e7=parseInt(e3/(60*60*24),10);return a4("%d day","%d days",e7).format(e7)}else{if(e3<4838400){T=parseInt(e3/(60*60*24*7),10);return a4("%d week","%d weeks",T).format(T)}else{if(e3<31536000){e1=parseInt(e3/(60*60*24*30),10);return a4("%d month","%d months",e1).format(e1)}else{e4=parseInt(e3/(60*60*24*365),10);return a4("%d year","%d years",e4).format(e4)}}}}}}},localize:function(T){cz(Constants.date_format!=null,"Date format missing.");return K.format(T,Constants.date_format)},format:function(T,e0){var e1;cz(typeof e0==="string","Date format requires a format string");e1={yy:(function(e2){return function(){return T.getFullYear().toString().substring(2)}})(this),yyyy:(function(e2){return function(){return T.getFullYear().toString()}})(this),M:(function(e2){return function(){return(T.getMonth()+1).toString()}})(this),MM:(function(e2){return function(){return(T.getMonth()+1).toString().lpad(2)}})(this),d:(function(e2){return function(){return T.getDate().toString()}})(this),dd:(function(e2){return function(){return T.getDate().toString().lpad(2)}})(this),h:(function(e2){return function(){return(T.getHours()%12||12).toString()}})(this),H:(function(e2){return function(){return T.getHours().toString()}})(this),HH:(function(e2){return function(){return T.getHours().toString().lpad(2)}})(this),m:(function(e2){return function(){return T.getMinutes().toString()}})(this),mm:(function(e2){return function(){return T.getMinutes().toString().lpad(2)}})(this),a:(function(e2){return function(){if(T.getHours()>11){return el("PM",{comment:"PM as in evening"})}else{return el("AM",{comment:"AM as in morning"})}}})(this)};return e0.replace(/([a-zA-Z]+)/g,function(e2){if(e1[e2]!=null){return e1[e2]()}else{return e2}})}};var eA;eA=INLINE_JS.Timezone=B.Timezone={check_timezone:function(){var T;if(!cB.get_viewer().is_signed_in){return}T=eA.get_current_timezone();if((Constants.auto_timezone_offset==null)||Constants.auto_timezone_offset!==T){return eA.update(T)}},get_current_timezone:function(){var e2,e1,T,e0;e1=new Date();e1.setSeconds(0);e1.setMilliseconds(0);e0=e1.toGMTString();e2=new Date(e0.substring(0,e0.lastIndexOf(" ")));T=(e1-e2)/(1000*60*60);return T},update:function(T){cz(typeof T==="number","Timezone offset was not a number: "+T);return new Ajax.DBRequest("/set_timezone",{parameters:{offset:T},noAutonotify:true})},update_timezones_dropdown:function(e0,e2){var e1,T;if(e2==null){e2=null}T=eA.timezones_by_country[e0];bv("#timezone_id").empty();return bv("#timezone_id").append((function(){var e5,e4,e3;e3=[];for(e5=0,e4=T.length;e5<e4;e5++){e1=T[e5];e3.push(bv('<option value="'+e1.id+'">'+e1.name+"</option>").prop("selected",e1.id===e2))}return e3})())},auto:function(){var T;T=$F("timezone_auto");if(T){return bv("#tz").hide()}else{if(eA.default_country){bv("#timezone_country").val(eA.default_country);eA.update_timezones_dropdown(eA.default_country)}return bv("#tz").show()}},load_data:function(e0,T){eA.timezones_by_country=e0;return eA.default_country=T}};var a9,bA;bA=B.CreateApp={init:function(e2,e0){var e1,e3,T;this.accepted_tos_by_uid=e2;this.form=e1=bv("#create-app-form");this.email_verification=null;if(!cB.get_viewer().is_paired){T=cB.get_viewer().get_users()[0];this.select_user(T.id)}e3=(function(e4){return function(e5){var e6;e6=e5.target.name;return e1.find("input[name="+e6+"]").each(function(){bv(this).parents("label").removeClass("active");return e1.removeClass(bv(this).data("next"))})}})(this);e1.find("input[type=radio]").change(function(e4){e3(e4);bv(e4.target).parents("label").addClass("active");return e1.addClass(bv(this).data("next"))});e1.find("input[type=checkbox]").change(function(e4){var e5;if(bv(this).filter("#accept-tos").length){return}bv(e4.target).parents("label").toggleClass("active");e5=e1.find("input[name="+(bv(this).attr("name"))+"]:checked");e1.toggleClass(bv(this).data("next"),e5.length!==0)});e1.find(".role-choice input").change((function(e4){return function(e6){var e5,e7;e5=e1.find(".role-choice input:checked");e7=e5.val();if(!cB.get_viewer().is_uid_signed_in(e7)){e5.prop("checked",false);e3(e6);bF.show_modal({user_id:e7,on_success:function(){return e5.prop("checked",true).trigger("change")}});return false}else{return e4.select_user(e7)}}})(this));e1.find("input:checked").trigger("change");e1.find("input[name=tos_accept]").change((function(e4){return function(e5){return e4.update_submit_enabled()}})(this));e1.find("#send-verify-email, #resend-verify-email").click((function(e4){return function(e5){e4.email_verification.send_email(e0,function(){e1.addClass("verify-email-sent");e4.email_verification.flash_email_sent_notification();return e4.email_verification.ensure_polling(function(){if(!e4.email_verification.user.is_email_verified){return}e1.addClass("email-verified");e1.removeClass("verifiy-email-sent");return e4.update_submit_enabled()})});return false}})(this));return e1.submit(function(e4){e1=bv(e4.target);bJ.ajax_submit(e1[0],false,(function(e5){return window.location.href=e5.responseText}));return false})},select_user:function(T){this.email_verification=dP.get_for_user(cB.get_viewer().get_user_by_id(T));this.form.find("#accept-tos-wrapper").toggle(!this.accepted_tos_by_uid[T]);this.form.find("input[name=tos_accept]").prop("checked",false);this.form.removeClass("verify-email-sent");this.form.find("#verify-email-wrapper").toggle(!this.email_verification.user.is_email_verified);this.form.toggleClass("email-verified",this.email_verification.user.is_email_verified);return this.update_submit_enabled()},update_submit_enabled:function(){var e0,T;T=this.email_verification.user;e0=this.accepted_tos_by_uid[T.id]||this.form.find("input[name=tos_accept]").prop("checked");return this.form.find("#create-button").prop("disabled",!e0)}};a9=INLINE_JS.Apps=B.Apps={init_apps:function(){return bv("#show-disabled-apps").click(function(){bv(this).parent().hide();bv("#disabled-apps").show();return false})},init_app_info:function(e0,e1,T){this.user_email=T;bv("#app-info .icon-container").each(function(e3,e4){var e2;e2=bv(e4);return e2.append(Dropbox.createChooseButton({success:function(e5){e2.find(".icon").attr("src",e5[0].thumbnailLink);return e2.find("input[type=hidden]").val(e5[0].link)},linkType:"direct",extensions:["images"]}))});this._hoverable_tmpl=eV.tmpl("hoverable_tmpl");this._webhook_info_row_tmpl=eV.tmpl("webhook_info_row_tmpl");bv("#domain-list").on("click",".img-container",function(e2){a9.remove_domain(e2.currentTarget.parentNode,e0)});bv("#oauth-uri-list").on("click",".img-container",function(e2){a9.remove_oauth_uri(e2.currentTarget.parentNode,e0)});bv("#webhook-list").on("click",".img-container",function(e2){a9.remove_webhook(e2.currentTarget.parentNode,e0)});bv("#webhook-list").on("click",".webhook-actions.enabled .webhook_disable",function(e2){a9.update_webhook_url(e2.currentTarget,e0,false)});bv("#webhook-list").on("click",".webhook-actions.disabled .webhook_enable",function(e2){a9.update_webhook_url(e2.currentTarget,e0,true)});bv("#generate-token-button").on("click",function(e2){a9.generate_access_token(e0)});bv("#delete-app-button").on("click",function(e2){a9.confirm_disable(e1,e0,0)});bv("#webhook_url").on("click change paste focus",function(e2){bv("#webhook-form").removeClass("error")});this.init_app_info_add_redirect_uri();return bv("#oauth2-allow-implicit-grant").on("change",function(e2){return a9.set_oauth2_allow_implicit_grant(e2.currentTarget,e0)})},init_app_info_add_redirect_uri:function(){var T,e0,e1,e2;e0=/^\#?add_redirect_uri=(.*)$/.exec(window.location.hash||"");if(!e0){return}e2=window.decodeURIComponent(e0[1]);T=bv("#oauth-add-uri-form");bv("input[name=oauth_uri]",T).val(e2);e1=bv("#add-redirect-uri-modal")[0];bv("#add-redirect-uri-modal-uri").text(e2);eS.show(el("Add OAuth redirect URI"),e1,{doit:function(){var e3;if(window.history&&window.history.replaceState){e3=window.location.href;e3=e3.substring(0,e3.indexOf("#"));window.history.replaceState({},document.title,e3)}else{window.location.hash=""}eS.hide();return a9.submit_new_oauth_uri(bv("#oauth-add-uri-form")[0])}})},init_app_datastores_browse:function(T){this.ds_info=T;if(cB.get_viewer().is_paired){this.role_picker=bv("#role-selector").controller();this.role_picker.on_state_change=this.app_datastores_browse_render.bind(this);return bF.set_during_login_callback((function(e0){return function(e2,e1){return e0.app_datastores_browse_reload_info(function(){return e1()},function(){e1("Error displaying datastores");return window.location.reload()})}})(this))}},app_datastores_browse_reload_info:function(e0,T){bv.ajax({url:"/developers/apps/datastores/info",success:(function(e1){return function(e2){e1.ds_info=e2;e1.app_datastores_browse_render();return typeof e0==="function"?e0():void 0}})(this),error:(function(e1){return function(e2){return typeof T==="function"?T(e2):void 0}})(this)});return false},app_datastores_browse_render:function(){this.app_datastores_browse_render_id("#apps_developed_container");this.app_datastores_browse_render_id("#apps_used_container");return this.app_datastores_browse_render_empty()},app_datastores_browse_render_empty:function(){var e1,e0,T,e2;e0=bv("#no_apps_container").empty();if(bv("#apps_developed_container").children().length!==0||bv("#apps_used_container").children().length!==0){return}e1=bv("<div class='empty-state'></div>").appendTo(e0);switch((e2=this.role_picker)!=null?e2.get_state():void 0){case dN.PERSONAL:case dN.WORK:T=cB.get_viewer().get_user_by_role(this.role_picker.get_state());return e1.append("You don't have any datastores in your "+cB.get_role_title(T)+" Dropbox.");default:return e1.append("You don't have any datastores in your Dropbox.")}},app_datastores_browse_render_id:function(e6){var e0,e5,e2,e4,e3,e1,T;e4=this.app_datastores_browse_get_id_info(e6);e5=bv(e6);e5.empty();e0="";for(e1=0,T=e4.length;e1<T;e1++){e2=e4[e1];if(this.app_datastores_should_render(e2.uid)){e0+=e2.html}}if(e0){e5.append(this.app_datastores_browse_get_id_header(e6));e3=bv("<div class='app-list clearfix'/>").appendTo(e5);return e3.html(e0)}},app_datastores_should_render:function(e0){var T;if(this.role_picker!=null){T=cB.get_viewer().get_user_by_id(e0);return this.role_picker.is_role_visible(T.role)}else{return true}},app_datastores_browse_get_id_info:function(T){switch(T){case"#apps_developed_container":return this.ds_info.apps_developed;case"#apps_used_container":return this.ds_info.apps_used;default:return cz(false,"invalid ds group id")}},app_datastores_browse_get_id_header:function(T){switch(T){case"#apps_developed_container":return bv("<h2>Apps you develop</h2>");case"#apps_used_container":return bv("<h2>Apps you use</h2>");default:return cz(false,"invalid ds group id")}},generate_access_token:function(e0){var e2,e1,T;T=this;e2=bv("#generate-token-button");e1=bv("<img>").attr("src","/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif").css("vertical-align","middle");e2.replaceWith(e1);return bv.ajax({url:"/developers/apps/generate_access_token",type:"POST",data:{app_id:e0},dataType:"json",success:function(e4){var e3;if(e4.status==="ok"){e3=bv("<div>").append(bv("<div>").attr("id","generated-token").addClass("text").css("padding-top",0).text(e4.token));e3.append(bv("<div>").addClass("detail-text").text(e4.warning))}else{if(e4.status==="error"){e3=bv("<div>").addClass("detail-text").addClass("error").text(e4.msg)}}return e1.replaceWith(e3)},error:function(){return ab.error("Unable to complete your request.")}})},confirm_disable:function(e2,e1,e0){var e3,T;e3=(e0?el("Are you sure you want to disable '%(app_name)s'?"):el("Are you sure you want to delete '%(app_name)s'?"));de.fillVal(e3.format({app_name:e2.escapeHTML()}),"app-disable-text");eS.show((e0?el("Confirm disable"):el("Confirm delete")),$("app-disable-modal"));T="/developers/disable_app/"+e1;$("app-disable-modal").down("form").action=T;return $("disable-app-button").setValue((e0?el("Disable"):el("Delete")))},enable_app:function(e0){var T;T="/developers/enable_app/"+e0;return window.location.href=T},show_uninstall:function(e4,e3,e1,e0,e2,T){var e5;if(e4){Event.stop(e4)}eS.vars={app_id:e1,user_id:T};e5=bv("#delete-"+e0+"-app-confirm");if(e0==="sandbox"){if(!e2){a9.do_uninstall();return}bv(".app_folder",e5).text(e2)}bv(".app_name",e5).text(e3);eS.show(el("Remove %(app_name)s?").format({app_name:bK.em_snippet(e3,22)}),e5[0],eS.vars);return null},do_uninstall:function(){var T;T=eS.vars.user_id;new Ajax.DBRequest("/api/uninstall_app",{parameters:{app_id:eS.vars.app_id,keep_sandbox_files:$F("keep_sandbox_files")},onSuccess:function(e0){var e1;ab.success(e0.responseText);e1=bv(".apps-"+T);bv("#inst-app-"+eS.vars.app_id+"-row",e1).hide().removeClass("active_app");if(bv(".active_app",e1).length===0){e1.hide()}if(bv(".active_app").length===0){bv("#empty-explanation").text(el("You have no apps linked to your Dropbox."));return bv("#applications-explanation",e1).remove()}},subject_user:T});return eS.hide()},enable_users_in_dev:function(T,e0){new Ajax.DBRequest("/developers/enable_users_in_dev/"+T,{onSuccess:function(e1){eS.show(el("Limit raised to %d users").format(e0),$("increased-dev-user-limit-modal"));bv("#users-in-dev-none, #users-in-dev-some").hide();return bv("#users-in-dev-max").show()}});return false},unlink_all_users_in_dev:function(T){eS.show(el("Unlink all users"),$("confirm-unlink-all-users"),{doit:function(){return new Ajax.DBRequest("/developers/unlink_all_users/"+T,{onSuccess:function(e0){bv("#current-app-users-1, #current-app-users-2").text("0");return eS.hide()}})}});return false},unlink_all_teams_in_dev:function(T){eS.show(el("Unlink all teams"),$("confirm-unlink-all-teams"),{doit:function(){return bv.ajax({url:"/developers/unlink_all_teams/"+T,type:"POST",success:function(e0){bv("#current-app-teams").text("0");return eS.hide()}})}});return false},restore_sandbox:function(e0,e2,T){var e4,e1,e3;e4=bv("#restore-sandbox")[0];eS.show(el("Restore app folder '%(filename)s'").format({filename:bK.em_snippet(av.filename(e2),17)}),e4);e3=bv("#restore-sandbox-form")[0];e1={ns_id:T};e1[Constants.UID_PARAM_NAME]=e0.id;return bJ.add_vars(e3,e1)},submit_restore_sandbox:function(e0){var T;T=$("restore-sandbox-form");bJ.ajax_submit(T,false,(function(e1){eS.hide();ab.success(el("Restored app folder"));if(e1.responseText.length){return ci.reload_fqpath(e1.responseText)}else{return ci.reload("","",true)}}),false,e0.target);return false},submit_app_info:function(T){var e0;e0=bv(T).find("input[name=name]").val();bJ.clear_errors(T);return bJ.ajax_submit(T,false,(function(){ab.success("App info updated.");if(e0){return bv("#app-info h1").text(e0)}}))},submit_folder_name:function(T){var e0;e0=bv(T).find("input[name=folder]").val();bJ.clear_errors(T);return bJ.ajax_submit(T,false,(function(){ab.success("App folder name updated.");bv("#folder-name .text").text(e0);return a9.hide_folder_input()}))},submit_new_webhook:function(e0){var e1,fb,e9,e4,e7,e6,fa,e8,e2,T,e5,e3;fb=bv(e0);e7=bv("#webhook-list");e4=bv("<img>").attr("src","/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif").css("vertical-align","middle");e9=fb.find("input[name=webhook_url]");e2=function(fd,fc){if(fc){fc.remove()}if(e7.find(".hoverable-url").length===0){e7.addClass("hide-status")}bv("#webhook-form-error").text(fd);return bv("#webhook-form").addClass("error")};fa=e9.val();if(fa===""){e2("Empty URI");return}e8=D.parse(fa);if((e5=e8.scheme)!=="http"&&e5!=="https"){e2("URI scheme must be http or https");return}if(!e8.authority){e2("Improperly formatted URI (typo maybe?)");return}if(((e3=e8.authority)==="localhost"||e3==="127.0.0.1")||e8.authority.indexOf("[::1]")===0){e2("Webhooks doesn't support localhost as Dropbox can't contact your local server. Please use an internet accessible URI.");return}if(e7.find("tbody").length>=Constants.MAX_WEBHOOKS_PER_APP){e2("You can register a maximum of %d webhook URIs per app.".format(Constants.MAX_WEBHOOKS_PER_APP));return}e1=bv(this._webhook_info_row_tmpl({url:fa,status:"Verifying"}).toHTML());e1.find(".status").append(e4);e1.find(".webhook-actions").removeClass("disabled").addClass("enabled");e7.append(e1);e7.removeClass("hide-status");bv("#webhook-form").removeClass("error");e6=bJ.collect_form_vars(e0);e9.val("");T=new Date().getTime();return bv.ajax({url:"/developers/apps/update/add_webhook",type:"POST",dataType:"json",data:e6,success:function(fe){var fc,fd;if(fe.status==="invalid"){e2(fe.failure_text,e1);return e9.val(fa)}else{fd=new Date().getTime()-T;fc=Math.max(0,1000-fd);return setTimeout((function(){if(fe.status==="ok"){return e1.find(".status").text("Enabled")}else{if(fe.status==="error"){e1.find("textarea").text(fe.failure_text);e1.find(".status").text(fe.status_text).addClass("error");e1.find(".timestamp").text("Just now");return e1.find(".webhook-failure-info").css("display","")}}}),fc)}},error:function(){ab.error("Unable to complete your request.");e1.remove();return e9.val(fa)}})},remove_webhook:function(e1,e0){var e2,T;bv("#webhook-form").removeClass("error");T=bv(e1).find(".value").text();e2=bv("<img>").attr("src","/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif").css("vertical-align","middle");bv(e1).find(".status").text("Removing").removeClass("error").append(e2);return bv.ajax({url:"/developers/apps/update/remove_webhook",type:"POST",data:{app_id:e0,webhook_url:T},dataType:"json",success:function(e5){var e3,e4;e3=e1.parentNode;e4=e3.parentNode;e4.removeChild(e3);if(e4.getElementsByClassName("hoverable-url").length===0){bv(e4).addClass("hide-status")}if(!bv("#webhook_url").val()){return bv("#webhook_url").val(T)}},error:function(){return ab.error("Unable to complete your request.")}})},update_webhook_url:function(e4,e2,e1){var e5,T,e3,e6,e0;e0=bv(e4.parentNode.parentNode).find(".value").text();bv("#webhook-form").removeClass("error");e3=e4.parentNode.parentNode.parentNode;e5=bv("<img>").attr("src","/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif").css("vertical-align","middle");T=bv(e3).find(".status").text();e1=T==="Disabled";e6=e1?"Enabling":"Disabling";bv(e3).find(".status").text(e6).removeClass("error").append(e5);return bv.ajax({url:"/developers/apps/update/update_webhook_url",type:"POST",data:{app_id:e2,webhook_url:e0,enable:e1},dataType:"json",success:function(e8){var e7;T=bv(e3).find(".status").text();e7=T==="Disabling"?"Disabled":"Enabled";bv(e3).find(".status").text(e7).removeClass("error").removeClass("img");if(T==="Disabling"){return bv(e3).find(".webhook-actions").removeClass("enabled").addClass("disabled")}else{return bv(e3).find(".webhook-actions").removeClass("disabled").addClass("enabled")}},error:function(e7){return ab.error("Unable to complete your request.")}})},set_oauth2_allow_implicit_grant:function(e0,T){return bv.ajax({url:"/developers/apps/update/oauth2_allow_implicit_grant",type:"POST",data:{app_id:T,allow:bv(e0).val()},dataType:"json",success:function(e1){return ab.success("OAuth 2 allow implicit grant updated.")},error:function(){return ab.error("Error updating OAuth 2 allow implicit grant.")}})},submit_new_oauth_uri:function(e0){var T;T=bv(e0).find("input[name=oauth_uri]").val();bJ.clear_errors(e0);return bJ.ajax_submit(e0,false,(function(){ab.success("OAuth URI added.");a9.add_oauth_uri(T);return bv(e0).find("input[name=oauth_uri]").val("")}))},add_oauth_uri:function(e0){var T;T=bv("#oauth-uri-list");T.append(this._hoverable_tmpl({value:e0}).toHTML());return T.show()},remove_oauth_uri:function(e0,T){var e2,e1;e2=bv(e0).find(".value").text();e1=function(e4){var e3;ab.success("OAuth URI removed.");e3=e0.parentNode;e3.removeChild(e0);if(e3.getElementsByTagName("div").length===0){return e3.hide()}};return bv.ajax({url:"/developers/apps/update/remove_oauth_uri",type:"POST",data:{app_id:T,oauth_uri:e2},dataType:"json",success:e1,error:function(){return ab.error("Unable to complete your request.")}})},submit_new_domain:function(T){var e0;e0=bv(T).find("input[name=domain_name]").val();bJ.clear_errors(T);return bJ.ajax_submit(T,false,(function(){ab.success("Domain added.");a9.add_domain(e0);return bv(T).find("input[name=domain_name]").val("")}))},add_domain:function(e0){var T;T=bv("#domain-list");T.append(this._hoverable_tmpl({value:e0}).toHTML());return T.show()},remove_domain:function(e0,T){var e2,e1;e2=bv(e0).find(".value").text();e1=function(e4){var e3;ab.success("Domain removed.");e3=e0.parentNode;e3.removeChild(e0);if(e3.getElementsByTagName("div").length===0){return e3.hide()}};return bv.ajax({url:"/developers/apps/update/remove_domain",type:"POST",data:{app_id:T,domain_name:e2},dataType:"json",success:e1,error:function(){return ab.error("Unable to complete your request.")}})},show_need_users_modal:function(T){eS.show(el("Please test this app",{comment:"Error message"}),$("app-need-users-modal"));return false},show_need_teams_modal:function(T){return eS.show(el("Please test this app",{comment:"Error message"}),$("app-need-teams-modal"))},show_name_branding_modal:function(T){eS.show(el("Please rename this app",{comment:"Error message"}),$("app-name-branding-modal"));return false},show_need_icon_modal:function(T){eS.show(el("Please add an icon for this app",{comment:"Error message"}),$("app-need-icon-modal"));return false},hide_folder_input:function(){bv("#folder-name").show();return bv("#folder-input").hide()},show_folder_input:function(){bv("#folder-name").hide();bv("#folder-input").show();return bv("#folder-input input[name=folder]").focus()}};var ct,dr;dr=INLINE_JS.twitter_auth_complete=function(T){cz(T!=null,"user_id must be provided");if(ct.onLoginSuccessCallback){ct.onLoginSuccessCallback(T)}else{window.location.reload()}return false};ct=B.Twitter={is_authed:function(T){T=parseInt(T);if(ct._authed_users==null){ct._authed_users={}}return ct._authed_users[T]},set_is_authed:function(T,e0){T=parseInt(T);if(ct._authed_users==null){ct._authed_users={}}return ct._authed_users[T]=e0},get_progress_container:function(){var T;cz(ct.progress_container,"Twitter is missing progress_container");T=$(ct.progress_container);cz(T,"Missing progress_container elm");return T},follow_dropbox:function(e0,T){var e1;cz(T!=null,"user_id must be provided");if(e0.showWorking){e0.showWorking()}e1=function(){if(e0.onFailure){return e0.onFailure()}else{return window.location.reload()}};return new Ajax.DBRequest("/twitter/follow_us",{onSuccess:function(e2){if(!e2.responseText.startsWith("ok")){return e1()}else{if(e0.onSuccess){return e0.onSuccess()}}},onFailure:function(){return e1()},subject_user:T})},do_auth:function(e2,T){var e1,e0;cz(T!=null,"user_id must be provided");e0=D({path:"/twitter/request_token"}).updateQuery(Constants.UID_PARAM_NAME,T).toString();window.open(e0,"twitter_auth","width=800,height=400");e1=function(e3){ct.set_is_authed(e3,true);return typeof e2==="function"?e2(e3):void 0};return ct.onLoginSuccessCallback=e1},show_auth:function(T){if(T){ct.onLoginSuccessCallback=T}return de.updateFromElm(ct.get_progress_container(),"inline-twitter-auth")},show_posting:function(){if(ct.should_hide_modal()){eS.hide()}return ct.get_progress_container().update(de.fromElm("sharing-progress"))},show_complete:function(e0){var T;T=ct.get_progress_container();T.update(de.fromElm("sharing-posted"));return ct.show_complete_into(e0,T)},show_complete_into:function(e5,T){var e2,e3,e1,e4,e0;e2="twitter";e4=el("View tweet");e0=void 0;if(e5.startsWith("ok")){e0="http://www.twitter.com/"}else{e0=e5}e3=T.down("#view-post");e3.href=e0;e3.update(e4);e1=cm.make("web",e2);return e3.__sert({top:e1})},post:function(e2,e4,e1,T){var e3,e0;cz(T!=null,"user_id must be provided");cz(e2,"Twitter message is empty");e3={message:e2,from_referrals:ct.from_referrals,from_getspace:ct.from_getspace};new Ajax.DBRequest("/twitter_post",{parameters:e3,onSuccess:function(e5){var e6,e7;if(e5.responseText==="login"){ct.onLoginSuccessCallback=function(){return ct.post(e2,null,null,T)};e6=ct.custom_show_auth||ct.show_auth;return e6()}else{if(ct.should_hide_modal()){eS.hide()}e7=ct.onPostSuccessCallback||ct.show_complete;return e7(e5.responseText)}},subject_user:T});e0=ct.custom_show_posting||ct.show_posting;return e0()},custom_post:function(e0,e1,T){cz(T!=null,"user_id must be provided");if(e1){ct.onPostSuccessCallback=e1}if(!e0){return}cz(e0,"Twitter message doesn't exist");if(!cB.get_viewer().is_signed_in){return window.open("http://www.twitter.com/home?status="+encodeURI(e0))}else{return ct.post(e0,null,null,T)}},get_user_info:function(e0,T){cz(T!=null,"user_id must be provided");return new Ajax.DBRequest("/twitter/user_info",{noAutonotify:1,parameters:{},onSuccess:function(e1){return e0(JSON.parse(e1.responseText))},subject_user:T})},should_hide_modal:function(){if(typeof ct.hide_modal==="undefined"){return true}else{return ct.hide_modal}}};var dc,eJ,dp,V,eC,ao,bx,aj,v,d7,ar={}.hasOwnProperty,cE=function(e2,e0){for(var T in e0){if(ar.call(e0,T)){e2[T]=e0[T]}}function e1(){this.constructor=e2}e1.prototype=e0.prototype;e2.prototype=new e1();e2.__super__=e0.prototype;return e2},dg=function(T,e0){return function(){return T.apply(e0,arguments)}};dp=B.LightboxPreviewBase=(function(){function T(e0){this.link_hash=e0.link_hash;this.filename=e0.filename;this.fq_path=e0.fq_path;this.thumbnail_url_tmpl=e0.thumbnail_url_tmpl;this.dl_url=e0.dl_url;this.ns_id=e0.ns_id;this.ns_path=e0.ns_path;this.display_time=e0.display_time||null;this.more_actions_item_tmpl=eV.tmpl("lightbox_more_actions_item_tmpl")}T.prototype.shutdown=function(){};T.prototype.preload=function(){};T.prototype.render=function(){};T.prototype.image_size=function(){var e0;e0=document.viewport.getDimensions();return aB(e0.width,e0.height)};T.prototype.get_more_actions_above_divider=function(e1){var e2,e0;e0=[];e2=this.more_actions_item_tmpl({_id:"lightbox_download_link",_href:this.dl_url,_ns_id:this.ns_id,_ns_path:this.ns_path,sprite_name:"lightbox_download",item_text:el("Download"),more_classes:"more-actions-item",Sprite:cm});e0.push(e2);return e0};T.prototype.get_more_actions_below_divider=function(e0){return[]};T.prototype.is_a_timeline_preview=function(){return this instanceof eC||this instanceof dc||this instanceof ao||this instanceof eJ};T.prototype.is_an_album_preview=function(){return this instanceof eC||this instanceof ao};T.prototype.is_a_photo_preview=function(){return this instanceof V};T.prototype.is_a_video_preview=function(){return this instanceof bx};T.prototype.get_actions=function(e2){var e4,e6,e7,e1,e5,e0,e3;e1=[];if(!this.is_a_timeline_preview()&&e2.enable_sublinks){if(e2.share_button_experiment_variant==="WHITE_BUTTON"){e7=bv("#lightbox-share-action-base").clone().attr("id","lightbox-share-button");if(this.shmodel_link){e3=(function(e8){return function(e9){a3.ShmodelUILogger.log("via-shmodel-lightbox");return window.open(D.parse(e8.shmodel_link).updateQuery("m","1"))}})(this)}else{e3=(function(e8){return function(e9){e9.preventDefault();a3.ShmodelUILogger.log("via-browse-lightbox");return dh.shmodel(e8.fq_path,"browse_lightbox")}})(this)}}else{e7=bv("<a />",{id:"lightbox_share_link","class":"title_bubble black"});e7.html(cm.make("web","link_white"));if(this.is_a_photo_preview()){e7.attr("title",el("Share link to photo"))}else{if(this.is_a_video_preview()){e7.attr("title",el("Share link to video"))}else{cz(false,"preview needs to be a photo or video")}}if(this.shmodel_link){e7.attr("href",D.parse(this.shmodel_link).updateQuery("m","1"));e7.attr("target","_blank");e3=(function(e8){return function(e9){return a3.ShmodelUILogger.log("via-shmodel-lightbox")}})(this)}else{e7.attr("href","#");e3=(function(e8){return function(e9){e9.preventDefault();a3.ShmodelUILogger.log("via-browse-lightbox");return dh.shmodel(e8.fq_path,"browse_lightbox")}})(this)}}e7.on("click",e3);e1.push(e7[0])}if(e2.include_delete){e5=bG.in_single_collection_view()?el("Remove"):el("Delete");if(e2.share_button_experiment_variant==="WHITE_BUTTON"){e4=bv("#lightbox-delete-action-base").clone().attr("id","lightbox-delete-link");e4.find(".sprite-text-inner").text(e5);e4.on("click",(function(e8){e8.preventDefault();return aE.delete_current()}))}else{e4=bv("<a />",{id:"lightbox-delete-button",href:"#","class":"title_bubble black",title:e5});e4.html(cm.make("web","lightbox_delete_16"));e4.on("click",(function(e8){e8.preventDefault();return aE.toggle_delete()}))}e1.push(e4[0])}if(e2.share_button_experiment_variant==="WHITE_BUTTON"){e0=(function(e8){return function(e9){e9.preventDefault();return aE.toggle_more_actions_menu()}})(this);e6=bv("#lightbox-more-actions-base").clone().attr("id","lightbox-more-actions-button").on("click",e0);e1.push(e6[0])}else{cz(aE.more_actions_button!=null,"Lightbox should have a more_actions_button added on init");e1.push(aE.more_actions_button)}return e1};T.prototype.delete_pressed=function(){var e0;e0=el("Deleting...");if(this.is_a_timeline_preview()){if(bG.in_single_collection_view()){e0=el("Removing...");bG.get_current_collection().remove_photos([this.photo])}else{bG._delete_photos([this.photo])}}else{document.fire(aE.PHOTO_DELETE_EVT,this)}return ab.success(e0)};T.prototype.set_more_actions_event_handlers=function(e0){};T.prototype.replace_dl_action_with_open_action_if_file_available=function(){var e1,e2,e0,e3;if(__CONDITIONAL_JS__.UnityFeatures==null){return}e0=ci.active_user.id;e2=(function(e4){return function(e5,e8,e6){var e9,e7;e9=bv("#lightbox_download_link");if(!(e9.data("ns-id")===e5&&e9.data("ns-path")===e8)){return}e7=bv(e4.more_actions_item_tmpl({_id:"unity_open_action",_href:"#",_ns_id:e5,_ns_path:e8,sprite_name:"lightbox_open",item_text:el("Open"),more_classes:"more-actions-item",Sprite:cm}).toHTML());e9.replaceWith(e7);return e7.on("click",function(fa){return __CONDITIONAL_JS__.UnityFeatures.open_file(e5,e8,e6,__CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler,function(fb){return __CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler(false)})})}})(this);if((e3=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?e3.is_cached_and_locally_available(this.ns_id,this.ns_path):void 0){return e2(this.ns_id,this.ns_path,e0)}else{e1=(function(e4){return function(e5){if(e5.is_locally_available){return e2(e4.ns_id,e4.ns_path,e0)}}})(this);return __CONDITIONAL_JS__.UnityFeatures.check_file(this.ns_id,this.ns_path,e0,e1)}};return T})();V=INLINE_JS.PhotoPreview=B.PhotoPreview=(function(e0){cE(T,e0);function T(e1){T.__super__.constructor.call(this,e1);this.original_url=String(D.parse(e1.original_url).updateQuery(Constants.UID_PARAM_NAME,ci.active_user));this.shmodel_link=e1.shmodel_link;this.fail_image_src="/static/images/preview_fail-vflc3IDxf.png";if(this.is_gif()){this.thumbnail_url_tmpl=this.original_url}this.loaded=false;this.enable_download=e1.enable_download}T.prototype.show_fail=function(e2){var e1;return e1=bv(e2).find(".lightbox_fail_text").text(el("Unable to preview this item."))};T.prototype.fallback=function(e2){var e1,e3;e1=$(e2.target);e1.writeAttribute({src:this.fail_image_src,width:128,height:128});e3=e1.up("div.content-item");if(e3){return this.show_fail(e3)}};T.prototype.is_gif=function(){return"gif"===av.file_extension(this.filename).toLowerCase()};T.prototype.preload=function(e3){var e2,e4,e1;e1=D.parse(this.thumbnail_url_tmpl).updateQuery({size:this.image_size()}).toString();if(this.is_gif()){e1=this.thumbnail_url_tmpl}e4=(function(e5){return function(){if(typeof e3==="function"){e3()}return e5.loaded=true}})(this);dQ.preload_image(e1,this.fallback.bind(this),e4);e2=$(dQ.preloaded_images[e1]);e2.writeAttribute("data-original-href",this.original_url);e2.setAttribute("enable-download",this.enable_download);e2.writeAttribute("class","thumbnail");return e2};T.prototype.render=function(e6,e3){var e4,e2,e5,e1,e7;if(this.loaded){e3()}e2=this.preload(e3);e7=bv("<div />",{"class":"content-item"}).append(e2);e4=bv("<div />",{"class":"lightbox_fail_text"});e7.append(e4);e5=e2.getAttribute("src").length;e1=e2.getAttribute("src").substring(e5-this.fail_image_src.length,e5);if(e1===this.fail_image_src){this.show_fail(e7)}e6.appendChild(e7[0]);return e7[0]};T.prototype.advance_on_click=true;T.prototype.get_more_actions_above_divider=function(e3){var e2,e1;e1=T.__super__.get_more_actions_above_divider.call(this,e3);e2=this.more_actions_item_tmpl({_id:"view_original",_href:this.original_url,_target:"_blank",sprite_name:"lightbox_view_original",item_text:el("View original"),more_classes:"more-actions-item",Sprite:cm});e1.push(e2);return e1};return T})(dp);bx=B.VideoPreview=(function(T){cE(e0,T);function e0(e1){this._player_error=dg(this._player_error,this);this._player_ready=dg(this._player_ready,this);e0.__super__.constructor.call(this,e1);this.preview_url=e1.preview_url;this.shmodel_link=e1.shmodel_link;this.thumbnail_div=null;this.metadata_link=e1.metadata_link!=null?e1.metadata_link:void 0;this.metadata=null;this.player=null}e0.prototype.render_error=function(e4){var e6,e2,e1,e3,e5;e2=bv("<div/>");e1=bv("<img/>",{src:"/static/images/preview_fail-vflc3IDxf.png","class":"video-preview-fail"});e3=bv("<div/>",{"class":"video-preview-fail"});if(e4==="needflash"){e3.html(el('Install <a href="http://get.adobe.com/flashplayer/">Adobe Flash Player</a> to view this video.'))}else{e3.text(el("Unable to preview this item.",e5="web",e6="preview means showing the item in the same browser window without downloading a copy."))}e2.append(e1,e3);return e2[0]};e0.prototype._player_ready=function(){var e1;e1=function(){bv(".vjs-poster").show();bv(".vjs-big-play-button").show();return bv(".vjs-big-play-button").focus()};return e1.defer()};e0.prototype._onPlay=function(){bv(".vjs-poster").hide();return bv(".vjs-big-play-button").hide()};e0.prototype._onEnded=function(){bv(".vjs-poster").show();bv(".vjs-big-play-button").show();return bv(".vjs-loading-spinner").hide()};e0.prototype._player_error=function(e1){this.shutdown();this.div=this.render_error(e1);return bv("#file-preview-modal .content-item").html(this.div)};e0.prototype.preload=function(){};e0.prototype.render=function(e2,e1){this.div=this.render_video(e2);return this.div};e0.prototype.render_video=function(e7){var e1,e5,e3,e2,e6,e4;e4=new Element("div",{"class":"video-player content-item"});e6=this.image_size().split("x")[0]*0.8;e2=parseInt(e6*0.55,10);e5=false;e3=D.parse(this.thumbnail_url_tmpl).updateQuery({size:this.image_size()}).toString();e1=(function(e8){return function(e9){return e8.metadata=e9}})(this);this.player=bm.embed(e4,{src:this.preview_url,type:Constants.transcoder_hls4web?"application/vnd.apple.mpegurl":"video/flv",width:e6,height:e2,controls:true,preload:"auto",poster:e3,onError:this._player_error,onReady:this._player_ready,metadata:this.metadata,metadata_link:this.metadata_link,metadata_cb:e1});e7.appendChild(e4);bv(".vjs-poster").hide();bv(".vjs-big-play-button").hide();this.player.on("play",this._onPlay);this.player.on("ended",this._onEnded);return e4};e0.prototype.shutdown=function(){var e2,e1;bv(".vjs-big-play-button").blur();if(this.player){try{this.player.trigger("shutdown");if(this.player.techName==="Hls"){if((e1=this.player.tech.sourceBuffer)!=null){e1.abort()}}this.player.dispose()}catch(e3){e2=e3}return this.player=null}};return e0})(dp);aj=function(e1){var T,e0;T=(function(e3){cE(e2,e3);function e2(e4){e4.ns_id=e4.photo.ns_id;e4.ns_path=e4.photo.ns_path;e2.__super__.constructor.call(this,e4);this.photo=e4.photo;bh.set_vertical_space(3);if(bG.in_single_collection_view()){bv("#lightbox-delete-photo").val(el("Remove"))}else{bv("#lightbox-delete-photo").val(el("Delete"))}}e2.prototype.get_more_actions_above_divider=function(e6){var e5,e4;e4=e2.__super__.get_more_actions_above_divider.call(this,e6);e5=this.more_actions_item_tmpl({_id:"lightbox_add_to_album",sprite_name:"lightbox_add_to_album",item_text:el("Add to album"),more_classes:"more-actions-item",Sprite:cm});e4.push(e5);return e4};e2.prototype.toggle_select_button_off=function(e4){if(this.is_a_photo_preview()){e4.attr("title",el("Select photo"))}else{if(this.is_a_video_preview()){e4.attr("title",el("Select video"))}}e4.html(cm.make("web","lightbox_unselected"));e4.removeClass("selected");e4.addClass("elbboggiw");return setTimeout((function(){return e4.removeClass("elbboggiw")}),540)};e2.prototype.toggle_select_button_on=function(e4){if(this.is_a_photo_preview()){e4.attr("title",el("Un-select photo"))}else{if(this.is_a_video_preview()){e4.attr("title",el("Un-select video"))}}e4.html(cm.make("web","lightbox_selected"));e4.addClass("selected");e4.addClass("wiggobble");return setTimeout((function(){return e4.removeClass("wiggobble")}),540)};e2.prototype.toggle_select=function(e5){var e4;e5.preventDefault();e4=bv("#lightbox-select-button");bh.hide_all();if(eF.contains(this.photo)){eF._remove(this.photo);return this.toggle_select_button_off(e4)}else{eF._add(this.photo);return this.toggle_select_button_on(e4)}};e2.prototype.get_actions=function(e6){var e5,e4,e7;e5=[];e7=bv("<a />",{id:"lightbox_share",href:"#","class":"lightbox-button lightbox-not-important"});aE.update_share_button_text(null,bv(e7));e7.on("click",((function(e8){return function(fa){var e9;fa.preventDefault();e9=eF.get();if(e9.length===0){return ek.show([e8.photo],false)}else{return ek.show(eF.get(),false)}}})(this)));e4=bv("<a />",{id:"lightbox-select-button",href:"#","class":"title_bubble black",title:el("Select this photo")});if(eF.contains(this.photo)){e4.html(cm.make("web","lightbox_selected"))}else{e4.html(cm.make("web","lightbox_unselected"))}e4.on("click",this.toggle_select.bind(this));e5.push(e7[0]);e5.push(e4[0]);return e5.concat(e2.__super__.get_actions.call(this,e6))};e2.prototype.set_more_actions_event_handlers=function(e4){$("lightbox_add_to_album").observe("click",((function(e5){return function(e6){e6.preventDefault();return cw.show_add_to_album_modal(e6,[e5.photo])}})(this)));$("lightbox_show_in_folder").observe("click",((function(e5){return function(e6){e6.preventDefault();return bG.show_in_folder(e5.photo)}})(this)));return e2.__super__.set_more_actions_event_handlers.call(this,e4)};e2.prototype.get_more_actions_below_divider=function(e6){var e5,e4;e5=[];e4=this.more_actions_item_tmpl({_id:"lightbox_show_in_folder",sprite_name:"lightbox_show_in_folder",item_text:el("Show in folder"),more_classes:"more-actions-item",Sprite:cm});e5.push(e4);e5=e5.concat(e2.__super__.get_more_actions_below_divider.call(this,e6));return e5};return e2})(e1);e0=(function(e3){cE(e2,e3);function e2(){return e2.__super__.constructor.apply(this,arguments)}e2.prototype.get_more_actions_below_divider=function(e6){var e4,e5;e5=[];e4=this.more_actions_item_tmpl({_id:"lightbox_remove_from_album",sprite_name:"lightbox_remove_from_album",item_text:el("Remove from album"),more_classes:"more-actions-item",Sprite:cm});e5.push(e4);e5=e5.concat(e2.__super__.get_more_actions_below_divider.call(this,e6));return e5};e2.prototype.set_more_actions_event_handlers=function(e4){$("lightbox_remove_from_album").observe("click",((function(e5){return function(e6){e6.preventDefault();return cw.show_remove_photos_modal(bG.get_current_collection(),[e5.photo])}})(this)));return e2.__super__.set_more_actions_event_handlers.call(this,e4)};return e2})(T);return[T,e0]};v=aj(V),dc=v[0],eC=v[1];d7=aj(bx),eJ=d7[0],ao=d7[1];var aE;aE=INLINE_JS.Lightbox=B.Lightbox=(function(){var fj,fh,fP,fO,fB,e7,e0,fo,fx,fT,fN,e6,fw,fI,fe,fH,ft,fC,fS,fd,fu,fb,fG,fK,e5,fJ,e4,fm,fM,fg,fv,e8,fp,fD,fq,fz,e2,fi,T,fy,fL,fR,fF,ff,fl,e3,fk,fA,e1,e9,fE,fr,fs,fc,fn,fa,fQ;fO=[];fj=0;fB=false;fP=true;fr=void 0;e0=/^\d+\-\d+\-\d+\s+\d+\.\d+\.\d+/;e7=false;fM=void 0;fI=void 0;fA=-1;e1=null;fC=null;fu=false;T=false;e5=false;fb=null;fd=function(fU){return fU.complete!==false};e3=function(){var fU;if($$("#file-preview-modal .loading-image").length){return}fU=new Element("img",{"class":"loading-image",src:"/static/images/icons/ajax-loader-black-vflweQQeE.gif"});return $$("#file-preview-modal .preview-content").first().__sert(fU)};ft=function(){return $$("#file-preview-modal .loading-image").invoke("remove")};fq=function(){var f0,fZ,fW,fU,fY,fX,fV;fZ=$$("#file-preview-modal .content-item").first().down("img.thumbnail");if(!fZ||!fd(fZ)){return}fU=$$("#file-preview-modal .preview").first().getDimensions();f0=void 0;if(!fZ.naturalHeight){f0=fZ.getDimensions();fZ.naturalHeight=f0.height;fZ.naturalWidth=f0.width}else{f0={width:fZ.naturalWidth,height:fZ.naturalHeight}}fW=f0.width/fU.width;fV=f0.height/fU.height;fX=Math.max(fW,fV);fZ.style.visibility="";if(fX<1){fZ.style.width="";fZ.style.height=""}else{fZ.style.width=Math.floor(f0.width/fX)+"px";fZ.style.height=Math.floor(f0.height/fX)+"px"}fY=bv("#file-preview-modal .paging-block").position().left-16;return bv("#file-preview-modal .filename").css("max-width",fY)};fw=void 0;fJ=function(){var f1,fW,f0,fZ,fY,fV,fX,fU;fW=$("file-preview-modal");fZ=fW.down(".menu");f0=fW.down(".header");fX=$$(".lightbox-not-important");fU=[];for(fY=0,fV=fX.length;fY<fV;fY++){f1=fX[fY];fU.push(f1.addClassName("opacity-zero"))}return fU};fk=function(){var fY,fX,fV,fW,fU;if(fw){clearTimeout(fw)}fW=$$(".lightbox-not-important");fU=[];for(fX=0,fV=fW.length;fX<fV;fX++){fY=fW[fX];fU.push(fY.removeClassName("opacity-zero"))}return fU};fz=function(fV){var fU;fk();fU=fV&&$(fV.target).descendantOf("file-preview-menu");if(fw!=null){clearTimeout(fw)}if(fP){if(!e7&&!fU){return fw=setTimeout(fJ,3112)}}};fE=function(){if(fw!=null){clearTimeout(fw)}return fP=false};e9=function(){fP=true;return fz()};fS=function(fV){var fU;fU=fO.length;return(fU+(fj+fV)%fU)%fU};fv=function(fV){var fU,fW;if(fM.no_preload){return}fU=ff.bind(null,fV);return typeof(fW=fO[fV]).preload==="function"?fW.preload(fU):void 0};e8=function(){var fW,fY,fV,fX,fU;fX=[1,2,3,4,5,6,-1,-2];fU=[];for(fY=0,fV=fX.length;fY<fV;fY++){fW=fX[fY];if(Math.abs(fW)<fO.length){fU.push(fv(fS(fW)))}else{fU.push(void 0)}}return fU};fi=function(fU){if(!fM.filename_in_url){return}if(fU!=null){aW.replace_hash("lh",fU)}else{aW.replace_hash("")}return fb=fU};fD=function(){var fU,fV;fU=bv("#file-preview-modal");fV=fM.num_previews||fO.length;if(fu&&T&&e5){fU.find(".lightbox-index-text-container").text(el("Could not load folder",{comment:"Error shown when a folder fails to load"}))}else{if(fu){if(T){fU.find(".lightbox-index-text-container").text(el("Loading...",{comment:"Shown while waiting for photos/videos to load"}))}else{fU.find(".lightbox-index-text-container").text("")}}else{fU.find(".lightbox-index-text-container").text(el("%(cur_file_num)s of %(num_total_files)s",{comment:"Indicating which we're viewing, like '3 of 10'"}).format({cur_file_num:fj+1,num_total_files:fV}))}}if(fO.length===1){fU.find(".prev").addClass("opacity-zero");return fU.find(".next").addClass("opacity-zero")}else{if(fj===0&&fM.no_wrap){fU.find(".prev").addClass("opacity-zero");return fU.find(".next").removeClass("opacity-zero")}else{if(fj===fO.length-1&&fM.no_wrap){fU.find(".prev").removeClass("opacity-zero");return fU.find(".next").addClass("opacity-zero")}else{fU.find(".prev").removeClass("opacity-zero");return fU.find(".next").removeClass("opacity-zero")}}}};fy=function(fW,gf){var f4,f5,f6,gb,f0,fX,fY,fU,ga,ge,gd,f9,f2,f8,f1,f7,gc,fV,gg,f3,fZ;fA=bU.time();cz(fj<fO.length,"Invalid index "+fj);f7=fO[fj];if(typeof f7!=="object"){if(e1){clearTimeout(e1)}e1=setTimeout((function(){if((aE.shown!=null)&&aE.shown){return fy(fW,gf)}}),100);return}bv("#file-preview-modal").trigger(aE.LIGHTBOX_SHOW_EVT,{preview:f7});if(f7.fq_path!=null){fY="browse_lightbox"}else{if(f7.shmodel_link!=null){fY="shmodel_lightbox"}else{fY="lightbox"}}fX=av.file_extension_for_logging(f7.filename);ga={mode:fY,file_ext:fX};a3.UserActivityLogger.log("web","file_view",ga);a3.WebLightboxLogger.log(a3.WebLightboxLogger.VIEW,{context:fY,file_ext:fX});gd=bv("#file-preview-modal");gc=gd.find(".preview-content");f1=fW?fF:ff;gc.empty();f0=f7.render(gc[0],f1);gd=gd[0];if(!fC){fC=gd.on("contextmenu","img.thumbnail",bg.show_for_lightbox.bind(bg))}fi(f7.link_hash);fD();if(f7.display_time){if(f7.filename.match(e0)){gd.down(".filename").__date(f7.display_time)}else{gd.down(".filename").__date(f7.display_time+" - "+f7.filename)}}else{gd.down(".filename").__date(f7.filename)}gd.down(".filename").writeAttribute("title",f7.filename);if(bG.in_single_collection_view()&&((f3=bG.get_current_collection().member_fnames)!=null?f3.length:void 0)>1&&(((fZ=f7.photo)!=null?fZ.item_owner_fname:void 0)!=null)){gb="&nbsp;&nbsp;&middot;&nbsp;&nbsp;";gb+=el("Added by %(fname)s").format({fname:bK.em_snippet(f7.photo.item_owner_fname,7)});gd.down(".added-by").__date(new eV(gb));gd.down(".added-by").show()}else{gd.down(".added-by").hide()}f2=eV.tmpl("lightbox_more_actions_item_tmpl");f9=f7.get_more_actions_above_divider(fM);f6=f7.get_more_actions_below_divider(fM);if(f6.length){f9.push(f2({divider:true,Sprite:cm}));f9=f9.concat(f6)}$("lightbox-more-actions-list").__date(f9);f7.set_more_actions_event_handlers(fM);if(bv(gd).data("is-unity-allowed")==="True"&&(__CONDITIONAL_JS__.UnityFeatures!=null)){f7.replace_dl_action_with_open_action_if_file_available()}f5=f7.get_actions(fM);fU=document.createDocumentFragment();for(fV=0,gg=f5.length;fV<gg;fV++){f4=f5[fV];fU.appendChild(f4)}gd.down(".actions").__date();gd.down(".actions").appendChild(fU);if(fM.share_button_experiment_variant==="WHITE_BUTTON"){f8=bv("#lightbox-more-actions-button .sprite-div").width();bv("#lightbox-more-actions-menu").css("right",f8/2)}document.fire(aE.ACTIONS_ADDED);if(bG.in_single_collection_view()){gd.down(".album-name").show().__date(bK.em_snippet(bG.get_current_collection().name,15,1));gd.down(".filename").addClassName("faded")}else{gd.down(".album-name").hide();gd.down(".filename").removeClassName("faded")}f0=f0.down("img.thumbnail");if(f0){if(!fd(f0)){f0.hide();e3();f0.observe("load",function(){ft();f0.style.visibility="hidden";f0.show();return fq()})}else{f0.show();fq()}}ge={preview_obj:f7,index:fj,direction:gf};return document.fire(aE.PHOTO_CHANGE_EVT,ge)};fR=function(fZ){var fV,fW,fU,fX,fY;if(fA===-1){return}fY=bU.time()-fA;if(typeof h!=="undefined"&&h!==null){fV=h.get_current_view()}else{if(typeof ag!=="undefined"&&ag!==null?ag.is_album:void 0){fV="album_shmodel"}else{fV="not_photos"}}fW={current_view:fV};fU=bv("#file-preview-modal .content-item img.thumbnail")[0];if((fU!=null)&&(fU.src!=null)){fX=D.parse(fU.src).getQuery();if("size" in fX){fW.size=fX.size}}d3.log_ajax_transition(fY,fZ,fW);fA=-1;return e8()};fF=function(){return fR("file-preview-lightbox-load-initial")};ff=function(fU){var fV;if(typeof fU==="number"){if((fV=fO[fU])!=null){fV.loaded=true}if(fU===fj){return fR("file-preview-lightbox-load")}}else{return fR("file-preview-lightbox-load")}};fL=function(fU){var fV;fV=bv("#lightbox-click-catcher");if(!fV.length){fV=bv("<div />",{id:"lightbox-click-catcher",style:"position: absolute; width: 100%; height: 100%; top: 0px; left: 0px; z-index: 2;"});fV.appendTo("#file-preview-modal .modal-preview-content");if(bR.msie_version_at_most(10)){fV.css("background","black");fV.fadeTo(0,0)}}fV.off("click");fV.on("click",(function(fW){fW.preventDefault();return fU()}));return fV.show()};fe=function(){return bv("#lightbox-click-catcher").hide()};fT=function(){var fU;fU=bv("#lightbox-more-actions-button");if(fU.hasClass("toggled")){fe();fU.removeClass("toggled");$("lightbox-more-actions-menu").hide();bv(document).trigger("dropdownClosed",[1]);e9();return true}return false};fm=function(){var fU;fU=bv("#lightbox-more-actions-button");if(!fU.hasClass("toggled")){fH();fU.addClass("toggled");bh.hide_all();bv("#lightbox-more-actions-menu").show();bv(document).trigger("dropdownOpened",[1]);fE();return fL(aE.close_more_actions_menu)}};fc=function(){if(bv("#lightbox-more-actions-button").hasClass("toggled")){return fT()}else{return fm()}};e4=function(fV){var fU;if(fu){T=true;fD()}fT();if(fV){fV.preventDefault()}if(fj===fO.length-1&&fM.no_wrap){return}if((fU=fO[fj])!=null){fU.shutdown()}fj=fS(1);if(fj===0){fz()}return fy(null,aE.NEXT)};fp=function(fV){var fU;if(fu){T=true;fD()}fT();if(fV){fV.preventDefault()}if(fj===0&&fM.no_wrap){return}if((fU=fO[fj])!=null){fU.shutdown()}fj=fS(-1);return fy(null,aE.PREV)};fx=function(fU){if(fU){fU.preventDefault()}if(fO[fj].advance_on_click){if(fU.clientX<bv(window).width()/10){return fp()}else{return e4()}}};fN=function(f0){var fX,fW,fZ,f1,fY,fV,fU;fX=fO.dict_by("fq_path");f1=void 0;if(f0.memo.files){f1=f0.memo.files.collect(function(f2){return f2.fq_path})}else{f1=f0.memo.fq_paths}fU=[];for(fY=0,fV=f1.length;fY<fV;fY++){fZ=f1[fY];if(fX[fZ]){fW=fO.indexOf(fX[fZ]);fO.splice(fW,1);if(fM.num_previews){fM.num_previews--}if(!fM.num_previews&&!fO.length){fU.push(fI())}else{if(fW===fO.length){fU.push(fp())}else{fU.push(fy())}}}else{fU.push(void 0)}}return fU};e2=function(fU){if(fO[fj].is_a_timeline_preview()){return fO[fj].toggle_select(fU)}};fn=function(){Event.stopObserving(document,"mousemove",fz);Event.stopObserving(document,"click",fz);document.stopObserving(aE.PHOTO_DELETE_EVT,fg);document.stopObserving(aC.DELETE,fN);document.stopObserving(eF.CHANGE_EVT,fa);return clearInterval(fr)};fI=function(fX){var fV,fW,fU,fY;if(fX){fX.preventDefault()}if(!aE.shown){return}if((fW=fO[fj])!=null){fW.shutdown()}fV=$("file-preview-modal");fV.hide();fV.down(".preview-content").__date();z.scroll_unlock_document();fn();fi();aE.shown=0;fV.stopObserving("click",aE.back);if((fU=$$(".preview-content"))!=null){if((fY=fU.first())!=null){fY.stopObserving("click")}}bv("#file-preview-modal").trigger(aE.LIGHTBOX_HIDE_EVT);if(aE.reload){return ci.force_reload()}};fh="db:filepreview:exitselect";fo=function(fV){var fU;if(fM.keep_url){fI()}else{if((fU=fO[fj])!=null){fU.shutdown()}window.history.go(-1)}if(fV!=null){if(fV.originalEvent){fV=fV.originalEvent}Event.extend(fV).stop()}return document.fire(fh,fO[fj])};fg=(function(fU){return function(fV){return dn.do_delete(ci.active_user,fV.memo.fq_path)}})(this);fK=function(){var fU;if(!fB){fU=bv("#file-preview-modal");fU.on("click",".close",fo);key("esc",aE.KEY_SCOPE,(function(fV){if(bv("#lightbox-more-actions-button").hasClass("toggled")){return fT()}else{if(e7){return fH()}else{return fo(fV)}}}));fU.on("click",".next",e4);fU.on("click",".prev",fp);fU.on("click",".preview-container",fx);key("left, k",aE.KEY_SCOPE,function(fV){return fp()});key("right, j",aE.KEY_SCOPE,function(fV){e4();return false});key("up, down",aE.KEY_SCOPE,function(fV){return false});key("x, s, space",aE.KEY_SCOPE,function(fV){e2(fV);return false});if(fM.include_delete&&fM.share_button_experiment_variant!=="WHITE_BUTTON"){key("delete, command+backspace, backspace",aE.KEY_SCOPE,function(fV){Event.extend(fV).preventDefault();return aE.toggle_delete()});bv("#lightbox-delete-photo").on("click",(function(fV){fs();return fO[fj].delete_pressed()}));bv("#lightbox-delete-cancel").on("click",fH)}eo.add_exit_callback("/lightbox",function(){return fI()});dQ.disableSelection(fU.find(".preview-container")[0]);dQ.disableSelection(fU.find(".header")[0]);fB=true}Event.observe(document,"mousemove",fz);Event.observe(document,"click",fz);document.observe(aC.DELETE,fN);document.observe(aE.PHOTO_DELETE_EVT,fg);document.observe(eF.CHANGE_EVT,fa);key.setScope(aE.KEY_SCOPE);return fr=setInterval(fq,500)};fG=function(){var fW,fY,fX,fV,fU;if(!fb){return}fU=[];for(fW=fX=0,fV=fO.length;fX<fV;fW=++fX){fY=fO[fW];if(fY.link_hash&&fY.link_hash.toLowerCase()===fb.toLowerCase()){fj=fW;if(!aE.shown){fU.push(aE.show())}else{fU.push(fy())}}else{fU.push(void 0)}}return fU};fQ=function(){return on_script_loaded(function(){aW.watch("lh",function(fU){fb=fU;return fG()});return aW.watch("f",function(fW){var fX,fZ,fY,fV,fU;fU=[];for(fX=fY=0,fV=fO.length;fY<fV;fX=++fY){fZ=fO[fX];if(fZ.filename.toLowerCase()===fW.toLowerCase()){fj=fX;if(!aE.shown){fU.push(aE.show())}else{fU.push(fy())}}else{fU.push(void 0)}}return fU})})};fa=function(fY,f0){var fW,fZ,fV,fX,fU;if(f0==null){f0=bv("#lightbox_share")}fV=eF.get();fX=cV.categorize_files(fV),fW=fX[0],fZ=fX[1];if(fV.length===0){f0.text(el("Share"));return(fU=fO[fj])!=null?fU.toggle_select_button_off(bv("#lightbox-select-button")):void 0}else{if(fV.length===1){if(fW){return f0.text(el("Share 1 photo"))}else{return f0.text(el("Share 1 video"))}}else{if(fW&&fZ){return f0.text(el("Share %(num_files)s items",{comment:"num_files is a number greater than 1"}).format({num_files:fV.length}))}else{if(fW){return f0.text(el("Share %(num_photos)s photos",{comment:"num_photos is a number greater than 1"}).format({num_photos:fV.length}))}else{return f0.text(el("Share %(num_videos)s videos",{comment:"num_videos is a number greater than 1"}).format({num_videos:fV.length}))}}}}};fl=function(){bh.hide_all();bv("#file-preview-modal .delete-file-prompt").show();bv(document).trigger("dropdownOpened",[1]);fk();e7=true;fL(aE.toggle_delete);return bv("#lightbox-delete-photo").focus()};fH=function(){var fV,fU;if(e7){fV=bv("#file-preview-modal .delete-file-prompt");fV.hide();bv(document).trigger("dropdownClosed",[1]);if((fU=fV.find(":focus")[0])!=null){fU.blur()}fz();e7=false;return fe()}};fs=function(){fT();if(e7){return fH()}else{return fl()}};e6=function(){return fO[fj].delete_pressed()};return{init_from_preview_objs:function(fX,f1,fW){var f0,fZ,fU,fY,fV;if(fW==null){fW=true}fU=[];for(fY=0,fV=fX.length;fY<fV;fY++){f0=fX[fY];if(f0.is_video){fZ=new bx({filename:f0.filename,fq_path:f0.path,thumbnail_url_tmpl:f0.thumbnail_url,preview_url:f0.preview_url,dl_url:f0.dl_url,shmodel_link:f0.shmodel_link,ns_id:f0.ns_id,ns_path:f0.path,link_hash:f0.item_id+"-"+f0.filename,metadata_link:f0.metadata_link})}else{fZ=new V({filename:f0.filename,fq_path:f0.path,thumbnail_url_tmpl:f0.thumbnail_url,dl_url:f0.dl_url,original_url:f0.orig_url,shmodel_link:f0.shmodel_link,ns_id:f0.ns_id,ns_path:f0.ns_path,link_hash:f0.item_id+"-"+f0.filename,enable_download:f0.enable_download})}fU.push(fZ)}aE.init(fU,{include_delete:false,keep_url:true,filename_in_url:true,enable_sublinks:fW});return document.on(aE.EXIT_SELECT_EVT,(function(f2){return function(f4){var f3;key.setScope("all");f3=bv(f1)[fU.indexOf(f4.memo)];dQ.scroll_to_thumb(f3);bv(f3).addClass("wiggobble");return setTimeout((function(){return bv(f3).removeClass("wiggobble")}),1000)}})(this))},init:function(fU,fV){if(aE.shown){return}aE.more_actions_button=new Element("a",{id:"lightbox-more-actions-button",href:"#","class":"lightbox-more-actions-button title_bubble black extra-margin",title:el("More actions")});aE.more_actions_button.observe("click",((function(fW){return function(fX){fX.preventDefault();return aE.toggle_more_actions_menu()}})(this)));aE.more_actions_button.__date(cm.make("web","lightbox_more"));fV=fV||{};fM={include_delete:fV.include_delete||false,keep_url:fV.keep_url||false,num_previews:fV.num_previews||null,filename_in_url:fV.filename_in_url||false,no_wrap:(fV.no_wrap||false)||true,no_preload:fV.no_preload||false,enable_sublinks:fV.enable_sublinks!=null?fV.enable_sublinks:true,share_button_experiment_variant:fV.share_button_experiment_variant||false};fu=fV.is_loading||false;cz(!fM.filename_in_url||fM.keep_url,"filename_in_url cannot be used with keep_url off");fO=fU;if(fV.start_index!=null){aE.show(fV.start_index)}if(fM.filename_in_url){fQ()}return $(document.body).on("click",".more-actions-item",function(fW,fX){if(fX.down("a").getAttribute("href").length<2){fW.preventDefault()}return aE.close_more_actions_menu()})},update_previews:function(fU){return fO=fU},show:function(fU){var fV,fW;if(aE.shown){return}cz(fO&&fO.length,"Lightbox.show() requires file preview objects to show");fK();if(fU!=null){fj=fU}bv("#file-preview-modal").trigger("lightbox-init-show",{preview:fO[fj]});if((fW=fO[fj])!=null?fW.enable_download:void 0){aE.more_actions_button.show()}else{aE.more_actions_button.hide()}cz(!aE.shown,"Trying to reshow file preview modal");$("file-preview-modal").show();z.scroll_lock_document();fy(true);aE.shown=1;if(!fM.keep_url){fV=eo.deconstruct_url(eo.get_url());if(fV.path.indexOf("/lightbox/")!==0){eo.push_state("/lightbox"+fV.path,fV.qargs)}}return fz()},jump_to:function(fU){cz(aE.shown,"Lightbox should be showing");fj=fU;fy();return fz()},set_no_wrap:function(fU){return fM.no_wrap=fU},refresh_file_list:function(fX){var fW,fZ,fV,fY,fU;if(aE.shown){fZ=fO[fj].fq_path}fO=aY.browsefile_to_filepreview(fX);fG();if(!aE.shown){return}for(fV=fY=0,fU=fO.length;fY<fU;fV=++fY){fW=fO[fV];if(fW.fq_path===fZ){fj=fV;break}}fu=false;T=false;return fD()},update_with_error:function(){e5=true;return fD()},num_previews:function(){return fM.num_previews||fO.length},get_previews:function(){return fO},current_index:function(){return fj},close_more_actions_menu:fT,toggle_more_actions_menu:fc,update_share_button_text:fa,toggle_delete:fs,delete_current:e6,back:fo,PHOTO_CHANGE_EVT:"db:lightbox:photo_change",PHOTO_DELETE_EVT:"db:lightbox:photo_delete",PHOTO_REMOVE_FROM_ALBUM_EVT:"db:lightbox:photo_remove_from_album",ACTIONS_ADDED:"db:lightbox:actions_added",EXIT_SELECT_EVT:fh,reload:false,NEXT:1,PREV:-1,vid_thumbnail_hidden:null,KEY_SCOPE:"lightbox",LIGHTBOX_HIDE_EVT:"lightbox-hide",LIGHTBOX_SHOW_EVT:"lightbox-preview"}})();var bw;bw=B.Tour=(function(){var e2,e1,e4,e5,e9,e7,e8,e6,e3,fa,e0,T;e1=6;e2=0;e0=function(fb){var fk,fj,fi,fd,fc,fe,fg,fh,ff;$$(".page-end").each(Element.remove);fc=fb;fg=e1-fb-1;fk=document.createDocumentFragment();for(fj=fh=0;0<=fc?fh<fc:fh>fc;fj=0<=fc?++fh:--fh){fd=new Element("img",{src:"/static/images/page-left-vflvWgvOr.png","class":"page-end-left page-end"});fd.style.left=(28-fj*5)+"px";fd.style.zIndex=e1-fj;fk.appendChild(fd)}for(fi=ff=0;0<=fg?ff<fg:ff>fg;fi=0<=fg?++ff:--ff){fe=new Element("img",{src:"/static/images/page-right-vflnAeb-6.png","class":"page-end-right page-end"});fe.style.right=(31-fi*5)+"px";fe.style.zIndex=e1-fi;fk.appendChild(fe)}return $("book").appendChild(fk)};T=function(fb){(fb>0?Element.show:Element.hide)("tour-page-back");return(fb+1<e1?Element.show:Element.hide)("tour-page-forward")};e3=function(fb){$$(".pages").invoke("hide");return $("page-"+fb).show()};e4=function(fb){T(fb);e0(fb);e3(fb);return e2=fb};e6=function(fc){var fb;Event.extend(fc).preventDefault();fb=e2-1;if(fb<0){return}e4(fb);return eo.push_state("/tour/"+fb)};e7=function(fc){var fb;Event.extend(fc).preventDefault();fb=e2+1;if(fb>=e1){return}e4(fb);return eo.push_state("/tour/"+fb)};fa=function(fc,fd){var fb;fc.preventDefault();fb=parseInt(fd.href.split("/").last(),10);e4(fb);return eo.push_state("/tour/"+fb)};e9=function(){$("tour-page-back").observe("click",e6);$("tour-page-forward").observe("click",e7);key("right",e7);key("left",e6);return $("toc").on("click","a",fa)};e5=function(fc,fd){var fb;fb=parseInt(fc,10)||0;if(fb<0||fb>=e1){fb=0}return e4(fb)};e8=function(){var ff,fe,fc,fd,fb;fd=$$(".page-right img");fb=[];for(fe=0,fc=fd.length;fe<fc;fe++){ff=fd[fe];fb.push(dQ.preload_image(ff.src))}return fb};return{setup:function(){return bv(function(){eo.add_callback("/tour",e5);e9();return e8()})}}})();var bG,bB=[].indexOf||function(e1){for(var e0=0,T=this.length;e0<T;e0++){if(e0 in this&&this[e0]===e1){return e0}}return -1};bG=INLINE_JS.Photos=B.Photos={THUMB_SIZE:198,MONTH_HEADER_HEIGHT:46,COLLECTION_HEADER_HEIGHT:4,LIGHTBOX_OFFSET:25,DUPLICATES_SNIPPET_LENGTH:30,KEY_SCOPE:"photos",NUM_PHOTOS_LONG_RUNNING_DELETES:100,NUM_PHOTOS_LONG_RUNNING_EDIT_TIMESTAMP:200,_all_photos_timeline:null,_single_collection_timeline:null,_last_lightbox_photo:null,_current_collection_gid:null,_in_all_collections_view:false,_tmpl:null,_cu_duplicate_tmpl:null,_creating_filetags:false,_creating_filetags_cb:null,event_metadata_cache:{},scroll_count:0,initialized:false,_init_finished:false,init:function(e5,e0,e2,e9,e6,e1,T,e7,fb){var e4,e8,fa,e3;this.event_metadata_cache=T;this.initialized=true;this.disable_selection();dQ.disable_ie_image_dragging();this._tmpl=eV.tmpl("cu_list_item_tmpl");this._cu_duplicate_tmpl=eV.tmpl("cu_duplicate_list_item_tmpl");this._current_collection_gid=e6!=null?e6.gid:void 0;key.setScope(this.KEY_SCOPE);this.include_shared_folders=e7.include_shared_folders;this.show_hidden=e7.show_hidden;this.timestamp_edit_enabled=fb.timestamp_edit_enabled;this.undo_enabled=fb.undo_enabled;this.local_storage_enabled=fb.local_storage_enabled;e8=eo.deconstruct_url();e3="share" in e8.qargs;for(fa in e9){if(e9.hasOwnProperty(fa)){eF.inc_num_loading_events_before_select(e3)}}this._init_timeline(e5,e0,e2,e9);this._init_lightbox();e4=[];if(e6!=null){e4.push(new Z(e6,false))}cw.init(e4,e1);eF.drag_select_enabled=fb.drag_select_enabled;if(e7.show_photos_tour){aG.next()}delete e8.qargs.selr;delete e8.qargs.user_email;delete e8.qargs.uid;delete e8.qargs.share;delete e8.qargs.m;if("uuid" in e8.qargs){delete e8.qargs.uuid;delete e8.qargs.id}if(dx){eo.replace_state(e8.path,e8.qargs)}else{if(!D.parse(window.location.href).fragment){eo.push_state("/photos",e8.qargs)}}this._listen();return this._init_finished=true},_listen:function(){$(document.body).on("click",".cu-thumb",this._thumb_click.bind(this));$(document.body).on("dblclick",".cu-thumb",this._thumb_double_click.bind(this));$(document.body).on("contextmenu",".cu-thumb",this._thumb_context_menu.bind(this));document.observe(aE.PHOTO_CHANGE_EVT,this._lightbox_photo_change.bind(this));document.observe(aE.PHOTO_DELETE_EVT,this._lightbox_delete.bind(this));document.observe(aE.PHOTO_REMOVE_FROM_ALBUM_EVT,this._lightbox_remove.bind(this));document.observe(aE.EXIT_SELECT_EVT,this._lightbox_exit.bind(this));document.observe(bg.HIDE_EVT,this._context_menu_hide.bind(this));Event.observe(window,"resize",this._window_resize.bind(this));eo.add_callback("/photos",this._history_change_handler.bind(this));document.observe(cZ.EVENT_MISCOUNT_EVT,this._photos_changed.bind(this));document.observe(cZ.PHOTOS_LOADED_EVT,this._photos_loaded.bind(this));document.observe(b9.PHOTOS_ADDED_EVT,this._photos_changed.bind(this));document.observe(b9.PHOTOS_REMOVED_EVT,this._photos_changed.bind(this));bv("#photos-nav-item").on("click",this.show_all_photos.bind(this));bv("#back-to-photos").on("click",this._back_to_photos.bind(this));bv("#back-to-albums").on("click",this._back_to_albums.bind(this));bv("#share-selected").on("click",this._share_selected.bind(this));bv("#clear-selected").on("click",this._clear_selected.bind(this));bv("#share-collection").on("click",this._share_collection.bind(this));if(this.include_shared_folders){bv("#do-include-shared-folders").prop("checked",true)}else{bv("#dont-include-shared-folders").prop("checked",true)}cw.listen();eF.listen();$(document.body).on("click",".event-select",this._select_event.bind(this));$(document.body).on("click",".event-share",this._share_event.bind(this));$(document.body).on("click",".event-add-to-album",this._add_event_to_album.bind(this));return bv(".show-all-photos").on("click",this.show_all_photos.bind(this))},_select_event:function(e6){var e2,e5,e1,e4,e0,e3,T;e5=$(e6.target).up(".cu-month-header").identify().slice(2);e2=this.get_timeline().events.valueFromKey(e5);e3=e2.photos;T=[];for(e4=0,e0=e3.length;e4<e0;e4++){e1=e3[e4];T.push(eF._add(e1))}return T},_share_event:function(e5){var e1,e4,e0,e3,T,e2;e4=$(e5.target).up(".cu-month-header").identify().slice(2);e1=this.get_timeline().events.valueFromKey(e4);e2=e1.photos;for(e3=0,T=e2.length;e3<T;e3++){e0=e2[e3];eF._add(e0)}return this._share_selected()},_add_event_to_album:function(e5){var e1,e4,e0,e3,T,e2;e4=$(e5.target).up(".cu-month-header").identify().slice(2);e1=this.get_timeline().events.valueFromKey(e4);e2=e1.photos;for(e3=0,T=e2.length;e3<T;e3++){e0=e2[e3];eF._add(e0)}return cw.show_add_to_album_modal(e5,eF.get())},_init_timeline:function(e6,e1,e2,e8){var e0,e9,e7,T,fa,e5,e4,e3;if(!e6.length){this.show_empty_state();return}e0=this.in_single_collection_view()?$("single-collection-list"):$("photos-list");e5=$("cu-view").cumulativeOffset().top+e0.getLayout().get("margin-top")+e0.getLayout().get("padding-top");if(bv("#carousel-promo-banner").outerHeight()){e5+=bv("#carousel-promo-banner").outerHeight()-$("cu-view").cumulativeOffset().top}e7=$("cu-view").cumulativeOffset().left+e0.getLayout().get("margin-left")+e0.getLayout().get("padding-left");e9={top_offset:e5,left_offset:e7,thumb_size:this.THUMB_SIZE,header_height:this.in_single_collection_view()?this.COLLECTION_HEADER_HEIGHT:this.MONTH_HEADER_HEIGHT};T={uses_lightbox:true,uses_timeline_nav:true,log_thumb_loading:true};fa=new b9(e0,null,e6,e1,e2,e8,this._tmpl,e9,T);if(this.in_single_collection_view()){if((e4=this._single_collection_timeline)!=null){e4.unlisten()}this._single_collection_timeline=fa}else{if((e3=this._all_photos_timeline)!=null){e3.unlisten()}this._all_photos_timeline=fa}return this.get_timeline().render()},_init_lightbox:function(){var e0,T;if(this.get_timeline()==null){return}if(aE.shown){T=this.get_timeline().get_preview_objs();if(T.length){aE.update_previews(T);e0=Math.min(aE.current_index(),T.length-1);return aE.jump_to(e0)}else{return aE.back()}}else{return aE.init(this.get_timeline().get_preview_objs(),{include_delete:true,no_wrap:true})}},_photos_loaded:function(){return this._init_lightbox()},_photos_changed:function(){this._init_lightbox();return this.set_empty_state()},_refresh_view:function(e0){var T;if((T=this.get_timeline())!=null){T.unlisten()}eF.clear();$("cu-empty").hide();$("single-album-empty").hide();if(this.in_single_collection_view()){$("single-collection-list").__date()}this._refresh_photo_events(e0);return window.scrollTo(0,0)},_refresh_photo_events:function(T){this.event_metadata_cache=null;return new Ajax.DBRequest("/photos_events",{parameters:{collection_gid:this._current_collection_gid,show_hidden:this.show_hidden},onSuccess:(function(e0){return function(e1){var e2;e2=JSON.parse(e1.responseText);if(e2==="deleted_collection"){e0._current_collection_gid=null;cw.reload();e0.show_all_collections();ab.error(el("This album has been deleted!"));return}e0._init_timeline(e2.header_ids,e2.header_id_to_name,e2.header_id_to_num_photos,{});e0._init_lightbox();return typeof T==="function"?T():void 0}})(this)})},set_empty_state:function(){if(this.get_timeline().events.length()){return this.hide_empty_state()}else{return this.show_empty_state()}},show_empty_state:function(){if(this.in_single_collection_view()){return $("single-album-empty").show()}else{return $("cu-empty").show()}},hide_empty_state:function(){if(this.in_single_collection_view()){return $("single-album-empty").hide()}else{return $("cu-empty").hide()}},get_timeline:function(){if(this.in_single_collection_view()){return this._single_collection_timeline}else{return this._all_photos_timeline}},show_in_folder:function(T){if(T.duplicates_info!=null){return this._show_duplicates_modal(T,false)}else{return window.open(this._get_browse_link(T),"_blank")}},_get_browse_link:function(e0){var T;T=eX.get_browse_root(cB.get_viewer().photos_user);return String(D({path:""+T+(av.normalize(av.parent_dir(e0.fq_path))),query:{select:e0.filename}}))},in_single_collection_view:function(){return this._current_collection_gid!=null},in_all_collections_view:function(){return this._in_all_collections_view},get_current_collection:function(){if(this._current_collection_gid!=null){return cw.get(this._current_collection_gid)}else{return null}},enable_selection:function(){return dQ.enableSelection($(document.body))},disable_selection:function(){return dQ.disableSelection($(document.body))},show_collection:function(e1){var e0,T;h.log_transition_to(cc.SINGLE_COLLECTION_VIEW);T=eo.deconstruct_url();e0="/lightbox";if(T.path.indexOf(e0)===0){T.path=T.path.slice(e0.length);key.setScope(this.KEY_SCOPE);this._last_lightbox_photo=null}if(bB.call(T.path,"/album/")<0){if(T.path==="/photos/all_albums"){$("back-to-photos").hide();$("back-to-albums").show()}else{$("back-to-albums").hide();$("back-to-photos").show()}}if(e1!=null){T.path=cw.get(e1).url}return eo.push_state(T.path,T.qargs)},show_all_collections:function(){h.log_transition_to(cc.ALBUMS_VIEW);return eo.push_state("/photos/all_albums")},show_all_photos:function(e0){var T;e0.preventDefault();h.log_transition_to(cc.PHOTOS_VIEW);T=eo.deconstruct_url();if(T.path==="/photos"){return this._refresh_view()}else{eF.clear();return eo.push_state("/photos")}},_back_to_photos:function(T){eF.clear();return this.show_all_photos(T)},_back_to_albums:function(T){eF.clear();return this.show_all_collections()},get_thumb_click_event_data:function(e1,T){var e0;e0=e1.event;return{timeline_photo_index:T,event_photo_index:e0.photos.indexOf(e1),num_photos_in_event:e0.photos.length,event_index:this.get_timeline().events.list.indexOf(e0.unique_id),num_events:this.get_timeline().events.list.length}},_thumb_click:function(e0){var T;T=this.get_timeline().get_photo_for_thumb_elm($(e0.target));if(eF._drag_drop.ignore_next_click){return eF._drag_drop.ignore_next_click=false}else{return eF.photo_click(e0,T)}},_thumb_double_click:function(e2){var e1,e0,T;e0=this.get_timeline().get_photo_for_thumb_elm($(e2.target));T=this.get_timeline().index_of_photo(e0);this._preview(T);e1=this.get_thumb_click_event_data(e0,T);return h.log_interaction(d8.OPEN_LIGHTBOX,cY.DBL_CLICK,e1)},_thumb_context_menu:function(e4){var e1,e5,e3,e0,e2,T;e1=this.get_timeline().get_photo_for_thumb_elm($(e4.target));if(e4.shiftKey){eF.photo_click(e4,e1);return}if(eF.contains(e1)){e5=eF.get()}else{e5=[e1]}bg.show_photos(e4,e5);T=[];for(e3=0,e0=e5.length;e3<e0;e3++){e1=e5[e3];T.push((e2=this.get_timeline().get_thumb_elm_for_photo(e1))!=null?e2.addClassName("context-selected"):void 0)}return T},_context_menu_hide:function(T){$$(".cu-thumb.context-selected").invoke("removeClassName","context-selected");return $$(".photo-collection.context-selected").invoke("removeClassName","context-selected")},_share_selected:function(e0){var T;T=eF.get();if(!T.length){return}ek.show(T,false);return h.log_interaction(d8.SHARE,cY.SAH,{num_photos:T.length})},_clear_selected:function(e0){var T;T=eF.get().length;eF.clear();return h.log_interaction(d8.CLEAR_SELECTED,cY.SAH,{num_photos:T})},_share_collection:function(e0){var T;cz(this.in_single_collection_view(),"_share_collection can only happen in single collection view");T=this.get_current_collection();if(T.num_items===0){ab.error(el("This album is empty. Add some photos before you share it!"));return}ek.show(this.get_current_collection(),true);return h.log_interaction(d8.SHARE_ALBUM,cY.SCA)},toggle_mem_lane_settings:function(T){var e1,e0;if(T){Event.extend(T).preventDefault()}if(!bv("#memory-lane-settings-menu").visible()){e0=bv("#memory-lane-settings-menu");eD.show($("memory-lane-settings-menu"),$("memory-lane-settings-button"));e1=function(e2){return e2.stopPropagation()};e0.off("mousedown");e0.off("click");e0.on("mousedown",e1);return e0.on("click",e1)}},show_delete_photos_modal:function(e7){var e8,e4,e1,e5,T,e0,e2,e6,e3;if(e7.length===1){e0=e7[0];if(e0.duplicates_info!=null){this._show_duplicates_modal(e0,true);return}}else{e8=[];for(e2=0,e6=e7.length;e2<e6;e2++){e0=e7[e2];if(e0.duplicates_info!=null){e4=e0.duplicates_info.slice(0);e4.push(e0);e4.sort(function(fa,e9){return e9.mtime-fa.mtime});e8=e8.concat(e4)}}if(e8.length){this._show_delete_multiple_duplicates_modal(e7,e8);return}}e3=cV.categorize_files(e7),e5=e3[0],T=e3[1];if(e5&&T){e1=a4("Delete %(file_count)s item?","Delete %(file_count)s items?",e7.length)}else{if(e5){e1=a4("Delete %(file_count)s photo?","Delete %(file_count)s photos?",e7.length)}else{e1=a4("Delete %(file_count)s video?","Delete %(file_count)s videos?",e7.length)}}return dy.show({title_text:e1.format({file_count:e7.length}),body_html:el("Are you sure you want to delete <strong>%(items)s</strong> from your Dropbox?").format({items:cV.file_desc(e7)}),confirm_text:el("Delete"),cancel_text:el("Cancel"),confirm_callback:(function(e9){return function(){return e9._delete_photos(e7)}})(this)})},_delete_photos:function(fe){var fa,e8,e2,fb,T,e0,fd,e7,e5,e4,fc,e1,e6,e3,e9;fe=fe.slice(0);fd=[];for(e5=0,fc=fe.length;e5<fc;e5++){e0=fe[e5];fd.push(e0.fq_path);if(e0.duplicates_info!=null){e6=e0.duplicates_info;for(e4=0,e1=e6.length;e4<e1;e4++){e2=e6[e4];fd.push(e2.fq_path)}}}e3=cV.categorize_files(fe),fb=e3[0],T=e3[1];if(fb&&T){e8=a4("Deleting file","Deleting files",fd.length);fa=a4("Deleted file.","Deleted files.",fd.length)}else{if(fb){e8=a4("Deleting photo","Deleting photos",fd.length);fa=a4("Deleted photo.","Deleted photos.",fd.length)}else{e8=a4("Deleting video","Deleting videos",fd.length);fa=a4("Deleted video.","Deleted videos.",fd.length)}}e9=function(ff){return new Ajax.DBRequest("/cmd/rollback",{parameters:{ns_to_cs:JSON.stringify(ff)},html_in_error_msg:true,progress_text:el("Undoing..."),onSuccess:function(fg){var fh;fh=el("Undo complete");ab.success(fh);return bG._all_photos_timeline.restore_removed_photos()},subject_user:cB.get_viewer().photos_user})};e7=(function(ff){return function(fg){return new Ajax.DBRequest("/cmd/delete",{parameters:{files:fd},job:fd.length>bG.NUM_PHOTOS_LONG_RUNNING_DELETES,job_user:cB.get_viewer().photos_user,progress_text:e8,onSuccess:function(fj){var fh,fk,fi;fk=fj.responseText.evalJSON();fi=bG.undo_enabled&&(bG._all_photos_timeline!=null);fh=fi?fk.changesets:null;U.notifyWithUndo(e8,fh,e9);bG.get_timeline().remove_photos(fe);if(fg.length>0){return cw.refresh_album_views(fg)}},subject_user:cB.get_viewer().photos_user})}})(this);return new Ajax.DBRequest("/collections_from_paths",{parameters:{fq_paths:JSON.stringify(fd)},onSuccess:(function(ff){return function(fi){var fh,fg,fj,fk;fg=JSON.parse(fi.responseText);fj=[];for(fk in fg){fh=fg[fk];fj=fj.concat(fh)}return e7(fj)}})(this)})},_preview:function(T){return aE.show(T)},_lightbox_delete:function(T){var e0;e0=T.memo.photo;h.log_interaction(d8.DELETE,cY.LIGHTBOX);return this.show_delete_photos_modal([e0])},_lightbox_remove:function(e0){var T;T=e0.memo.photo;this.get_current_collection().remove_photos([T]);return h.log_interaction(d8.REMOVE,cY.LIGHTBOX)},_show_duplicates_modal:function(e0,ff){var e7,fe,e5,e9,e8,e2,fb,e1,e6,fa,T,fd,e3,fc,e4;e8=e0.duplicates_info.slice(0);e8.push(e0);e8.sort(function(fh,fg){return fg.mtime-fh.mtime});e9=$("cu-duplicate-files");e2=[];for(e3=0,fc=e8.length;e3<fc;e3++){e5=e8[e3];fe="Dropbox"+av.normalize(av.parent_dir(e5.fq_path));e2.push(this._cu_duplicate_tmpl({thumbnail_url:e5.thumbnail_url,filename_snippet:bK.em_snippet(e5.filename,this.DUPLICATES_SNIPPET_LENGTH),path_snippet:bK.em_snippet(fe,this.DUPLICATES_SNIPPET_LENGTH,0),path_href:this._get_browse_link(e5)}))}e9.__date(e2);if(e8.length>=5){e9.addClassName("scroll")}else{e9.removeClassName("scroll")}e4=cV.categorize_files([e0]),fa=e4[0],T=e4[1];if(fa){e1=el("There are multiple copies of this photo.");e6=el("Delete all copies of this photo?")}else{e1=el("There are multiple copies of this video.");e6=el("Delete all copies of this video?")}if(ff){fb="delete_32";fd=e6;e7=e1+" "+el("Would you like to delete them all?");$("cu-delete-all-duplicates").show()}else{fb="folder_32";fd=el("Show in folder");e7=e1+" "+el("Which folder would you like to view?");$("cu-delete-all-duplicates").hide()}de.fillVal(e7,"cu-duplicates-desc");return eS.show(fd,$("cu-duplicates-modal"),{action:this._delete_photos.curry([e0])})},_show_delete_multiple_duplicates_modal:function(fc,e7){var fb,e5,e8,e1,e0,e6,e4,e9,T,e2,fa,e3;e8=$("cu-multiple-duplicate-files");e1=[];for(e2=0,fa=e7.length;e2<fa;e2++){e5=e7[e2];fb="Dropbox"+av.normalize(av.parent_dir(e5.fq_path));e1.push(this._cu_duplicate_tmpl({thumbnail_url:e5.thumbnail_url,filename_snippet:bK.em_snippet(e5.filename,this.DUPLICATES_SNIPPET_LENGTH),path_snippet:bK.em_snippet(fb,this.DUPLICATES_SNIPPET_LENGTH,0),path_href:this._get_browse_link(e5)}))}e8.__date(e1);if(e7.length>=5){e8.addClassName("scroll")}else{e8.removeClassName("scroll")}e3=cV.categorize_files(fc),e9=e3[0],T=e3[1];if(e9&&T){e0=el("Delete %(num_files)s files and all copies?").format({num_files:fc.length});e6=el("There are multiple copies of these files in your Dropbox.");e4=el("Show files with multiple copies")}else{if(e9){e0=el("Delete %(num_photos)s photos and all copies?").format({num_photos:fc.length});e6=el("There are multiple copies of these photos in your Dropbox.");e4=el("Show photos with multiple copies")}else{e0=el("Delete %(num_videos)s videos and all copies?").format({num_videos:fc.length});e6=el("There are multiple copies of these videos in your Dropbox.");e4=el("Show videos with multiple copies")}}de.fillVal(e6,"cu-multiple-duplicates-desc");de.fillVal(e4,"cu-multiple-duplicates-show");$("cu-multiple-duplicates-modal").removeClassName("show-duplicates");return eS.show(e0,$("cu-multiple-duplicates-modal"),{action:this._delete_photos.curry(fc)})},show_timestamps_modal:function(e4){var e0,e1,e2,T,e3;e4.sort_by_key((function(e5){return e5.time_taken}),true);T=(function(){var e7,e6,e5;e5=[];for(e7=0,e6=e4.length;e7<e6;e7++){e2=e4[e7];e5.push(e2.time_taken)}return e5})();e0=(function(){var e7,e6,e5;e5=[];for(e7=0,e6=e4.length;e7<e6;e7++){e2=e4[e7];e5.push(e2.item_counter)}return e5})();e1=(function(){var e7,e6,e5;e5=[];for(e7=0,e6=T.length;e7<e6;e7++){e3=T[e7];if(e3==null){e5.push(e3)}}return e5})();if(e1.length===T.length){return this._show_add_timestamps_modal(e4,T,e0)}else{if(e1.length===0){return this._show_edit_timestamps_modal(e4,T,e0)}else{return cz(false,"Timestamp modal should only open when all selected photos either have or don't have timestamp information.")}}},_scroll_to_photo_after_timestamp_edit:function(T,e0){return this._refresh_photo_events((function(e1){return function(){var e2,e3;e3=("m_"+(e0.getFullYear()))+(""+(e0.getMonth()+1)).lpad(2);e2=e1.get_timeline().events.valueFromKey(e3);cz(e2!=null,"Event is missing after a timestamp edit!");em.update("2/3");e2.on_load_all_metadata=function(){e1.get_timeline().scroll_to_photo_with_key(T.uniqueness_key);em.hide();return ab.success("New timestamps have been saved!")};if(e2.has_loaded_metadata()){e2.on_load_all_metadata();return e2.on_load_all_metadata=null}else{return e2.load_metadata()}}})(this))},_show_add_timestamps_modal:function(e3,e0,T){var e2,e1;e1=bv("#add-timestamp-modal");e2=new F("date_picker",{disable_future:true});return eS.show("Set Timestamps",e1[0],{action:(function(e4){return function(){var e8,fc,fa,fb,e6,e7,e9,e5;fa=dQ.to_iso8601_date(e2.selected_date,false,true);fb=(function(){var ff,fe,fd;fd=[];for(e7=ff=0,fe=e3.length;0<=fe?ff<fe:ff>fe;e7=0<=fe?++ff:--ff){fd.push(fa)}return fd})();e6={};for(e8=e9=0,e5=T.length;e9<e5;e8=++e9){fc=T[e8];e6[fc]=fb[e8]}em.show("Making the changes");return new Ajax.DBRequest("/modify_photo_timestamp",{parameters:{timestamp_by_item_counter:JSON.stringify(e6)},onSuccess:function(fd){em.update("1/3");return e4._scroll_to_photo_after_timestamp_edit(e3[0],e2.selected_date)}})}})(this)})},_show_edit_timestamps_modal:function(e7,e6,e2){var T,e5,e1,e3,e4,e0;e5=bv("#edit-timestamp-modal");T=(function(){var fa,e9,e8;e8=[];for(fa=0,e9=e6.length;fa<e9;fa++){e3=e6[fa];e8.push(K.toUTCDate(new Date(e3)))}return e8})();e1={year:0,month:0,day:0,hour:0};e4=function(e8){return el("%(date)s at %(time)s").format({date:K.localize(e8),time:K.format(e8,Constants.time_format)})};e0=function(e8,fc,fd,fb){var fa,e9;if(e8==null){e8=0}if(fc==null){fc=0}if(fd==null){fd=0}if(fb==null){fb=0}e1.year+=e8;e1.month+=fc;e1.day+=fd;e1.hour+=fb;e9=bU.increment_date(new Date(T[0]),e1.year,e1.month,e1.day,e1.hour,0);fa=bU.increment_date(new Date(T[T.length-1]),e1.year,e1.month,e1.day,e1.hour,0);if(e7.length===1){return e5.find("#timestamp-new").text(e4(e9))}else{e5.find("#timestamp-new-start").text(e4(e9));return e5.find("#timestamp-new-end").text(e4(fa))}};if(e7.length===1){e5.find("#edit-timestamp-single").show();e5.find("#edit-timestamp-multi").hide();e5.find("#timestamp-current").text(e4(T[0]))}else{e5.find("#edit-timestamp-single").hide();e5.find("#edit-timestamp-multi").show();e5.find("#timestamp-current-start").text(e4(T[0]));e5.find("#timestamp-current-end").text(e4(T[T.length-1]))}e0();bv("#timestamp-year-plus").on("click",e0.curry(1,0,0,0));bv("#timestamp-year-minus").on("click",e0.curry(-1,0,0,0));bv("#timestamp-month-plus").on("click",e0.curry(0,1,0,0));bv("#timestamp-month-minus").on("click",e0.curry(0,-1,0,0));bv("#timestamp-day-plus").on("click",e0.curry(0,0,1,0));bv("#timestamp-day-minus").on("click",e0.curry(0,0,-1,0));bv("#timestamp-hour-plus").on("click",e0.curry(0,0,0,1));bv("#timestamp-hour-minus").on("click",e0.curry(0,0,0,-1));eS.onHide=function(){var e8,fb,e9,fa;fa=["year","month","day","hour"];for(fb=0,e9=fa.length;fb<e9;fb++){e8=fa[fb];bv("#timestamp-"+e8+"-plus").off("click");bv("#timestamp-"+e8+"-minus").off("click")}eS.onHide=null;return eS.hide()};return eS.show("Edit Timestamps",e5[0],{action:(function(e8){return function(){var fi,ff,e9,fa,fg,fk,fh,fd,fj,fe,fc,fb;if((((e1.year===(fb=e1.month)&&fb===(fc=e1.day))&&fc===(fe=e1.hour))&&fe===0)){return}h.log_interaction(d8.EDIT_TIMESTAMP,cY.PCM,{num_photos:e7.length});fa=(function(){var fn,fm,fl;fl=[];for(fn=0,fm=T.length;fn<fm;fn++){fi=T[fn];fl.push(bU.increment_date(fi,e1.year,e1.month,e1.day,e1.hour,0))}return fl})();fg=(function(){var fn,fm,fl;fl=[];for(fn=0,fm=fa.length;fn<fm;fn++){fk=fa[fn];fl.push(dQ.to_iso8601_date(fk,false,true))}return fl})();fh={};for(ff=fd=0,fj=e2.length;fd<fj;ff=++fd){e9=e2[ff];fh[e9]=fg[ff]}em.show("Making the changes");return new Ajax.DBRequest("/modify_photo_timestamp",{parameters:{timestamp_by_item_counter:JSON.stringify(fh)},job:e7.length>e8.NUM_PHOTOS_LONG_RUNNING_EDIT_TIMESTAMP,job_user:cB.get_viewer().photos_user,onSuccess:function(fl){em.update("1/3");return e8._scroll_to_photo_after_timestamp_edit(e7[0],fa[0])}})}})(this)})},_preload_file_previews:function(e2){var e8,e6,e1,T,fd,fc,e9,e7,fa,e5,e4,fb,e0,e3;fa=this.get_timeline().get_photos();if(e2[0]<=e2[e2.length-1]){e7=null;for(e5=0,fb=e2.length;e5<fb;e5++){e6=e2[e5];T=fa[e6];if(T.status!==H.PLACEHOLDER){continue}fd=T.event;if(e7==null){e7=fd;e9=T}if(fd===e7){continue}if(e7.is_missing_timestamp_bucket()&&!this.get_timeline().is_missing_timestamp_bucket_shown()){this.get_timeline()._show_missing_timestamp_bucket(false,true)}e7.load_metadata();e7=fd;e9=T}if((e7!=null)&&!e7.has_loaded_metadata()){e8=e7.photos.indexOf(e9);e1=e7.photos.indexOf(T);if(e7.is_missing_timestamp_bucket()&&!this.get_timeline().is_missing_timestamp_bucket_shown()){this.get_timeline()._show_missing_timestamp_bucket(false,true)}return e7.load_metadata_range(e8,e1)}}else{e3=[];for(e4=0,e0=e2.length;e4<e0;e4++){e6=e2[e4];T=fa[e6];if(T.status!==H.PLACEHOLDER){continue}fd=T.event;fc=fd.photos.indexOf(T);e3.push(fd.load_metadata(fc))}return e3}},_lightbox_photo_change:function(e7){var T,e9,e4,e8,e5,e3,e6,e2,e1,e0;this._last_lightbox_photo=e7.memo.preview_obj.photo;T=e7.memo.index;e4=aE.num_previews();if(T===0||T===e4-1){return}if(e7.memo.direction===aE.NEXT||(e7.memo.direction==null)){e9=Math.min(T+this.LIGHTBOX_OFFSET*this.get_timeline().THUMBS_PER_ROW,e4-1);return this._preload_file_previews((function(){e1=[];for(var fa=e6=T+1;e6<=e9?fa<=e9:fa>=e9;e6<=e9?fa++:fa--){e1.push(fa)}return e1}).apply(this))}else{if(e7.memo.direction===aE.PREV){e8=Math.max(T-this.LIGHTBOX_OFFSET*this.get_timeline().THUMBS_PER_ROW,0);return this._preload_file_previews((function(){e0=[];for(var fa=e2=T-1;e2<=e8?fa<=e8:fa>=e8;e2<=e8?fa++:fa--){e0.push(fa)}return e0}).apply(this))}}},_lightbox_exit:function(T){return key.setScope(this.KEY_SCOPE)},_window_resize:function(){var e1,e0,e2,T;e0=$("cu-view").cumulativeOffset().top+$("photos-list").getLayout().get("margin-top")+$("photos-list").getLayout().get("padding-top");if(bv("#carousel-promo-banner").outerHeight()){e0+=bv("#carousel-promo-banner").outerHeight()-$("cu-view").cumulativeOffset().top}e1=$("cu-view").cumulativeOffset().left+$("photos-list").getLayout().get("margin-left")+$("photos-list").getLayout().get("padding-left");if((e2=this._all_photos_timeline)!=null){e2.update_offsets(e0,e1)}return(T=this._single_collection_timeline)!=null?T.update_offsets(e0,e1):void 0},_history_change_handler:function(fc,fb){var e7,e8,e9,e4,e2,e5,fa,e6,e3,e1,e0,T;if(this._init_finished){if(eS.shown()){eS.hide()}}$("photos-nav-item").removeClassName("selected");$$(".sidebar-album.selected").invoke("removeClassName","selected");if((e6=this.get_timeline())!=null){e6.unlisten()}if(fc==="all_albums"){cw.load_collections(null);this._in_all_collections_view=true;$("cu-view").removeClassName("single-collection");$("cu-view").addClassName("all-collections");if((e3=$("all-albums-sidebar"))!=null){e3.addClassName("selected")}eF.clear();document.title=el("Albums")+" - Dropbox";cw.restore_all_albums_scroll_position();this._current_collection_gid=null;return}else{this._in_all_collections_view=false;$("cu-view").removeClassName("all-collections")}if(fc.startsWith("album/")){e7=cw.get_from_url("/photos/"+fc);e1=$$(".sidebar-album");for(e5=0,fa=e1.length;e5<fa;e5++){e9=e1[e5];if(e9.readAttribute("data-gid")===e7.gid){e9.addClassName("selected");break}}$("single-collection-title").__date(bK.em_snippet(e7.name,cw.HEADER_COLLECTION_SNIPPET_LENGTH,1));if(e7.shmodel_url!=null){$("single-collection-share-status").writeAttribute("href",e7.shmodel_url);if(((e0=e7.member_fnames)!=null?e0.length:void 0)>1){e8=el("%(photo_video_desc)s from %(album_members)s",{comment:'for example: "3 photos and 1 video from Peter, Boris, and Ryan"'}).format({photo_video_desc:cV.album_desc(e7),album_members:dQ.nice_list(e7.member_fnames)});$("single-collection-share-status").__date(e8)}else{$("single-collection-share-status").__date(el("Shared"))}}else{$("single-collection-share-status").__date()}$("cu-view").addClassName("single-collection");if(!e7.is_creator){$("cu-view").addClassName("not-collection-creator")}document.title=""+e7.name+" - Dropbox";co.log_event("show_collection",e7.gid,e7.num_photos,e7.is_anonymous)}else{e7=null;$("cu-view").removeClassName("single-collection");$("photos-nav-item").addClassName("selected");document.title=el("Photos")+" - Dropbox"}e4=false;if(e7!=null){if(e7.gid!==this._current_collection_gid){e4=true}}else{if(this._all_photos_timeline==null){e4=true}}this._current_collection_gid=e7!=null?e7.gid:null;if(e4){this._refresh_view()}else{this._init_lightbox();this.get_timeline().init_timeline_nav();this.get_timeline().restore_scroll_position();this.get_timeline().listen()}if((this._last_lightbox_photo!=null)&&this.get_timeline().num_photos()){e2=this._last_lightbox_photo.uniqueness_key;this.get_timeline().scroll_to_photo_with_key(e2);if((T=$(e2))!=null){T.addClassName("wiggobble")}setTimeout((function(){return $(e2).removeClassName("wiggobble")}),1000);return this._last_lightbox_photo=null}}};var aG;aG=INLINE_JS.PhotosTour=B.PhotosTour={_frame:0,next:function(){var T;eS.show("",bv("#photos-tour-"+(this._frame+1))[0],null,null,700,null,null,false);T=this._frame;h.log_interaction(a1.SHOW_MODAL,"",{frame:T});bv("#modal-x").off("click");bv("#modal-x").on("click",((function(e0){return function(){return h.log_interaction(a1.EXIT_MODAL,"",{frame:T})}})(this)));return this._frame=(this._frame+1)%4},hide:function(T){h.log_interaction(T,"");return eS.hide()}};var cV;cV=B.PhotosUtil={categorize_files:function(e0){var e1,T;e1=e0.filter(function(e2){return e2.preview_type==="photo"});T=e0.filter(function(e2){return e2.preview_type==="video"});return[e1.length,T.length]},file_desc:function(e4,e1,T){var e0,e3,e2;if(e1==null){e1=false}if(T==null){T=false}e2=this.categorize_files(e4),e0=e2[0],e3=e2[1];return this._photo_video_desc(e0,e3,e1,T)},album_desc:function(e1,e0,T){if(e0==null){e0=false}if(T==null){T=false}return this._photo_video_desc(e1.num_photos,e1.num_videos,e0,T)},_photo_video_desc:function(e0,e5,e1,T){var e2,e4,e3;e4=a4("%d photo","%d photos",e0,{comment:"This will be used in a phrase such as 'x photos and y videos'"}).format(e0);e3=a4("%d video","%d videos",e5,{comment:"This will be used in a phrase such as 'x photos and y videos'"}).format(e5);if(e0&&e5){if(e1){e2=e0+e5;return a4("%d item","%d items",e2).format(e2)}else{if(T){return new eV(""+e4+"<br/>"+e3)}else{return el("%(num_photos)s and %(num_videos)s",{comment:"num_photos and num_videos may be like either '1 photo' or '%d photos'"}).format({num_photos:e4,num_videos:e3})}}}else{if(e0){return e4}else{if(e5){return e3}else{return""}}}}};var eF,bB=[].indexOf||function(e1){for(var e0=0,T=this.length;e0<T;e0++){if(e0 in this&&this[e0]===e1){return e0}}return -1};eF=INLINE_JS.PhotosSelection=B.PhotosSelection={CHANGE_EVT:"db:photos_selection:change",SHIFT_KEY_CODE:16,DRAG_STATUS_OFFSET:16,DRAG_START_THRESHOLD:10,SCROLL_BAR_WIDTH:10,_selected:[],_context_selected:null,_highlighted:[],_dehighlighted:[],_last_selected:null,_last_mouseover:null,_drag_select:{},_marquee:{},_drag_drop:{},_events_highlighting:[],_last_highlight_from_photo:null,_last_highlight_to_photo:null,_select_highlighted_waiting:0,_show_share_after_loading_selected:false,_num_pending_events_with_selections:0,_max_num_pending_events_with_selections:0,listen:function(){$(document.body).on("keydown",(function(T){return function(e0){if(e0.keyCode===T.SHIFT_KEY_CODE&&T._last_mouseover&&!z.focus_in_input()){return T._highlight_range(T._last_selected,T._last_mouseover)}}})(this));$(document.body).on("keyup",(function(T){return function(e0){if(e0.keyCode===T.SHIFT_KEY_CODE&&!T._marquee.active){return T.clear_highlighted()}}})(this));key("delete, command+backspace, backspace",bG.KEY_SCOPE,(function(T){return function(e0){e0.preventDefault();if(bG.in_single_collection_view()){if(T._selected.length){return cw.show_remove_photos_modal(bG.get_current_collection(),T._selected)}}else{if(T._selected.length){return bG.show_delete_photos_modal(T._selected)}}}})(this));key("esc",bG.KEY_SCOPE,(function(T){return function(e1){var e0;if(typeof e1.preventDefault==="function"){e1.preventDefault()}if(T._drag_drop.active){T._drag_drop.active=false;if((e0=$("albums-sidebar-list"))!=null){e0.removeClassName("drag-drop")}return $("photos-drag-status").removeClassName("active")}else{T.clear();return h.log_interaction(d8.CLEAR_SELECTED,cY.ESC)}}})(this));$(document.body).on("mouseover",".cu-thumb",this._photo_mouseover.bind(this));$(document.body).on("mouseout",".cu-thumb",this._photo_mouseout.bind(this));$(document.body).on("mousedown",this._body_mousedown.bind(this));$(document.body).on("mousemove",this._body_mousemove.bind(this));$(document).on("mouseup",this._body_mouseup.bind(this));$(document.body).on("dblclick",this._body_double_click.bind(this));return y.init(null,bv("#cu-header").height())},is_selection_active:function(){return this._highlighted.length||this._selected.length||this._marquee.active||this._drag_drop.active||this._drag_select.active},get:function(){return this._selected},contains:function(e0){var T,e2,e1;e2=(function(){var e6,e4,e5,e3;e5=this._selected;e3=[];for(e6=0,e4=e5.length;e6<e4;e6++){T=e5[e6];e3.push(T.uniqueness_key)}return e3}).call(this);return e1=e0.uniqueness_key,bB.call(e2,e1)>=0},clear:function(){this._selected=[];this._last_selected=null;$$(".cu-thumb.selected").invoke("removeClassName","selected");$("cu-view").removeClassName("photos-selected");$("page-sidebar").removeClassName("photos-selected");eD.hide_all();return document.fire(eF.CHANGE_EVT)},clear_highlighted:function(){this._highlighted=[];this._dehighlighted=[];if(!this._select_highlighted_waiting){$$(".cu-thumb.highlighted").invoke("removeClassName","highlighted");$$(".cu-thumb.dehighlighted").invoke("removeClassName","dehighlighted");this._last_highlight_from_photo=null;return this._last_highlight_to_photo=null}},photo_click:function(e0,T){if(e0.isRightClick()&&!e0.shiftKey){return}if(e0.shiftKey){return this._select_highlighted()}else{if(this.contains(T)){return this._remove(T)}else{return this._add(T)}}},num_selected:function(){return this._selected.length},refresh:function(e2){var e4,e5,e1,e6,e3,e0,T;e6=(function(){var fa,e8,e9,e7;e9=this._selected;e7=[];for(fa=0,e8=e9.length;fa<e8;fa++){e1=e9[fa];e7.push(e1.uniqueness_key)}return e7}).call(this);T=[];for(e3=0,e0=e2.length;e3<e0;e3++){e5=e2[e3];e4=e6.indexOf(e5.uniqueness_key);if(e4>=0){T.push(this._selected[e4]=e5)}else{T.push(void 0)}}return T},inc_num_loading_events_before_select:function(T){if(!this._show_share_after_loading_selected){em.show(el("Loading photos..."))}this._show_share_after_loading_selected=T;this._num_pending_events_with_selections++;if(this._num_pending_events_with_selections>this._max_num_pending_events_with_selections){return this._max_num_pending_events_with_selections=this._num_pending_events_with_selections}},dec_num_loading_events_before_select:function(){this._num_pending_events_with_selections--;em.update(""+(this._max_num_pending_events_with_selections-this._num_pending_events_with_selections)+"/"+this._max_num_pending_events_with_selections);if(this._num_pending_events_with_selections===0){em.hide();if(this._show_share_after_loading_selected){this._show_share_after_loading_selected=false;if(this.num_selected()>0){return bG._share_selected()}}}},_photo_mouseover:function(T){this._last_mouseover=bG.get_timeline().get_photo_for_thumb_elm($(T.target));if(T.shiftKey){return this._highlight_range(this._last_selected,this._last_mouseover)}else{if(this._drag_select.active){return this._highlight_range(this._drag_select.anchor,this._last_mouseover,true)}}},_photo_mouseout:function(T){if(!this._marquee.active){this.clear_highlighted();return this._last_mouseover=null}},_body_mousedown:function(e2){var T,e0,e1;if(bG.in_all_collections_view()||e2.isRightClick()||this._invalid_mouse_target($(e2.target))){return}bg.hide();eD.hide_all();T=(e1=bG.get_timeline())!=null?e1.get_photo_for_thumb_elm($(e2.target)):void 0;if(T!=null){if(this.contains(T)||!eF.drag_select_enabled){e0=z.scroll_offsets();this._drag_drop.active=true;this._drag_drop.start_x=e2.clientX+e0.left;this._drag_drop.start_y=e2.clientY+e0.top;this._drag_drop.anchor=$(e2.target);this._drag_drop.single_photo=this.contains(T)?null:T;this._build_drag_status(T);this._update_drag_status_position(e2)}else{this._drag_select.active=true;this._drag_select.anchor=T}}else{e0=z.scroll_offsets();if((e2.clientX+e0.left)>=($(document.body).getWidth()-this.SCROLL_BAR_WIDTH)){return}this._marquee.active=true;this._marquee.start_x=e2.clientX+e0.left;this._marquee.start_y=e2.clientY+e0.top;this._marquee.x_max_boundary=-1;this._marquee.y_max_boundary=-1}return y.start()},_body_mousemove:function(e2){var e0,T,e3,e1;e0=z.scroll_offsets();T=e2.clientX+e0.left;e3=e2.clientY+e0.top;if(this._marquee.active){if(!$("marquee").visible()){if(Math.abs(T-this._marquee.start_x)<this.DRAG_START_THRESHOLD&&Math.abs(e3-this._marquee.start_y)<this.DRAG_START_THRESHOLD){return}}this._marquee.end_x=T;this._marquee.end_y=e3;return this._draw_marquee()}else{if(this._drag_drop.active){if(!$("photos-drag-status").hasClassName("active")){if(Math.abs(T-this._drag_drop.start_x)<this.DRAG_START_THRESHOLD&&Math.abs(e3-this._drag_drop.start_y)<this.DRAG_START_THRESHOLD){return}}this._update_drag_status_position(e2);$$(".sidebar-album").invoke("removeClassName","album-flash");if((e1=$("albums-sidebar-list"))!=null){e1.addClassName("drag-drop")}return $("photos-drag-status").addClassName("active")}}},_body_mouseup:function(e1){var e0,T;if(this._drag_select.active){this._drag_select.active=false;this._select_highlighted()}if(this._marquee.active){this._marquee.active=false;$("marquee").hide();e0=this._highlighted.length;this._select_highlighted();if(e0){h.log_interaction(d8.MARQUEE_SELECT,cY.DRAG,{num_selected:e0})}}if(this._drag_drop.active){if($(e1.target)===this._drag_drop.anchor&&$("photos-drag-status").hasClassName("active")){this._drag_drop.ignore_next_click=true}this._drag_drop.active=false;this._drag_drop.anchor=null;this._drag_drop.single_photo=null;if((T=$("albums-sidebar-list"))!=null){T.removeClassName("drag-drop")}$("photos-drag-status").removeClassName("active")}return y.end()},_body_double_click:function(T){if(bG.get_timeline().get_photo_for_thumb_elm($(T.target))||this._invalid_mouse_target($(T.target))){return}this.clear();return h.log_interaction(d8.CLEAR_SELECTED,cY.DBL_CLICK)},_draw_marquee:function(){var T,e3,e2,e1,e0;e0=Math.abs(this._marquee.start_x-this._marquee.end_x);T=Math.abs(this._marquee.start_y-this._marquee.end_y);e2=Math.min(this._marquee.start_y,this._marquee.end_y);e3=Math.min(this._marquee.start_x,this._marquee.end_x);$("marquee").setStyle({width:e0+"px",height:T+"px",top:e2+"px",left:e3+"px"});$("marquee").show();e1=false;if(bG.get_timeline()!=null){if(this._marquee.end_x>=this._marquee.x_max_boundary||this._marquee.end_x<=this._marquee.x_min_boundary){this._update_marquee_x_bounds(this._marquee.end_x);e1=true}if(this._marquee.end_y>=this._marquee.y_max_boundary||this._marquee.end_y<=this._marquee.y_min_boundary){this._update_marquee_y_bounds(this._marquee.end_y);e1=true}if(e1){return this._update_marquee_highlight(e2,e3,e0,T)}}},_update_marquee_highlight:function(fa,e1,T,fc){var e8,e9,e6,e0,e5,e4,fb,e7,e3,e2;this.clear_highlighted();e0=[];e9=bG.get_timeline().grid.photo_col_offsets.length;e7=bG.get_timeline().grid.photo_col_offsets.slice(0,e9-1);for(e8=e5=0,fb=e7.length;e5<fb;e8=++e5){e6=e7[e8];if(e6<=e1+T&&bG.get_timeline().grid.photo_col_offsets[e8+1]>=e1){e0.push(e8)}}e2=[];for(e8=e4=0,e3=bG.get_timeline().events.length();0<=e3?e4<e3:e4>e3;e8=0<=e3?++e4:--e4){e2.push(bG.get_timeline().events.valueAtIndex(e8).marquee_highlight(fa,fa+fc,e0))}return e2},_update_marquee_x_bounds:function(T){var e2,e5,e6,e4,e1,e3,e0;e5=$(document.body).getWidth();if(T<bG.get_timeline().grid.photo_col_offsets.first()){this._marquee.x_min_boundary=-1;return this._marquee.x_max_boundary=bG.get_timeline().grid.photo_col_offsets.first()}else{if(T>bG.get_timeline().grid.photo_col_offsets.last()){this._marquee.x_min_boundary=bG.get_timeline().grid.photo_col_offsets.last();return this._marquee.x_max_boundary=e5}else{e3=bG.get_timeline().grid.photo_col_offsets;e0=[];for(e2=e4=0,e1=e3.length;e4<e1;e2=++e4){e6=e3[e2];if(e6>T){this._marquee.x_min_boundary=bG.get_timeline().grid.photo_col_offsets[e2-1];this._marquee.x_max_boundary=e6;break}else{e0.push(void 0)}}return e0}}},_update_marquee_y_bounds:function(e6){var T,e3,e2,e5,e1,e4,e0;e2=$(document.body).getHeight();if(e6<bG.get_timeline().grid.photo_row_offsets.first()){this._marquee.y_min_boundary=-1;return this._marquee.y_max_boundary=bG.get_timeline().grid.photo_row_offsets.first()}else{if(e6>bG.get_timeline().grid.photo_row_offsets.last()){this._marquee.y_min_boundary=bG.get_timeline().grid.photo_row_offsets.last();return this._marquee.y_max_boundary=e2}else{e4=bG.get_timeline().grid.photo_row_offsets;e0=[];for(e3=e5=0,e1=e4.length;e5<e1;e3=++e5){T=e4[e3];if(T>e6){this._marquee.y_min_boundary=bG.get_timeline().grid.photo_row_offsets[e3-1];this._marquee.y_max_boundary=T;break}else{e0.push(void 0)}}return e0}}},_build_drag_status:function(e2){var e1,T,e0;T=bG.get_timeline().get_thumb_elm_for_photo(e2);e0=T.down("img.thumb-content").cloneNode(false);$("photos-drag-status").down(".thumb").__date(e0);e1=this._drag_drop.single_photo?[this._drag_drop.single_photo]:this._selected;return $("photos-drag-status").down(".count").__date(cV.file_desc(e1,false,true))},_update_drag_status_position:function(T){return $("photos-drag-status").setStyle({left:(T.pointerX()-z.scroll_offsets().left+this.DRAG_STATUS_OFFSET)+"px",top:(T.pointerY()-z.scroll_offsets().top+this.DRAG_STATUS_OFFSET)+"px"})},_highlight_range:function(fb,fa,e1){var e9,T,e2,e6,e8,e7,e0,e4,e5,e3;if(e1==null){e1=false}this.clear_highlighted();this._events_highlighting=[];this._last_highlight_from_photo=fb;this._last_highlight_to_photo=fa;e2=bG.get_timeline().index_of_photo(fb);e0=bG.get_timeline().index_of_photo(fa);e9=!e1&&this.contains(fa)&&!this.contains(fb);e3=[];for(e6=e4=e2;e2<=e0?e4<=e0:e4>=e0;e6=e2<=e0?++e4:--e4){e7=bG.get_timeline().photo_at_index(e6);if(e7.status===H.PLACEHOLDER){if(e7.event!==e8){T=e7.event;if(!T.has_loaded_metadata()){T.on_load_all_metadata=this._highlight_range_incremental.bind(this);T.load_metadata();if(e5=T.unique_id,bB.call(this._events_highlighting,e5)<0){this._events_highlighting.push(T.unique_id)}e3.push(e8=T)}else{e3.push(void 0)}}else{e3.push(void 0)}}else{if(this.contains(e7)){if(e9){e3.push(this._dehighlight(e7))}else{e3.push(void 0)}}else{if(!e9){e3.push(this._highlight(e7))}else{e3.push(void 0)}}}}return e3},_highlight_range_incremental:function(T){var e6,e1,e7,e3,e4,e0,e5,e2;e7=this._last_highlight_from_photo;e5=this._last_highlight_to_photo;if(!((e7!=null)&&(e5!=null))){return}e1=bG.get_timeline().index_of_photo(e7);e0=bG.get_timeline().index_of_photo(e5);for(e3=e2=e1;e1<=e0?e2<=e0:e2>=e0;e3=e1<=e0?++e2:--e2){e4=bG.get_timeline().photo_at_index(e3);if(e4.status!==H.PLACEHOLDER&&!this.contains(e4)&&this._highlighted.indexOf(e4)===-1){this._highlight(e4)}}e6=this._events_highlighting.indexOf(T.unique_id);if(e6>=0){this._events_highlighting.splice(e6,1)}if(this._select_highlighted_waiting){em.update(""+(this._select_highlighted_waiting-this._events_highlighting.length)+"/"+this._select_highlighted_waiting);if(this._events_highlighting.length===0){return this._select_highlighted()}}},_highlight_list:function(e2){var e1,e3,e0,T;this.clear_highlighted();T=[];for(e3=0,e0=e2.length;e3<e0;e3++){e1=e2[e3];if(!this.contains(e1)){T.push(this._highlight(e1))}else{T.push(void 0)}}return T},_select_highlighted:function(){var e2,e5,e3,e1,e0,e4,T;if(this._events_highlighting.length>0){em.show(el("Selecting photos..."));this._select_highlighted_waiting=this._events_highlighting.length;return}e4=this._highlighted;for(e5=0,e1=e4.length;e5<e1;e5++){e2=e4[e5];this._add(e2)}T=this._dehighlighted;for(e3=0,e0=T.length;e3<e0;e3++){e2=T[e3];this._remove(e2)}if(this._select_highlighted_waiting){em.hide();this._select_highlighted_waiting=0}return this.clear_highlighted()},_highlight:function(e0){var T;this._highlighted.push(e0);T=bG.get_timeline().get_thumb_elm_for_photo(e0);return T!=null?T.addClassName("highlighted"):void 0},_dehighlight:function(e0){var T;this._dehighlighted.push(e0);T=bG.get_timeline().get_thumb_elm_for_photo(e0);return T!=null?T.addClassName("dehighlighted"):void 0},_add:function(e0){var T;cz(e0.status!==H.PLACEHOLDER,"placeholder photos can't be added to the selection",true,["photo_selection_placeholder"]);T=bG.get_timeline().get_thumb_elm_for_photo(e0);if(T!=null){T.addClassName("selected")}this._selected.push(e0);this._last_selected=e0;de.fillVal(cV.file_desc(this._selected,true),"selected-desc");de.fillVal(this._selected.length,"num-selected");$("cu-view").addClassName("photos-selected");this._check_for_single_selection();$("page-sidebar").addClassName("photos-selected");return document.fire(eF.CHANGE_EVT)},_remove:function(e1){var e0,T;T=bG.get_timeline().get_thumb_elm_for_photo(e1);if(T!=null){T.removeClassName("selected")}e0=this._selected.indexOf(e1);if(e0!==-1){this._selected.splice(e0,1);this._last_selected=e1;if(this._selected.length){de.fillVal(cV.file_desc(this._selected,true),"selected-desc");de.fillVal(this._selected.length,"num-selected")}else{$("cu-view").removeClassName("photos-selected");$("page-sidebar").removeClassName("photos-selected")}}this._check_for_single_selection();return document.fire(eF.CHANGE_EVT)},_invalid_mouse_target:function(e2){var e0,e1,T;e0=e2.classNames().toArray().concat(e2.up().classNames().toArray());return(bB.call(e0,"freshbutton")>=0)||(bB.call(e0,"freshbutton-blue")>=0)||(bB.call(e0,"freshbutton-lightblue")>=0)||(bB.call(e0,"freshbutton-blue-on-gray")>=0)||(bB.call(e0,"timeline-elm")>=0)||(e2.up(".no-marquee")!=null)||(e2.up("#context-menu")!=null)||(e2.up(".freshdropdown-menu")!=null)||e2.nodeName==="A"||((e1=e2.tagName.toUpperCase())==="INPUT"||e1==="TEXTAREA"||e1==="SELECT")||eS.shown()||((T=$("modal-progress-content"))!=null?T.visible():void 0)||aE.shown},_check_for_single_selection:function(){if(this._selected.length===1){return $("cu-view").addClassName("single-selection")}else{return $("cu-view").removeClassName("single-selection")}}};var cw,bB=[].indexOf||function(e1){for(var e0=0,T=this.length;e0<T;e0++){if(e0 in this&&this[e0]===e1){return e0}}return -1};cw=INLINE_JS.PhotosCollections=B.PhotosCollections={SIDEBAR_COLLECTION_SNIPPET_LENGTH:10,HEADER_COLLECTION_SNIPPET_LENGTH:25,CONTEXT_MENU_COLLECTION_SNIPPET_LENGTH:11,NUM_PHOTOS_LONG_RUNNING_ADDS:100,NUM_PHOTOS_LONG_RUNNING_REMOVES:250,NUM_PHOTOS_LONG_RUNNING_COLLECTION_DELETES:50,LOADING_SPINNER:new eV('<br/><div class="cu-loading"><img src="/static/images/icons/ajax-loading-small-vfl3Wt7C_.gif" /></div>'),_collections:[],_gid_to_collection:{},_url_to_collection:{},_collection_list_item_tmpl:null,_albums_sidebar_tmpl:null,_all_collections_loaded:false,_removed_pre_load:[],_all_albums_scroll_position:0,_num_loading_collections:0,init:function(e0,T){this._collections=e0;this._gid_to_collection=e0.dict_by("gid");this._url_to_collection=e0.dict_by("url");this._collection_list_item_tmpl=eV.tmpl("collection_list_item_tmpl");this._albums_sidebar_tmpl=eV.tmpl("albums_sidebar_tmpl");this._all_collections_loaded=false;this._sidebar_collections_loaded=false;this._num_loading_collections=0;this.refresh_album_views();return this._init_collections()},_init_collections:function(){var T;T=eo.deconstruct_url();if(T.path!=="/photos/all_albums"){return this.load_collections(5)}},load_collections:function(T){if(this._num_loading_collections!==null&&(this._num_loading_collections<T||T===null)){this._num_loading_collections=T;return new Ajax.DBRequest("/collections",{parameters:{limit:T},allow_retries:true,onSuccess:(function(e0){return function(e3){var e7,e6,e2,e5,e1,e4;e2=JSON.parse(e3.responseText);for(e5=0,e1=e2.length;e5<e1;e5++){e6=e2[e5];if(!(e6.gid in e0._gid_to_collection)&&!(e4=e6.gid,bB.call(e0._removed_pre_load,e4)>=0)){e7=new Z(e6,false);e0._collections.push(e7);e0._gid_to_collection[e7.gid]=e7;e0._url_to_collection[e7.url]=e7}}if(T===null||e2.length<T){e0._all_collections_loaded=true;e0._sidebar_collections_loaded=true}if(T>=5){e0._sidebar_collections_loaded=true}return e0.refresh_album_views()}})(this)})}},reload:function(){this._collections=[];this._gid_to_collection={};this._url_to_collection={};this._all_collections_loaded=false;this.refresh_album_views();return this._init_collections()},listen:function(){$("single-collection-title").observe("click",(function(T){return function(e0){if(!bG.get_current_collection().is_creator){return}T.header_rename();return h.log_interaction(d8.RENAME_ALBUM,cY.CLICK_TITLE)}})(this));$(document.body).on("contextmenu",".albums-list-item",this._albums_list_item_contextmenu.bind(this));$(document.body).on("click",".show-collection-target",this._show_collection_click.bind(this));$(document.body).on("click",".collection-shmodel-target",this._collection_shmodel_click.bind(this));$(document.body).on("click",".add-to-album-target",this._add_to_album_click.bind(this));$(document.body).on("mouseover",".add-to-album-drop-target",this._drop_target_mouseover.bind(this));$(document.body).on("mouseup",".add-to-album-drop-target",this._drop_target_mouseup.bind(this));$(document.body).on("mouseout",".add-to-album-drop-target",this._drop_target_mouseout.bind(this));$(document.body).on("click",".create-album-target",this._create_album_click.bind(this));document.observe(bg.HIDE_EVT,(function(){return $$(".albums-list-item.context-selected").invoke("removeClassName","context-selected")}));Event.observe(window,"scroll",this._window_scroll.bind(this));document.observe(Z.CREATE_EVT,this._collection_created.bind(this));document.observe(Z.ADD_EVT,this._collection_photos_added.bind(this));document.observe(Z.REMOVE_EVT,this._collection_photos_removed.bind(this));document.observe(Z.UNDO_REMOVE_EVT,this._collection_undid_remove.bind(this));document.observe(Z.RENAME_EVT,this._collection_renamed.bind(this));document.observe(Z.DELETE_EVT,this._collection_deleted.bind(this));document.observe(Z.SHARE_EVT,this._collection_shared.bind(this));document.observe(Z.UNSHARE_EVT,this._collection_unshared.bind(this));return document.observe(Z.COVER_CHANGE_EVT,this._collection_cover_changed.bind(this))},render_all_albums_view:function(){var e3,e0,e2,T,e1;if(this._collections.length||!this._all_collections_loaded){$("albums-empty").hide()}else{$("albums-empty").show()}e0=[];e1=this._collections;for(e2=0,T=e1.length;e2<T;e2++){e3=e1[e2];e0.push(this._collection_list_item_tmpl({collection:e3,additional_class:"albums-list-item show-collection-target",Sprite:cm,Emstring:bK}))}$("albums-list").__date(e0);$("albums-list").__sert(new Element("div",{"class":"clearfix"}));if(!this._all_collections_loaded){return $("albums-list").__sert(this.LOADING_SPINNER)}},render_add_to_album_modal:function(){var e4,e0,e1,e3,T,e2;e0=[];e1={name:el("Create new album"),thumbnail_url_256:"/static/images/new_album_big-vflQJ5xd7.png"};e0.push(this._collection_list_item_tmpl({collection:e1,additional_class:"create-album-target",hide_icons:true,Sprite:cm,Emstring:bK}));e2=this._collections;for(e3=0,T=e2.length;e3<T;e3++){e4=e2[e3];e0.push(this._collection_list_item_tmpl({collection:e4,additional_class:"add-to-album-target",Sprite:cm,Emstring:bK}))}$("add-to-album-modal-list").__date(e0);if(!this._all_collections_loaded&&this._collections.length>0){return $("add-to-album-modal-list").__sert(this.LOADING_SPINNER)}},render_albums_sidebar:function(){var e5,e7,e3,e6,e4,e2,e0,T,e1;if(!this._sidebar_collections_loaded){return}if(!this._collections.length){$("albums-sidebar").hide();$("main-nav-bottom").show();return}$("main-nav-bottom").hide();$("albums-sidebar").show();e7=this._albums_sidebar_tmpl({collections:this._collections.slice(0,5),_:el,Sprite:cm,PhotosCollections:cw});if((e4=$("albums-sidebar"))!=null){e4.__date(e7)}if((e2=$("all-albums-sidebar"))!=null){e2.observe("click",bG.show_all_collections)}if((e0=$("all-albums-sidebar"))!=null){e0.observe("mouseup",(function(e8){return function(e9){var fa;if(!eF._drag_drop.active){return}if(eF._drag_drop.single_photo!=null){fa=[eF._drag_drop.single_photo]}else{fa=eF.get()}e8.show_add_to_album_modal(e9,fa);return h.log_interaction(d8.ADD_TO_OTHER_ALBUM,cY.DROP_TARGET,{num_photos:eF.get().length})}})(this))}if(bG.in_all_collections_view()){return $("all-albums-sidebar").addClassName("selected")}else{if(bG.in_single_collection_view()){T=$$(".sidebar-album");e1=[];for(e3=0,e6=T.length;e3<e6;e3++){e5=T[e3];if(e5.readAttribute("data-gid")===bG.get_current_collection().gid){e5.addClassName("selected");break}else{e1.push(void 0)}}return e1}}},refresh_album_views:function(e0){var T;if(e0==null){e0=null}T=(function(e1){return function(){e1.render_all_albums_view();e1.render_albums_sidebar();return e1.render_add_to_album_modal()}})(this);if(e0!=null?e0.length:void 0){return new Ajax.DBRequest("/collections",{allow_retries:true,parameters:{collection_gids:JSON.stringify(e0.unique())},onSuccess:(function(e1){return function(fb){var fa,e9,e3,e8,e6,e5,fc,e2,e7,e4;e7=JSON.parse(fb.responseText);for(e6=0,fc=e7.length;e6<fc;e6++){e3=e7[e6];e9=new Z(e3,false);e1._gid_to_collection[e9.gid]=e9;e1._url_to_collection[e9.url]=e9;e4=e1._collections;for(e8=e5=0,e2=e4.length;e5<e2;e8=++e5){fa=e4[e8];if(fa.gid===e9.gid){e1._collections[e8]=e9;break}}}return T()}})(this)})}else{return T()}},show_add_to_album_modal:function(T,e0){if(e0!==eF.get()&&(eF._drag_drop.single_photo==null)){eF._context_selected=e0}eS.onHide=function(){eF._context_selected=null;delete eS.onHide;return eS.hide()};eS.show(el("Choose an album"),$("add-to-album-modal"),false,false,893);return this.load_collections(null)},add_photos:function(e1,e3,e0){var T,e2;if(e0==null){e0=true}e2=null;if(bG.in_single_collection_view()){e2=bG.get_current_collection().gid}T=e3.length>this.NUM_PHOTOS_LONG_RUNNING_ADDS;ab.success(el("Adding to album..."));return e1.add_photos(e3,e2,T,e0)},show_remove_photos_modal:function(e2,e4){var e1,T,e3,e0;e0=cV.categorize_files(e4),T=e0[0],e3=e0[1];if(T&&e3){e1=a4("Remove %(file_count)s item?","Remove %(file_count)s items?",e4.length)}else{if(T){e1=a4("Remove %(file_count)s photo?","Remove %(file_count)s photos?",e4.length)}else{e1=a4("Remove %(file_count)s video?","Remove %(file_count)s videos?",e4.length)}}e1=e1.format({file_count:e4.length});de.fillVal(cV.file_desc(e4),"collection-remove-files");de.fillVal(e2.name.escapeHTML(),"collection-remove-name");return eS.show(e1,de.fromElm("collection-remove-modal"),{action:(function(e5){return function(){var e6;e4=e4.slice(0);e6=e4.length>e5.NUM_PHOTOS_LONG_RUNNING_REMOVES;return e2.remove_photos(e4,e6)}})(this)})},header_rename:function(){if(bv("#single-collection-title-container").hasClass("editing")){return}bv("#single-collection-title-container").addClass("editing");return bG.get_current_collection().rename($("single-collection-title"))},show_delete_modal:function(e0){var T;de.fillVal(e0.name.escapeHTML(),"collection-delete-name");T=el("Delete album?");return eS.show(T,de.fromElm("collection-delete-modal"),{action:function(){if(e0.num_items>this.NUM_PHOTOS_LONG_RUNNING_COLLECTION_DELETES){ab.success(el("Deleting '%(collection_name)s'...").format({collection_name:e0.name}),100)}return e0["delete"]()}})},show_unshare_modal:function(e0){var T;de.fillVal(e0.name.escapeHTML(),"collection-unshare-name");T=el("Unshare album?");return eS.show(T,de.fromElm("collection-unshare-modal"),{action:function(){return e0.unshare()}})},create:function(e7,e6,fb,e0){var e2,e3,e1,e4,e9,fa,e8,T,e5;if(e0==null){e0=false}if(e7){Event.extend(e7).preventDefault();e5=$(e7.target);if(e5.hasClassName("inplaceeditor-form")||(e5.up(".inplaceeditor-form")!=null)){return}if(e5.up("#context-menu")){e2=true}else{if(e5.up(".freshdropdown-menu")){e1=true}}}bG.enable_selection();if(!fb){fb=eF.get()}e4=(function(){var fe,fd,fc;fc=[];for(fe=0,fd=fb.length;fe<fd;fe++){T=fb[fe];fc.push(T.item_counter)}return fc})();fb.sort_by_key(function(fc){return fc.time_taken});e9=fb.length>this.NUM_PHOTOS_LONG_RUNNING_ADDS;e8=(function(fc){return function(fe){var fh,ff,fd,fg;ff=JSON.parse(fe.responseText);fh=new Z(ff);eF.clear();eD.hide_all();bg.hide();eS.hide();bG.disable_selection();fg=el("Created '%(collection_name)s'");fd=fh.name.escapeHTML();fg=fg.format({collection_name:"<a data-gid='"+fh.gid+"' class='show-collection-target'>"+fd+"</a>"});ab.success(new eV(fg));return fc.flash_sidebar_album(fh.gid)}})(this);fa=function(){if(!e1){eD.hide_all()}if(!e2){bg.hide()}cw.render_albums_sidebar();return bG.disable_selection()};e3=new Ajax.InPlaceEditor(e6,"/collection_create",{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:11,ajaxClass:Ajax.DBRequest,submitOnBlur:e0,initialText:"",cancelIfSame:true,clickToEdit:false,onCancel:fa,onFailure:function(){},savingText:el("Creating..."),onLeaveEditMode:bG.disable_selection(),onLeaveHover:function(){},ajaxOptions:{method:"POST",onSuccess:e8,job:e9,job_user:cB.get_viewer().photos_user,progress_text:el("Creating album...")},callback:function(fc,fe){var fd;ab.success(el("Creating album..."));fd={collection_name:fe,item_counters:JSON.stringify(e4)};if(bG.in_single_collection_view()){fd.source_collection_gid=bG.get_current_collection().gid}return fd}});e3.enterEditMode();if(!e0){return e3._controls.editor.observe("blur",fa)}},toggle_more_selected_actions:function(T){if(T){Event.extend(T).preventDefault()}if(!$("more-selected-actions-menu").visible()){return eD.show($("more-selected-actions-menu"),$("more-selected-actions-button"))}},toggle_more_actions:function(T){var e0;if(T){Event.extend(T).preventDefault()}if(!$("more-collection-actions-menu").visible()){if(bG.get_current_collection().share_tkey!=null){$("unshare-album").show()}else{$("unshare-album").hide()}if(bR.msie_version_at_most(10)){e0=bv("#more-collection-actions-menu");if(!e0.parent().is("body")){bv(document.body).append(e0.remove())}}return eD.show($("more-collection-actions-menu"),$("more-collection-actions-button"))}},_collection_created:function(T){var e0;e0=T.memo.collection;if(!e0.is_anonymous){this._collections.unshift(e0)}this._gid_to_collection[e0.gid]=e0;this._url_to_collection[e0.url]=e0;return this.refresh_album_views()},_collection_changed:function(T){this._collections.removeItem(T);this._collections.unshift(T);return this.refresh_album_views()},_collection_photos_added:function(e6){var e5,e3,e2,e7,e8,e1,T,e0,e9,e4;e5=e6.memo.collection;e9=e6.memo.photos;e7=e6.memo.num_items_added;e1=e6.memo.num_photos_added;e0=e6.memo.num_videos_added;if(e6.memo.promote_collection&&e7>0){this._collection_changed(e5)}else{this.refresh_album_views()}if(e9===eF.get()){eF.clear()}if(e7<1){e4=cV.categorize_files(e9),e8=e4[0],T=e4[1];if(e8&&T){e2=a4("That item is already in '%(collection_name)s'","Those items are already in '%(collection_name)s'",e9.length)}else{if(e8){e2=a4("That photo is already in '%(collection_name)s'","Those photos are already in '%(collection_name)s'",e9.length)}else{e2=a4("That video is already in '%(collection_name)s'","Those videos are already in '%(collection_name)s'",e9.length)}}}else{if(e1&&e0){e2=a4("Added item to '%(collection_name)s'","Added items to '%(collection_name)s'",e9.length)}else{if(e1){e2=a4("Added photo to '%(collection_name)s'","Added photos to '%(collection_name)s'",e9.length)}else{e2=a4("Added video to '%(collection_name)s'","Added videos to '%(collection_name)s'",e9.length)}}}e3=e5.name.escapeHTML();e2=e2.format({collection_name:"<a data-gid='"+e5.gid+"' class='show-collection-target'>"+e3+"</a>"});return ab.success(new eV(e2))},_collection_photos_removed:function(e0){var e1,e2,T;e1=e0.memo.collection;e2=e0.memo.photos;T=bG.undo_enabled?e0.memo.undo_changeset:null;bG.get_timeline().remove_photos(e2);this._collection_changed(e1);return ab.success(el("Removed %(files_desc)s from '%(collection_name)s'").format({files_desc:cV.file_desc(e2),collection_name:e1.name}),null,null,T,(function(){return e1.undo_remove(T)}))},_collection_undid_remove:function(T){var e0;e0=T.memo.collection;bG.get_timeline().restore_removed_photos();cw.refresh_album_views([e0.gid]);return ab.success(el("Undo complete"))},_collection_renamed:function(e0){var e1,T;e1=e0.memo.collection;if(((T=bG.get_current_collection())!=null?T.gid:void 0)===e1.gid){bv("#single-collection-title").text(bK.em_snippet(e1.name,this.HEADER_COLLECTION_SNIPPET_LENGTH,1));document.title=""+e1.name+" - Dropbox"}this._collection_changed(e1);return ab.success(el("Renamed '%(collection_name)s'").format({collection_name:e1.name}))},_collection_deleted:function(e0){var e1,T;e1=e0.memo.collection;this._collections.removeItem(e1);if(!this._all_collections_loaded){this._removed_pre_load.push(e1.gid)}this.refresh_album_views();if(((T=bG.get_current_collection())!=null?T.gid:void 0)===e1.gid){bG.show_all_collections()}delete this._gid_to_collection[e1.gid];delete this._url_to_collection[e1.url];return ab.success(el("Deleted '%(collection_name)s'").format({collection_name:e1.name}))},_collection_shared:function(e0){var e1,T;e1=e0.memo.collection;this._collection_changed(e1);if(((T=bG.get_current_collection())!=null?T.gid:void 0)===e1.gid){bv("#single-collection-share-status").text(el("Shared"));return bv("#single-collection-share-status").attr("href",e1.shmodel_url)}},_collection_unshared:function(e0){var e1,T;e1=e0.memo.collection;if(((T=bG.get_current_collection())!=null?T.gid:void 0)===e1.gid){bv("#single-collection-share-status").text("")}return ab.success(el("Unshared '%(collection_name)s'").format({collection_name:e1.name}))},_collection_cover_changed:function(T){var e1,e0;e1=T.memo.collection;this._collection_changed(e1);e0=el("Changed cover photo for '%(collection_name)s'");e0=e0.format({collection_name:e1.name.escapeHTML()});return ab.success(e0)},_albums_list_item_contextmenu:function(e0,T){bg.show_photo_collection(e0,this.get(T.readAttribute("data-gid")),T);T.removeClassName("album-flash");return T.addClassName("context-selected")},_show_collection_click:function(e1,T){var e0;e0=$(e1.target);if(e0.hasClassName("inplaceeditor-form")||(e0.up(".inplaceeditor-form")!=null)){return}return bG.show_collection(T.readAttribute("data-gid"))},_collection_shmodel_click:function(e0,T){return this.go_to_link(this.get(T.readAttribute("data-gid")))},_add_to_album_click:function(e0,T){if(eF._context_selected){this.add_photos(this.get(T.readAttribute("data-gid")),eF._context_selected);eF._context_selected=null}else{this.add_photos(this.get(T.readAttribute("data-gid")),eF.get())}delete eS.onHide;eS.hide();return h.log_interaction(d8.ADD_TO_RECENT_ALBUM,cY.SAH,{num_photos:eF.get().length})},_drop_target_mouseover:function(e0,T){if(eF._drag_drop.active){T.addClassName("hovered");return $("photos-drag-status").addClassName("hovering")}},_drop_target_mouseout:function(e0,T){if(eF._drag_drop.active){T.removeClassName("hovered");return $("photos-drag-status").removeClassName("hovering")}},_drop_target_mouseup:function(e0,T){var e1;if(T.hasClassName("hovered")){T.removeClassName("hovered");$("photos-drag-status").removeClassName("hovering");if(eF._drag_drop.single_photo!=null){e1=[eF._drag_drop.single_photo]}else{e1=eF.get()}if(T.readAttribute("data-gid")!=null){this.add_photos(this.get(T.readAttribute("data-gid")),e1,false)}if(T.identify()==="add-to-album-sidebar-new"){return h.log_interaction(d8.ADD_TO_NEW_ALBUM,cY.DROP_TARGET,{num_photos:eF.get().length})}else{if(T.identify()==="all-albums-sidebar"){return h.log_interaction(d8.ADD_TO_OTHER_ALBUM,cY.DROP_TARGET,{num_photos:eF.get().length})}else{return h.log_interaction(d8.ADD_TO_RECENT_ALBUM,cY.DROP_TARGET,{num_photos:eF.get().length})}}}},_create_album_click:function(T,e0){if(eF._context_selected){this.create(T,e0.down(".collection-name"),eF._context_selected,true);return eF._context_selected=null}else{return this.create(T,e0.down(".collection-name"),eF.get(),true)}},_window_scroll:function(){if(bG.in_all_collections_view()){return this._all_albums_scroll_position=z.scroll_offsets().top}},get_all:function(){return this._collections},get_from_url:function(T){return this._url_to_collection[T]},get:function(T){return this._gid_to_collection[T]},go_to_link:function(T){return window.open(T.shmodel_url,"_blank")},restore_all_albums_scroll_position:function(){if(this._all_albums_scroll_position!=null){return window.scrollTo(0,this._all_albums_scroll_position)}else{return window.scrollTo(0,0)}},two_line_snippet:function(e1,e0){var T,e3,e2;T=bK.em_snippet(e1,e0,1);e3=T.lastIndexOf(" ");if(e3===-1){return T}else{T=T.slice(0,+e3+1||9000000000);e2=bK.em_snippet(e1.slice(e3+1),e0,1);return T+e2}},get_default_album_name:function(){var T;T=el("Untitled album");return this.increment_collection_name_until_valid(T)},collection_name_in_use:function(e0){var e3,e2,T,e1;e1=this.get_all();for(e2=0,T=e1.length;e2<T;e2++){e3=e1[e2];if(e3.name===e0.trim()){return true}}return false},increment_collection_name_until_valid:function(e0){var e1,T;e1=this.collection_name_in_use(e0);T=0;while(e1){T++;e1=this.collection_name_in_use(e0+(" ("+T+")"))}return(T===0?e0:e0+(" ("+T+")"))},flash_sidebar_album:function(e3){var e4,e2,e0,e1,T;e1=$$(".sidebar-album");T=[];for(e2=0,e0=e1.length;e2<e0;e2++){e4=e1[e2];if(e4.readAttribute("data-gid")===e3){e4.removeClassName("album-flash");e4.addClassName("album-flash");break}else{T.push(void 0)}}return T}};var b9;b9=B.PhotoTimeline=(function(){T.PHOTOS_ADDED_EVT="db:phototimeline:photos_added";T.PHOTOS_REMOVED_EVT="db:phototimeline:photos_removed";T.prototype.THUMB_SIZE=null;T.prototype.HEADER_HEIGHT=null;T.prototype.THUMBS_PER_ROW=4;T.prototype.RENDER_SCROLL_WAIT=100;T.prototype.RENDER_SCROLL_MAX_WAIT=750;T.prototype.HIDE_TIMELINE_NAV_DELAY=1500;T.prototype.THUMBS_BATCH_SIZE=12;T.prototype.VIEWPORT_SCALE_SCROLL_DIRECTION=4;T.prototype.VIEWPORT_SCALE_OTHER_DIRECTION=1;T.prototype.TIMELINE_NAV_MOUSE_THRESHOLD=100;T.prototype.TIMELINE_NAV_ELM_HEIGHT=20;T.prototype.TIMELINE_DOT_HTML=cm.html("web","timeline_dot");T.container;T.scroll_container;T.events;T.current_event;T.key_to_photo;T.preview_objs;T.tmpl;T.last_render_scroll_timeout;T.start_render_scroll_time;T.last_scroll_position;T.hide_timeline_nav_timeout;T.grid;T._skip_scroll_update;T.header_id_to_sel_items;T.event_remove_info;T.opts;function T(e1,e2,e5,e3,e4,e6,e7,e8,e0){this.container=e1;this.scroll_container=e2;this.tmpl=e7;this.opts=e0;this.THUMB_SIZE=e8.thumb_size;this.HEADER_HEIGHT=e8.header_height;this.key_to_photo={};this.preview_objs=[];this.start_render_scroll_time=-1;this.grid={};this._skip_scroll_update=false;this.header_id_to_sel_items=e6;this.event_remove_info=[];this._init_events(e5,e3,e4);this.update_offsets(e8.top_offset,e8.left_offset);this.listen();dk.start_capture(this.scroll_container)}T.prototype._init_events=function(e8,e2,e4){var e1,e6,fb,e3,e5,e9,e0,e7,fa;if(e8.length<1){this.events=new aT([],{});return}e6=[];e5={};fb=false;for(e7=0,fa=e8.length;e7<fa;e7++){e3=e8[e7];e3=String(e3);e0=e3 in this.header_id_to_sel_items?this.header_id_to_sel_items[e3]:[];e9=false;if(e0.length&&!fb){fb=true;e9=true}e1=new cZ(this,e3,e2[e3],e4[e3],e0,e9);e6.push(e3);e5[e3]=e1}return this.events=new aT(e6,e5)};T.prototype.listen=function(){this._bound_window_scroll=this._window_scroll.bind(this);this._bound_window_resize=this._window_resize.bind(this);this._body_mousemove_handler=$(document.body).on("mousemove",this._body_mousemove.bind(this));this._timeline_elm_click_handler=$(document.body).on("click",".timeline-elm",this._timeline_elm_click.bind(this));this._show_missing_timestamp_bucket_handler=$(document.body).on("click","#show-missing-timestamps-button",this._show_missing_timestamp_bucket.curry(true,false).bind(this));if(this.scroll_container!=null){this.scroll_container.observe("scroll",this._bound_window_scroll)}else{Event.observe(window,"scroll",this._bound_window_scroll)}Event.observe(window,"resize",this._bound_window_resize);return $(document).observe(cZ.EVENT_MISCOUNT_EVT,this._event_miscount.bind(this))};T.prototype.unlisten=function(){var e1,e0,e2;if((e1=this._body_mousemove_handler)!=null){e1.stop()}if((e0=this._timeline_elm_click_handler)!=null){e0.stop()}if((e2=this._show_missing_timestamp_bucket_handler)!=null){e2.stop()}if(this.scroll_container!=null){this.scroll_container.stopObserving("scroll",this._bound_window_scroll)}else{Event.stopObserving(window,"scroll",this._bound_window_scroll)}Event.stopObserving(window,"resize",this._bound_window_resize);return $(document).stopObserving(cZ.EVENT_MISCOUNT_EVT)};T.prototype.render=function(){this._render_empty_grid();this.init_timeline_nav();this._load_metadata_for_sel_events();return this._render_viewport()};T.prototype.update_offsets=function(e2,e1){var e3,e5,e4,e0;cz(this.THUMBS_PER_ROW>0,"Invalid THUMBS_PER_ROW: "+this.THUMBS_PER_ROW);this.top_offset=e2;this.refresh_row_offsets();this.left_offset=e1;this.grid.photo_col_offsets=[];e0=[];for(e3=e5=0,e4=this.THUMBS_PER_ROW;0<=e4?e5<=e4:e5>=e4;e3=0<=e4?++e5:--e5){e0.push(this.grid.photo_col_offsets.push(this.left_offset+this.THUMB_SIZE*e3))}return e0};T.prototype.refresh_row_offsets=function(){var e7,e4,e2,e6,e3,e1,e5,e0;this.grid.photo_row_offsets=[];e7=this.top_offset;e5=this.events.getValues();for(e6=0,e1=e5.length;e6<e1;e6++){e4=e5[e6];e4.top_offset=e7;e7+=this.HEADER_HEIGHT;this.grid.photo_row_offsets.push(e7);for(e2=e3=0,e0=e4.get_num_rows();0<=e0?e3<e0:e3>e0;e2=0<=e0?++e3:--e3){e7+=this.THUMB_SIZE;this.grid.photo_row_offsets.push(e7)}}};T.prototype._render_empty_grid=function(){var e1,e4,e3,e0,e2;this.container.__date();e2=this.events.getValues();for(e3=0,e0=e2.length;e3<e0;e3++){e1=e2[e3];if(!(e1.is_missing_timestamp_bucket()&&this.events.length()>1)){e1.add_html_elements_to(this.container)}}if(this.has_missing_timestamp_bucket()&&this.events.length()>1){e4=bv('<div id="show-missing-timestamps-button"/>').addClass("freshbutton-silver").text(el("Show photos with missing dates"));return bv(this.container).append(e4)}};T.prototype._render_viewport=function(e3){var e1,fc,e4,fb,fe,e9,e8,e6,fd,e2,e0,fa,e7,e5;if(e3==null){e3=false}this.start_render_scroll_time=-1;fe=this.get_viewport_info();fc=[];fa=this.events.getValues();for(e9=0,fd=fa.length;e9<fd;e9++){e1=fa[e9];if(!(e1.has_loaded_metadata()||e1.loading_metadata||(e1.is_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown()))){if(e1.in_current_viewport(fe,false)){fc.unshift(e1)}else{if(e1.in_current_viewport(fe,true)){fc.push(e1)}}}}for(e8=0,e2=fc.length;e8<e2;e8++){e1=fc[e8];e7=e1.get_photo_range_to_render(fe,true),e4=e7[0],fb=e7[1];e1.load_metadata_range(e4,fb)}if(e3){fe=this.get_viewport_info();e5=this.events.getValues();for(e6=0,e0=e5.length;e6<e0;e6++){e1=e5[e6];if(e1.in_current_viewport(fe,false)){e1.timing_stopped_scrolling_on_event=bU.time()-this.RENDER_SCROLL_WAIT}}}return this._load_visible_photos()};T.prototype._load_metadata_for_sel_events=function(){var e2,e4,e0,e3,e1;if("a_missing_timestamps" in this.header_id_to_sel_items){this._show_missing_timestamp_bucket(false,false)}e3=this.header_id_to_sel_items;e1=[];for(e4 in e3){e0=e3[e4];e2=this.events.valueFromKey(e4);if(e2!=null){e2.load_metadata()}e1.push(cz(e2!=null,"Missing "+e4+" in list of events with selected photos"))}return e1};T.prototype._load_visible_photos=function(){var e2,e4,e1,e3,e0;e3=this.events.getValues();e0=[];for(e4=0,e1=e3.length;e4<e1;e4++){e2=e3[e4];if(!(e2.is_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown())){e0.push(e2.update_photo_divs())}else{e0.push(void 0)}}return e0};T.prototype._body_mousemove=function(e0){if(!this.opts.uses_timeline_nav){return}if((e0.clientX+z.scroll_offsets().left)>=($(document.body).getWidth()-this.TIMELINE_NAV_MOUSE_THRESHOLD)){return $("timeline-nav").addClassName("mouse-active")}else{return $("timeline-nav").removeClassName("mouse-active")}};T.prototype._timeline_elm_click=function(e3,e2){var e0,e1;e1=e2.readAttribute("data-event-id");if(e1){e0=this.events.valueFromKey(e1)}this._update_timeline_position(e0);if(e0.is_missing_timestamp_bucket()){h.log_interaction(cc.MISSING_TIMESTAMPS_VIEW);if(!this.is_missing_timestamp_bucket_shown()){this._show_missing_timestamp_bucket(false)}}return this._scroll_to_event(e0)};T.prototype._scroll_to_event=function(e2,e0){var e1;if(e0==null){e0=false}e1=e2.top_offset-this.top_offset;if(e2&&(z.scroll_offsets().top!==e1)){if(e0){return bv("html, body").animate({scrollTop:e1},200)}else{this._skip_scroll_update=true;return window.scrollTo(z.scroll_offsets().left,e1)}}};T.prototype._window_scroll=function(){var e3,e2,e6,e5,e1,e4,e0;e2=bU.time();bl.clear_all_pending_batches();if(this.start_render_scroll_time===-1||e2-this.start_render_scroll_time<this.RENDER_SCROLL_MAX_WAIT){clearTimeout(this.last_render_scroll_timeout)}if(this.start_render_scroll_time===-1){this.start_render_scroll_time=e2}e6=this.visible_thumbs_loaded()?0:this.RENDER_SCROLL_WAIT;this.last_render_scroll_timeout=setTimeout(this._render_viewport.curry(true).bind(this),e6);if(this.opts.uses_timeline_nav){this._update_timeline_position();$("timeline-nav").addClassName("scroll-active");clearTimeout(this.hide_timeline_nav_timeout);this.hide_timeline_nav_timeout=setTimeout(((function(e7){return function(){return $("timeline-nav").removeClassName("scroll-active")}})(this)),this.HIDE_TIMELINE_NAV_DELAY)}this.last_scroll_position=z.scroll_offsets().top;bG.scroll_count++;e4=this.events.getValues();e0=[];for(e5=0,e1=e4.length;e5<e1;e5++){e3=e4[e5];e0.push(e3.logged_thumbs_arrived=false)}return e0};T.prototype._window_resize=function(){this._resize_timeline_nav();return this._show_hide_timeline_elms()};T.prototype.init_timeline_nav=function(){var e1,e3,e0,e2;if(!this.opts.uses_timeline_nav){return}this.grid.side_nav={};this.current_event=null;this._resize_timeline_nav();e2=this.events.getValues().reverse();for(e3=0,e0=e2.length;e3<e0;e3++){e1=e2[e3];e1.add_to_timeline_nav(e1===this.events.getValues()[0])}this._update_timeline_position();return this._show_hide_timeline_elms()};T.prototype._resize_timeline_nav=function(){var e0;if(!this.opts.uses_timeline_nav){return}e0=this.get_viewport_info().height-this.TIMELINE_NAV_ELM_HEIGHT;return $("timeline-nav").setStyle({height:e0+"px"})};T.prototype._update_timeline_position=function(e6){var fa,e7,e0,e9,e4,e3,e8,e1,e5,e2;if(!this.opts.uses_timeline_nav){return}if(this._skip_scroll_update){this._skip_scroll_update=false;return}if(e6==null){e9=this.get_viewport_info();if(this.scroll_container==null){e9.top=document.viewport.getScrollOffsets().top}fa=e9.top+e9.height/2;e5=this.events.getValues();for(e4=0,e8=e5.length;e4<e8;e4++){e0=e5[e4];if(e0.top_offset>fa){break}e6=e0}}if((e6==null)||e6===this.current_event){return}$$(".timeline-elm.current").invoke("removeClassName","current");e2=$$(".timeline-elm");for(e3=0,e1=e2.length;e3<e1;e3++){e7=e2[e3];if(e7.readAttribute("data-event-id")===e6.unique_id){e7.addClassName("current");break}}return this.current_event=e6};T.prototype._show_hide_timeline_elms=function(){var e7,e4,e2,e3,e6,e1,e5,e0;if(!this.opts.uses_timeline_nav){return}e2=$("cu-header").cumulativeOffset().left+$("cu-header").getWidth();e4=$("cu-header").cumulativeOffset().top+$("cu-header").getHeight();e5=$$(".timeline-elm");e0=[];for(e6=0,e1=e5.length;e6<e1;e6++){e7=e5[e6];e7.show();e3=e7.cumulativeOffset();if(e3.top<e4&&e3.left<e2){e0.push(e7.hide())}else{e0.push(void 0)}}return e0};T.prototype._event_miscount=function(e0){this.refresh_row_offsets();return this._load_visible_photos()};T.prototype.remove_photos=function(e7){var e3,e5,e6,e2,e1,e4,e0;e7=e7.slice(0);this.event_remove_info=[];e6={};for(e4=0,e0=e7.length;e4<e0;e4++){e2=e7[e4];e5=e2.event.unique_id;if(e5 in e6){e6[e5].push(e2)}else{e6[e5]=[e2]}}for(e5 in e6){e7=e6[e5];e3=this.events.valueFromKey(e5);e1=e3.remove_photos(e7);this.event_remove_info.push({event:e3,remove_info:e1})}this.init_timeline_nav();this.refresh_row_offsets();this._load_visible_photos();return $(document).fire(T.PHOTOS_REMOVED_EVT,this)};T.prototype.restore_removed_photos=function(){var e1,ff,fb,fe,fc,e3,fa,e8,e7,e5,fd,e2,e0,e9,e6,e4;eF.clear();e9=this.event_remove_info.reverse();for(e8=0,fd=e9.length;e8<fd;e8++){ff=e9[e8];e1=ff.event;fc=ff.remove_info;if(fc.removed_event_index!=null){this.events.insertAtIndex(fc.removed_event_index,e1.unique_id,e1);e1.restore()}e1.add_photos(fc.removed_photos_and_indexes.reverse());e6=fc.removed_photos_and_indexes;for(e7=0,e2=e6.length;e7<e2;e7++){fe=e6[e7];eF._add(fe.photo)}}e3=null;fa=null;e4=this.event_remove_info;for(e5=0,e0=e4.length;e5<e0;e5++){ff=e4[e5];e1=ff.event;fc=ff.remove_info;fb=this.events.indexOfKey(e1.unique_id);if((e3==null)||e3>fb){e3=fb;fa=fc.removed_photos_and_indexes[0].photo}}this.event_remove_info=[];this.init_timeline_nav();if(fa!=null){this.scroll_to_photo_with_key(fa.uniqueness_key)}this.refresh_row_offsets();this._load_visible_photos();return $(document).fire(T.PHOTOS_ADDED_EVT,this)};T.prototype.get_photos=function(){var e1,e4,e3,e0,e2;e4=[];e2=this.events.getValues();for(e3=0,e0=e2.length;e3<e0;e3++){e1=e2[e3];e4=e4.concat(e1.photos)}return e4};T.prototype.num_photos=function(){var e2,e1,e4,e0,e3;e1=0;e3=this.events.getValues();for(e4=0,e0=e3.length;e4<e0;e4++){e2=e3[e4];e1+=e2.photos.length}return e1};T.prototype.get_preview_objs=function(){var e0,e1,e7,e5,e4,e8,e2,e6,e3;e7=[];e6=this.events.getValues();for(e5=0,e8=e6.length;e5<e8;e5++){e0=e6[e5];e3=e0.photos;for(e4=0,e2=e3.length;e4<e2;e4++){e1=e3[e4];e7.push(e1.preview_obj)}}return e7};T.prototype.index_of_photo=function(e2){var e3,e1,e5,e0,e4;e1=0;e4=this.events.getValues();for(e5=0,e0=e4.length;e5<e0;e5++){e3=e4[e5];if(e3===e2.event){e1+=e3.photos.indexOf(e2);break}else{e1+=e3.photos.length}}return e1};T.prototype.photo_at_index=function(e2){var e0,e3,e5,e1,e4;e0=0;e4=this.events.getValues();for(e5=0,e1=e4.length;e5<e1;e5++){e3=e4[e5];if(e0+e3.photos.length>e2){return e3.photos[e2-e0]}else{e0+=e3.photos.length}}return null};T.prototype.get_thumb_elm_for_photo=function(e0){return $(e0.uniqueness_key)};T.prototype.get_photo_for_thumb_elm=function(e0){if(!e0.hasClassName("cu-thumb")){e0=e0.up(".cu-thumb")}if(e0){return this.key_to_photo[e0.identify()]}else{return null}};T.prototype.get_viewport_info=function(){var e0,e1;if(this.scroll_container!=null){e1=this.scroll_container.scrollTop;e0=this.scroll_container.getHeight()}else{e1=z.scroll_offsets().top;e0=z.viewport_dimensions().height}return{top:e1,height:e0,bottom:e1+e0}};T.prototype.scroll_to_photo_with_key=function(e1){var e5,e2,e0,e4,e3;z.scroll_unlock_document();e5=$(e1);if(e5!=null?e5.visible():void 0){dQ.scroll_to_thumb(e5)}else{e0=this.key_to_photo[e1];e2=e0.event;if(e0.event!=null){e4=Math.floor(e2.photos.indexOf(e0)/this.THUMBS_PER_ROW);e3=this.get_viewport_info().height;z.scroll_to(0,e2.top_offset+this.HEADER_HEIGHT+e4*this.THUMB_SIZE-e3/2)}}return this._load_visible_photos()};T.prototype.restore_scroll_position=function(){z.scroll_unlock_document();if(this.last_scroll_position!=null){window.scrollTo(0,this.last_scroll_position)}else{window.scrollTo(0,0)}if(Prototype.Browser.IE&&Prototype.Browser.IEV<9){return this._load_visible_photos()}};T.prototype.visible_thumbs_loaded=function(){var e1,e3,e0,e2;e2=this.events.getValues();for(e3=0,e0=e2.length;e3<e0;e3++){e1=e2[e3];if(!e1.visible_thumbs_loaded()){return false}}return true};T.prototype.has_missing_timestamp_bucket=function(){var e0;e0=this.events.getValues();return e0[e0.length-1].is_missing_timestamp_bucket()};T.prototype.is_missing_timestamp_bucket_shown=function(){var e0,e1;if(!this.has_missing_timestamp_bucket()){return false}e0=this.events.getValues();e1=e0[e0.length-1].unique_id;return bv("#p-"+e1).length>0};T.prototype._show_missing_timestamp_bucket=function(e0,e3){var e2,e1;if(e0==null){e0=true}if(e3==null){e3=false}if(!(this.has_missing_timestamp_bucket()&&!this.is_missing_timestamp_bucket_shown())){return}e1=this.events.getValues();e2=e1[e1.length-1];bv("#show-missing-timestamps-button").hide();e2.add_html_elements_to(this.container);if(!e3){if(this.opts.uses_timeline_nav){$("timeline-nav").addClassName("mouse-active")}this._scroll_to_event(e2,e0);this._render_viewport()}return this.init_timeline_nav()};return T})();var cZ;cZ=B.PhotoEvent=(function(){T.EVENT_MISCOUNT_EVT="db:photoevent:miscount";T.PHOTOS_LOADED_EVT="db:photoevent:photos_loaded";T.prototype.MONTH_PREFIX="m_";T.prototype.COLLECTION_PREFIX="c_";T.prototype.EVENT_PREFIX="e_";T.prototype.MISSING_TIMESTAMP_PREFIX="a_";T.prototype.NUM_LIGHTBOX_PHOTOS_TO_PRELOAD=5;T.prototype.MAX_PHOTOS_PER_METADATA_REQUEST=500;T.timeline;T.unique_id;T.name;T.init_num_photos;T.photos;T.header_html;T.placeholder_html;T.top_offset;T.loading_metadata;T.cursor;T.num_photos_loaded;T.prototype.LOADING_ORDER_NOT_DECIDED=-1;T.prototype.LOADING_ORDER_TOP_DOWN=0;T.prototype.LOADING_ORDER_BOTTOM_UP=1;T.loading_order;T.num_photos_to_load;T.on_load_all_metadata;T.init_sel_items;T.scroll_to_first_sel;T.num_to_select;T.logged_thumbs_arrived;T.timing_metadata_received;T.timing_stopped_scrolling_on_event;T.scroll_count;function T(e8,e5,e1,e6,e0,e4){var e3,e9,e2,e7;this.timeline=e8;this.unique_id=e5;this.name=e1;this.init_num_photos=e6;this.photos=(function(){var fb,fa;fa=[];for(e3=fb=0;0<=e6?fb<e6:fb>e6;e3=0<=e6?++fb:--fb){fa.push(new H(this))}return fa}).call(this);this.init_sel_items={};for(e2=0,e7=e0.length;e2<e7;e2++){e9=e0[e2];this.init_sel_items[e9]=true}this.num_to_select=e0.length;this.scroll_to_first_sel=e4;this._generate_container_html();this.timing_metadata_received=-1;this.timing_stopped_scrolling_on_event=-1;this.num_photos_loaded=0;this.loading_order=this.LOADING_ORDER_NOT_DECIDED;this.num_photos_to_load=0;this.loading_metadata=false;if(e6===0){$("single-album-empty").show()}}T.prototype.is_month=function(){return this.unique_id.slice(0,2)===this.MONTH_PREFIX};T.prototype.is_missing_timestamp_bucket=function(){return this.unique_id.slice(0,2)===this.MISSING_TIMESTAMP_PREFIX};T.prototype.get_month=function(){var e0;cz(this.is_month(),"this must be a month event");e0=parseInt(this.unique_id.slice(6,8),10);cz(!isNaN(e0),"Month was not parsed out of the event id "+this.unique_id+" correctly.",true,["photo_event_nan_date"]);return e0};T.prototype.get_year=function(){var e0;cz(this.is_month(),"this must be a month event");e0=parseInt(this.unique_id.slice(2,6),10);cz(!isNaN(e0),"Year was not parsed out of the event id "+this.unique_id+" correctly.",true,["photo_event_nan_date"]);return e0};T.prototype.is_collection=function(){return this.unique_id.slice(0,2)===this.COLLECTION_PREFIX};T.prototype.get_collection_gid=function(){cz(this.is_collection(),"this must be a collection event");return this.unique_id.slice(2)};T.prototype.is_event=function(){return this.unique_id.slice(0,2)===this.EVENT_PREFIX};T.prototype._generate_container_html=function(){var e3,e1,e4,e6,e2,e0,e5;e6=this.name;if(this.is_event()){this.header_html=new Element("h1",{id:"h-"+this.unique_id,"class":"cu-month-header"});this.header_html.__sert(e6);e3=new Element("div",{"class":"event-button event-add-to-album title_bubble","data-title":"Add to album"});e3.__date(cm.html("web","event_add_to_album"));this.header_html.__sert(e3);e5=new Element("div",{"class":"event-button event-share title_bubble","data-title":"Share"});e5.__date(cm.html("web","event_share"));this.header_html.__sert(e5);e0=new Element("div",{"class":"event-button event-select title_bubble","data-title":"Select all"});e0.__date(cm.html("web","event_select"));this.header_html.__sert(e0)}else{this.header_html=new eV("<h1 class='cu-month-header' id='h-"+this.unique_id+"'><span>"+e6+"</span></h1>")}e1=this.get_content_height();e2=this.photos.length%this.timeline.THUMBS_PER_ROW;e4=e2===0?0:(this.timeline.THUMBS_PER_ROW-e2)*this.timeline.THUMB_SIZE;return this.placeholder_html=new eV('<div style="height: '+e1+'px;" id="p-'+this.unique_id+'" class="content-placeholder-container">\n  <div style="height: '+e1+'px;" id="p-top-'+this.unique_id+'" class="content-placeholder"></div>\n  <div style="height: 0px;" id="p-bottom-'+this.unique_id+'" class="content-placeholder"></div>\n  <div style="width: '+e4+'px" id="p-cover-'+this.unique_id+'" class="thumb-cover"></div>\n</div>')};T.prototype.add_html_elements_to=function(e1){var e0;if(this.is_event()){e0=new Element("div",{"class":"photo-event"});e0.__sert(this.header_html);e0.__sert(this.placeholder_html);return e1.__sert(e0)}else{e1.__sert(this.header_html);return e1.__sert(this.placeholder_html)}};T.prototype.remove=function(){$("h-"+this.unique_id).hide();$("p-"+this.unique_id).hide();return this.timeline.events.remove(this.unique_id)};T.prototype.restore=function(){$("h-"+this.unique_id).show();return $("p-"+this.unique_id).show()};T.prototype.add_to_timeline_nav=function(e7){var e0,e5,e8,e1,e9,e4,e3,e6,e2;if(e7==null){e7=false}if(!(this.is_month()||this.is_event()||this.is_missing_timestamp_bucket())){return}e2=this.timeline.get_viewport_info().height;e9=this.timeline.TIMELINE_NAV_ELM_HEIGHT;e4=$(document.body).getHeight();e3=this.top_offset/e4*100;if(this.is_event()){e1=this.name}else{if(this.is_missing_timestamp_bucket()){e1=el("Missing dates")}else{e1=bU.month_abbr_with_year(this.get_month()-1,this.get_year())}}e8=false;for(e6 in this.timeline.grid.side_nav){e0=Math.abs(this.timeline.events.valueFromKey(e6).top_offset-this.top_offset);if(e0/e4*e2<e9){e8=true;if(e7){bv("#timeline-nav-"+e6).remove()}}}e5=bv("#timeline-nav-"+this.unique_id);if(!e8||e7){if(e5.length){e5.css("top",""+e3+"%")}else{e5=bv("<div/>");e5.addClass("timeline-elm");e5.attr({"data-event-id":this.unique_id.toString(),id:"timeline-nav-"+this.unique_id});e5.css("top",""+e3+"%");e5.text(e1);bv("#timeline-nav").append(e5)}return this.timeline.grid.side_nav[this.unique_id]=e3}else{if(e5.length){return e5.remove()}}};T.prototype.marquee_highlight=function(e0,e7,e4){var e2,e8,e1,e9,fb,e3,e6,e5,fa;if(this.top_offset>e7||this.top_offset+this.get_height()<e0){return}if(e0<this.top_offset){e7-=this.top_offset;if(e7<this.timeline.HEADER_HEIGHT){return}e3=0;fb=Math.floor((e7-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}else{if(e7>this.top_offset+this.get_height()){e0-=this.top_offset;fb=Math.ceil(this.photos.length/this.timeline.THUMBS_PER_ROW);if(e0<this.timeline.HEADER_HEIGHT){e3=0}else{e3=Math.floor((e0-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}}else{e0-=this.top_offset;e7-=this.top_offset;if(e0<this.timeline.HEADER_HEIGHT&&e7<this.timeline.HEADER_HEIGHT){return}else{if(e0<this.timeline.HEADER_HEIGHT){e3=0;fb=Math.floor((e7-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}else{e3=Math.floor((e0-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);fb=Math.floor((e7-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE)}}}}for(e9=e6=e3;e3<=fb?e6<=fb:e6>=fb;e9=e3<=fb?++e6:--e6){for(e5=0,fa=e4.length;e5<fa;e5++){e2=e4[e5];e8=this.timeline.THUMBS_PER_ROW*e9+e2;if(e8<this.photos.length){e1=this.photos[e8];if(e1.status!==H.PLACEHOLDER&&!eF.contains(e1)){eF._highlight(e1)}}}}};T.prototype.add_photos=function(e3){var e2,e1,e4,e5,e0;for(e5=0,e0=e3.length;e5<e0;e5++){e4=e3[e5];e1=e4.photo;e2=e4.index;cz(e2<=this.photos.length,"cannot insert past end of photos array");this.photos.splice(e2,0,e1);if(e1.status>=H.LOADED){e1.status=H.LOADED;this.num_photos_loaded++;this.num_photos_to_load=Math.max(this.num_photos_to_load,this.num_photos_loaded)}}return this._num_photos_changed()};T.prototype.remove_photos=function(e8){var e5,e0,e4,e6,e1,e2,e7,e3;e5=this.timeline.events.indexOfKey(this.unique_id);e1=[];for(e2=0,e7=e8.length;e2<e7;e2++){e0=e8[e2];e4=this.photos.indexOf(e0);cz(e4>-1,"Photo not found in the photos array!");this.photos.splice(e4,1);if(e0.status>=H.LOADED){this.num_photos_loaded--;if((e3=$(e0.uniqueness_key))!=null){e3.remove()}e0.status=H.LOADED}eF._remove(e0);e1.push({photo:e0,index:e4})}this._num_photos_changed();e6={removed_photos_and_indexes:e1};if(this.photos.length===0){e6.removed_event_index=e5}return e6};T.prototype._num_photos_changed=function(){if(this.photos.length===0){return this.remove()}else{return this._update_placeholder_container()}};T.prototype.update_placeholders=function(){if($("p-"+this.unique_id)!=null){this._update_placeholder_container();$("p-top-"+this.unique_id).setStyle({height:""+(this.get_content_height())+"px"});return $("p-bottom-"+this.unique_id).setStyle({height:"0px"})}else{return this._generate_container_html()}};T.prototype._update_placeholder_container=function(){var e1,e0;$("p-"+this.unique_id).setStyle({height:""+(this.get_content_height())+"px"});e0=this.photos.length%this.timeline.THUMBS_PER_ROW;e1=e0!==0?(this.timeline.THUMBS_PER_ROW-e0)*this.timeline.THUMB_SIZE:0;return $("p-cover-"+this.unique_id).setStyle({width:""+e1+"px"})};T.prototype.load_metadata=function(e7){var e2,e1,e6,e0,e4,e5,e3;e0=0;if((!this._is_valid_photo_index(e7))||(this.num_to_select>0)){if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=this.LOADING_ORDER_TOP_DOWN}e0=this.photos.length}else{if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=e7*2<=this.photos.length?this.LOADING_ORDER_TOP_DOWN:this.LOADING_ORDER_BOTTOM_UP}e0=this._is_loading_from_bottom()?this.photos.length-e7:e7+1}this.num_photos_to_load=Math.max(this.num_photos_to_load,e0);if(this.has_loaded_metadata()||(this.num_photos_loaded>=this.num_photos_to_load)){return}if(this.loading_metadata){return}if(this.load_cached_metadata()){return}this.loading_metadata=true;e4={show_hidden:bG.show_hidden};if(this.cursor!=null){e4.cursor=this.cursor}if(this._is_loading_from_bottom()){e4.chron_order=true}e4.limit=Math.max(this.num_photos_to_load-this.num_photos_loaded,0);if(e4.limit>this.MAX_PHOTOS_PER_METADATA_REQUEST){e4.limit=this.MAX_PHOTOS_PER_METADATA_REQUEST}if(this.is_event()){e5=this.unique_id.split("_");e2=e5[2];e1=e5[1];e4.filters=JSON.stringify({date_begin:e2,date_end:e1},{event_id:this.unique_id})}else{if(this.is_missing_timestamp_bucket()){e4.filters=JSON.stringify({other:true})}else{if(this.is_month()){e3=this.get_year();e6=this.get_month();e2=dQ.to_iso8601_date(new Date(e3,e6-1,1,0,0,0,0),false,true);e1=dQ.to_iso8601_date(new Date(e3,e6,1,0,0,0),false,true);e4.filters=JSON.stringify({date_begin:e2,date_end:e1},{year:e3,month:e6})}else{if(this.is_collection()){e4.filters=JSON.stringify({collection_gid:this.get_collection_gid()})}else{cz(false,"invalid photo event id: "+this.unique_id)}}}}return new cs.WebRequest({url:"/photos_event_metadata",data:e4,dataType:"json",success:(function(e8){return function(e9){e8.timing_metadata_received=bU.time();e8.cursor=e9.cursor;return e8._load_metadata_callback(e9.photos,e9.key_to_duplicates,(e9.more!=null)&&e9.more)}})(this)})};T.prototype.load_metadata_range=function(e1,e0){if(!(this._is_valid_photo_index(e1)&&this._is_valid_photo_index(e0))){this.load_metadata();return}if(this.loading_order===this.LOADING_ORDER_NOT_DECIDED){this.loading_order=e1*2<=this.photos.length?this.LOADING_ORDER_TOP_DOWN:this.LOADING_ORDER_BOTTOM_UP}if(this._is_loading_from_bottom()){return this.load_metadata(e1)}else{return this.load_metadata(e0)}};T.prototype.load_cached_metadata=function(){var e0,e1;if(this.loading_metadata||this._is_loading_from_bottom()||this.num_photos_loaded>0||(((e1=bG.event_metadata_cache)!=null?e1[this.unique_id]:void 0)==null)){return false}e0=bG.event_metadata_cache[this.unique_id];this.cursor=e0.cursor;this._load_metadata_callback(e0.photos,e0.key_to_duplicates,e0.more);return true};T.prototype._load_metadata_callback=function(fc,e5,e6){var fb,e7,fh,e8,fi,e2,e9,ff,e4,fd,e3,fa,e1,e0,fe,fg;e8=[];e4=[];fa=false;for(fb=e1=0,fe=fc.length;e1<fe;fb=++e1){e9=fc[fb];if(this.has_loaded_metadata()){e2=new H(this);if(this._is_loading_from_bottom()){this.photos.unshift(e2)}else{this.photos.push(e2)}fa=true}else{if(this.num_photos_loaded<this.photos.length){e7=this._is_loading_from_bottom()?this.photos.length-1-this.num_photos_loaded:this.num_photos_loaded;e2=this.photos[e7]}else{cz(false,"num_photos_loaded should never be greater than photos.length")}}e2.init_metadata(e9);if(e2.uniqueness_key in e5){e2.set_duplicates(e5[e2.uniqueness_key])}if(fb<this.NUM_LIGHTBOX_PHOTOS_TO_PRELOAD){e4.push(e2.preview_obj)}e8.push(e2)}if(this.timeline.opts.uses_lightbox){window.setTimeout((function(){var fm,fl,fk,fj;fj=[];for(fl=0,fk=e4.length;fl<fk;fl++){fm=e4[fl];fj.push(fm.preload())}return fj}),500)}eF.refresh(e8);for(e0=0,fg=e8.length;e0<fg;e0++){e2=e8[e0];if(e2.item_counter in this.init_sel_items){eF._add(e2);this.num_to_select--;if(this.num_to_select===0){eF.dec_num_loading_events_before_select()}delete this.init_sel_items[e2.item_counter];if(this.scroll_to_first_sel){this.scroll_to_first_sel=false;e3=this.timeline;fh=e2.uniqueness_key;bv(document).ready(function(){return e3.scroll_to_photo_with_key(fh)})}}}if(!e6){if(this.num_photos_loaded<this.photos.length){fi=this.photos.length-this.num_photos_loaded;fd=this._is_loading_from_bottom()?0:this.num_photos_loaded;this.photos.splice(fd,fi);this.num_photos_to_load=Math.min(this.num_photos_to_load,this.num_photos_loaded)}if(fa||fi){this._fix_photo_miscount()}if(typeof this.on_load_all_metadata==="function"){this.on_load_all_metadata(this)}this.on_load_all_metadata=null}this.loading_metadata=false;this.update_photo_divs();$(document).fire(T.PHOTOS_LOADED_EVT,this);if(!this.has_loaded_metadata()&&this.num_photos_to_load>this.num_photos_loaded){ff=this._is_loading_from_bottom()?this.photos.length-this.num_photos_to_load:this.num_photos_to_load-1;return this.load_metadata(ff)}};T.prototype._fix_photo_miscount=function(){var e2,e1,e0;e2=Math.ceil(this.init_num_photos/this.timeline.THUMBS_PER_ROW);e1=this.get_num_rows()-e2;if(typeof h!=="undefined"&&h!==null){h.log("event_miscount",null,null,null,{event_id:this.unique_id,false_count:this.init_num_photos,true_count:this.photos.length,count_delta:this.photos.length-this.init_num_photos})}e0=z.scroll_offsets().top;if(this.top_offset+this.get_height()<e0){z.scroll_to(0,e0+e1*this.timeline.THUMB_SIZE)}this._num_photos_changed();return $(document).fire(T.EVENT_MISCOUNT_EVT,this)};T.prototype.get_num_rows=function(){return Math.ceil(this.photos.length/this.timeline.THUMBS_PER_ROW)};T.prototype.get_content_height=function(){return this.get_num_rows()*this.timeline.THUMB_SIZE};T.prototype.get_height=function(){return this.timeline.HEADER_HEIGHT+this.get_content_height()};T.prototype.has_loaded_metadata=function(){return this.num_photos_loaded===this.photos.length};T.prototype.visible_thumbs_loaded=function(e2){var e6,e5,e1,e0,e4,e3;if(e2==null){e2=this.timeline.get_viewport_info()}e3=this.get_photo_range_to_render(e2,false),e6=e3[0],e5=e3[1];if(e6===null&&e5===null){return true}for(e0=e4=e6;e6<=e5?e4<=e5:e4>=e5;e0=e6<=e5?++e4:--e4){e1=this.photos[e0];if((e1==null)||!(e1.status>=H.RENDERED)){return false}}return true};T.prototype._is_loaded=function(e0){var e1,e2;if(this._is_loading_from_bottom()){e2=this.photos.length-this.num_photos_loaded;e1=this.photos.length-1}else{e2=0;e1=this.num_photos_loaded-1}return(e2<=e0&&e0<=e1)};T.prototype._is_loading_from_bottom=function(){return this.loading_order===this.LOADING_ORDER_BOTTOM_UP};T.prototype._is_valid_photo_index=function(e0){return(e0!=null)&&(e0>=0)&&(e0<=this.photos.length-1)};T.prototype.update_photo_divs=function(){var e2,e1,fh,fg,fl,fo,fi,fd,e7,fp,ff,fm,fb,e8,e5,e3,fq,fr,e0,fn,fe,fc,fa,e6,e4,e9,fk,fj;if(!this.num_photos_loaded){return}fm=this.timeline.get_viewport_info();if(this.hide_photos_if_not_in_current_viewport(fm)){return}fn=this.get_photo_range_to_render(fm),fh=fn[0],fg=fn[1];cz((fh!=null)&&(fg!=null),"This line is after @hide_photos_if_not_in_ current_viewport, so first_photo_to_render and last_photo_to_render shouldn't be null.");if(!this.has_loaded_metadata()&&((!this._is_loaded(fh))||(!this._is_loaded(fg)))){this.load_metadata_range(fh,fg);if(this._is_loading_from_bottom()){fh=Math.max(fh,this.photos.length-this.num_photos_loaded)}else{fg=Math.min(fg,this.num_photos_loaded-1)}if(fh>fg){return}}fo=Math.floor(fh/this.timeline.THUMBS_PER_ROW);ff=fo*this.timeline.THUMB_SIZE;$("p-top-"+this.unique_id).setStyle({height:ff+"px"});fl=Math.floor((this.photos.length-1)/this.timeline.THUMBS_PER_ROW)-Math.floor(fg/this.timeline.THUMBS_PER_ROW);e1=fl*this.timeline.THUMB_SIZE;$("p-bottom-"+this.unique_id).setStyle({height:e1+"px"});this._hide_photos((function(){e9=[];for(var fs=0;0<=fh?fs<fh:fs>fh;0<=fh?fs++:fs--){e9.push(fs)}return e9}).apply(this));this._hide_photos((function(){fk=[];for(var fs=fe=fg+1,ft=this.photos.length;fe<=ft?fs<ft:fs>ft;fe<=ft?fs++:fs--){fk.push(fs)}return fk}).apply(this));this._show_photos((function(){fj=[];for(var fs=fh;fh<=fg?fs<=fg:fs>=fg;fh<=fg?fs++:fs--){fj.push(fs)}return fj}).apply(this));fa=eF.get();for(e3=0,fq=fa.length;e3<fq;e3++){fd=fa[e3];if((e6=$(fd.uniqueness_key))!=null){e6.addClassName("selected")}}this.scroll_count=bG.scroll_count;e2=[];e4=this.get_thumb_indexes_to_load(fm);for(e0=0,fr=e4.length;e0<fr;e0++){e7=e4[e0];fd=this.photos[e7];if((fd!=null)&&fd.status>=H.RENDERED){fp=$(fd.uniqueness_key);if((fp!=null?fp.down("img"):void 0)!=null){e2.push(fp.down("img"))}}}fi=function(fs){return fs.up(".cu-thumb").addClassName("thumb-loaded")};return bl.batch_load_thumbs(e2,this.timeline.THUMBS_BATCH_SIZE,fi,this.log_thumb_load.bind(this))};T.prototype._hide_photos=function(e4){var e2,e3,e1,e0;e0=[];for(e3=0,e1=e4.length;e3<e1;e3++){e2=e4[e3];e0.push(this._hide_photo(e2))}return e0};T.prototype._hide_photo=function(e0){var e1;e1=this.photos[e0];if((e1==null)||!(e1.status===H.DISPLAYED)){return}$(e1.uniqueness_key).hide();return e1.status=H.RENDERED};T.prototype._show_photos=function(fg){var fc,fb,ff,e4,fd,e9,e3,fa,e8,e6,e5,fe,e2,e1,e0,e7;e4=[];for(fa=0,fe=fg.length;fa<fe;fa++){fb=fg[fa];fd=this._get_photo_insert_info(fb);if(!fd){continue}ff=fd[0],e3=fd[1];e9=false;for(e8=0,e2=e4.length;e8<e2;e8++){fc=e4[e8];if(fc.after===ff){fc.photos.push(e3);e9=true;break}}if(!e9){e4.push({after:ff,photos:[e3]})}}for(e6=0,e1=e4.length;e6<e1;e6++){fc=e4[e6];fc.after.__sert({after:fc.photos})}e7=[];for(e5=0,e0=fg.length;e5<e0;e5++){fb=fg[e5];e7.push(this.photos[fb].status=H.DISPLAYED)}return e7};T.prototype._get_photo_insert_info=function(e0){var e3,e1,e2,e7,e4,e6,e5;e2=this.photos[e0];if((e2==null)||e2.status===H.DISPLAYED){return}if(e2.status===H.RENDERED){$(e2.uniqueness_key).show()}else{e1=$("p-top-"+this.unique_id);if(e0!==0){for(e3=e6=e5=e0-1;e5<=0?e6<=0:e6>=0;e3=e5<=0?++e6:--e6){e7=this.photos[e3];if((e7!=null)&&e7.status>=H.RENDERED){e4=$(e7.uniqueness_key);cz(e4!=null,"photo "+e3+" was marked as rendered, but its thumb elm doesn't exist");e1=e4;break}}}return[e1,e2.thumb_html]}};T.prototype.in_y_range=function(e1,e0){return !(this.top_offset+this.timeline.HEADER_HEIGHT>e0||this.top_offset+this.get_height()<e1)};T.prototype.in_current_viewport=function(e2,e4){var e0,e1,e3;if(e2==null){e2=this.timeline.get_viewport_info()}if(e4==null){e4=true}e1=e2.top;e0=e2.top+e2.height;if(e4){e3=this._blur_range(e1,e0,e2),e1=e3[0],e0=e3[1]}return this.in_y_range(e1,e0)};T.prototype.hide_photos_if_not_in_current_viewport=function(e3){var e1,e5,e2,e4,e0,e6;if(!this.in_current_viewport(e3)){if(this._is_loading_from_bottom()){for(e1=e5=e4=this.photos.length-this.num_photos_loaded,e0=this.photos.length;e4<=e0?e5<e0:e5>e0;e1=e4<=e0?++e5:--e5){this._hide_photo(e1)}}else{for(e1=e2=0,e6=this.num_photos_loaded;0<=e6?e2<e6:e2>e6;e1=0<=e6?++e2:--e2){this._hide_photo(e1)}}$("p-top-"+this.unique_id).setStyle({height:this.get_content_height()+"px"});$("p-bottom-"+this.unique_id).setStyle({height:"0px"});return true}return false};T.prototype._blur_range=function(e3,e0,e5){var e2,e1,e4;if(e5==null){e5=this.timeline.get_viewport_info()}e4=dk.get();if(e4>=0){e1=this.timeline.VIEWPORT_SCALE_OTHER_DIRECTION;e2=this.timeline.VIEWPORT_SCALE_SCROLL_DIRECTION}else{if(e4<0){e1=this.timeline.VIEWPORT_SCALE_SCROLL_DIRECTION;e2=this.timeline.VIEWPORT_SCALE_OTHER_DIRECTION}}e3-=e1*e5.height;e0+=e2*e5.height;return[e3,e0]};T.prototype.get_photo_range_to_render=function(e8,e2){var e6,e1,e5,e7,e4,e0,e3;if(e2==null){e2=true}e0=e8.top;e4=e8.bottom;if(e2){e3=this._blur_range(e0,e4,e8),e0=e3[0],e4=e3[1]}if(!this.in_y_range(e0,e4)){return[null,null]}e7=Math.floor((e0-this.top_offset-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);e6=Math.floor((e4-this.top_offset-this.timeline.HEADER_HEIGHT)/this.timeline.THUMB_SIZE);e1=Math.min(this.photos.length-1,e7*this.timeline.THUMBS_PER_ROW);e5=Math.min(this.photos.length-1,(e6+1)*this.timeline.THUMBS_PER_ROW-1);cz(!isNaN(e5),"Last photo to render should not be NaN.  "+("viewport_data.bottom="+e8.bottom+" ")+("viewport_data.height="+e8.height+" ")+("photos.length="+this.photos.length+" ")+("top_offset="+this.top_offset+" ")+("bottom_row_to_render="+e6+" "),true,["photo_event_nan_limit"]);return[Math.max(0,e1),e5]};T.prototype.get_photo_range_to_render_with_blur=function(e3){var e1,e6,e2,e5,e4,e0;e4=this.get_photo_range_to_render(e3,true),e6=e4[0],e5=e4[1];e0=this.get_photo_range_to_render(e3,false),e1=e0[0],e2=e0[1];return[e6,e1,e2,e5]};T.prototype.get_thumb_indexes_to_load=function(fd){var fk,fa,e8,e7,fh,fj,fg,fi,fe,e4,e2,e1,e0,ff,e6,e5,e3,fc,fb,e9;ff=this.get_photo_range_to_render_with_blur(fd),fa=ff[0],fk=ff[1],e8=ff[2],e7=ff[3];if(fk==null){fh=(function(){e3=[];for(var fl=fa;fa<=e7?fl<=e7:fl>=e7;fa<=e7?fl++:fl--){e3.push(fl)}return e3}).apply(this);if(this.top_offset>fd.bottom){return fh}else{return fh.reverse()}}fi=(function(){fc=[];for(var fl=fk;fk<=e8?fl<=e8:fl>=e8;fk<=e8?fl++:fl--){fc.push(fl)}return fc}).apply(this);fj=[];fg=[];if(fa<fk){fj=(function(){fb=[];for(var fl=e6=fk-1;e6<=fa?fl<=fa:fl>=fa;e6<=fa?fl++:fl--){fb.push(fl)}return fb}).apply(this)}if(e7>e8){fg=(function(){e9=[];for(var fl=e5=e8+1;e5<=e7?fl<=e7:fl>=e7;e5<=e7?fl++:fl--){e9.push(fl)}return e9}).apply(this)}fe=dk.get();if(fe>=0){return fi.concat(fg).concat(fj)}else{return fi.concat(fj).concat(fg)}};T.prototype.log_thumb_load=function(e1,e2){var e4,e0,e3;if(!this.timeline.opts.log_thumb_loading){return}if(this.scroll_count===bG.scroll_count&&!this.logged_thumbs_arrived){if((e1+1)%this.timeline.THUMBS_PER_ROW===0||e1+1===e2){if(this.visible_thumbs_loaded()){e0=this.timeline.get_viewport_info();e4=this.timeline.events.indexOfKey(this.unique_id)===(this.timeline.events.length()-1);if((this.top_offset<e0.bottom&&e0.bottom<this.top_offset+this.get_height())||e4){if(bG.scroll_count<2&&((e3=h.get_current_view())===cc.PHOTOS_VIEW||e3===cc.CAMERA_VIEW)){this.log_timing_event(G.viewport_initial_load);bG.scroll_count+=2}else{this.log_timing_event(G.viewport_loaded)}}return this.logged_thumbs_arrived=true}}}};T.prototype.log_timing_event=function(e3){var e0,e1,e4,e2;e1=bU.time();e0={};if(e3===G.viewport_initial_load){if((typeof performance!=="undefined"&&performance!==null?(e2=performance.timing)!=null?e2.navigationStart:void 0:void 0)!=null){e4=bU.time()-performance.timing.navigationStart;e0={current_view:h.get_current_view()};d3.log_ajax_transition(e4,e3,e0,e3)}return}if(this.timing_stopped_scrolling_on_event===-1){return}if(e3===G.viewport_loaded){e4=e1-this.timing_stopped_scrolling_on_event}return d3.log_ajax_transition(e4,e3,e0,e3)};return T})();var H;H=B.Photo=(function(){T.PLACEHOLDER=0;T.LOADED=1;T.RENDERED=2;T.DISPLAYED=3;T.uniqueness_key;T.item_counter;T.filename;T.ns_id;T.ns_path;T.fq_path;T.href;T.thumbnail_url;T.large_thumbnail_url;T.time_taken;T.display_time_taken;T.preview_type;T.mtime;T.video_streaming_url;T.is_visible;T.user_id;T.event;T.status;T.thumb_html;T.preview_obj;T.duplicates_info;function T(e0){this.event=e0;this.status=T.PLACEHOLDER;this.preview_obj=e0.unique_id}T.prototype.init_metadata=function(e0){this.uniqueness_key=e0.uniqueness_key;this.item_counter=e0.item_counter;this.filename=e0.filename;this.ns_id=e0.ns_id;this.ns_path=e0.ns_path;this.fq_path=e0.path;this.href=e0.href;this.thumbnail_url=e0.thumbnail_url;this.large_thumbnail_url=e0.large_thumbnail_url;this.time_taken=e0.time_taken;this.display_time_taken=e0.display_time_taken;this.preview_type=e0.preview_type;this.mtime=e0.mtime;this.video_streaming_url=e0.video_streaming_url;this.is_visible=e0.is_visible;this.user_id=e0.user_id;this.thumb_html=this.event.timeline.tmpl({photo:this,display_date:this._get_display_date(),shareable:true,Sprite:cm});this.preview_obj=this._get_preview_obj();this.status=T.LOADED;this.event.num_photos_loaded+=1;return this.event.timeline.key_to_photo[this.uniqueness_key]=this};T.prototype.set_duplicates=function(e2){var e1,e3,e0;for(e3=0,e0=e2.length;e3<e0;e3++){e1=e2[e3];e1.fq_path=e1.path}return this.duplicates_info=e2};T.prototype._get_preview_obj=function(){if(!this.event.timeline.opts.uses_lightbox){return}if(this.preview_type==="photo"&&this.large_thumbnail_url){if(bG.in_single_collection_view()){return new eC({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,dl_url:D.parse(this.href).updateQuery({dl:1}).toString(),original_url:this.href,display_time:this.display_time_taken,photo:this})}else{return new dc({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,dl_url:D.parse(this.href).updateQuery({dl:1}).toString(),original_url:this.href,display_time:this.display_time_taken,photo:this})}}else{if(this.preview_type==="video"&&this.large_thumbnail_url&&!Constants.DISABLE_VIDEOS_IN_LIGHTBOX){if(bG.in_single_collection_view()){return new ao({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,preview_url:this.video_streaming_url,dl_url:D.parse(this.href).updateQuery({dl:1}).toString(),display_time:this.display_time_taken,photo:this})}else{return new eJ({filename:this.filename,fq_path:this.fq_path,thumbnail_url_tmpl:this.large_thumbnail_url,preview_url:this.video_streaming_url,dl_url:D.parse(this.href).updateQuery({dl:1}).toString(),display_time:this.display_time_taken,photo:this})}}}return null};T.prototype._get_display_date=function(){var e0;if(this.time_taken!=null){e0=new Date(this.time_taken);return bU.nice_date_with_month_name(e0,e0.getUTCFullYear()<new Date().getFullYear(),true)}else{return""}};return T})();var Z;Z=B.PhotoCollection=(function(){T.CREATE_EVT="db:photocollection:create";T.ADD_EVT="db:photocollection:add";T.REMOVE_EVT="db:photocollection:remove";T.UNDO_REMOVE_EVT="db:photocollection:undo_remove";T.RENAME_EVT="db:photocollection:rename";T.DELETE_EVT="db:photocollection:delete";T.SHARE_EVT="db:photocollection:share";T.UNSHARE_EVT="db:photocollection:unshare";T.COVER_CHANGE_EVT="db:photocollection:cover_change";T.gid;T.name;T.num_items;T.num_photos;T.num_videos;T.thumbnail_url_32;T.thumbnail_url_256;T.is_anonymous;T.share_tkey;T.shmodel_url;T.short_url;T.is_creator;T.member_fnames;function T(e1,e0){if(e0==null){e0=true}cz((e1.gid!=null)&&(e1.url!=null)&&(e1.name!=null)&&(e1.num_items!=null)&&(e1.num_photos!=null)&&(e1.num_videos!=null),"missing required PhotoCollection params");this.gid=e1.gid;this.url=e1.url;this.name=e1.name;this.num_items=e1.num_items;this.num_photos=e1.num_photos;this.num_videos=e1.num_videos;this.thumbnail_url_32=e1.thumbnail_url_32||null;this.thumbnail_url_256=e1.thumbnail_url_256||null;this.is_anonymous=e1.is_anonymous!=null?e1.is_anonymous:false;this.share_tkey=e1.share_tkey||null;this.shmodel_url=e1.shmodel_url||null;this.short_url=e1.short_url||null;this.is_creator=e1.is_creator!=null?e1.is_creator:true;this.member_fnames=e1.member_fnames||[el("You")];if(e0){document.fire(T.CREATE_EVT,{collection:this})}}T.prototype.add_photos=function(e6,e5,e2,e4){var e0,e3,e1;if(e5==null){e5=null}if(e2==null){e2=false}if(e4==null){e4=true}e0=(function(){var e9,e8,e7;e7=[];for(e9=0,e8=e6.length;e9<e8;e9++){e1=e6[e9];e7.push(e1.item_counter)}return e7})();cz(e0.length,"Have to add at least one photo");e3={collection_gid:this.gid,item_counters:JSON.stringify(e0)};if(e5!=null){e3.source_collection_gid=e5}return new Ajax.DBRequest("/collection_add",{parameters:e3,job:e2,job_user:cB.get_viewer().photos_user,progress_text:el("Adding to album..."),onSuccess:(function(e7){return function(fa){var e8,fb,e9,fc;fc=JSON.parse(fa.responseText);e7.thumbnail_url_32=fc.thumbnail_url_32;e7.thumbnail_url_256=fc.thumbnail_url_256;fb=fc.new_num_photos-e7.num_photos;e9=fc.new_num_videos-e7.num_videos;e8=fc.new_num_items-e7.num_items;e7.num_photos=fc.new_num_photos;e7.num_videos=fc.new_num_videos;e7.num_items=fc.new_num_items;return document.fire(T.ADD_EVT,{collection:e7,photos:e6,num_items_added:e8,num_photos_added:fb,num_videos_added:e9,promote_collection:e4})}})(this)})};T.prototype.remove_photos=function(e3,e2){var e0,e1;if(e2==null){e2=false}e0=(function(){var e6,e5,e4;e4=[];for(e6=0,e5=e3.length;e6<e5;e6++){e1=e3[e6];e4.push(e1.item_counter)}return e4})();return new Ajax.DBRequest("/collection_remove",{parameters:{collection_gid:this.gid,item_counters:JSON.stringify(e0),is_shared:this.share_tkey!=null,num_items:this.num_items},job:e2,job_user:cB.get_viewer().photos_user,progress_text:el("Removing from album..."),onSuccess:(function(e4){return function(e5){var e6;e6=JSON.parse(e5.responseText);e4.thumbnail_url_32=e6.thumbnail_url_32;e4.thumbnail_url_256=e6.thumbnail_url_256;e4.num_photos=e6.new_num_photos;e4.num_videos=e6.new_num_videos;e4.num_items=e6.new_num_items;return document.fire(T.REMOVE_EVT,{collection:e4,photos:e3,undo_changeset:e6.undo_changeset})}})(this)})};T.prototype.undo_remove=function(e0){return new Ajax.DBRequest("/photos_undo_remove",{parameters:{collection_gid:this.gid,changeset:e0},html_in_error_msg:true,progress_text:el("Undoing..."),onSuccess:(function(e1){return function(){return document.fire(T.UNDO_REMOVE_EVT,{collection:e1})}})(this)})};T.prototype.rename=function(e1){var e0;bG.enable_selection();e0=new Ajax.InPlaceEditor(e1,"/collection_rename",{htmlResponse:false,okControl:false,cancelControl:false,highlightColor:"transparent",highlightEndColor:"transparent",clickToEditText:"",cols:11,ajaxClass:Ajax.DBRequest,submitOnBlur:true,initialText:this.name,cancelIfSame:true,clickToEdit:false,onComplete:function(){return bv("#single-collection-title-container").removeClass("editing")},onFailure:function(){},savingText:el("Saving..."),onLeaveEditMode:bG.disable_selection,onLeaveHover:function(){},ajaxOptions:{method:"POST",onSuccess:(function(e2){return function(e3){e2.name=e3.responseText;return document.fire(T.RENAME_EVT,{collection:e2})}})(this)},callback:(function(e2){return function(e3,e4){return{collection_gid:e2.gid,new_collection_name:e4,is_shared:e2.share_tkey!=null}}})(this)});return e0.enterEditMode()};T.prototype["delete"]=function(){if(this.share_tkey!=null){new Ajax.DBRequest("/sm/disable/"+this.share_tkey,{subject_user:cB.get_viewer().photos_user})}return new Ajax.DBRequest("/collection_delete",{parameters:{collection_gid:this.gid,is_shared:this.share_tkey!=null,num_items:this.num_items},subject_user:cB.get_viewer().photos_user,onSuccess:(function(e0){return function(){return document.fire(T.DELETE_EVT,{collection:e0})}})(this)})};T.prototype.attach_to_token=function(e2,e4,e1,e3,e0){return new Ajax.DBRequest("/collection_attach_to_dummy_token",{parameters:{tkey:e2,collection_gid:this.gid,num_items:this.num_items},onSuccess:(function(e5){return function(){e5.share_tkey=e2;e5.shmodel_url=e4;e5.short_url=e1;if(typeof e3==="function"){e3()}return document.fire(T.SHARE_EVT,{collection:e5})}})(this),onFailure:function(){return typeof e0==="function"?e0():void 0}})};T.prototype.send_link=function(e1,e3,e7,e2,e6,e0){var e5,e4;e5=(function(e8){return function(){e8.share_tkey=e3;e8.shmodel_url=e7;e8.short_url=e2;if(typeof e6==="function"){e6()}return document.fire(T.SHARE_EVT,{collection:e8})}})(this);e4={collection_gid:this.gid,share_tkey:e3,num_items:this.num_items};return bJ.ajax_submit(e1,"/collection_share",e5,e0,e1.down(".tokenizer-submit-button"),e4)};T.prototype.unshare=function(){cz(this.share_tkey!=null,"Can't unshare collection "+this.gid+" without a tkey");return new Ajax.DBRequest("/sm/disable/"+this.share_tkey,{onSuccess:(function(e0){return function(){e0.share_tkey=null;e0.shmodel_url=null;e0.short_url=null;return document.fire(T.UNSHARE_EVT,{collection:e0})}})(this),subject_user:cB.get_viewer().photos_user})};T.prototype.set_cover=function(e0){return new Ajax.DBRequest("/collection_set_cover",{parameters:{collection_gid:this.gid,item_counter:e0.item_counter},onSuccess:(function(e1){return function(e2){var e3;e3=JSON.parse(e2.responseText);e1.thumbnail_url_32=e3.thumbnail_url_32;e1.thumbnail_url_256=e3.thumbnail_url_256;return document.fire(T.COVER_CHANGE_EVT,{collection:e1})}})(this)})};return T})();var bV,k;bV=__PARENT_SCOPE__.FilePreview=INLINE_JS.FilePreview=B.FilePreview={PARTIAL_TEXT_LENGTH_THRESHOLD:64*1024,init_pdf:function(e4,e3,e1,T){var e0,e2;this._pdfLink=T;this.iframe_src=e3;this._log_pdf_render_time(e4);if(e4==="pdf-native"||e4==="pdf-embedded"||e4==="pdf-js"){window.addEventListener("message",k,false);bv((function(e5){return function(){var e8,e7,e6;e6=D.parse(e3);e8=bv("#pdf-embed-container");if(e8.attr("data-docpreview-annotation-marker-enabled")==="True"){e6=e6.updateQuery("annotation_marker","1")}if(e8.attr("data-docpreview-annotation-highlight-enabled")==="True"){e6=e6.updateQuery("annotation_highlight","1")}e7=bv("#pdf-embed-iframe");e7.attr("src",String(e6));e7.attr("type","application/pdf");e7.attr("allowfullscreen","");bv("html, body").addClass("full_height");return e5._fire_pdf_render_event()}})(this));this.preview_status=e1;if(bR.chrome){e2=function(){var e5;e5=bv('link[rel="shortcut icon"]').remove();return bv("head").append(e5)};setTimeout(e2,1000)}e0=$$("#pdf-embed-container iframe");return window.setTimeout(((function(e5){return function(){return e0.invoke("setStyle",{visibility:"visible"})}})(this)),200)}},init_excel:function(T){window.addEventListener("message",k,false);return bv("#pdf-embed-iframe").attr("src",T)},excel_preview_unsupported:function(){return this.preview_failed()},init_font:function(){return bv((function(T){return function(){if(!$(document.documentElement).hasClassName("fontface")||$(document.body).hasClassName("gecko")){return $(document.body).removeClassName("file-preview-body")}}})(this))},init_photo:function(e2,e6,e4){var e8,e3,e7,e5,e1,T,e0;$("preview-img").observe("error",this.preview_failed.bind(this));if((e5=window.performance)!=null?(e1=e5.timing)!=null?e1.navigationStart:void 0:void 0){$("preview-img").observe("load",function(){var e9;e9=bU.time()-window.performance.timing.navigationStart;return d3.log_ajax_transition(e9,"file-preview-photo")})}$("full-img").src=e2;T=$$("#preview-img, #full-img");e0=[];for(e3=0,e7=T.length;e3<e7;e3++){e8=T[e3];e8.setAttribute("data-original-href",e6);e8.setAttribute("enable-download",e4);e0.push(e8.on("contextmenu","img",bg.show_shmodel.bind(bg)))}return e0},init_htmlified:function(){if(window.htmlified_height){this.htmlified_loaded();return}if(!window.postMessage){this.preview_failed();return}return setTimeout(((function(T){return function(){if(!window.htmlified_height){return T.preview_failed()}}})(this)),10000)},htmlified_loaded:function(){var T;if((T=$("htmlified-loading"))!=null){T.remove()}if(bv("#htmlified-wrapper[data-docpreview-ui-rams-enabled='True'] iframe, code-wrapper[data-docpreview-ui-rams-enabled='True'] iframe").length===0){$("htmlified").style.height=window.htmlified_height+"px"}return $("htmlified").style.visibility=""},init_video:function(e3,e5,e0,e2,T,e1,e4){return bv((function(e6){return function(){var e9,e7,e8;e8=e4.width()*0.9;e7=e8*0.55;e9=e6._video_preview_failed;if(e2==="hls"){e6.player=bm.embed("#video",{src:e0,type:"application/vnd.apple.mpegurl",width:e8,height:e7,controls:true,poster:T,onError:e9,onReady:e6._player_ready,metadata_link:e1})}else{bv("#video").empty();if(e3){if(e5){e6.player=bm.embed("#video",{src:e0,type:"video/mp4",width:e8,height:e7,controls:true,poster:T,onError:e9,onReady:e6._player_ready,metadata_link:e1})}else{e9()}}else{e6.player=bm.embed("#video",{src:e0,type:"video/flv",width:e8,height:e7,controls:true,poster:T,onError:e9,onReady:e6._player_ready,metadata_link:e1})}}bv(".vjs-poster").hide();bv(".vjs-big-play-button").hide();e6.player.on("play",e6._onPlay);return e6.player.on("ended",e6._onEnded)}})(this))},photo_loaded:function(e1){var e0,T;if((e0=window.performance)!=null?(T=e0.timing)!=null?T.navigationStart:void 0:void 0){e1=e1-window.performance.timing.navigationStart;return d3.log_ajax_transition(e1,"file-preview-photo")}},switch_preview:function(e0,e3,e6){var e5,e4,e2,e1,T;e2=INLINE_JS.URI.parse(this.iframe_src);T=INLINE_JS.URI.parse(e2.getQuery().file);e1=T.updateQuery({revision_id:e0}).toString();e4=D.parse(this.iframe_src).updateQuery({file:e1});if(e3){e4.updateQuery({annotation_marker:"1"})}else{e4.removeQuery("annotation_marker")}e5=bv("#pdf-embed-iframe");e5.attr("src",e4.toString());e5.on("load",e6);return this._fire_pdf_render_event()},_player_ready:function(){var T;T=function(){bv(".vjs-poster").show();bv(".vjs-big-play-button").show();return bv(".vjs-big-play-button").focus()};return T.defer()},_onPlay:function(){bv(".vjs-poster").hide();return bv(".vjs-big-play-button").hide()},_onEnded:function(){bv(".vjs-poster").show();bv(".vjs-big-play-button").show();return bv(".vjs-loading-spinner").hide()},_video_preview_failed:function(T){if(T==="needflash"){bv("#video-preview-flash-message").show()}return bV.preview_failed()},preview_failed:function(){var T;T=bv(document.body);if(T.hasClass("shmodel-body")){T.removeClass("file-preview-body")}ab.error(el("Preview failed."));return bv(document).trigger("preview_failed")},_fire_pdf_render_event:function(){var T;if(document.createEvent&&window.dispatchEvent){T=document.createEvent("UIEvents");T.initUIEvent("pagerender",false,false,window,0);return window.dispatchEvent(T)}},_log_pdf_render_time:function(e0){var T;T=function(e4){var e2,e3,e1;if((e3=window.performance)!=null?(e1=e3.timing)!=null?e1.navigationStart:void 0:void 0){e2=bU.time()-window.performance.timing.navigationStart;return d3.log_ajax_transition(e2,e4)}};Event.observe(window,"pagerender",function(){Event.stopObserving(window,"pagerender");return T(e0)});return Event.observe(window,"parsecomplete",function(){Event.stopObserving(window,"parsecomplete");return T(""+e0+"-parse")})},_getEmbedContainer:function(){var T;T=bv("#pdf-embed-container, #html-container, #htmlified-wrapper, #code-wrapper");if(T.length!==1){T=[]}return T},nativePdfPrint:function(){var T,e1,e0;if(!bv("body").hasClass("file-preview-body")||bv("#pdf-embed-iframe").length!==1||(this._pdfLink==null)){return false}e0=D.parse(bR.get_href());e0.setQuery({preview:1,force_no_progressive:1});T=D.parse(this._pdfLink).getAuthority();e1=bL.getNativePrintUrl(e0.toString(),T,bv("#pdf-embed-container"));if(e1==null){return false}window.open(e1,"_blank");return true},enter_rams_fullscreen:function(){return bL.enter_rams_fullscreen(bv(this._getEmbedContainer()))},exit_rams_fullscreen:function(){return bL.exit_rams_fullscreen(bv(this._getEmbedContainer()))},is_rams_fullscreen_active:function(){return bL.is_rams_fullscreen_active(bv(this._getEmbedContainer()))}};k=function(e3){var e2,e0,e1,T;e0={"https://dl-doc.dropbox.com":true,"https://dl.dropbox.com":true};e0["https://"+Constants.DL_DOC_USER_CONTENT_DOMAIN]=true;e0["https://"+Constants.PUBSERVER]=true;e0[Constants.WEB_STATIC_DROPBOX]=true;if(e0[e3.origin]){e1={};try{e1=JSON.parse(e3.data);e2=e1.action}catch(e4){T=e4;e2=e3.data}switch(e2){case"failed":return bV.preview_failed()}}};var d0;Effect.BlindFadeUp=function(e2,e1){var e0,T;e0=new Effect.BlindUp(e2,e1);T=new Effect.Fade(e2,e1);this.cancel=function(){e0.cancel();return T.cancel()}};Effect.BlindFadeDown=function(e2,e1){var e0,T;e0=new Effect.BlindDown(e2,e1);T=new Effect.Appear(e2,e1);this.cancel=function(){e0.cancel();return T.cancel()}};Effect.Flash=function(e1,e0,T){cz(e0.startcolor&&e0.endcolor,"Start and end colors must be specified");cz(e0.cycles,"Fade cycles must be specified");T=T||0;return new Effect.Highlight(e1,{duration:1,startcolor:e0.startcolor,endcolor:e0.endcolor,restorecolor:e0.endcolor,afterFinish:function(){return new Effect.Highlight(e1,{duration:1,startcolor:e0.endcolor,endcolor:e0.startcolor,restorecolor:e0.startcolor,afterFinish:function(){if(T<e0.cycles){return Effect.Flash(e1,e0,T+1)}}})}})};Effect.ScaleComprehensive=Class.create(Effect.Scale,{setup:function(){var ff,fd,fl,e9,fe,fg,fa,fb,e6,e3,e1,e0,fm,fr,fp,fn,fk,fj,fi,fh,T,fs,fq,fo,fc,e8,e7,e5,e2,e4;this.restoreAfterFinish=this.options.restoreAfterFinish||false;this.elementPositioning=this.element.getStyle("position");this.originalStyle={};fc=["top","left","width","height","fontSize"];for(e6=0,fm=fc.length;e6<fm;e6++){fg=fc[e6];this.originalStyle[fg]=this.element.style[fg]}this.originalTop=this.element.offsetTop;this.originalLeft=this.element.offsetLeft;e9=this.element.getStyle("font-size")||"100%";e8=["em","px","%","pt"];for(e3=0,fr=e8.length;e3<fr;e3++){fe=e8[e3];if(e9.indexOf(fe)>0){this.fontSize=parseFloat(e9);this.fontSizeType=fe}}this.factor=(this.options.scaleTo-this.options.scaleFrom)/100;if(this.options.scaleMode==="box"){this.dims={height:this.element.offsetHeight,width:this.element.offsetWidth}}if(/^content/.test(this.options.scaleMode)){this.dims={height:this.element.scrollHeight,width:this.element.scrollWidth}}if(!this.dims){this.dims={height:this.options.scaleMode.originalHeight,width:this.options.scaleMode.originalWidth}}this.full_height=this.dims.height;this.full_width=this.dims.width;fd=["border%sWidth","margin%s","padding%s"];for(e1=0,fp=fd.length;e1<fp;e1++){fa=fd[e1];e7=["Top","Bottom","Left","Right"];for(e0=0,fn=e7.length;e0<fn;e0++){fl=e7[e0];fb=fa.format(fl);this.dims[fb]=parseFloat(this.element.getStyle(fb));if(fl==="Top"||fl==="Bottom"){this.full_height+=this.dims[fb]}else{this.full_width+=this.dims[fb]}}}this.attrs_vertical=[];this.attrs_horizontal=[];if(this.options.scaleX){for(T=0,fk=fd.length;T<fk;T++){ff=fd[T];this.attrs_horizontal.push(ff.format("Left"))}this.attrs_horizontal.push("width");e5=fd.reverse();for(fs=0,fj=e5.length;fs<fj;fs++){ff=e5[fs];this.attrs_horizontal.push(ff.format("Right"))}}if(this.options.scaleY){for(fq=0,fi=fd.length;fq<fi;fq++){ff=fd[fq];this.attrs_vertical.push(ff.format("Top"))}this.attrs_vertical.push("height");e2=fd.reverse();e4=[];for(fo=0,fh=e2.length;fo<fh;fo++){ff=e2[fo];e4.push(this.attrs_vertical.push(ff.format("Bottom")))}return e4}},update:function(T){var e0;e0=(this.options.scaleFrom/100)+(this.factor*T);e0=(-0.5+1/(1+Math.exp((0.5-e0)*7)))*1.055+0.5;if(this.options.scaleContent&&this.fontSize){this.element.setStyle({fontSize:this.fontSize*e0+this.fontSizeType})}return this.setDimensions(e0)},setDimensions:function(e3){var e8,fb,e9,e6,e7,e0,e4,e2,fa,T,e5,e1;e9={};e5=[[this.full_width,this.attrs_horizontal],[this.full_height,this.attrs_vertical]];for(e4=0,fa=e5.length;e4<fa;e4++){e1=e5[e4],e6=e1[0],fb=e1[1];e7=e6*e3;for(e2=0,T=fb.length;e2<T;e2++){e8=fb[e2];e0=this.dims[e8];if(e0<e7){e9[e8]=e0+"px";e7-=e0}else{e9[e8]=e7.round()+"px";e7=0}}}return this.element.setStyle(e9)}});Effect.BlindUpComprehensive=function(T){T=$(T);T.makeClipping();return new Effect.ScaleComprehensive(T,0,Object.extend({scaleContent:false,scaleX:false,restoreAfterFinish:true,afterFinishInternal:function(e0){return e0.element.hide().undoClipping()}},arguments[1]||{}))};Effect.BlindDownComprehensive=function(e0){var T;e0=$(e0);T=e0.getDimensions();return new Effect.ScaleComprehensive(e0,100,Object.extend({scaleContent:false,scaleX:false,scaleFrom:0,scaleMode:{originalHeight:T.height,originalWidth:T.width},restoreAfterFinish:true,afterSetup:function(e1){return e1.element.makeClipping().setStyle({height:"0px"}).show()},afterFinishInternal:function(e1){return e1.element.undoClipping()}},arguments[1]||{}))};Effect.HighlightForcedWithAlpha=Class.create(Effect.Highlight,{setup:function(){var e7,e5,e1,e4,e6,e2,e8,e3,e0,T;this.oldStyle={};if(!this.options.keepBackgroundImage){this.oldStyle.backgroundImage=this.element.getStyle("background-image");this.element.setStyle({backgroundImage:"none"})}if(!this.options.endcolor){this.options.endcolor=this.element.getStyle("background-color")}if(!this.options.restorecolor){this.options.restorecolor=this.element.getStyle("background-color")}this._supports_alpha=false;try{e5=new Element("div");e6="rgba(1, 1, 1, 0)";e5.setStyle({backgroundColor:e6});this._supports_alpha=(e5.getStyle("background-color"))===e6}catch(e9){}this._base=d0(this.options.startcolor);if((e3=this.options.endcolor)==="transparent"||e3==="rgba(0, 0, 0, 0)"){if(this._supports_alpha){e1=this._base.slice(0);e1[3]=0}else{e1=[255,255,255,1]}}else{e1=d0(this.options.endcolor)}this._delta=[];e0=this._base;T=[];for(e4=e2=0,e8=e0.length;e2<e8;e4=++e2){e7=e0[e4];T.push(this._delta.push(e1[e4]-e7))}return T},update:function(T){var e6,e1,e5,e2,e4,e0,e3;e5=[];e3=this._base;for(e2=e4=0,e0=e3.length;e4<e0;e2=++e4){e6=e3[e2];e1=e6+this._delta[e2]*T;if(!(e2>2)){e1=Math.round(e1)}e5.push(e1)}if(this._supports_alpha){return this.element.setStyle({backgroundColor:"rgba("+(e5.join(", "))+")"})}else{return this.element.setStyle({backgroundColor:"rgb("+(e5.slice(0,3).join(", "))+")"})}}});d0=function(e1){var e2,e5,e4,e3,T,e0,e6,e8,e7;e0=/^rgb\((\d{1,3}), ?(\d{1,3}), ?(\d{1,3})\)$/;T=/^rgba\((\d{1,3}), ?(\d{1,3}), ?(\d{1,3}), ?(\d+?\.?\d*)\)$/;e3=/^#([0-9A-F])([0-9A-F])([0-9A-F])$/i;e5=/^#([0-9A-F])([0-9A-F])([0-9A-F])([0-9A-F])$/i;e4=/^#([0-9A-F][0-9A-F])([0-9A-F][0-9A-F])([0-9A-F][0-9A-F])$/i;e2=/^#([0-9A-F][0-9A-F])([0-9A-F][0-9A-F])([0-9A-F][0-9A-F])([0-9A-F][0-9A-F])$/i;if(e8=e1.match(e0)){e7=(function(){var fc,fa,fb,e9;fb=e8.slice(1);e9=[];for(fc=0,fa=fb.length;fc<fa;fc++){e1=fb[fc];e9.push(parseInt(e1,10))}return e9})()}else{if(e8=e1.match(T)){e7=(function(){var fc,fa,fb,e9;fb=e8.slice(1,4);e9=[];for(fc=0,fa=fb.length;fc<fa;fc++){e1=fb[fc];e9.push(parseInt(e1,10))}return e9})();e7[3]=parseFloat(e8[4])}else{if(e8=e1.match(e3)){e7=(function(){var fc,fa,fb,e9;fb=e8.slice(1);e9=[];for(fc=0,fa=fb.length;fc<fa;fc++){e1=fb[fc];e9.push(parseInt(e1+e1,16))}return e9})()}else{if(e8=e1.match(e5)){e7=(function(){var fc,fa,fb,e9;fb=e8.slice(1);e9=[];for(fc=0,fa=fb.length;fc<fa;fc++){e1=fb[fc];e9.push(parseInt(e1+e1,16))}return e9})()}else{if(e8=e1.match(e4)){e7=(function(){var fc,fa,fb,e9;fb=e8.slice(1);e9=[];for(fc=0,fa=fb.length;fc<fa;fc++){e1=fb[fc];e9.push(parseInt(e1,16))}return e9})()}else{if(e8=e1.match(e2)){e7=(function(){var fc,fa,fb,e9;fb=e8.slice(1);e9=[];for(fc=0,fa=fb.length;fc<fa;fc++){e1=fb[fc];e9.push(parseInt(e1,16))}return e9})()}}}}}}e7=e7||[255,255,255,1];e6=e7.length;if(e6===3){e7.push(1)}else{if(e6===4&&e7[e6-1]>1){e7[e6-1]=e7[e6-1]/255}}return e7};var ay;ay=B.ClientDownload=(function(){function T(){}T.prototype.show_download_modal=function(){return new Ajax.DBRequest("/download_modal_view",{onSuccess:function(e0){var e1;e1=bv("<div",{"class":"brodal-header",text:el("Install Dropbox")});return eS.show(e1[0],$("client-download"),{},false,450)},subject_user:ci.active_user})};return T})();var co,d8,h,G,a1,cY,cc;co=B.AlbumsLogger={log_share:function(e0,e3,e2,e1,T){return co.log(e0,e3,true,e2,e1,T)},log_event:function(T,e2,e1,e0){return co.log(T,e2,false,e1,e0)},log:function(e0,e5,e2,e4,e3,T){var e1;e1={evt:e0,collection_gid:e5,is_anonymous:e3};if(e2!=null){e1.share_event=e2}if(e4!=null){e1.num_items=e4}if(T!=null){e1.on_create=T}return new Ajax.DBRequest("/collection_log",{method:"post",noAutonotify:true,parameters:e1})}};d8=INLINE_JS.PhotosEvents=B.PhotosEvents={CLEAR_SELECTED:"clear_selected",SHARE:"share",SHARE_ALBUM:"share_album",GO_TO_ALBUM_LINK:"go_to_album_link",UNSHARE_ALBUM:"unshare_album",ADD_TO_NEW_ALBUM:"add_to_new_album",ADD_TO_RECENT_ALBUM:"add_to_recent_album",ADD_TO_OTHER_ALBUM:"add_to_other_album",SHOW_IN_FOLDER:"show_in_folder",DELETE:"delete",DELETE_ALBUM:"delete_album",REMOVE:"remove",SET_AS_COVER:"set_as_cover",RENAME_ALBUM:"rename_album",OPEN_LIGHTBOX:"open_lightbox",MARQUEE_SELECT:"marquee_select",SEND:"send",GET_LINK:"get_link",FB_SHARE:"fb_share",TWITTER_SHARE:"twitter_share"};a1=INLINE_JS.PhotosTourEvents=B.PhotosTourEvents={SKIP:"skip",AWESOME:"awesome",EXIT_MODAL:"exit_modal",SHOW_MODAL:"show_modal"};cY=INLINE_JS.PhotosTriggers=B.PhotosTriggers={SAH:"selected_actions_header",PCM:"photos_context_menu",CCM:"collections_context_menu",SCA:"single_collection_action",CLICK:"click",DBL_CLICK:"double_click",DRAG:"drag",ESC:"escape",CLICK_TITLE:"click_title",LIGHTBOX:"lightbox",DROP_TARGET:"drop_target",FOSHMODAL:"foshmodal"};cc=B.PhotosViews={PHOTOS_VIEW:"photos_view",CAMERA_VIEW:"camera_view",ALBUMS_VIEW:"albums_view",SINGLE_COLLECTION_VIEW:"single_collection_view",NOT_PHOTOS:"not_photos",MISSING_TIMESTAMPS_VIEW:"missing_timestamps_view"};h=INLINE_JS.PhotosLogger=B.PhotosLogger={last_logged_error_msg:null,last_error_msg_url:null,get_current_view:function(){var T,e1,e0;T=((e0=$("modal"))!=null?e0.visible():void 0)&&$("shmodal").visible();e1=T?"-foshmodal":"";if(bG.in_single_collection_view()){return cc.SINGLE_COLLECTION_VIEW+e1}else{if(bG.in_all_collections_view()){return cc.ALBUMS_VIEW+e1}else{if(bG.initialized){return cc.PHOTOS_VIEW+e1}else{return cc.NOT_PHOTOS}}}},log_interaction:function(T,e0,e1){return h.log(T,e0,null,h.get_current_view(),e1)},log_transition_to:function(T){return h.log(T,null,null,h.get_current_view(),null,true)},log:function(e0,e1,T,e5,e3,e4){var e2;e2={evt:e0,trigger:e1,view:T};if(e3!=null){e2.data=JSON.stringify(e3)}if(e5!=null){e2.start_view=e5}if(e4!=null){e2.transition=true}return new Ajax.DBRequest("/photos_log",{method:"post",noAutonotify:true,parameters:e2})}};G=B.PhotosTimingEvents={viewport_loaded:"viewport_loaded",viewport_initial_load:"viewport_initial_load"};var dw,aI;aI=B.ShmodelLogger={CLICK_SIGN_IN:"click_sign_in",CLICK_ADD_TO_MY_DROPBOX:"click_add_to_my_dropbox",REMOVE_LINK:"remove_link",CLICK_FILENAME:"click_filename",CLICK_DOWNLOAD:"click_download",LOGIN_THRU_DEFAULT_DROPDOWN:"login_thru_default_dropdown",CLICK_SIGNUP_THRU_DEFAULT_DROPDOWN:"click_signup_thru_default_dropdown",CLICK_SHARE:"click_share",log:function(T){return new Ajax.DBRequest("/shmlog",{method:"post",noAutonotify:true,parameters:{evt:T,url:window.location.href}})},attachLogListener:function(T,e0){if(e0==null){return}return e0.observe("click",function(e1){aI.log(T);if(e0.href&&e0.href!=="#"&&e0.target!=="_blank"){Event.stop(e1);return(function(){return window.location.href=e0.href}).defer()}})}};dw=B.RegistrationLogger={log:function(T){var e0;e0=window.location.href;return new Ajax.DBRequest("/share/reglog",{method:"post",noAutonotify:true,parameters:{evt:T,url:e0}})},attachLogListener:function(T,e0){if(e0==null){return}return e0.observe("click",function(e1){dw.log(T);if(e0.href&&e0.href!=="#"&&e0.target!=="_blank"){Event.stop(e1);return(function(){return window.location.href=e0.href}).defer()}})}};var e;e=B.ModalFlow=(function(){function T(e8,e6,fa,e2,e1,e5,e9){var e0,e3,e7,e4;this.title=e8;this.icon=e6;this.states=fa;this.next_state_table=e2;this.previous_state_table=e1;this.initial=e5;this.onStart=e9;this._state_map={};e4=this.states;for(e3=0,e7=e4.length;e3<e7;e3++){e0=e4[e3];this._state_map[e0.name]=e0}this.state=null;this._exit_listeners=[];this._cleanup_queue=[]}T.prototype.start=function(){var e3,e2,e0,e1;this.vars={};e1=this.states;for(e2=0,e0=e1.length;e2<e0;e2++){e3=e1[e2];e3.next=this._next.bind(this,e3);e3.back=this._back.bind(this,e3);if(e3.onSubmit){e3.onSubmitFn=(function(e4,e5){e4.onSubmit(this,e4,e5);return false}).bind(this,e3)}else{e3.onSubmitFn=((function(e4){return function(e5,e6){e5.next();return false}})(this)).bind(this,e3)}e3.contents.on("submit",e3.onSubmitFn);e3.contents.find(".backbutton").on("click",e3.back)}eS.onHide=this._onExit.bind(this);if(this.onStart){this.onStart()}this.to_state(this.initial);return false};T.prototype.to_state=function(e1){var e0;this.state=this._state_map[e1];e0=this.title;if(this.state.title!=null){e0=this.state.title}eS.show(e0,this.state.contents[0]);return this.state.enter(this)};T.prototype._next=function(e0){var e1;if(e0===this.state){e1=this.next_state_table[this.state.name](this);if(e1==="__exit__"){return this.exit()}else{return this.to_state(e1)}}};T.prototype._back=function(e0){var e1;if(e0===this.state){e1=this.previous_state_table[this.state.name](this);if(e1==="__cancel__"){return this.exit()}else{if(e1){return this.to_state(e1)}}}};T.prototype.exit=function(){return this._onExit()};T.prototype._onExit=function(e7){var e2,e0,e5,e4,e8,e1,e6,e3;e6=this.states;for(e5=0,e8=e6.length;e5<e8;e5++){e0=e6[e5];e0.contents.off("submit",e0.onSubmitFn)}this._cleanUpExitListeners();e3=this._exit_listeners;for(e4=0,e1=e3.length;e4<e1;e4++){e2=e3[e4];e2(e7)}eS.onHide=null;return eS.hide()};T.prototype.addExitListener=function(e0){return this._exit_listeners.push(e0)};T.prototype.removeExitListener=function(e0){return this._cleanup_queue.push(e0)};T.prototype._cleanUpExitListeners=function(){var e3,e2,e5,e1,e4,e0;e4=this._cleanup_queue;e0=[];for(e5=0,e1=e4.length;e5<e1;e5++){e3=e4[e5];e2=this._exit_listeners.indexOf(e3);e0.push(this._exit_listeners.splice(e2,1))}return e0};return T})();var cu;cu=B.TwoFactorAuth={_checkpoint_token:null,_email:null,_container_selector:null,_error_selector:null,_is_offline_setup:null,_invalid_code_count:null,_current_flow:null,set_user:function(T){this._user=cB.get_viewer().get_user_by_id(T);cz(this._user,""+T+" is invalid");return bv("#twofactor-enter-password .email-placeholder").text(this._user.email)},login_init:function(){this._container_selector="#twofactor-confirm";this._error_selector="#twofactor-confirm .error-message";return this.login_listen()},login_listen:function(){bv("#resend-link").on("click",this.resend_phone_code.bind(this));return bv("#code").focus()},init:function(e0,T){this._container_selector=".twofactor-account-form";this._error_selector=".twofactor-account-form .error-message";this.account_listen();dQ.async_load_script(e0);return dQ.async_load_script(T)},account_listen:function(){var e7,e4,T,e1,e2,e3,fa,e5,fb,e0,e9,e6,e8;e9={name:"delivery_choice",enter:(function(fc){return function(fd){var fe;fc.hide_error();fe=0;bv(".delivery-choice").each(function(){var ff;ff=bv(this).height();return fe=Math.max(ff,fe)});bv(".delivery-choice").height(fe);return bv(".delivery-choice.selected > input").prop("checked",true)}})(this),contents:bv("#twofactor-delivery-choice"),onSubmit:(function(fc){return function(fd,fe,ff){fd.vars.sms=!!(bv("#use-sms")[0].getValue()==="on");if(!fd.vars.sms){return fc.fetch_offline_key(fd,fe)}else{return fe.next()}}})(this)};e6={name:"enter_phone_number",enter:(function(fc){return function(fe){var ff,fd;fc.hide_error();fc._is_offline_setup=false;fc._phone_number=null;ff=$("twofactor-enter-phone");fd=fc.fill_phone_number_for_edit(ff,bv("#twofactor-row-"+fc._user.role+" #twofactor-sms-number").text());return fd.focus()}})(this),contents:bv("#twofactor-enter-phone"),onSubmit:this.submit_phone_number.bind(this)};e8={name:"offline_setup",enter:(function(fc){return function(fd){fc.hide_error();fc._is_offline_setup=true;return fc._phone_number=null}})(this),contents:bv("#twofactor-offline-setup")};e0={name:"confirm_phone",enter:(function(fc){return function(fd){var fe;fc._invalid_code_count=0;if(fc._is_offline_setup){$("twofactor-enable-confirm").addClassName("offline")}else{fe=fd.vars.phone_number;cz(fe,"expected a display_phone argument");$("phone-number-placeholder").__date(fe);$("twofactor-enable-confirm").removeClassName("offline")}fc.hide_error();$("phone-code").clear().focus();return fc.fill_delivery_choice(fe)}})(this),onSubmit:this.submit_phone_code.bind(this),contents:bv("#twofactor-enable-confirm")};fb={name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"back_next"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_none"),contents:bv("#twofactor-enter-backup-phone")};e3=new e(this.DEFAULT_ENABLE_TITLE,this.LOCK_ICON,[{name:"enable_start",enter:this.hide_error.bind(this),contents:bv("#twofactor-start")},{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.ENABLE_CONFIRM_HREF,(function(fc){return function(fd,fe){fc.successfully_enabled=false;fd.vars.mode="ENABLE";fd.vars.passed_password=true;return fe.next()}})(this)),contents:bv("#twofactor-enter-password")},e9,e6,e8,e0,fb,{name:"recovery_code",enter:(function(fc){return function(){fc.fill_backup_phone(fc._backup_phone);return fc.hide_error.bind(fc)}})(this),onSubmit:this.submit_finish.bind(this),contents:bv("#twofactor-recovery")},{name:"congrats_done",enter:this.after_enabled.bind(this),title:el("Congrats! You've enabled two-step verification!"),contents:bv("#twofactor-done")}],{enable_start:function(){return"password"},password:function(){return"delivery_choice"},delivery_choice:((function(fc){return function(fd){if(fd.vars.sms){return"enter_phone_number"}else{return"offline_setup"}}})(this)),enter_phone_number:function(){return"confirm_phone"},confirm_phone:function(){return"backup_phone"},backup_phone:function(){return"recovery_code"},recovery_code:function(){return"congrats_done"},congrats_done:function(){return"__exit__"},offline_setup:function(){return"confirm_phone"}},{enable_start:function(){return null},password:function(){return null},delivery_choice:function(){return null},enter_phone_number:function(){return"delivery_choice"},offline_setup:function(){return"delivery_choice"},confirm_phone:function(fc){if(fc.vars.sms){return"enter_phone_number"}else{return"offline_setup"}},backup_phone:function(){return"delivery_choice"},recovery_code:function(){return"backup_phone"},congrats_done:function(){return null}},"enable_start",function(){return this.vars.passed_password=false});e3.addExitListener((function(fc){return function(fd){if(e3.vars.passed_password&&fd&&!fc.successfully_enabled){return ab.error(el("Two-step verification is not enabled"))}}})(this));e2=new e(this.DEFAULT_EDIT_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(fc){return function(fe,ff){var fd;fc.successfully_enabled=false;bv(".delivery-choice").removeClass("selected");fd=!bv("#twofactor-row").hasClass("with-sms");bv(fd?"#app-choice":"#sms-choice").addClass("selected");bv("#twofactor-recovery").addClass("edit-mode");fe.vars.passed_password=true;return ff.next()}})(this)),contents:bv("#twofactor-enter-password")},e9,e6,e8,e0,{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"back_save"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_everything"),contents:bv("#twofactor-enter-backup-phone")}],{password:function(){return"delivery_choice"},delivery_choice:((function(fc){return function(fd){if(fd.vars.sms){return"enter_phone_number"}else{return"offline_setup"}}})(this)),enter_phone_number:function(){return"confirm_phone"},confirm_phone:function(){return"backup_phone"},backup_phone:function(){return"__exit__"},offline_setup:function(){return"confirm_phone"}},{password:function(){return null},delivery_choice:function(){return null},enter_phone_number:function(){return"delivery_choice"},offline_setup:function(){return"delivery_choice"},confirm_phone:function(fc){if(fc.vars.sms){return"enter_phone_number"}else{return"offline_setup"}},backup_phone:function(){return"delivery_choice"}},"password",function(){return this.vars.passed_password=false});e2.addExitListener((function(fc){return function(fd){if(e2.vars.passed_password&&fd&&!fc.successfully_enabled){return ab.error(el("Two-step verification has not been changed"))}}})(this));T=new e(this.DEFAULT_DISABLE_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.DISABLE_CONFIRM_HREF,(function(fc){return function(fd,fe){fc.successfully_disabled=false;fd.vars.passed_password=true;return fe.next()}})(this)),contents:bv("#twofactor-enter-password")},{name:"disable",enter:this.hide_error.bind(this),contents:bv("#twofactor-disable"),onSubmit:this.disable_submit.bind(this)}],{password:function(){return"disable"},disable:function(){return"__exit__"}},{password:function(){return null},disable:function(){return"__cancel__"}},"password",function(){return this.vars.passed_password=false});T.addExitListener((function(fc){return function(fd){if(T.vars.passed_password&&fd&&!fc.successfully_disabled){return ab.error(el("Two-step verification is still enabled"))}}})(this));e7=new e(this.ADD_BACKUP_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(fc){return function(fd,fe){return fe.next()}})(this)),contents:bv("#twofactor-enter-password")},{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"cancel_save"),onSubmit:this.submit_backup_phone_number.bind(this,true,"save_backup_phone"),contents:bv("#twofactor-enter-backup-phone")}],{password:function(){return"backup_phone"},backup_phone:function(){return"__exit__"}},{password:function(){return null},backup_phone:function(){return"__cancel__"}},"password");e1=new e(this.EDIT_BACKUP_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(fc){return function(fd,fe){return fe.next()}})(this)),contents:bv("#twofactor-enter-password")},{name:"backup_phone",enter:this.enter_backup_phone_number_shown.bind(this,"cancel_save"),onSubmit:this.submit_backup_phone_number.bind(this,false,"save_backup_phone"),contents:bv("#twofactor-enter-backup-phone")}],{password:function(){return"backup_phone"},backup_phone:function(){return"__exit__"}},{password:function(){return null},backup_phone:function(){return"__cancel__"}},"password");fa=new e(this.EDIT_RECOVERY_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(fc){return function(fd,fe){return new Ajax.DBRequest(fc.RECOVERY_CODE_HREF,{parameters:{checkpoint_token:fc._checkpoint_token},onSuccess:function(ff){var fg;fg=ff.responseText.strip();if(fg.startsWith("OK:")){fc.fill_recovery_code(fg.substr(3),"backup-code-div-edit");return fe.next()}else{switch(fg){case"EXPIRED":return fc.show_error_expired();case"ALREADY_DISABLED":bv("#twofactor-row").removeClass("twofactor-enabled");ab.success(el("Two-step verification is already disabled. Did you maybe disable it in another window?"));return eS.hide()}}},onFailure:fc.show_error500.bind(fc),cleanUp:fc.hide_loading.bind(fc),subject_user:fc._user})}})(this)),contents:bv("#twofactor-enter-password")},{name:"recovery_code",enter:this.hide_error.bind(this),contents:bv("#twofactor-recovery-edit"),onSubmit:(function(fc){return function(fd,fe){fc._checkpoint_token=null;return fe.next()}})(this)}],{password:function(){return"recovery_code"},recovery_code:function(){return"__exit__"}},{password:function(){return null},recovery_code:function(){return null}},"password");e5=(function(fc){return function(fd){bv("#twofactor-security-key-edit .loading-wheel").hide();return new Ajax.DBRequest(fc.ADD_SECURITY_KEY_FINISH_HREF,{parameters:{checkpoint_token:fc._checkpoint_token,device_response:JSON.stringify(fd)},onSuccess:function(fe){var ff;ff=fe.responseText.strip();bv("#twofactor-security-key-edit .accept").show();bv("#twofactor-security-key-edit input[type='submit']").removeAttr("disabled");return bv("#twofactor-row-"+fc._user.role).addClass("with-security-key")},onFailure:function(ff){var fe,fg;fg=ff.responseText;fe=JSON.parse(fg.substr(4));if(fe.security_key_register!=null){return ab.error(fe.security_key_register["message_text"])}else{return fc.show_error500.bind(fc)}},cleanUp:fc.hide_loading.bind(fc),subject_user:fc._user})}})(this);bv("#security-key-register").on("click",(function(fc){return function(fd){return new Ajax.DBRequest(fc.ADD_SECURITY_KEY_START_HREF,{parameters:{checkpoint_token:fc._checkpoint_token},onSuccess:function(fe){var ff;bv("#twofactor-security-key-edit .loading-wheel").show();ff=JSON.parse(fe.responseText);return u2f.register(ff.registerRequests,ff.authenticateRequests,e5)},onFailure:fc.show_error500.bind(fc),cleanUp:fc.hide_loading.bind(fc),subject_user:fc._user})}})(this));e4=new e(this.EDIT_SECURITY_KEY_TITLE,this.LOCK_ICON,[{name:"password",enter:this.enter_password_shown.bind(this),onSubmit:this.submit_password.bind(this,this.EDIT_CONFIRM_HREF,(function(fc){return function(fd,fe){return fe.next()}})(this)),contents:bv("#twofactor-enter-password")},{name:"security_key",enter:this.hide_error.bind(this),contents:bv("#twofactor-security-key-edit"),onSubmit:(function(fc){return function(fd,fe){fc._checkpoint_token=null;fe.next();if(bv(".active_security_keys").length){return location.reload(true)}}})(this)}],{password:function(){return"security_key"},security_key:function(){return"__exit__"}},{password:function(){return null},security_key:function(){return"__cancel__"}},"password");e4.addExitListener((function(fc){return function(fd){bv("#twofactor-security-key-edit .loading-wheel").hide();bv("#twofactor-security-key-edit .accept").hide();return bv("#twofactor-security-key-edit input[type='submit']").attr("disabled",true)}})(this));bv(".enable-twofactor").on("click",(function(fc){return function(fd){return fc.start_flow(fd,e3)}})(this));bv(".disable-twofactor").on("click",(function(fc){return function(fd){return fc.start_flow(fd,T)}})(this));bv(".add-twofactor-backup-link").on("click",(function(fc){return function(fd){return fc.start_flow(fd,e7)}})(this));bv(".edit-twofactor-backup").on("click",(function(fc){return function(fd){return fc.start_flow(fd,e1)}})(this));bv(".edit-twofactor-recovery").on("click",(function(fc){return function(fd){return fc.start_flow(fd,fa)}})(this));bv(".add-twofactor-security-key-link").on("click",(function(fc){return function(fd){return fc.start_flow(fd,e4)}})(this));bv(".edit-twofactor-sms, .edit-twofactor-offline").on("click",(function(fc){return function(fd){return fc.start_flow(fd,e2)}})(this));bv("#generate-new-recovery-code").on("click",(function(fc){return function(fd){fc.show_loading();return new Ajax.DBRequest(fc.NEW_RECOVERY_CODE_HREF,{parameters:{checkpoint_token:fc._checkpoint_token},onSuccess:function(fe){var ff;ff=fe.responseText.strip();if(ff.startsWith("OK:")){return fc.fill_recovery_code(ff.substr(3),"backup-code-div-edit")}else{switch(ff){case"EXPIRED":fa.to_state("password");return fc.show_error_expired();case"ALREADY_DISABLED":$("twofactor-row").removeClassName("twofactor-enabled");ab.success(el("Two-step verification is disabled. Did you maybe disable it in another window?"));return eS.hide()}}},onFailure:fc.show_error500.bind(fc),cleanUp:fc.hide_loading.bind(fc),subject_user:fc._user})}})(this));bv("#twofactor-enter-backup-phone #country-code").on("change",this.reset_phone_field.bind(this));bv("#resend-link").on("click",this.enable_resend_phone_code.bind(this));bv("#twofactor-delivery-choice input").change(function(){bv(".delivery-choice").removeClass("selected");return bv(this).parents(".delivery-choice").addClass("selected")});bv("#show-qr").on("click",(function(fc){return function(fd){bv("#twofactor-offline-setup").addClass("showing-qr");return false}})(this));bv("#hide-qr").on("click",(function(fc){return function(fd){bv("#twofactor-offline-setup").removeClass("showing-qr");return false}})(this));if(window.location.hash==="#backup2fa"&&bv("#twofactor-row").hasClass("allow-autopop")){return this.start_flow(e7)}},start_flow:function(e1,e0){var T;e1.preventDefault();T=bv(e1.target).data("uid");cu.set_user(cB.get_viewer().get_user_by_id(T));this._current_flow=e0;e0.start();return false},connect_login_init:function(){this._container_selector="#twofactor-form";this._error_selector="#twofactor-form .error";return bv("#resend-link").on("click",this.connect_resend_phone_code.bind(this))},resend_phone_code:function(e0){var T;if(this.is_resending()){return}this.show_resending();T="/twofactor_resend";if(bv("#twofactor-confirm").hasClass("backup")){T=D.parse(T).updateQuery({backup:true}).toString()}new Ajax.DBRequest(T,{onSuccess:(function(e1){return function(e2){switch(e2.responseText.strip()){case"OK":e1.hide_error();return e1.notify_resent();case"UNREACHABLE":return e1.show_error_unreachable(true);case"BADCARRIER":return e1.show_error_bad_carrier();case"INVALIDNUMBER":return e1.show_error_invalid_number();case"NOTAMOBILE":return e1.show_error_not_a_mobile();case"RATELIMIT":return ab.error(el("You've asked for too many SMS messages. Please try again in a few minutes."));case"EXPIRED":return $("twofactor-confirm").submit()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},connect_resend_phone_code:function(T){if(this.is_resending()){return}this.show_resending();new Ajax.DBRequest("/twofactor_resend",{onSuccess:(function(e0){return function(e1){switch(e1.responseText.strip()){case"OK":e0.hide_error();return e0.notify_resent();case"UNREACHABLE":return ab.error(error_unreachable(true));case"BADCARRIER":return ab.error(error_bad_carrier());case"INVALIDNUMBER":return e0.show_error_invalid_number();case"NOTAMOBILE":return ab.error(error_not_a_mobile());case"RATELIMIT":return ab.error(el("You've asked for too many SMS messages. Please try again in a few minutes."));case"EXPIRED":return $("twofactor-form").submit()}}})(this),onFailure:(function(e0){return function(e1){return ab.error(e0.error500())}})(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},enable_resend_phone_code:function(T){if(this.is_resending()){return}this.show_resending();new Ajax.DBRequest("/twofactor_resend",{onSuccess:(function(e0){return function(e1){switch(e1.responseText.strip()){case"OK":e0.hide_error();return e0.notify_resent();case"UNREACHABLE":return e0.show_error_unreachable();case"BADCARRIER":return e0.show_error_bad_carrier();case"INVALIDNUMBER":return e0.show_error_invalid_number();case"NOTAMOBILE":return e0.show_error_not_a_mobile();case"RATELIMIT":return ab.error("You've asked for too many SMS messages. Please try again in a few minutes.");case"EXPIRED":e0._current_flow.to_state("password");return e0.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_resending_with_delay.bind(this)});return false},DEFAULT_ENABLE_TITLE:el("Enable two-step verification"),DEFAULT_EDIT_TITLE:el("Edit two-step verification"),DEFAULT_DISABLE_TITLE:el("Disable two-step verification"),ADD_BACKUP_TITLE:el("Add a backup phone number"),EDIT_BACKUP_TITLE:el("Edit backup phone number"),EDIT_RECOVERY_TITLE:el("View recovery code"),EDIT_SECURITY_KEY_TITLE:el("Add security key"),LOCK_ICON:"lock32",ENABLE_CONFIRM_HREF:"/account/twofactor/confirm_password",DISABLE_CONFIRM_HREF:"/account/twofactor/disable_confirm_password",EDIT_CONFIRM_HREF:"/account/twofactor/edit_confirm_password",ADD_SECURITY_KEY_START_HREF:"/account/twofactor/u2f_start_registration",ADD_SECURITY_KEY_FINISH_HREF:"/account/twofactor/u2f_finish_registration",RECOVERY_CODE_HREF:"/account/twofactor/get_rescue_code",NEW_RECOVERY_CODE_HREF:"/account/twofactor/new_rescue_code",enter_password_shown:function(){var T;this.hide_error();bv("#twofactor-recovery").removeClass("edit-mode");T=$("twofactor-enter-password");bv("#password",T).val("").focus();return false},submit_password:function(e1,e4,T,e2,e3){var e0;e0=$("password").getValue();if(!e0){this.show_error(el("Please enter your password"));return}this.show_loading();return new Ajax.DBRequest(e1,{parameters:{password:e0},onSuccess:(function(e5){return function(e6){var e7;e7=e6.responseText.strip();if(e7.startsWith("OK:")){e5._checkpoint_token=e7.substr(3);return e4(T,e2)}else{switch(e7){case"EXPIRED_PASSWORD":return e5.show_error_expired_password();case"INVALID":return e5.show_error(el("Invalid password"));case"RATELIMIT":return e5.show_error(el("Too many incorrect passwords. Please try again in a few minutes."));case"ALREADY_ENABLED":$("twofactor-row").addClassName("twofactor-enabled");ab.success(el("Two-step verification is already enabled. Did you maybe enable it in another window?"));return eS.hide();case"ALREADY_DISABLED":$("twofactor-row").removeClassName("twofactor-enabled");ab.success(el("Two-step verification is already disabled. Did you maybe disable it in another window?"));return eS.hide()}}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fetch_offline_key:function(T,e0){this.show_loading();return new Ajax.DBRequest("/account/twofactor/add_phone",{parameters:{checkpoint_token:this._checkpoint_token,offline:true},onSuccess:(function(e1){return function(e2){var e3;e3=e2.responseText.strip();if(e3.startsWith("OK:")){e1.fill_key(e3.substr(3));return e0.next()}else{switch(e3){case"EXPIRED":T.to_state("password");return e1.show_error_expired()}}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fill_key:function(e0){var T,e2,e1;e0=e0.replace(new RegExp("=+$"),"");T=e0.toLowerCase().replace(/(.{4})/g,"$1 ");$("secret-div").__date(T);$("qr-div").__date();e1=Constants.IS_PROD?"Dropbox":"DropboxDev";e2={text:"otpauth://totp/"+e1+":"+this._user.email+"?secret="+e0+"&issuer="+e1,width:200,height:200};if(!Modernizr.canvas){e2.render="table"}bv("#qr-div").qrcode(e2);if(!Modernizr.canvas){return bv("#qr-div > table").css("margin","0 auto")}},submit_phone_number:function(e0,e2,e3){var T,e1;T=bv("#twofactor-enter-phone .twofactor-phone-number");if(!T.controller().validate_on_submit()){return}e1=T.val();this.show_loading();return new Ajax.DBRequest("/account/twofactor/add_phone",{parameters:{checkpoint_token:this._checkpoint_token,phone_number:e1},onSuccess:(function(e4){return function(e5){switch(e5.responseText.strip()){case"OK":e4._phone_number=e1;e0.vars.phone_number=e1;return e2.next();case"EXPIRED":e0.to_state("password");return e4.show_error_expired();case"UNREACHABLE":return e4.show_error_unreachable(T);case"BADCARRIER":return e4.show_error_bad_carrier(T);case"INVALIDNUMBER":return e4.show_error_invalid_number(T);case"NOTAMOBILE":return e4.show_error_not_a_mobile(T);case"RATELIMIT":return e4.show_error(el("You've added too many phone numbers. Please try again in a few minutes."))}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},submit_phone_code:function(T,e0,e2){var e1;e1=$("phone-code").getValue().strip();if(!e1){this.show_error(el("Please enter the security code"));return}if(e1.search(/^\d{6}$/)===-1){this.show_error(el("Invalid security code"));return}this.show_loading();return new Ajax.DBRequest("/account/twofactor/confirm_phone",{parameters:{checkpoint_token:this._checkpoint_token,twofactor_code:e1},onSuccess:(function(e3){return function(e4){var e6,e5;e5=e4.responseText.strip();if(e5.startsWith("OK:")){e3.fill_recovery_code(e5.substr(3),"backup-code-div");return e0.next()}else{switch(e5){case"INVALID":e3._invalid_code_count+=1;e6=e3._invalid_code_count<=2?el("Invalid code"):e3._is_offline_setup?el("Invalid code. Check the clock on your phone: it must be accurate to the minute."):el("Invalid code");return e3.show_error(e6);case"EXPIRED":T.to_state("password");return e3.show_error_expired();case"RATELIMIT":return e3.show_error(el("Too many invalid codes. Try again in a few minutes."))}}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},enter_backup_phone_number_shown:function(e2,e0){var e1,T;this.hide_error();e1=$("twofactor-enter-backup-phone");T=this.fill_phone_number_for_edit(e1,bv("#twofactor-row-"+this._user.role+" #twofactor-backup-number").text());T.focus();if(e2==="back_next"){bv("#twofactor-backup-back-next").show();bv("#twofactor-backup-cancel-save").hide();return bv("#twofactor-backup-back-save").hide()}else{if(e2==="cancel_save"){bv("#twofactor-backup-back-next").hide();bv("#twofactor-backup-cancel-save").show();return bv("#twofactor-backup-back-save").hide()}else{if(e2==="back_save"){bv("#twofactor-backup-back-next").hide();bv("#twofactor-backup-cancel-save").hide();return bv("#twofactor-backup-back-save").show()}}}},submit_backup_phone_number:function(e3,e2,e0,e4,e5){var T,e1;T=bv("#twofactor-enter-backup-phone .twofactor-backup-phone-number");if(!T.controller().validate_on_blur()){return}e1=T.val();if(e1){if(this.is_primary_number(e1)){T.controller().show_error(el("You can't use your primary phone as your backup",T));return}}else{if(e3){T.controller().show_error(el("Please enter phone number",T));return}}this._backup_phone=e1;if(e2==="save_backup_phone"){this.save_added_backup_phone(e0,e3,e1)}else{if(e2==="save_everything"){this.submit_finish(e0,e4,e5)}else{if(e2==="save_none"){return e4.next()}}}},is_same_phone_number:function(e0,T){if(!e0||!T){return false}return e0.replace(/\D+/g,"")===T.replace(/\D+/g,"")},is_primary_number:function(T){var e0;e0=bv("#twofactor-row-"+this._user.role);if(this._is_offline_setup){return false}if(this.is_same_phone_number(T,e0.data("primary_phone"))){return true}if(this.is_same_phone_number(T,bv("#twofactor-sms-number",e0).text())){return true}return false},save_added_backup_phone:function(T,e1,e0){this.show_loading();return new Ajax.DBRequest("/account/twofactor/set_backup_phone",{parameters:{checkpoint_token:this._checkpoint_token,backup_phone_number:e0},onSuccess:(function(e2){return function(e3){var e4;switch(e3.responseText.strip()){case"OK":e2.hide_error();e4="#twofactor-row-"+e2._user.role;bv(""+e4+" #twofactor-backup-number").text(e0);bv(e4).toggleClass("with-backup",!!e0);if(!e0){ab.success(el("Backup phone number removed"))}else{if(!e1){ab.success(el("Backup phone number updated"))}else{ab.success(el("Backup phone number added"))}}return eS.hide();case"EXPIRED":T.to_state("password");return e2.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},fill_phone_number_for_edit:function(e2,e4){var e3,e0,e1,T;e0=bv(".sick-input > input",e2);if(!e4){return e0.val("")}T=bv('select[name="country_code"]',e2);e3=/^\+\d+/.exec(e4);e3=e3?e3[0]:"";e1=this.option_for_country_code(T,e3);if(e1!=null){e1.selected=true}e0.val(bv.trim(e4.slice(e3.length)));if(e0.length){e0[0].select()}return e0},option_for_country_code:function(T,e1){var e0;if(e1){e0=bv('option[value="'+e1+'"]',T);if(e0.length>1){e0=e0.filter("[selected]")}if(e0.length){return e0[0]}}return bv("option[selected]",T)[0]},fill_delivery_choice:function(T){bv("#twofactor-delivery-phone-label,#confirm-phone-primary").toggle(!!T);bv("#twofactor-delivery-offline-label").toggle(!T);bv("#confirm-phone-primary-number").text(T);return bv("#twofactor-row-"+this._user.role).data("primary_phone",T)},fill_backup_phone:function(T){bv("#confirm-phone-backup").toggle(!!T);return bv("#confirm-phone-backup-number").text(T)},fill_recovery_code:function(e0,T){e0=e0.toLowerCase().replace(/(.{4})/g,"$1 ");return $(T).__date(e0)},submit_finish:function(T,e0,e1){var e2;this.show_loading();e2={checkpoint_token:this._checkpoint_token};if(this._backup_phone){e2.backup_phone_number=this._backup_phone}return new Ajax.DBRequest("/account/twofactor/enable_finish",{parameters:e2,onSuccess:(function(e3){return function(e4){switch(e4.responseText.strip()){case"OK":e3.successfully_enabled=true;if(T.vars.mode!=="ENABLE"){return e3.after_enabled(T,e0)}else{return e0.next()}break;case"EXPIRED":T.to_state("password");return e3.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},after_enabled:function(e0,e1){var T;this._checkpoint_token=null;this.hide_error();T=bv("#twofactor-row-"+this._user.role);T.toggleClass("with-sms",!!this._phone_number);bv("#twofactor-sms-number",T).text(this._phone_number||"");T.toggleClass("with-backup",!!this._backup_phone);bv("#twofactor-backup-number",T).text(this._backup_phone||"");T.addClass("twofactor-enabled");if(e0.vars.mode!=="ENABLE"){ab.success(el("Two-step verification updated"));return e1!=null?e1.next():void 0}},disable_submit:function(T,e0){this.show_loading();return new Ajax.DBRequest("/account/twofactor/disable",{parameters:{checkpoint_token:this._checkpoint_token},onSuccess:(function(e1){return function(e3){var e2;switch(e3.responseText.strip()){case"OK":e1.successfully_disabled=true;e1._checkpoint_token=null;e2=bv("#twofactor-row-"+e1._user.role);e2.removeClass("twofactor-enabled with-sms with-backup with-security-key");bv("#twofactor-sms-number, #twofactor-backup-number",e2).text("");ab.success(el("Two-step verification is now disabled."));return e0.next();case"EXPIRED":T.to_state("password");return e1.show_error_expired()}}})(this),onFailure:this.show_error500.bind(this),cleanUp:this.hide_loading.bind(this),subject_user:this._user})},show_error:function(e1,T){var e0;if(T){T.controller().show_error(e1);return}e0=$$(this._error_selector);if(e1===this.error_expired_password()||e1===this.error_unreachable(true)){e0.invoke("update",e1)}else{e0.invoke("__date",e1)}return e0.invoke("show")},show_error500:function(){return this.show_error(this.error_500())},show_error_bad_carrier:function(T){return this.show_error(this.error_bad_carrier(),T)},show_error_invalid_number:function(T){return this.show_error(this.error_invalid_number(),T)},show_error_not_a_mobile:function(T){return this.show_error(this.error_not_a_mobile(),T)},show_error_unreachable:function(T,e0){if(e0==null){e0=false}return this.show_error(this.error_unreachable(e0),T)},show_error_expired:function(T){return this.show_error(this.error_expired(),T)},show_error_expired_password:function(T){return this.show_error(this.error_expired_password(),T)},error_500:function(){return el("Sorry, an error occurred. Please try again later.")},error_bad_carrier:function(){return el("Unfortunately, your carrier is not supported at this time.")},error_invalid_number:function(){return el("That is not a valid phone number.")},error_not_a_mobile:function(){return el("That phone number does not appear to be a valid mobile number.")},error_unreachable:function(T){if(T==null){T=false}if(T){return el('We couldn\'t reach your phone number. If this has happened before <a href="https://www.dropbox.com/help/364/">click here</a>.')}else{return el("We couldn't reach your phone number. Are you sure it's correct?")}},error_expired:function(){return el("Since it's been a while, please enter your password again.")},error_expired_password:function(){return el('Your password has expired. Please create a new password <a target="_blank" href="/password_expired">here</a>.')},hide_error:function(){return $$(this._error_selector).invoke("__date")},show_loading:function(){this.hide_error();return $$(this._container_selector).invoke("addClassName","loading")},hide_loading:function(){return $$(this._container_selector).invoke("removeClassName","loading")},is_resending:function(){return $$(this._container_selector)[0].hasClassName("resending")},show_resending:function(){return $$(this._container_selector).invoke("addClassName","resending")},hide_resending:function(){return $$(this._container_selector).invoke("removeClassName","resending")},hide_resending_with_delay:function(){return setTimeout(this.hide_resending.bind(this),3000)},notify_resent:function(){return ab.success(el("We sent you another code. It may take a few minutes to arrive."))},reset_phone_field:function(e0){var T,e1;T=e0.element();e1=bv(".sick-input",T.form);bv("input",e1).val("").focus();return this.fill_example_phone_number(T,e1)},fill_example_phone_number:function(T,e2){var e1,e0;if(typeof phone_helpers!=="undefined"&&phone_helpers!==null){e1=bv(T).val().substr(1);e0=phone_helpers.get_example_mobile_number(e1);return bv("label",e2).text(el("Example: ")+e0)}},reset_phone_field_and_backup_country:function(e0){var T;this.reset_phone_field(e0);if(bv("#backup-phone-number").val()===""){T=bv("#twofactor-enter-backup-phone #country-code");T.val(e0.element().getValue());return this.fill_example_phone_number(T,bv(".sick-input",T[0].form))}}};var b0;b0=B.PseudoLocalStorage={_store:{},getItem:function(T){return this._store[T]},setItem:function(T,e0){return this._store[T]=e0},removeItem:function(T){return delete this._store[T]},clear:function(){return this._store={}}};var bL,bB=[].indexOf||function(e1){for(var e0=0,T=this.length;e0<T;e0++){if(e0 in this&&this[e0]===e1){return e0}}return -1};bL=B.FileViewRamsCommon={RAMS_FULLSCREEN_TRANSITION_TIME_MSEC:1000,_PDF_PREVIEW_DOMAINS:["dl-doc.dropbox.com","dl-web.dropbox.com","dl.dropboxusercontent.com","dl-doc.dropboxusercontent.com"],_DEV_DOMAIN_SUFFIX:".dev.corp.dropbox.com",enter_rams_fullscreen:function(T){T.addClass("rams-fullscreen").data("rams-fullscreen",true);return bv(window).resize()},exit_rams_fullscreen:function(T){T.removeClass("rams-fullscreen").removeData("rams-fullscreen");return bv(window).resize()},is_rams_fullscreen_active:function(e0){var T;T=e0.data("rams-fullscreen");return(T!=null)&&T},_isPdfPreviewDomain:function(T){T=T.toLowerCase();return bB.call(this._PDF_PREVIEW_DOMAINS,T)>=0||T.endsWith(this._DEV_DOMAIN_SUFFIX)},_supportsNativePrinting:function(T){return T.attr("data-docpreview-pdf-native-print-enabled")==="True"},getNativePrintUrl:function(e1,T,e0){var e2;if(!this._supportsNativePrinting(e0)){return null}if(!this._isPdfPreviewDomain(T)){console.warn("Blocked attempt to load pdf native print for unexpected domain");return null}e2=D.parse("https://"+T+"/nativeprint");e2.updateQuery({file:e1});return e2.toString()}};var l;l=__PARENT_SCOPE__.FileViewer=INLINE_JS.FileViewer=B.FileViewer={KEY_SCOPE:"fileviewer",_MODAL_FILEINFO:0,_MODAL_PREVIEW:1,MAX_CHECK_LOCK_TRIES:8,MAX_GIF_FILE_SIZE_B:80*1024*1024,_FADE_MSEC:300,file:null,has_preview:false,preview_locked:false,preview_lock_listener:null,modal_type:this._MODAL_FILEINFO,is_loaded:false,has_key_listener:false,preview_status_timeout_obj:null,preview_status_request:null,_non_fullscreen_vert_overflow:null,hiding:false,check_lock_request:null,check_lock_timeout:null,file_locked:false,_frameMessenger:null,_cached_browser_window_title:null,annotation_enabled_for_this_revision:true,active_user:null,in_browse:true,globalPreviewStateModel:new Backbone.Model({state:"closed",file_obj:null}),globalOpenWithWebButtonStateModel:new Backbone.Model({state:"hidden",file_extension:null}),_get_extension:function(e0){var T;T=e0.lastIndexOf(".");return(T===-1?"":e0.substr(T+1))},show:function(e1,T,e0){this._cached_browser_window_title=document.title;return this._setup_and_load.apply(this,arguments)},_setup_and_load:function(e3,e1,e2){var e0,e4,T;if(e2==null){e2={}}e2=$u.defaults(e2,{files:[],in_browse:false,force_file_unlocked:false,from_shared_link:false,should_focus_comment_input:false});T=bv("#file-viewer");if(this.hiding){T.finish()}else{if(this.shown()){this.prev_scope=key.getScope();key.setScope(this.KEY_SCOPE);return}else{T.hide()}}this.file=e3;this.active_user=e1;this.in_browse=e2.in_browse;this.flippable_files=this._filterFlippableFiles(e2.files);this.from_shared_link=e2.from_shared_link;this.should_focus_comment_input=e2.should_focus_comment_input;this._start_time=Date.now();if(this.file.preview_type==="download"){window.location.href=this.file.href}else{z.scroll_lock_document();T.css("pointer-events","").fadeIn(this._FADE_MSEC);e0=bv(".left-flip-button");e0.off("click");e0.on("click",(function(e5){return function(){return e5.loadPreviousFlippable()}})(this));e4=bv(".right-flip-button");e4.off("click");e4.on("click",(function(e5){return function(){return e5.loadNextFlippable()}})(this));return this.load(this.file,e2.force_file_unlocked)}},load:function(e0,e2){var T,e1;if(e2==null){e2=false}this.file=e0;document.title=this.file.filename;T=bv("#file-viewer");if(T.data("is-openwith-allowed")==="True"){if(__CONDITIONAL_JS__.OpenWith.file_supported(this.file)){if(e2){this.file_locked=false}else{this.file_locked=true;this.check_lock()}}}this._render_viewer();e1=this.modal_type===this._MODAL_FILEINFO;return bv("#file-viewer").trigger("db:filepreview:open",[this.file,this.from_shared_link,this.active_user.id,this.should_focus_comment_input,e1])},_isFlippable:function(T){var e0;return(e0=T.preview_type)==="photo"||e0==="video"},_filterFlippableFiles:function(e0){var T;return(function(){var e3,e2,e1;e1=[];for(e3=0,e2=e0.length;e3<e2;e3++){T=e0[e3];if(this._isFlippable(T)){e1.push(T)}}return e1}).call(this)},currentFlippableFileIndex:function(){var e1,e0,e3,T,e2;e2=this.flippable_files;for(e0=e3=0,T=e2.length;e3<T;e0=++e3){e1=e2[e0];if(this.file.sjid===e1.sjid){return e0}}return -1},cancel_check_lock:function(){this.file_locked=false;if(this.check_lock_request!=null){this.check_lock_request.abort();this.check_lock_request=null}if(this.check_lock_timeout!=null){clearTimeout(this.check_lock_timeout);return this.check_lock_timeout=null}},check_lock:function(){var e2,e1,e5,T,e6,e3,e0,e4;if(this.check_lock_request!=null){return}this.check_lock_timeout=null;e2=0;T=this.active_user.id;e5=this.file.fq_path;e1=1000;e4=(function(e7){return function(){e2++;if(e2<e7.MAX_CHECK_LOCK_TRIES){if(e2===2){INLINE_JS.Notify.warning(el("Office Online is saving your file."))}else{if(e2===5){INLINE_JS.Notify.warning(el("Office Online is taking longer than expected to save. ",+"Your changes are safe and will eventually be saved to Dropbox."))}}e7.check_lock_timeout=setTimeout(e6,e1);return e1=e1*2}else{clearTimeout(e7.check_lock_timeout);e7.check_lock_request=null;e7.file_locked=false;return e7._render_preview(true,true)}}})(this);e0=(function(e7){return function(e8){e8=JSON.parse(e8);if(e8!=null?e8.has_lock:void 0){return e4()}else{e7.check_lock_request=null;e7.file_locked=false;return e7._render_preview(true,true)}}})(this);e3=function(e9,e7,e8){return e4()};e6=(function(e7){return function(){return e7.check_lock_request=cs.WebRequest({url:"/ow/msft/check_lock",data:{user_id:T,fq_path:e5},success:e0,error:e3})}})(this);return e6()},shown:function(){return bv("#file-viewer").css("display")!=="none"},clear_preview_url_timer:function(){if(this.previewUrlTimer!=null){return clearTimeout(this.previewUrlTimer)}},set_preview_url_w_timeout:function(){this.clear_preview_url_timer();return this.previewUrlTimer=setTimeout((function(T){return function(){return T.set_preview_url()}})(this),250)},set_preview_url:function(){var e1,e0,T;e1=D.parse(eo.get_url());e0=e1.getPath();T=e1.removeQuery("select").updateQuery({preview:this.file.filename}).getQuery();return eo.push_state(D.encode_parts(e0),T)},unset_preview_url:function(){var e1,e0,T;this.clear_preview_url_timer();e1=D.parse(eo.get_url());if(!this.from_shared_link&&(e1.getPath().match(/^\/s[h]?\/.+/)||!this.in_browse)){return}if(!("preview" in e1.getQuery())){return}e0=e1.getPath();T=e1.removeQuery("select").removeQuery("preview").getQuery();return eo.push_state(D.encode_parts(e0),T)},render_file_failed:function(){var T,e1,e0;e1=this.file;T=this.active_user;e0=this.in_browse;this._teardown_and_hide();e1.doc_preview_status=Constants.DOC_PREVIEW_UNAVAILABLE_BAD_FILE;this._setup_and_load(e1,T,e0,!this.file_locked,this.flippable_files,this.from_shared_link,this.should_focus_comment_input);bv("#file-viewer").show();return bv("#file-viewer").trigger("preview_failed")},_log_view:function(T,e0){var e1;e1={mode:"file-preview",file_ext:av.file_extension_for_logging(this.file.filename),preview_type:this.file.preview_type,preview_status:this.file.doc_preview_status,time_taken:T,file_bytes:this.file.bytes,is_team:this.active_user.is_team===1,paid:this.active_user.paid===1,in_progress:e0,ns_id:this.file.ns_id,sjid:this.file.sjid,user_id:this.active_user.id};return a3.UserActivityLogger.log("web","file_view",e1)},preload_office_static:function(e0){var e2,e1,T;if(__CONDITIONAL_JS__.OpenWith.PRELOAD_URLS==null){return}e1=this._get_extension(e0);if(e1 in __CONDITIONAL_JS__.OpenWith.PRELOAD_URLS){e2=bv("#file-viewer .open-with-static-content-container");T=bv("<iframe/>",{src:__CONDITIONAL_JS__.OpenWith.PRELOAD_URLS[e1]});return e2.html(T)}},unload_office_static:function(){var T;T=bv("#file-viewer .open-with-static-content-container");return T.empty()},_render_viewer:function(){var e6,e0,e9,fa,e2,fc,T,fb,e8,fd,e1,e3,e7,e5,e4;e0=bv("#file-viewer");e6=e0.find(".download-button");fa=D.parse(this.file.href).updateQuery({dl:1}).toString();this.preload_office_static(this.file.filename);e7=(function(fe){return function(fl){var fh,fj,fg,fi,fk,ff;if(fl==null){fl=true}fg=bK.em_snippet(fe.file.filename,35);fh=e0.find(".title-bar .filename");fk={"class":"icon",alt:fe.file.caption};fi=cm.html("web",fe.file.icon,fk).toHTML();fj=bv("<span />",{"class":"filename-text"}).text(fg);fh.html(fi).append(fj);e0.addClass("has-preview");if(fe.file.htmlified_link){e0.addClass("htmlified-preview")}else{if(fe.file.preview_type==="excel"){e0.addClass("html-preview");e0.find(".loading").css("z-index","-1")}else{e0.addClass(""+fe.file.preview_type+"-preview")}}if(fl){e0.find(".loading").show()}e6.on("click",function(fm){fm.preventDefault();return window.location.href=fa});if(fe.file.tkey===void 0&&l.active_user.is_email_verified){ff=function(fm){this.file.tkey=fm.tkey;return this._update_title_bar_buttons()};cs.WebRequest({url:"/sm/get_token",type:"POST",data:{path:fe.file.fq_path},dataType:"json",subject_user:fe.active_user.id,success:ff.bind(fe)})}else{fe._update_title_bar_buttons()}fe.modal_type=fe._MODAL_PREVIEW;fe._first_render_completed=false;return fe._listen()}})(this);fc=(function(fe){return function(){e0.removeClass();e0.find(".loading").hide();return fe._unlisten()}})(this);e3=(function(fe){return function(ff,fk,fi,fh,fg){var fj;if(ff==null){ff=false}if(fk==null){fk=true}if(fi==null){fi=false}if(fh==null){fh=false}if(fg==null){fg=true}fe._log_view(Date.now()-fe._start_time,fh);fj=fe._get_extension(fe.file.filename);if(fj==="doc"||fj==="docx"||fj==="ppt"||fj==="pptx"||fj==="xls"||fj==="xlsx"||fj==="pdf"||fj==="eps"||fj==="ai"||fj==="psd"||fj==="svg"||fj==="txt"||fj==="rtf"||fj==="pspimage"||fj==="tif"||fj==="tiff"||fj==="yuv"||fj==="url"||fj==="webloc"||fj==="website"){fe.globalPreviewStateModel.set({state:"open",file_obj:fe.file})}if(!ff){e7(fk);fe._update_title_bar_buttons()}fe._render_preview(fi,fg);return fe._initial_resize()}})(this);e1=(function(fe){return function(fg){var ff,fi,fj,fh;if(fg==null){fg=false}ff=fe.file.filename.indexOf(".");fi=fe.file.filename.substring(ff+1);if(fi==="key"&&fe.file.preview_type===null){fh="/static/images/icons128/"+(av.file_icon("_other"))+".png"}else{fh="/static/images/icons128/"+(av.file_icon(fe.file.filename))+".png"}fe.globalPreviewStateModel.set({state:"closed",file_obj:null});fj=bK.em_snippet(fe.file.filename,20);e0.find(".title-bar .filename").text(fj);e0.addClass("no-preview");e0.find(".file-thumbnail img").attr({src:fh});e0.find(".file-type").text(fj);e0.find(".file-size").text(fe.file.size);e0.find(".file-modified").text(fe.file.ago||"");e6.on("click",function(){return bR.redirect(fa)});fe.modal_type=fe._MODAL_FILEINFO;fe._listen();fe._log_view(Date.now()-fe._start_time,fg);fe._update_title_bar_buttons();return fe._initial_resize()}})(this);e2=this._get_extension(this.file.filename);fd=((e4=this.file.preview_type)==="doc"||e4==="excel"||e4==="keynote"||e4==="adobecs"||e4==="linkfile")&&(this.file.bytes<Constants.MAX_PDF_FILE_SIZE_B||av.file_extension(this.file.filename).toLowerCase()!=="pdf")&&!bR.msie_version_at_most(9);this.has_preview=(this._is_zoomzoom_ui()&&this.file.preview_type==="photo")||(this._is_zoomzoom_ui()&&this.file.preview_type==="video")||(this.file.preview_type==="text"&&this.file.bytes<Constants.MAX_TEXT_FILE_SIZE_B)||(this.file.preview_type==="html"&&"sandbox" in document.createElement("iframe"))||(this.file.preview_type==="linkfile")||(fd&&this.file.doc_preview_status===Constants.DOC_PREVIEW_AVAILABLE&&!this.file_locked);T=fd&&this._preview_progressive_try(e2)&&this.file.doc_preview_status!==Constants.DOC_PREVIEW_UNAVAILABLE_BAD_FILE&&!this.file_locked;if(this.has_preview||T){return e3(false,!(this.file.preview_type==="doc"),false,false,this.has_preview)}fb=this.file_locked||(fd&&this.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS);if(!fb){return e1()}e7();e8=D({path:"/doc_preview_status"+this.file.fq_path}).toString();e5=Date.now();return(e9=(function(fe){return function(){var ff;ff=Date.now();if(ff-e5>=5000){setTimeout(bv.proxy(fe.render_file_failed,fe),0);return}return fe.preview_status_request=bv.ajax(e8,{success:function(fg){if(fe.file){return fe.file.doc_preview_status=parseInt(fg,10)}},complete:function(fg,fh){if(fh==="abort"){return}if(fe.file_locked){return}if(fe.file.doc_preview_status===Constants.DOC_PREVIEW_AVAILABLE){fe.has_preview=true;return e3(true,false,true,true)}else{if(fe.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS){return fe.preview_status_timeout_obj=setTimeout(e9,1000)}else{fe.render_file_failed()}}},timeout:5000-(ff-e5),subject_user:fe.active_user})}})(this))()},switch_preview:function(e0,e2,e4){var e3,e1,T;if(e0!=null){if(this.file!=null){this.annotation_enabled_for_this_revision=e2;this.file.href=e0;e1=bv("#file-viewer .preview-content-container");T="";e1.html(T);this._render_preview(false,true);e3=e1.find("iframe");if(e3.length>0){return e3.on("load",e4)}}}},_remove_loading:function(T){var e0;if(T==null){T=true}e0=bv("#file-viewer .loading");e0.hide();e0.css("z-index","");return this.is_loaded=T},_render_blank:function(){var e0,T;e0=bv("#file-viewer .preview-content-container");T=dl.createElement(E,{icon:this.file.icon,filename:this.file.filename,created:new Date(this.file.ts*1000),size:this.file.size});return dl.render(T,e0.get(0))},_render_linkfile:function(){var e0,T;e0=bv("#file-viewer .preview-content-container");T=dl.createElement(P,{filename:this.file.filename,source:"browse","authenticated-data-link":true});return dl.render(T,e0.get(0))},_update_title_bar_buttons:function(){var e1,e0,e5,fe,fa,e4,fi,e6,e7,e3,e2,T,fc,fg,fh,fd,ff,fj,e9,fb,e8;e4=bv("#file-viewer");fa=e4.find(".share-button");if(this.from_shared_link){fa.remove()}e1=e4.find(".download-button");e0=e4.find(".split-button.openwith");fe=e0!=null?e0.find(".main-button"):void 0;e5=e0!=null?e0.find(".more-button"):void 0;fi=el("Open",{comment:"Open a file natively on the user's computer"});fb=function(){return e4.data("is-unity-allowed")==="True"&&(__CONDITIONAL_JS__.UnityFeatures!=null)};e9=(function(fk){return function(fm){var fn,fl;return e4.data("is-openwith-allowed")==="True"&&((fn=__CONDITIONAL_JS__.OpenWith)!=null?fn.get_open_handler_for(fm,fk.active_user):void 0)&&fm.bytes<((fl=__CONDITIONAL_JS__.OpenWith)!=null?fl.MAX_SUPPORTED_FILE_SIZE_B:void 0)&&fm.doc_preview_status!==Constants.DOC_PREVIEW_UNAVAILABLE_PROTECTED_DOC}})(this);fg=(function(fk){return function(){return __CONDITIONAL_JS__.UnityFeatures.open_file(fk.file.ns_id,fk.file.ns_path,fk.file.user_id,__CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler,function(fl){return __CONDITIONAL_JS__.UnityFeatures.standard_open_file_handler(false)})}})(this);fh=(function(fk){return function(){var fm,fl,fn;fm=__CONDITIONAL_JS__.OpenWith.get_open_handler_for(fk.file,fk.active_user);if(fm){if((fn=__CONDITIONAL_JS__.OpenWithMicrosoftLogger)!=null){fn.log_open_button_pressed(fk.active_user.id,av.file_extension(fk.file.filename).toLowerCase(),fk.file.ns_id,fk.file.ns_path)}fl=fm.uri+"?hpt_click_ts="+Date.now();return bR.redirect(fl)}}})(this);fj=(function(fk){return function(fm,fl,fq){var fn,fo,fp;if(!fm&&!fl){fd(false)}else{if(fm&&fl){e2(fi,fk.file,fg,fh)}else{if(fm){e3(fi,fh)}else{e3(fi,fg)}}}if(!fm&&!fl){fo=false}else{if(fl){fo=false}else{fo=true}}if(!fo&&!fq){fk._hide_more_button()}else{fk._show_more_button(fq,fo)}fn=function(fr,ft,fu,fs){if(fk._open_button_update_state_timeout){clearTimeout(fk._open_button_update_state_timeout)}return fk._open_button_update_state_timeout=setTimeout((function(){fk.globalOpenWithWebButtonStateModel.set({user_id:fr,state:ft,file_extension:fu,target_button:fs});return fk._open_button_update_state_timeout=null}),200)};if(fm){fp=av.file_extension(fk.file.filename).toLowerCase();if(fl){return fn(fk.active_user.id,"visible",fp,e5)}else{return fn(fk.active_user.id,"visible",fp,fe)}}else{return fn(null,"hidden",null,null)}}})(this);fd=function(fk){if(e0!=null){e0.toggleClass("shown",fk)}return e1.toggle(!fk)};e3=function(fk,fl){if((e0==null)&&(fe==null)){return}fd(true);e0.removeClass("split");fe.text(fk);return fe.off("click").on("click",fl)};e2=(function(fk){return function(fq,fl,fp,fo){var fn,fm;if((e0==null)&&(fe==null)&&(e5==null)){return}fd(true);e0.addClass("split");fe.text(fq);fn=e4.find(".openwith-dropdown");fe.off("click").on("click",function(fr){return fp(fr)});e5.off("click").on("click",function(fs){var fr;fr=bv(this).parent().siblings(".openwith-dropdown");if(fr.is(":visible")){return}eD.show(fr,this,null,true);return fs.stopPropagation()});fn.find(".openwith-desktop-link").off("click").on("click",function(fr){fr.preventDefault();return fp(fr)});fm=__CONDITIONAL_JS__.OpenWith.get_open_handler_for(fl,fk.active_user);fn.each(function(){return cm.src(bv(this).find(".openwith-link .sprite")[0],"web",fm.icon)});fn.find(".openwith-link .sprite-text-inner").text(fm.name);fn.find(".openwith-link").off("click").on("click",function(fr){fr.preventDefault();return fo(fr)});return bv("#file-viewer-container").off("click",eD.hide_all).on("click",eD.hide_all)}})(this);ff=!!fb();e6=!!e9(this.file);e7=!!this.file.tkey;fj(e6,false,e7);if(ff){T=function(){return fj(e6,true,e7)};if((e8=__CONDITIONAL_JS__.UnityCheckFileCache)!=null?e8.is_cached_and_locally_available(this.file.ns_id,this.file.ns_path):void 0){return T()}else{fc=function(fk){if(fk.is_locally_available){return T()}};return __CONDITIONAL_JS__.UnityFeatures.check_file(this.file.ns_id,this.file.ns_path,this.file.user_id,fc)}}},_show_more_button:function(e5,e0){var e3,e4,e1,e2,T;T=bv("#file-viewer");e3=T.find(".more-options-button");e3.show();e1=T.find(".more-options-dropdown");e3.on("click",function(e6){if(e1.is(":visible")){return}eD.show(e1,e3,null,true);return e6.stopPropagation()});bv("#file-viewer-container").on("click",eD.hide_all);e2=e1.find(".remove-link");e2.off("click");if(e5){e2.show();e2.on("click",(function(e6){return function(e7){eD.hide_all();return ag.confirm_remove(e6.file.filename,e6.file.tkey,0,0,0,e6.file.user_id)}})(this))}else{e2.hide()}e4=e1.find(".download-button");return e4.toggle(e0)},_hide_more_button:function(){var e0,T;T=bv("#file-viewer");e0=T.find(".more-options-button");e0.off("click").hide();bv("#file-viewer-container").off("click",eD.hide_all);return T.find(".remove-link").off("click")},_initial_resize:function(){var T;if(this.is_loaded){return}T=function(){return bv("window").trigger("resize")};return setTimeout(T,0)},_get_progressive_url:function(e3,e2){var e4,T,e1,e0;e0=this.active_user;e3=e3.substring(0,3).replace("rtf","doc").replace("pps","ppt");e1=D.parse(e2);T=false;if((e3==="doc"&&e0.progressive_previews_doc)||(e3==="key")||(e3==="keynote")||(e3==="adobecs")){if(!(Constants.PDF_PREVIEW_MODE==="pdf-js")){e1=e1.updateQuery({post_message_on_failure:1})}}else{if(e3==="ppt"&&e0.progressive_previews_ppt){e4="private_progressive_viewer";T=true}else{if(e3==="xls"&&e0.progressive_previews_xls){if(e0.xls_edit){e4="xls/edit"}else{e4="xls/preview"}}}}if(e4){if(T){e1.setAuthority(Constants.WEBSERVER)}else{e1.setAuthority(e1.getAuthority().replace("dl-web","dl-doc"))}e1.setPath(e1.getPath().replace("/get/","/"+e4+"/"))}e1=e1.updateQuery({get_preview:1,rams_ui:this._is_rams_ui()?1:0});return e1},_get_pdf_js_url:function(T){var e0;if(Constants.PDF_PREVIEW_MODE==="pdf-js"){e0=T.toString();T=D.parse(Constants.static_url_pdfjs_viewer);T.setQuery({file:e0})}return T},_preview_is_progressive:function(e0){var T;e0=e0.substring(0,3).replace("rtf","doc").replace("pps","ppt");T=this.active_user;return(e0==="doc"&&T.progressive_previews_doc)||(e0==="ppt"&&T.progressive_previews_ppt)||(e0==="xls"&&T.progressive_previews_xls)||(e0==="key"||e0==="keynote")||(e0==="eps"||e0==="ai")},_preview_progressive_try:function(e0){var e1,T;if(!this._preview_is_progressive(e0)){return false}if(this.file.doc_preview_status===Constants.DOC_PREVIEW_IN_PROGRESS){return true}e0=e0.substring(0,3).replace("rtf","doc").replace("pps","ppt");e1=this.file.doc_preview_status===Constants.DOC_PREVIEW_UNAVAILABLE_FAILED&&((e0==="ppt"&&this.active_user.progressive_previews_ppt_try_failed)||(e0==="doc"&&this.active_user.progressive_previews_doc_try_failed)||(e0==="xls"&&this.active_user.progressive_previews_xls_try_failed)||(e0==="eps"||e0==="ai"));T=e0==="key"||e0==="keynote";return e1||T},_set_previews_sandbox_params:function(e0,T){e0=e0.substring(0,3).replace("rtf","doc").replace("pps","ppt");if(e0!=="xls"){return""}else{return null}},_render_preview:function(fe,fc){var fg,e2,T,e1,fd,e9,ff,e4,fb,e3,fa,fh,e6,e0,e8,e7,e5;if(fe==null){fe=false}if(fc==null){fc=true}if(fe){this._remove_loading(false)}fa=bv("#file-viewer .preview-content-container");if(fa.find("iframe").length>0){return}T=this.currentFlippableFileIndex();fg=bv(".left-flip-button");e2=bv(".right-flip-button");if(T>=0&&this.flippable_files.length>1){fg.toggle(T>0);e2.toggle((T+1)<this.flippable_files.length)}else{fg.hide();e2.hide()}if(this.file.htmlified_link){e4=bv("<iframe/>",{src:this.file.htmlified_link});fa.append(e4);return e4.on("load",this._remove_loading)}else{if(this.file.preview_type==="doc"){e1=this._get_extension(this.file.filename);e0=this._get_progressive_url(e1,this.file.href);e1=e1.substring(0,3).replace("rtf","doc").replace("pps","ppt");if(e1==="ppt"){e4=bv("<iframe/>",{src:e0.toString(),allowfullscreen:"",type:"application/pdf"});fa.append(e4)}else{if(this.active_user.inline_commenting){bv("#file-viewer-container").css({marginLeft:"0",width:"90%",left:"5%"});e0.setAuthority(e0.getAuthority().replace("dl-web","dl-doc"));e0.setPath(e0.getPath().replace("/get/","/dochax_private_commentless_preview/"));e9=e0.toString();e0=D.parse(Constants.static_url_pdfjs_hack_viewer);e0.setQuery({file:e9})}else{if(!fc){e0=e0.updateQuery({generate_preview:1});e0.setAuthority(e0.getAuthority().replace("dl-web","dl-doc"))}e0=this._get_pdf_js_url(e0)}e0=e0.updateQuery(Constants.UID_PARAM_NAME,this.active_user);if(this._is_annotation_marker_enabled()){e0=e0.updateQuery("annotation_marker","1")}if(this._is_annotation_highlight_enabled()){e0=e0.updateQuery("annotation_highlight","1")}e4=bv("<iframe/>",{src:String(e0),type:"application/pdf"});fa.append(e4)}return e4.on("load",this._remove_loading)}else{if(this.file.preview_type==="html"){e4=bv("<iframe/>",{src:this.file.href,sandbox:""});fa.append(e4);return e4.on("load",this._remove_loading)}else{if(this.file.preview_type==="excel"){e0=this._get_progressive_url("xls",this.file.href);e4=bv("<iframe/>",{src:e0,type:"application/pdf"});this._set_previews_sandbox_params("xls",e4);fa.append(e4);return e4.on("load",this._remove_loading)}else{if(this.file.preview_type==="keynote"){e0=this._get_progressive_url("html",this.file.href);e0=e0.updateQuery({generate_preview:1});e0=e0.updateQuery({post_message_on_failure:1});e4=bv("<iframe/>",{src:e0,type:"text/html"});fa.append(e4);return e4.on("load",this._remove_loading)}else{if(this.file.preview_type==="adobecs"){e0=this._get_progressive_url("adobecs",this.file.href);e0=e0.updateQuery({generate_preview:1});e0=this._get_pdf_js_url(e0);e7=String(e0.updateQuery(Constants.UID_PARAM_NAME,this.active_user));e4=bv("<iframe/>",{src:e7,type:"application/pdf"});fa.append(e4);return e4.on("load",this._remove_loading)}else{if(this.file.preview_type==="linkfile"){this._remove_loading();return this._render_linkfile()}else{if(this._is_zoomzoom_ui()){if((e5=this.file.preview_type)==="photo"||e5==="video"){dl.unmountComponentAtNode(fa.get(0));bv("#file-viewer .loading").css("z-index","1");fh=(function(){var fk,fj,fi;if(this.file.preview_type==="photo"){fb=[];fi=[1,2,3,4,5,6,-1,-2];for(fk=0,fj=fi.length;fk<fj;fk++){ff=fi[fk];e3=T+ff;if(0<=e3&&e3<this.flippable_files.length){fb.push(this.flippable_files[e3].thumbnail_url_tmpl)}}fd=this._get_extension(this.file.filename);if(fd==="gif"&&this.file.bytes>this.MAX_GIF_FILE_SIZE_B){this._remove_loading();return dl.createElement(E,{icon:this.file.icon,filename:this.file.filename,created:new Date(this.file.ts*1000),size:this.file.size})}else{if(fd==="gif"){e8=this.file.href}else{e8=this.file.thumbnail_url_tmpl}return dl.createElement(u,{"thumbnail-url-tmpl":e8,"file-extension":fd,imagesToPreload:fb,onLoad:(function(fl){return function(){fl._remove_loading()}})(this),onError:(function(fl){return function(){fl._remove_loading();fl._render_blank()}})(this)})}}else{if(this.file.preview_type==="video"){e6=typeof this.file.video_transcode_url==="string"?this.file.video_transcode_url:this.file.fq_path!=null?bm.video_transcode_url(this.file.fq_path,this.file.hash,this.active_user):void 0;return dl.createElement(d6,{"preview-url":e6,"thumbnail-url-tmpl":this.file.thumbnail_url_tmpl,onLoad:(function(fl){return function(){fl._remove_loading()}})(this)})}}}).call(this);return dl.render(fh,fa.get(0))}}}}}}}}}},post_preview_message:function(e7){var e6,e3,e4,e8,e0,T,e2,e5,e1;e4=bv("#file-viewer .preview-content-container iframe");e1=[];for(e2=0,e5=e4.length;e2<e5;e2++){e3=e4[e2];T=e3.src;e0="://";e8=T.indexOf(e0);if(e8===-1){e6=T.indexOf("/")}else{e6=T.indexOf("/",e8+e0.length)}if(e6!==-1){T=T.substring(0,e6)}e1.push(e3.contentWindow.postMessage(e7,T))}return e1},notify_preview_sfj:function(){if(this.file_locked){this.cancel_check_lock();this._render_preview(true,false)}return l.post_preview_message('{"action":"notify_sfj"}')},loadPreviousFlippable:function(){if(this._isFlippable(this.file)&&this.currentFlippableFileIndex()>0){this.load(this.flippable_files[this.currentFlippableFileIndex()-1]);this.set_preview_url();return bv("#file-viewer").trigger("db:filepreview:prev",[this.file,this.from_shared_link,this.active_user.id])}},loadNextFlippable:function(){if(this._isFlippable(this.file)&&this.currentFlippableFileIndex()<this.flippable_files.length-1){this.load(this.flippable_files[this.currentFlippableFileIndex()+1]);this.set_preview_url();return bv("#file-viewer").trigger("db:filepreview:next",[this.file,this.from_shared_link,this.active_user.id])}},_listen:function(){var e0,T,e1;e0=bv("#file-viewer");e0.on("click",bv.proxy(this._teardown_and_hide,this));e0.find("#file-viewer-container").on("click",function(e2){return e2.stopPropagation()});e0.find(".js-close-button").on("click",bv.proxy(this._on_close,this));if(this.in_browse){this.sfj_callback_handle=ci.add_subscribe_sfj_callback(l.notify_preview_sfj.bind(this))}if(!this.has_key_listener){key("esc",this.KEY_SCOPE,(function(e2){return function(e3){if(e2.is_rams_fullscreen_active()){return}return e2._teardown_and_hide()}})(this));key("left",this.KEY_SCOPE,(function(e2){return function(e3){return e2.loadPreviousFlippable()}})(this));key("right",this.KEY_SCOPE,(function(e2){return function(e3){return e2.loadNextFlippable()}})(this));this.has_key_listener=true}this.prev_scope=key.getScope();key.setScope(this.KEY_SCOPE);if(this.modal_type===this._MODAL_PREVIEW){e0.find(".share-button").on("click",bv.proxy(this._share,this));e1=(function(e2){return function(e3){if(e2.file.fq_path.toLowerCase()===e3.memo.fq_path.toLowerCase()){e2.file.tkey=e3.memo.tkey;return e2._update_title_bar_buttons()}}})(this);T=(function(e2){return function(e3){if(e2.file.tkey===e3.memo.token){e2.file.tkey=null;return e2._update_title_bar_buttons()}}})(this);this.share_link_callback=e1.bind(this);this.remove_link_callback=T.bind(this);document.observe(aC.LINKS_ADD,this.share_link_callback);document.observe(aC.LINKS_REMOVE,this.remove_link_callback)}else{if(this.modal_type===this._MODAL_FILEINFO){e0.find(".share-button").on("click",bv.proxy(this._share,this))}}bv(window).on("resize",bv.proxy(this._resize,this));this.handleMessageFromChild=function(e2){switch(e2.action){case"failed":return l.render_file_failed();case"lock_preview":return l.preview_locked=true;case"unlock_preview":return l.preview_locked=false;case"toggle_preview_lock":return l.preview_locked=!l.preview_locked;case"hide_iframe":return l._teardown_and_hide();case"loaded":return l.post_preview_message('{"action":"listening_sfj"}');case"pagerendered":return l._handle_page_rendered(e2.parameters.stats)}};this._frameMessenger=new eg();this._frameMessenger.configureChildMessaging(".preview-content-container > iframe",bv.proxy(this.handleMessageFromChild,this),["failed","lock_preview","unlock_preview","toggle_preview_lock","hide_iframe","loaded","pagerendered"]);this._frameMessenger.startListening();return window.onbeforeunload=function(e2){if(l.preview_locked){return""}else{return void 0}}},_unlisten:function(){var T;T=bv("#file-viewer");T.off("click",bv.proxy(this._teardown_and_hide,this));T.find("#file-viewer-container").off("click",function(e0){return e0.stopPropagation()});T.find(".js-close-button").off("click",bv.proxy(this._on_close,this));if(this.modal_type===this._MODAL_PREVIEW){T.find(".share-button").off("click",bv.proxy(this._share,this));T.find(".download-button").off("click");bv(document).off("click",eD.hide_all);document.stopObserving(aC.LINKS_ADD,this.share_link_callback);document.stopObserving(aC.LINKS_REMOVE,this.remove_link_callback)}else{if(this.modal_type===this._MODAL_FILEINFO){T.find(".share-button").off("click",bv.proxy(this._share,this))}}bv(window).off("resize",bv.proxy(this._resize,this));key.setScope(this.prev_scope);if(this.in_browse){ci.remove_sfj_callback(this.sfj_callback_handle);return this.sfj_callback_handle=null}},_resize:function(e1){var e0,T;if(!this._is_rams_ui()){e0=bv("#file-viewer");T=e0.find("#file-viewer-container").height()-(e0.find(".title-bar").height()+1);e0.find(".preview").height(T);return e0.trigger("height-resize",{height:T})}},_share:function(T){a3.ShmodelUILogger.log("via-browse-file-viewer");T.preventDefault();return new c3(this.active_user.id,this.file.fq_path,"file_viewer").show()},_on_close:function(T){T.preventDefault();return this._teardown_and_hide()},_teardown_and_hide:function(){var T;if(this.hiding){return}this.hiding=true;this.clear_preview_url_timer();this.unload_office_static();this.globalPreviewStateModel.set({state:"closed",file_obj:null});if(this.preview_locked){if(!confirm("You have unsaved changes. Are you sure you want to leave this page?")){return}}if(this.preview_status_timeout_obj){clearTimeout(this.preview_status_timeout_obj);this.preview_status_timeout_obj=null}if(this.preview_status_request){this.preview_status_request.abort();this.preview_status_request=null}if(this.in_browse){eG.set_selected_files(this.file)}if(this.in_browse||this.from_shared_link){l.unset_preview_url()}z.scroll_unlock_document();T=bv("#file-viewer");return T.css("pointer-events","none").fadeOut({duration:this._FADE_MSEC,always:(function(e0){return function(){var e3,e2,e1;if(e0.is_rams_fullscreen_active()){e0.exit_rams_fullscreen()}if(__CONDITIONAL_JS__.UnityFeatures!=null){e1=el("Download");e3=T.find(".download-button");e3.text(e1);e3.off("click")}e0._hide_more_button();T.removeClass("has-preview").removeClass("no-preview");e2=T.find(".preview-content-container");dl.unmountComponentAtNode(e2.get(0));e2.empty();T.find(".file-thumbnail img").attr({src:""});T.find(".title-bar .filename").text("");T.attr({"class":""});e0._unlisten();e0._remove_loading();document.title=e0._cached_browser_window_title;e0._cached_browser_window_title=null;e0.last_file=e0.file;e0.file=null;e0.preview_locked=false;window.removeEventListener("message",e0.preview_lock_listener);e0.is_loaded=false;e0.hiding=false;e0.cancel_check_lock();T.trigger("db:filepreview:close")}})(this)})},_handle_page_rendered:function(e2){var T,e1,e3,e4,e0;if(!this._first_render_completed){T={total_time:Date.now()-this._start_time,file_ext:av.file_extension_for_logging(this.file.filename)};for(e4=0,e0=e2.length;e4<e0;e4++){e3=e2[e4];e1=(function(){switch(e3.name){case"Page Request":return"viewer_page_request_time";case"Rendering":return"viewer_rendering_time";case"Overall":return"viewer_overall_time"}})();T[e1]=e3.end-e3.start}a3.UserActivityLogger.log("web","file_view_first_page_rendered",T);return this._first_render_completed=true}},resize:function(){return this._resize(null)},hide:function(){return this._teardown_and_hide()},nativePdfPrint:function(){var e0,e2,T,e1;if(this.file.doc_preview_status!==Constants.DOC_PREVIEW_AVAILABLE||((e1=this.file.preview_type)!=="doc"&&e1!=="ppt"&&e1!=="adobecs")){return false}T=this._get_progressive_url("doc",this.file.href);e0=D.parse(T).getAuthority();e2=bL.getNativePrintUrl(T,e0,bv("#file-viewer"));if(e2==null){return false}window.open(e2,"_blank");return true},_is_annotation_marker_enabled:function(){return bv("#file-viewer").attr("data-docpreview-annotation-marker-enabled")==="True"&&this.annotation_enabled_for_this_revision},_is_annotation_highlight_enabled:function(){return bv("#file-viewer").attr("data-docpreview-annotation-highlight-enabled")==="True"&&this.annotation_enabled_for_this_revision},_is_rams_ui:function(){return bv("#file-viewer").attr("data-docpreview-ui-rams-enabled")==="True"},enter_rams_fullscreen:function(){var T;bL.enter_rams_fullscreen(bv(".preview"));T=bv("html");this._non_fullscreen_vert_overflow=T.css("overflow-y");return T.css("overflow-y","hidden")},exit_rams_fullscreen:function(){bL.exit_rams_fullscreen(bv(".preview"));bv("html").css("overflow-y",this._non_fullscreen_vert_overflow);return this._non_fullscreen_vert_overflow=null},is_rams_fullscreen_active:function(){return bL.is_rams_fullscreen_active(bv(".preview"))},_is_zoomzoom_ui:function(){return bv("#file-viewer").attr("data-photopreview-ui-zoomzoom-enabled")}};var dL;dL=B.Index2={init:function(e7,e3){var e5,e8,e0,e9,e4,T,e2,e1,e6;if(e3){bv("#sign-in").on("click",function(ff){var fa,fd,fc,fb,fe;ff.preventDefault();fc=bv("#sign-in-form");eS.show(el("Sign in"),fc[0],false,false,416,false,"sign-in-modal");fd=fc.find("#login_email");fd.focus();return new bW(fa=fd,fe=function(){fc.find("#password-field").hide();fc.find("#remember-me").hide();fc.find("#login_submit").val(el("Continue"));fc.find("#forgot_password_link").hide();return fc.find("#sso_description_footer").show()},fb=function(){fc.find("#password-field").show();fc.find("#remember-me").show();fc.find("#login_submit").val(el("Sign in"));fc.find("#forgot_password_link").show();return fc.find("#sso_description_footer").hide()})})}e5=function(){if(!bv("#signup-container").hasClass("form_shown")){return bv.when(bv("#signup-container").animate({marginTop:-245},{easing:"easeInOutCubic",duration:500}).promise()).done(function(){bv("#signup-container").addClass("form_shown");return bv("#signup-container .text-input input:visible").first().focus()})}};if(!e7){bv(".register").find(".login-button").on("click",function(fa){if(!bv("#signup-container").hasClass("form_shown")){fa.preventDefault();return e5()}});dL.animate()}else{bv(".photo").show()}e8=function(){if(!bv("#signup-container").hasClass("form_shown")){return bv(".register").find(".login-button").trigger("click")}};bv(".buttons .freshbutton-blue").on("click",function(fa){fa.preventDefault();bv("html, body").animate({scrollTop:0},{queue:false,duration:500,complete:e8});return false});bv("#learn-more").on("click",function(fa){fa.preventDefault();bv("html, body").animate({scrollTop:bv("#divider").offset().top},{queue:false,duration:500});return false});if(bo.are_enabled()){a3.WebMiscActivityLogger.log("index_page",{event_name:"cookies_enabled"})}else{ab.error(el("Please enable browser-cookies to use the Dropbox website."))}T=["#devices-background",".register-button","#learn-more",".buttons .freshbutton-blue",".buttons .freshbutton-silver","#sign-in a","#page-header .downloading-link"];e2=function(fa){return bv(fa).on("click",function(){return a3.WebMiscActivityLogger.log("index_page",{event_name:"click",id:fa})})};for(e1=0,e6=T.length;e1<e6;e1++){e0=T[e1];e2(e0)}e4=[".bullet-0 .subline",".bullet-0 .description",".bullet-1 .subline",".bullet-1 .description",".bullet-2 .subline",".bullet-2 .description",".bullet-3 .subline",".bullet-3 .description",".bottom .buttons"];e9={};return bv(window).scroll(function(){var fg,fh,ff,fd,fc,fe,fb,fa;fa=[];for(fe=0,fb=e4.length;fe<fb;fe++){ff=e4[fe];if(bv(ff).length&&!e9[ff]){fh=bv(window).scrollTop();fg=fh+bv(window).outerHeight();fc=bv(ff).offset().top;fd=fc+bv(ff).outerHeight();if(fd<=fg){a3.WebMiscActivityLogger.log("index_page",{event_name:"scroll",id:ff});fa.push(e9[ff]=true)}else{fa.push(void 0)}}else{fa.push(void 0)}}return fa})},_animate_points:function(e5,e6,e7,e0,e9,e4,T){var e2,e1,e3,e8;if(T==null){T=0}T=Math.min(Math.max(T,0),1);e3=e4(T);e8=[(function(){var fc,fb,fa;fa=[];for(e2=fc=0,fb=e6.length;0<=fb?fc<fb:fc>fb;e2=0<=fb?++fc:--fc){fa.push([(function(){var fe,fd;fd=[];for(e1=fe=0;fe<2;e1=++fe){fd.push(e6[e2][e1]+(e7[e2][e1]-e6[e2][e1])*e3)}return fd})()])}return fa})()];e5.attr("points",dL.points_array_to_str(e8));if(T>=1){return e9.resolve()}else{return setTimeout(function(){return dL._animate_points(e5,e6,e7,e0,e9,e4,T+(10/e0))},10)}},animate_points:function(e0,e5,e4,e1,e3,e2){var T;if(e2==null){e2=jQuery.easing.linear}T=bv.Deferred();dL._animate_points(e0,e5,e4,e1,T,e2);return T.done(function(){return typeof e3==="function"?e3():void 0}).promise()},animate_hide_rects:function(e0,e4,e6){var T,e1,e5,e3,e2;T=bv.Deferred().resolve().promise();e5=function(e7){var fc,e9,fb,e8,fa;e8=bv(e0[e7]);fc=dL.points_str_to_array(e8.attr("points"));fa=[fc[1],fc[1],fc[2],fc[2]];e9=dL.inverse(jQuery.easing.linear);fb=e4*(e9((e7+1)/e0.length)-e9(e7/e0.length));return T=T.then(function(){return dL.animate_points(e8,fc,fa,fb)})};for(e1=e3=0,e2=e0.length;0<=e2?e3<e2:e3>e2;e1=0<=e2?++e3:--e3){e5(e1)}return T.done(function(){return typeof e6==="function"?e6():void 0}).promise()},animate_delay:function(e0){var T;T=bv.Deferred();setTimeout(T.resolve,e0);return T.promise()},animate:function(){return bv.Deferred().resolve().promise().then(function(){return dL.animate_docs()}).then(function(){return dL.animate_graphs()}).then(function(){return dL.animate_photos()})},inverse:function(e0,T){if(T==null){T=0.000001}return function(e4){var e2,e3,e1;e3=0;e2=1;while(e2-e3>T){e1=(e3+e2)/2;if(e0(e1)<e4){e3=e1}else{e2=e1}}return e3}},points_str_to_array:function(e5){var e1,e4,e3,e0,e2,T;e2=e5.split(" ");T=[];for(e3=0,e0=e2.length;e3<e0;e3++){e4=e2[e3];T.push((function(){var e9,e7,e6,e8;e6=e4.split(",");e8=[];for(e9=0,e7=e6.length;e9<e7;e9++){e1=e6[e9];e8.push(parseFloat(e1))}return e8})())}return T},points_array_to_str:function(e0){var T;return((function(){var e3,e2,e1;e1=[];for(e3=0,e2=e0.length;e3<e2;e3++){T=e0[e3];e1.push(T.join(","))}return e1})()).join(" ")},animate_docs:function(){var e5,T,e2,e1,e4,e0,e3;e0=[[5,6],[177,1],[184,157],[13,180]];T="";for(e4=e3=0.475;e3<=0.625;e4=e3+=0.05){e5=e4+0.05;e2=[[e0[0][0]+(e0[3][0]-e0[0][0])*e4,e0[0][1]+(e0[3][1]-e0[0][1])*e4],[e0[1][0]+(e0[2][0]-e0[1][0])*e4,e0[1][1]+(e0[2][1]-e0[1][1])*e4],[e0[1][0]+(e0[2][0]-e0[1][0])*e5,e0[1][1]+(e0[2][1]-e0[1][1])*e5],[e0[0][0]+(e0[3][0]-e0[0][0])*e5,e0[0][1]+(e0[3][1]-e0[0][1])*e5]];e2=dL.points_array_to_str(e2);T+="<polygon points='"+e2+"' style='fill:#f5f9fc;stroke:none;' />"}e1=bv('<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="190" width="188">\n   '+T+"\n</svg>");return bv.Deferred().resolve().promise().then(function(){bv(".doc, .graph, .photo").hide();bv(".comp.doc").append(e1);return bv(".comp.doc").show("slide",{direction:"down"},850).promise()}).then(function(){return dL.animate_hide_rects(e1.find("polygon"),2500,function(){return e1.remove()})}).then(function(){return dL.animate_delay(500)}).then(function(){return bv(".tablet.doc, .phone.doc").show("fade",{easing:"easeInOutCubic"},400).promise()}).then(function(){return dL.animate_delay(1500)}).then(function(){return bv(".tablet.doc, .phone.doc, .comp.doc").hide("fade",{easing:"easeInOutCubic",duration:700}).promise()})},animate_graphs:function(){var e0,T;e0=[[83,98],[158,37],[241,77],[171,145]];T=bv('<svg xmlns="http://www.w3.org/2000/svg" version="1.1">\n    <polygon style="fill:#f5f9fc;stroke:none;"/>\n</svg>');T.find("polygon").attr("points",dL.points_array_to_str(e0));return bv.Deferred().resolve().promise().then(function(){bv(".doc, .graph, .photo").hide();bv(".tablet.graph .graph-grid").hide();bv(".tablet.graph").append(T);return bv(".tablet.graph").show("fade",{},500).promise()}).then(function(){var e1;e1=[e0[0],e0[1],e0[1],e0[0]];return dL.animate_points(T.find("polygon"),e0,e1,600,function(){return T.remove()})}).then(function(){if(!bR.msie_version_at_most(8)){return bv(".tablet.graph .graph-grid").show("fade",{},400).promise()}}).then(function(){return dL.animate_delay(500)}).then(function(){return bv(".comp.graph, .phone.graph").show("fade",{easing:"easeInOutCubic"},500).promise()}).then(function(){return dL.animate_delay(2000)}).then(function(){return bv(".graph").hide("fade",{easing:"easeInOutCubic"},700).promise()})},animate_photos:function(){return bv.Deferred().resolve().promise().then(function(){bv(".doc, .graph, .photo").hide();bv(".phone.photo img").not(".photo-flash").css({left:-18*1.15,top:-66*1.15,position:"absolute"});bv(".phone.photo").show();return bv.when((function(){if(!bR.msie_version_at_most(8)){return bv(".phone.photo .photo-flash").show().hide("fade",{},2000).promise()}})(),(function(){return bv.Deferred().resolve().promise().then(function(){return bv(".phone.photo img").not(".photo-flash").animate({left:0,top:0},{duration:800,easing:"easeInOutCubic"}).promise()}).then(function(){return dL.animate_delay(750)}).then(function(){return bv(".tablet.photo, .comp.photo").show("fade",{easing:"easeInOutCubic"},500).promise()})})())})}};var dm,J,dg=function(T,e0){return function(){return T.apply(e0,arguments)}},ar={}.hasOwnProperty,cE=function(e2,e0){for(var T in e0){if(ar.call(e0,T)){e2[T]=e0[T]}}function e1(){this.constructor=e2}e1.prototype=e0.prototype;e2.prototype=new e1();e2.__super__=e0.prototype;return e2};J=INLINE_JS.UserNotifier=B.UserNotifier={USER_NOTIFICATION_STATUS_UNREAD:0,USER_NOTIFICATION_STATUS_READ:1,USER_NOTIFICATION_STATUS_INVISIBLE:2,MAX_ROWS_TO_RETRIEVE:100,MAX_INITIAL_ROWS:10,NUM_ROWS_TO_APPEND:10,SCROLLING_OFFSET:10,_is_retrieving_feed:false,_unread_count:0,_notifications:[],LAST_ACKED_META_ID_KEY:"last_acked_meta_id_key",_current_meta_not_id:null,_num_event_rows:0,_acked_ids:{},_shown:{},_has_more:false,_has_acked:false,THUMBS_BATCH_SIZE:16,_thumb_cache:{},init:function(){var e0,e1,T;this.refresh_feed();bv("#event-feed-container").scroll(function(){if(J._has_more){if(J._scroller_within_offset_to_bottom(J.SCROLLING_OFFSET)){return J._append_event_rows(false)}}});Event.observe($("event-feed-container"),"mousewheel",this.scrolling.bind(this));Event.observe($("event-feed-container"),"DOMMouseScroll",this.scrolling.bind(this));bv("#event-feed").on("click",this._mouseclick.bind(this));T=[];for(e1 in O){e0=O[e1];T.push(this._subscribe_user(e0))}return T},refresh_feed:function(T,e0){var e2,e3,e1;e1=(function(e4){return function(e6){var e9,e7,e8,e5;e4._unread_count=e6.unread_count;e4._notifications=e6.notifications;if(e6.meta_notification){e7=e6.meta_notification;e8=e4._identifier(e7);if(e8!==e4._get_last_acked_meta_not_id()){e4._unread_count++}e4._current_meta_not_id=e8;e4._notifications.push(e7)}e4._has_acked=false;e4._notifications.sort(e4._sort_key);e4._append_event_rows(true);e4.update_jewel_ui(e4._unread_count);if((T!=null)&&(e0!=null)){e5=T.get_user_id();e9=e6.latest_nid[e5];T.handler_success(e0,{nid:e6.latest_nid[e5]})}if(bP){return bP.refresh_inbox_counts()}}})(this);e3=(function(e4){return function(){return e4._is_retrieving_feed=false}})(this);e2=(function(e4){return function(){var e5;e4._is_retrieving_feed=true;e5={count:e4.MAX_ROWS_TO_RETRIEVE};return new bv.ajax("/web/notifications/retrieve",{data:e5,dataType:"json",type:"POST",success:e1,error:function(){if((T!=null)&&(e0!=null)){return T.handler_failure(e0)}},complete:e3})}})(this);return e2()},ack_unread_notifications:function(){if(!this._has_acked&&this._unread_count>0){this.update_jewel_ui(0);if(this._get_last_acked_meta_not_id()!==this._current_meta_not_id){this._set_last_acked_meta_not_id(this._current_meta_not_id);this._acked_ids[this._current_meta_not_id]=true}new bv.ajax("/web/notifications/ack_all",{dataType:"json",type:"POST",success:(function(T){return function(e2){var e3,e5,e4,e1,e0;e0=[];for(e4=0,e1=e2.length;e4<e1;e4++){e5=e2[e4];e3=T._identifier(e5);T._acked_ids[e3]=true;e0.push(T._append_event_rows())}return e0}})(this)});return this._has_acked=true}},update_jewel_ui:function(T){bv("#new-notification-count").text(T).toggleClass("show",T>0);if(T>0){bv(".notifications-bell").addClass("shake")}return setTimeout((function(){return bv(".notifications-bell").removeClass("shake")}),500)},scrolling:function(T){var e0;if(T.originalEvent){T=T.originalEvent}e0=T.detail?T.detail*(-40):T.wheelDelta;if(!this._has_more&&e0<=0&&this._scroller_within_offset_to_bottom(0)){return this.preventDefault(T)}else{if(e0>=0&&$("event-feed-container").scrollTop===0){return this.preventDefault(T)}}},clear_cached_client_states:function(){if(this._is_retrieving_feed){return}this._acked_ids={};return this._append_event_rows(true)},preventDefault:function(T){if(typeof T.preventDefault==="function"){T.preventDefault()}return T.returnValue=false},_subscribe_user:function(T){var e0;return e0=T.subscribe_user({name:"NotificationFeedUpdater",handler:(function(e1){return function(){return e1.refresh_feed(T,e0)}})(this)})},_append_event_rows:function(e8){var T,fc,ff,e1,fa,e6,e9,e7,e5,fb,e0,e3,fe,e2,fd,e4;if(e8==null){e8=false}if(e8){bv("#event-feed").empty();this._shown={};this._num_event_rows=Math.min(this._notifications.length,this.MAX_INITIAL_ROWS)}else{this._num_event_rows+=this.NUM_ROWS_TO_APPEND;this._num_event_rows=Math.min(this._num_event_rows,this._notifications.length)}fb=bv(".feed-row").size();fc=[];e4=this._notifications;for(e9=e2=0,fd=e4.length;e2<fd;e9=++e2){e5=e4[e9];if(fb>=this._num_event_rows){break}fa=this._identifier(e5);if(fa in this._shown){continue}this._shown[fa]=true;e3=e5.status;e1=bv(e5.notification_div);bv("#event-feed").append(e1);fb++;e6=e1.find("img").get(0);if(e6){T=bv(e6);ff=T.attr("data-src");if(ff){if(this._thumb_cache[ff]){e7=this._thumb_cache[ff];T.attr("src",e7);if(!e7.endsWith(cm.SPACER)){this._add_thumbnail_frame(T)}}else{if(!(ff in this._thumb_cache)){this._thumb_cache[ff]=false;fe=e5.user_id;T.data("uid",fe);T.data("not-identifier",fa);fc.push($(e6))}}}}if(!e1.hasClass("feed-row")){e1=e1.find(".feed-row")}if(e5.type_id===Constants.NOTIFICATION_TYPE_META){e1.addClass("meta-feed");if((!(fa in this._acked_ids))&&(fa===this._get_last_acked_meta_not_id())){e1.addClass("read")}}if(e3===this.USER_NOTIFICATION_STATUS_INVISIBLE){e1.addClass("invisible");if(fa in this._acked_ids){delete this._acked_ids[fa]}}if(e3===this.USER_NOTIFICATION_STATUS_READ){if(!(fa in this._acked_ids)){e1.addClass("read")}}}e0=(function(fg){return function(fk){var fi,fh,fj;if(!fk.src.endsWith(cm.SPACER)){fi=bv(fk);fg._add_thumbnail_frame(fi);fa=fi.data("not-identifier");fj=fi.attr("data-src");fh=fi.attr("src");return fg._thumb_cache[fj]=fh}}})(this);bl.batch_load_thumbs(fc,this.THUMBS_BATCH_SIZE,e0);this._has_more=this._num_event_rows<this._notifications.length;if(bv(".feed-row").length===0){return bv("#event-feed-container").addClass("empty")}else{return bv("#event-feed-container").removeClass("empty")}},_identifier:function(T){return""+T.user_id+" "+T.type_id+" "+T.target_object_key},_sort_key:function(e0,T){if(e0.sticky&&!T.sticky){return -1}if(T.sticky&&!e0.sticky){return 1}if(e0.status===J.USER_NOTIFICATION_STATUS_UNREAD&&T.status!==J.USER_NOTIFICATION_STATUS_UNREAD){return -1}if(T.status===J.USER_NOTIFICATION_STATUS_UNREAD&&e0.status!==J.USER_NOTIFICATION_STATUS_UNREAD){return 1}return T.feed_time-e0.feed_time},_get_last_acked_meta_not_id:function(){if(window.localStorage){return localStorage.getItem(this.LAST_ACKED_META_ID_KEY)}},_set_last_acked_meta_not_id:function(T){if(window.localStorage){return localStorage.setItem(this.LAST_ACKED_META_ID_KEY,T)}},_add_thumbnail_frame:function(T){bv(T).addClass("thumbnail");return bv(T).parent(".feed-thumbnail").addClass("has-frame")},_mouseclick:function(e1){var e0,T;e0=bv(e1.target);if(e0.is("a")){if(e0.hasClass("view")){e1.preventDefault();T=e0.attr("data-mount");window.open(T)}}if(e0.closest("a").hasClass("meta-notification-sign-in-needed")){e1.preventDefault();return bF.show_page_login_modal((function(e2){return function(){return e2.refresh_feed()}})(this))}},_scroller_within_offset_to_bottom:function(e0){var T;T=$("event-feed-container");return T.scrollTop+T.offsetHeight+e0>=T.scrollHeight}};dm=B.NotificationUIButton=(function(e0){cE(T,e0);T.prototype.selector=function(){return".notification-button"};function T(){this.clear=dg(this.clear,this);this.active=dg(this.active,this);this._clear_sticky_notification_on_popover_close=dg(this._clear_sticky_notification_on_popover_close,this);T.__super__.constructor.call(this);this._overflowY="auto";this._position="static";this._max_height="0px"}T.prototype._clear_sticky_notification_on_popover_close=function(){if(!bv(this.selector())[0].hasClassName("active")){return J.clear_cached_client_states()}};T.prototype.active=function(e1,e3){var e2;e2=e1.target.hasClassName("feed-row")?e1.target:$(e1.target).up(".feed-row");if(e2){if(!e2.hasClassName("clickable")){return}}T.__super__.active.call(this,e1,e3);return this._clear_sticky_notification_on_popover_close()};T.prototype.clear=function(e1){T.__super__.clear.call(this,e1);return this._clear_sticky_notification_on_popover_close()};return T})(dH);var bs,cd,ey;ey=B.UnsupportedBrowser={init:function(){return bv("#unsupported-browser-dismiss").on("click",function(T){T.preventDefault();eO.hide();return bv.ajax({url:"/dismiss_browser_msg",type:"POST"})})}};cd=B.ExpiredCCNotificationBar={init:function(T){return bv(".expired-dismiss").on("click",function(e0){e0.preventDefault();eO.hide();return bv.ajax({url:"/dismiss_expired_cc_notification",type:"POST",data:{source:T}})})}};bs=B.BetaLocaleNotificationBar={init:function(T){return bv(".beta-locale-dismiss").on("click",function(e0){e0.preventDefault();eO.hide();return bv.ajax({url:"/dismiss_beta_locale_notification",type:"POST",data:{source:T}})})}};var d;d=INLINE_JS.viewer=cB.get_viewer();require(["modules/dirty/eventbus_dark_launch"],function(T){return __CIRCULAR_DEPENDENCY__.EventbusDarkLaunch=T});var I,b2,g,f,cF,cy,v,d7;if(!Constants.is_test){bv(eA.check_timezone)}if(window._document_observe_listeners){v=window._document_observe_listeners;for(g=0,cF=v.length;g<cF;g++){b2=v[g];if(document.loaded){b2.func()}else{document.observe(b2.event,b2.func)}}}if(window._jquery_ready_handlers){d7=window._jquery_ready_handlers;for(f=0,cy=d7.length;f<cy;f++){I=d7[f];bv(I)}}bv(function(){Event.fire(document,"script:loaded");return $(document.body).removeClassName("deferred-resources")});return B});